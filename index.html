<!DOCTYPE html>
<html lang="en" class="light">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gojira | Training Portal</title>
  <!-- APP_VERSION: 20260130-001 -->

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = { darkMode: 'class' }
  </script>

  <!-- Fonts -->
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Montserrat:wght@700&display=swap"
    rel="stylesheet">
  <audio id="login-sound" src="https://assets.mixkit.co/active_storage/sfx/2571/2571-preview.mp3"
    preload="auto"></audio>

  <style>
    body {
      font-family: 'Inter', sans-serif;
    }

    .app-view {
      display: none;
      min-height: 100vh;
    }

    .app-view.active {
      display: block;
    }

    .hover-lift:hover {
      transform: translateY(-8px);
      box-shadow: 0 20px 30px -10px rgba(0, 0, 0, .15);
    }

    .faq-answer {
      max-height: 0;
      overflow: hidden;
      opacity: 0;
      transition: all 0.4s ease;
    }

    .faq-item.active .faq-answer {
      max-height: 1200px;
      opacity: 1;
      padding-top: 0.75rem;
    }

    .tab-content {
      display: block;
    }

    .hidden {
      display: none;
    }

    .stylish {
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
    }

    .glow {
      box-shadow: 0 0 20px rgba(59, 130, 246, 0.5);
    }

    .animate-fade-in {
      animation: fadeIn 0.5s ease-in-out;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes zoomIn {
      from {
        opacity: 0;
        transform: translateY(20px) scale(0.7);
      }

      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    /* Door brand descent animation: keeps same size but moves down behind the login card */
    @keyframes doorBrandDescend {
      0% {
        transform: translateY(0) scale(1) rotate(-8deg);
        opacity: 1;
      }

      60% {
        transform: translateY(7rem) scale(0.96) rotate(-8deg);
        opacity: 0.6;
      }

      100% {
        transform: translateY(14rem) scale(0.85) rotate(-8deg);
        opacity: 0.18;
      }
    }

    /* Login card stacking helper */
    .login-card {
      z-index: 30;
    }

    .login-card.raised {
      z-index: 70 !important;
    }

    /* 3D Swing Animations */
    @keyframes swingLeft {
      from {
        transform: rotateY(0deg);
      }

      to {
        transform: rotateY(95deg);
        opacity: 0;
      }
    }

    @keyframes swingRight {
      from {
        transform: rotateY(0deg);
      }

      to {
        transform: rotateY(-95deg);
        opacity: 0;
      }
    }

    .animate-zoom-in {
      animation: zoomIn 2.8s cubic-bezier(0.2, 0.8, 0.2, 1) 0.6s forwards;
      /* Slightly longer, slower zoom out */
      opacity: 0;
    }

    /* Apply door-brand descent to the big heading so it moves when doors swing */
    #door-brand .door-brand {
      transform-origin: center;
      will-change: transform, opacity;
      transform: translateY(0) rotate(0deg);
    }

    /* Class to start the descent animation on demand */
    .door-descend {
      animation: doorBrandDescend 1.8s cubic-bezier(0.25, 0.46, 0.45, 0.94) 0.5s forwards;
    }

    #door-brand.moved {
      z-index: 0 !important;
      opacity: 0.18 !important;
      pointer-events: none;
      transform: translateY(14rem) scale(0.85) rotate(0deg);
    }

    .animate-door-left {
      transform-origin: left;
      animation: swingLeft 1.8s cubic-bezier(0.25, 0.46, 0.45, 0.94) 0.5s forwards;
    }

    .animate-door-right {
      transform-origin: right;
      animation: swingRight 1.8s cubic-bezier(0.25, 0.46, 0.45, 0.94) 0.5s forwards;
    }

    /* Gojira Theme Variables and Styles */
    :root {
      --gojira-red: #b91c1c;
      /* deep red */
      --gojira-blue: #0f172a;
      /* dark blue */
      --gojira-grad: linear-gradient(90deg, #b91c1c, #1e40af);
    }

    /* Theme applied after login to make pages colorful (legacy - not used when removed) */
    body.gojira-theme {
      background: linear-gradient(180deg, #081426 0%, #0b1220 40%, #2b0f14 100%);
      color: rgba(255, 255, 255, 0.92);
      transition: background 0.5s ease, color 0.3s ease;
    }

    .gojira-theme header,
    .gojira-theme #top-nav {
      background: linear-gradient(90deg, #7f1d1d 0%, #0b1220 50%, #1e3a8a 100%) !important;
      /* For the colored theme we show headers with dark text (per request) */
      color: #0b0b0b !important;
      border: none !important;
      transition: background 0.4s ease, color 0.25s ease;
    }

    /* Ensure any white-text inside header elements is forced to dark in colored mode */
    .gojira-theme header .text-white,
    .gojira-theme #top-nav .text-white {
      color: #0b0b0b !important;
    }

    /* Dark mode with stronger red mix */
    body.dark {
      /* stronger red tint layered over dark gradient */
      background: linear-gradient(180deg, rgba(185, 28, 28, 0.12) 0%, #061025 10%, #0b1220 50%, #160a0a 100%);
      color: rgba(255, 255, 255, 0.95);
      transition: background 0.45s ease, color 0.25s ease;
      background-blend-mode: overlay;
    }

    body.dark header,
    body.dark #top-nav {
      /* stronger red overlay for header in dark mode */
      background: linear-gradient(90deg, rgba(185, 28, 28, 0.22) 0%, rgba(30, 24, 40, 0.6) 30%, #0b1220 70%) !important;
      color: rgba(255, 255, 255, 0.95) !important;
      box-shadow: 0 6px 30px rgba(185, 28, 28, 0.06);
    }

    /* Ensure headings remain readable in dark mode */
    body.dark h1,
    body.dark h2,
    body.dark h3,
    body.dark .font-bold,
    body.dark .font-extrabold {
      color: rgba(255, 255, 255, 0.95) !important;
    }

    /* Dark mode accents: stronger red highlights */
    body.dark .accent-btn {
      background: linear-gradient(90deg, rgba(185, 28, 28, 0.95), #1e3a8a) !important;
      color: white !important;
      box-shadow: 0 10px 30px rgba(185, 28, 28, 0.12) !important;
    }

    body.dark .badge,
    body.dark .btn-outline {
      border-color: rgba(185, 28, 28, 0.18) !important;
      color: rgba(255, 255, 255, 0.95) !important;
      background: rgba(185, 28, 28, 0.03) !important;
    }

    .gojira-theme .app-view {
      background: linear-gradient(180deg, rgba(185, 28, 28, 0.03), rgba(14, 42, 90, 0.03));
    }

    /* Ensure main page headings are dark when colored theme is active (so 'Guidelines' and 'Quality Assurance Checklist' are visible) */
    .gojira-theme .app-view h1,
    .gojira-theme .app-view h2,
    .gojira-theme .app-view h3,
    .gojira-theme .app-view .font-extrabold,
    .gojira-theme .app-view .font-bold {
      color: #0b0b0b !important;
    }

    .gojira-theme .card,
    .gojira-theme .panel {
      background: rgba(10, 14, 22, 0.6);
      color: rgba(255, 255, 255, 0.92);
      border-radius: 12px;
      box-shadow: 0 8px 40px rgba(14, 40, 90, 0.12);
      border: 1px solid rgba(255, 255, 255, 0.04);
    }

    .gojira-theme .accent-btn {
      background: var(--gojira-grad);
      color: white;
      border: none;
      box-shadow: 0 10px 30px rgba(30, 58, 138, 0.18);
    }

    /* Inputs and form elements */
    .gojira-theme input,
    .gojira-theme select,
    .gojira-theme textarea {
      background: rgba(255, 255, 255, 0.02) !important;
      border: 1px solid rgba(255, 255, 255, 0.06) !important;
      color: rgba(255, 255, 255, 0.95) !important;
    }

    .gojira-theme .btn-outline {
      border-color: rgba(255, 255, 255, 0.12);
      color: rgba(255, 255, 255, 0.92);
    }

    /* Accent badges */
    .gojira-theme .badge {
      background: rgba(255, 255, 255, 0.06);
      color: #fff;
      border: 1px solid rgba(255, 255, 255, 0.04);
    }

    /* Door branding */
    .door-brand {
      font-family: 'Montserrat', sans-serif;
      text-shadow: 4px 5px 10px rgba(0, 0, 0, 0.45);
      letter-spacing: -2px;
    }

    /* Login label styling */
    .login-label {
      color: var(--gojira-red);
      font-weight: 700;
    }

    /* Header colored flash for smooth transition between themes */
    #top-nav.header-colored-flash,
    header.header-colored-flash {
      background: var(--gojira-grad) !important;
      color: #fff !important;
      box-shadow: 0 8px 30px rgba(30, 58, 138, 0.15);
      transition: background 0.35s ease, color 0.25s ease;
    }

    /* subtle pulse while flashing */
    .header-colored-flash .glow {
      box-shadow: 0 14px 40px rgba(30, 58, 138, 0.22);
    }

    /* Zoom-in entrance for home page after login (smoother, slower) */
    @keyframes zoomInEntrance {
      0% {
        opacity: 0;
        transform: scale(0.92) translateY(12px);
      }

      60% {
        opacity: 1;
        transform: scale(1.012) translateY(4px);
      }

      100% {
        opacity: 1;
        transform: scale(1) translateY(0);
      }
    }

    .zoom-in-enter {
      animation: zoomInEntrance 980ms cubic-bezier(0.16, 0.84, 0.24, 1) both;
      transform-origin: center top;
      will-change: transform, opacity;
    }
  </style>
  <!-- Debug Console Removed -->

  <script type="module">
    // 1. Setup Logging
    function log(msg) {
      console.log(msg);
    }

    // 2. Global Error Handler
    window.onerror = function (msg, url, line) {
      log(`GLOBAL ERROR: ${msg} (Line: ${line})`);
      return false;
    };

    log("Loader script started.");

    // --- FIX: Define missing functions to prevent crash ---
    window.updateClearFinalizationsButton = function () {
      console.log("updateClearFinalizationsButton called (placeholder)");
    };
    window.renderAdminEntityFeedback = function () {
      console.log("renderAdminEntityFeedback called (placeholder)");
    };
    // Shim for status update to prevent module crash if legacy script lags
    window.updateSupabaseStatus = function (status) {
      console.log("Status Update (Shim): " + status);
      const el = document.getElementById('firebase-status-dot');
      const text = document.getElementById('firebase-status-text');
      if (el && text) {
        // Simple fallback update
        if (status === 'connected') { el.className = 'w-3 h-3 rounded-full mr-2 bg-green-500'; text.innerText = 'Live'; }
        else if (status === 'syncing') { el.className = 'w-3 h-3 rounded-full mr-2 bg-yellow-400 animate-pulse'; text.innerText = 'Syncing...'; }
        else { el.className = 'w-3 h-3 rounded-full mr-2 bg-red-500'; text.innerText = 'Offline'; }
      }
    };

    // 3. Modern ES Module Load (Bypasses UMD issues)
    // We import directly and assign to window to ensure global access

    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

    log("Module loaded. createClient available.");

    window.createClient = createClient; // Backup global

    // --- SUPABASE INTEGRATION ---
    const SUPABASE_URL = "https://mhqowleeklroqrpycibs.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1ocW93bGVla2xyb3FycHljaWJzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAzMDM3NTUsImV4cCI6MjA4NTg3OTc1NX0.5LYhA9sMo-OEFUacnF1imc4V-nFLg7p0f-pCZoMX0Ig";

    try {
      window.supabase = createClient(SUPABASE_URL, SUPABASE_KEY);
      log("Supabase Client Created (ESM)!");

      // Signal success to the rest of the app
      if (window.supabase) {
        updateSupabaseStatus('syncing');

        window.supabase.auth.onAuthStateChange((event, session) => {
          log("Auth Event: " + event);
          if (event === 'SIGNED_IN' && session) {
            if (typeof handleLoginSuccess === 'function') {
              handleLoginSuccess(session.user);
            }
          }
        });

        // Initial Sync
        setTimeout(() => {
          log("Starting Sync...");
          if (typeof syncReviewsFromSupabase === 'function') syncReviewsFromSupabase();
          if (typeof syncCommentsFromSupabase === 'function') syncCommentsFromSupabase();
        }, 1000);

        // Debug console hide logic removed

      }
    } catch (e) {
      log("INIT MODULE EXCEPTION: " + e.message);
    }
  </script>

  <script>
    // --- LEGACY INITIALIZATION REMOVED (Replaced by Module) ---

    // --- AUTH FUNCTIONS ---
    // --- SUPABASE SYNC FUNCTIONS ---

    // Auth Listener
    // Auth Listener moved to initSupabase

    async function syncReviewDeletionToSupabase(reviewId) {
      if (!supabase) return;
      try {
        const { error } = await supabase.from('reviews').delete().eq('id', reviewId);
        if (error) throw error;
        console.log('Deleted review from Supabase:', reviewId);
      } catch (e) {
        console.warn('Failed to delete review from Supabase', e);
      }
    }

    async function pushCommentsToSupabase(comment) {
      if (!supabase) return;
      try {
        const { error } = await supabase.from('comments').upsert(comment);
        if (error) throw error;
        console.log('Pushed comment to Supabase:', comment.id);
      } catch (e) {
        console.warn('Failed to push comment', e);
      }
    }

    async function syncCommentsFromSupabase() {
      if (!supabase) return;
      try {
        const { data, error } = await supabase.from('comments').select('*').limit(100);
        if (error) throw error;
        if (!data || data.length === 0) return;

        let localComments = JSON.parse(localStorage.getItem('reviewComments') || '[]');
        const localIds = new Set(localComments.map(c => c.id));
        let changed = false;

        data.forEach(remoteComment => {
          if (!localIds.has(remoteComment.id)) {
            localComments.push(remoteComment);
            localIds.add(remoteComment.id);
            changed = true;
          }
        });

        if (changed) {
          localStorage.setItem('reviewComments', JSON.stringify(localComments));
          if (document.getElementById('admin-feedback-list')) {
            if (typeof adminLoadFeedbackList === 'function') adminLoadFeedbackList();
          }
        }
      } catch (e) {
        console.warn('Sync comments failed', e);
      }
    }

    // signInWithSupabaseEmail removed

    async function handleLoginSuccess(user) {
      // Check for custom claims or role in metadata
      const role = user.app_metadata?.role || user.user_metadata?.role;

      if (role === 'admin') {
        console.log("Admin role found");
        const adminUser = {
          id: user.id,
          name: user.user_metadata?.name || user.email,
          role: 'admin',
          entity: 'ALL'
        };
        localStorage.setItem('currentUser', JSON.stringify(adminUser));
        location.reload();
        return;
      }

      // Fallback: Check email whitelist
      const adminEmails = ['divyanshu.sharma@bharatloan.com'];
      if (adminEmails.includes(user.email)) {
        const adminUser = {
          id: user.id,
          name: user.user_metadata?.name || user.email,
          role: 'admin',
          entity: 'ALL'
        };
        localStorage.setItem('currentUser', JSON.stringify(adminUser));
        location.reload();
        return;
      }

      alert("Login successful but you do not have Admin access.");
    }

    async function pushReviewsToSupabase(reviewIds) {
      if (!supabase) {
        console.warn("Supabase not initialized.");
        return;
      }
      updateSupabaseStatus('syncing');
      console.log('Pushing reviews to Supabase...', reviewIds);
      const reviews = JSON.parse(localStorage.getItem('adminReviews') || '[]');
      const targetReviews = reviews.filter(r => reviewIds.includes(r.id));

      if (targetReviews.length === 0) return;

      // Helper to convert Blob to Base64
      const blobToBase64 = (blob) => new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onloadend = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(blob);
      });

      try {
        // Prepare reviews with file content if available
        const uploadableReviews = await Promise.all(targetReviews.map(async (r) => {
          const clone = { ...r };
          if (clone.fileStored) {
            try {
              if (!FileDB._db) await FileDB.init();
              const blob = await FileDB.getFile(clone.id);
              if (blob) {
                // Check size limit (max 5MB for Supabase row safety)
                if (blob.size > 5 * 1024 * 1024) {
                  console.warn(`File for ${clone.id} is too large (${(blob.size / 1024 / 1024).toFixed(2)}MB). Skipping file upload.`);
                  alert(`Warning: Attachment for ${clone.employeeName} is too large (>5MB) and will not be synced.`);
                  delete clone.fileContent; // Ensure clean
                } else {
                  clone.fileContent = await blobToBase64(blob);
                  console.log(`Attached file content for ${clone.id} (${Math.round(clone.fileContent.length / 1024)}KB)`);
                }
              }
            } catch (e) {
              console.warn('Failed to attach file for upload', clone.id, e);
            }
          }
          return clone;
        }));

        const { error } = await supabase.from('reviews').upsert(uploadableReviews);
        if (error) throw error;

        console.log(`Successfully pushed ${uploadableReviews.length} reviews.`);
        updateSupabaseStatus('connected');
        alert("Synced to Supabase! ‚òÅÔ∏è");
      } catch (err) {
        console.error('pushReviewsToSupabase failed', err);
        updateSupabaseStatus('error');
        alert("Sync Failed: " + (err.message || JSON.stringify(err)));
      }
    }

    async function syncReviewsFromSupabase(isBackground = false) {
      if (!supabase) {
        updateSupabaseStatus('disconnected');
        return;
      }
      try {
        // Only show "Syncing..." if it's not a background sync or if we are currently offline/error
        const isConnected = document.getElementById('firebase-status-text')?.innerText?.includes('Live');
        if (!isBackground || !isConnected) {
          updateSupabaseStatus('syncing');
        }

        // Add a timeout to detect hanging requests - Increased to 15s
        const timeoutPromise = new Promise((_, reject) =>
          setTimeout(() => reject(new Error('Request timed out after 15s')), 15000)
        );

        const fetchPromise = supabase.from('reviews').select('*').limit(500);

        // Race the fetch against the timeout
        const { data, error } = await Promise.race([fetchPromise, timeoutPromise]);

        updateSupabaseStatus('connected');
        if (error) throw error;
        if (!data || data.length === 0) return;

        let localReviews = JSON.parse(localStorage.getItem('adminReviews') || '[]');
        let changed = false;
        const localIds = new Set(localReviews.map(r => r.id));

        // Initialize FileDB once if needed
        try { if (!FileDB._db) await FileDB.init(); } catch (e) { console.warn('FileDB init failed in sync', e); }

        for (const remoteReview of data) {
          // Handle file download/sync
          if (remoteReview.fileContent && remoteReview.fileContent.startsWith('data:')) {
            try {
              const res = await fetch(remoteReview.fileContent);
              const blob = await res.blob();
              await FileDB.saveFile(remoteReview.id, blob);
              remoteReview.fileStored = true;
              // Remove heavy content before saving to localStorage
              delete remoteReview.fileContent;
              console.log(`Downloaded and saved file for review ${remoteReview.id}`);
            } catch (e) {
              console.warn(`Failed to process file for review ${remoteReview.id}`, e);
            }
          }

          if (!localIds.has(remoteReview.id)) {
            localReviews.push(remoteReview);
            localIds.add(remoteReview.id);
            changed = true;
          }
        }

        if (changed) {
          localStorage.setItem('adminReviews', JSON.stringify(localReviews));
          console.log('Synced new reviews from Supabase');

          if (typeof adminLoadReviewsList === 'function') adminLoadReviewsList();
          if (typeof reviewerLoadReviewsList === 'function') reviewerLoadReviewsList();
          if (typeof checkAndEnableWeekFinalButton === 'function') checkAndEnableWeekFinalButton();
          if (typeof agentLoadMonthlyPerformance === 'function') agentLoadMonthlyPerformance();
          if (typeof agentLoadQADashboard === 'function') agentLoadQADashboard();

          const toast = document.createElement('div');
          toast.className = 'fixed bottom-4 right-4 bg-blue-600 text-white px-4 py-2 rounded-lg shadow-lg z-[100] animate-fade-in';
          toast.innerText = 'New reviews synced from Supabase ‚òÅÔ∏è';
          document.body.appendChild(toast);
          setTimeout(() => toast.remove(), 3000);
        }
      } catch (e) {
        console.warn('Sync failed', e);
        // Only update status to error if it wasn't a silent background check, 
        // OR if we were explicitly showing 'Syncing...' (meaning we were trying to recover from offline)
        const isSyncing = document.getElementById('firebase-status-text')?.innerText === 'Syncing...';
        if (!isBackground || isSyncing) {
          updateSupabaseStatus('error');
        }
      }
    }

    function updateSupabaseStatus(status) {
      const el = document.getElementById('firebase-status-dot');
      const text = document.getElementById('firebase-status-text');

      if (!el || !text) {
        console.warn("Status elements not found yet, retrying...", status);
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', () => updateSupabaseStatus(status));
        }
        return;
      }

      el.className = 'w-3 h-3 rounded-full mr-2 ';
      if (status === 'connected') el.classList.add('bg-green-500', 'shadow-[0_0_8px_rgba(34,197,94,0.6)]');
      else if (status === 'syncing') el.classList.add('bg-yellow-400', 'animate-pulse');
      else if (status === 'error') el.classList.add('bg-red-500');
      else el.classList.add('bg-gray-400');

      if (status === 'connected') text.innerText = 'Live';
      else if (status === 'syncing') text.innerText = 'Syncing...';
      else if (status === 'error') text.innerText = 'Error';
      else text.innerText = 'Offline';
    }

    // Auto-sync loops
    setInterval(() => {
      syncReviewsFromSupabase(true); // background sync
      syncCommentsFromSupabase();
    }, 60000);

    window.addEventListener('load', () => {
      syncReviewsFromSupabase();
      syncCommentsFromSupabase();
      setTimeout(() => {
        if (!supabase) updateSupabaseStatus('disconnected');
      }, 2000);
    });
  </script>
</head>

<body class="bg-slate-50 text-slate-900 dark:bg-slate-900 dark:text-slate-100 transition-colors duration-300">

  <!-- Update Available Banner (hidden by default) -->
  <div id="update-banner"
    class="hidden fixed top-4 left-1/2 transform -translate-x-1/2 z-50 w-full max-w-3xl mx-auto px-4">
    <div
      class="bg-yellow-50 border-l-4 border-yellow-400 text-yellow-900 p-4 rounded-lg shadow-md flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="text-lg">üîî</div>
        <div>
          <div class="font-bold">New version available</div>
          <div class="text-sm text-yellow-800">A new version of the portal is available. Refresh to get the latest
            updates.</div>
        </div>
      </div>
      <div class="flex items-center gap-3">
        <button id="update-reload-btn" class="bg-yellow-600 text-white px-4 py-2 rounded-md font-semibold">Reload
          Now</button>
        <button id="update-dismiss-btn" class="text-sm text-yellow-800 underline">Dismiss</button>
      </div>
    </div>
  </div>

  <!-- MAIN PORTAL LOGIN SCREEN -->
  <div id="portal-login-screen" class="fixed inset-0 bg-slate-900 z-50 overflow-y-auto overflow-x-hidden"
    style="perspective: 1500px;">


    <!-- The Split Doors (3D Swing) -->
    <div
      class="fixed inset-y-0 left-0 w-1/2 z-50 animate-door-left flex items-center justify-end border-r border-transparent shadow-2xl"
      style="background: linear-gradient(90deg, #7f1d1d 0%, #0b1220 50%, #1e3a8a 100%);">
    </div>
    <div
      class="fixed inset-y-0 right-0 w-1/2 z-50 animate-door-right flex items-center justify-start border-l border-transparent shadow-2xl"
      style="background: linear-gradient(270deg, #7f1d1d 0%, #0b1220 50%, #1e3a8a 100%);">
    </div>

    <!-- Revealed Background -->
    <div class="absolute inset-0 z-0"
      style="background: linear-gradient(135deg, #7f1d1d 0%, #0b1220 50%, #1e3a8a 100%);"></div>

    <!-- Background Typography Theme (Door Branding) -->
    <div id="door-brand" class="absolute inset-0 flex items-center justify-center pointer-events-none select-none z-10">
      <h1
        class="door-brand text-[18rem] font-montserrat font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-red-500 to-blue-500 whitespace-nowrap drop-shadow-lg"
        style="pointer-events: none; will-change: transform, opacity; transform: translateY(0) rotate(0deg);">
        Gojira</h1>
    </div>

    <!-- Colored Login Card -->
    <div class="min-h-screen w-full flex items-center justify-center py-20 relative z-50">
      <!-- Light/Dark Mode Toggle -->
      <button id="login-theme-toggle" onclick="toggleLoginTheme()"
        class="fixed top-6 right-6 z-50 bg-slate-200 dark:bg-slate-800 text-slate-800 dark:text-yellow-300 px-4 py-2 rounded-full font-bold shadow-lg hover:shadow-xl transition">
        ‚òÄÔ∏è Light
      </button>

      <div id="login-card"
        class="p-12 rounded-3xl shadow-2xl max-w-md w-full mx-4 relative z-50 login-card overflow-hidden border border-indigo-500/30 animate-zoom-in shadow-indigo-500/20"
        style="background-color: rgba(10, 14, 22, 0.97);">
        <div class="text-center mb-8">
          <div
            class="w-20 h-20 bg-gradient-to-br from-red-600 to-blue-600 rounded-full flex items-center justify-center text-white font-black text-4xl mx-auto mb-4 shadow-lg shadow-blue-900/50">
            G</div>
          <h1
            class="text-4xl font-black text-transparent bg-clip-text bg-gradient-to-r from-red-600 to-blue-600 drop-shadow-sm">
            Gojira</h1>

        </div>
        

        <form onsubmit="submitLogin(event)">
          <div class="mb-6">
            <label class="block text-sm font-semibold mb-2 login-label">Employee ID</label>
            <input id="portal-emp-id" type="text" required placeholder="Enter your Employee ID"
              class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-lg bg-slate-50 dark:bg-slate-700 focus:border-indigo-600 focus:ring-2 focus:ring-indigo-200 outline-none transition">
          </div>

          <div class="mb-6">
            <label class="block text-sm font-semibold mb-2 login-label">Password</label>
            <input id="portal-password" type="password" required placeholder="Enter your password"
              class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-lg bg-slate-50 dark:bg-slate-700 focus:border-indigo-600 focus:ring-2 focus:ring-indigo-200 outline-none transition">
          </div>

          <button type="submit"
            class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 transition mb-4">Login</button>
        </form>




        <div class="text-center mb-4">
          <button onclick="showChangePasswordModal()"
            class="text-indigo-600 hover:text-indigo-700 text-sm font-semibold underline">Change Password</button>
        </div>
      </div>
    </div>

    <!-- Contact Details Section (Login Screen) -->
    <div class="w-full max-w-5xl mx-auto mt-16 px-6 pb-20 relative z-50 animate-zoom-in" style="animation-delay: 0.5s;">
      <h3 class="text-2xl font-bold text-white/90 mb-8 flex items-center justify-center gap-2 drop-shadow-md">
        <span>üìû</span> Contact Us
      </h3>
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 text-center">

        <!-- Location -->
        <div
          class="p-6 rounded-2xl bg-slate-800/80 backdrop-blur-md shadow-lg border border-slate-700/50 hover:bg-slate-800 transition">
          <div class="text-4xl mb-4">üìç</div>
          <h4 class="font-bold text-slate-200 mb-2">Visit Us</h4>
          <p class="text-slate-400 text-sm leading-relaxed">
            Plot no. 516, 2nd Floor<br>
            Udyog Vihar Phase 3<br>
            Gurgaon, Haryana 122016
          </p>
        </div>

        <!-- Call -->
        <a href="tel:9220912305"
          class="p-6 rounded-2xl bg-slate-800/80 backdrop-blur-md shadow-lg border border-slate-700/50 hover:bg-slate-800 hover:border-blue-500/50 transition group">
          <div class="text-4xl mb-4 group-hover:scale-110 transition-transform">üìû</div>
          <h4 class="font-bold text-slate-200 mb-2 group-hover:text-blue-400 transition">Call Us</h4>
          <p class="text-slate-400 font-mono text-lg">9220912305</p>
        </a>

        <!-- WhatsApp -->
        <a href="https://wa.me/917668053516" target="_blank"
          class="p-6 rounded-2xl bg-slate-800/80 backdrop-blur-md shadow-lg border border-slate-700/50 hover:bg-slate-800 hover:border-green-500/50 transition group">
          <div class="text-4xl mb-4 group-hover:scale-110 transition-transform">üì±</div>
          <h4 class="font-bold text-slate-200 mb-2 group-hover:text-green-400 transition">WhatsApp</h4>
          <p class="text-slate-400 font-mono text-lg">7668053516</p>
        </a>

        <!-- Email -->
        <a href="mailto:divyanshu.sharma@bharatloan.com"
          class="p-6 rounded-2xl bg-slate-800/80 backdrop-blur-md shadow-lg border border-slate-700/50 hover:bg-slate-800 hover:border-amber-500/50 transition group">
          <div class="text-4xl mb-4 group-hover:scale-110 transition-transform">‚úâÔ∏è</div>
          <h4 class="font-bold text-slate-200 mb-2 group-hover:text-amber-400 transition">Email Us</h4>
          <p class="text-slate-400 text-sm break-all">divyanshu.sharma@bharatloan.com</p>
        </a>

      </div>
    </div>

    <!-- Web Shooter Animation Canvas (Inside Login Screen) -->
    <canvas id="twinkle-canvas" class="absolute inset-0 pointer-events-none" style="z-index: 20;"></canvas>

    <script>


      /**
       * BUBBLE NETWORK ANIMATION (Web Shooter Effect)
       */
      // Global animation state
      window.loginAnimState = {
        mode: localStorage.getItem('loginTheme') || 'bubble',
        canvas: null,
        particles: [],
        mouseX: -1000,
        mouseY: -1000
      };

      (function () {
        const loginScreen = document.getElementById('portal-login-screen');
        // Only run if we are inside the login screen context
        const canvas = document.getElementById('twinkle-canvas');
        if (!canvas || !loginScreen) return;
        
        window.loginAnimState.canvas = canvas;

        const ctx = canvas.getContext('2d');
        let width, height;

        // Resize
        function resize() {
          width = canvas.width = window.innerWidth;
          // Use scrollHeight to ensure it covers the full scrollable content (contacts etc.)
          height = canvas.height = Math.max(window.innerHeight, loginScreen.scrollHeight);
        }
        window.addEventListener('resize', resize);
        // Also resize on scroll to ensure dynamic content is covered if it expands
        loginScreen.addEventListener('scroll', () => {
          if (canvas.height < loginScreen.scrollHeight) resize();
        }); resize(); // Mouse Listeners
        document.addEventListener('mousemove', (e) => {
          // Adjust mouse coordinates relative to the canvas/scroll position
          const rect = canvas.getBoundingClientRect();
          window.loginAnimState.mouseX = e.clientX - rect.left;
          window.loginAnimState.mouseY = e.clientY - rect.top;
        });

        // Particle Class (Bubbles or Stars based on mode)
        class Particle {
          constructor(mode = 'bubble') {
            this.x = Math.random() * width;
            this.y = Math.random() * height;
            this.mode = mode;
            
            if (mode === 'star') {
              // Stars flow downward slowly
              this.vx = (Math.random() - 0.5) * 0.2;
              this.vy = Math.random() * 0.3 + 0.1; // Downward flow
              this.size = Math.random() * 1.5 + 0.8;
              this.color = 'rgba(255, 255, 255, 0.8)';
              this.scatterVx = 0;
              this.scatterVy = 0;
              this.scattering = false;
              this.scatterTimer = 0;
            } else {
              // Bubbles
              this.vx = (Math.random() - 0.5) * 0.4;
              this.vy = (Math.random() - 0.5) * 0.4;
              this.size = Math.random() * 3 + 2;
              const colors = ['rgba(100, 149, 237, 0.7)', 'rgba(255, 105, 180, 0.7)', 'rgba(50, 205, 50, 0.7)', 'rgba(255, 165, 0, 0.7)', 'rgba(0, 206, 209, 0.7)', 'rgba(138, 43, 226, 0.7)', 'rgba(255, 48, 48, 0.7)', 'rgba(255, 215, 0, 0.7)', 'rgba(64, 224, 208, 0.7)', 'rgba(220, 20, 60, 0.7)', 'rgba(173, 255, 47, 0.7)', 'rgba(30, 144, 255, 0.7)'];
              this.color = colors[Math.floor(Math.random() * colors.length)];
            }
          }

          update() {
            if (this.mode === 'star') {
              if (this.scattering) {
                this.x += this.scatterVx;
                this.y += this.scatterVy;
                this.scatterVx *= 0.95;
                this.scatterVy *= 0.95;
                this.scatterTimer--;
                if (this.scatterTimer <= 0) {
                  this.scattering = false;
                  this.vx = (Math.random() - 0.5) * 0.2;
                  this.vy = Math.random() * 0.3 + 0.1;
                }
              } else {
                this.x += this.vx;
                this.y += this.vy;
                if (this.y > height) this.y = -10;
                if (this.x < 0 || this.x > width) this.vx *= -1;
              }
            } else {
              this.x += this.vx;
              this.y += this.vy;
              if (this.x < 0 || this.x > width) this.vx *= -1;
              if (this.y < 0 || this.y > height) this.vy *= -1;
            }
          }

          scatter(mouseX, mouseY) {
            if (this.mode === 'star') {
              const dx = this.x - mouseX;
              const dy = this.y - mouseY;
              const dist = Math.hypot(dx, dy);
              if (dist < 120) {
                this.scattering = true;
                this.scatterTimer = 30;
                const angle = Math.atan2(dy, dx);
                this.scatterVx = Math.cos(angle) * 3;
                this.scatterVy = Math.sin(angle) * 3;
              }
            }
          }

          draw() {
            if (this.mode === 'star') {
              this.drawStar(this.x, this.y, 5, this.size, this.size * 0.5);
            } else {
              ctx.beginPath();
              ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
              ctx.fillStyle = this.color;
              ctx.fill();
            }
          }

          drawStar(cx, cy, spikes, outerRadius, innerRadius) {
            let rot = Math.PI / 2 * 3;
            let x = cx;
            let y = cy;
            const step = Math.PI / spikes;

            ctx.beginPath();
            ctx.moveTo(cx, cy - outerRadius);
            for (let i = 0; i < spikes; i++) {
              x = cx + Math.cos(rot) * outerRadius;
              y = cy + Math.sin(rot) * outerRadius;
              ctx.lineTo(x, y);
              rot += step;

              x = cx + Math.cos(rot) * innerRadius;
              y = cy + Math.sin(rot) * innerRadius;
              ctx.lineTo(x, y);
              rot += step;
            }
            ctx.lineTo(cx, cy - outerRadius);
            ctx.closePath();
            ctx.fillStyle = this.color;
            ctx.fill();
          }
        }

        let animationMode = localStorage.getItem('loginTheme') || 'bubble';
        
        window.reinitLoginAnimation = function() {
          animationMode = localStorage.getItem('loginTheme') || 'bubble';
          window.loginAnimState.particles = [];
          initParts();
        };

        function initParts() {
          window.loginAnimState.particles = [];
          const particleCount = Math.floor(width * height / 2500);
          for (let i = 0; i < particleCount; i++) { window.loginAnimState.particles.push(new Particle(animationMode)); }
        } 
        initParts(); 
        
        function animate() {
          ctx.clearRect(0, 0, width, height); 
          window.loginAnimState.particles.forEach(p => {
            p.update();
            if (animationMode === 'star') {
              p.scatter(window.loginAnimState.mouseX, window.loginAnimState.mouseY);
            }
            p.draw();
            
            if (animationMode === 'bubble') {
              const dist = Math.hypot(p.x - window.loginAnimState.mouseX, p.y - window.loginAnimState.mouseY);
              if (dist < 180) {
                ctx.beginPath(); 
                ctx.strokeStyle = `rgba(255, 255, 255, ${1 - dist / 180})`;
                ctx.lineWidth = 1.5; 
                ctx.moveTo(p.x, p.y); 
                ctx.lineTo(window.loginAnimState.mouseX, window.loginAnimState.mouseY); 
                ctx.stroke(); 
                p.x += (window.loginAnimState.mouseX - p.x) * 0.02; 
                p.y += (window.loginAnimState.mouseY - p.y) * 0.02;
              }
            }
          }); 
          requestAnimationFrame(animate);
        } 
        animate();
      })(); 
    </script>

  </div>


  <!-- PDF.js for SOP extraction -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
  <script>
    // Minimal client-side extractor: renders each PDF page to canvas and exposes PNG downloads.
    async function extractSOPGraphs() {
      const url = 'resources/SOP_BharatLoan2.pdf';
      try {
        const resp = await fetch(url);
        if (!resp.ok) throw new Error('fetch failed');
        const ab = await resp.arrayBuffer();
        await _extractFromArrayBuffer(ab);
        return;
      } catch (e) {
        // fallback: prompt user to upload the PDF
        console.warn('[extractSOPGraphs] fetch failed, requesting file from user', e);
        document.getElementById('sop-file-input').click();
      }
    }

    // Toggle preview + graphs; extract graphs lazily on first open
    async function showSOPDetails() {
      const preview = document.getElementById('sop-preview');
      const graphs = document.getElementById('sop-graphs');
      const container = document.getElementById('sop-graphs-container');
      if (!preview || !graphs) return;
      const isHidden = preview.classList.contains('hidden');
      if (isHidden) {
        preview.classList.remove('hidden');
        graphs.classList.remove('hidden');
        if (container && container.innerHTML.trim() === '') {
          await extractSOPGraphs();
        }
      } else {
        preview.classList.add('hidden');
        graphs.classList.add('hidden');
      }
    }

    function openSOPModal() {
      const modal = document.getElementById('sop-modal');
      if (modal) {
        modal.classList.remove('hidden');
        extractSOPGraphsToModal();
      }
    }

    function openSOPModalFullscreen() {
      const modal = document.getElementById('sop-modal');
      const content = document.getElementById('sop-modal-content');
      if (modal && content) {
        modal.classList.remove('hidden');
        extractSOPGraphsToModal();
        // Request fullscreen after a brief delay to ensure DOM is ready
        setTimeout(() => {
          if (content.requestFullscreen) {
            content.requestFullscreen().catch(err => console.log('Fullscreen error:', err));
          }
        }, 100);
      }
    }

    function closeSOPModal() {
      const modal = document.getElementById('sop-modal');
      if (modal) {
        modal.classList.add('hidden');
      }
    }

    function toggleSOPFullscreen() {
      const content = document.getElementById('sop-modal-content');
      if (content) {
        if (content.requestFullscreen) {
          if (document.fullscreenElement) {
            document.exitFullscreen();
          } else {
            content.requestFullscreen().catch(err => console.log('Fullscreen error:', err));
          }
        }
      }
    }

    async function extractSOPGraphsToModal() {
      const url = 'resources/SOP_BharatLoan2.pdf';
      try {
        const resp = await fetch(url);
        if (!resp.ok) throw new Error('fetch failed: ' + resp.status);
        const ab = await resp.arrayBuffer();
        await _extractFromArrayBufferToModal(ab);
        return;
      } catch (e) {
        console.warn('[extractSOPGraphsToModal] PDF fetch/extract error:', e);
      }
    }

    async function _extractFromArrayBufferToModal(ab) {
      try {
        const loadingTask = pdfjsLib.getDocument({ data: ab });
        const pdf = await loadingTask.promise;
        const container = document.getElementById('sop-modal-graphs-container');
        container.innerHTML = '';
        for (let i = 1; i <= pdf.numPages; i++) {
          const page = await pdf.getPage(i);
          const viewport = page.getViewport({ scale: 2 });
          const canvas = document.createElement('canvas');
          canvas.width = Math.floor(viewport.width);
          canvas.height = Math.floor(viewport.height);
          const ctx = canvas.getContext('2d');
          await page.render({ canvasContext: ctx, viewport }).promise;

          const dataUrl = canvas.toDataURL('image/png');

          const wrapper = document.createElement('div');
          wrapper.className = 'p-4 bg-slate-50 dark:bg-slate-800 rounded-lg border border-slate-200 dark:border-slate-700';
          wrapper.innerHTML = `
            <div class="mb-2 font-bold">Page ${i}</div>
            <img src="${dataUrl}" class="w-full rounded-lg mb-2" />
            <div class="flex gap-2">
              <a href="${dataUrl}" download="sop-page-${i}.png" class="bg-blue-600 text-white px-3 py-1 rounded text-sm">Download PNG</a>
            </div>`;

          container.appendChild(wrapper);
        }
      } catch (err) {
        console.error('Error extracting SOP images', err);
        alert('Failed to extract images from the PDF. Try uploading the PDF via the file selector.');
      }
    }

    document.addEventListener('DOMContentLoaded', function () {
      const input = document.getElementById('sop-file-input');
      if (input) {
        input.addEventListener('change', async function (e) {
          const f = e.target.files && e.target.files[0];
          if (!f) return;
          const ab = await f.arrayBuffer();
          await _extractFromArrayBufferToModal(ab);
        });
      }
    });
  </script>

  <!-- CHANGE PASSWORD MODAL -->
  <div id="change-password-modal"
    class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <!-- ... content kept as is ... -->
    <div class="bg-white dark:bg-slate-800 p-8 rounded-3xl shadow-lg max-w-md w-full mx-4">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold">Change Password</h2>
        <button onclick="hideChangePasswordModal()"
          class="text-slate-500 hover:text-slate-700 text-2xl">&times;</button>
      </div>

      <form onsubmit="submitChangePassword(event)">
        <div class="mb-6">
          <label class="block text-sm font-semibold mb-2">Employee ID</label>
          <input id="change-pass-emp-id" type="text" required placeholder="Enter your Employee ID"
            class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-lg bg-slate-50 dark:bg-slate-700 focus:border-indigo-600 outline-none transition">
        </div>

        <div class="mb-6">
          <label class="block text-sm font-semibold mb-2">Current Password</label>
          <input id="change-pass-current" type="password" required placeholder="Enter current password"
            class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-lg bg-slate-50 dark:bg-slate-700 focus:border-indigo-600 outline-none transition">
        </div>

        <div class="mb-6">
          <label class="block text-sm font-semibold mb-2">New Password</label>
          <input id="change-pass-new" type="password" required placeholder="Enter new password"
            class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-lg bg-slate-50 dark:bg-slate-700 focus:border-indigo-600 outline-none transition">
        </div>

        <button type="submit"
          class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 transition">Update
          Password</button>
      </form>
    </div>
  </div>

  <!-- ADMIN REVIEW TYPE MODAL (NEW) -->
  <div id="admin-review-type-modal"
    class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-[60] p-4">
    <div
      class="bg-white dark:bg-slate-800 rounded-3xl shadow-2xl max-w-md w-full p-8 transform transition-all scale-100">
      <div class="text-center mb-8">
        <div
          class="w-16 h-16 bg-blue-100 dark:bg-blue-900 rounded-full flex items-center justify-center mx-auto mb-4 text-3xl">
          üéØ</div>
        <h2 class="text-2xl font-bold mb-2">Select Review Type</h2>
        <p class="text-slate-600 dark:text-slate-400">Choose the type of interaction you want to review for <span
            id="review-type-agent-name" class="font-bold text-blue-600">Agent</span>.</p>
      </div>

      <div class="grid grid-cols-2 gap-4 mb-6">
        <button onclick="adminSelectReviewType('voice')"
          class="p-6 rounded-2xl border-2 border-slate-200 dark:border-slate-700 hover:border-blue-500 hover:bg-blue-50 dark:hover:bg-slate-700 transition group text-center">
          <div class="text-4xl mb-3 group-hover:scale-110 transition-transform">üéôÔ∏è</div>
          <div class="font-bold text-slate-800 dark:text-white">Voice</div>
          <p class="text-xs text-slate-500 mt-1">Upload Call Recording</p>
        </button>

        <button onclick="adminSelectReviewType('non-voice')"
          class="p-6 rounded-2xl border-2 border-slate-200 dark:border-slate-700 hover:border-purple-500 hover:bg-purple-50 dark:hover:bg-slate-700 transition group text-center">
          <div class="text-4xl mb-3 group-hover:scale-110 transition-transform">üí¨</div>
          <div class="font-bold text-slate-800 dark:text-white">Non-Voice</div>
          <p class="text-xs text-slate-500 mt-1">Chat / Email ID</p>
        </button>
      </div>

      <div class="text-center">
        <button onclick="document.getElementById('admin-review-type-modal').classList.add('hidden')"
          class="text-slate-400 hover:text-slate-600 font-semibold text-sm">Cancel</button>
      </div>
    </div>
  </div>

  <!-- NOTIFICATIONS MODAL -->
  <div id="notifications-modal"
    class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"
    onclick="if(event.target.id === 'notifications-modal') closeNotificationsModal()">
    <div class="bg-white dark:bg-slate-800 rounded-3xl shadow-2xl max-w-2xl w-full max-h-[80vh] overflow-y-auto"
      onclick="event.stopPropagation()">
      <div
        class="sticky top-0 bg-white dark:bg-slate-800 p-6 border-b border-slate-200 dark:border-slate-700 flex justify-between items-center">
        <div class="flex items-center gap-3">
          <h2 class="text-2xl font-bold">Notifications</h2>
          <button onclick="clearAllNotifications()"
            class="text-xs bg-slate-100 hover:bg-slate-200 dark:bg-slate-700 dark:hover:bg-slate-600 px-3 py-1 rounded-full font-semibold transition">
            Clear All
          </button>
        </div>
        <button onclick="closeNotificationsModal()" class="text-slate-500 hover:text-slate-700 text-2xl">‚úï</button>
      </div>

      <div id="notifications-list" class="p-6 space-y-3">
        <!-- Notifications populated here -->
      </div>

      <div id="notifications-empty" class="text-center py-12 p-6">
        <div class="text-4xl mb-4">‚ú®</div>
        <h4 class="text-xl font-bold text-slate-600 dark:text-slate-400">All Caught Up!</h4>
        <p class="text-slate-500 dark:text-slate-500 mt-2">No new notifications at the moment.</p>
      </div>
    </div>
  </div>

  <!-- TOP NAV (hidden initially) -->
  <nav id="top-nav"
    class="hidden bg-white dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700 sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-6 py-3 flex items-start justify-between">
      <div onclick="navigateTo('view-home')" class="flex gap-3 cursor-pointer group">
        <div
          class="w-12 h-12 bg-slate-900 dark:bg-slate-700 rounded flex items-center justify-center text-white font-bold group-hover:bg-blue-600 transition glow">
          G</div>
        <div class="flex flex-col">
          <span
            class="font-['Montserrat'] text-3xl text-transparent bg-clip-text bg-gradient-to-r from-blue-500 via-purple-500 to-indigo-600 stylish leading-none">
            Gojira
          </span>
        </div>
      </div>

      <div class="flex flex-col items-end gap-2">
        <div class="flex items-center gap-2">
          <!-- Firebase Status -->
          <div
            class="flex items-center bg-slate-100 dark:bg-slate-700 px-3 py-1 rounded-full text-xs font-semibold mr-2 border border-slate-200 dark:border-slate-600 cursor-pointer"
            title="Click to Test Connection" onclick="syncReviewsFromSupabase(); alert('Manual Sync Triggered');">
            <div id="firebase-status-dot" class="w-2 h-2 rounded-full bg-gray-400 mr-2"></div>
            <span id="firebase-status-text" class="text-slate-600 dark:text-slate-300">Connecting...</span>
          </div>

          <button onclick="toggleSearch()" class="text-slate-500 hover:text-blue-600 text-xl">üîç</button>
          <button id="theme-toggle" onclick="toggleTheme()"
            class="flex items-center justify-center p-2 rounded-full bg-slate-100 dark:bg-slate-700 text-sm transition"
            title="Toggle theme" aria-label="Toggle theme">
            <span id="theme-icon" class="text-xl">üåô</span>
            <span class="sr-only">Toggle theme</span>
          </button>

          <!-- Unified Notification Bell -->
          <div
            class="relative cursor-pointer hover:bg-slate-100 dark:hover:bg-slate-700 p-2 rounded-full transition notification-bell"
            onclick="checkNotifications(true)" title="Check Notifications">
            <span class="text-xl">üîî</span>
            <span
              class="notification-dot hidden absolute top-0 right-0 w-3 h-3 bg-red-500 rounded-full border-2 border-white dark:border-slate-800"></span>
          </div>

          <button onclick="portalLogout()"
            class="flex items-center gap-2 px-3 py-2 rounded-full bg-red-100 dark:bg-red-900 text-red-600 dark:text-red-300 text-sm font-semibold hover:bg-red-200 dark:hover:bg-red-800 transition"
            title="Logout" aria-label="Logout">
            <!-- Power icon (accessible) -->
            <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
              <path d="M12 2v10" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                stroke-linejoin="round" />
              <path d="M17.657 6.343a8 8 0 11-11.314 0" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                stroke-linejoin="round" />
            </svg>
            <span class="sr-only">Logout</span>
          </button>
        </div>

        <div id="search-bar" class="hidden">
          <input id="search-input" type="text" oninput="performSearch(this.value)" placeholder="Search portal..."
            class="px-4 py-2 rounded-full bg-slate-100 dark:bg-slate-700 text-sm w-64">
          <div id="search-results"
            class="mt-2 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg shadow-lg max-h-60 overflow-y-auto">
          </div>
        </div>
      </div>
    </div>
  </nav>

  <!-- HOME -->
  <div id="view-home" class="app-view active">
    <main class="max-w-7xl mx-auto px-6 py-20 text-center">
      <p id="home-user-greeting" class="text-3xl font-bold text-blue-600 dark:text-blue-400 mb-4">Hi Guest</p>

      <h1 class="text-5xl font-extrabold mb-12">
        Welcome to
        <span class="text-transparent bg-clip-text bg-gradient-to-r from-blue-600 to-indigo-600">
          Training & Quality Portal
        </span>
      </h1>

      <div class="grid grid-cols-1 md:grid-cols-4 gap-8" style="pointer-events: auto;">
        <div onclick="navigateTo('view-kb')"
          class="p-10 rounded-[2.5rem] cursor-pointer hover-lift bg-blue-600 text-white" style="pointer-events: auto;">
          <div class="w-16 h-16 bg-white/20 rounded-2xl mx-auto mb-6 flex items-center justify-center text-3xl">üìò</div>
          <h2 class="text-2xl font-bold mb-2">Knowledge Base</h2>
          <p class="text-sm opacity-90">Crucial FAQs and operational guidelines.</p>
        </div>

        <div onclick="navigateTo('view-entities')"
          class="p-10 rounded-[2.5rem] cursor-pointer hover-lift bg-indigo-600 text-white"
          style="pointer-events: auto;">
          <div class="w-16 h-16 bg-white/20 rounded-2xl mx-auto mb-6 flex items-center justify-center text-3xl">üè¶</div>
          <h2 class="text-2xl font-bold mb-2">Brand Entities</h2>
        </div>

        <div onclick="navigateTo('view-updates')"
          class="p-10 rounded-[2.5rem] cursor-pointer hover-lift bg-amber-500 text-white" style="pointer-events: auto;">
          <div class="w-16 h-16 bg-white/20 rounded-2xl mx-auto mb-6 flex items-center justify-center text-3xl">üì¢</div>
          <h2 class="text-2xl font-bold mb-2">New Updates</h2>
          <p class="text-sm opacity-90">Latest system & policy logs.</p>
        </div>

        <div onclick="navigateTo('view-resources')"
          class="p-10 rounded-[2.5rem] cursor-pointer hover-lift bg-purple-600 text-white"
          style="pointer-events: auto;">
          <div class="w-16 h-16 bg-white/20 rounded-2xl mx-auto mb-6 flex items-center justify-center text-3xl">üìÅ</div>
          <h2 class="text-2xl font-bold mb-2">Resources</h2>
          <p class="text-sm opacity-90">Guidelines and quality checkup</p>
        </div>
      </div>


    </main>
  </div>

  <!-- KNOWLEDGE BASE -->
  <div id="view-kb" class="app-view bg-white dark:bg-slate-900">
    <header
      class="h-16 flex items-center px-6 border-b border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800">
      <button onclick="navigateTo('view-home')" class="font-bold text-slate-500 hover:text-blue-600">‚Üê Home</button>
      <span class="mx-auto font-bold">Knowledge Base</span>
    </header>
    <div class="max-w-4xl mx-auto px-6 py-14">
      <h1 class="text-4xl font-extrabold mb-10">Frequently Asked Questions</h1>
      <div class="space-y-4">
        <!-- 1 -->
        <div class="faq-item border-b pb-4">
          <button onclick="toggleFaq(this)" class="w-full text-left font-bold text-lg">1. My loan is approved but not
            disbursed. Why?</button>
          <div class="faq-answer text-slate-600 dark:text-slate-300">
            <p class="mb-2">Loan disbursement may be pending due to:</p>
            <ul class="list-disc ml-6 space-y-1">
              <li>Incomplete documentation</li>
              <li>Bank account verification</li>
              <li>Internal compliance or risk checks</li>
            </ul>
            <p class="mt-2 font-medium">Our team will assist you with the exact reason.</p>
          </div>
        </div>

        <!-- 2 -->
        <div class="faq-item border-b pb-4">
          <button onclick="toggleFaq(this)" class="w-full text-left font-bold text-lg">2. Can I increase my loan amount
            after sanction?</button>
          <div class="faq-answer text-slate-600 dark:text-slate-300">
            <p class="mb-2">Loan enhancement depends on below mentioned criteria but can be done while accepting the
              offer not post sanction:</p>
            <ul class="list-disc ml-6 space-y-1">
              <li>Your credit profile</li>
              <li>Repayment history</li>
              <li>Internal eligibility checks</li>
            </ul>
            <p class="mt-2">You may reapply after closing or maintaining a good repayment track.</p>
          </div>
        </div>

        <!-- 3 -->
        <div class="faq-item border-b pb-4">
          <button onclick="toggleFaq(this)" class="w-full text-left font-bold text-lg">3. Why was my loan application
            rejected?</button>
          <div class="faq-answer text-slate-600 dark:text-slate-300">
            <p class="mb-2">Loan applications can be rejected due to:</p>
            <ul class="list-disc ml-6 space-y-1">
              <li>Credit score or repayment history</li>
              <li>Existing liabilities</li>
              <li>Internal risk assessment</li>
            </ul>
            <p class="mt-2">Customer care can guide but cannot override system decisions.</p>
          </div>
        </div>

        <!-- 4 -->
        <div class="faq-item border-b pb-4">
          <button onclick="toggleFaq(this)" class="w-full text-left font-bold text-lg">4. How long does it take for
            repayment to reflect after payment?</button>
          <div class="faq-answer text-slate-600 dark:text-slate-300">
            <p>Payments usually reflect within 24‚Äì48 working hours. Delays may occur due to bank processing or holidays.
            </p>
          </div>
        </div>

        <!-- 5 -->
        <div class="faq-item border-b pb-4">
          <button onclick="toggleFaq(this)" class="w-full text-left font-bold text-lg">5. How is my total payable amount
            calculated?</button>
          <div class="faq-answer text-slate-600 dark:text-slate-300">
            <p class="mb-2">Your payable amount includes:</p>
            <ul class="list-disc ml-6 space-y-1">
              <li>Loan Amount</li>
              <li>Interest calculated till the repayment date</li>
              <li>Penalty (2% post repayment date where 1% is daily interest and 1% is penalty)</li>
            </ul>
          </div>
        </div>

        <!-- 6 -->
        <div class="faq-item border-b pb-4">
          <button onclick="toggleFaq(this)" class="w-full text-left font-bold text-lg">6. Will my credit score be
            affected if I delay payment?</button>
          <div class="faq-answer text-slate-600 dark:text-slate-300">
            <p>Yes. Any delay in repayment may negatively impact your CIBIL score, which can affect future loan or
              credit card approvals.</p>
          </div>
        </div>

        <!-- 7 -->
        <div class="faq-item border-b pb-4">
          <button onclick="toggleFaq(this)" class="w-full text-left font-bold text-lg">7. I have already shared a
            Promise to Pay (PTP). Why am I being called again?</button>
          <div class="faq-answer text-slate-600 dark:text-slate-300">
            <p class="mb-2">We may call to:</p>
            <ul class="list-disc ml-6 space-y-1">
              <li>Confirm your payment readiness</li>
              <li>Check if funds have been arranged</li>
              <li>Assist you in making the payment earlier, if possible</li>
            </ul>
            <p class="mt-2">This helps avoid further penalties or escalation.</p>
          </div>
        </div>

        <!-- 8 -->
        <div class="faq-item border-b pb-4">
          <button onclick="toggleFaq(this)" class="w-full text-left font-bold text-lg">8. Will I continue to receive
            calls after making the payment?</button>
          <div class="faq-answer text-slate-600 dark:text-slate-300">
            <p>No. Once the payment is successfully received and updated in our system, collection calls will stop.</p>
            <p class="mt-2">If you still receive a call, please share the payment reference number with the agent.</p>
          </div>
        </div>

        <!-- 9 -->
        <div class="faq-item border-b pb-4">
          <button onclick="toggleFaq(this)" class="w-full text-left font-bold text-lg">9. What is NBFC?</button>
          <div class="faq-answer text-slate-600 dark:text-slate-300">
            <p>NBFC means Non-Banking Financial Company. It is a company that gives loans, but it is not a bank.</p>
            <div class="mt-4 p-4 bg-slate-50 dark:bg-slate-800 rounded-xl space-y-2">
              <p>üè¶ <strong>Bank</strong> = savings account + loans</p>
              <p>üí∞ <strong>NBFC</strong> = only loans</p>
            </div>
            <ul class="list-disc ml-6 mt-4 space-y-1">
              <li>NBFCs give personal loans, business loans, etc.</li>
              <li>They are approved by RBI</li>
              <li>You cannot open a savings account in an NBFC</li>
              <li>They are commonly used in instant loan apps</li>
            </ul>
            <p class="mt-3 text-sm italic">Example: If you take a quick loan from an app and get money fast, it is
              usually an NBFC, not a bank.</p>
          </div>
        </div>

        <!-- 10 -->
        <div class="faq-item border-b pb-4">
          <button onclick="toggleFaq(this)" class="w-full text-left font-bold text-lg">10. What is an Account
            Aggregator?</button>
          <div class="faq-answer text-slate-600 dark:text-slate-300">
            <p class="mb-3">An Account Aggregator (AA) is a secure system that lets you share your bank details
              digitally with a lender only after your permission. It helps banks/NBFCs check your financial data online,
              without paperwork.</p>
            <h4 class="font-bold mb-2">How it works:</h4>
            <ol class="list-decimal ml-6 space-y-1 mb-4">
              <li>You give consent</li>
              <li>Your bank statement / financial data is shared securely</li>
              <li>The lender checks your eligibility</li>
              <li>Loan gets processed faster</li>
            </ol>
            <div class="grid grid-cols-2 gap-2 text-sm">
              <div class="bg-slate-100 dark:bg-slate-800 p-2 rounded">üîí Safe & secure</div>
              <div class="bg-slate-100 dark:bg-slate-800 p-2 rounded">‚úÖ RBI regulated</div>
              <div class="bg-slate-100 dark:bg-slate-800 p-2 rounded">‚ùå No data without consent</div>
              <div class="bg-slate-100 dark:bg-slate-800 p-2 rounded">‚ö° Quick & paperless</div>
            </div>
          </div>
          
        </div>
      </div>
    </div>
  </div>

  <!-- BRAND ENTITIES -->
  <div id="view-entities" class="app-view">
    <header class="h-16 flex items-center px-6 border-b bg-white dark:bg-slate-800">
      <button onclick="navigateTo('view-home')" class="font-bold text-slate-500 hover:text-blue-600">‚Üê Home</button>
      <span class="mx-auto font-bold">Brand Entities</span>
    </header>

    <div class="max-w-6xl mx-auto px-6 py-14 text-center">
      <h1 class="text-3xl font-extrabold mb-12">Select an Entity to View Guidelines</h1>

      <div class="grid md:grid-cols-4 gap-8">
        <div onclick="navigateTo('view-bharatloan')"
          class="relative p-8 rounded-3xl cursor-pointer hover-lift bg-gradient-to-r from-blue-800 via-red-600 to-blue-900 text-white">
          <div
            class="w-16 h-16 bg-black rounded-2xl mx-auto mb-4 flex items-center justify-center font-extrabold text-2xl text-white">
            B</div>
          <h3 class="font-bold text-lg">BharatLoan</h3>
        </div>

        <div onclick="navigateTo('view-rupee112')"
          class="relative p-8 rounded-3xl cursor-pointer hover-lift bg-gradient-to-r from-green-500 to-red-600 text-white">
          <div
            class="w-16 h-16 bg-black rounded-2xl mx-auto mb-4 flex items-center justify-center font-extrabold text-2xl text-white">
            ‚Çπ</div>
          <h3 class="font-bold text-lg">Rupee112</h3>
        </div>

        <div onclick="navigateTo('view-loan112')"
          class="relative p-8 rounded-3xl cursor-pointer hover-lift bg-gradient-to-r from-blue-900 to-red-600 text-white">
          <div
            class="w-16 h-16 bg-black rounded-2xl mx-auto mb-4 flex items-center justify-center font-extrabold text-2xl text-white">
            L</div>
          <h3 class="font-bold text-lg">Loan112</h3>
        </div>

        <div onclick="navigateTo('view-rupeeontime')"
          class="relative p-8 rounded-3xl cursor-pointer hover-lift bg-gradient-to-r from-purple-600 to-red-600 text-white">
          <div
            class="w-16 h-16 bg-black rounded-2xl mx-auto mb-4 flex items-center justify-center font-extrabold text-2xl text-white">
            ‚úî</div>
          <h3 class="font-bold text-lg">RupeeOnTime</h3>
        </div>
      </div>
    </div>
  </div>

  <!-- UPDATES -->
  <div id="view-updates" class="app-view bg-white dark:bg-slate-900">
    <header class="h-16 flex items-center px-6 border-b bg-white dark:bg-slate-800">
      <button onclick="navigateTo('view-home')" class="font-bold text-slate-500 hover:text-blue-600">‚Üê Home</button>
      <span class="mx-auto font-bold">System Updates</span>
    </header>
    <div class="max-w-4xl mx-auto px-6 py-14">
      <h2 class="text-3xl font-extrabold mb-8">Recent Policy Changes</h2>
      <div
        class="bg-blue-50 dark:bg-slate-800 p-8 rounded-3xl border border-blue-100 dark:border-slate-700 text-center">
        <div class="text-4xl mb-4">‚ú®</div>
        <h3 class="text-xl font-bold mb-2">Stay Tuned!</h3>
        <p class="text-slate-600 dark:text-slate-400">There are no new updates currently.</p>
      </div>
    </div>
  </div>

  <!-- BHARATLOAN SPECIFIC VIEW -->
  <div id="view-bharatloan" class="app-view bg-white dark:bg-slate-900">
    <header
      class="h-16 flex items-center justify-between px-6 border-b border-slate-200 dark:border-slate-700 bg-gradient-to-r from-red-600 to-blue-900 text-white relative">
      <button onclick="navigateTo('view-entities')" class="font-bold text-white hover:text-blue-600">‚Üê Back to
        Entities</button>
      <button onclick="toggleDropdown('')" class="text-white hover:text-blue-600">Support üìû</button>
      <div id="support-dropdown"
        class="hidden absolute top-full right-0 mt-2 bg-gradient-to-r from-blue-800 via-red-600 to-blue-900 text-white border border-slate-200 dark:border-slate-700 rounded-lg shadow-lg p-4 z-10">
        <h4 class="font-bold mb-2">Contact Support</h4>
        <p><strong>Call:</strong> 8282824644</p>
        <p><strong>Email:</strong> care@bharatloan.com</p>
      </div>
    </header>

    <div class="max-w-5xl mx-auto px-6 py-14">
      <!-- Tabs -->
      <div class="flex border-b border-slate-200 dark:border-slate-700 mb-8">
        <button onclick="showTab('tools')" id="tab-tools"
          class="px-6 py-3 font-bold text-blue-600 border-b-2 border-blue-600">Our Operating Tools</button>
      </div>

      <!-- Tools Tab Content -->
      <div id="content-tools" class="tab-content">
        <div class="grid gap-6">
          <div
            class="group bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 p-6 rounded-3xl transition-all hover:shadow-lg">
            <div class="flex flex-col md:flex-row md:items-center justify-between gap-6">
              <div class="flex-1">
                <h3 class="text-xl font-bold mb-2">BharatLoan Portal and Search Module</h3>
                <p class="text-slate-600 dark:text-slate-300 text-sm leading-relaxed">
                  Main application processing, document view, and status checks. Customer search via PAN, Mobile, or
                  Email.
                </p>
              </div>
              <a href="https://bharatloanfintech.com/" target="_blank"
                class="bg-blue-600 text-white font-bold py-3 px-6 rounded-xl hover:bg-blue-700 transition">Visit Portal
                ‚Üó</a>
            </div>
          </div>

          <div
            class="group bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 p-6 rounded-3xl transition-all hover:shadow-lg">
            <div class="flex flex-col md:flex-row md:items-center justify-between gap-6">
              <div class="flex-1">
                <h3 class="text-xl font-bold mb-2">WOCOM 365</h3>
                <p class="text-slate-600 dark:text-slate-300 text-sm leading-relaxed">
                  Telephony integration, lead management, and communication logging.
                </p>
              </div>
              <a href="https://cpaas.wocom365.com/" target="_blank"
                class="bg-emerald-600 text-white font-bold py-3 px-6 rounded-xl hover:bg-emerald-700 transition">Open
                WOCOM ‚Üó</a>
            </div>
          </div>

          <div
            class="group bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 p-6 rounded-3xl transition-all hover:shadow-lg">
            <div class="flex flex-col md:flex-row md:items-center justify-between gap-6">
              <div class="flex-1">
                <h3 class="text-xl font-bold mb-2">Yellow Ai</h3>
                <p class="text-slate-600 dark:text-slate-300 text-sm leading-relaxed">
                  Handle real-time customer chats efficiently through the AI-powered cloud platform.
                </p>
              </div>
              <a href="https://cloud.yellow.ai/auth/login" target="_blank"
                class="bg-indigo-600 text-white font-bold py-3 px-6 rounded-xl hover:bg-indigo-700 transition">Login
                Chat ‚Üó</a>
            </div>
          </div>

          <div
            class="group bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 p-6 rounded-3xl transition-all hover:shadow-lg">
            <div class="flex flex-col md:flex-row md:items-center justify-between gap-6">
              <div class="flex-1">
                <h3 class="text-xl font-bold mb-2">Outlook (Care@bharatloan.com)</h3>
                <p class="text-slate-600 dark:text-slate-300 text-sm leading-relaxed">
                  Review customer emails and attachments. Standard channel for ticketing and complex queries.
                </p>
              </div>
              <a href="https://outlook.office.com/mail/" target="_blank"
                class="bg-amber-500 text-white font-bold py-3 px-6 rounded-xl hover:bg-amber-600 transition">Open Mail
                ‚Üó</a>
            </div>
          </div>

          <div
            class="group bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 p-6 rounded-3xl transition-all hover:shadow-lg">
            <div class="flex flex-col md:flex-row md:items-center justify-between gap-6">
              <div class="flex-1">
                <h3 class="text-xl font-bold mb-2">Refund Sheet</h3>
                <p class="text-slate-600 dark:text-slate-300 text-sm leading-relaxed">
                  Refund Tracker for processing and status updates.
                </p>
              </div>
              <a href="https://bharatloan1-my.sharepoint.com/:x:/g/personal/karamjit_singh_bharatloan_com/IQCJrpeD0n1mRZIu_vPq7HqGAQKM_Bvbax8CFaRwSYLBes4?e=Tb7xev"
                target="_blank"
                class="bg-green-600 text-white font-bold py-3 px-6 rounded-xl hover:bg-green-700 transition">Open Sheet
                ‚Üó</a>
            </div>
          </div>
        </div>
      </div>


    </div>
  </div>

  <!-- RESOURCES -->
  <div id="view-resources" class="app-view bg-white dark:bg-slate-900">
    <header class="h-16 flex items-center px-6 border-b bg-white dark:bg-slate-800">
      <button onclick="navigateTo('view-home')" class="font-bold text-slate-500 hover:text-blue-600">‚Üê Home</button>
      <span class="mx-auto font-bold">Resources</span>
    </header>
    <div class="max-w-4xl mx-auto px-6 py-14">
      <div class="space-y-6">
        <div
          class="bg-slate-50 dark:bg-slate-800 p-6 rounded-3xl border border-slate-200 dark:border-slate-700 cursor-pointer hover:border-purple-600 transition"
          onclick="document.getElementById('guidelines-list').classList.toggle('hidden')">
          <div class="flex items-center gap-4">
            <div class="w-12 h-12 bg-purple-600 text-white rounded-xl flex items-center justify-center text-xl">üìÑ</div>
            <div class="flex-1">
              <h3 class="text-xl font-bold">Guidelines</h3>
              <p class="text-slate-600 dark:text-slate-300">Click to view operational procedures.</p>
            </div>
            <div class="text-2xl text-slate-400">‚ñº</div>
          </div>

          <div id="guidelines-list" class="hidden space-y-4 mt-6 pt-6 border-t border-slate-200 dark:border-slate-700"
            onclick="event.stopPropagation()">
            <!-- 1. Payment Queries -->
            <div class="faq-item border-b border-slate-200 dark:border-slate-700 pb-4">
              <button onclick="toggleFaq(this)" class="w-full text-left font-bold text-lg">1. Payment Queries</button>
              <div class="faq-answer text-slate-600 dark:text-slate-300 text-sm">
                <div class="mb-4 mt-2">
                  <h4 class="font-bold text-slate-800 dark:text-slate-100 mb-2">A. Payment Not Reflecting (Agent Portal)
                  </h4>
                  <p><strong>Step 1:</strong> Verbally confirm the exact payment amount with the customer.</p>
                  <p><strong>Step 2:</strong> Update the WhatsApp Group immediately with the confirmed amount.</p>
                  <p><strong>Step 3:</strong> Escalate/Tag the concerned team via email.</p>
                  <p class="text-red-500 font-bold mt-1">Rule: Escalation is forbidden without prior amount
                    confirmation.</p>
                </div>
                <div>
                  <h4 class="font-bold text-slate-800 dark:text-slate-100 mb-2">B. Payment Reflecting (Verification
                    Pending)</h4>
                  <p><strong>Script:</strong> "We have received your payment of ‚Çπ[Amount]. Your payment is currently
                    under verification and will be updated within 24 hours (maximum)."</p>
                </div>
              </div>
            </div>

            <!-- 2. Application Status Queries -->
            <div class="faq-item border-b border-slate-200 dark:border-slate-700 pb-4">
              <button onclick="toggleFaq(this)" class="w-full text-left font-bold text-lg">2. Application Status
                Queries</button>
              <div class="faq-answer text-slate-600 dark:text-slate-300 text-sm">
                <div class="mb-4 mt-2">
                  <h4 class="font-bold text-slate-800 dark:text-slate-100 mb-2">A. Incomplete Applications
                    (Leads/Partial/eKYC Pending)</h4>
                  <p><strong>Script:</strong> "Your application is currently in process. Kindly complete the remaining
                    steps 100% through the application. If you are facing any issues, please visit our website or
                    contact us at care@bharatloan.com and try again after some time."</p>
                  <p class="mt-2"><strong>If asked about time:</strong> "There is a maximum processing time of 24 hours
                    after 100% completion. A credit manager will then be assigned and will contact you within 24 hours."
                  </p>
                  <p class="text-red-500 font-bold mt-1">üö´ Prohibition: Never assure a callback within 24 hours for
                    incomplete applications.</p>
                </div>
                <div class="mb-4">
                  <h4 class="font-bold text-slate-800 dark:text-slate-100 mb-2">B. Successfully Submitted (#Reference
                    Generated)</h4>
                  <p><strong>Script:</strong> "Your application has been submitted successfully. Our team will contact
                    you within 24 hours."</p>
                </div>
                <div>
                  <h4 class="font-bold text-slate-800 dark:text-slate-100 mb-2">C. Repeat Customers (100% Applied)</h4>
                  <p><strong>Script:</strong> "Since you are an existing customer, your application status is in
                    process. Kindly wait while a credit manager is assigned. They will contact you within 24 hours."</p>
                </div>
              </div>
            </div>

            <!-- 3. Credit Manager Escalations -->
            <div class="faq-item border-b border-slate-200 dark:border-slate-700 pb-4">
              <button onclick="toggleFaq(this)" class="w-full text-left font-bold text-lg">3. Credit Manager
                Escalations</button>
              <div class="faq-answer text-slate-600 dark:text-slate-300 text-sm">
                <table class="w-full text-left mt-2 border-collapse">
                  <thead>
                    <tr class="border-b border-slate-200 dark:border-slate-700">
                      <th class="py-2 font-bold">Scenario</th>
                      <th class="py-2 font-bold">Action</th>
                      <th class="py-2 font-bold">Agent Script</th>
                    </tr>
                  </thead>
                  <tbody class="divide-y divide-slate-100 dark:divide-slate-700">
                    <tr>
                      <td class="py-2 pr-2">New Concern</td>
                      <td class="py-2 pr-2">Highlight/Escalate</td>
                      <td class="py-2 italic">"Your concern is being escalated; the team will contact you within 24
                        hours."</td>
                    </tr>
                    <tr>
                      <td class="py-2 pr-2">Raised Same Day</td>
                      <td class="py-2 pr-2">Verify previous log</td>
                      <td class="py-2 italic">"An executive has already escalated this; the team will contact you within
                        24 hours."</td>
                    </tr>
                    <tr>
                      <td class="py-2 pr-2">Raised Twice</td>
                      <td class="py-2 pr-2">Tag Manager in email</td>
                      <td class="py-2 italic">"We are prioritizing this with senior management. Please wait for the 24h
                        window."</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>

            <!-- 4. Collections & Special Requests -->
            <div class="faq-item border-b border-slate-200 dark:border-slate-700 pb-4">
              <button onclick="toggleFaq(this)" class="w-full text-left font-bold text-lg">4. Collections & Special
                Requests</button>
              <div class="faq-answer text-slate-600 dark:text-slate-300 text-sm">
                <div class="mb-4 mt-2">
                  <h4 class="font-bold text-slate-800 dark:text-slate-100 mb-2">A. Medical Extensions</h4>
                  <p><strong>Mandatory Script:</strong> "We do not have the authority to grant extensions. Your case is
                    with the collection team. If payment is delayed, it may impact your CIBIL score, and a 2% daily
                    charge (1% interest + 1% penalty) will apply. Please email valid medical documents to
                    care@bharatloan.com for review."</p>
                </div>
                <div>
                  <h4 class="font-bold text-slate-800 dark:text-slate-100 mb-2">B. Penalty Waiver / Settlement</h4>
                  <p><strong>Step 1:</strong> Ask the customer for the specific reason.</p>
                  <p><strong>Script:</strong> "We do not have authority for waivers. Please email care@bharatloan.com
                    with valid reasons and evidence. Your concern will be escalated for a response within 24 hours."</p>
                </div>
              </div>
            </div>

            <!-- 5. Disbursement & Refunds -->
            <div class="faq-item border-b border-slate-200 dark:border-slate-700 pb-4">
              <button onclick="toggleFaq(this)" class="w-full text-left font-bold text-lg">5. Disbursement &
                Refunds</button>
              <div class="faq-answer text-slate-600 dark:text-slate-300 text-sm">
                <div class="mb-4 mt-2">
                  <h4 class="font-bold text-slate-800 dark:text-slate-100 mb-2">A. Disbursement Delay</h4>
                  <p><strong>Rule:</strong> Wait 24 hours from the disbursement date.</p>
                  <p><strong>Action (&lt;24h):</strong> Do not escalate. Advise the customer to wait.</p>
                  <p><strong>Action (&gt;24h):</strong> Request a bank statement via email for verification.</p>
                </div>
                <div class="mb-4">
                  <h4 class="font-bold text-slate-800 dark:text-slate-100 mb-2">B. Cancellation After Disbursement</h4>
                  <p><strong>Action:</strong> Immediately update the Refund Tracker under the sheet ‚ÄúCancel After
                    Disbursement‚Äù with 100% accurate details.</p>
                </div>
                <div>
                  <h4 class="font-bold text-slate-800 dark:text-slate-100 mb-2">C. Pending Refunds</h4>
                  <p><strong>Step 1:</strong> Confirm the refund amount with the customer.</p>
                  <p><strong>Timeline:</strong> Inform the customer of the 7‚Äì10 working days window.</p>
                </div>
              </div>
            </div>

            <!-- 6. Email Protocol -->
            <div class="faq-item border-b border-slate-200 dark:border-slate-700 pb-4">
              <button onclick="toggleFaq(this)" class="w-full text-left font-bold text-lg">6. Email Protocol
                (Mandatory)</button>
              <div class="faq-answer text-slate-600 dark:text-slate-300 text-sm">
                <div class="mb-4 mt-2">
                  <p class="text-red-500 font-bold mb-2">üö´ Strict Prohibition: Never use "Sir" or "Ma'am."</p>
                  <p><strong>Greeting:</strong> Always use the customer's First Name (e.g., "Dear Rajesh,").</p>
                </div>
                <div
                  class="bg-indigo-50 dark:bg-slate-700 p-4 rounded-xl border border-indigo-100 dark:border-slate-600">
                  <h4 class="font-bold text-indigo-700 dark:text-indigo-300 mb-2">Payment Confirmation Format:</h4>
                  <p class="font-mono text-xs">
                    Dear [Customer Name],<br><br>
                    This is to confirm that we have received your payment as per the details below:<br><br>
                    Loan Number: {{Loan Number}}<br>
                    Amount Paid: {{Amount}}<br>
                    Date of Payment: {{Payment Date}}
                  </p>
                </div>
              </div>
            </div>

          </div>
        </div>

        <!-- Inserted SOP (user PDF) -->
        <div id="sop-card"
          class="bg-slate-50 dark:bg-slate-800 p-6 rounded-3xl border border-slate-200 dark:border-slate-700 cursor-pointer hover:border-purple-600 transition"
          onclick="event.stopPropagation()">
          <div class="flex items-center gap-4 mb-4">
            <div class="w-12 h-12 bg-indigo-600 text-white rounded-xl flex items-center justify-center text-xl">üìö</div>
            <div class="flex-1">
              <h3 class="text-xl font-bold">Standard Operating Procedure</h3>
            </div>
            <div class="flex-none flex items-center gap-2">
              <a id="sop-download-abs" href="file:///C:/Users/Divyanshu704/Downloads/SOP_BharatLoan2%20(1)%20(1).pdf"
                target="_blank" class="text-slate-500 hover:text-blue-600">Open local file ‚Üó</a>
            </div>
          </div>

          <div class="mt-4">
            <button onclick="event.stopPropagation(); openSOPModalFullscreen()"
              class="font-bold text-sm text-white bg-indigo-600 hover:bg-indigo-700 py-2 px-4 rounded-lg transition">üñ•Ô∏è Fullscreen</button>
          </div>

          <input id="sop-file-input" type="file" accept="application/pdf" class="hidden" />
        </div>

        <!-- Quality Assurance Checklist - Agent Only -->
        

        <div id="qa-checklist-card-agent"
          class="hidden bg-slate-50 dark:bg-slate-800 p-6 rounded-3xl border border-slate-200 dark:border-slate-700 cursor-pointer hover:border-purple-400 transition"
          onclick="navigateTo('view-agent-qa')">
          <div class="flex items-center gap-4 mb-4">
            <div class="w-12 h-12 bg-purple-600 text-white rounded-xl flex items-center justify-center text-xl">üìä</div>
            <div>
              <h3 class="text-xl font-bold">Quality Assurance Checklist</h3>
              <p class="text-slate-600 dark:text-slate-300">View your weekly performance and reviews.</p>
            </div>
          </div>
        </div>

        <!-- Quality Assurance Checklist - Non-Agent Users -->
        <div id="qa-checklist-card-other"
          class="bg-slate-50 dark:bg-slate-800 p-6 rounded-3xl border border-slate-200 dark:border-slate-700 cursor-pointer"
          onclick="navigateTo('view-checklist')">
          <div class="flex items-center gap-4 mb-4">
            <div class="w-12 h-12 bg-teal-600 text-white rounded-xl flex items-center justify-center text-xl">üéØ</div>
            <div>
              <h3 class="text-xl font-bold">Quality Assurance Checklist</h3>
              <p class="text-slate-600 dark:text-slate-300">Click to view entity checklists.</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- CHECKLIST VIEW -->
  <div id="view-checklist" class="app-view bg-white dark:bg-slate-900">
    <header class="h-16 flex items-center px-6 border-b bg-white dark:bg-slate-800">
      <button onclick="navigateTo('view-resources')" class="font-bold text-slate-500 hover:text-blue-600">‚Üê Back to
        Resources</button>
      <span class="mx-auto font-bold">Quality Assurance Checklist</span>
    </header>

    <div class="max-w-6xl mx-auto px-6 py-14 text-center">
      <h1 class="text-3xl font-extrabold mb-12">Quality Assurance Checklist</h1>

      <ol class="text-left max-w-2xl mx-auto space-y-6 text-slate-700 dark:text-slate-300">
        <!-- BharatLoan -->
        <div
          class="bg-white dark:bg-slate-800 rounded-2xl shadow-lg border border-slate-200 dark:border-slate-700 overflow-hidden">
          <div onclick="handleChecklistClick('BharatLoan')"
            class="cursor-pointer hover:scale-[1.02] transition-all duration-300 text-2xl font-bold p-6 bg-gradient-to-r from-blue-800 via-blue-700 to-blue-900 text-white flex items-center gap-4">
            <span class="bg-white/20 w-12 h-12 rounded-full flex items-center justify-center text-xl">B</span>
            <div class="flex-1">1. BharatLoan</div>
            <span class="text-sm opacity-80 backdrop-blur-sm bg-white/20 px-3 py-1 rounded-full">Enter Dashboard
              ‚Üí</span>
          </div>

        </div>

        <!-- RupeeOnTime -->
        <div
          class="bg-white dark:bg-slate-800 rounded-2xl shadow-lg border border-slate-200 dark:border-slate-700 overflow-hidden">
          <div onclick="handleChecklistClick('RupeeOnTime')"
            class="cursor-pointer hover:scale-[1.02] transition-all duration-300 text-2xl font-bold p-6 bg-gradient-to-r from-purple-600 via-purple-500 to-purple-800 text-white flex items-center gap-4">
            <span class="bg-white/20 w-12 h-12 rounded-full flex items-center justify-center text-xl">‚úî</span>
            <div class="flex-1">2. RupeeOnTime</div>
            <span class="text-sm opacity-80 backdrop-blur-sm bg-white/20 px-3 py-1 rounded-full">Enter Dashboard
              ‚Üí</span>
          </div>

        </div>
        <!-- Rupee112 -->
        <div
          class="bg-white dark:bg-slate-800 rounded-2xl shadow-lg border border-slate-200 dark:border-slate-700 overflow-hidden">
          <div onclick="handleChecklistClick('Rupee112')"
            class="cursor-pointer hover:scale-[1.02] transition-all duration-300 text-2xl font-bold p-6 bg-gradient-to-r from-emerald-600 via-emerald-500 to-emerald-800 text-white flex items-center gap-4">
            <span class="bg-white/20 w-12 h-12 rounded-full flex items-center justify-center text-xl">‚Çπ</span>
            <div class="flex-1">3. Rupee112</div>
            <span class="text-sm opacity-80 backdrop-blur-sm bg-white/20 px-3 py-1 rounded-full">Enter Dashboard
              ‚Üí</span>
          </div>

        </div>

        <!-- Loan112 -->
        <div
          class="bg-white dark:bg-slate-800 rounded-2xl shadow-lg border border-slate-200 dark:border-slate-700 overflow-hidden">
          <div onclick="handleChecklistClick('Loan112')"
            class="cursor-pointer hover:scale-[1.02] transition-all duration-300 text-2xl font-bold p-6 bg-gradient-to-r from-indigo-600 via-indigo-500 to-indigo-900 text-white flex items-center gap-4">
            <span class="bg-white/20 w-12 h-12 rounded-full flex items-center justify-center text-xl">L</span>
            <div class="flex-1">4. Loan112</div>
            <span class="text-sm opacity-80 backdrop-blur-sm bg-white/20 px-3 py-1 rounded-full">Enter Dashboard
              ‚Üí</span>
          </div>

        </div>
      </ol>
    </div>
  </div>

  <!-- RUPEE112 SPECIFIC VIEW -->
  <div id="view-rupee112" class="app-view bg-white dark:bg-slate-900">
    <header
      class="h-16 flex items-center justify-between px-6 border-b border-slate-200 dark:border-slate-700 bg-gradient-to-r from-green-500 to-red-600 text-white relative">
      <button onclick="navigateTo('view-entities')" class="font-bold text-white hover:text-blue-600">‚Üê Back to
        Entities</button>

      <button onclick="toggleDropdown('rupee112')" class="text-white hover:text-blue-600">Support üìû</button>
      <div id="support-dropdown-rupee112"
        class="hidden absolute top-full right-0 mt-2 bg-gradient-to-r from-green-500 to-red-600 text-white border border-slate-200 dark:border-slate-700 rounded-lg shadow-lg p-4 z-10">
        <h4 class="font-bold mb-2">Contact Support</h4>
        <p><strong>Call:</strong> 9220644112</p>
        <p><strong>Email:</strong> care@rupee112.com</p>
      </div>
    </header>

    <div class="max-w-5xl mx-auto px-6 py-14">
      <!-- Tabs -->
      <div class="flex border-b border-slate-200 dark:border-slate-700 mb-8">
        <button onclick="showTab('tools', 'rupee112')" id="tab-tools-rupee112"
          class="px-6 py-3 font-bold text-blue-600 border-b-2 border-blue-600">Our Operating Tools</button>
      </div>

      <!-- Tools Tab Content -->
      <div id="content-tools-rupee112" class="tab-content">
        <div class="grid gap-6">
          <div
            class="group bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 p-6 rounded-3xl transition-all hover:shadow-lg">
            <div class="flex flex-col md:flex-row md:items-center justify-between gap-6">
              <div class="flex-1">
                <h3 class="text-xl font-bold mb-2">Rupee112 Portal and Search Module</h3>
                <p class="text-slate-600 dark:text-slate-300 text-sm leading-relaxed">
                  Main application processing, document view, and status checks. Customer search via PAN, Mobile, or
                  Email.
                </p>
              </div>
              <a href="https://rupee112fintech.com/" target="_blank"
                class="bg-blue-600 text-white font-bold py-3 px-6 rounded-xl hover:bg-blue-700 transition">Visit Portal
                ‚Üó</a>
            </div>
          </div>

          <div
            class="group bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 p-6 rounded-3xl transition-all hover:shadow-lg">
            <div class="flex flex-col md:flex-row md:items-center justify-between gap-6">
              <div class="flex-1">
                <h3 class="text-xl font-bold mb-2">WOCOM 365</h3>
                <p class="text-slate-600 dark:text-slate-300 text-sm leading-relaxed">
                  Telephony integration, lead management, and communication logging.
                </p>
              </div>
              <a href="https://cpaas.wocom365.com/" target="_blank"
                class="bg-emerald-600 text-white font-bold py-3 px-6 rounded-xl hover:bg-emerald-700 transition">Open
                WOCOM ‚Üó</a>
            </div>
          </div>

          <div
            class="group bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 p-6 rounded-3xl transition-all hover:shadow-lg">
            <div class="flex flex-col md:flex-row md:items-center justify-between gap-6">
              <div class="flex-1">
                <h3 class="text-xl font-bold mb-2">Yellow Ai</h3>
                <p class="text-slate-600 dark:text-slate-300 text-sm leading-relaxed">
                  Handle real-time customer chats efficiently through the AI-powered cloud platform.
                </p>
              </div>
              <a href="https://cloud.yellow.ai/auth/login" target="_blank"
                class="bg-indigo-600 text-white font-bold py-3 px-6 rounded-xl hover:bg-indigo-700 transition">Login
                Chat ‚Üó</a>
            </div>
          </div>

          <div
            class="group bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 p-6 rounded-3xl transition-all hover:shadow-lg">
            <div class="flex flex-col md:flex-row md:items-center justify-between gap-6">
              <div class="flex-1">
                <h3 class="text-xl font-bold mb-2">Outlook (Care@rupee112.com)</h3>
                <p class="text-slate-600 dark:text-slate-300 text-sm leading-relaxed">
                  Review customer emails and attachments. Standard channel for ticketing and complex queries.
                </p>
              </div>
              <a href="https://outlook.office.com/mail/" target="_blank"
                class="bg-amber-500 text-white font-bold py-3 px-6 rounded-xl hover:bg-amber-600 transition">Open Mail
                ‚Üó</a>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- LOAN112 SPECIFIC VIEW -->
  <div id="view-loan112" class="app-view bg-white dark:bg-slate-900">
    <header
      class="h-16 flex items-center justify-between px-6 border-b border-slate-200 dark:border-slate-700 bg-gradient-to-r from-blue-900 to-red-600 text-white relative">
      <button onclick="navigateTo('view-entities')" class="font-bold text-white hover:text-blue-600">‚Üê Back to
        Entities</button>

      <button onclick="toggleDropdown('loan112')" class="text-white hover:text-blue-600">Support üìû</button>
      <div id="support-dropdown-loan112"
        class="hidden absolute top-full right-0 mt-2 bg-gradient-to-r from-blue-900 to-red-600 text-white border border-slate-200 dark:border-slate-700 rounded-lg shadow-lg p-4 z-10">
        <h4 class="font-bold mb-2">Contact Support</h4>
        <p><strong>Call:</strong> 9311912970</p>
        <p><strong>Email:</strong> care@loan112.com</p>
      </div>
    </header>

    <div class="max-w-5xl mx-auto px-6 py-14">
      <!-- Tabs -->
      <div class="flex border-b border-slate-200 dark:border-slate-700 mb-8">
        <button onclick="showTab('tools', 'loan112')" id="tab-tools-loan112"
          class="px-6 py-3 font-bold text-blue-600 border-b-2 border-blue-600">Our Operating Tools</button>
      </div>

      <!-- Tools Tab Content -->
      <div id="content-tools-loan112" class="tab-content">
        <div class="grid gap-6">
          <div
            class="group bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 p-6 rounded-3xl transition-all hover:shadow-lg">
            <div class="flex flex-col md:flex-row md:items-center justify-between gap-6">
              <div class="flex-1">
                <h3 class="text-xl font-bold mb-2">Loan112 Portal and Search Module</h3>
                <p class="text-slate-600 dark:text-slate-300 text-sm leading-relaxed">
                  Main application processing, document view, and status checks. Customer search via PAN, Mobile, or
                  Email.
                </p>
              </div>
              <a href="https://loan112fintech.com/" target="_blank"
                class="bg-blue-600 text-white font-bold py-3 px-6 rounded-xl hover:bg-blue-700 transition">Visit Portal
                ‚Üó</a>
            </div>
          </div>

          <div
            class="group bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 p-6 rounded-3xl transition-all hover:shadow-lg">
            <div class="flex flex-col md:flex-row md:items-center justify-between gap-6">
              <div class="flex-1">
                <h3 class="text-xl font-bold mb-2">WOCOM 365</h3>
                <p class="text-slate-600 dark:text-slate-300 text-sm leading-relaxed">
                  Telephony integration, lead management, and communication logging.
                </p>
              </div>
              <a href="https://cpaas.wocom365.com/" target="_blank"
                class="bg-emerald-600 text-white font-bold py-3 px-6 rounded-xl hover:bg-emerald-700 transition">Open
                WOCOM ‚Üó</a>
            </div>
          </div>

          <div
            class="group bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 p-6 rounded-3xl transition-all hover:shadow-lg">
            <div class="flex flex-col md:flex-row md:items-center justify-between gap-6">
              <div class="flex-1">
                <h3 class="text-xl font-bold mb-2">Yellow Ai</h3>
                <p class="text-slate-600 dark:text-slate-300 text-sm leading-relaxed">
                  Handle real-time customer chats efficiently through the AI-powered cloud platform.
                </p>
              </div>
              <a href="https://cloud.yellow.ai/auth/login" target="_blank"
                class="bg-indigo-600 text-white font-bold py-3 px-6 rounded-xl hover:bg-indigo-700 transition">Login
                Chat ‚Üó</a>
            </div>
          </div>

          <div
            class="group bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 p-6 rounded-3xl transition-all hover:shadow-lg">
            <div class="flex flex-col md:flex-row md:items-center justify-between gap-6">
              <div class="flex-1">
                <h3 class="text-xl font-bold mb-2">Outlook (Care@loan112.com)</h3>
                <p class="text-slate-600 dark:text-slate-300 text-sm leading-relaxed">
                  Review customer emails and attachments. Standard channel for ticketing and complex queries.
                </p>
              </div>
              <a href="https://outlook.office.com/mail/" target="_blank"
                class="bg-amber-500 text-white font-bold py-3 px-6 rounded-xl hover:bg-amber-600 transition">Open Mail
                ‚Üó</a>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- RUPEEONTIME SPECIFIC VIEW -->
  <div id="view-rupeeontime" class="app-view bg-white dark:bg-slate-900">
    <header
      class="h-16 flex items-center justify-between px-6 border-b border-slate-200 dark:border-slate-700 bg-gradient-to-r from-purple-600 to-red-600 text-white relative">
      <button onclick="navigateTo('view-entities')" class="font-bold text-white hover:text-blue-600">‚Üê Back to
        Entities</button>

      <button onclick="toggleDropdown('rupeeontime')" class="text-white hover:text-blue-600">Support üìû</button>
      <div id="support-dropdown-rupeeontime"
        class="hidden absolute top-full right-0 mt-2 bg-gradient-to-r from-purple-600 to-red-600 text-white border border-slate-200 dark:border-slate-700 rounded-lg shadow-lg p-4 z-10">
        <h4 class="font-bold mb-2">Contact Support</h4>
        <p><strong>Call:</strong> 9220912304</p>
        <p><strong>Email:</strong> care@rupeeontime.com</p>
      </div>
    </header>

    <div class="max-w-5xl mx-auto px-6 py-14">
      <!-- Tabs -->
      <div class="flex border-b border-slate-200 dark:border-slate-700 mb-8">
        <button onclick="showTab('tools', 'rupeeontime')" id="tab-tools-rupeeontime"
          class="px-6 py-3 font-bold text-blue-600 border-b-2 border-blue-600">Our Operating Tools</button>
      </div>

      <!-- Tools Tab Content -->
      <div id="content-tools-rupeeontime" class="tab-content">
        <div class="grid gap-6">
          <div
            class="group bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 p-6 rounded-3xl transition-all hover:shadow-lg">
            <div class="flex flex-col md:flex-row md:items-center justify-between gap-6">
              <div class="flex-1">
                <h3 class="text-xl font-bold mb-2">RupeeOnTime Portal and Search Module</h3>
                <p class="text-slate-600 dark:text-slate-300 text-sm leading-relaxed">
                  Main application processing, document view, and status checks. Customer search via PAN, Mobile, or
                  Email.
                </p>
              </div>
              <a href="https://rotfintech.com/" target="_blank"
                class="bg-blue-600 text-white font-bold py-3 px-6 rounded-xl hover:bg-blue-700 transition">Visit Portal
                ‚Üó</a>
            </div>
          </div>

          <div
            class="group bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 p-6 rounded-3xl transition-all hover:shadow-lg">
            <div class="flex flex-col md:flex-row md:items-center justify-between gap-6">
              <div class="flex-1">
                <h3 class="text-xl font-bold mb-2">WOCOM 365</h3>
                <p class="text-slate-600 dark:text-slate-300 text-sm leading-relaxed">
                  Telephony integration, lead management, and communication logging.
                </p>
              </div>
              <a href="https://cpaas.wocom365.com/" target="_blank"
                class="bg-emerald-600 text-white font-bold py-3 px-6 rounded-xl hover:bg-emerald-700 transition">Open
                WOCOM ‚Üó</a>
            </div>
          </div>

          <div
            class="group bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 p-6 rounded-3xl transition-all hover:shadow-lg">
            <div class="flex flex-col md:flex-row md:items-center justify-between gap-6">
              <div class="flex-1">
                <h3 class="text-xl font-bold mb-2">Yellow Ai</h3>
                <p class="text-slate-600 dark:text-slate-300 text-sm leading-relaxed">
                  Handle real-time customer chats efficiently through the AI-powered cloud platform.
                </p>
              </div>
              <a href="https://cloud.yellow.ai/auth/login" target="_blank"
                class="bg-indigo-600 text-white font-bold py-3 px-6 rounded-xl hover:bg-indigo-700 transition">Login
                Chat ‚Üó</a>
            </div>
          </div>

          <div
            class="group bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 p-6 rounded-3xl transition-all hover:shadow-lg">
            <div class="flex flex-col md:flex-row md:items-center justify-between gap-6">
              <div class="flex-1">
                <h3 class="text-xl font-bold mb-2">Outlook (Care@rupeeontime.com)</h3>
                <p class="text-slate-600 dark:text-slate-300 text-sm leading-relaxed">
                  Review customer emails and attachments. Standard channel for ticketing and complex queries.
                </p>
              </div>
              <a href="https://outlook.office.com/mail/" target="_blank"
                class="bg-amber-500 text-white font-bold py-3 px-6 rounded-xl hover:bg-amber-600 transition">Open Mail
                ‚Üó</a>
            </div>
          </div>

          <div
            class="group bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 p-6 rounded-3xl transition-all hover:shadow-lg">
            <div class="flex flex-col md:flex-row md:items-center justify-between gap-6">
              <div class="flex-1">
                <h3 class="text-xl font-bold mb-2">Refund Sheet</h3>
                <p class="text-slate-600 dark:text-slate-300 text-sm leading-relaxed">
                  Refund Tracker for processing and status updates.
                </p>
              </div>
              <a href="https://bharatloan1-my.sharepoint.com/:x:/g/personal/karamjit_singh_bharatloan_com/IQCJrpeD0n1mRZIu_vPq7HqGAQKM_Bvbax8CFaRwSYLBes4?e=Tb7xev"
                target="_blank"
                class="bg-green-600 text-white font-bold py-3 px-6 rounded-xl hover:bg-green-700 transition">Open Sheet
                ‚Üó</a>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- PERFORMANCE VIEW (AGENT DASHBOARD) -->
  <div id="view-performance" class="app-view bg-white dark:bg-slate-900">
    <header class="h-16 flex items-center px-6 border-b bg-white dark:bg-slate-800 justify-between">
      <div class="flex items-center gap-4">
        <button onclick="navigateTo('view-checklist')" class="font-bold text-slate-500 hover:text-blue-600">‚Üê
          Back</button>
        <span id="agent-dashboard-title" class="font-bold text-xl">Agent Dashboard</span>
      </div>
      <div class="flex items-center gap-4">
      </div>
    </header>

    <div class="max-w-6xl mx-auto px-6 py-10">

      <!-- Welcome Banner -->
      <div class="mb-12 p-8 rounded-3xl bg-gradient-to-r from-indigo-600 to-purple-600 text-white shadow-xl">
        <h1 class="text-3xl font-extrabold mb-2">Hello, <span id="agent-name-display">Agent</span> üëã</h1>
        <p class="opacity-90">Keep up the great work! Check your latest performance reviews below.</p>
      </div>

      <!-- Dashboard Grid -->
      <div class="grid grid-cols-1 max-w-2xl mx-auto gap-8">

        <!-- Weekly Performance Tab/Card -->
        <div onclick="openAgentPerformanceModal()"
          class="cursor-pointer group bg-white dark:bg-slate-800 p-8 rounded-3xl border border-slate-200 dark:border-slate-700 hover:shadow-2xl hover:-translate-y-2 transition-all duration-300 relative overflow-hidden">
          <div class="absolute top-0 right-0 p-4 opacity-5 group-hover:opacity-10 transition">
            <span class="text-9xl">üìà</span>
          </div>

          <div
            class="w-16 h-16 rounded-2xl bg-indigo-50 dark:bg-slate-700 flex items-center justify-center text-3xl mb-6 text-indigo-600">
            üéØ
          </div>

          <h3 class="text-2xl font-bold mb-2">Weekly Performance</h3>
          <p class="text-slate-500 text-sm mb-6">Review your audit scores, compliance stats, and proofs.</p>

          <div class="flex items-center gap-2 text-indigo-600 font-bold group-hover:gap-4 transition-all">
            <span>View Details</span>
            <span>‚Üí</span>
          </div>
        </div>


      </div>
    </div>
  </div>

  <!-- AGENT PERFORMANCE MODAL -->
  <div id="agent-performance-modal"
    class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4">
    <div
      class="bg-white dark:bg-slate-900 w-full max-w-5xl h-[90vh] rounded-[2rem] shadow-2xl overflow-hidden flex flex-col animate-scale-up">

      <!-- Modal Header -->
      <div
        class="p-6 border-b border-slate-100 dark:border-slate-800 flex items-center justify-between bg-white dark:bg-slate-900 z-10">
        <div>
          <h2 class="text-2xl font-extrabold flex items-center gap-2">
            <span>üìä</span> Weekly Performance Review
          </h2>
          <p class="text-xs text-slate-500 font-mono mt-1" id="modal-agent-id">ID: --</p>
        </div>
        <button onclick="closeAgentPerformanceModal()"
          class="w-10 h-10 rounded-full bg-slate-100 dark:bg-slate-800 flex items-center justify-center text-slate-500 hover:bg-red-50 hover:text-red-500 transition font-bold text-xl">&times;</button>
      </div>

      <!-- Modal Content (Scrollable) -->
      <div class="flex-1 overflow-y-auto p-8">

        <div id="perf-content-loaded" class="space-y-10">

          <!-- Performance Stats Cards -->
          <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div
              class="p-6 bg-blue-50 dark:bg-slate-800 rounded-2xl border border-blue-100 dark:border-slate-700 text-center">
              <p class="text-xs font-bold uppercase text-slate-400 mb-2">No. of Audits</p>
              <div id="modal-audit-count" class="text-4xl font-black text-blue-600">--</div>
            </div>
            <div
              class="p-6 bg-red-50 dark:bg-slate-800 rounded-2xl border border-red-100 dark:border-slate-700 text-center">
              <p class="text-xs font-bold uppercase text-slate-400 mb-2">Fatal Errors (Score 0)</p>
              <div id="modal-fatal-count" class="text-4xl font-black text-red-600">--</div>
            </div>
            <div
              class="p-6 bg-emerald-50 dark:bg-slate-800 rounded-2xl border border-emerald-100 dark:border-slate-700 text-center">
              <p class="text-xs font-bold uppercase text-slate-400 mb-2">Good (Score 100)</p>
              <div id="modal-good-count" class="text-4xl font-black text-emerald-600">--</div>
            </div>
            <div
              class="p-6 bg-indigo-50 dark:bg-slate-800 rounded-2xl border border-indigo-100 dark:border-slate-700 text-center">
              <p class="text-xs font-bold uppercase text-slate-400 mb-2">Total Score</p>
              <div id="modal-total-score" class="text-4xl font-black text-indigo-600">--</div>
            </div>
          </div>

          <!-- Detailed Reviews List -->
          <div>
            <h3 class="text-xl font-bold mb-4 flex items-center gap-2">
              <span class="bg-indigo-100 dark:bg-slate-700 text-indigo-600 p-2 rounded-lg text-sm">üìã</span>
              Quality Reviews
            </h3>
            <div id="modal-reviews-list" class="space-y-4">
              <!-- Reviews will be populated here by JS -->
            </div>
          </div>



        </div>

        <!-- Empty State -->
        <div id="perf-content-empty"
          class="hidden h-full flex flex-col items-center justify-center text-center opacity-50 py-20">
          <div class="text-6xl mb-4">üì≠</div>
          <h3 class="text-xl font-bold">No performance review available yet.</h3>
        </div>

      </div>
    </div>
  </div>

  <!-- ADMIN DASHBOARD -->
  <div id="view-admin" class="app-view bg-white dark:bg-slate-900">
    <header class="h-16 flex items-center px-6 border-b bg-white dark:bg-slate-800 justify-between">
      <div class="flex items-center gap-4">
        <button onclick="navigateTo('view-checklist')" class="font-bold text-slate-500 hover:text-blue-600">‚Üê
          Back</button>
        <span class="font-bold text-xl text-indigo-600">Admin Dashboard - <span
            id="admin-entity-display">--</span></span>
      </div>
    </header>

    <div class="max-w-6xl mx-auto px-6 py-10">
      <!-- Welcome Banner -->
      <div class="mb-8 p-6 bg-gradient-to-r from-indigo-600 to-blue-600 text-white rounded-3xl">
        <h1 id="admin-welcome-text" class="text-3xl font-bold">Welcome Siddhant Chauhan</h1>
      </div>

      <!-- Section 1: Select Agent Only -->
      <div class="bg-blue-50 dark:bg-slate-800 p-8 rounded-3xl mb-12 border border-blue-200 dark:border-slate-700">
        <h2 class="text-2xl font-bold mb-6 flex items-center gap-3">
          <span class="bg-blue-600 text-white rounded-lg p-2 text-xl">üë•</span>
          Select Agent
        </h2>

        <!-- Agent Selection -->
        <!-- Agent Selection Dropdown -->
        <div class="mb-6">
          <label class="block text-sm font-semibold mb-2 text-slate-600 dark:text-slate-400">Choose an Agent to
            Review</label>
          <div class="flex items-center gap-3 mb-3 flex-wrap">
            <div class="flex items-center gap-2">
              <label class="text-sm font-semibold text-slate-600 dark:text-slate-400">Select Week:</label>
              <select id="admin-week-selector" onchange="changeAdminCurrentWeek(this.value)"
                class="bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 text-slate-900 dark:text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5 font-bold shadow-sm">
                <option value="1">Week 1</option>
                <option value="2">Week 2</option>
                <option value="3">Week 3</option>
                <option value="4">Week 4</option>
              </select>
            </div>
            <div class="text-sm text-slate-700 dark:text-slate-300">| Week <span id="admin-week-display"
                class="font-bold">1</span> - <span id="admin-week-progress" class="text-slate-500">(0/0 completed)</span></div>
            <button id="admin-week-final-submit-btn" onclick="adminFinalizeWeek()"
              class="ml-auto bg-blue-600 text-white px-4 py-2 rounded-md text-sm font-semibold opacity-50 cursor-not-allowed"
              disabled>Final Submit This Week</button>
            <button onclick="adminLoadMonthlyDashboard()"
              class="ml-2 bg-indigo-600 text-white px-4 py-2 rounded-md text-sm font-semibold hover:bg-indigo-700 transition shadow-lg shadow-indigo-500/30">Monthly
              Scorecard üìä</button>
            <button onclick="adminLoadWeeklyDashboard()"
              class="ml-2 bg-teal-600 text-white px-4 py-2 rounded-md text-sm font-semibold hover:bg-teal-700 transition shadow-lg shadow-teal-500/30">Weekly
              Scorecard üìä</button>
          </div>
          <!-- Hidden native select (kept for backwards compatibility) -->
          <select id="admin-agent-selector" onchange="adminSelectAgentFromDropdown(this)"
            class="w-full p-4 rounded-xl border-2 border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 font-bold text-lg focus:border-blue-500 outline-none transition cursor-pointer">
            <option value="">-- Click to Select Agent --</option>
          </select>
        </div>

        <button id="admin-start-review-btn" onclick="adminStartQualityReview()" disabled
          class="w-full bg-blue-600 text-white font-bold py-3 px-8 rounded-xl hover:bg-blue-700 transition opacity-50 cursor-not-allowed">
          Start Quality Review
        </button>

        <!-- Agent Process Modal (Voice / Non-Voice) -->
        <div id="agent-process-modal"
          class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div class="bg-white dark:bg-slate-800 p-8 rounded-3xl shadow-2xl max-w-md w-full mx-4">
            <div class="flex justify-between items-center mb-4">
              <h2 class="text-2xl font-bold">Start Quality Review</h2>
              <button onclick="document.getElementById('agent-process-modal').classList.add('hidden')"
                class="text-slate-500 hover:text-slate-700 text-2xl">&times;</button>
            </div>
            <p class="text-slate-600 dark:text-slate-400 mb-6">Choose the review type for <span id="modal-agent-name"
                class="font-bold"></span></p>

            <div class="space-y-4">
              <button onclick="startQualityReviewWithType('voice')"
                class="w-full bg-blue-600 text-white font-bold py-4 px-6 rounded-xl hover:bg-blue-700 transition flex items-center justify-center gap-3">
                <span class="text-2xl">üéôÔ∏è</span>
                <div>
                  <div class="font-bold">Voice</div>
                  <div class="text-sm opacity-90">Call recordings & interaction (requires file)</div>
                </div>
              </button>

              <button onclick="startQualityReviewWithType('non-voice')"
                class="w-full bg-green-600 text-white font-bold py-4 px-6 rounded-xl hover:bg-green-700 transition flex items-center justify-center gap-3">
                <span class="text-2xl">üí¨</span>
                <div>
                  <div class="font-bold">Non-Voice</div>
                  <div class="text-sm opacity-90">Chat / Email interactions (paste Chat/Email ID)</div>
                </div>
              </button>
            </div>

            <button onclick="document.getElementById('agent-process-modal').classList.add('hidden')"
              class="w-full mt-4 bg-slate-300 text-slate-700 font-bold py-2 px-4 rounded-lg hover:bg-slate-400 transition">Cancel</button>
          </div>
        </div>

      </div>



      <!-- Confirm Clear Finalizations Modal -->





      <!-- Section 2: Quality Review Form (Hidden initially) -->
      <div id="admin-quality-form-section"
        class="hidden bg-emerald-50 dark:bg-slate-800 p-8 rounded-3xl mb-12 border border-emerald-200 dark:border-slate-700">
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-2xl font-bold flex items-center gap-3">
            <span class="bg-emerald-600 text-white rounded-lg p-2 text-xl">üìù</span>
            Quality Review - <span id="admin-review-agent-display" class="text-emerald-600"></span>
          </h2>
          <button onclick="adminCancelReview()" class="text-slate-500 hover:text-slate-700 text-sm font-medium">‚Üê
            Back</button>
        </div>

        <!-- File Input Section (for Voice reviews) -->
        <div id="admin-review-file-section"
          class="hidden mb-6 p-4 bg-white dark:bg-slate-700 rounded-xl border border-emerald-200 dark:border-slate-600">
          <label class="block text-sm font-semibold mb-3">Select Call Recording or File (Max 100MB)</label>
          <input type="file" id="admin-review-file-input"
            class="block w-full text-sm file:mr-4 file:py-2 file:px-4 file:rounded file:border-0 file:text-sm file:font-semibold file:bg-blue-100 file:text-blue-700">
          <p class="text-xs text-slate-500 mt-2">Selected: <span id="admin-review-file-name">None</span></p>
        </div>

        <div id="admin-review-items-container" class="space-y-6">
          <!-- Review items will be dynamically added here -->
        </div>

        <div class="flex gap-3 mt-8">
          <button onclick="adminAddReviewItem()" id="admin-add-review-btn"
            class="flex-1 bg-blue-600 text-white font-bold py-3 px-8 rounded-xl hover:bg-blue-700 transition">
            ‚ûï Add Review (Min 3, Max 10)
          </button>
          <button onclick="adminFinalSubmit()" id="admin-final-submit-btn" disabled
            class="flex-1 bg-green-600 text-white font-bold py-3 px-8 rounded-xl hover:bg-green-700 transition opacity-50 cursor-not-allowed">
            ‚úÖ Final Submit
          </button>
        </div>
      </div>

      <!-- Section: Data Management -->
      <div id="admin-data-management-section"
        class="mb-12 hidden bg-red-50 dark:bg-slate-800 p-8 rounded-3xl border border-red-200 dark:border-red-900/50">
        <h2 class="text-2xl font-bold mb-6 flex items-center gap-3 text-red-700 dark:text-red-400">
          <span class="bg-red-600 text-white rounded-lg p-2 text-xl">‚ö†Ô∏è</span>
          Data Management
        </h2>
        <p class="mb-6 text-slate-600 dark:text-slate-400">This section has been removed. Agents are auto-finalized when reviews are submitted, and can be unfirmed using Clear Finalizations.</p>
      </div>

      <!-- Section 3: Submitted Reviews -->
      <div id="admin-submitted-reviews-section" class="mb-12 hidden">
        <h2 class="text-2xl font-bold mb-6 flex items-center gap-3">
          <span class="bg-indigo-600 text-white rounded-lg p-2 text-xl">üìã</span>
          Submitted Reviews
        </h2>
        <div class="mb-4 flex gap-3">
          <button onclick="adminDeleteAllReviews()"
            class="bg-red-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-red-700 transition text-sm">
            üóëÔ∏è Delete All Reviews
          </button>
          <button onclick="adminClearFinalizations()" id="admin-clear-finalizations-btn"
            class="bg-yellow-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-yellow-600 transition text-sm">
            ‚úñÔ∏è Clear Finalizations
          </button>
        </div>
        <div class="overflow-x-auto rounded-3xl border border-slate-200 dark:border-slate-700">
          <table class="w-full bg-white dark:bg-slate-800 text-left border-collapse">
            <thead class="bg-slate-50 dark:bg-slate-700 text-slate-500 uppercase text-xs">
              <tr>
                <th class="p-6">Date</th>
                <th class="p-6">Agent</th>
                <th class="p-6">File</th>
                <th class="p-6">Score</th>
                <th class="p-6">Observation</th>
                <th class="p-6 text-right">Action</th>
              </tr>
            </thead>
            <tbody id="admin-reviews-list" class="divide-y divide-slate-100 dark:divide-slate-700">
              <!-- JS Populates this -->
            </tbody>
          </table>
        </div>
      </div>





    </div>
  </div>



  <!-- ADMIN WEEKLY DASHBOARD (NEW) -->
  <div id="view-admin-weekly" class="app-view bg-white dark:bg-slate-900">
    <header class="h-16 flex items-center justify-between px-6 border-b bg-white dark:bg-slate-800 sticky top-0 z-40">
      <div class="flex items-center">
        <button onclick="navigateTo('view-admin')" class="font-bold text-slate-500 hover:text-blue-600 mr-4">‚Üê
          Back</button>
        <h1 class="font-bold text-xl text-teal-600">Weekly Performance Scorecard</h1>
      </div>
      <div class="flex gap-2">
        <button onclick="downloadTableAsCSV('admin-weekly-table', 'Weekly_Performance_Report')"
          class="bg-teal-100 text-teal-700 hover:bg-teal-200 px-4 py-2 rounded-lg font-bold text-sm flex items-center gap-2 transition">
          <span>üì•</span> Download CSV
        </button>
      </div>
    </header>

    <div class="max-w-7xl mx-auto px-6 py-10">
      <div
        class="bg-teal-50 dark:bg-slate-800 p-8 rounded-3xl mb-8 border border-teal-100 dark:border-slate-700 flex justify-between items-center">
        <div>
          <h2 class="text-3xl font-bold mb-2">Weekly Team Overview</h2>
          <div class="flex items-center gap-2 mt-4 flex-wrap">
            <label class="text-slate-600 dark:text-slate-400 font-bold ml-1">Period:</label>

            <select id="admin-weekly-select-week" onchange="renderAdminWeeklyPerformance()"
              class="bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 text-slate-900 dark:text-white text-sm rounded-lg focus:ring-teal-500 focus:border-teal-500 block p-2.5 font-bold shadow-sm">
              <option value="1">Week 1</option>
              <option value="2">Week 2</option>
              <option value="3">Week 3</option>
              <option value="4">Week 4</option>
            </select>

            <span class="text-slate-400 mx-1">/</span>

            <select id="admin-weekly-select-month" onchange="renderAdminWeeklyPerformance()"
              class="bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 text-slate-900 dark:text-white text-sm rounded-lg focus:ring-teal-500 focus:border-teal-500 block p-2.5 font-bold shadow-sm">
              <!-- Months populated by JS -->
            </select>

            <select id="admin-weekly-select-year" onchange="renderAdminWeeklyPerformance()"
              class="bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 text-slate-900 dark:text-white text-sm rounded-lg focus:ring-teal-500 focus:border-teal-500 block p-2.5 font-bold shadow-sm">
              <!-- Years populated by JS -->
            </select>
          </div>
        </div>
        <div class="text-5xl opacity-80">üìä</div>
      </div>

      <div
        class="bg-white dark:bg-slate-800 rounded-3xl shadow-sm border border-slate-200 dark:border-slate-700 overflow-hidden">
        <div class="overflow-x-auto">
          <table id="admin-weekly-table" class="w-full text-left border-collapse">
            <thead class="bg-slate-50 dark:bg-slate-700 text-slate-500 uppercase text-xs">
              <tr>
                <th class="p-6 text-center">Rank</th>
                <th class="p-6">Agent Name</th>
                <th class="p-6 text-center">Audits</th>
                <th class="p-6 text-center">Fatals</th>
                <th class="p-6 text-center">100% Scores</th>
                <th class="p-6 text-center">Avg Score</th>
                <th class="p-6 text-center">Status</th>
              </tr>
            </thead>
            <tbody id="admin-weekly-list" class="divide-y divide-slate-100 dark:divide-slate-700 text-sm">
              <!-- Populated by JS -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- ADMIN MONTHLY DASHBOARD (NEW) -->
  <div id="view-admin-monthly" class="app-view bg-white dark:bg-slate-900">
    <header class="h-16 flex items-center justify-between px-6 border-b bg-white dark:bg-slate-800 sticky top-0 z-40">
      <div class="flex items-center">
        <button onclick="navigateTo('view-admin')" class="font-bold text-slate-500 hover:text-blue-600 mr-4">‚Üê
          Back</button>
        <h1 class="font-bold text-xl text-indigo-600">Monthly Performance Scorecard</h1>
      </div>
      <div class="flex gap-2">
        <button onclick="downloadTableAsCSV('admin-monthly-table', 'Monthly_Performance_Report')"
          class="bg-indigo-100 text-indigo-700 hover:bg-indigo-200 px-4 py-2 rounded-lg font-bold text-sm flex items-center gap-2 transition">
          <span>üì•</span> Download CSV
        </button>
      </div>
    </header>

    <div class="max-w-7xl mx-auto px-6 py-10">
      <div
        class="bg-indigo-50 dark:bg-slate-800 p-8 rounded-3xl mb-8 border border-indigo-100 dark:border-slate-700 flex justify-between items-center">
        <div>
          <h2 class="text-3xl font-bold mb-2">Team Performance Overview</h2>
          <div class="flex items-center gap-4">
            <p class="text-slate-600 dark:text-slate-400">Aggregated performance for: </p>
            <select id="admin-monthly-select-month" onchange="renderAdminMonthlyPerformance()"
              class="bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 text-slate-900 dark:text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5 font-bold">
              <!-- Months populated by JS -->
            </select>
            <select id="admin-monthly-select-year" onchange="renderAdminMonthlyPerformance()"
              class="bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 text-slate-900 dark:text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5 font-bold">
              <!-- Years populated by JS -->
            </select>
          </div>
        </div>
        <div class="text-right">
          <div class="text-sm font-bold text-slate-500 uppercase">Entity</div>
          <div class="text-2xl font-bold text-indigo-600" id="admin-monthly-entity-display">--</div>
        </div>
      </div>

      <div
        class="bg-white dark:bg-slate-800 rounded-3xl shadow-xl overflow-hidden border border-slate-200 dark:border-slate-700">
        <div class="overflow-x-auto">
          <table class="w-full text-left border-collapse">
            <thead class="bg-slate-50 dark:bg-slate-700 text-slate-500 uppercase text-xs font-bold">
              <tr>
                <th class="p-6 text-center w-16">#</th>
                <th class="p-6">Agent Name</th>
                <th class="p-6 text-center">Total Audits</th>
                <th class="p-6 text-center">Fatal Errors</th>
                <th class="p-6 text-center">Avg Score</th>
                <th class="p-6 text-center">Performance</th>
              </tr>
            </thead>
            <tbody id="admin-monthly-table-body" class="divide-y divide-slate-100 dark:divide-slate-700 text-sm">
              <!-- JS Populates this -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- AGENT QUALITY ASSURANCE CHECKLIST -->
  <div id="view-agent-qa" class="app-view bg-white dark:bg-slate-900">
    <header class="h-16 flex items-center px-6 border-b bg-white dark:bg-slate-800 justify-between">
      <div class="flex items-center gap-4">
        <button onclick="navigateTo('view-home')" class="font-bold text-slate-500 hover:text-blue-600">‚Üê
          Back</button>
        <span class="font-bold text-xl text-purple-600">Quality Assurance Checklist</span>
      </div>
      <div class="flex items-center gap-4">
      </div>
    </header>

    <div class="max-w-6xl mx-auto px-6 py-10">
      <!-- Welcome Banner -->
      <div class="mb-8 p-6 bg-gradient-to-r from-purple-600 to-indigo-600 text-white rounded-3xl">
        <h1 id="agent-qa-welcome-text" class="text-3xl font-bold">Welcome</h1>
        <p class="text-purple-100 mt-2">View your performance and quality scores</p>
      </div>

      <!-- Tab Navigation -->
      <div class="flex gap-4 mb-8 border-b border-slate-200 dark:border-slate-700">
        <button onclick="agentSwitchTab('weekly')" id="tab-weekly"
          class="px-6 py-3 font-bold text-purple-600 border-b-2 border-purple-600">üìä Weekly Performance</button>
        <button onclick="agentSwitchTab('monthly')" id="tab-monthly"
          class="px-6 py-3 font-bold text-slate-500 border-b-2 border-transparent hover:text-slate-700">üìà Monthly
          Performance</button>
      </div>

      <!-- Weekly Performance Section -->
      <div id="tab-content-weekly"
        class="bg-purple-50 dark:bg-slate-800 p-8 rounded-3xl mb-12 border border-purple-200 dark:border-slate-700">
        <h2 class="text-2xl font-bold mb-8 flex items-center gap-3">
          <span class="bg-purple-600 text-white rounded-lg p-2 text-xl">üìä</span>
          Weekly Performance
        </h2>

        <!-- Performance Stats -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
          <!-- Total Reviews -->
          <div class="bg-white dark:bg-slate-700 p-6 rounded-2xl border border-purple-200 dark:border-slate-600">
            <div class="text-3xl font-bold text-purple-600" id="agent-total-reviews">0</div>
            <p class="text-slate-600 dark:text-slate-400 text-sm mt-2">Total Reviews</p>
          </div>

          <!-- Average Score -->
          <div class="bg-white dark:bg-slate-700 p-6 rounded-2xl border border-purple-200 dark:border-slate-600">
            <div class="text-3xl font-bold text-indigo-600" id="agent-avg-score">0</div>
            <p class="text-slate-600 dark:text-slate-400 text-sm mt-2">Average Score</p>
          </div>

          <!-- Last Review -->
          <div class="bg-white dark:bg-slate-700 p-6 rounded-2xl border border-purple-200 dark:border-slate-600">
            <div class="text-lg font-bold text-blue-600" id="agent-last-review">--</div>
            <p class="text-slate-600 dark:text-slate-400 text-sm mt-2">Last Review Date</p>
          </div>

          <!-- Performance Status -->
          <div class="bg-white dark:bg-slate-700 p-6 rounded-2xl border border-purple-200 dark:border-slate-600">
            <div class="text-lg font-bold text-green-600" id="agent-performance-status">Excellent</div>
            <p class="text-slate-600 dark:text-slate-400 text-sm mt-2">Current Status</p>
          </div>
        </div>

        <!-- Reviews History Table -->
        <h3 class="text-xl font-bold mb-4 mt-8">Your Review History</h3>
        <div class="overflow-x-auto rounded-3xl border border-slate-200 dark:border-slate-700">
          <table class="w-full bg-white dark:bg-slate-800 text-left border-collapse">
            <thead class="bg-slate-50 dark:bg-slate-700 text-slate-500 uppercase text-xs">
              <tr>
                <th class="p-6">Date</th>
                <th class="p-6">Reviewer</th>
                <th class="p-6">Details</th>
                <th class="p-6">Score</th>
                <th class="p-6">Replies</th>
                <th class="p-6">Status</th>
              </tr>
            </thead>
            <tbody id="agent-reviews-history" class="divide-y divide-slate-100 dark:divide-slate-700">
              <!-- JS Populates this -->
            </tbody>
          </table>
        </div>

        <!-- No Reviews Message -->
        <div id="agent-no-reviews-message" class="text-center py-12 hidden">
          <div class="text-4xl mb-4">üì≠</div>
          <h4 class="text-xl font-bold text-slate-600 dark:text-slate-400">No Reviews Yet</h4>
          <p class="text-slate-500 dark:text-slate-500 mt-2">Your reviews will appear here once submitted by quality
            assurance team.</p>
        </div>
      </div>

      <!-- Monthly Performance Section -->
      <div id="tab-content-monthly"
        class="hidden bg-green-50 dark:bg-slate-800 p-8 rounded-3xl mb-12 border border-green-200 dark:border-slate-700">
        <h2 class="text-2xl font-bold mb-8 flex items-center gap-3">
          <span class="bg-green-600 text-white rounded-lg p-2 text-xl">üìà</span>
          Monthly Performance (Last 4 Weeks)
        </h2>

        <!-- Monthly Stats -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
          <div class="bg-white dark:bg-slate-700 p-6 rounded-2xl border border-green-200 dark:border-slate-600">
            <div class="text-3xl font-bold text-green-600" id="agent-monthly-total-audits">0</div>
            <p class="text-slate-600 dark:text-slate-400 text-sm mt-2">Total Audits</p>
          </div>

          <div class="bg-white dark:bg-slate-700 p-6 rounded-2xl border border-green-200 dark:border-slate-600">
            <div class="text-3xl font-bold text-indigo-600" id="agent-monthly-avg-score">0%</div>
            <p class="text-slate-600 dark:text-slate-400 text-sm mt-2">Overall Score</p>
          </div>

          <div class="bg-white dark:bg-slate-700 p-6 rounded-2xl border border-green-200 dark:border-slate-600">
            <div class="text-3xl font-bold text-red-600" id="agent-monthly-fatal-count">0</div>
            <p class="text-slate-600 dark:text-slate-400 text-sm mt-2">Total Fatal Issues</p>
          </div>

          <div class="bg-white dark:bg-slate-700 p-6 rounded-2xl border border-green-200 dark:border-slate-600">
            <div class="text-lg font-bold text-green-600" id="agent-monthly-status">Excellent</div>
            <p class="text-slate-600 dark:text-slate-400 text-sm mt-2">Monthly Status</p>
          </div>
        </div>

        <!-- Weekly Breakdown -->
        <div id="agent-monthly-weekly-breakdown" class="mb-8">
          <!-- Week 1 -->
          <div class="bg-white dark:bg-slate-700 p-6 rounded-2xl border border-slate-200 dark:border-slate-600 mb-4">
            <h4 class="font-bold text-lg mb-4">Week 1</h4>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
              <div>
                <p class="text-sm text-slate-600 dark:text-slate-400">Audits</p>
                <p class="text-2xl font-bold" id="agent-monthly-week1-audits">0</p>
              </div>
              <div>
                <p class="text-sm text-slate-600 dark:text-slate-400">Score</p>
                <p class="text-2xl font-bold" id="agent-monthly-week1-score">0%</p>
              </div>
              <div>
                <p class="text-sm text-slate-600 dark:text-slate-400">Fatals</p>
                <p class="text-2xl font-bold text-red-600" id="agent-monthly-week1-fatals">0</p>
              </div>
            </div>
          </div>

          <!-- Week 2 -->
          <div class="bg-white dark:bg-slate-700 p-6 rounded-2xl border border-slate-200 dark:border-slate-600 mb-4">
            <h4 class="font-bold text-lg mb-4">Week 2</h4>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
              <div>
                <p class="text-sm text-slate-600 dark:text-slate-400">Audits</p>
                <p class="text-2xl font-bold" id="agent-monthly-week2-audits">0</p>
              </div>
              <div>
                <p class="text-sm text-slate-600 dark:text-slate-400">Score</p>
                <p class="text-2xl font-bold" id="agent-monthly-week2-score">0%</p>
              </div>
              <div>
                <p class="text-sm text-slate-600 dark:text-slate-400">Fatals</p>
                <p class="text-2xl font-bold text-red-600" id="agent-monthly-week2-fatals">0</p>
              </div>
            </div>
          </div>

          <!-- Week 3 -->
          <div class="bg-white dark:bg-slate-700 p-6 rounded-2xl border border-slate-200 dark:border-slate-600 mb-4">
            <h4 class="font-bold text-lg mb-4">Week 3</h4>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
              <div>
                <p class="text-sm text-slate-600 dark:text-slate-400">Audits</p>
                <p class="text-2xl font-bold" id="agent-monthly-week3-audits">0</p>
              </div>
              <div>
                <p class="text-sm text-slate-600 dark:text-slate-400">Score</p>
                <p class="text-2xl font-bold" id="agent-monthly-week3-score">0%</p>
              </div>
              <div>
                <p class="text-sm text-slate-600 dark:text-slate-400">Fatals</p>
                <p class="text-2xl font-bold text-red-600" id="agent-monthly-week3-fatals">0</p>
              </div>
            </div>
          </div>

          <!-- Week 4 -->
          <div class="bg-white dark:bg-slate-700 p-6 rounded-2xl border border-slate-200 dark:border-slate-600 mb-4">
            <h4 class="font-bold text-lg mb-4">Week 4</h4>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
              <div>
                <p class="text-sm text-slate-600 dark:text-slate-400">Audits</p>
                <p class="text-2xl font-bold" id="agent-monthly-week4-audits">0</p>
              </div>
              <div>
                <p class="text-sm text-slate-600 dark:text-slate-400">Score</p>
                <p class="text-2xl font-bold" id="agent-monthly-week4-score">0%</p>
              </div>
              <div>
                <p class="text-sm text-slate-600 dark:text-slate-400">Fatals</p>
                <p class="text-2xl font-bold text-red-600" id="agent-monthly-week4-fatals">0</p>
              </div>
            </div>
          </div>
        </div>

        <div id="agent-no-monthly-data" class="text-center py-12">
          <div class="text-4xl mb-4">üìÖ</div>
          <h4 class="text-xl font-bold text-slate-600 dark:text-slate-400">Need More Data</h4>
          <p class="text-slate-500 dark:text-slate-500 mt-2">Monthly performance requires at least 4 weeks of audit
            data.</p>
        </div>
      </div>
    </div>
  </div>

  <!-- REVIEWER DASHBOARD -->
  <div id="view-reviewer" class="app-view bg-white dark:bg-slate-900">
    <header class="h-16 flex items-center px-6 border-b bg-white dark:bg-slate-800 justify-between">
      <div class="flex items-center gap-4">
        <button onclick="navigateTo('view-checklist')" class="font-bold text-slate-500 hover:text-blue-600">‚Üê
          Back</button>

        <span class="font-bold text-xl text-purple-600">Review Dashboard - <span
            id="reviewer-entity-display">--</span></span>
      </div>
    </header>

    <div class="max-w-6xl mx-auto px-6 py-10">
      <!-- Welcome Banner -->
      <div class="mb-8 p-6 bg-gradient-to-r from-purple-600 to-indigo-600 text-white rounded-3xl">
        <h1 id="reviewer-welcome-text" class="text-3xl font-bold">Welcome Ayushi Gupta</h1>
      </div>

      <!-- Section 1: Select Agent -->
      <div class="bg-purple-50 dark:bg-slate-800 p-8 rounded-3xl mb-12 border border-purple-200 dark:border-slate-700">
        <h2 class="text-2xl font-bold mb-6 flex items-center gap-3">
          <span class="bg-purple-600 text-white rounded-lg p-2 text-xl">üë•</span>
          Select Agent
        </h2>

        <!-- Agent Selection -->
        <div class="mb-6">
          <label class="block text-sm font-semibold mb-2 text-slate-600 dark:text-slate-400">Select Agent</label>
          <select id="reviewer-agent-selector" onchange="reviewerSelectAgent(this)"
            class="w-full p-4 rounded-xl border-2 border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 font-bold text-lg focus:border-purple-500 outline-none transition cursor-pointer">
            <option value="">-- Choose Agent --</option>
          </select>
        </div>
      </div>

      <!-- Section 2: Reviews List -->
      <div id="reviewer-reviews-section" class="mb-12 hidden">
        <h2 class="text-2xl font-bold mb-6 flex items-center gap-3">
          <span class="bg-purple-600 text-white rounded-lg p-2 text-xl">üìã</span>
          Agent Reviews
        </h2>
        <div class="overflow-x-auto rounded-3xl border border-slate-200 dark:border-slate-700">
          <table class="w-full bg-white dark:bg-slate-800 text-left border-collapse">
            <thead class="bg-slate-50 dark:bg-slate-700 text-slate-500 uppercase text-xs">
              <tr>
                <th class="p-6">Date</th>
                <th class="p-6">Agent</th>
                <th class="p-6">File</th>
                <th class="p-6">Score</th>
                <th class="p-6">Observation</th>
                <th class="p-6 text-right">Action</th>
              </tr>
            </thead>
            <tbody id="reviewer-reviews-list" class="divide-y divide-slate-100 dark:divide-slate-700">
              <!-- JS Populates this -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- LOGIN MODAL -->
  <div id="login-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white dark:bg-slate-800 p-8 rounded-3xl shadow-lg max-w-md w-full mx-4">
      <div class="flex justify-between items-center mb-6">
        <h2 id="login-title" class="text-2xl font-bold">Login</h2>
        <button onclick="hideLogin()" class="text-slate-500 hover:text-slate-700 text-2xl">&times;</button>
      </div>
      <form onsubmit="submitLogin(event)">
        <div class="mb-6">
          <label class="block text-sm font-medium mb-2">Employee ID</label>
          <input id="empid" type="text" required
            class="w-full px-4 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-slate-50 dark:bg-slate-700">
        </div>

        <button type="submit"
          class="w-full bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition">Login</button>
      </form>
    </div>
  </div>

  <!-- ACCESS DENIED MODAL -->
  <div id="access-denied-modal"
    class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white dark:bg-slate-800 p-8 rounded-3xl shadow-lg max-w-md w-full mx-4">
      <div class="flex justify-between items-center mb-6">
        <h2 id="access-denied-title" class="text-2xl font-bold text-red-600">Access Denied</h2>
        <button onclick="document.getElementById('access-denied-modal').classList.add('hidden')"
          class="text-slate-500 hover:text-slate-700 text-2xl">&times;</button>
      </div>
      <p class="text-slate-600 dark:text-slate-400 mb-6">You do not have permission to access this entity. Please use
        the correct Employee ID for the selected entity.</p>
      <button onclick="document.getElementById('access-denied-modal').classList.add('hidden')"
        class="w-full bg-red-600 text-white py-2 px-4 rounded-lg hover:bg-red-700 transition">Close</button>
    </div>
  </div>

  <!-- EDIT REVIEW MODAL -->
  <div id="admin-edit-review-modal"
    class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4">
    <div class="bg-white dark:bg-slate-800 p-8 rounded-3xl shadow-lg max-w-lg w-full">
      <h3 class="text-2xl font-bold mb-6">Edit Review</h3>

      <!-- Score -->
      <div class="mb-4">
        <label class="block text-sm font-medium mb-2">Score</label>
        <div class="flex gap-4">
          <label
            class="flex items-center gap-2 cursor-pointer bg-emerald-50 dark:bg-slate-700 p-3 rounded-xl border border-emerald-100 dark:border-slate-600">
            <input type="radio" name="edit-score" value="100" class="w-5 h-5 text-emerald-600">
            <span class="font-bold text-emerald-600">100 (Pass)</span>
          </label>
          <label
            class="flex items-center gap-2 cursor-pointer bg-red-50 dark:bg-slate-700 p-3 rounded-xl border border-red-100 dark:border-slate-600">
            <input type="radio" name="edit-score" value="0" class="w-5 h-5 text-red-600">
            <span class="font-bold text-red-600">0 (Fatal/Fail)</span>
          </label>
        </div>
      </div>

      <!-- Observation -->
      <div class="mb-4">
        <label class="block text-sm font-medium mb-2">Observation</label>
        <textarea id="edit-observation" rows="3"
          class="w-full px-4 py-2 rounded-lg border border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 focus:ring-2 focus:ring-blue-500 outline-none"></textarea>
      </div>

      <!-- File -->
      <div class="mb-6">
        <label class="block text-sm font-medium mb-2">Update File (Optional)</label>
        <p class="text-xs text-slate-500 mb-2">Current: <span id="edit-current-filename"
            class="font-mono font-bold"></span></p>
        <input type="file" id="edit-file-upload"
          class="w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
      </div>

      <div class="flex gap-3">
        <button onclick="adminSaveEdit()" id="btn-save-edit"
          class="flex-1 bg-blue-600 text-white font-bold py-3 rounded-xl hover:bg-blue-700 transition">Save
          Changes</button>
        <button onclick="document.getElementById('admin-edit-review-modal').classList.add('hidden')"
          class="px-6 py-3 rounded-xl border border-slate-300 hover:bg-slate-50 dark:border-slate-600 dark:hover:bg-slate-700 transition">Cancel</button>
      </div>
    </div>
  </div>

  <script>
    // ===== PORTAL LOGIN SYSTEM =====
    let currentSessionUser = null;

    // Initialize portal login on page load
    function initPortal() {
      const savedPasswords = JSON.parse(localStorage.getItem('gojira_passwords') || '{}');
      if (!Object.keys(savedPasswords).length) {
        // Initialize all users with default password "1234"
        const allUsers = {};
        USER_DB.forEach(user => {
          allUsers[user.id] = '1234'; // Default password
        });
        localStorage.setItem('gojira_passwords', JSON.stringify(allUsers));
      }

      // Check if already logged in
      const sessionUser = localStorage.getItem('gojira_session_user');
      if (sessionUser) {
        try {
          currentSessionUser = JSON.parse(sessionUser);
          console.info('[initPortal] Restored session for', currentSessionUser.id, currentSessionUser.role);
          // Restore role-specific UI and state
          if (currentSessionUser.role === 'admin') {
            currentUser = currentSessionUser;
            adminCurrentEntity = currentSessionUser.entity || 'ALL';
            const welcomeText = document.getElementById('admin-welcome-text');
            if (welcomeText) welcomeText.innerText = `Welcome ${currentSessionUser.name}`;
            adminLoadAgents();
          } else if (currentSessionUser.role === 'reviewer') {
            currentUser = currentSessionUser;
            reviewerCurrentEntity = currentSessionUser.entity || 'BharatLoan';
            adminCurrentEntity = reviewerCurrentEntity; // ensure agents load correctly
            const welcomeText = document.getElementById('reviewer-welcome-text');
            if (welcomeText) welcomeText.innerText = `Welcome ${currentSessionUser.name}`;
            const entityDisplay = document.getElementById('reviewer-entity-display');
            if (entityDisplay) entityDisplay.textContent = reviewerCurrentEntity;
            adminLoadAgents();
          } else if (currentSessionUser.role === 'agent') {
            // Restore agent session
            currentUser = currentSessionUser;
            currentEntity = currentSessionUser.entity || currentEntity;
            // Welcome text for agent QA
            const welcomeText = document.getElementById('agent-qa-welcome-text');
            if (welcomeText) welcomeText.innerText = `Welcome ${currentSessionUser.name}`;
            // Pre-load the agent QA dashboard so data is available on navigation
            try { agentLoadQADashboard(); } catch (e) { console.warn('[initPortal] agentLoadQADashboard failed', e); }
          } else {
            currentUser = currentSessionUser;
          }
          showPortalContent();
        } catch (err) {
          console.error('[initPortal] invalid session data', err);
        }
      }
    }


    // Portal Login Function
    function showPortalContent() {
      document.getElementById('portal-login-screen').classList.add('hidden');
      document.getElementById('top-nav').classList.remove('hidden');

      // Set user greeting on home page
      const firstName = currentSessionUser.name.split(' ')[0];
      document.getElementById('home-user-greeting').innerText = `Hi ${firstName}`;

      // Filter entities display based on user
      filterEntitiesDisplay();
      filterResourcesQACard(); // Set QA card visibility based on user role

      // Set currentUser and currentEntity for all users
      currentUser = currentSessionUser;
      currentEntity = currentSessionUser.entity;

      // Route all users to home page
      navigateTo('view-home');
    }

    // Portal Logout
    function portalLogout() {
      try {
        // Sign out of Firebase if in use
        if (firebaseAuth && firebaseAuth.signOut) {
          firebaseAuth.signOut().catch(e => console.warn('[portalLogout] firebase signOut failed', e));
        }
      } catch (e) { }

      // Clear session
      currentSessionUser = null;
      localStorage.removeItem('gojira_session_user');

      // Reset user greeting
      document.getElementById('home-user-greeting').innerText = 'Hi Guest';

      // Clear all forms
      document.getElementById('portal-emp-id').value = '';
      document.getElementById('portal-password').value = '';
      document.getElementById('change-pass-emp-id').value = '';
      document.getElementById('change-pass-current').value = '';
      document.getElementById('change-pass-new').value = '';

      // Show login screen
      document.getElementById('portal-login-screen').classList.remove('hidden');
      document.getElementById('top-nav').classList.add('hidden');

      // Reset theme to light on logout
      setTheme('light');

      // Hide all views
      document.querySelectorAll('.app-view').forEach(view => {
        view.classList.remove('active');
      });
    }

    // Change Password Modal Functions
    function showChangePasswordModal() {
      document.getElementById('change-password-modal').classList.remove('hidden');
    }

    function hideChangePasswordModal() {
      document.getElementById('change-password-modal').classList.add('hidden');
      document.getElementById('change-pass-emp-id').value = '';
      document.getElementById('change-pass-current').value = '';
      document.getElementById('change-pass-new').value = '';
    }

    // Submit Change Password
    function submitChangePassword(event) {
      event.preventDefault();

      const empId = document.getElementById('change-pass-emp-id').value.trim();
      const currentPassword = document.getElementById('change-pass-current').value;
      const newPassword = document.getElementById('change-pass-new').value;

      // Validate employee exists
      const user = USER_DB.find(u => u.id === empId);
      if (!user) {
        alert('‚ùå Employee ID not found');
        return;
      }

      // Validate current password
      const savedPasswords = JSON.parse(localStorage.getItem('gojira_passwords') || '{}');
      const storedPassword = savedPasswords[empId] || '1234';

      if (currentPassword !== storedPassword) {
        alert('‚ùå Current password is incorrect');
        return;
      }

      // Validate new password
      if (newPassword.trim().length < 4) {
        alert('‚ùå New password must be at least 4 characters');
        return;
      }

      // Update password
      savedPasswords[empId] = newPassword;
      localStorage.setItem('gojira_passwords', JSON.stringify(savedPasswords));

      alert('‚úÖ Password changed successfully! You can now login with your new password.');
      hideChangePasswordModal();
    }

    // MOCK BACKEND
    class MockBackend {
      static getReports() {
        return JSON.parse(localStorage.getItem('gojira_reports') || '[]');
      }

      static addReport(file, content) {
        const reports = this.getReports();
        reports.unshift({
          id: Date.now(),
          name: file.name,
          type: file.type || 'Unknown',
          date: new Date().toLocaleString(),
          uploader: 'Admin',
          content: content // Store Base64 string
        });
        // Limit storage to prevent quota exceeded (keep last 5)
        if (reports.length > 5) reports.pop();
        localStorage.setItem('gojira_reports', JSON.stringify(reports));
      }

      static getComments() {
        return JSON.parse(localStorage.getItem('gojira_comments') || '[]');
      }

      static addComment(text, agentId, entity = null) {
        const comments = this.getComments();
        comments.unshift({
          id: Date.now(),
          text,
          agentId,
          entity, // optional, can be null
          date: new Date().toLocaleString()
        });
        localStorage.setItem('gojira_comments', JSON.stringify(comments));
      }

      static clearComments() {
        localStorage.setItem('gojira_comments', JSON.stringify([]));
      }

      static deleteComment(id) {
        const comments = this.getComments().filter(c => c.id != id);
        localStorage.setItem('gojira_comments', JSON.stringify(comments));
      }

      static deleteReport(id) {
        const reports = this.getReports().filter(r => r.id != id);
        localStorage.setItem('gojira_reports', JSON.stringify(reports));
      }

      static clearAllReports() {
        localStorage.setItem('gojira_reports', JSON.stringify([]));
      }

      // PERFORMANCE DATA
      static getPerformance(agentId) {
        const db = JSON.parse(localStorage.getItem('gojira_performance') || '{}');
        return db[agentId] || null;
      }

      static savePerformance(agentId, data) {
        const db = JSON.parse(localStorage.getItem('gojira_performance') || '{}');
        db[agentId] = {
          ...data,
          lastUpdated: new Date().toLocaleString()
        };
        localStorage.setItem('gojira_performance', JSON.stringify(db));
      }

      static savePerformanceScore(performanceData) {
        const scores = JSON.parse(localStorage.getItem('gojira_performance_scores') || '[]');
        scores.unshift({
          id: Date.now(),
          ...performanceData
        });
        // Keep only last 50 scores to prevent storage bloat
        if (scores.length > 50) scores.pop();
        localStorage.setItem('gojira_performance_scores', JSON.stringify(scores));

        // Update the agent's current performance score
        const currentPerf = this.getPerformance(performanceData.agentId) || {};
        this.savePerformance(performanceData.agentId, {
          score: performanceData.score,
          isFatal: performanceData.isFatal,
          lastReviewDate: new Date().toLocaleString(),
          reviewerId: performanceData.reviewerId
        });
      }

      static getPerformanceScores() {
        return JSON.parse(localStorage.getItem('gojira_performance_scores') || '[]');
      }

      static deletePerformanceScore(scoreId) {
        const scores = this.getPerformanceScores();
        const scoreToDelete = scores.find(s => s.id == scoreId);

        if (scoreToDelete) {
          // Remove the score
          const updatedScores = scores.filter(s => s.id != scoreId);
          localStorage.setItem('gojira_performance_scores', JSON.stringify(updatedScores));

          // Check if this was the agent's most recent score
          const agentScores = updatedScores.filter(s => s.agentId === scoreToDelete.agentId);
          if (agentScores.length === 0) {
            // No more scores for this agent, remove their performance record
            const performanceDb = JSON.parse(localStorage.getItem('gojira_performance') || '{}');
            delete performanceDb[scoreToDelete.agentId];
            localStorage.setItem('gojira_performance', JSON.stringify(performanceDb));
          } else {
            // Update with the most recent remaining score
            const latestScore = agentScores.reduce((latest, current) =>
              new Date(current.timestamp) > new Date(latest.timestamp) ? current : latest
            );
            this.savePerformance(scoreToDelete.agentId, {
              score: latestScore.score,
              isFatal: latestScore.isFatal,
              lastReviewDate: new Date(latestScore.timestamp).toLocaleString(),
              reviewerId: latestScore.reviewerId
            });
          }
        }
      }

      static clearAllPerformanceData() {
        // Clear all performance scores history
        localStorage.removeItem('gojira_performance_scores');
        // Clear all current performance records
        localStorage.removeItem('gojira_performance');
      }
    }

    // ADMIN & AGENT FUNCTIONS
    function renderAdminDashboard() {
      // Request notifications permission for admin users (so they can get comment alerts)
      try { if (typeof ensureNotificationPermission === 'function') ensureNotificationPermission().then(() => { if (typeof registerFCMTokenForCurrentUser === 'function') registerFCMTokenForCurrentUser().catch(() => { }); }).catch(() => { }); } catch (e) { }

      // This function is called to refresh UI after operations
      // It should use adminLoadAgents() instead to maintain consistency
      if (typeof adminLoadAgents === 'function') adminLoadAgents();

      // Populate Performance Reviews Table
      const reviews = (typeof MockBackend !== 'undefined' && MockBackend.getPerformanceScores) ? MockBackend.getPerformanceScores() : [];
      const reviewsList = document.getElementById('admin-reviews-list');
      if (reviewsList) {
        if (reviews.length === 0) {
          reviewsList.innerHTML = '<tr><td colspan="6" class="p-6 text-center text-slate-400">No performance reviews yet.</td></tr>';
        } else {
          reviewsList.innerHTML = reviews.map(r => {
            const agent = USER_DB.find(u => u.id === r.agentId);
            const agentName = agent ? agent.name : r.agentId;
            const scoreClass = r.score === 100 ? 'text-emerald-600' : 'text-red-600';
            const scoreText = r.score === 0 ? '0 (Fatal)' : r.score;
            const date = new Date(r.timestamp).toLocaleString();

            return `
                <tr class="hover:bg-slate-50 dark:hover:bg-slate-700/50">
                  <td class="p-6">${date}</td>
                  <td class="p-6">${agentName}</td>
                  <td class="p-6"><span class="${scoreClass} font-bold">${scoreText}</span></td>
                  <td class="p-6">--</td>
                  <td class="p-6">${r.feedbackData.fileName}</td>
                  <td class="p-6 text-right">
                    <button onclick="viewReviewDetails(${r.id})" class="text-blue-600 hover:text-blue-800 mr-2">View</button>
                    <button onclick="handleDeleteReview(${r.id})" class="text-red-600 hover:text-red-800">Delete</button>
                  </td>
                </tr>
              `;
          }).join('');
        }
      }

      // Populate Comments Table (Updated to use reviewComments)
      adminLoadCommentsDisplay();
    }

    function adminLoadCommentsDisplay() {
      const commentsList = document.getElementById('admin-comments-list');
      const countSpan = document.getElementById('admin-comments-count');
      if (!commentsList) return;

      const comments = JSON.parse(localStorage.getItem('reviewComments') || '[]');
      const reviews = JSON.parse(localStorage.getItem('adminReviews') || '[]');

      if (countSpan) countSpan.textContent = comments.length;

      if (comments.length === 0) {
        commentsList.innerHTML = '<p class="text-sm text-slate-500 italic text-center py-8">No comments found.</p>';
      } else {
        commentsList.innerHTML = comments.map(c => {
          // Find related review context
          const review = reviews.find(r => r.id === c.reviewId);
          const reviewDate = review ? review.date : 'Unknown Date';

          return `
              <div class="bg-white dark:bg-slate-700 p-4 rounded-xl border border-slate-200 dark:border-slate-600 shadow-sm flex justify-between items-start gap-4">
                <div class="flex-1">
                  <div class="flex items-center gap-2 mb-1">
                    <span class="font-bold text-slate-800 dark:text-slate-200">${c.authorName || 'Agent'}</span>
                    <span class="text-xs text-slate-400">‚Ä¢ ${c.date}</span>
                    <span class="text-xs text-indigo-500 bg-indigo-50 dark:bg-indigo-900/30 px-2 py-0.5 rounded-full">Review: ${reviewDate}</span>
                  </div>
                  <p class="text-slate-600 dark:text-slate-300 text-sm whitespace-pre-wrap">${c.text}</p>
                </div>
                <button onclick="adminDeleteComment('${c.id}')" class="text-red-500 hover:text-red-700 p-2 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg transition" title="Delete Comment">
                  üóëÔ∏è
                </button>
              </div>
            `;
        }).join('');
      }
    }

    function adminDeleteComment(commentId) {
      if (!confirm('Are you sure you want to delete this comment?')) return;

      let comments = JSON.parse(localStorage.getItem('reviewComments') || '[]');
      comments = comments.filter(c => c.id !== commentId);
      localStorage.setItem('reviewComments', JSON.stringify(comments));

      adminLoadCommentsDisplay();
    }

    function adminDeleteAllComments() {
      if (!confirm('Are you sure you want to DELETE ALL comments? This cannot be undone.')) return;

      localStorage.setItem('reviewComments', '[]');
      adminLoadCommentsDisplay();
    }

    // NEW WORKFLOW FUNCTIONS
    let selectedAgentForReview = null;
    let selectedFileForReview = null;
    let selectedProcessType = null;

    function onAgentSelected() {
      const agentSelector = document.getElementById('agent-selector');
      const selectedAgentId = agentSelector.value;

      if (selectedAgentId) {
        selectedAgentForReview = USER_DB.find(u => u.id === selectedAgentId);
        if (selectedAgentForReview) {
          // Show agent details section and populate it
          document.getElementById('admin-agent-list-section').classList.remove('hidden');
          document.getElementById('selected-agent-display-name').innerText = selectedAgentForReview.name;

          // Populate agent details
          const agentListContainer = document.getElementById('admin-agent-list');
          const perf = MockBackend.getPerformance(selectedAgentForReview.id);
          const pendingReviews = getPendingReviews(selectedAgentForReview.id);
          const scoreClass = perf ? (perf.score >= 90 ? 'text-emerald-500' : 'text-red-500') : 'text-slate-300';
          const scoreText = perf ? perf.score + '%' : 'Not Scored';

          const reviewStatus = pendingReviews.length === 0
            ? 'No reviews in progress'
            : pendingReviews.length >= 3
              ? 'Ready for final submission'
              : `${pendingReviews.length}/3 reviews completed`;

          const buttonText = pendingReviews.length >= 3
            ? 'Complete Final Submission'
            : pendingReviews.length === 0
              ? 'Start Quality Review'
              : `Continue Review (${pendingReviews.length}/3)`;

          // Check if this agent is finalized for the current week
          const state = getEntityWeekState(adminCurrentEntity || 'ALL');
          const currentWeek = state.currentWeek || 1;
          const finalized = state.completedAgents && state.completedAgents[currentWeek] && state.completedAgents[currentWeek][selectedAgentForReview.id];
          const finalizedBadge = finalized ? `<div class="text-sm text-emerald-600 font-semibold">Finalized Week ${currentWeek} ‚úÖ</div>` : '';

          const buttonAction = pendingReviews.length >= 3
            ? 'showFinalSubmissionOptionForSelectedAgent()'
            : 'startQualityReview()';

          agentListContainer.innerHTML = `
              <div class="bg-white dark:bg-slate-700 p-6 rounded-2xl border border-slate-200 dark:border-slate-600">
                <div class="flex items-center justify-between mb-4">
                    <div>
                      <h4 class="font-bold text-slate-700 dark:text-slate-200 text-xl">${selectedAgentForReview.name}</h4>
                      ${finalizedBadge}
                      <p class="text-sm text-slate-500 font-mono">${selectedAgentForReview.id}</p>
                      <p class="text-xs text-slate-400 mt-1">Entity: ${selectedAgentForReview.entity}</p>
                      <p class="text-xs text-blue-600 mt-1 font-medium">${reviewStatus}</p>
                    </div>
                    <div class="text-right">
                      <div class="font-black ${scoreClass} text-2xl">${scoreText}</div>
                      <div class="text-xs text-slate-400 uppercase">Current Score</div>
                    </div>
                </div>

                <!-- Replaced inline process selection with modal-driven process selector -->
                <div class="flex gap-3">
                    <button onclick="document.getElementById('agent-process-modal').classList.remove('hidden')" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-xl hover:bg-blue-700 transition" id="start-review-btn">
                      ${buttonText}
                    </button>
                    <button onclick="clearAgentSelection()" class="bg-slate-500 text-white font-medium py-2 px-4 rounded-xl hover:bg-slate-600 transition">
                      Clear Selection
                    </button>
                </div>
              </div>
            `;

          // Auto-open the admin review type modal when an agent is selected from the list
          try {
            const modalName = document.getElementById('review-type-agent-name');
            if (modalName) modalName.textContent = selectedAgentForReview.name;
            document.getElementById('admin-review-type-modal').classList.remove('hidden');
          } catch (e) {
            /* ignore if modal not present */
          }

          // Disable start button if this agent is finalized for the current week
          try {
            const stateBtn = getEntityWeekState(adminCurrentEntity || 'ALL');
            const cw = stateBtn.currentWeek || 1;
            const finalizedBtn = stateBtn.completedAgents && stateBtn.completedAgents[cw] && stateBtn.completedAgents[cw][selectedAgentForReview.id];
            const startBtnEl = document.getElementById('start-review-btn');
            if (startBtnEl) {
              if (finalizedBtn) {
                startBtnEl.disabled = true;
                startBtnEl.classList.add('opacity-50', 'cursor-not-allowed');
                startBtnEl.onclick = () => alert(`Agent finalized for Week ${cw}. Clear finalization to reopen.`);
              } else {
                startBtnEl.disabled = false;
                startBtnEl.classList.remove('opacity-50', 'cursor-not-allowed');
                startBtnEl.onclick = () => document.getElementById('agent-process-modal').classList.remove('hidden');
              }
            }
          } catch (e) { /* ignore */ }
        }
      } else {
        // Hide agent details section if no agent selected
        document.getElementById('admin-agent-list-section').classList.add('hidden');
        selectedAgentForReview = null;
        clearAgentSelection();
      }
    }

    function selectProcessType(processType) {
      selectedProcessType = processType;

      // Update button styles to show selection
      const voiceBtn = document.getElementById('voice-btn');
      const nonVoiceBtn = document.getElementById('non-voice-btn');
      const startBtn = document.getElementById('start-review-btn');

      if (processType === 'voice') {
        voiceBtn.classList.add('border-blue-500', 'bg-blue-50', 'dark:bg-blue-900/20');
        voiceBtn.classList.remove('border-slate-200', 'dark:border-slate-600');
        nonVoiceBtn.classList.remove('border-green-500', 'bg-green-50', 'dark:bg-green-900/20');
        nonVoiceBtn.classList.add('border-slate-200', 'dark:border-slate-600');
      } else {
        nonVoiceBtn.classList.add('border-green-500', 'bg-green-50', 'dark:bg-green-900/20');
        nonVoiceBtn.classList.remove('border-slate-200', 'dark:border-slate-600');
        voiceBtn.classList.remove('border-blue-500', 'bg-blue-50', 'dark:bg-blue-900/20');
        voiceBtn.classList.add('border-slate-200', 'dark:border-slate-600');
      }

      // Enable start review button
      startBtn.disabled = false;
      startBtn.classList.remove('opacity-50', 'cursor-not-allowed');
    }

    function startQualityReview() {
      if (selectedAgentForReview && selectedProcessType) {
        // Hide agent details, show file selection section
        document.getElementById('admin-agent-list-section').classList.add('hidden');
        document.getElementById('file-selection-section').classList.remove('hidden');

        // Set agent info in file selection section
        document.getElementById('selected-agent-name-file').innerText = selectedAgentForReview.name;
        document.getElementById('selected-agent-id-file').innerText = selectedAgentForReview.id;
        document.getElementById('selected-process-type').innerText = selectedProcessType === 'voice' ? 'Voice' : 'Non-Voice';
      }
    }

    function clearAgentSelection() {
      // Reset agent selector
      document.getElementById('agent-selector').value = '';
      // Hide all workflow sections
      document.getElementById('admin-agent-list-section').classList.add('hidden');
      document.getElementById('file-selection-section').classList.add('hidden');
      document.getElementById('feedback-form-section').classList.add('hidden');
      document.getElementById('scoring-section').classList.add('hidden');
      // Clear selections
      selectedAgentForReview = null;
      selectedFileForReview = null;
      selectedProcessType = null;
      localStorage.removeItem('currentQualityFeedback');
    }

    function proceedToFeedback() {
      const fileInput = document.getElementById('quality-feedback-file');

      if (!fileInput.files[0]) {
        alert('Please select a file for quality review.');
        return;
      }

      selectedFileForReview = fileInput.files[0];

      // Hide file selection, show feedback form
      document.getElementById('file-selection-section').classList.add('hidden');
      document.getElementById('feedback-form-section').classList.remove('hidden');

      // Set agent and file info in feedback section
      document.getElementById('selected-agent-name-feedback').innerText = selectedAgentForReview.name;
      document.getElementById('selected-agent-id-feedback').innerText = selectedAgentForReview.id;
      document.getElementById('selected-process-feedback').innerText = selectedProcessType === 'voice' ? 'Voice' : 'Non-Voice';
      document.getElementById('selected-process-feedback-display').innerText = selectedProcessType === 'voice' ? 'Voice' : 'Non-Voice';
      document.getElementById('selected-file-name').innerText = selectedFileForReview.name;
    }

    function backToFileSelection() {
      // Hide feedback form, show file selection
      document.getElementById('feedback-form-section').classList.add('hidden');
      document.getElementById('file-selection-section').classList.remove('hidden');
    }

    function submitFeedbackAndProceed() {
      const feedback = document.getElementById('feedback-observations').value.trim();


      if (!feedback) {
        alert('Please provide feedback and observations.');
        return;
      }

      // Store feedback data temporarily
      const feedbackData = {
        agentId: selectedAgentForReview.id,
        file: selectedFileForReview,
        processType: selectedProcessType,
        // interactionType: removed
        feedback: feedback,
        timestamp: new Date().toISOString()
      };

      // Store in localStorage for now
      localStorage.setItem('currentQualityFeedback', JSON.stringify({
        ...feedbackData,
        fileName: selectedFileForReview.name
      }));

      // Hide feedback form, show additional feedback section
      document.getElementById('feedback-form-section').classList.add('hidden');
      document.getElementById('additional-feedback-section').classList.remove('hidden');

      // Set agent info in additional feedback section
      document.getElementById('selected-agent-name-additional').innerText = selectedAgentForReview.name;
      document.getElementById('selected-agent-id-additional').innerText = selectedAgentForReview.id;
      document.getElementById('process-type-additional').innerText = selectedProcessType === 'voice' ? 'Voice' : 'Non-Voice';
      document.getElementById('process-type-additional').innerText = selectedProcessType === 'voice' ? 'Voice' : 'Non-Voice';
      // Interaction Type removed
      document.getElementById('interaction-type-additional').parentElement.classList.add('hidden'); // Hide the interaction type line
      document.getElementById('primary-feedback-display').innerText = feedback;

      // Initialize with 3 default feedback items
      initializeAdditionalFeedback();
    }

    function initializeAdditionalFeedback() {
      // The HTML already has 3 default feedback items
      // Just update the count and ensure proper button states
      updateFeedbackCount();

      // Ensure the first 3 items have disabled remove buttons
      const container = document.getElementById('additional-feedback-container');
      const feedbackItems = container.querySelectorAll('.feedback-item');
      feedbackItems.forEach((item, index) => {
        const removeBtn = item.querySelector('button[onclick*="removeFeedbackItem"]');
        if (index < 3) {
          removeBtn.disabled = true;
          removeBtn.classList.add('opacity-50');
        } else {
          removeBtn.disabled = false;
          removeBtn.classList.remove('opacity-50');
        }
      });
    }

    function backToFeedbackForm() {
      // Hide additional feedback, show feedback form
      document.getElementById('additional-feedback-section').classList.add('hidden');
      document.getElementById('feedback-form-section').classList.remove('hidden');
    }

    function addFeedbackItem() {
      const container = document.getElementById('additional-feedback-container');
      const feedbackItems = container.querySelectorAll('.feedback-item');
      const count = feedbackItems.length;

      if (count >= 10) {
        alert('Maximum 10 feedback items allowed.');
        return;
      }

      const newItem = document.createElement('div');
      newItem.className = 'feedback-item mb-3 p-4 bg-white dark:bg-slate-700 rounded-xl border border-slate-200 dark:border-slate-600';
      newItem.innerHTML = `
          <div class="flex items-center justify-between mb-2">
            <label class="text-sm font-medium">Feedback Item ${count + 1}</label>
            <button onclick="removeFeedbackItem(this)" class="text-red-500 hover:text-red-700 text-sm">Remove</button>
          </div>
          <input type="text" placeholder="Enter additional feedback point..." class="w-full px-3 py-2 rounded-lg border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-700 focus:ring-2 focus:ring-purple-500 outline-none">
        `;

      container.appendChild(newItem);
      updateFeedbackCount();

      // Disable add button if at max
      if (count + 1 >= 10) {
        document.getElementById('add-feedback-btn').disabled = true;
        document.getElementById('add-feedback-btn').classList.add('opacity-50', 'cursor-not-allowed');
      }

      // Update remove button states for all items
      const allItems = container.querySelectorAll('.feedback-item');
      allItems.forEach((item, index) => {
        const removeBtn = item.querySelector('button[onclick*="removeFeedbackItem"]');
        if (index < 3) {
          removeBtn.disabled = true;
          removeBtn.classList.add('opacity-50');
        } else {
          removeBtn.disabled = false;
          removeBtn.classList.remove('opacity-50');
        }
      });
    }

    function removeFeedbackItem(button) {
      const container = document.getElementById('additional-feedback-container');
      const feedbackItems = container.querySelectorAll('.feedback-item');
      const count = feedbackItems.length;

      if (count <= 3) {
        alert('Minimum 3 feedback items required.');
        return;
      }

      button.closest('.feedback-item').remove();
      updateFeedbackCount();

      // Re-enable add button if below max
      document.getElementById('add-feedback-btn').disabled = false;
      document.getElementById('add-feedback-btn').classList.remove('opacity-50', 'cursor-not-allowed');

      // Renumber remaining items and update remove button states
      const remainingItems = container.querySelectorAll('.feedback-item');
      remainingItems.forEach((item, index) => {
        const label = item.querySelector('label');
        label.textContent = `Feedback Item ${index + 1}`;

        const removeBtn = item.querySelector('button[onclick*="removeFeedbackItem"]');
        if (index < 3) {
          removeBtn.disabled = true;
          removeBtn.classList.add('opacity-50');
        } else {
          removeBtn.disabled = false;
          removeBtn.classList.remove('opacity-50');
        }
      });
    }

    function updateFeedbackCount() {
      const container = document.getElementById('additional-feedback-container');
      const count = container.querySelectorAll('.feedback-item').length;
      document.getElementById('feedback-count').textContent = count;
    }

    function submitAdditionalFeedback() {
      const container = document.getElementById('additional-feedback-container');
      const feedbackInputs = container.querySelectorAll('.feedback-item input');
      const additionalFeedback = [];

      // Validate minimum 3 items
      if (feedbackInputs.length < 3) {
        alert('Minimum 3 feedback items required.');
        return;
      }

      // Collect feedback items
      feedbackInputs.forEach(input => {
        const value = input.value.trim();
        if (value) {
          additionalFeedback.push(value);
        }
      });

      // Validate that we have at least 3 non-empty items
      if (additionalFeedback.length < 3) {
        alert('Please fill in at least 3 feedback items.');
        return;
      }

      // Get existing feedback data and add additional feedback
      const existingData = JSON.parse(localStorage.getItem('currentQualityFeedback'));
      existingData.additionalFeedback = additionalFeedback;

      // Update localStorage
      localStorage.setItem('currentQualityFeedback', JSON.stringify(existingData));

      // Hide additional feedback, show scoring section
      document.getElementById('additional-feedback-section').classList.add('hidden');
      document.getElementById('scoring-section').classList.remove('hidden');

      // Set agent info in scoring section
      document.getElementById('selected-agent-name-scoring').innerText = selectedAgentForReview.name;
      document.getElementById('selected-agent-id-scoring').innerText = selectedAgentForReview.id;
      document.getElementById('process-type-display').innerText = existingData.processType === 'voice' ? 'Voice' : 'Non-Voice';
      document.getElementById('process-type-display').innerText = existingData.processType === 'voice' ? 'Voice' : 'Non-Voice';
      // document.getElementById('interaction-type-display').innerText = existingData.interactionType... removed;
      document.getElementById('interaction-type-display').parentElement.classList.add('hidden');
      document.getElementById('scoring-file-name').innerText = existingData.fileName;
      document.getElementById('feedback-display').innerText = existingData.feedback;

      // Update Submit Button State
      const pendingReviews = getPendingReviews(selectedAgentForReview.id);
      const currentCount = pendingReviews.length;
      const finalSubmitBtn = document.getElementById('final-submit-btn');
      const addReviewBtn = document.getElementById('add-review-btn');

      // We are working on the next review (currentCount + 1)
      const potentialTotal = currentCount + 1;

      if (potentialTotal >= 3) {
        finalSubmitBtn.disabled = false;
        finalSubmitBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        finalSubmitBtn.innerHTML = `Submit Final Reviews (${potentialTotal})`;
      } else {
        finalSubmitBtn.disabled = true;
        finalSubmitBtn.classList.add('opacity-50', 'cursor-not-allowed');
        finalSubmitBtn.innerHTML = `Submit Final Reviews (Need ${3 - potentialTotal} more)`;
      }

      // Check max limit for Add More
      if (potentialTotal >= 10) {
        addReviewBtn.disabled = true;
        addReviewBtn.classList.add('opacity-50', 'cursor-not-allowed');
        addReviewBtn.innerText = "Max Reviews Reached";
      } else {
        addReviewBtn.disabled = false;
        addReviewBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        addReviewBtn.innerText = "Add more quality review";
      }
    }

    function backToFeedback() {
      // Hide scoring, show feedback form
      document.getElementById('scoring-section').classList.add('hidden');
      document.getElementById('feedback-form-section').classList.remove('hidden');
    }

    function restoreAdditionalFeedback(feedbackItems) {
      const container = document.getElementById('additional-feedback-container');
      container.innerHTML = ''; // Clear existing

      feedbackItems.forEach((item, index) => {
        const newItem = document.createElement('div');
        newItem.className = 'feedback-item mb-3 p-4 bg-white dark:bg-slate-700 rounded-xl border border-slate-200 dark:border-slate-600';
        const isDisabled = index < 3;
        newItem.innerHTML = `
            <div class="flex items-center justify-between mb-2">
              <label class="text-sm font-medium">Feedback Item ${index + 1}</label>
              <button onclick="removeFeedbackItem(this)" class="text-red-500 hover:text-red-700 text-sm ${isDisabled ? 'opacity-50' : ''}" ${isDisabled ? 'disabled' : ''}>Remove</button>
            </div>
            <input type="text" value="${item}" placeholder="Enter additional feedback point..." class="w-full px-3 py-2 rounded-lg border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-700 focus:ring-2 focus:ring-purple-500 outline-none">
          `;

        container.appendChild(newItem);
      });

      updateFeedbackCount();

      // Update add button state
      const count = feedbackItems.length;
      const addBtn = document.getElementById('add-feedback-btn');
      if (count >= 10) {
        addBtn.disabled = true;
        addBtn.classList.add('opacity-50', 'cursor-not-allowed');
      } else {
        addBtn.disabled = false;
        addBtn.classList.remove('opacity-50', 'cursor-not-allowed');
      }
    }

    function submitPerformanceScore(isFinal = false) {
      const score = document.querySelector('input[name="performance-score"]:checked');

      if (!score) {
        alert('Please select a performance score.');
        return;
      }

      const feedbackData = JSON.parse(localStorage.getItem('currentQualityFeedback'));
      if (!feedbackData) {
        alert('No feedback data found. Please restart the process.');
        return;
      }

      // Save this review to pending reviews for the agent
      const reviewData = {
        agentId: selectedAgentForReview.id,
        score: parseInt(score.value),
        isFatal: score.value === '0',
        feedbackData: feedbackData,
        timestamp: new Date().toISOString(),
        reviewerId: currentUser.id,
        fileName: feedbackData.fileName
      };

      savePendingReview(reviewData);

      // Clear temporary data
      localStorage.removeItem('currentQualityFeedback');

      // Check agent review count
      const pendingReviews = getPendingReviews(selectedAgentForReview.id);

      if (isFinal) {
        if (pendingReviews.length < 3) {
          alert(`Minimum 3 reviews required. Currently: ${pendingReviews.length}`);
          return;
        }
        showFinalSubmissionOption(selectedAgentForReview.id);
      } else {
        // Add more review
        if (pendingReviews.length >= 10) {
          alert('Maximum 10 reviews reached. Please submit final.');
          // Maybe force final?
          showFinalSubmissionOption(selectedAgentForReview.id);
          return;
        }

        // Reset workflow for next review
        resetForNextReview();
        alert(`Review saved. Total pending: ${pendingReviews.length}. You can add more or submit final.`);
      }
    }

    function savePendingReview(reviewData) {
      const pendingReviews = JSON.parse(localStorage.getItem('pending_agent_reviews') || '{}');
      if (!pendingReviews[reviewData.agentId]) {
        pendingReviews[reviewData.agentId] = [];
      }
      pendingReviews[reviewData.agentId].push(reviewData);
      localStorage.setItem('pending_agent_reviews', JSON.stringify(pendingReviews));
    }

    function getPendingReviews(agentId) {
      const pendingReviews = JSON.parse(localStorage.getItem('pending_agent_reviews') || '{}');
      return pendingReviews[agentId] || [];
    }

    function showFinalSubmissionOption(agentId) {
      const pendingReviews = getPendingReviews(agentId);
      const agent = USER_DB.find(u => u.id === agentId);

      // Hide current workflow sections
      document.getElementById('scoring-section').classList.add('hidden');

      // Show final submission section
      const finalSection = document.getElementById('final-submission-section');
      if (!finalSection) {
        // Create the final submission section
        createFinalSubmissionSection();
      }

      document.getElementById('final-submission-section').classList.remove('hidden');

      // Populate final submission data
      document.getElementById('final-agent-name').innerText = agent.name;
      document.getElementById('final-agent-id').innerText = agent.id;

      // Calculate average score
      const totalScore = pendingReviews.reduce((sum, review) => sum + review.score, 0);
      const averageScore = Math.round(totalScore / pendingReviews.length);
      document.getElementById('final-average-score').innerText = averageScore;

      // Show review summary
      const reviewSummary = document.getElementById('final-review-summary');
      reviewSummary.innerHTML = '';
      pendingReviews.forEach((review, index) => {
        const reviewDiv = document.createElement('div');
        reviewDiv.className = 'p-3 bg-slate-50 dark:bg-slate-700 rounded-lg mb-2';
        reviewDiv.innerHTML = `
            <div class="flex justify-between items-center">
              <span class="font-medium">Review ${index + 1}</span>
              <span class="text-sm text-slate-500">${new Date(review.timestamp).toLocaleDateString()}</span>
            </div>
            <div class="text-sm text-slate-600 dark:text-slate-300 mt-1">
              Process: ${review.processType === 'voice' ? 'Voice' : 'Non-Voice'} | File: ${review.fileName} | Score: ${review.score}/100
            </div>
          `;
        reviewSummary.appendChild(reviewDiv);
      });
    }

    function createFinalSubmissionSection() {
      const section = document.createElement('div');
      section.id = 'final-submission-section';
      section.className = 'hidden bg-green-50 dark:bg-slate-800 p-8 rounded-3xl mb-12 border border-green-200 dark:border-slate-700';

      section.innerHTML = `
          <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl font-bold flex items-center gap-3">
              <span class="bg-green-600 text-white rounded-lg p-2 text-xl">‚úÖ</span>
              Final Performance Submission for <span id="final-agent-name" class="text-green-600"></span>
            </h2>
            <button onclick="cancelReviewProcess()" class="text-slate-500 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-200 text-sm font-medium">
              Cancel Process
            </button>
          </div>

          <div class="mb-6 p-4 bg-white dark:bg-slate-700 rounded-xl border border-slate-200 dark:border-slate-600">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm text-slate-600 dark:text-slate-300">
              <div><strong>Agent ID:</strong> <span id="final-agent-id" class="font-mono"></span></div>
              <div><strong>Average Score:</strong> <span id="final-average-score" class="font-bold text-green-600"></span>/100</div>
            </div>
          </div>

          <div class="mb-6">
            <h3 class="text-lg font-semibold mb-4">Review Summary (3 Reviews Completed)</h3>
            <div id="final-review-summary" class="space-y-2">
              <!-- Review summaries will be populated here -->
            </div>
          </div>

          <div class="mb-6 p-4 bg-yellow-50 dark:bg-slate-700 rounded-xl border border-yellow-200 dark:border-slate-600">
            <p class="text-sm text-yellow-800 dark:text-yellow-200">
              <strong>Note:</strong> This will calculate the final performance score based on the average of all 3 reviews and update the agent's performance record.
            </p>
          </div>

          <button onclick="submitFinalPerformanceScore()"
            class="bg-green-600 text-white font-bold py-3 px-8 rounded-xl hover:bg-green-700 transition shadow-lg shadow-green-500/30">
            Submit Final Performance Score
          </button>
        `;

      // Insert after the scoring section
      const scoringSection = document.getElementById('scoring-section');
      scoringSection.parentNode.insertBefore(section, scoringSection.nextSibling);
    }

    function submitFinalPerformanceScore() {
      const agentId = document.getElementById('final-agent-id').innerText;
      const pendingReviews = getPendingReviews(agentId);

      if (pendingReviews.length < 3) {
        alert('Minimum 3 reviews required before final submission.');
        return;
      }

      // Calculate final score (average of all reviews)
      const totalScore = pendingReviews.reduce((sum, review) => sum + review.score, 0);
      const finalScore = Math.round(totalScore / pendingReviews.length);

      // Check if any review was fatal (score = 0)
      const hasFatal = pendingReviews.some(review => review.isFatal);

      // Save the final performance score
      const performanceData = {
        agentId: agentId,
        score: finalScore,
        isFatal: hasFatal,
        feedbackData: { reviews: pendingReviews }, // Store all reviews
        timestamp: new Date().toISOString(),
        reviewerId: currentUser.id
      };

      MockBackend.savePerformanceScore(performanceData);

      // Mark this agent as completed for the current week
      markAgentWeekComplete(adminCurrentEntity || currentEntity || 'ALL', agentId);

      // Clear pending reviews for this agent
      const allPending = JSON.parse(localStorage.getItem('pending_agent_reviews') || '{}');
      delete allPending[agentId];
      localStorage.setItem('pending_agent_reviews', JSON.stringify(allPending));

      // Reset workflow
      document.getElementById('final-submission-section').classList.add('hidden');
      document.getElementById('admin-agent-list-section').classList.add('hidden');

      // Reset selections
      selectedAgentForReview = null;
      selectedFileForReview = null;
      document.getElementById('agent-selector').value = '';

      // Refresh dashboard
      renderAdminDashboard();
      adminLoadAgents();
      checkAndEnableWeekFinalButton();

      alert(`Final performance score (${finalScore}/100) submitted successfully for agent!`);
    }

    function showFinalSubmissionOptionForSelectedAgent() {
      if (selectedAgentForReview) {
        showFinalSubmissionOption(selectedAgentForReview.id);
      }
    }

    function cancelReviewProcess() {
      // Clear any temporary data
      localStorage.removeItem('currentQualityFeedback');

      // If there's a selected agent with pending reviews, ask if they want to clear them
      if (selectedAgentForReview) {
        const pendingReviews = getPendingReviews(selectedAgentForReview.id);
        if (pendingReviews.length > 0) {
          const clearPending = confirm(`This agent has ${pendingReviews.length} pending review(s). Do you want to clear all pending reviews for this agent?`);
          if (clearPending) {
            const allPending = JSON.parse(localStorage.getItem('pending_agent_reviews') || '{}');
            delete allPending[selectedAgentForReview.id];
            localStorage.setItem('pending_agent_reviews', JSON.stringify(allPending));
          }
        }
      }

      selectedAgentForReview = null;
      selectedFileForReview = null;

      // Reset to agent selection view (hide all workflow sections)
      document.getElementById('file-selection-section').classList.add('hidden');
      document.getElementById('feedback-form-section').classList.add('hidden');
      document.getElementById('additional-feedback-section').classList.add('hidden');
      document.getElementById('scoring-section').classList.add('hidden');
      document.getElementById('final-submission-section').classList.add('hidden');
      document.getElementById('admin-agent-list-section').classList.add('hidden');

      // Reset agent selector
      document.getElementById('agent-selector').value = '';

      // Refresh dashboard to update agent statuses
      renderAdminDashboard();
    }

    function resetForNextReview() {
      // Hide scoring section
      document.getElementById('scoring-section').classList.add('hidden');

      // Reset to file selection for next review
      document.getElementById('file-selection-section').classList.remove('hidden');

      // Clear file selection
      selectedFileForReview = null;
      const fileInput = document.getElementById('quality-feedback-file');
      if (fileInput) fileInput.value = '';

      document.getElementById('selected-file-name').innerText = 'No file selected';

      // Reset Feedback Form
      document.getElementById('feedback-observations').value = '';

      // Reset Additional Feedback Section to default 3 items
      const container = document.getElementById('additional-feedback-container');
      container.innerHTML = `
          <div class="feedback-item mb-3 p-4 bg-white dark:bg-slate-700 rounded-xl border border-slate-200 dark:border-slate-600">
            <div class="flex items-center justify-between mb-2">
              <label class="text-sm font-medium">Feedback Item 1</label>
              <button onclick="removeFeedbackItem(this)" class="text-red-500 hover:text-red-700 text-sm opacity-50" disabled>Remove</button>
            </div>
            <input type="text" placeholder="Enter additional feedback point..." class="w-full px-3 py-2 rounded-lg border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-700 focus:ring-2 focus:ring-purple-500 outline-none">
          </div>
          <div class="feedback-item mb-3 p-4 bg-white dark:bg-slate-700 rounded-xl border border-slate-200 dark:border-slate-600">
            <div class="flex items-center justify-between mb-2">
              <label class="text-sm font-medium">Feedback Item 2</label>
              <button onclick="removeFeedbackItem(this)" class="text-red-500 hover:text-red-700 text-sm opacity-50" disabled>Remove</button>
            </div>
            <input type="text" placeholder="Enter additional feedback point..." class="w-full px-3 py-2 rounded-lg border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-700 focus:ring-2 focus:ring-purple-500 outline-none">
          </div>
          <div class="feedback-item mb-3 p-4 bg-white dark:bg-slate-700 rounded-xl border border-slate-200 dark:border-slate-600">
            <div class="flex items-center justify-between mb-2">
              <label class="text-sm font-medium">Feedback Item 3</label>
              <button onclick="removeFeedbackItem(this)" class="text-red-500 hover:text-red-700 text-sm opacity-50" disabled>Remove</button>
            </div>
            <input type="text" placeholder="Enter additional feedback point..." class="w-full px-3 py-2 rounded-lg border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-700 focus:ring-2 focus:ring-purple-500 outline-none">
          </div>
        `;
      updateFeedbackCount();
      document.getElementById('add-feedback-btn').disabled = false;
      document.getElementById('add-feedback-btn').classList.remove('opacity-50', 'cursor-not-allowed');

      // Reset Performance Score Radios
      const scoreRadios = document.getElementsByName('performance-score');
      scoreRadios.forEach(radio => radio.checked = false);
    }

    function calculateTotalScore() {
      const audit = parseInt(document.getElementById('indiv-score').value) || 0;
      const errors = parseInt(document.getElementById('indiv-errors').value);
      const compliance = parseInt(document.getElementById('indiv-compliance').value) || 0;

      const display = document.getElementById('calc-total-score');

      // Logic: 
      // If Fatal Error (1) -> Score 0
      // Else -> Average of Audit & Compliance? Or just Audit?
      // User said "choose the score 0 and hundred... automatically fetch total"
      // Let's assume strict compliance.

      let total = 0;

      if (document.getElementById('indiv-errors').value === "") {
        display.innerText = "--";
        return;
      }

      if (errors === 1) {
        total = 0;
      } else {
        // If no fatal errors
        // Using simple average for now, standard QA math
        total = (audit + compliance) / 2;
      }

      display.innerText = total + "%";
      if (total === 100) display.className = "text-2xl font-black text-emerald-500";
      else if (total === 0) display.className = "text-2xl font-black text-red-500";
      else display.className = "text-2xl font-black text-indigo-600";
    }

    function handleFileUpload() {
      const fileInput = document.getElementById('admin-file-upload');
      if (fileInput.files.length > 0) {
        const file = fileInput.files[0];

        // Read file content
        const reader = new FileReader();
        reader.onload = function (e) {
          const content = e.target.result;
          try {
            MockBackend.addReport(file, content);
            alert(`Successfully uploaded "${file.name}"`);
            renderAdminDashboard(); // Refresh UI
          } catch (err) {
            alert('Upload failed: File might be too large for browser storage.');
            console.error(err);
          }
        };
        reader.readAsDataURL(file);

        fileInput.value = ''; // Reset
      } else {
        alert('Please select a file first.');
      }
    }

    function handleDeleteReport(id) {
      if (confirm('Are you sure you want to delete this report? It will be removed for all agents.')) {
        MockBackend.deleteReport(id);
        renderAdminDashboard(); // Refresh
      }
    }

    function handleDeleteComment(id) {
      if (confirm('Are you sure you want to delete this comment?')) {
        MockBackend.deleteComment(id);
        renderAdminDashboard(); // Refresh
      }
    }

    function viewReviewDetails(reviewId) {
      const reviews = MockBackend.getPerformanceScores();
      const review = reviews.find(r => r.id == reviewId);

      if (review) {
        const agent = USER_DB.find(u => u.id === review.agentId);
        const agentName = agent ? agent.name : review.agentId;
        const date = new Date(review.timestamp).toLocaleString();

        const details = `
  Review Details:
  - Date: ${date}
  - Agent: ${agentName} (${review.agentId})
  - Score: ${review.score === 0 ? '0 (Fatal Error)' : review.score}
  - Interaction Type: ${review.feedbackData.interactionType}
  - File: ${review.feedbackData.fileName}
  - Feedback: ${review.feedbackData.feedback}

  Reviewer: ${review.reviewerId}
          `;

        alert(details);
      }
    }

    function resetAllPerformanceData() {
      if (confirm('Are you sure you want to reset ALL performance data? This will clear all reviews and scores for all agents. This action cannot be undone.')) {
        MockBackend.clearAllPerformanceData();
        renderAdminDashboard();
        alert('All performance data has been reset. All agents now show as "Not Scored".');
      }
    }

    function clearSelectedAgent() {
      selectedAgentForUpload = null;
      document.getElementById('indiv-agent-search').value = '';
      document.getElementById('indiv-agent-results').classList.add('hidden');
      document.getElementById('indiv-agent-selected').classList.add('hidden');
      document.getElementById('indiv-agent-selected').classList.remove('flex');
      document.getElementById('indiv-upload-form').classList.add('hidden');
      document.getElementById('indiv-score').value = '';
      document.getElementById('indiv-errors').value = '';
      document.getElementById('indiv-compliance').value = '';
      document.getElementById('calc-total-score').innerText = '--';
      document.getElementById('proof-audio').value = '';
      document.getElementById('proof-chat').value = '';
      document.getElementById('proof-email').value = '';
    }

    function renderAgentDashboard() {
      if (currentUser) {
        document.getElementById('agent-name-display').innerText = currentUser.name;
      }
    }

    function openAgentPerformanceModal() {
      if (!currentUser) return;
      const modal = document.getElementById('agent-performance-modal');
      const contentLoaded = document.getElementById('perf-content-loaded');
      const contentEmpty = document.getElementById('perf-content-empty');

      document.getElementById('modal-agent-id').innerText = `ID: ${currentUser.id}`;
      modal.classList.remove('hidden');

      const perfData = MockBackend.getPerformance(currentUser.id);

      if (perfData) {
        contentLoaded.classList.remove('hidden');
        contentEmpty.classList.add('hidden');

        // Populate Scores based on localStorage reviews (Primary Source)
        let reviews = JSON.parse(localStorage.getItem('adminReviews') || '[]');
        reviews = reviews.filter(r => r.agentId === currentUser.id);

        let totalScore = 0;
        let fatalCount = 0;
        let goodCount = 0;
        let avgScore = 0;

        if (reviews.length > 0) {
          reviews.forEach(r => {
            // Handle score parsing properly
            let s = parseInt(r.score);
            if (isNaN(s)) s = 0;

            totalScore += s;
            if (s === 0) fatalCount++;
            if (s === 100) goodCount++;
          });
          avgScore = Math.round(totalScore / reviews.length);
        } else {
          // Fallback to MockBackend logic if no reviews found
          const audit = parseInt(perfData.score) || 0;
          avgScore = audit;
        }

        document.getElementById('modal-audit-score').innerText = perfData.score; // Keep original Monthly? Or switch to count? User request ambiguous. Let's keep perfData for compliance/stats if consistent.
        // Actually, let's use the box for "No. of Audits" as per the new label in HTML?
        // HTML Line 1163: <p class="text-xs font-bold uppercase text-slate-400 mb-2">No. of Audits</p>
        // HTML ID: modal-audit-count. Wait, the JS below uses 'modal-audit-score'.
        // Let's check the view_file of openAgentPerformanceModal again.
        // It used document.getElementById('modal-audit-score').innerText = perfData.score;
        // BUT the HTML in view-performance (Line 1164) has id="modal-audit-count".
        // The previous JS snippet I viewed had `modal-audit-score` ???
        // Let's assume the ID in HTML is `modal-audit-count` per my view of line 1164.

        const countSpan = document.getElementById('modal-audit-count');
        if (countSpan) countSpan.innerText = reviews.length;

        document.getElementById('modal-fatal-count').innerText = fatalCount;
        document.getElementById('modal-good-count').innerText = goodCount;
        document.getElementById('modal-total-score').innerText = avgScore + '%';

        // Populate Reviews List
        const reviewsList = document.getElementById('modal-reviews-list');
        if (reviews.length > 0) {
          reviewsList.innerHTML = reviews.map(r => {
            const dateObj = new Date(r.date);
            const displayDate = r.displayDate || (isNaN(dateObj.getTime()) ? r.date : dateObj.toLocaleDateString());
            const monthName = r.month || (isNaN(dateObj.getTime()) ? 'Unknown' : dateObj.toLocaleString('default', { month: 'long', year: 'numeric' }));

            return `
              <div class="bg-slate-50 dark:bg-slate-800 p-6 rounded-2xl border border-slate-200 dark:border-slate-700">
                <div class="flex justify-between items-start mb-4">
                  <div>
                    <h4 class="font-bold text-lg text-slate-800 dark:text-slate-100">${r.fileName || 'Performance Review'}</h4>
                    <div class="flex items-center gap-3 mt-1 text-sm text-slate-500 font-medium">
                      <span>üìÖ ${displayDate}</span>
                      <span class="px-2 py-0.5 bg-blue-100 text-blue-700 rounded text-xs uppercase font-bold">${monthName}</span>
                    </div>
                    ${r.id ? `<p class="text-xs text-blue-600 underline cursor-pointer mt-2" onclick="openReviewDetail('${r.id}')">View Details & File</p>` : ''}
                  </div>
                  <div class="text-right">
                    <span class="inline-block px-3 py-1 rounded-full text-sm font-bold ${r.score == 100 ? 'bg-emerald-100 text-emerald-600' : 'bg-red-100 text-red-600'}">
                      Score: ${r.score}
                    </span>
                  </div>
                </div>
                <div class="bg-white dark:bg-slate-900 p-4 rounded-xl border border-slate-100 dark:border-slate-800">
                  <p class="text-sm font-bold text-slate-500 mb-1">Observation:</p>
                  <p class="text-slate-700 dark:text-slate-300 italic">"${r.observation}"</p>
                </div>
              </div>
            `;
          }).join('');
        } else {
          reviewsList.innerHTML = '<p class="text-center text-slate-500 italic">No reviews found.</p>';
        }

        // MockBackend Proofs (Preserved)
        const proofsList = document.getElementById('modal-proofs-list');
        if (perfData.proofs && perfData.proofs.length > 0) {
          proofsList.innerHTML = perfData.proofs.map(p => `
                  <div class="flex items-center justify-between p-4 bg-white dark:bg-slate-700 rounded-xl border border-slate-200 dark:border-slate-600">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-slate-100 dark:bg-slate-600 flex items-center justify-center text-xl">${p.icon}</div>
                        <div>
                          <p class="font-bold text-sm text-slate-700 dark:text-slate-200">${p.name}</p>
                          <p class="text-[10px] text-slate-400 uppercase">${p.type.split('/')[1] || 'FILE'}</p>
                        </div>
                    </div>
                    <button onclick="openReport('${p.content}', '${p.type}')" class="bg-indigo-50 dark:bg-indigo-900/30 text-indigo-600 px-4 py-2 rounded-lg font-bold text-sm hover:bg-indigo-100 transition">View üëÅÔ∏è</button>
                  </div>
              `).join('');
        } else {
          proofsList.innerHTML = '<p class="col-span-2 text-center text-slate-400 italic">No proofs attached.</p>';
        }

        // Check notifications on load
        checkAgentNotifications(false);

      } else {
        contentLoaded.classList.add('hidden');
        contentEmpty.classList.remove('hidden');
      }
    }

    function checkNotifications(showPopup) {
      if (!currentUser) return;

      const dot = document.querySelector('.notification-dot');

      if (currentUser.role === 'agent') {
        checkAgentNotifications(showPopup);
      } else if (currentUser.role === 'admin' || currentUser.role === 'reviewer') {
        checkAdminNotifications(showPopup);
      }
    }

    function getAgentSeenNotifications(agentId) {
      return JSON.parse(localStorage.getItem(`agentNotifications_${agentId}`) || '[]');
    }

    function markAgentSeenNotifications(agentId, ids) {
      const seen = new Set(getAgentSeenNotifications(agentId));
      ids.forEach(id => seen.add(id));
      localStorage.setItem(`agentNotifications_${agentId}`, JSON.stringify(Array.from(seen)));
    }

    // --- CLEARED NOTIFICATIONS LOGIC ---
    function getClearedNotifications(userId) {
      // Shared logic for both agents and admins to get their cleared list
      return JSON.parse(localStorage.getItem(`clearedNotifications_${userId}`) || '[]');
    }

    function addToClearedNotifications(userId, ids) {
      const cleared = new Set(getClearedNotifications(userId));
      ids.forEach(id => cleared.add(id));
      localStorage.setItem(`clearedNotifications_${userId}`, JSON.stringify(Array.from(cleared)));
    }

    function clearNotification(id) {
      if (!currentUser) return;
      addToClearedNotifications(currentUser.id, [id]);
      // Refresh the list immediately
      checkNotifications(true);
    }

    function clearAllNotifications() {
      if (!currentUser) return;
      const list = document.querySelectorAll('#notifications-list > div');
      // We can grab IDs from the rendered DOM elements if we add data-id attributes, 
      // or easier: just clear based on the current context objects we have in memory.
      // But re-fetching is safer.

      let idsToClear = [];
      if (currentUser.role === 'agent') {
        // Re-fetch what the agent currently has "visible" (valid & uncleared)
        const reviews = JSON.parse(localStorage.getItem('adminReviews') || '[]');
        const clearedIds = getClearedNotifications(currentUser.id);
        const currentAgentId = String(currentUser.id).trim().toLowerCase();
        // Basic filter same as checkAgentNotifications
        const validReviews = reviews.filter(r => String(r.agentId).trim().toLowerCase() === currentAgentId && !clearedIds.includes(r.id));
        idsToClear = validReviews.map(r => r.id);
      } else {
        // Admin logic
        const comments = JSON.parse(localStorage.getItem('reviewComments') || '[]');
        const clearedIds = getClearedNotifications(currentUser.id);
        // Filter comments not cleared
        const validComments = comments.filter(c => !clearedIds.includes(c.id));
        idsToClear = validComments.map(c => c.id);
      }

      if (idsToClear.length > 0) {
        addToClearedNotifications(currentUser.id, idsToClear);
        checkNotifications(true);
        // alert('All notifications cleared!');
      }
    }

    function checkAgentNotifications(showPopup) {
      if (!currentUser || currentUser.role !== 'agent') return;

      let reviews = JSON.parse(localStorage.getItem('adminReviews') || '[]');
      const now = new Date();
      // Filter for this week (last 7 days) and current agent
      const oneWeekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);

      // Safe Trim Comparison
      const currentAgentId = String(currentUser.id).trim().toLowerCase();
      const agentReviews = reviews.filter(r => String(r.agentId).trim().toLowerCase() === currentAgentId);

      const recentReviews = agentReviews.filter(r => {
        // Try parsing ISO date first, then fallback
        let d = new Date(r.date);
        if (isNaN(d.getTime())) {
          // Fallback for older locale strings (MM/DD/YYYY or DD/MM/YYYY dependent on browser)
          // If we can't parse it, we might show it anyway if it's recent in the list?
          // But let's assume valid date.
          return false;
        }
        return d >= oneWeekAgo;
      });

      const seenIds = getAgentSeenNotifications(currentAgentId);
      const clearedIds = getClearedNotifications(currentUser.id);

      // LIST ITEMS: All recent reviews NOT CLEARED
      // (We ignore 'seen' status for the list - show them even if seen, unless cleared)
      const listItems = recentReviews.filter(r => !clearedIds.includes(r.id));

      // UNSEEN ITEMS: List items that are NOT SEEN
      const unseenItems = listItems.filter(r => !seenIds.includes(r.id));

      const dot = document.querySelector('.notification-dot');

      if (unseenItems.length > 0) {
        if (dot) dot.classList.remove('hidden');
      } else {
        if (dot) dot.classList.add('hidden');
      }

      if (showPopup) {
        // Show LIST ITEMS
        showAgentNotifications(listItems);
        // Mark displayed items as seen
        if (unseenItems.length > 0) {
          markAgentSeenNotifications(currentAgentId, unseenItems.map(r => r.id));
          if (dot) dot.classList.add('hidden'); // Dot goes away immediately on open
        }
      }
    }

    function showAgentNotifications(reviews) {
      const notificationsList = document.getElementById('notifications-list');
      const notificationsEmpty = document.getElementById('notifications-empty');

      if (reviews.length === 0) {
        notificationsList.classList.add('hidden');
        notificationsEmpty.classList.remove('hidden');
      } else {
        notificationsList.classList.remove('hidden');
        notificationsEmpty.classList.add('hidden');

        notificationsList.innerHTML = reviews.map(review => {
          const displayDate = review.displayDate || review.date;
          return `
            <div class="bg-blue-50 dark:bg-slate-700 p-4 rounded-xl border border-blue-100 dark:border-slate-600 cursor-pointer hover:shadow-lg transition relative group" onclick="agentViewNotificationReview('${review.id}')">
                
                <button onclick="event.stopPropagation(); clearNotification(${review.id})" 
                  class="absolute -top-2 -right-2 w-6 h-6 bg-slate-200 dark:bg-slate-600 text-slate-500 rounded-full flex items-center justify-center hover:bg-red-500 hover:text-white transition shadow-sm z-10" title="Clear">
                  √ó
                </button>

                <div class="flex items-start justify-between">
                  <div>
                    <h3 class="font-bold text-blue-900 dark:text-blue-200">New Performance Review</h3>
                    <p class="text-sm text-slate-600 dark:text-slate-400 mt-1">${review.date}</p>
                    <div class="mt-2 flex gap-2">
                      <span class="text-xs font-bold px-2 py-1 rounded bg-white dark:bg-slate-800 border border-blue-200 dark:border-slate-600 text-blue-700 dark:text-blue-300">
                        Score: ${review.score}%
                      </span>
                    </div>
                  </div>
                  <span class="bg-blue-600 text-white rounded-full w-8 h-8 flex items-center justify-center text-sm font-bold">‚Üí</span>
                </div>
              </div>
          `}).join('');
      }

      document.getElementById('notifications-modal').classList.remove('hidden');
      document.querySelector('.notification-dot').classList.add('hidden');
      // Mark reviews as seen for this agent when the modal is opened
      if (currentUser && currentUser.role === 'agent') {
        markAgentSeenNotifications(currentUser.id, reviews.map(r => r.id));
      }
    }

    function agentViewNotificationReview(reviewId) {
      const reviews = JSON.parse(localStorage.getItem('adminReviews') || '[]');
      const review = reviews.find(r => r.id === reviewId);
      if (review) {
        closeNotificationsModal();
        // Mark this review as seen for the agent
        if (currentUser && currentUser.role === 'agent') {
          markAgentSeenNotifications(currentUser.id, [reviewId]);
          const dot = document.querySelector('.notification-dot');
          if (dot) dot.classList.add('hidden');
        }

        // Navigate agent to QA dashboard and open the review detail
        navigateTo('view-agent-qa');
        // Ensure agent dashboard reloads
        setTimeout(() => {
          agentLoadQADashboard();
          setTimeout(() => {
            openReviewDetail(reviewId);
          }, 200);
        }, 200);
      }
    }

    function checkAdminNotifications(showPopup) {
      if (!currentUser || (currentUser.role !== 'admin' && currentUser.role !== 'reviewer')) return;

      const comments = JSON.parse(localStorage.getItem('reviewComments') || '[]');
      const adminNotifications = JSON.parse(localStorage.getItem('adminNotifications') || '[]'); // 'Seen' IDs
      const clearedIds = getClearedNotifications(currentUser.id);

      // LIST ITEMS: All comments NOT CLEARED
      const listItems = comments.filter(c => !clearedIds.includes(c.id));

      // UNSEEN ITEMS: List items NOT SEEN
      const unseenItems = listItems.filter(c => !adminNotifications.includes(c.id));

      const dot = document.querySelector('.notification-dot');

      if (unseenItems.length > 0) {
        if (dot) dot.classList.remove('hidden');
      } else {
        if (dot) dot.classList.add('hidden');
      }

      if (showPopup) {
        showAdminNotifications(listItems);

        if (unseenItems.length > 0) {
          // Add unseen IDs to 'seen' storage
          const newSeen = [...adminNotifications];
          unseenItems.forEach(c => { if (!newSeen.includes(c.id)) newSeen.push(c.id); });
          localStorage.setItem('adminNotifications', JSON.stringify(newSeen));

          if (dot) dot.classList.add('hidden');
        }
      }
    }

    function showAdminNotifications(comments) {
      const notificationsList = document.getElementById('notifications-list');
      const notificationsEmpty = document.getElementById('notifications-empty');
      const reviews = JSON.parse(localStorage.getItem('adminReviews') || '[]');

      if (comments.length === 0) {
        notificationsList.classList.add('hidden');
        notificationsEmpty.classList.remove('hidden');
      } else {
        notificationsList.classList.remove('hidden');
        notificationsEmpty.classList.add('hidden');

        notificationsList.innerHTML = comments.map(comment => {
          const review = reviews.find(r => r.id === comment.reviewId);
          return `
              <div class="bg-gradient-to-r from-orange-50 to-amber-50 dark:from-slate-700 dark:to-slate-600 p-4 rounded-xl border border-orange-200 dark:border-slate-600 cursor-pointer hover:shadow-lg transition relative group" onclick="adminViewNotificationComment('${comment.reviewId}')">
                
                <button onclick="event.stopPropagation(); clearNotification(${comment.id})" 
                  class="absolute -top-2 -right-2 w-6 h-6 bg-slate-200 dark:bg-slate-600 text-slate-500 rounded-full flex items-center justify-center hover:bg-red-500 hover:text-white transition shadow-sm z-10" title="Clear">
                  √ó
                </button>

                <div class="flex items-start justify-between">
                  <div class="flex-1">
                    <h3 class="font-bold text-orange-900 dark:text-orange-200">${comment.authorName} commented on review</h3>
                    <p class="text-sm text-slate-600 dark:text-slate-400 mt-1">Review Date: ${comment.date}</p>
                    <p class="text-sm mt-2 text-slate-700 dark:text-slate-300 line-clamp-2">"${comment.text.substring(0, 80)}..."</p>
                  </div>
                  <span class="bg-orange-600 text-white rounded-full w-8 h-8 flex items-center justify-center text-sm font-bold">‚Üí</span>
                </div>
              </div>
            `;
        }).join('');

        // Mark all as seen
        const allCommentIds = comments.map(c => c.id);
        localStorage.setItem('adminNotifications', JSON.stringify(allCommentIds));
      }

      document.getElementById('notifications-modal').classList.remove('hidden');
      document.querySelector('.notification-dot').classList.add('hidden');
    }

    function adminViewNotificationComment(reviewId) {
      const reviews = JSON.parse(localStorage.getItem('adminReviews') || '[]');
      const review = reviews.find(r => r.id === reviewId);
      if (review) {
        closeNotificationsModal();

        // Mark the related comments as read for admin
        const adminNotifications = JSON.parse(localStorage.getItem('adminNotifications') || '[]');
        const comments = JSON.parse(localStorage.getItem('reviewComments') || '[]');
        const relatedCommentIds = comments.filter(c => c.reviewId === reviewId).map(c => c.id);
        relatedCommentIds.forEach(id => { if (!adminNotifications.includes(id)) adminNotifications.push(id); });
        localStorage.setItem('adminNotifications', JSON.stringify(adminNotifications));

        // Navigate to admin dashboard and focus the agent and review
        adminCurrentEntity = review.entity || adminCurrentEntity || 'ALL';
        adminCurrentAgent = review.agentId;
        adminCurrentAgentName = review.agentName;

        navigateTo('view-admin');
        adminLoadAgents();

        // Give DOM a moment to render and then load reviews and open the specific review
        setTimeout(() => {
          // Set selector to agent
          const sel = document.getElementById('admin-agent-selector');
          if (sel) sel.value = adminCurrentAgent;
          adminLoadReviewsList();

          // Find index in filtered reviews
          const filtered = JSON.parse(localStorage.getItem('adminReviews') || '[]').filter(r => r.entity === adminCurrentEntity && r.agentId === adminCurrentAgent);
          const index = filtered.findIndex(r => r.id === reviewId);
          if (index !== -1) {
            setTimeout(() => {
              adminViewReview(index);
            }, 100);
          } else {
            alert('The review referenced by this notification is not available.');
          }
        }, 200);
      }
    }

    function showAdminComments(reviewId) {
      const comments = JSON.parse(localStorage.getItem('reviewComments') || '[]').filter(c => c.reviewId === reviewId);
      if (comments.length === 0) {
        alert('No replies yet for this review.');
        return;
      }

      let commentsText = `Comments for the selected review:\n\n`;
      comments.forEach(c => {
        commentsText += `[${c.date}] ${c.authorName}:\n${c.text}\n\n`;
      });

      alert(commentsText);
    }

    function showNotificationsModal(notifications) {
      const notificationsList = document.getElementById('notifications-list');
      const notificationsEmpty = document.getElementById('notifications-empty');

      if (notifications.length === 0) {
        notificationsList.classList.add('hidden');
        notificationsEmpty.classList.remove('hidden');
      }

      document.getElementById('notifications-modal').classList.remove('hidden');
    }

    function closeNotificationsModal() {
      document.getElementById('notifications-modal').classList.add('hidden');
    }

    function closeAgentPerformanceModal() {
      document.getElementById('agent-performance-modal').classList.add('hidden');
    }

    // BULK PERFORMANCE MANAGER
    function openReport(content, type) {
      const win = window.open();
      if (win) {
        if (type.startsWith('image/')) {
          win.document.write(`<div style="display:flex;justify-content:center;align-items:center;height:100vh;background:#f0f0f0;"><img src="${content}" style="max-width:100%;max-height:100%;box-shadow:0 0 20px rgba(0,0,0,0.1);"></div>`);
        } else if (type === 'application/pdf') {
          win.document.write(`<embed width="100%" height="100%" src="${content}" type="application/pdf">`);
        } else {
          // Fallback for other types
          win.document.write(`<h2 style="font-family:sans-serif;text-align:center;padding:20px;">Preview not available for this file type. Please download to view.</h2><div style="text-align:center;"><a href="${content}" download="file" style="padding:10px 20px;background:#3b82f6;color:white;text-decoration:none;border-radius:5px;">Download File</a></div>`);
        }
        win.document.title = "View Report";
        win.document.close(); // Important for loading
      } else {
        alert('Pop-up blocked! Please allow pop-ups for this site to view reports.');
      }
    }

    // Submit a comment from the QA checklist per-entity


    function logout() {
      currentUser = null;
      navigateTo('view-home');
    }

    // ===== AGENT QUALITY ASSURANCE FUNCTIONS =====
    // Helper: normalize IDs for robust matching
    function normalizeId(id) {
      return String(id || '').trim().toLowerCase().replace(/\s+/g, '');
    }

    // --------- FileDB (IndexedDB) - used to store review files larger than localStorage -------
    const FileDB = {
      _db: null,
      init() {
        return new Promise((resolve, reject) => {
          if (!window.indexedDB) return reject(new Error('IndexedDB not supported'));
          const req = indexedDB.open('gojira-files', 1);
          req.onupgradeneeded = (e) => {
            const db = e.target.result;
            if (!db.objectStoreNames.contains('files')) db.createObjectStore('files');
          };
          req.onsuccess = (e) => { FileDB._db = e.target.result; resolve(); };
          req.onerror = (e) => reject(e.target.error);
        });
      },
      saveFile(id, blob) {
        return new Promise((resolve, reject) => {
          try {
            const tx = FileDB._db.transaction('files', 'readwrite');
            const store = tx.objectStore('files');
            const r = store.put(blob, id);
            r.onsuccess = () => resolve();
            r.onerror = (e) => reject(e.target.error);
          } catch (err) { reject(err); }
        });
      },
      getFile(id) {
        return new Promise((resolve, reject) => {
          try {
            const tx = FileDB._db.transaction('files', 'readonly');
            const store = tx.objectStore('files');
            const r = store.get(id);
            r.onsuccess = (e) => resolve(e.target.result);
            r.onerror = (e) => reject(e.target.error);
          } catch (err) { reject(err); }
        });
      },
      deleteFile(id) {
        return new Promise((resolve, reject) => {
          try {
            const tx = FileDB._db.transaction('files', 'readwrite');
            const store = tx.objectStore('files');
            const r = store.delete(id);
            r.onsuccess = () => resolve();
            r.onerror = (e) => reject(e.target.error);
          } catch (err) { reject(err); }
        });
      }
    };

    // Helper to open a review file by its review id (handles legacy data URLs and IndexedDB blobs)
    async function openReviewFile(reviewId) {
      const reviews = JSON.parse(localStorage.getItem('adminReviews') || '[]');
      const review = reviews.find(r => r.id === reviewId);
      if (!review) return alert('File not found');

      // If legacy fileContent (data URL) exists, use it
      if (review.fileContent) {
        return openFileContent(review.fileContent, review.fileName);
      }

      // Remote file URL from Firebase Storage -- open directly
      if (review.fileUrl) {
        return openFileContent(review.fileUrl, review.fileName || 'file');
      }

      // Otherwise attempt to fetch from FileDB
      try {
        if (!FileDB._db) await FileDB.init();
        const blob = await FileDB.getFile(reviewId);
        if (!blob) return alert('File not found or not saved.');
        const url = URL.createObjectURL(blob);
        openFileContent(url, review.fileName || 'file');
        // Revoke the URL later to free memory
        setTimeout(() => URL.revokeObjectURL(url), 60 * 1000);
      } catch (err) {
        console.error('openReviewFile error', err);
        alert('Unable to open file: ' + (err.message || err));
      }
    }

    // --------- Optional Firebase integration (Firestore + Storage) ---------
    // Paste your Firebase config object into FIREBASE_CONFIG to enable real-time cross-device sync.
    // Example:
    // const FIREBASE_CONFIG = { apiKey: '...', authDomain: '...', projectId: '...', storageBucket: '...', messagingSenderId: '...', appId: '...' };
    const FIREBASE_CONFIG = {
      apiKey: "AIzaSyBaM-BpRPVhMTNaaX0RgcjLOWBiMe60kvU",
      authDomain: "gojira-9f84a.firebaseapp.com",
      projectId: "gojira-9f84a",
      storageBucket: "gojira-9f84a.firebasestorage.app",
      messagingSenderId: "1040488004573",
      appId: "1:1040488004573:web:b4854f7bf34205dda51434",
      measurementId: "G-PGSS0ELEXQ"
    };

    // Public VAPID key for Web Push (paste from Firebase Console -> Project settings -> Cloud Messaging)
    const FIREBASE_VAPID_KEY = 'BBK5BLTVv851mxs7kHr8c4fbUWO1KIyN3ivod__pZz0T1AzOnOorWo7W70Q-p2FawX1v5gdKKRI6tBOaw1l6chg';

    let firebaseApp = null;
    let firebaseFirestore = null;
    let firebaseStorage = null;
    let firebaseAuth = null;
    let isFirebaseReady = false;
    let _firebaseAgentUnsub = null;

    function _loadScript(url) {
      return new Promise((resolve, reject) => {
        const s = document.createElement('script');
        s.src = url;
        s.async = true;
        s.onload = () => resolve();
        s.onerror = (e) => reject(e);
        document.head.appendChild(s);
      });
    }

    async function initFirebase() {
      if (!FIREBASE_CONFIG) return Promise.resolve();
      if (isFirebaseReady) return Promise.resolve();
      // Load compat SDKs (non-module friendly)
      try {
        await _loadScript('https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js');
        await _loadScript('https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js');
        await _loadScript('https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js');
        await _loadScript('https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js');
        await _loadScript('https://www.gstatic.com/firebasejs/9.23.0/firebase-messaging-compat.js');

        firebase.initializeApp(FIREBASE_CONFIG);
        firebaseApp = firebase;
        firebaseFirestore = firebase.firestore();
        firebaseStorage = firebase.storage();
        firebaseAuth = firebase.auth();
        try { firebaseMessaging = firebase.messaging(); } catch (e) { console.warn('[Firebase] messaging init failed', e); firebaseMessaging = null; }
        isFirebaseReady = true;
        console.info('[Firebase] initialized');
        return Promise.resolve();
      } catch (err) {
        console.warn('[Firebase] init failed', err);
        return Promise.reject(err);
      }
    }

    async function pushReviewToFirebase(review) {
      if (!isFirebaseReady || !firebaseFirestore) return;
      try {
        const docRef = firebaseFirestore.collection('reviews').doc(String(review.id));
        let fileUrl = review.fileUrl || null;
        // If a local blob exists (stored in FileDB), upload it to Firebase Storage
        if (!fileUrl && review.fileStored) {
          try {
            if (!FileDB._db) await FileDB.init();
            const blob = await FileDB.getFile(review.id);
            if (blob) {
              const storagePath = `reviews/${review.id}/${encodeURIComponent(review.fileName || 'file')}`;
              const uploadTaskSnapshot = await firebaseStorage.ref(storagePath).put(blob);
              fileUrl = await uploadTaskSnapshot.ref.getDownloadURL();
            }
          } catch (err) {
            console.warn('[Firebase] upload failed for', review.id, err);
          }
        }

        // Prepare doc
        const doc = {
          id: review.id,
          agentId: review.agentId,
          agentName: review.agentName,
          entity: review.entity,
          reviewType: review.reviewType,
          score: review.score,
          observation: review.observation,
          reviewerId: review.reviewerId,
          reviewerName: review.reviewerName,
          fileUrl: fileUrl || null,
          fileName: review.fileName || null,
          date: review.date,
          expiryDate: review.expiryDate,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        };

        await docRef.set(doc, { merge: true });
        console.info('[Firebase] pushed review', review.id);
      } catch (err) {
        console.error('[Firebase] pushReviewToFirebase error', err);
      }
    }

    // ---------------- Firebase Auth helpers ----------------
    function handleFirebaseAuthUser(fbUser) {
      if (!fbUser) {
        // Signed out
        console.info('[Auth] signed out');
        // If we previously used firebase for session, clear it
        try { if (localStorage.getItem('gojira_session_user') && currentSessionUser && currentSessionUser.id === fbUser?.uid) { localStorage.removeItem('gojira_session_user'); } } catch (e) { }
        return;
      }

      (async function () {
        try {
          const idTokenResult = await fbUser.getIdTokenResult();
          const claims = idTokenResult?.claims || {};
          const role = claims.role || (fbUser.email && (fbUser.email.endsWith('@yourcompany.com') ? 'admin' : 'agent')) || 'agent';
          const mapped = USER_DB.find(u => u.email && u.email.toLowerCase() === (fbUser.email || '').toLowerCase());
          const userProfile = mapped ? { id: mapped.id, name: mapped.name, role: mapped.role, entity: mapped.entity } : { id: fbUser.uid, name: fbUser.displayName || fbUser.email, role, entity: 'ALL' };

          currentSessionUser = { id: userProfile.id, name: userProfile.name, role: userProfile.role, entity: userProfile.entity };
          localStorage.setItem('gojira_session_user', JSON.stringify(currentSessionUser));

          // Apply session and show portal
          currentUser = currentSessionUser;
          currentEntity = currentSessionUser.entity;
          if (currentUser.role === 'admin') {
            adminCurrentEntity = currentUser.entity || adminCurrentEntity || 'ALL';
            const welcomeText = document.getElementById('admin-welcome-text'); if (welcomeText) welcomeText.innerText = `Welcome ${currentUser.name}`;
          }

          showPortalContent();
          navigateTo('view-home');

          // Register FCM token for this user now that they are signed in
          try { if (typeof registerFCMTokenForCurrentUser === 'function') registerFCMTokenForCurrentUser().catch(() => { }); } catch (e) { }

          console.info('[Auth] mapped user to session', currentSessionUser);
        } catch (err) {
          console.warn('[Auth] handle user failed', err);
        }
      })();
    }

    // Legacy Authentication Functions Removed


    async function pushReviewsToFirebase(reviewIds) {
      if (!isFirebaseReady) {
        try { await initFirebase(); } catch (e) { console.warn('[pushReviewsToFirebase] initFirebase failed', e); return; }
      }
      for (const id of reviewIds) {
        const reviews = JSON.parse(localStorage.getItem('adminReviews') || '[]');
        const review = reviews.find(r => r.id === id);
        if (review) {
          pushReviewToFirebase(review).catch(e => console.warn('[pushReviewsToFirebase] failed', id, e));
        }
      }
    }

    function setupAgentFirebaseListener(agentId) {
      if (!isFirebaseReady || !firebaseFirestore) return;
      try {
        if (_firebaseAgentUnsub) _firebaseAgentUnsub();
        const q = firebaseFirestore.collection('reviews').where('agentId', '==', agentId);
        _firebaseAgentUnsub = q.onSnapshot(snapshot => {
          snapshot.docChanges().forEach(change => {
            const data = change.doc.data();
            const id = change.doc.id;
            if (change.type === 'added' || change.type === 'modified') {
              // Add to localStorage if missing
              let reviews = JSON.parse(localStorage.getItem('adminReviews') || '[]');
              const exists = reviews.some(r => r.id === id);
              if (!exists) {
                const newReview = Object.assign({}, data, { id: id });
                // Ensure expiryDate is string
                if (newReview.expiryDate && newReview.expiryDate.toDate) newReview.expiryDate = newReview.expiryDate.toDate().toISOString();
                reviews.push(newReview);
                localStorage.setItem('adminReviews', JSON.stringify(reviews));
                try { agentLoadQADashboard(); checkAgentNotifications(false); } catch (e) { console.warn('[Firebase] agent reload failed', e); }

                // Notify the agent in-app and via browser notification (if permitted)
                try {
                  const title = 'New Review from Admin';
                  const body = `${newReview.reviewType ? newReview.reviewType + ' - ' : ''}${newReview.score ? 'Score: ' + newReview.score + '. ' : ''}${(newReview.observation || '').substring(0, 140)}`;
                  showInAppNotification(title, body, () => openReviewFile(id));
                  if (isNotificationPermissionGranted) showBrowserNotification(title, body, null);
                  playNotificationBeep();
                } catch (e) { console.warn('[Firebase] notify failed', e); }
              }
            }
            if (change.type === 'removed') {
              // remove locally if present
              let reviews = JSON.parse(localStorage.getItem('adminReviews') || '[]');
              const updated = reviews.filter(r => r.id !== id);
              localStorage.setItem('adminReviews', JSON.stringify(updated));
              try { agentLoadQADashboard(); } catch (e) { }
            }
          });
        }, err => console.warn('[Firebase] listener error', err));
      } catch (err) {
        console.warn('[Firebase] setupAgentFirebaseListener failed', err);
      }
    }

    // ---------- Notification helpers: in-app toasts + browser notifications + sound ----------
    let isNotificationPermissionGranted = false;
    function playNotificationBeep() {
      try {
        const Ctx = window.AudioContext || window.webkitAudioContext;
        if (!Ctx) return;
        const ctx = new Ctx();
        const o = ctx.createOscillator();
        const g = ctx.createGain();
        o.type = 'sine';
        o.frequency.value = 880;
        o.connect(g);
        g.connect(ctx.destination);
        g.gain.value = 0.03;
        o.start();
        setTimeout(() => { try { o.stop(); ctx.close(); } catch (e) { } }, 130);
      } catch (e) {
        // ignore
      }
    }

    async function ensureNotificationPermission() {
      if (!('Notification' in window)) return false;
      if (Notification.permission === 'granted') { isNotificationPermissionGranted = true; return true; }
      if (Notification.permission === 'denied') return false;
      try {
        const perm = await Notification.requestPermission();
        isNotificationPermissionGranted = (perm === 'granted');
        return isNotificationPermissionGranted;
      } catch (e) { return false; }
    }

    function showBrowserNotification(title, body, onclickUrl) {
      try {
        if (!('Notification' in window) || Notification.permission !== 'granted') return;
        const n = new Notification(title, { body });
        n.onclick = function (ev) {
          window.focus();
          try { if (onclickUrl) window.location.href = onclickUrl; } catch (e) { }
          n.close();
        };
      } catch (e) { console.warn('showBrowserNotification failed', e); }
    }

    function showInAppNotification(title, body, onClick) {
      try {
        let container = document.getElementById('gojira-notifications');
        if (!container) {
          container = document.createElement('div');
          container.id = 'gojira-notifications';
          container.style.position = 'fixed';
          container.style.right = '16px';
          container.style.top = '16px';
          container.style.zIndex = 99999;
          document.body.appendChild(container);
        }

        const el = document.createElement('div');
        el.className = 'gojira-toast';
        el.style.background = '#0f172a';
        el.style.color = '#fff';
        el.style.padding = '12px 16px';
        el.style.marginTop = '8px';
        el.style.borderRadius = '8px';
        el.style.boxShadow = '0 4px 12px rgba(2,6,23,0.4)';
        el.style.cursor = 'pointer';
        el.innerHTML = `<strong style="display:block;margin-bottom:6px">${escapeHtml(title)}</strong><div style="font-size:13px;opacity:0.9">${escapeHtml(body)}</div>`;
        el.onclick = function () { try { if (typeof onClick === 'function') onClick(); } catch (e) { } el.remove(); };
        container.appendChild(el);
        setTimeout(() => { try { el.remove(); } catch (e) { } }, 12000);
      } catch (e) { console.warn('showInAppNotification failed', e); }
    }

    // small helper to escape text inserted into innerHTML
    function escapeHtml(str) { return String(str || '').replace(/[&"'<>]/g, function (m) { return ({ '&': '&amp;', '"': '&quot;', "'": '&#39;', '<': '&lt;', '>': '&gt;' })[m]; }); }


    // FCM token registration helpers
    async function registerFCMTokenForCurrentUser(vapidKey) {
      if (!isFirebaseReady) return Promise.resolve();
      if (!firebaseMessaging || !firebaseFirestore || !firebaseAuth) return Promise.resolve();
      const user = firebaseAuth.currentUser;
      if (!user) return Promise.resolve();
      try {
        // Try to register a service worker (so background notifications work) and then request token
        let options = vapidKey ? { vapidKey } : (typeof FIREBASE_VAPID_KEY !== 'undefined' && FIREBASE_VAPID_KEY ? { vapidKey: FIREBASE_VAPID_KEY } : undefined);
        if ('serviceWorker' in navigator && (!options || !options.serviceWorkerRegistration)) {
          try {
            const reg = await navigator.serviceWorker.register('/firebase-messaging-sw.js');
            options = Object.assign({}, options || {}, { serviceWorkerRegistration: reg });
          } catch (swErr) { console.warn('[FCM] service worker registration failed', swErr); }
        }

        const token = await firebaseMessaging.getToken(options);
        if (!token) return null;
        await firebaseFirestore.collection('fcm_tokens').doc(String(user.uid)).set({ tokens: firebase.firestore.FieldValue.arrayUnion(token), updatedAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge: true });
        console.info('[FCM] token registered for', user.uid);
        return token;
      } catch (e) {
        console.warn('[FCM] register failed', e);
        return null;
      }
    }

    async function deleteFCMTokenForCurrentUser(token) {
      if (!isFirebaseReady) return Promise.resolve();
      if (!firebaseMessaging || !firebaseFirestore || !firebaseAuth) return Promise.resolve();
      const user = firebaseAuth.currentUser;
      if (!user || !token) return Promise.resolve();
      try {
        await firebaseFirestore.collection('fcm_tokens').doc(String(user.uid)).set({ tokens: firebase.firestore.FieldValue.arrayRemove(token) }, { merge: true });
        console.info('[FCM] token removed for', user.uid);
      } catch (e) {
        console.warn('[FCM] delete token failed', e);
      }
    }


    // ---------------------------------------------------------------------

    function agentLoadQADashboard() {
      if (!currentSessionUser || currentSessionUser.role !== 'agent') {
        return; // Only for agents
      }

      const agentIdRaw = currentSessionUser.id;
      const agentId = normalizeId(agentIdRaw); // normalized id for comparisons
      const agentName = currentSessionUser.name;

      // Trigger sync for new reviews
      if (typeof syncReviewsFromSupabase === 'function') {
        syncReviewsFromSupabase().catch(e => console.warn('Agent sync failed', e));
      }


      // Setup Firebase listener so this agent receives cross-device updates in realtime (if configured)
      try {
        if (typeof setupAgentFirebaseListener === 'function') {
          if (isFirebaseReady) {
            setupAgentFirebaseListener(agentId);
            if (typeof registerFCMTokenForCurrentUser === 'function') registerFCMTokenForCurrentUser().catch(() => { });
          } else {
            initFirebase().then(() => {
              setupAgentFirebaseListener(agentId);
              if (typeof registerFCMTokenForCurrentUser === 'function') registerFCMTokenForCurrentUser().catch(() => { });
            }).catch(e => console.warn('[agentLoadQADashboard] initFirebase failed', e));
          }
        }
      } catch (e) {
        console.warn('[agentLoadQADashboard] could not setup firebase listener', e);
      }

      // Set welcome text
      document.getElementById('agent-qa-welcome-text').innerText = `Welcome ${agentName}`;

      // Load reviews for this agent and filter out expired entries
      let reviews = JSON.parse(localStorage.getItem('adminReviews') || '[]');
      const now = new Date();
      reviews = reviews.filter(r => !r.expiryDate || new Date(r.expiryDate) >= now);

      // Filter reviews for current agent only using normalized matching
      const agentReviews = reviews.filter(r => normalizeId(r.agentId) === agentId);

      // Calculate stats
      const totalReviews = agentReviews.length;
      const avgScore = totalReviews > 0 ? Math.round(agentReviews.reduce((sum, r) => sum + r.score, 0) / totalReviews) : 0;

      // Get last review date
      let lastReviewDate = '--';
      if (agentReviews.length > 0) {
        const lastReview = agentReviews[agentReviews.length - 1];
        lastReviewDate = lastReview.displayDate || lastReview.date;
      }

      // Determine performance status
      let status = 'Pending';
      let statusColor = 'text-slate-600';

      if (totalReviews === 0) {
        status = 'Pending';
        statusColor = 'text-slate-600';
      } else if (avgScore >= 80) {
        status = 'Excellent';
        statusColor = 'text-green-600';
      } else if (avgScore >= 60) {
        status = 'Good';
        statusColor = 'text-blue-600';
      } else if (avgScore >= 40) {
        status = 'Need Improvement';
        statusColor = 'text-amber-600';
      } else {
        status = 'Critical';
        statusColor = 'text-red-600';
      }

      // Update stats
      document.getElementById('agent-total-reviews').innerText = totalReviews;
      document.getElementById('agent-avg-score').innerText = avgScore;
      document.getElementById('agent-last-review').innerText = lastReviewDate;
      document.getElementById('agent-performance-status').className = `text-lg font-bold ${statusColor}`;
      document.getElementById('agent-performance-status').innerText = status;

      // Populate reviews history table
      const tbody = document.getElementById('agent-reviews-history');
      const noReviewsMsg = document.getElementById('agent-no-reviews-message');

      if (agentReviews.length === 0) {
        tbody.innerHTML = '';
        noReviewsMsg.classList.remove('hidden');
      } else {
        noReviewsMsg.classList.add('hidden');
        // Build rows with View button to see details
        // Reverse to show newest first
        tbody.innerHTML = [...agentReviews].reverse().map(review => {
          const comments = (JSON.parse(localStorage.getItem('reviewComments') || '[]')).filter(c => c.reviewId === review.id);
          const replyCount = comments.length;
          const displayDate = review.displayDate || review.date;

          return `
            <tr class="hover:bg-slate-50 dark:hover:bg-slate-700/50">
              <td class="p-6">${displayDate}</td>
              <td class="p-6" title="${review.reviewerName || 'Quality Team'}">Quality Team</td>
              <td class="p-6">
                <button onclick="openReviewDetail('${review.id}')" class="text-blue-600 hover:text-blue-800 underline font-semibold">
                  üëÅÔ∏è View
                </button>
              </td>
              <td class="p-6"><span class="font-bold ${review.score === 100 ? 'text-emerald-600' : review.score >= 50 ? 'text-blue-600' : 'text-red-600'}">${review.score}</span></td>
              <td class="p-6 text-sm">${replyCount} <span class="text-slate-500">replies</span></td>
              <td class="p-6"><span class="px-3 py-1 rounded-full text-xs font-bold ${review.score === 100 ? 'bg-emerald-100 text-emerald-700' : 'bg-amber-100 text-amber-700'}">${review.score === 100 ? 'Good' : 'Review'}</span></td>
            </tr>
          `}).join('');
      }

      // Load feedback
      agentLoadFeedback(agentId);
    }

    function agentLoadFeedback(agentId) {
      let comments = JSON.parse(localStorage.getItem('gojira_comments') || '[]');

      // Filter feedback for current agent using normalized ID comparison
      const normalize = id => String(id || '').trim().toLowerCase().replace(/\s+/g, '');
      let agentComments = comments.filter(c => normalize(c.agentId) === normalize(agentId));

      const tbody = document.getElementById('agent-feedback-list');
      const noFeedbackMsg = document.getElementById('agent-no-feedback-message');

      if (agentComments.length === 0) {
        tbody.innerHTML = '';
        noFeedbackMsg.classList.remove('hidden');
      } else {
        noFeedbackMsg.classList.add('hidden');
        const now = new Date();
        tbody.innerHTML = agentComments.map(comment => {
          // Calculate expiry date (7 days from comment date)
          const commentDate = new Date(comment.date);
          const expiryDate = new Date(commentDate.getTime() + 7 * 24 * 60 * 60 * 1000);
          const daysLeft = Math.ceil((expiryDate - now) / (1000 * 60 * 60 * 24));

          return `
              <tr class="hover:bg-slate-50 dark:hover:bg-slate-700/50">
                <td class="p-6">${comment.date}</td>
                <td class="p-6">Quality Team</td>
                <td class="p-6 text-sm">${comment.text.substring(0, 50)}...</td>
                <td class="p-6"><span class="px-3 py-1 rounded-full text-xs font-bold ${daysLeft > 0 ? 'bg-blue-100 text-blue-700' : 'bg-slate-100 text-slate-700'}">${daysLeft > 0 ? daysLeft + ' days' : 'Expired'}</span></td>
              </tr>
            `;
        }).join('');
      }
    }

    function handleAgentSearch(query) {
      const resultsDiv = document.getElementById('indiv-agent-results');
      if (!query || query.length < 2) {
        resultsDiv.classList.add('hidden');
        return;
      }

      const matched = USER_DB.filter(u =>
        u.role === 'agent' &&
        (u.name.toLowerCase().includes(query.toLowerCase()) || u.id.toLowerCase().includes(query.toLowerCase()))
      );

      if (matched.length === 0) {
        resultsDiv.innerHTML = '<div class="p-4 text-sm text-slate-500 italic">No agents found</div>';
      } else {
        resultsDiv.innerHTML = matched.map(u => `
            <div onclick="selectAgent('${u.id}')" class="p-3 hover:bg-slate-50 dark:hover:bg-slate-700 cursor-pointer border-b border-slate-50 dark:border-slate-700 last:border-0">
              <div class="font-bold text-slate-700 dark:text-slate-200">${u.name}</div>
              <div class="text-xs text-slate-500 font-mono">${u.id} ‚Ä¢ ${u.entity}</div>
            </div>
          `).join('');
      }
      resultsDiv.classList.remove('hidden');
    }

    // Agent reply to a specific review
    // Deprecated - use modal version instead
    function agentReplyToReview(reviewId) {
      // This is kept for backwards compatibility but not used
      return;
    }

    function selectAgent(id) {
      selectedAgentForUpload = USER_DB.find(u => u.id === id);
      if (!selectedAgentForUpload) return;

      // Update UI
      document.getElementById('indiv-agent-search').value = '';
      document.getElementById('indiv-agent-results').classList.add('hidden');
      document.getElementById('indiv-agent-selected').classList.remove('hidden');
      document.getElementById('indiv-agent-selected').classList.add('flex');
      document.getElementById('indiv-upload-form').classList.remove('hidden');

      document.getElementById('selected-agent-name').innerText = selectedAgentForUpload.name;
      document.getElementById('selected-agent-id').innerText = selectedAgentForUpload.id;

      // Search Input hidden or disabled
      document.getElementById('indiv-agent-search').parentElement.parentElement.classList.add('hidden');
    }



    async function submitIndividualScore() {
      if (!selectedAgentForUpload) return alert('No agent selected.');

      const score = document.getElementById('indiv-score').value;
      const errors = document.getElementById('indiv-errors').value;
      const compliance = document.getElementById('indiv-compliance').value;

      if (!score || !errors) return alert('Please enter Score and Errors.');

      // Handle File Uploads
      const proofs = [];
      const files = [
        { id: 'proof-audio', name: 'Call Recording', icon: 'üé§' },
        { id: 'proof-chat', name: 'Chat Transcript', icon: 'üí¨' },
        { id: 'proof-email', name: 'Email Proof', icon: '‚úâÔ∏è' }
      ];

      try {
        for (const f of files) {
          const input = document.getElementById(f.id);
          if (input.files.length > 0) {
            const file = input.files[0];
            const content = await readFileAsBase64(file);
            proofs.push({
              name: f.name + ` (${file.name})`,
              icon: f.icon,
              type: file.type,
              content: content
            });
          }
        }
      } catch (e) {
        console.error(e);
        return alert('Error processing files. Please try again.');
      }

      // Save
      MockBackend.savePerformance(selectedAgentForUpload.id, {
        score,
        errors,
        compliance,
        proofs
      });

      alert(`Performance updated for ${selectedAgentForUpload.name} successfully!`);
      clearSelectedAgent();
    }

    function readFileAsBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result);
        reader.onerror = error => reject(error);
      });
    }

    const searchData = [
      { name: 'Knowledge Base', id: 'view-kb' },
      { name: 'Brand Entities', id: 'view-entities' },
      { name: 'New Updates', id: 'view-updates' },
      { name: 'Resources', id: 'view-resources' },
      { name: 'BharatLoan', id: 'view-bharatloan' },
      { name: 'Rupee112', id: 'view-rupee112' },
      { name: 'Loan112', id: 'view-loan112' },
      { name: 'RupeeOnTime', id: 'view-rupeeontime' },
      { name: 'Quality Assurance Checklist', id: 'view-checklist' },
      { name: 'BharatLoan Portal', id: 'view-bharatloan' },
      { name: 'Rupee112 Portal', id: 'view-rupee112' },
      { name: 'Loan112 Portal', id: 'view-loan112' },
      { name: 'RupeeOnTime Portal', id: 'view-rupeeontime' },
      { name: 'WOCOM 365', id: 'view-bharatloan' },
      { name: 'Yellow Ai', id: 'view-bharatloan' },
      { name: 'Outlook', id: 'view-bharatloan' },
    ];

    let currentEntity = '';
    let currentUser = null;
    let selectedAgentForUpload = null;

    const ENTITY_VIEW_MAP = {
      'view-bharatloan': 'BharatLoan',
      'view-rupee112': 'Rupee112',
      'view-loan112': 'Loan112',
      'view-rupeeontime': 'RupeeOnTime'
    };

    // Filter entities display based on user role
    function filterEntitiesDisplay() {
      const userToCheck = currentSessionUser || currentUser;
      if (!userToCheck) return; // Not logged in via new system

      // Get all entity cards
      const entities = document.querySelectorAll('#view-entities .grid > div');

      entities.forEach(entityCard => {
        // Check which entity this card represents based on onclick attribute
        const onclick = entityCard.getAttribute('onclick');
        let entityToShow = null;

        if (onclick.includes('bharatloan')) entityToShow = 'BharatLoan';
        else if (onclick.includes('rupee112')) entityToShow = 'Rupee112';
        else if (onclick.includes('loan112')) entityToShow = 'Loan112';
        else if (onclick.includes('rupeeontime')) entityToShow = 'RupeeOnTime';

        // Show/hide based on user's entity
        if (userToCheck.entity === 'ALL') {
          entityCard.style.display = ''; // Show all for admin/reviewer
        } else if (userToCheck.entity === entityToShow) {
          entityCard.style.display = ''; // Show only matching entity for agents
        } else {
          entityCard.style.display = 'none'; // Hide non-matching entities
        }
      });
    }

    // Filter QA Checklist card in Resources based on user role
    function filterResourcesQACard() {
      const userToCheck = currentSessionUser || currentUser;
      const agentCard = document.getElementById('qa-checklist-card-agent');
      const otherCard = document.getElementById('qa-checklist-card-other');

      if (!agentCard || !otherCard) return;

      if (userToCheck && userToCheck.role === 'agent') {
        // Show agent-specific QA card
        agentCard.classList.remove('hidden');
        otherCard.classList.add('hidden');
      } else {
        // Show entity checklist QA card for others
        agentCard.classList.add('hidden');
        otherCard.classList.remove('hidden');
      }
    }

    function navigateTo(id) {
      // CHECK ACCESS PERMISSION - Use currentSessionUser for new login system
      const userToCheck = currentSessionUser || currentUser;

      if (userToCheck && userToCheck.entity !== 'ALL') {
        const targetEntity = ENTITY_VIEW_MAP[id];
        if (targetEntity && targetEntity !== userToCheck.entity) {

          // Dynamic check: Update modal text to ensure it matches requirement
          const modalTitle = document.getElementById('access-denied-title');
          if (modalTitle) modalTitle.innerText = 'Please enter the correct ID and can choose the correct entity for this ID';

          // Show Access Denied Modal
          document.getElementById('access-denied-modal').classList.remove('hidden');
          return; // STOP NAVIGATION
        }
      }

      document.querySelectorAll('.app-view').forEach(v => v.classList.remove('active'));
      const targetEl = document.getElementById(id);
      targetEl.classList.add('active');

      // Play a zoom-in entrance when arriving at the home view to make the transition feel dynamic
      if (id === 'view-home') {
        targetEl.classList.remove('zoom-in-enter');
        // Force reflow so repeated navigations replay the animation
        void targetEl.offsetWidth;
        targetEl.classList.add('zoom-in-enter');
        const onEnd = () => {
          targetEl.classList.remove('zoom-in-enter');
          targetEl.removeEventListener('animationend', onEnd);
        };
        targetEl.addEventListener('animationend', onEnd);
      }
      window.scrollTo({ top: 0, behavior: 'smooth' });
      // Close search after navigation
      document.getElementById('search-bar').classList.add('hidden');
      document.getElementById('search-input').value = '';
      document.getElementById('search-results').innerHTML = '';

      // Filter Resources QA card when navigating to resources
      if (id === 'view-resources') {
        filterResourcesQACard();
      }

      // Load QA Dashboard for agents and monthly/weekly admin dashboards
      if (id === 'view-agent-qa') {
        try { agentLoadQADashboard(); } catch (e) { console.warn('[navigateTo] agentLoadQADashboard failed', e); }
      }
      if (id === 'view-admin-monthly') {
        renderAdminMonthlyPerformance();
      }
      if (id === 'view-admin-weekly') {
        renderAdminWeeklyPerformance();
      }

      // Check notifications on navigation if agent
      if (currentSessionUser && currentSessionUser.role === 'agent') {
        checkAgentNotifications(false);
      } else if (currentUser && currentUser.role === 'agent') {
        checkAgentNotifications(false);
      }

      // Show notification bell only on homepage
      document.querySelectorAll('.agent-notification-bell').forEach(b => {
        if (id === 'view-home') b.classList.remove('hidden'); else b.classList.add('hidden');
      });
    }

    function toggleFaq(btn) {
      btn.parentElement.classList.toggle('active');
    }

    function showTab(tab, entity = '') {
      const prefix = entity ? '-' + entity : '';
      // Hide all tab contents
      document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));
      // Remove active from all tabs
      const tabSelectors = entity ? `#tab-tools${prefix}` : '#tab-tools';
      document.querySelectorAll(tabSelectors).forEach(btn => {
        btn.classList.remove('text-blue-600', 'border-blue-600');
        btn.classList.add('text-slate-500', 'border-transparent');
      });
      // Show selected tab content
      document.getElementById('content-' + tab + prefix).classList.remove('hidden');
      // Activate selected tab
      document.getElementById('tab-' + tab + prefix).classList.add('text-blue-600', 'border-blue-600');
      document.getElementById('tab-' + tab + prefix).classList.remove('text-slate-500', 'border-transparent');

      // Populate agents list if agents tab is selected
      if (tab === 'agents') {
        populateAgentsList(entity);
      }
    }

    function populateAgentsList(entity) {
      const entityMap = {
        'bharatloan': 'BharatLoan',
        'rupee112': 'Rupee112',
        'loan112': 'Loan112',
        'rupeeontime': 'RupeeOnTime',
        '': 'BharatLoan' // default
      };

      const entityName = entityMap[entity] || 'BharatLoan';
      const containerId = `agents-list-${entity || 'bharatloan'}`;
      const container = document.getElementById(containerId);

      if (!container) return;

      // Filter agents for the current entity
      const agents = USER_DB.filter(u => u.role === 'agent' && u.entity === entityName);

      if (agents.length === 0) {
        container.innerHTML = '<div class="p-4 text-center text-slate-500">No agents found for this entity.</div>';
        return;
      }

      // Create agent list HTML
      container.innerHTML = agents.map(agent => `
          <div class="bg-white dark:bg-slate-700 p-4 rounded-xl border border-slate-200 dark:border-slate-600 hover:shadow-md transition">
            <div class="flex items-center justify-between">
              <div>
                <h4 class="font-bold text-slate-900 dark:text-white text-lg">${agent.name}</h4>
                <p class="text-sm text-slate-600 dark:text-slate-300 font-mono">${agent.id}</p>
              </div>
              <div class="bg-indigo-100 dark:bg-indigo-900 text-indigo-700 dark:text-indigo-200 px-3 py-1 rounded-lg text-sm font-semibold">${agent.entity}</div>
            </div>
          </div>
        `).join('');
    }

    function setTheme(mode) {
      // mode: 'light' | 'dark'
      const html = document.documentElement;
      const icon = document.getElementById('theme-icon');
      const btn = document.getElementById('theme-toggle');

      if (mode === 'dark') {
        html.classList.add('dark');
        // Slight red mix in dark mode is handled by CSS (see .dark rules)
        if (icon) icon.innerText = 'üåô';
        if (btn) {
          btn.title = 'Switch to Light theme';
          btn.setAttribute('aria-label', 'Switch to Light theme');
        }
      } else {
        html.classList.remove('dark');
        if (icon) icon.innerText = '‚òÄÔ∏è';
        if (btn) {
          btn.title = 'Switch to Dark theme';
          btn.setAttribute('aria-label', 'Switch to Dark theme');
        }
      }

      localStorage.setItem('theme', mode);
    }

    function flashHeaderColored(duration = 700) {
      const topNav = document.getElementById('top-nav');
      const headerEl = document.querySelector('header');
      const els = [topNav, headerEl].filter(Boolean);
      els.forEach(el => el.classList.add('header-colored-flash'));
      setTimeout(() => els.forEach(el => el.classList.remove('header-colored-flash')), duration);
    }

    function toggleTheme() {
      const cur = localStorage.getItem('theme') || 'light';
      const next = cur === 'light' ? 'dark' : 'light';

      // Show a brief colored flash as a transition effect between themes
      flashHeaderColored(500);
      setTimeout(() => setTheme(next), 180);
    }

    function toggleDropdown(entity) {
      const dropdown = document.getElementById('support-dropdown' + (entity ? '-' + entity : ''));
      dropdown.classList.toggle('hidden');
    }

    function toggleSearch() {
      const bar = document.getElementById('search-bar');
      bar.classList.toggle('hidden');
      if (!bar.classList.contains('hidden')) {
        document.getElementById('search-input').focus();
      } else {
        document.getElementById('search-input').value = '';
        document.getElementById('search-results').innerHTML = '';
      }
    }

    function performSearch(query) {
      const resultsDiv = document.getElementById('search-results');
      if (!query.trim()) {
        resultsDiv.innerHTML = '';
        return;
      }
      const filtered = searchData.filter(item => item.name.toLowerCase().includes(query.toLowerCase()));
      resultsDiv.innerHTML = filtered.map(item => `<div onclick="navigateTo('${item.id}')" class="px-4 py-2 hover:bg-slate-100 dark:hover:bg-slate-700 cursor-pointer">${item.name}</div>`).join('');
    }

    function showLogin(entity) {
      currentEntity = entity;
      document.getElementById('login-title').innerText = `Login to ${entity}`;
      document.getElementById('login-modal').classList.remove('hidden');
      document.getElementById('empid').value = '';
    }

    function handleChecklistClick(entityName) {
      // If user is logged in as admin or reviewer, set entity and navigate to admin/reviewer dashboard
      if (currentSessionUser && (currentSessionUser.role === 'admin' || currentSessionUser.role === 'reviewer')) {
        currentEntity = entityName;
        adminCurrentEntity = entityName;
        if (currentSessionUser.role === 'admin') {
          navigateTo('view-admin');
          adminLoadAgents();
        } else if (currentSessionUser.role === 'reviewer') {
          navigateTo('view-reviewer');
          adminLoadAgents();
        }
      } else {
        // For non-logged-in users or agents, show login modal
        showLogin(entityName);
      }
    }

    function hideLogin() {
      document.getElementById('login-modal').classList.add('hidden');
      document.getElementById('empid').value = '';
    }

    // USER DATABASE
    const USER_DB = [
      { id: 'BL/GG/25/1135', name: 'Siddhant Chauhan', role: 'admin', entity: 'ALL' },
      { id: 'BL/GG/25/0957', name: 'Ayushi Gupta', role: 'reviewer', entity: 'ALL' },
      { id: 'BL/GG/25/1056', name: 'KARAMJIT SINGH', role: 'reviewer', entity: 'ALL' },
      { id: 'BL/GG/25/703', name: 'SHARAD ADHIKARI', role: 'agent', entity: 'BharatLoan' },
      { id: 'BL/GG/25/704', name: 'DIVYANSHU SHARMA', role: 'agent', entity: 'BharatLoan' },
      { id: 'BL/GG/25/705', name: 'AYUSHMAN TIBREWAL', role: 'agent', entity: 'BharatLoan' },
      { id: 'BL/GG/25/1189', name: 'Khushi Kumari', role: 'agent', entity: 'BharatLoan' },
      { id: 'BL/GG/25/712', name: 'AKSHAY NAGIA', role: 'agent', entity: 'BharatLoan' },
      { id: 'BL/GG/25/1021', name: 'Chitresh Kumar', role: 'agent', entity: 'BharatLoan' },
      { id: 'BL/GG/25/1022', name: 'Akshat', role: 'agent', entity: 'BharatLoan' },
      { id: 'BL/GG/25/1055', name: 'KAJAL', role: 'agent', entity: 'BharatLoan' },
      { id: 'BL/GG/25/1134', name: 'Isha', role: 'agent', entity: 'BharatLoan' },

      { id: 'BL/GG/25/1240', name: 'KUNDAN KUMAR', role: 'agent', entity: 'BharatLoan' },
      { id: 'BL/GG/25/1338', name: 'MOHIT KUMAR', role: 'agent', entity: 'BharatLoan' },
      { id: 'BL/GG/26/042', name: 'MOHD. KAIF', role: 'agent', entity: 'BharatLoan' },


      // LOAN112 AGENTS
      { id: 'L112/GG/25/021', name: 'RITU YADAV', role: 'agent', entity: 'Loan112' },
      { id: 'L112/GG/25/047', name: 'Hari Kishan', role: 'agent', entity: 'Loan112' },
      { id: 'L112/GG/25/022', name: 'ADITYA SINGH', role: 'agent', entity: 'Loan112' },
      { id: 'L112/GG/25/015', name: 'Kunal Kukreti', role: 'agent', entity: 'Loan112' },
      { id: 'L112/GG/25/086', name: 'Joba', role: 'agent', entity: 'Loan112' },
      { id: 'L112/GG/25/026', name: 'AMAAN KHAN', role: 'agent', entity: 'Loan112' },
      { id: 'L112/GG/25/087', name: 'Ajit', role: 'agent', entity: 'Loan112' },
      { id: 'L112/GG/25/046', name: 'Avinash', role: 'agent', entity: 'Loan112' },

      // RUPEE112 AGENTS
      { id: 'R112/GG/25/710', name: 'Priya Kumari', role: 'agent', entity: 'Rupee112' },
      { id: 'R112/GG/24/410', name: 'CHANDAN PANDAY', role: 'agent', entity: 'Rupee112' },
      { id: 'R112/GG/24/432', name: 'SHEETAL SINGH', role: 'agent', entity: 'Rupee112' },
      { id: 'R112/GG/25/623', name: 'GUNJAN', role: 'agent', entity: 'Rupee112' },
      { id: 'R112/GG/25/707', name: 'Dunna Vishal', role: 'agent', entity: 'Rupee112' },
      { id: 'R112/GG/25/754', name: 'Nishu Yadav', role: 'agent', entity: 'Rupee112' },
      { id: 'R112/GG/25/724', name: 'Aryan', role: 'agent', entity: 'Rupee112' },
      { id: 'R112/GG/25/732', name: 'Ansh Rai', role: 'agent', entity: 'Rupee112' },
      { id: 'RDA/GG/25/006', name: 'Ashish Rawat', role: 'agent', entity: 'Rupee112' },
      { id: 'R112/GG/24/478', name: 'KOMAL', role: 'agent', entity: 'Rupee112' },
      { id: 'R112/GG/25/725', name: 'Kusum sharma', role: 'agent', entity: 'Rupee112' },
      { id: 'RDA/GG/25/038', name: 'Nippi', role: 'agent', entity: 'Loan112' },
      { id: 'R112/GG/23/168', name: 'Ruksar', role: 'agent', entity: 'Rupee112' },
      { id: 'R112/GG/25/692', name: 'NEHA', role: 'agent', entity: 'Rupee112' },

      // RUPEE ON TIME AGENTS

      { id: 'RT/GG/25/004', name: 'Jay Prakash', role: 'agent', entity: 'RupeeOnTime' },
      { id: 'BL/GG/25/1233', name: 'Swati', role: 'agent', entity: 'RupeeOnTime' },
      { id: 'BL/JAI/23/0032', name: 'Ritika Panwar', role: 'agent', entity: 'RupeeOnTime' },
      { id: 'RT/GG/26/103', name: 'Meenakshi Verma', role: 'agent', entity: 'RupeeOnTime' },
      { id: 'RT/GG/26/129', name: 'Naman Singh', role: 'agent', entity: 'RupeeOnTime' }
    ];

    function hideLogin() {
      document.getElementById('login-modal').classList.add('hidden');
      document.getElementById('empid').value = '';
    }

    function toggleLoginTheme() {
      const currentMode = localStorage.getItem('loginTheme') || 'bubble';
      const newMode = currentMode === 'bubble' ? 'star' : 'bubble';
      localStorage.setItem('loginTheme', newMode);
      
      // Update button
      const btn = document.getElementById('login-theme-toggle');
      if (btn) {
        btn.textContent = newMode === 'bubble' ? '‚òÄÔ∏è Light' : 'üåô Dark';
      }
      
      // Update HTML theme
      if (newMode === 'star') {
        document.documentElement.classList.add('dark');
      } else {
        document.documentElement.classList.remove('dark');
      }
      
      // Reinitialize animation
      if (typeof window.reinitLoginAnimation === 'function') {
        window.reinitLoginAnimation();
      }
    }

    // Initialize theme toggle on load
    document.addEventListener('DOMContentLoaded', function() {
      const theme = localStorage.getItem('loginTheme') || 'bubble';
      const btn = document.getElementById('login-theme-toggle');
      if (btn) {
        btn.textContent = theme === 'bubble' ? '‚òÄÔ∏è Light' : 'üåô Dark';
      }
      if (theme === 'star') {
        document.documentElement.classList.add('dark');
      } else {
        document.documentElement.classList.remove('dark');
      }
    });

    async function submitLogin(event) {
      try {
        event.preventDefault();
        const empId = document.getElementById('portal-emp-id').value.trim();
        const password = document.getElementById('portal-password').value;
        console.debug('[submitLogin] empId:', empId);

        // Check if employee exists
        const user = USER_DB.find(u => u.id === empId);
        if (!user) {
          console.warn('[submitLogin] Invalid Employee ID:', empId);
          alert('‚ùå Invalid Employee ID');
          return;
        }

        // Check password
        const savedPasswords = JSON.parse(localStorage.getItem('gojira_passwords') || '{}');
        console.debug('[submitLogin] savedPasswords sample:', Object.keys(savedPasswords).slice(0, 5));
        const correctPassword = savedPasswords[empId] || '1234';

        if (password !== correctPassword) {
          console.warn('[submitLogin] Invalid Password for', empId);
          alert('‚ùå Invalid Password');
          return;
        }

        // Login successful - save session
        currentSessionUser = { id: user.id, name: user.name, role: user.role, entity: user.entity };
        localStorage.setItem('gojira_session_user', JSON.stringify(currentSessionUser));
        console.info('[submitLogin] Login successful for', user.id, user.role);

        // Play login sound
        try {
          const sound = document.getElementById('login-sound');
          if (sound) {
            sound.volume = 0.5;
            sound.currentTime = 0;
            await sound.play();
          }
        } catch (e) { console.warn('Login sound play failed:', e); }

        // Apply dark theme after login (colored option removed)
        setTheme('dark');

        // Clear login form
        document.getElementById('portal-emp-id').value = '';
        document.getElementById('portal-password').value = '';

        // Route users based on role
        if (user.role === 'admin') {
          // For admin
          const selectedEntity = document.getElementById('login-entity')?.value || currentEntity || 'ALL';
          adminCurrentEntity = selectedEntity;
          currentUser = user;
          currentEntity = user.entity;

          // Set welcome message with admin name
          const welcomeText = document.getElementById('admin-welcome-text');
          if (welcomeText) welcomeText.innerText = `Welcome ${user.name}`;

          showPortalContent();
          navigateTo('view-home');
        } else if (user.role === 'reviewer') {
          // For reviewer
          const selectedEntity = document.getElementById('login-entity')?.value || currentEntity || 'BharatLoan';
          reviewerCurrentEntity = selectedEntity;
          adminCurrentEntity = selectedEntity; // ensure agent lists populate
          currentUser = user;
          currentEntity = user.entity;

          // Set welcome message with reviewer name
          const welcomeText = document.getElementById('reviewer-welcome-text');
          if (welcomeText) welcomeText.innerText = `Welcome ${user.name}`;

          // Set entity display
          const entityDisplay = document.getElementById('reviewer-entity-display');
          if (entityDisplay) entityDisplay.textContent = reviewerCurrentEntity;

          // Populate agent list for reviewer
          adminLoadAgents();

          showPortalContent();
          navigateTo('view-home');
        } else if (user.role === 'agent') {
          // For agents
          currentUser = user;
          currentEntity = user.entity;

          // Update Header Title
          const titleSpan = document.getElementById('agent-dashboard-title');
          if (titleSpan) titleSpan.innerText = `Welcome ${user.name}`;

          // Update Banner Name
          const bannerName = document.getElementById('agent-name-display');
          if (bannerName) bannerName.innerText = user.name;

          showPortalContent();
          navigateTo('view-home');
        }
      } catch (err) {
        console.error('[submitLogin] error', err);
        alert('An unexpected error occurred during login. Check console for details.');
      }
    }

    window.onload = () => {
      const savedTheme = localStorage.getItem('theme') || 'light';
      // Apply saved theme (supports 'light' | 'dark')
      try { setTheme(savedTheme); } catch (e) { console.warn('[onload] setTheme failed', e); }
      // Initialize file DB (used for storing uploaded review files up to ~50MB). Non-fatal if unsupported.
      try { if (window.indexedDB) { FileDB.init().catch(e => console.warn('[FileDB] init failed', e)); } } catch (e) { console.warn('[FileDB] init failed', e); }



      // Safety: Ensure session persists across refreshes. 
      try {
        const sessionUserRaw = localStorage.getItem('gojira_session_user');
        if (sessionUserRaw) {
          currentSessionUser = JSON.parse(sessionUserRaw);
          console.info('[onload] Restoring session from localStorage for', currentSessionUser?.id);

          // Initialize Firebase Auth listener if configured (so admin sign-in persists and maps into session)
          // initFirebaseAuth removed


          // Restore global variables based on role
          currentUser = currentSessionUser;

          // Theme state handled globally via setTheme during onload (no legacy flag used)
          console.debug('[onload] current theme:', localStorage.getItem('theme'));

          // Move door-brand behind login after its animation completes (synchronised with doors)
          try {
            const doorBrandEl = document.getElementById('door-brand');

            // Play login sound effect
            const loginSound = document.getElementById('login-sound');
            if (loginSound) {
              setTimeout(() => {
                loginSound.volume = 0.5;
                loginSound.play().catch(e => console.warn("Login sound autoplay prevented:", e));
              }, 400); // Sync with door animation start
            }

            if (doorBrandEl) {
              const heading = doorBrandEl.querySelector('.door-brand');

              // When left door animation ends, trigger heading descend animation so it stays centered until doors move
              const leftDoor = document.querySelector('.animate-door-left');
              if (leftDoor) {
                leftDoor.addEventListener('animationend', () => {
                  heading?.classList.add('door-descend');
                  console.debug('[onload] left door animation ended - started door-descend');
                });
              }

              // When heading finishes its descend, finalize moved state and raise the login card
              heading?.addEventListener('animationend', () => {
                doorBrandEl.classList.add('moved');
                const loginCardEl = document.getElementById('login-card');
                if (loginCardEl) loginCardEl.classList.add('raised');
                console.debug('[onload] door-brand animation ended, moved behind login and login-card raised');
              });

              // Fallback in case animation events aren't triggered - ensure proper final state after a short delay
              setTimeout(() => {
                if (!doorBrandEl.classList.contains('moved')) {
                  heading?.classList.add('door-descend');
                }
                setTimeout(() => {
                  doorBrandEl.classList.add('moved');
                  const loginCardEl = document.getElementById('login-card');
                  if (loginCardEl) loginCardEl.classList.add('raised');
                }, 900);
              }, 2400);
            }
          } catch (e) {
            console.warn('[onload] failed to attach door-brand listeners', e);
          }

          // initPortal will be called but we will override its default "show login" behavior if we have a user
        }
      } catch (e) {
        console.warn('[onload] failed to restore session safely', e);
      }

      // Initialize portal login system
      // If we have a user, this function should respect it or we override it immediately after

      // Try to register the service worker for FCM (non-blocking)
      try {
        if ('serviceWorker' in navigator) {
          navigator.serviceWorker.register('/firebase-messaging-sw.js').then(reg => console.info('[SW] registered at', reg.scope)).catch(e => console.warn('[SW] service worker registration failed', e));
        }
      } catch (e) { console.warn('[onload] sw register failed', e); }
      initPortal();

      if (currentSessionUser) {
        showPortalContent();
        if (currentSessionUser.role === 'admin') {
          adminCurrentEntity = currentSessionUser.entity === 'ALL' ? (adminCurrentEntity || 'BharatLoan') : currentSessionUser.entity;
          adminLoadAgents();
        } else if (currentSessionUser.role === 'reviewer') {
          adminCurrentEntity = currentSessionUser.entity === 'ALL' ? (adminCurrentEntity || 'BharatLoan') : currentSessionUser.entity;
          adminLoadAgents();
        } else if (currentSessionUser.role === 'agent') {
          // Agent specific init if needed
          const titleSpan = document.getElementById('agent-dashboard-title');
          if (titleSpan) titleSpan.innerText = `Welcome ${currentSessionUser.name}`;
          const bannerName = document.getElementById('agent-name-display');
          if (bannerName) bannerName.innerText = currentSessionUser.name;
        }

        // Navigate to home or last view? Default to home for now to be safe, or stay on current if possible.
        // User request: "refresh ... it shouldn't be logout"
        // keeping it simple: just show portal content.
      }
    }

    // ===== NEW ADMIN DASHBOARD FUNCTIONS =====
    let adminCurrentEntity = '';
    let adminCurrentAgent = '';
    let adminCurrentAgentName = '';
    let adminReviewItems = [];
    let adminReviewType = ''; // 'voice' or 'non-voice'
    let reviewerCurrentEntity = '';
    let agentCurrentEntity = '';

    function changeAdminCurrentWeek(week) {
      const entity = adminCurrentEntity || 'ALL';
      const state = getEntityWeekState(entity);
      const newWeek = parseInt(week);
      
      if (newWeek >= 1 && newWeek <= 4) {
        state.currentWeek = newWeek;
        setEntityWeekState(entity, state);
        
        // Update UI
        document.getElementById('admin-week-display').textContent = newWeek;
        document.getElementById('admin-week-selector').value = newWeek;
        
        // Refresh the agent list and check button states
        adminLoadAgents();
        checkAndEnableWeekFinalButton();
        
        // Refresh performance dashboards if they're visible
        if (!document.getElementById('view-admin-weekly').classList.contains('hidden')) {
          renderAdminWeeklyPerformance();
        }
        if (!document.getElementById('view-admin-monthly').classList.contains('hidden')) {
          renderAdminMonthlyPerformance();
        }
      }
    }

    

    
    function getEntityWeekState(entity) {
      if (!entity) entity = 'ALL';
      return JSON.parse(localStorage.getItem(`entityWeekState_${entity}`) || JSON.stringify({ currentWeek: 1, completedAgents: {} }));
    }

    function setEntityWeekState(entity, state) {
      if (!entity) entity = 'ALL';
      localStorage.setItem(`entityWeekState_${entity}`, JSON.stringify(state));
    }

    function markAgentWeekComplete(entity, agentId) {
      const state = getEntityWeekState(entity);
      const week = state.currentWeek || 1;
      state.completedAgents = state.completedAgents || {};
      state.completedAgents[week] = state.completedAgents[week] || {};
      state.completedAgents[week][agentId] = true;
      setEntityWeekState(entity, state);
      // Refresh UI dropdown and controls
      renderAdminAgentDropdown();
      checkAndEnableWeekFinalButton();
    }

    function unmarkAgentWeekComplete(entity, agentId) {
      // If entity provided is specific, remove for that entity/week; otherwise sweep all stored entityWeekState_ keys
      const sweepAll = !entity || entity === 'ALL';

      if (sweepAll) {
        // Remove agent from any entityWeekState_* entries
        Object.keys(localStorage).forEach(key => {
          if (!key.startsWith('entityWeekState_')) return;
          try {
            const state = JSON.parse(localStorage.getItem(key) || '{}');
            if (state && state.completedAgents) {
              let changed = false;
              Object.keys(state.completedAgents).forEach(wk => {
                if (state.completedAgents[wk] && state.completedAgents[wk][agentId]) {
                  delete state.completedAgents[wk][agentId];
                  changed = true;
                }
              });
              if (changed) localStorage.setItem(key, JSON.stringify(state));
            }
          } catch (e) {
            console.warn('Failed parsing', key, e);
          }
        });
      } else {
        const state = getEntityWeekState(entity);
        const week = state.currentWeek || 1;
        if (state.completedAgents && state.completedAgents[week] && state.completedAgents[week][agentId]) {
          delete state.completedAgents[week][agentId];
          setEntityWeekState(entity, state);
        }
      }
    }







    function isAgentWeekComplete(entity, agentId) {
      const state = getEntityWeekState(entity);
      const week = state.currentWeek || 1;
      return !!(state.completedAgents && state.completedAgents[week] && state.completedAgents[week][agentId]);
    }

    function adminClearFinalizations() {
      if (!confirm('Are you sure you want to clear all agent finalizations for the current week? They will be able to have reviews added again.')) {
        return;
      }

      const entity = adminCurrentEntity || 'ALL';
      const state = getEntityWeekState(entity);
      const currentWeek = state.currentWeek || 1;

      // Clear all completed agents for current week
      if (state.completedAgents && state.completedAgents[currentWeek]) {
        state.completedAgents[currentWeek] = {};
        setEntityWeekState(entity, state);
      }

      // Refresh UI
      adminLoadAgents();
      checkAndEnableWeekFinalButton();
      renderAdminAgentDropdown();

      alert(`All agent finalizations for Week ${currentWeek} have been cleared. Agents can now receive new reviews.`);
    }

    function renderAdminAgentDropdown() {
      const adminSelector = document.getElementById('admin-agent-selector');
      const dropdownList = document.getElementById('admin-agent-dropdown-list');
      const selectedText = document.getElementById('admin-agent-dropdown-selected-text');
      const dropdownSelected = document.getElementById('admin-agent-dropdown-selected');
      if (!dropdownList || !adminSelector || !selectedText || !dropdownSelected) return;

      // Build agent list
      dropdownList.innerHTML = '';
      adminSelector.innerHTML = '<option value="">-- Click to Select Agent --</option>';

      let agents = USER_DB.filter(u => u.role === 'agent');
      if (adminCurrentEntity && adminCurrentEntity !== 'ALL') {
        agents = agents.filter(u => u.entity === adminCurrentEntity);
      }

      const state = getEntityWeekState(adminCurrentEntity || 'ALL');
      const currentWeek = state.currentWeek || 1;

      agents.forEach(agent => {
        const completed = !!(state.completedAgents && state.completedAgents[currentWeek] && state.completedAgents[currentWeek][agent.id]);

        // Populate hidden select for backwards compatibility
        const option = document.createElement('option');
        option.value = agent.id;
        option.text = `${agent.name} ${agent.id}${completed ? ' ‚úÖ' : ''}`;
        option.dataset.name = agent.name;
        if (completed) option.title = `Finalized for Week ${currentWeek}`;
        adminSelector.appendChild(option);

        // Create visible list item
        const item = document.createElement('div');
        item.className = 'p-3 cursor-pointer hover:bg-slate-100 dark:hover:bg-slate-700 flex items-center justify-between';
        item.innerHTML = `
            <div class="flex items-center">
              <div class="w-6 h-6 rounded-full mr-3 flex items-center justify-center ${completed ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-600'}">${completed ? '‚úî' : ''}</div>
              <div class="font-bold">${agent.name} ${agent.id}</div>
            </div>
            <div class="text-sm text-slate-500">${completed ? 'Finalized Wk ' + currentWeek : ''}</div>
          `;

        item.addEventListener('click', () => {
          adminSelectAgent(agent.id, agent.name);
          // Update selected text
          selectedText.innerHTML = `${agent.name} ${agent.id}${completed ? ' <span class=\"text-blue-600 font-bold\">‚úî</span>' : ''}`;
          // close dropdown
          dropdownList.classList.add('hidden');
        });

        dropdownList.appendChild(item);
      });

      // Update selected text if an agent is already selected (show blue tick if completed)
      if (adminCurrentAgent) {
        const sel = [...adminSelector.options].find(o => o.value === adminCurrentAgent);
        const agent = agents.find(a => a.id === adminCurrentAgent);
        const completed = agent && isAgentWeekComplete(adminCurrentEntity || 'ALL', adminCurrentAgent);
        if (sel) selectedText.innerHTML = `${agent.name} ${agent.id}${completed ? ' <span class="text-blue-600 font-bold">‚úî</span>' : ''}`;
      } else {
        selectedText.textContent = '-- Click to Select Agent --';
      }

      // Toggle dropdown on click
      dropdownSelected.onclick = (e) => {
        e.stopPropagation();
        dropdownList.classList.toggle('hidden');
      };

      // Close dropdown when clicking outside (attach listener only once)
      if (!dropdownList.dataset.listenerAttached) {
        document.addEventListener('click', (ev) => {
          if (!dropdownList.classList.contains('hidden')) dropdownList.classList.add('hidden');
        });
        dropdownList.dataset.listenerAttached = '1';
      }
    }


    /* -------------------------------------------------------------------------- */
    /*                        CSV DOWNLOAD & WEEKLY REPORTS                       */
    /* -------------------------------------------------------------------------- */

    function downloadTableAsCSV(tableId, filename) {
      const table = document.getElementById(tableId);
      if (!table) return;

      let csv = [];
      const rows = table.querySelectorAll("tr");

      for (let i = 0; i < rows.length; i++) {
        const row = [], cols = rows[i].querySelectorAll("td, th");

        for (let j = 0; j < cols.length; j++) {
          // Clean text: remove newlines, multiple spaces, and escape quotes
          let data = cols[j].innerText.replace(/(\r\n|\n|\r)/gm, " ").replace(/\s+/g, " ").trim();
          row.push('"' + data + '"');
        }
        csv.push(row.join(","));
      }

      const csvFile = new Blob([csv.join("\n")], { type: "text/csv" });
      const downloadLink = document.createElement("a");
      downloadLink.download = filename + ".csv";
      downloadLink.href = window.URL.createObjectURL(csvFile);
      downloadLink.style.display = "none";
      document.body.appendChild(downloadLink);
      downloadLink.click();
      document.body.removeChild(downloadLink);
    }

    /* -------------------------------------------------------------------------- */
    /*                        RESET DATA MODAL LOGIC                              */
    /* -------------------------------------------------------------------------- */

    let currentResetType = ''; // 'weekly' or 'monthly'

    function openResetDataModal(type) {
      currentResetType = type;
      const modal = document.getElementById('admin-reset-data-modal');
      const typeDisplay = document.getElementById('reset-data-type-display');
      const select = document.getElementById('reset-data-agent-select');

      if (!modal || !select) return;

      typeDisplay.textContent = type === 'weekly' ? 'Weekly' : 'Monthly';

      // Populate agents from current entity
      select.innerHTML = '<option value="">-- Select Agent --</option>';
      const entity = adminCurrentEntity || 'ALL';
      let agents = USER_DB.filter(u => u.role === 'agent');
      if (entity !== 'ALL') {
        agents = agents.filter(u => u.entity === entity);
      }

      agents.forEach(agent => {
        const opt = document.createElement('option');
        opt.value = agent.id;
        opt.textContent = `${agent.name} (${agent.id})`;
        select.appendChild(opt);
      });

      modal.classList.remove('hidden');
    }

    function closeResetDataModal() {
      document.getElementById('admin-reset-data-modal').classList.add('hidden');
      currentResetType = '';
    }

    function confirmResetData() {
      const select = document.getElementById('reset-data-agent-select');
      const agentId = select.value;

      if (!agentId) {
        alert('Please select an agent.');
        return;
      }

      const agentName = select.options[select.selectedIndex].text;
      if (!confirm(`Are you sure you want to delete ALL ${currentResetType} data for ${agentName}? This cannot be undone.`)) {
        return;
      }

      // Load current reviews
      let reviews = JSON.parse(localStorage.getItem('adminReviews') || '[]');
      const now = new Date();
      let deletedCount = 0;
      const reviewsToDelete = []; // Track deleted reviews for Supabase sync

      // Normalize target agent ID
      const targetAgentId = String(agentId).trim().toLowerCase();

      if (currentResetType === 'weekly') {
        const weekSelect = document.getElementById('admin-weekly-select-week');
        const monthSelect = document.getElementById('admin-weekly-select-month');
        const yearSelect = document.getElementById('admin-weekly-select-year');

        let startDate, endDate;

        if (weekSelect && monthSelect && yearSelect && weekSelect.value && monthSelect.value && yearSelect.value) {
          const year = parseInt(yearSelect.value);
          const month = parseInt(monthSelect.value) - 1; // 0-indexed
          const week = parseInt(weekSelect.value);

          let startDay = (week - 1) * 7 + 1;
          startDate = new Date(year, month, startDay);

          if (week === 4) {
            endDate = new Date(year, month + 1, 0);
          } else {
            endDate = new Date(year, month, startDay + 6);
          }
          startDate.setHours(0, 0, 0, 0);
          endDate.setHours(23, 59, 59, 999);
        } else {
          // Fallback: Delete last 7 days if selectors are missing (legacy or fail-safe)
          const now = new Date();
          endDate = now;
          startDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
        }

        reviews = reviews.filter(r => {
          if (String(r.agentId).trim().toLowerCase() !== targetAgentId) return true; // Keep others

          // Check if this review is within the selected range
          const d = new Date(r.date);
          if (d >= startDate && d <= endDate) {
            deletedCount++;
            reviewsToDelete.push(r); // Track for Supabase sync
            return false; // Remove
          }
          return true;
        });

        // Clear Finalization Status (Using selected week index if possible)
        try {
          const state = getEntityWeekState(adminCurrentEntity || 'ALL');
          // If we have a selected week from dropdown, use it, otherwise default to "current"
          const targetWeek = (weekSelect && weekSelect.value) ? parseInt(weekSelect.value) : (state.currentWeek || 1);

          let cleared = false;
          if (state.completedAgents && state.completedAgents[targetWeek]) {
            // Direct check
            if (state.completedAgents[targetWeek] && state.completedAgents[targetWeek][agentId]) {
              delete state.completedAgents[targetWeek][agentId];
              cleared = true;
            } else if (state.completedAgents[targetWeek]) {
              // Case-insensitive check
              const keys = Object.keys(state.completedAgents[targetWeek]);
              const match = keys.find(k => String(k).toLowerCase() === String(agentId).toLowerCase());
              if (match) {
                delete state.completedAgents[targetWeek][match];
                cleared = true;
              }
            }
          }
          if (cleared) saveEntityWeekState(state);
        } catch (e) { console.error('Error clearing week state', e); }

      } else if (currentResetType === 'monthly') {
        // Monthly Logic:
        const monthSelect = document.getElementById('admin-monthly-select-month');
        const yearSelect = document.getElementById('admin-monthly-select-year');
        const isMonthlyViewActive = !document.getElementById('view-admin-monthly').classList.contains('hidden');

        let selYear = null;
        let selMonth = null;

        if (isMonthlyViewActive && monthSelect && yearSelect && monthSelect.value && yearSelect.value) {
          // Targeted Month Wipe
          selYear = parseInt(yearSelect.value);
          selMonth = parseInt(monthSelect.value);
        } else {
          // Full Wipe (Main Dashboard or no month selected)
          selYear = null;
          selMonth = null;
        }

        reviews = reviews.filter(r => {
          if (String(r.agentId).trim().toLowerCase() !== targetAgentId) return true;

          // If no specific month targeted, delete ALL reviews for agent
          if (selYear === null) {
            deletedCount++;
            reviewsToDelete.push(r); // Track for Supabase sync
            return false;
          }

          const d = new Date(r.date);
          // Match Year and Month
          if (d.getFullYear() === selYear && (d.getMonth() + 1) === selMonth) {
            deletedCount++;
            reviewsToDelete.push(r); // Track for Supabase sync
            return false; // Remove
          }
          return true;
        });
      }

      localStorage.setItem('adminReviews', JSON.stringify(reviews));

      // Sync deletions to Supabase for each deleted review
      for (const review of reviewsToDelete) {
        if (review && review.id) {
          if (typeof syncReviewDeletionToSupabase === 'function') {
            syncReviewDeletionToSupabase(review.id).catch(e => console.warn('[confirmResetData] Supabase delete failed', review.id, e));
          }
        }
        // Delete associated file if stored
        if (review && review.fileStored) {
          (async () => {
            try {
              if (!FileDB._db) await FileDB.init();
              await FileDB.deleteFile(review.id);
            } catch (e) { console.warn('[confirmResetData] failed to delete file', review.id, e); }
          })();
        }
      }

      // Update timestamps/sync if needed
      try { localStorage.setItem('adminReviewsUpdatedAt', Date.now().toString()); } catch (e) { }

      // Refresh UI based on active view
      if (currentResetType === 'weekly') {
        if (typeof renderAdminWeeklyPerformance === 'function') renderAdminWeeklyPerformance();
      } else {
        if (typeof renderAdminMonthlyPerformance === 'function') renderAdminMonthlyPerformance();
      }

      closeResetDataModal();

      if (deletedCount > 0) {
        alert(`Successfully deleted ${deletedCount} reviews for ${agentName}.`);
      } else {
        alert(`No matching ${currentResetType} data found for ${agentName} to delete.`);
      }
    }

    function initMonthlyDashboardControls() {
      const selectMonth = document.getElementById('admin-monthly-select-month');
      const selectYear = document.getElementById('admin-monthly-select-year');
      if (!selectMonth || !selectYear) return;

      const currentMonth = new Date().getMonth(); // 0-11
      const defaultYear = 2026;

      // populate months
      selectMonth.innerHTML = '';
      const months = [
        "January", "February", "March", "April", "May", "June",
        "July", "August", "September", "October", "November", "December"
      ];
      months.forEach((mName, idx) => {
        const option = document.createElement('option');
        option.value = idx + 1;
        option.text = mName;
        if (idx === currentMonth) option.selected = true; // Default to current month
        selectMonth.appendChild(option);
      });

      // populate years (2026-2030)
      selectYear.innerHTML = '';
      for (let y = 2026; y <= 2030; y++) {
        const option = document.createElement('option');
        option.value = y;
        option.text = y;
        if (y === defaultYear) option.selected = true; // Default to 2026 as requested
        selectYear.appendChild(option);
      }
    }

    function renderAdminMonthlyPerformance() {
      const tbody = document.getElementById('admin-monthly-table-body');
      const entity = adminCurrentEntity || 'ALL';
      const monthSelect = document.getElementById('admin-monthly-select-month');
      const yearSelect = document.getElementById('admin-monthly-select-year');

      if (!tbody) return;
      tbody.innerHTML = ''; // loading state

      // Initialize dropdowns if empty
      if (monthSelect && monthSelect.options.length === 0) {
        initMonthlyDashboardControls();
      }

      let selYear, selMonth;

      if (monthSelect && yearSelect && monthSelect.value && yearSelect.value) {
        selYear = parseInt(yearSelect.value);
        selMonth = parseInt(monthSelect.value);
      } else {
        // Fallback or init default (Current Month, 2026)
        const now = new Date();
        selMonth = now.getMonth() + 1;
        selYear = 2026;
      }

      // 1. Get Agents
      let agents = USER_DB.filter(u => u.role === 'agent');
      if (entity !== 'ALL') {
        agents = agents.filter(u => u.entity === entity);
      }

      // 2. Get Reviews
      const reviews = JSON.parse(localStorage.getItem('adminReviews') || '[]');

      // 3. Process Data
      const rows = agents.map(agent => {
        // Filter reviews for this agent matching the selected month/year
        const agentId = String(agent.id).trim().toLowerCase();

        const agentReviews = reviews.filter(r => {
          const rAgentId = String(r.agentId).trim().toLowerCase();
          if (rAgentId !== agentId) return false;

          // Date check
          const d = new Date(r.date);
          if (isNaN(d.getTime())) return false;

          return d.getFullYear() === selYear && (d.getMonth() + 1) === selMonth;
        });

        const totalAudits = agentReviews.length;
        const avgScore = totalAudits > 0 ? Math.round(agentReviews.reduce((sum, r) => sum + r.score, 0) / totalAudits) : 0;
        const fatalCount = agentReviews.filter(r => r.score === 0 || (r.fatals && r.fatals > 0)).length;
        const perfectCount = agentReviews.filter(r => r.score === 100).length;

        // Performace Status & Color Logic
        let status = 'Pending';
        let statusClass = 'bg-slate-100 text-slate-500';
        let scoreClass = 'text-slate-400 bg-slate-50';

        // Fatal Color Logic
        let fatalClass = 'text-green-600'; // Default Low (0)
        if (fatalCount > 2) fatalClass = 'text-red-600 font-black animate-pulse'; // Highest
        else if (fatalCount === 2) fatalClass = 'text-orange-600 font-bold'; // Medium
        else if (fatalCount === 1) fatalClass = 'text-amber-500 font-semibold'; // Low-Medium

        if (totalAudits > 0) {
          // Tiered Color Logic: Dark Green -> Green -> Light Green -> Yellow -> Orange -> Red
          if (avgScore >= 95 && fatalCount === 0) {
            status = 'Outstanding';
            statusClass = 'bg-emerald-900 text-white shadow-md'; // Dark Green
            scoreClass = 'text-emerald-900 bg-emerald-100';
          }
          else if (avgScore >= 90 && fatalCount <= 1) {
            status = 'Excellent';
            statusClass = 'bg-green-600 text-white'; // Green
            scoreClass = 'text-green-700 bg-green-100';
          }
          else if (avgScore >= 80 && fatalCount <= 2) {
            status = 'Good';
            statusClass = 'bg-green-400 text-white'; // Light Green
            scoreClass = 'text-green-600 bg-green-50';
          }
          else if (avgScore >= 70) {
            status = 'Average';
            statusClass = 'bg-yellow-400 text-white'; // Yellow
            scoreClass = 'text-yellow-700 bg-yellow-50';
          }
          else if (avgScore >= 60) {
            status = 'Below Avg';
            statusClass = 'bg-orange-500 text-white'; // Orange
            scoreClass = 'text-orange-700 bg-orange-50';
          }
          else {
            status = 'Critical';
            statusClass = 'bg-red-600 text-white animate-pulse'; // Red
            scoreClass = 'text-red-700 bg-red-50';
          }
        }

        return {
          name: agent.name,
          id: agent.id,
          audits: totalAudits,
          fatals: fatalCount,
          perfects: perfectCount,
          score: avgScore,
          status: status,
          statusClass: statusClass,
          fatalClass: fatalClass,
          scoreClass: scoreClass
        };
      });

      // 4. Render
      if (rows.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="p-6 text-center text-slate-400 italic">No agents found for this entity.</td></tr>';
        return;
      }

      // Sort by score desc
      rows.sort((a, b) => b.score - a.score);

      tbody.innerHTML = rows.map((row, index) => {
        // Blank logic for empty audits
        const showAudits = row.audits === 0 ? '--' : row.audits;
        const showFatals = row.audits === 0 ? '--' : row.fatals;
        const showPerfects = row.audits === 0 ? '--' : row.perfects;
        const showScore = row.audits === 0 ? '--' : row.score + '%';
        const showStatus = row.audits === 0 ? '<span class="text-slate-400">--</span>' : `<span class="px-3 py-1 rounded-full text-xs font-bold uppercase ${row.statusClass}">${row.status}</span>`;
        const scoreClass = row.scoreClass || '';

        return `
          <tr class="hover:bg-indigo-50/30 dark:hover:bg-slate-700/30 transition">
            <td class="p-6 text-center font-bold text-slate-400">#${index + 1}</td>
            <td class="p-6">
                <div class="font-bold rounded-lg p-3 ${row.statusClass}">
                  <div class="text-lg text-white drop-shadow-md">${row.name}</div>
                  <div class="text-xs text-white/80 font-mono">${row.id}</div>
                </div>
            </td>
            <td class="p-6 text-center font-bold text-slate-700 dark:text-slate-300 text-lg">${showAudits}</td>
            <td class="p-6 text-center font-bold text-lg ${row.audits > 0 ? row.fatalClass : 'text-slate-400'}">${showFatals}</td>
            <td class="p-6 text-center font-bold text-indigo-600 text-lg">${showPerfects}</td>
            <td class="p-6 text-center">
                <div class="inline-block px-3 py-1 rounded-full font-bold text-sm ${scoreClass}">
                  ${showScore}
                </div>
            </td>
            <td class="p-6 text-center">
                ${showStatus}
            </td>
          </tr>
        `}).join('');
    }

    function initWeeklyDashboardControls() {
      const selectMonth = document.getElementById('admin-weekly-select-month');
      const selectYear = document.getElementById('admin-weekly-select-year');
      if (!selectMonth || !selectYear) return;

      const currentMonth = new Date().getMonth(); // 0-11
      const defaultYear = new Date().getFullYear();

      // populate months
      selectMonth.innerHTML = '';
      const months = [
        "January", "February", "March", "April", "May", "June",
        "July", "August", "September", "October", "November", "December"
      ];
      months.forEach((mName, idx) => {
        const option = document.createElement('option');
        option.value = idx + 1;
        option.text = mName;
        if (idx === currentMonth) option.selected = true;
        selectMonth.appendChild(option);
      });

      // populate years (2025-2030)
      selectYear.innerHTML = '';
      for (let y = 2025; y <= 2030; y++) {
        const option = document.createElement('option');
        option.value = y;
        option.text = y;
        if (y === defaultYear) option.selected = true;
        selectYear.appendChild(option);
      }
    }

    function renderAdminWeeklyPerformance() {
      const tbody = document.getElementById('admin-weekly-list');
      const entity = adminCurrentEntity || 'ALL';

      // Selectors
      const weekSelect = document.getElementById('admin-weekly-select-week');
      const monthSelect = document.getElementById('admin-weekly-select-month');
      const yearSelect = document.getElementById('admin-weekly-select-year');

      if (!tbody) return;
      tbody.innerHTML = ''; // loading state

      // Initialize dropdowns if empty
      if (monthSelect && monthSelect.options.length === 0) {
        initWeeklyDashboardControls();
      }

      // Set week selector to the admin's selected week for this entity
      const state = getEntityWeekState(entity);
      const currentWeek = state.currentWeek || 1;
      if (weekSelect) {
        weekSelect.value = currentWeek;
      }

      // Determine Date Range from Selectors
      let startDate, endDate;

      if (weekSelect && monthSelect && yearSelect && weekSelect.value && monthSelect.value && yearSelect.value) {
        const year = parseInt(yearSelect.value);
        const month = parseInt(monthSelect.value) - 1; // 0-indexed
        const week = parseInt(weekSelect.value);

        // Week 1: 1st - 7th
        // Week 2: 8th - 14th
        // Week 3: 15th - 21st
        // Week 4: 22nd - End of Month

        let startDay = (week - 1) * 7 + 1;
        startDate = new Date(year, month, startDay);

        if (week === 4) {
          // For week 4, go to the last day of the month
          endDate = new Date(year, month + 1, 0);
          // Limit to end of month
        } else {
          endDate = new Date(year, month, startDay + 6);
        }
        // Set times to cover the full days
        startDate.setHours(0, 0, 0, 0);
        endDate.setHours(23, 59, 59, 999);
      } else {
        // Fallback: Current Week Logic (approx)
        const now = new Date();
        endDate = now;
        startDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
      }

      // 1. Get Agents
      let agents = USER_DB.filter(u => u.role === 'agent');
      if (entity !== 'ALL') {
        agents = agents.filter(u => u.entity === entity);
      }

      // 2. Get Reviews
      const reviews = JSON.parse(localStorage.getItem('adminReviews') || '[]');

      // 3. Process Data
      const rows = agents.map(agent => {
        const agentId = String(agent.id).trim().toLowerCase();

        const agentReviews = reviews.filter(r => {
          const rAgentId = String(r.agentId).trim().toLowerCase();
          if (rAgentId !== agentId) return false;

          const d = new Date(r.date);
          if (isNaN(d.getTime())) return false; // skip invalid dates

          return d >= startDate && d <= endDate;
        });

        const totalAudits = agentReviews.length;
        const avgScore = totalAudits > 0 ? Math.round(agentReviews.reduce((sum, r) => sum + r.score, 0) / totalAudits) : 0;
        const fatalCount = agentReviews.filter(r => r.score === 0 || (r.fatals && r.fatals > 0)).length; // Assuming score 0 implies fatal or explicit fatal flag
        const perfectCount = agentReviews.filter(r => r.score === 100).length;

        // Performace Status & Color Logic
        let status = 'Pending';
        let statusClass = 'bg-slate-100 text-slate-500';
        let scoreClass = 'text-slate-400 bg-slate-50';

        // Fatal Color Logic
        let fatalClass = 'text-green-600'; // Default Low (0)
        if (fatalCount > 2) fatalClass = 'text-red-600 font-black animate-pulse'; // Highest
        else if (fatalCount === 2) fatalClass = 'text-orange-600 font-bold'; // Medium
        else if (fatalCount === 1) fatalClass = 'text-amber-500 font-semibold'; // Low-Medium

        if (totalAudits > 0) {
          // Tiered Color Logic: Dark Green -> Green -> Light Green -> Yellow -> Orange -> Red
          if (avgScore >= 95 && fatalCount === 0) {
            status = 'Outstanding';
            statusClass = 'bg-emerald-900 text-white shadow-md'; // Dark Green
            scoreClass = 'text-emerald-900 bg-emerald-100';
          }
          else if (avgScore >= 90 && fatalCount <= 1) {
            status = 'Excellent';
            statusClass = 'bg-green-600 text-white'; // Green
            scoreClass = 'text-green-700 bg-green-100';
          }
          else if (avgScore >= 80 && fatalCount <= 2) {
            status = 'Good';
            statusClass = 'bg-green-400 text-white'; // Light Green
            scoreClass = 'text-green-600 bg-green-50';
          }
          else if (avgScore >= 70) {
            status = 'Average';
            statusClass = 'bg-yellow-400 text-white'; // Yellow
            scoreClass = 'text-yellow-700 bg-yellow-50';
          }
          else if (avgScore >= 60) {
            status = 'Below Avg';
            statusClass = 'bg-orange-500 text-white'; // Orange
            scoreClass = 'text-orange-700 bg-orange-50';
          }
          else {
            status = 'Critical';
            statusClass = 'bg-red-600 text-white animate-pulse'; // Red
            scoreClass = 'text-red-700 bg-red-50';
          }
        }

        return {
          name: agent.name,
          id: agent.id,
          audits: totalAudits,
          fatals: fatalCount,
          perfects: perfectCount,
          score: avgScore,
          status: status,
          statusClass: statusClass,
          fatalClass: fatalClass,
          scoreClass: scoreClass
        };
      });

      // 4. Render
      if (rows.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="p-6 text-center text-slate-400 italic">No agents found for this entity.</td></tr>';
        return;
      }

      // Sort by fatals (asc) then score (desc) to highlight quality
      rows.sort((a, b) => {
        if (a.fatals !== b.fatals) return a.fatals - b.fatals; // Less fatals is better
        return b.score - a.score;
      });

      tbody.innerHTML = rows.map((row, index) => {
        const showAudits = row.audits === 0 ? '--' : row.audits;
        const showFatals = row.audits === 0 ? '--' : row.fatals;
        const showPerfects = row.audits === 0 ? '--' : row.perfects;
        const showScore = row.audits === 0 ? '--' : row.score + '%';
        const scoreClass = row.scoreClass || '';

        return `
          <tr class="hover:bg-teal-50/30 dark:hover:bg-slate-700/30 transition">
            <td class="p-6 text-center font-bold text-slate-400">#${index + 1}</td>
            <td class="p-6">
                <div class="text-lg font-bold text-slate-900 dark:text-white">${row.name}</div>
            </td>
            <td class="p-6 text-center font-bold text-slate-700 dark:text-slate-300 text-lg">${showAudits}</td>
            <td class="p-6 text-center font-bold text-lg ${row.audits > 0 ? row.fatalClass : 'text-slate-400'}">${showFatals}</td>
            <td class="p-6 text-center font-bold text-indigo-600 text-lg">${showPerfects}</td>
            <td class="p-6 text-center">
                <div class="inline-block px-3 py-1 rounded-full font-bold text-sm ${scoreClass}">
                  ${showScore}
                </div>
            </td>
            <td class="p-6 text-center">
                <span class="px-3 py-1 rounded-full text-xs font-bold uppercase ${row.statusClass}">${row.status}</span>
            </td>
          </tr>
        `}).join('');
    }

    function checkAndEnableWeekFinalButton() {
      const state = getEntityWeekState(adminCurrentEntity || 'ALL');
      const currentWeek = state.currentWeek || 1;
      const agentsList = USER_DB.filter(u => u.role === 'agent' && (!adminCurrentEntity || adminCurrentEntity === 'ALL' || u.entity === adminCurrentEntity));
      const total = agentsList.length;
      const completedCount = agentsList.filter(a => state.completedAgents && state.completedAgents[currentWeek] && state.completedAgents[currentWeek][a.id]).length;

      const progressEl = document.getElementById('admin-week-progress');
      const weekDisplay = document.getElementById('admin-week-display');
      const finalBtn = document.getElementById('admin-week-final-submit-btn');
      if (weekDisplay) weekDisplay.textContent = currentWeek;
      if (progressEl) progressEl.textContent = `(${completedCount}/${total} completed)`;

      if (completedCount > 0 && completedCount === total) {
        if (finalBtn) {
          finalBtn.disabled = false;
          finalBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        }
      } else {
        if (finalBtn) {
          finalBtn.disabled = true;
          finalBtn.classList.add('opacity-50', 'cursor-not-allowed');
        }
      }
    }

    function adminFinalizeWeek() {
      if (!adminCurrentEntity) adminCurrentEntity = 'ALL';
      const state = getEntityWeekState(adminCurrentEntity);
      const currentWeek = state.currentWeek || 1;
      // Mark week as finalized
      state.finalizedWeeks = state.finalizedWeeks || [];
      if (!state.finalizedWeeks.includes(currentWeek)) state.finalizedWeeks.push(currentWeek);
      // Advance week
      if (currentWeek < 4) {
        state.currentWeek = currentWeek + 1;
      } else {
        // Cycle back to week 1 after week 4
        state.currentWeek = 1;
      }
      // Reset completed for new week
      state.completedAgents[state.currentWeek] = state.completedAgents[state.currentWeek] || {};
      setEntityWeekState(adminCurrentEntity, state);

      alert(`Week ${currentWeek} finalized. Moved to Week ${state.currentWeek}.`);
      // Refresh UI
      adminLoadAgents();
      checkAndEnableWeekFinalButton();
    }

    function adminLoadAgents() {
      // Display current entity for admin dashboard
      const adminEntityDisplay = document.getElementById('admin-entity-display');
      if (adminEntityDisplay) {
        adminEntityDisplay.textContent = adminCurrentEntity === 'ALL' ? 'All Entities' : adminCurrentEntity;
      }

      // Update week selector and display to show current week for this entity
      const state = getEntityWeekState(adminCurrentEntity || 'ALL');
      const currentWeek = state.currentWeek || 1;
      const weekDisplay = document.getElementById('admin-week-display');
      const weekSelector = document.getElementById('admin-week-selector');
      if (weekDisplay) weekDisplay.textContent = currentWeek;
      if (weekSelector) weekSelector.value = currentWeek;

      // Display current entity for reviewer dashboard
      const reviewerEntityDisplay = document.getElementById('reviewer-entity-display');
      if (reviewerEntityDisplay && currentSessionUser && currentSessionUser.role === 'reviewer') {
        reviewerEntityDisplay.textContent = adminCurrentEntity === 'ALL' ? 'All Entities' : adminCurrentEntity;
      }

      // Get the selector dropdown for admin
      const adminSelector = document.getElementById('admin-agent-selector');
      const reviewerSelector = document.getElementById('reviewer-agent-selector');

      // Filter agents by entity
      let agents = USER_DB.filter(u => u.role === 'agent');
      if (adminCurrentEntity && adminCurrentEntity !== 'ALL') {
        agents = agents.filter(u => u.entity === adminCurrentEntity);
      }



      // Populate reviewer dropdown
      if (reviewerSelector) {
        reviewerSelector.innerHTML = '<option value="">-- Choose Agent --</option>';
        agents.forEach(agent => {
          const state = getEntityWeekState(adminCurrentEntity || 'ALL');
          const currentWeek = state.currentWeek || 1;
          const completed = state.completedAgents && state.completedAgents[currentWeek] && state.completedAgents[currentWeek][agent.id];
          const option = document.createElement('option');
          option.value = agent.id;
          option.text = `${agent.name} ${agent.id}${completed ? ' ‚úÖ' : ''}`;
          option.title = completed ? `Finalized for Week ${currentWeek}` : '';
          option.dataset.name = agent.name;
          reviewerSelector.appendChild(option);
        });
      }

      // Populate admin dropdown
      if (adminSelector) {
        adminSelector.innerHTML = '<option value="">-- Click to Select Agent --</option>';
        agents.forEach(agent => {
          const state = getEntityWeekState(adminCurrentEntity || 'ALL');
          const currentWeek = state.currentWeek || 1;
          const completed = state.completedAgents && state.completedAgents[currentWeek] && state.completedAgents[currentWeek][agent.id];
          const option = document.createElement('option');
          option.value = agent.id;
          option.text = `${agent.name} ${agent.id}${completed ? ' ‚úÖ' : ''}`;
          option.title = completed ? `Finalized for Week ${currentWeek}` : '';
          option.dataset.name = agent.name;
          adminSelector.appendChild(option);
        });
      }

      // Load reviews for the current entity
      adminLoadReviewsList();

      // Render agent dropdown with inline badges for admin
      renderAdminAgentDropdown();

      // Update week UI and final button state
      checkAndEnableWeekFinalButton();

      // Update Clear Finalizations button label
      updateClearFinalizationsButton();

      // Load Entity Feedback
      renderAdminEntityFeedback();
    }

    function adminSelectAgentFromDropdown(selectElement) {
      const selectedOption = selectElement.options[selectElement.selectedIndex];
      const agentId = selectedOption.value;
      const agentName = selectedOption.dataset.name;

      if (agentId) {
        adminCurrentAgent = agentId;
        adminCurrentAgentName = agentName;

        // Reset any previous inline selection state (inline controls removed)
        adminReviewType = '';

        // Enable/disable the start review button (dropdown users will use modal to pick type)
        const startTopBtn = document.getElementById('admin-start-review-btn');
        const isFinalized = isAgentWeekComplete(adminCurrentEntity || 'ALL', agentId);
        if (isFinalized) {
          startTopBtn.disabled = true;
          startTopBtn.classList.add('opacity-50', 'cursor-not-allowed');
          const stateForTooltip = getEntityWeekState(adminCurrentEntity || 'ALL');
          const cw = stateForTooltip.currentWeek || 1;
          startTopBtn.title = `Finalized for Week ${cw} ‚Äî Clear finalizations to reopen`;
        } else {
          startTopBtn.disabled = false;
          startTopBtn.classList.remove('opacity-50', 'cursor-not-allowed');
          startTopBtn.title = '';
        }

        // Show the submitted reviews section and load reviews for this agent
        document.getElementById('admin-submitted-reviews-section').classList.remove('hidden');
        // Data Management panel removed
        adminLoadReviewsList();
        // updateClearFinalizationsButton removed
      } else {
        adminCurrentAgent = '';

        adminCurrentAgentName = '';
        // Disable the start review button
        document.getElementById('admin-start-review-btn').disabled = true;
        document.getElementById('admin-start-review-btn').classList.add('opacity-50', 'cursor-not-allowed');
        // Hide the submitted reviews section
        document.getElementById('admin-submitted-reviews-section').classList.add('hidden');
        // Data Management panel removed
        adminReviewType = '';
        // updateClearFinalizationsButton removed
      }
    }

    function adminSelectAgent(agentId, agentName) {
      adminCurrentAgent = agentId;
      adminCurrentAgentName = agentName;

      // Show the submitted reviews section when agent is selected
      document.getElementById('admin-submitted-reviews-section').classList.remove('hidden');
      // Data Management panel removed


      // Clear any previous inline selection state
      adminReviewType = '';

      // Enable start button so admin can proceed to Quality Checklist
      document.getElementById('admin-start-review-btn').disabled = false;
      document.getElementById('admin-start-review-btn').classList.remove('opacity-50', 'cursor-not-allowed');

      // Update summary card similar to onAgentSelected but using adminReviews
      const agentListContainer = document.getElementById('admin-agent-list');
      const reviews = JSON.parse(localStorage.getItem('adminReviews') || '[]');
      const agentReviews = reviews.filter(r => String(r.agentId) === String(agentId) && (!adminCurrentEntity || adminCurrentEntity === 'ALL' || r.entity === adminCurrentEntity));
      const reviewStatus = agentReviews.length === 0
        ? 'No reviews submitted'
        : agentReviews.length >= 3
          ? 'Ready for final submission'
          : `${agentReviews.length}/3 reviews completed`;

      // Compute finalization state for this agent to control start button behavior
      const stateForBtn = getEntityWeekState(adminCurrentEntity || 'ALL');
      const currentWeekForBtn = stateForBtn.currentWeek || 1;
      const finalizedForBtn = stateForBtn.completedAgents && stateForBtn.completedAgents[currentWeekForBtn] && stateForBtn.completedAgents[currentWeekForBtn][agentId];
      const topBtnClass = finalizedForBtn ? 'bg-gray-300 text-slate-700 px-4 py-2 rounded-md text-sm font-semibold opacity-50 cursor-not-allowed' : 'bg-blue-600 text-white px-4 py-2 rounded-md text-sm font-semibold';
      const topBtnOnclick = finalizedForBtn ? `alert('Agent finalized for Week ${currentWeekForBtn}. Clear finalization to reopen.');` : 'adminStartQualityReview()';
      const topBtnDisabledAttr = finalizedForBtn ? 'disabled' : '';

      agentListContainer.innerHTML = `
          <div class="bg-white dark:bg-slate-700 p-6 rounded-2xl border border-slate-200 dark:border-slate-600">
            <div class="flex items-center justify-between mb-4">
                <div>
                  <h4 class="font-bold text-slate-700 dark:text-slate-200 text-xl">${agentName}</h4>
                  <p class="text-sm text-slate-500 font-mono">${agentId}</p>
                  <p class="text-xs text-slate-400 mt-1">Entity: ${USER_DB.find(u => String(u.id) === String(agentId))?.entity || ''}</p>
                  <p class="text-xs text-blue-600 mt-1 font-medium">${reviewStatus}</p>
                </div>
                <div class="text-right flex items-center gap-3">
                  <button onclick="adminClearReviewsForAgent('${agentId}')" id="admin-clear-reviews-btn" class="bg-red-100 text-red-700 px-3 py-2 rounded-md text-sm font-semibold border border-red-200 hover:bg-red-200">Clear Reviews</button>
                  <button onclick="${topBtnOnclick}" id="admin-top-start-btn" class="${topBtnClass}" ${topBtnDisabledAttr}>${agentReviews.length >= 3 ? 'Complete Final Submission' : 'Start Quality Review'}</button>
                </div>
            </div>
          </div>
        `;

      // Refresh reviews list for this agent
      adminLoadReviewsList();

      // Update Clear Finalizations button label
      updateClearFinalizationsButton();
    }

    function reviewerSelectAgent(selectElement) {
      const selectedOption = selectElement.options[selectElement.selectedIndex];
      const agentId = selectedOption.value;
      const agentName = selectedOption.dataset.name;

      if (agentId) {
        adminCurrentAgent = agentId;
        adminCurrentAgentName = agentName;
        // Show the reviews section
        document.getElementById('reviewer-reviews-section').classList.remove('hidden');
        // Load reviews for this agent
        reviewerLoadReviewsList();
      } else {
        adminCurrentAgent = '';
        adminCurrentAgentName = '';
        // Hide the reviews section
        document.getElementById('reviewer-reviews-section').classList.add('hidden');
      }
    }

    function adminStartQualityReview() {
      if (!adminCurrentEntity || !adminCurrentAgent) {
        alert('Please select an agent');
        return;
      }
      // Prevent starting reviews on finalized agents
      const state = getEntityWeekState(adminCurrentEntity || 'ALL');
      const currentWeek = state.currentWeek || 1;
      const finalized = state.completedAgents && state.completedAgents[currentWeek] && state.completedAgents[currentWeek][adminCurrentAgent];
      if (finalized) {
        return alert(`Agent finalized for Week ${currentWeek}. Clear finalization to reopen.`);
      }

      // Trigger the new modal
      document.getElementById('admin-review-type-modal').classList.remove('hidden');
      document.getElementById('review-type-agent-name').textContent = adminCurrentAgentName;
    }

    function startQualityReviewWithType(type) {
      console.debug('[startQualityReviewWithType] type=', type, 'adminCurrentAgent=', adminCurrentAgent, 'selectedAgentForReview=', selectedAgentForReview?.id);
      try { document.getElementById('agent-process-modal').classList.add('hidden'); } catch (e) { }

      if (!adminCurrentAgent && selectedAgentForReview) {
        adminCurrentAgent = selectedAgentForReview.id;
        adminCurrentAgentName = selectedAgentForReview.name;
      }

      try { document.getElementById('review-type-agent-name').textContent = adminCurrentAgentName; } catch (e) { }

      // Reuse the existing adminSelectReviewType flow
      adminSelectReviewType(type);
    }

    function adminSelectReviewType(type) {
      // type: 'voice' or 'non-voice'
      console.debug('[adminSelectReviewType] selected type', type, 'for agent', adminCurrentAgentName);
      adminReviewType = type;
      document.getElementById('admin-review-type-modal').classList.add('hidden');

      // Show quality review form
      adminReviewItems = [];
      document.getElementById('admin-review-items-container').innerHTML = '';
      document.getElementById('admin-quality-form-section').classList.remove('hidden');
      document.getElementById('admin-review-agent-display').textContent = adminCurrentAgentName;

      // Add first review item automatically
      adminAddReviewItem();
    }

    function adminCancelReview() {
      document.getElementById('admin-quality-form-section').classList.add('hidden');
      adminReviewItems = [];
      document.getElementById('admin-review-items-container').innerHTML = '';
      document.querySelectorAll('.admin-agent-btn').forEach(btn => {
        btn.classList.remove('border-blue-500', 'bg-blue-100', 'dark:bg-slate-500');
      });
      document.getElementById('admin-start-review-btn').disabled = true;
      document.getElementById('admin-start-review-btn').classList.add('opacity-50', 'cursor-not-allowed');
      adminCurrentAgent = '';
    }

    function adminAddReviewItem() {
      if (adminReviewItems.length >= 10) {
        alert('Maximum 10 reviews allowed per agent');
        return;
      }

      const itemIndex = adminReviewItems.length + 1;
      const container = document.getElementById('admin-review-items-container');

      let itemHtml = `
          <div class="admin-review-item bg-white dark:bg-slate-700 p-6 rounded-xl border border-slate-200 dark:border-slate-600 mb-4">
            <div class="flex items-center justify-between mb-4">
              <h4 class="font-bold text-lg">Review #${itemIndex}</h4>
              ${itemIndex > 1 ? `<button onclick="adminRemoveReviewItem(${itemIndex - 1})" class="text-red-600 hover:text-red-700 text-sm">üóëÔ∏è Remove</button>` : ''}
            </div>

            <!-- Date Selector -->
            <div class="mb-4">
              <label class="block text-sm font-semibold mb-2">Review Date</label>
              <input type="date" class="review-date-input w-full px-4 py-3 rounded-lg border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-700 focus:ring-2 focus:ring-emerald-500 outline-none" 
                data-item-index="${itemIndex - 1}">
            </div>
        `;

      // Show file upload only for voice reviews
      if (adminReviewType === 'voice') {
        itemHtml += `

            <!-- File Upload (Voice) -->
            <div class="mb-4">
              <label class="block text-sm font-semibold mb-2">Select File (Optional, Max 50MB)</label>
              <input type="file" class="review-file-input block w-full text-sm file:mr-4 file:py-2 file:px-4 file:rounded file:border-0 file:text-sm file:font-semibold file:bg-blue-100 file:text-blue-700"
                data-item-index="${itemIndex - 1}" onchange="adminOnFileSelected(${itemIndex - 1})">
              <p class="text-xs text-slate-500 mt-1">Selected: <span class="review-file-name">None</span></p>
            </div>
          `;
      } else {
        // Show single contact input for non-voice reviews (Chat ID or Email ID - only one required)
        itemHtml += `
            <!-- Chat or Email ID (Non-Voice) -->
            <div class="mb-4">
              <label class="block text-sm font-semibold mb-2">Chat ID or Email ID</label>
              <input type="text" class="review-contact-id w-full px-4 py-3 rounded-lg border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-700 focus:ring-2 focus:ring-emerald-500 outline-none" 
                placeholder="Enter Chat ID or Email ID (one required)" data-item-index="${itemIndex - 1}">
            </div>
          `;
      }

      // Observation and Score (Binary)
      itemHtml += `
            <!-- Observation -->
            <div class="mb-4">
              <label class="block text-sm font-semibold mb-2">Observation</label>
              <textarea class="review-observation w-full px-4 py-3 rounded-lg border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-700 focus:ring-2 focus:ring-emerald-500 outline-none" 
                rows="4" placeholder="Enter your observation for this review..." data-item-index="${itemIndex - 1}"></textarea>
            </div>

            <!-- Score (Binary 0 or 100) -->
            <div class="mb-4">
              <label class="block text-sm font-semibold mb-3">Performance Score</label>
              <div class="flex gap-4">
                <label class="flex items-center gap-2 p-3 bg-emerald-50 dark:bg-slate-600 rounded-lg border border-emerald-200 dark:border-slate-500 cursor-pointer flex-1 transition hover:bg-emerald-100">
                  <input type="radio" name="score-${itemIndex - 1}" value="100" class="review-score w-5 h-5 text-emerald-600 focus:ring-emerald-500 border-gray-300" data-item-index="${itemIndex - 1}">
                  <div>
                    <div class="font-bold text-emerald-600">Good (100)</div>
                  </div>
                </label>
                <label class="flex items-center gap-2 p-3 bg-red-50 dark:bg-slate-600 rounded-lg border border-red-200 dark:border-slate-500 cursor-pointer flex-1 transition hover:bg-red-100">
                  <input type="radio" name="score-${itemIndex - 1}" value="0" class="review-score w-5 h-5 text-red-600 focus:ring-red-500 border-gray-300" data-item-index="${itemIndex - 1}">
                  <div>
                    <div class="font-bold text-red-600">Fatal (0)</div>
                  </div>
                </label>
              </div>
            </div>
          </div>
        `;

      container.insertAdjacentHTML('beforeend', itemHtml);
      // Initialize with correct fields structure
      adminReviewItems.push({ file: null, chatId: '', emailId: '', observation: '', score: null, reviewType: adminReviewType });

      // Update button states
      adminUpdateReviewButtons();
    }

    function adminRemoveReviewItem(index) {
      adminReviewItems.splice(index, 1);
      const items = document.querySelectorAll('.admin-review-item');
      if (items[index]) items[index].remove();
      adminUpdateReviewButtons();
    }

    function adminOnFileSelected(index) {
      const fileInput = document.querySelector(`input[data-item-index="${index}"]`);
      const file = fileInput.files[0];

      if (file) {
        if (file.size > 50 * 1024 * 1024) {
          alert('File size exceeds 50MB limit');
          fileInput.value = '';
          return;
        }
        adminReviewItems[index].file = file;
        document.querySelector(`.admin-review-item:nth-child(${index + 1}) .review-file-name`).textContent = file.name;
      }
    }

    function adminUpdateReviewButtons() {
      const count = document.querySelectorAll('.admin-review-item').length; // Use DOM count for accuracy
      const addBtn = document.getElementById('admin-add-review-btn');
      const finalBtn = document.getElementById('admin-final-submit-btn');

      // Add Button: Max 10
      if (count >= 10) {
        addBtn.disabled = true;
        addBtn.classList.add('opacity-50', 'cursor-not-allowed');
        addBtn.innerText = "Max 10 Reviews Reached";
      } else {
        addBtn.disabled = false;
        addBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        addBtn.innerText = "+ Add Another Review";
      }

      // Final Submit Button: Min 3
      if (count >= 3) {
        finalBtn.disabled = false;
        finalBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        finalBtn.innerHTML = `‚úÖ Final Submit (${count} reviews)`;
      } else {
        finalBtn.disabled = true;
        finalBtn.classList.add('opacity-50', 'cursor-not-allowed');
        finalBtn.innerHTML = `Final Submit (Need ${3 - count} more)`;
      }
    }

    async function adminFinalSubmit() {
      // Validate again before submission
      const itemElements = document.querySelectorAll('.admin-review-item');
      if (itemElements.length < 3) {
        alert('Minimum 3 reviews required.');
        return;
      }
      if (itemElements.length > 10) {
        alert('Maximum 10 reviews allowed.');
        return;
      }

      const items = [];
      let missingFields = false;

      itemElements.forEach((item, index) => {
        const observation = item.querySelector('.review-observation').value.trim();
        const scoreInput = item.querySelector('.review-score:checked');
        const score = scoreInput ? parseInt(scoreInput.value) : null;

        let file = null;
        let chatId = '';
        let emailId = '';

        if (adminReviewType === 'voice') {
          const fileInput = item.querySelector('.review-file-input');
          file = fileInput ? fileInput.files[0] : null;
          // file is now optional for voice - no validation error here
        } else {
          // For non-voice, accept either Chat ID or Email ID (one required)
          const contactInput = item.querySelector('.review-contact-id');
          const contactVal = contactInput ? contactInput.value.trim() : '';

          if (contactVal) {
            if (contactVal.includes('@')) {
              emailId = contactVal;
            } else {
              chatId = contactVal;
            }
          } else {
            missingFields = true; // neither provided
          }
        }

        if (!observation || score === null) missingFields = true;

        items.push({
          file: file,
          chatId: chatId,
          emailId: emailId, // Store email ID
          observation: observation,
          score: score,
          reviewType: adminReviewType,
          date: item.querySelector('.review-date-input')?.value || null
        });
      });

      if (missingFields) {
        alert('Please fill all fields (File/IDs, Observation, Score) for all review items.');
        return;
      }

      const submitBtn = document.getElementById('admin-final-submit-btn');
      submitBtn.innerText = 'Submitting...';
      submitBtn.disabled = true;

      try {
        // Process files: keep File blobs and metadata; actual file bytes are saved to IndexedDB (FileDB) to support larger files
        const processedItems = items.map(item => ({ ...item, fileBlob: item.file || null, fileName: item.file ? item.file.name : null }));

        // STORAGE: Save to localStorage
        let reviews = JSON.parse(localStorage.getItem('adminReviews') || '[]');
        const now = new Date();

        // Create review objects and append. We'll save file blobs to FileDB after creating review IDs.
        const createdReviewIds = [];
        for (let idx = 0; idx < processedItems.length; idx++) {
          const item = processedItems[idx];
          const reviewId = Date.now().toString() + '-' + Math.floor(Math.random() * 10000).toString() + '-' + idx;
          createdReviewIds.push(reviewId);
          const reviewObj = {
            id: reviewId,
            date: item.date ? new Date(item.date).toISOString() : now.toISOString(), // Use selected date or current
            displayDate: item.date ? new Date(item.date).toLocaleDateString() : now.toLocaleDateString(), // Keep human readable date for display
            month: item.date ? new Date(item.date).toLocaleString('default', { month: 'long', year: 'numeric' }) : now.toLocaleString('default', { month: 'long', year: 'numeric' }), // store month explicitly
            agentId: String(adminCurrentAgent || '').trim(), // store normalized-ish agent ID (trimmed)
            agentName: adminCurrentAgentName,
            entity: adminCurrentEntity,
            reviewType: item.reviewType,
            score: item.score,
            observation: item.observation,
            expiryDate: new Date((item.date ? new Date(item.date) : now).getTime() + 7 * 24 * 60 * 60 * 1000).toISOString(),
            reviewerId: currentUser?.id || 'admin',
            reviewerName: currentUser?.name || 'Admin',
            // Specific fields
            chatId: item.chatId,
            emailId: item.emailId,
            fileName: item.fileName || null,
            fileStored: false
          };

          reviews.push(reviewObj);

          // If a file blob is present, save it to IndexedDB under the reviewId
          if (item.fileBlob) {
            try {
              if (!FileDB._db) await FileDB.init();
              await FileDB.saveFile(reviewId, item.fileBlob);
              // Mark as stored
              reviews[reviews.length - 1].fileStored = true;
            } catch (err) {
              console.error('Failed to save file for review', reviewId, err);
              // keep fileStored false and notify admin
              alert('Warning: file could not be saved for one of the reviews. The review was submitted without the file.');
            }
          }
        }

        // Persist reviews (with updated fileStored flags)
        localStorage.setItem('adminReviews', JSON.stringify(reviews));
        // Notify other sessions/tabs that reviews changed (timestamp)
        try { localStorage.setItem('adminReviewsUpdatedAt', Date.now().toString()); } catch (e) { console.warn('[adminFinalSubmit] could not set adminReviewsUpdatedAt', e); }

        // If Supabase is configured, attempt to push these newly created reviews
        try {
          if (typeof pushReviewsToSupabase === 'function' && createdReviewIds && createdReviewIds.length) {
            // fire-and-forget, don't block admin submit flow
            pushReviewsToSupabase(createdReviewIds).catch(err => console.warn('[adminFinalSubmit] pushReviewsToSupabase failed', err));
          }
        } catch (err) {
          console.warn('[adminFinalSubmit] could not call pushReviewsToSupabase', err);
        }

        // NOTIFICATION: Add feedback to agent comments
        let comments = JSON.parse(localStorage.getItem('gojira_comments') || '[]');
        const feedbackText = processedItems.map((item, idx) => `Review #${idx + 1} (${item.score}): ${item.observation}`).join('\n\n');

        if (feedbackText) {
          comments.unshift({
            id: Date.now(),
            text: `[${adminReviewType.toUpperCase()}] Weekly Review:\n` + feedbackText,
            agentId: adminCurrentAgent,
            date: new Date().toLocaleString()
          });
          localStorage.setItem('gojira_comments', JSON.stringify(comments));
        }

        // FINALIZE AGENT: Mark Agent as Finalized (Blue Tick)
        // User said: "once the admin will click on the final submit... agent... will be signed as blue tick"
        // This implies instant finalization upon this submission.
        markAgentWeekComplete(adminCurrentEntity || 'ALL', adminCurrentAgent);

        alert(`Successfully submitted ${processedItems.length} reviews for ${adminCurrentAgentName}. Agent finalized.`);

        // Reset UI
        adminCancelReview();
        // Refresh List to show Blue Tick
        adminLoadAgents();

        // Re-open agent dashboard to show the cleared state and updated list
        if (adminCurrentAgent) {
          adminSelectAgent(adminCurrentAgent, adminCurrentAgentName);
        }

      } catch (error) {
        console.error("Error submitting reviews:", error);
        alert("Failed to submit reviews. Please try again.");
      } finally {
        submitBtn.innerText = '‚úÖ Final Submit';
        submitBtn.disabled = false;
      }
    }

    function adminLoadReviewsList() {
      let reviews = JSON.parse(localStorage.getItem('adminReviews') || '[]');
      const tbody = document.getElementById('admin-reviews-list');

      // Remove expired reviews
      const now = new Date();
      // Keep non-expired for immediate display
      let filtered = reviews.filter(r => new Date(r.expiryDate) >= now);

      // Delete expired review files in background to free space
      const expired = reviews.filter(r => new Date(r.expiryDate) < now);
      if (expired.length > 0) {
        (async () => {
          try {
            if (!FileDB._db) await FileDB.init();
            await Promise.all(expired.map(r => r.fileStored ? FileDB.deleteFile(r.id).catch(e => console.warn('[cleanup] deleteFile failed', r.id, e)) : Promise.resolve()));
          } catch (e) {
            console.warn('[cleanup] failed', e);
          }
        })();
      }

      localStorage.setItem('adminReviews', JSON.stringify(filtered));

      // Filter by current entity (admin can only see reviews for their logged-in entity)
      if (adminCurrentEntity && adminCurrentEntity !== 'ALL') {
        filtered = filtered.filter(r => r.entity === adminCurrentEntity);
      }

      // IMPORTANT: Only show reviews for the SELECTED agent
      if (adminCurrentAgent) {
        filtered = filtered.filter(r => r.agentId === adminCurrentAgent);
      } else {
        // If no agent is selected, show no reviews
        filtered = [];
      }

      if (filtered.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="p-6 text-center text-slate-400">No submitted reviews for this agent yet.</td></tr>';
        return;
      }

      tbody.innerHTML = filtered.map((review, idx) => `
          <tr class="hover:bg-slate-50 dark:hover:bg-slate-700/50">
            <td class="p-6">${review.date}</td>
            <td class="p-6">${review.agentName}</td>
            <td class="p-6 text-sm text-blue-600 underline cursor-pointer" onclick="openReviewFile('${review.id}')">${review.fileName || 'N/A'}</td>
            <td class="p-6"><span class="font-bold ${review.score === 100 ? 'text-emerald-600' : 'text-red-600'}">${review.score}</span></td>
            <td class="p-6 text-sm">${review.observation.substring(0, 50)}...</td>
            <td class="p-6 text-right space-x-2">
              <button onclick="adminViewReview(${idx})" class="text-blue-600 hover:text-blue-700">üëÅÔ∏è View</button>
              <button onclick="adminDeleteReview('${review.id}')" class="text-red-600 hover:text-red-700">üóëÔ∏è Delete</button>
            </td>
          </tr>
        `).join('');
    }

    function reviewerLoadReviewsList() {
      let reviews = JSON.parse(localStorage.getItem('adminReviews') || '[]');
      const tbody = document.getElementById('reviewer-reviews-list');

      // Remove expired reviews
      const now = new Date();
      let filtered = reviews.filter(r => new Date(r.expiryDate) >= now);

      // Filter by current entity
      if (adminCurrentEntity && adminCurrentEntity !== 'ALL') {
        filtered = filtered.filter(r => r.entity === adminCurrentEntity);
      }

      // Only show reviews for the SELECTED agent
      if (adminCurrentAgent) {
        filtered = filtered.filter(r => r.agentId === adminCurrentAgent);
      } else {
        filtered = [];
      }

      if (filtered.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="p-6 text-center text-slate-400">No submitted reviews for this agent yet.</td></tr>';
        return;
      }

      tbody.innerHTML = filtered.map((review, idx) => `
          <tr class="hover:bg-slate-50 dark:hover:bg-slate-700/50">
            <td class="p-6">${review.date}</td>
            <td class="p-6">${review.agentName}</td>
            <td class="p-6 text-sm text-blue-600 underline cursor-pointer" onclick="openReviewFile('${review.id}')">${review.fileName || 'N/A'}</td>
            <td class="p-6"><span class="font-bold ${review.score === 100 ? 'text-emerald-600' : 'text-red-600'}">${review.score}</span></td>
            <td class="p-6 text-sm">${review.observation.substring(0, 50)}...</td>
            <td class="p-6 text-right space-x-2">
              <button onclick="reviewerViewReview('${review.id}')" class="text-blue-600 hover:text-blue-700">üëÅÔ∏è View</button>
              <button onclick="reviewerViewComments('${review.id}')" class="text-purple-600 hover:text-purple-700">üí¨ Comments</button>
            </td>
          </tr>
        `).join('');
    }

    function reviewerViewReview(reviewId) {
      const reviews = JSON.parse(localStorage.getItem('adminReviews') || '[]');
      const review = reviews.find(r => r.id === reviewId);
      if (review) {
        const choice = confirm(`File: ${review.fileName}\nAgent: ${review.agentName}\nScore: ${review.score}\nObservation: ${review.observation}\n\nClick OK to open the file.`);
        if (choice) {
          openReviewFile(review.id);
        }
      }
    }

    function reviewerViewComments(reviewId) {
      const comments = JSON.parse(localStorage.getItem('reviewComments') || '[]');
      const reviewComments = comments.filter(c => c.reviewId === reviewId);
      const reviews = JSON.parse(localStorage.getItem('adminReviews') || '[]');
      const review = reviews.find(r => r.id === reviewId);

      if (reviewComments.length === 0) {
        alert('No comments yet for this review.');
      } else {
        let commentsText = `Comments for ${review.agentName}'s review:\n\n`;
        reviewComments.forEach(c => {
          commentsText += `[${c.date}] ${c.authorName}:\n${c.text}\n\n`;
        });
        alert(commentsText);
      }
    }

    function openFileContent(content, name) {
      if (!content) return alert('File content not found.');
      // Open in new window
      const win = window.open();
      if (win) {
        win.document.write(`<iframe src="${content}" frameborder="0" style="border:0; top:0px; left:0px; bottom:0px; right:0px; width:100%; height:100%;" allowfullscreen></iframe>`);
        win.document.title = name;
      } else {
        alert('Please allow popups to view the file.');
      }
    }

    function adminViewReview(index) {
      const reviews = JSON.parse(localStorage.getItem('adminReviews') || '[]');
      const review = reviews[index];
      if (!review) return;

      const modal = document.getElementById('admin-review-detail-modal');

      // Populate fields
      document.getElementById('admin-review-detail-agent').textContent = review.agentName || 'Unknown Agent';
      document.getElementById('admin-review-detail-type').textContent = review.reviewType === 'voice' ? 'üéôÔ∏è Voice Call' : 'üí¨ Chat/Email';
      document.getElementById('admin-review-detail-date').textContent = review.displayDate || review.date;
      document.getElementById('admin-review-detail-score').textContent = review.score;
      document.getElementById('admin-review-detail-observation').textContent = review.observation;

      // File or ID
      if (review.reviewType === 'voice') {
        document.getElementById('admin-review-detail-file-section').classList.remove('hidden');
        document.getElementById('admin-review-detail-id-section').classList.add('hidden');
        document.getElementById('admin-review-detail-file-name').textContent = review.fileName || 'N/A';
        document.getElementById('admin-review-detail-file-link').onclick = () => openReviewFile(review.id);
      } else {
        document.getElementById('admin-review-detail-file-section').classList.add('hidden');
        document.getElementById('admin-review-detail-id-section').classList.remove('hidden');
        const idText = (review.emailId ? 'Email: ' + review.emailId : '') + (review.emailId && review.chatId ? ' | ' : '') + (review.chatId ? 'Chat: ' + review.chatId : '');
        document.getElementById('admin-review-detail-id-value').textContent = idText || 'N/A';
      }

      // Comments
      const comments = JSON.parse(localStorage.getItem('reviewComments') || '[]').filter(c => c.reviewId === review.id);
      const commentsHtml = comments.length === 0 ? '<p class="text-slate-500 italic">No comments yet</p>' : comments.map(c => `
          <div class="bg-slate-100 dark:bg-slate-600 p-3 rounded mb-2 ${c.authorId === (currentUser?.id || 'admin') ? 'ml-8 bg-blue-50 dark:bg-blue-900/20' : 'mr-8'}">
            <div class="flex justify-between items-center mb-1">
              <span class="font-bold text-sm ${c.authorId === (currentUser?.id || 'admin') ? 'text-blue-700 dark:text-blue-300' : 'text-slate-700 dark:text-slate-200'}">${c.authorName || 'User'}</span>
              <span class="text-xs text-slate-400">${c.date}</span>
            </div>
            <div class="text-sm text-slate-800 dark:text-slate-200">${c.text}</div>
          </div>
        `).join('');
      document.getElementById('admin-review-detail-comments').innerHTML = commentsHtml;

      modal.classList.remove('hidden');
    }

    function closeAdminReviewDetailModal() {
      document.getElementById('admin-review-detail-modal').classList.add('hidden');
    }

    let currentEditIndex = -1;

    function adminEditReview(index) {
      currentEditIndex = index;
      const reviews = JSON.parse(localStorage.getItem('adminReviews') || '[]');
      const review = reviews[index];

      // Populate Modal
      document.getElementById('edit-observation').value = review.observation;
      document.getElementById('edit-current-filename').innerText = review.fileName || 'None';

      // Set Radio
      const radios = document.getElementsByName('edit-score');
      radios.forEach(r => {
        // Reset first
        r.checked = false;
        if (parseInt(r.value) === review.score) r.checked = true;
      });

      // Clear file input
      document.getElementById('edit-file-upload').value = '';

      // Show Modal
      document.getElementById('admin-edit-review-modal').classList.remove('hidden');
    }

    async function adminSaveEdit() {
      if (currentEditIndex === -1) return;

      const reviews = JSON.parse(localStorage.getItem('adminReviews') || '[]');
      const review = reviews[currentEditIndex];

      // Get Values
      const obs = document.getElementById('edit-observation').value;
      const scoreEl = document.querySelector('input[name="edit-score"]:checked');
      if (!scoreEl) return alert('Please select a score');
      const score = parseInt(scoreEl.value);

      // Handle File
      const fileInput = document.getElementById('edit-file-upload');

      const saveBtn = document.getElementById('btn-save-edit');
      saveBtn.innerText = 'Saving...';
      saveBtn.disabled = true;

      try {
        if (fileInput.files.length > 0) {
          const file = fileInput.files[0];
          try {
            if (!FileDB._db) await FileDB.init();
            // Remove any previously stored file for this review to avoid orphaned blobs
            if (review.fileStored) {
              try { await FileDB.deleteFile(review.id); } catch (e) { console.warn('Failed to delete old file for review', review.id, e); }
            }
            await FileDB.saveFile(review.id, file);
            review.fileName = file.name;
            review.fileStored = true;
          } catch (err) {
            console.error('Failed saving edited file', err);
            alert('Failed to save file. Review updated without replacing the file.');
          }
        }

        review.observation = obs;
        review.score = score;

        // Save
        reviews[currentEditIndex] = review;
        localStorage.setItem('adminReviews', JSON.stringify(reviews));

        // If Supabase is configured, push the edited review
        try {
          if (typeof pushReviewsToSupabase === 'function') {
            pushReviewsToSupabase([review.id]).catch(err => console.warn('[adminSaveEdit] pushReviewsToSupabase failed', err));
          }
        } catch (err) {
          console.warn('[adminSaveEdit] could not call pushReviewsToSupabase', err);
        }

        // Refresh & Close
        adminLoadReviewsList();
        document.getElementById('admin-edit-review-modal').classList.add('hidden');
        alert('Review updated successfully!');
      } catch (err) {
        console.error(err);
        alert('Error saving edit');
      } finally {
        saveBtn.innerText = 'Save Changes';
        saveBtn.disabled = false;
      }
    }

    async function adminDeleteReview(reviewId) {
      if (confirm('Delete this review?')) {
        let reviews = JSON.parse(localStorage.getItem('adminReviews') || '[]');
        const index = reviews.findIndex(r => r.id === reviewId);
        if (index === -1) return;

        const review = reviews[index];
        const agentId = review ? review.agentId : null;

        // If file is stored in FileDB, remove it (non-blocking)
        if (review && review.fileStored) {
          (async () => {
            try {
              if (!FileDB._db) await FileDB.init();
              await FileDB.deleteFile(review.id);
            } catch (e) { console.warn('[adminDeleteReview] failed to delete associated file', e); }
          })();
        }

        reviews.splice(index, 1);
        localStorage.setItem('adminReviews', JSON.stringify(reviews));

        // Supabase Deletion Sync (non-blocking)
        if (review && review.id) {
          if (typeof syncReviewDeletionToSupabase === 'function') {
            syncReviewDeletionToSupabase(review.id).catch(e => console.warn('Supabase delete failed', e));
          }
        }

        // If this deletion caused the agent to fall below threshold, unmark completion
        if (agentId) {
          const remaining = reviews.filter(r => String(r.agentId) === String(agentId)).length;
          if (remaining < 3) {
            unmarkAgentWeekComplete('ALL', agentId);
            reconcileFinalizeFlags();
            renderAdminAgentDropdown();
            checkAndEnableWeekFinalButton();
            if (adminCurrentAgent && String(adminCurrentAgent) === String(agentId)) {
              // Soft refresh without full reset
              try {
                const btn = document.getElementById('admin-top-start-btn');
                if (btn) {
                  btn.disabled = false;
                  btn.classList.remove('opacity-50', 'cursor-not-allowed');
                  btn.innerHTML = 'Start Quality Review';
                  btn.title = '';
                  btn.onclick = () => adminStartQualityReview();
                }
              } catch (e) { }
            }
            // Use toast instead of blocking alert for speed
            const toast = document.createElement('div');
            toast.className = 'fixed bottom-4 right-4 bg-amber-600 text-white px-4 py-2 rounded-lg shadow-lg z-[100] animate-fade-in';
            toast.innerText = `Agent reviews dropped to ${remaining}. Finalization removed.`;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
          }
        }

        adminLoadReviewsList();
      }
    }

    async function adminDeleteAllReviews() {
      if (confirm('Delete all reviews for this entity? This action cannot be undone.')) {
        let reviews = JSON.parse(localStorage.getItem('adminReviews') || '[]');

        // Find reviews to remove for this entity
        const toRemove = reviews.filter(r => r.entity === adminCurrentEntity);

        // Delete associated files from FileDB when present
        try {
          if (!FileDB._db) await FileDB.init();
          await Promise.all(toRemove.map(r => {
            if (r.fileStored) return FileDB.deleteFile(r.id).catch(e => console.warn('[adminDeleteAllReviews] deleteFile failed', r.id, e));
            return Promise.resolve();
          }));
        } catch (e) {
          console.warn('[adminDeleteAllReviews] file deletion loop failed', e);
        }

        // Determine which agents had reviews removed for this entity
        const removedAgents = new Set(toRemove.map(r => r.agentId));

        // Remove only reviews for the current entity
        reviews = reviews.filter(r => r.entity !== adminCurrentEntity);

        localStorage.setItem('adminReviews', JSON.stringify(reviews));

        // Sync deletions to Supabase for each deleted review
        for (const review of toRemove) {
          if (review && review.id) {
            if (typeof syncReviewDeletionToSupabase === 'function') {
              syncReviewDeletionToSupabase(review.id).catch(e => console.warn('[adminDeleteAllReviews] Supabase delete failed', review.id, e));
            }
          }
        }

        // Attempt to remove matching docs/files from Firebase (non-blocking)
        try {
          (async () => {
            try {
              if (!isFirebaseReady) await initFirebase();
              if (isFirebaseReady && firebaseFirestore) {
                await Promise.all(toRemove.map(r => {
                  try {
                    firebaseFirestore.collection('reviews').doc(r.id).delete().catch(e => console.warn('[adminDeleteAllReviews] firebase delete failed', r.id, e));
                  } catch (e) { console.warn('[adminDeleteAllReviews] delete doc loop', e); }
                  if (r.fileUrl && firebaseStorage) {
                    try {
                      const ref = firebaseStorage.refFromURL(r.fileUrl);
                      ref.delete().catch(e => console.warn('[adminDeleteAllReviews] firebase storage delete failed', r.id, e));
                    } catch (e) { console.warn('[adminDeleteAllReviews] storage ref creation failed', e); }
                  }
                  return Promise.resolve();
                }));
              }
            } catch (e) {
              console.warn('[adminDeleteAllReviews] initFirebase or batch delete failed', e);
            }
          })();
        } catch (e) {
          console.warn('[adminDeleteAllReviews] could not trigger firebase deletes', e);
        }

        // For each removed agent, if they now have 0 global reviews, unmark finalization
        removedAgents.forEach(agentId => {
          const remaining = reviews.filter(r => String(r.agentId) === String(agentId)).length;
          if (remaining === 0) {
            unmarkAgentWeekComplete('ALL', agentId);
          }
        });

        // Reconcile across all entities to handle edge cases where flags may remain
        reconcileFinalizeFlags();

        // Refresh UI
        renderAdminAgentDropdown();
        checkAndEnableWeekFinalButton();
        adminLoadReviewsList();

        alert('All reviews for this entity have been deleted. Finalization flags were cleared where applicable.');
      }
    }

    // ----- Confirm modal & undo flow for clearing finalizations -----
    let _pendingFinalizationClearBuffer = null; // stores pending buffer id and expiry in localStorage

    // adminClearFinalizations logic removed


    function undoClearFinalizations(bufferId) {
      const buf = JSON.parse(localStorage.getItem('finalizationUndoBuffer') || 'null');
      if (!buf || buf.id !== bufferId) return alert('Nothing to undo.');

      // Restore backups
      Object.keys(buf.backups || {}).forEach(key => {
        localStorage.setItem(key, buf.backups[key]);
      });

      // Reconcile and refresh UI
      reconcileFinalizeFlags();
      renderAdminAgentDropdown();
      checkAndEnableWeekFinalButton();
      adminLoadReviewsList();
      // Refresh selected agent card if present
      if (adminCurrentAgent) {
        try { adminSelectAgent(adminCurrentAgent, adminCurrentAgentName); } catch (e) { /* ignore */ }
      }

      // Audit undo
      const history = JSON.parse(localStorage.getItem('finalizationClearHistory') || '[]');
      history.unshift({ id: `undo_${bufferId}`, actor: (currentUser?.name || currentSessionUser?.name || 'admin'), entity: buf.entity, agents: buf.agents, action: 'undo', timestamp: new Date().toISOString() });
      localStorage.setItem('finalizationClearHistory', JSON.stringify(history));

      // Remove undo buffer
      localStorage.removeItem('finalizationUndoBuffer');
      dismissFinalizationUndoToast();

      alert('Undo complete. Finalization flags restored.');
    }

    function dismissFinalizationUndoToast() {
      const toast = document.getElementById('finalization-undo-toast');
      if (toast) toast.classList.add('hidden');
    }

    async function adminDeleteAgentWeekData() {
      if (!adminCurrentAgent) return alert('No agent selected.');
      if (!confirm(`Are you sure you want to DELETE all reviews for ${adminCurrentAgentName} in the current week? This will also un-finalize the week for this agent.`)) return;

      // Unmark completion
      unmarkAgentWeekComplete(adminCurrentEntity || 'ALL', adminCurrentAgent);

      let reviews = JSON.parse(localStorage.getItem('adminReviews') || '[]');
      const now = new Date();
      // Keep reviews that belong to OTHER agents OR belong to this agent but are EXPIRED (old history)
      const reviewsToDelete = reviews.filter(r => {
        if (r.agentId !== adminCurrentAgent) return false; // Don't delete other agents
        if (new Date(r.expiryDate) < now) return false; // Don't delete old history
        return true; // DELETE active reviews for this agent
      });

      const newReviews = reviews.filter(r => {
        if (r.agentId !== adminCurrentAgent) return true; // Keep other agents
        if (new Date(r.expiryDate) < now) return true; // Keep old history
        return false; // DELETE active reviews for this agent
      });

      localStorage.setItem('adminReviews', JSON.stringify(newReviews));

      // Sync deletions to Supabase for each deleted review
      for (const review of reviewsToDelete) {
        if (review && review.id) {
          if (typeof syncReviewDeletionToSupabase === 'function') {
            syncReviewDeletionToSupabase(review.id).catch(e => console.warn('Supabase delete failed for review', review.id, e));
          }
        }
        // Delete associated file if stored
        if (review && review.fileStored) {
          (async () => {
            try {
              if (!FileDB._db) await FileDB.init();
              await FileDB.deleteFile(review.id);
            } catch (e) { console.warn('[adminDeleteAgentWeekData] failed to delete file', review.id, e); }
          })();
        }
      }

      alert(`Current week data deleted for ${adminCurrentAgentName}.`);

      // Refresh
      adminLoadAgents();
      if (adminCurrentAgent) adminSelectAgent(adminCurrentAgent, adminCurrentAgentName);
    }

    function adminResetAgentMonthlyData() {
      if (!adminCurrentAgent) return alert('No agent selected.');
      if (!confirm(`Are you sure you want to RESET monthly performance data for ${adminCurrentAgentName}? This cannot be undone.`)) return;

      localStorage.removeItem(`agentMonthlyData_${adminCurrentAgent}`);
      alert('Monthly data reset.');

      // Force re-calculation if needed by clearing the cached object in memory if any
      // Since agentLoadMonthlyPerformance reads from localStorage every time, this is sufficient.
    }

    function adminDeleteAllReports() {
      if (confirm('Delete all reports? This action cannot be undone.')) {
        MockBackend.clearAllReports();
        renderAdminDashboard();
        alert('All reports have been deleted.');
      }
    }

    function adminDeleteAllFeedback() {
      if (confirm('Delete all feedback? This action cannot be undone.')) {
        // Clear unified comment storage
        if (typeof MockBackend !== 'undefined' && MockBackend.clearComments) {
          MockBackend.clearComments();
        } else {
          localStorage.removeItem('gojira_comments');
        }
        adminLoadFeedbackList();
      }
    }

    function adminLoadFeedbackList() {
      const comments = (typeof MockBackend !== 'undefined' && MockBackend.getComments) ? MockBackend.getComments() : [];
      const tbody = document.getElementById('admin-feedback-list');

      if (!tbody) {
        console.warn("Feedback list element 'admin-feedback-list' not found.");
        return;
      }

      if (comments.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="p-6 text-center text-slate-400">No agent replies yet.</td></tr>';
        return;
      }

      // Map agent ids to names & entities
      const agents = (typeof USER_DB !== 'undefined') ? USER_DB.filter(u => u.role === 'agent') : [];

      tbody.innerHTML = comments.map((comment) => {
        const ag = agents.find(a => String(a.id) === String(comment.agentId));
        const agentName = ag ? ag.name : comment.agentId;
        const entity = comment.entity || (ag ? ag.entity : 'Unknown');
        return `
          <tr>
            <td class="p-6">${comment.date}</td>
            <td class="p-6">${agentName}</td>
            <td class="p-6">${entity}</td>
            <td class="p-6">${comment.text.substring(0, 80)}...</td>
            <td class="p-6 text-right">
              <button onclick="adminDeleteCommentById(${comment.id})" class="text-red-600 hover:text-red-700">üóëÔ∏è Delete</button>
            </td>
          </tr>
        `;
      }).join('');
    }

    function adminDeleteCommentById(id) {
      if (!confirm('Delete this comment?')) return;
      if (typeof MockBackend !== 'undefined' && MockBackend.deleteComment) {
        MockBackend.deleteComment(id);
        adminLoadFeedbackList();
      }
    }

    // ===== NEW AGENT DASHBOARD FUNCTIONS =====
    function openAgentPerformanceModal() {
      const modal = document.getElementById('agent-performance-modal');
      const agentId = currentUser.id;

      document.getElementById('modal-agent-id').textContent = `ID: ${agentId}`;

      // Load reviews for this agent
      const reviews = JSON.parse(localStorage.getItem('adminReviews') || '[]');
      const agentReviews = reviews.filter(r => r.agentId === agentId);

      if (agentReviews.length === 0) {
        document.getElementById('perf-content-loaded').classList.add('hidden');
        document.getElementById('perf-content-empty').classList.remove('hidden');
        modal.classList.remove('hidden');
        return;
      }

      // Calculate stats
      const totalAudits = agentReviews.length;
      const fatalCount = agentReviews.filter(r => r.score === 0).length;
      const goodCount = agentReviews.filter(r => r.score === 100).length;
      const totalScore = (goodCount * 100) / totalAudits;

      // Display stats
      document.getElementById('modal-audit-count').textContent = totalAudits;
      document.getElementById('modal-fatal-count').textContent = fatalCount;
      document.getElementById('modal-good-count').textContent = goodCount;
      document.getElementById('modal-total-score').textContent = totalScore.toFixed(0);

      // Display reviews
      const reviewsList = document.getElementById('modal-reviews-list');
      reviewsList.innerHTML = agentReviews.map((review, idx) => `
          <div class="bg-slate-50 dark:bg-slate-700 p-4 rounded-lg border border-slate-200 dark:border-slate-600">
            <div class="flex justify-between items-start mb-2">
              <div>
                <p class="font-bold text-sm">Review #${idx + 1}</p>
                <p class="text-xs text-slate-500">${review.date}</p>
              </div>
              <span class="font-bold ${review.score === 100 ? 'text-emerald-600 text-lg' : 'text-red-600 text-lg'}">Score: ${review.score}</span>
            </div>
            <p class="text-sm mb-2"><strong>File:</strong> ${review.fileName}</p>
            <p class="text-sm mb-2"><strong>Observation:</strong> ${review.observation}</p>
            <button onclick="agentViewReviewDetail(${idx})" class="text-blue-600 hover:text-blue-700 text-sm">üëÅÔ∏è View Details</button>
          </div>
        `).join('');

      document.getElementById('perf-content-loaded').classList.remove('hidden');
      document.getElementById('perf-content-empty').classList.add('hidden');
      modal.classList.remove('hidden');
    }

    function agentViewReviewDetail(index) {
      const reviews = JSON.parse(localStorage.getItem('adminReviews') || '[]');
      const agentId = currentUser.id;
      const agentReviews = reviews.filter(r => r.agentId === agentId);
      const review = agentReviews[index];

      const choice = confirm(`üìã Review Detail\n\nFile: ${review.fileName}\nScore: ${review.score}\nObservation:\n${review.observation}\n\nClick OK to OPEN THE FILE.`);
      if (choice) {
        openReviewFile(review.id);
      }
    }

    function agentSubmitComment() {
      const textarea = document.getElementById('agent-comment-input');
      const comment = textarea.value.trim();

      if (!comment) {
        alert('Please enter a comment');
        return;
      }

      // Use unified MockBackend
      MockBackend.addComment(comment, currentUser.id);

      textarea.value = '';
      alert('Your feedback has been sent to admin!');
    }

    function closeAgentPerformanceModal() {
      document.getElementById('agent-performance-modal').classList.add('hidden');
      document.getElementById('agent-comment-input').value = '';
    }

    // Review Detail Modal for Agents
    function openReviewDetail(reviewId) {
      const reviews = JSON.parse(localStorage.getItem('adminReviews') || '[]');
      const review = reviews.find(r => r.id === reviewId);
      if (!review) return;

      const modal = document.getElementById('agent-review-detail-modal');
      document.getElementById('review-detail-type').textContent = review.reviewType === 'voice' ? 'üéôÔ∏è Voice Call' : 'üí¨ Chat/Email';

      if (review.reviewType === 'voice') {
        document.getElementById('review-detail-file-section').classList.remove('hidden');
        document.getElementById('review-detail-id-section').classList.add('hidden');
        document.getElementById('review-detail-file-name').textContent = review.fileName || 'N/A';
        document.getElementById('review-detail-file-link').onclick = () => openReviewFile(review.id);
      } else {
        document.getElementById('review-detail-file-section').classList.add('hidden');
        document.getElementById('review-detail-id-section').classList.remove('hidden');
        document.getElementById('review-detail-id-value').textContent = review.chatId || 'N/A';
      }

      document.getElementById('review-detail-date').textContent = review.date;
      document.getElementById('review-detail-observation').textContent = review.observation;
      document.getElementById('review-detail-score').textContent = review.score;

      // Show reviewer/quality team
      if (!document.getElementById('review-detail-reviewer')) {
        const reviewerRow = document.createElement('div');
        reviewerRow.className = 'text-sm text-slate-500 mb-2';
        reviewerRow.id = 'review-detail-reviewer';
        reviewerRow.innerHTML = `<strong>Reviewed by:</strong> ${review.reviewerName || 'Quality Team'}`;
        const container = document.querySelector('#agent-review-detail-modal .p-6');
        if (container) container.insertBefore(reviewerRow, container.firstChild);
      } else {
        document.getElementById('review-detail-reviewer').innerHTML = `<strong>Reviewed by:</strong> ${review.reviewerName || 'Quality Team'}`;
      }

      // Load comments for this review
      const allComments = JSON.parse(localStorage.getItem('reviewComments') || '[]');
      const comments = allComments.filter(c => c.reviewId === reviewId);
      const commentsHtml = comments.length === 0 ? '<p class="text-slate-500 italic">No replies yet</p>' : comments.map(c => `
          <div class="bg-slate-100 dark:bg-slate-600 p-3 rounded mb-2">
            <div class="font-semibold text-sm">${c.authorName || 'Agent'}</div>
            <div class="text-xs text-slate-500">${c.date}</div>
            <div class="text-sm mt-1">${c.text}</div>
          </div>
        `).join('');
      document.getElementById('review-detail-comments').innerHTML = commentsHtml;

      // Check if agent has already replied
      const replyInput = document.getElementById('review-detail-reply-input');
      const replyBtn = document.getElementById('review-detail-reply-btn');

      const hasReplied = comments.some(c => c.authorId === (currentUser.id || currentSessionUser.id));

      if (hasReplied && (currentUser.role === 'agent')) {
        replyInput.disabled = true;
        replyInput.placeholder = "You have already replied to this review.";
        replyBtn.disabled = true;
        replyBtn.innerHTML = "Reply Sent ‚úÖ";
        replyBtn.classList.add('opacity-50', 'cursor-not-allowed');
      } else {
        replyInput.disabled = false;
        replyInput.placeholder = "Write your reply...";
        replyBtn.disabled = false;
        replyBtn.innerHTML = "üì§ Send Reply";
        replyBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        // Set reply handler
        replyBtn.onclick = () => agentReplyFromModal(reviewId);
      }

      document.getElementById('agent-review-detail-modal').classList.remove('hidden');
    }

    function agentReplyFromModal(reviewId) {
      const allComments = JSON.parse(localStorage.getItem('reviewComments') || '[]');
      const alreadyReplied = allComments.some(c => c.reviewId === reviewId && c.authorId === (currentUser.id || currentSessionUser.id));

      if (alreadyReplied && (currentUser.role === 'agent')) {
        alert('You have already replied to this review.');
        return;
      }

      const textarea = document.getElementById('review-detail-reply-input');
      const text = textarea.value.trim();
      if (!text) return alert('Please write a reply first.');

      const comments = JSON.parse(localStorage.getItem('reviewComments') || '[]');
      comments.unshift({
        id: Date.now().toString() + '-' + Math.floor(Math.random() * 1000).toString(),
        reviewId: reviewId,
        authorId: currentSessionUser?.id || currentUser?.id || 'agent',
        authorName: currentSessionUser?.name || currentUser?.name || 'Agent',
        text: text,
        date: new Date().toLocaleString()
      });
      const newComment = comments[0];
      localStorage.setItem('reviewComments', JSON.stringify(comments));
      // Push to Firebase
      pushCommentsToFirebase(newComment);
      textarea.value = '';
      alert('Reply submitted!');
      openReviewDetail(reviewId); // Refresh modal
      agentLoadQADashboard(); // Refresh dashboard
      // Notify admin of new reply
      if (document.querySelector('.notification-dot')) {
        document.querySelector('.notification-dot').classList.remove('hidden');
      }
    }

    function closeReviewDetailModal() {
      const modal = document.getElementById('agent-review-detail-modal');
      if (modal) {
        modal.classList.add('hidden');
      }
    }

    // Tab Switching Function
    function agentSwitchTab(tab) {
      const weeklyContent = document.getElementById('tab-content-weekly');
      const monthlyContent = document.getElementById('tab-content-monthly');
      const weeklyBtn = document.getElementById('tab-weekly');
      const monthlyBtn = document.getElementById('tab-monthly');

      if (tab === 'weekly') {
        weeklyContent.classList.remove('hidden');
        monthlyContent.classList.add('hidden');
        weeklyBtn.classList.add('text-purple-600', 'border-purple-600');
        weeklyBtn.classList.remove('text-slate-500', 'border-transparent');
        monthlyBtn.classList.add('text-slate-500', 'border-transparent');
        monthlyBtn.classList.remove('text-purple-600', 'border-purple-600');
      } else {
        weeklyContent.classList.add('hidden');
        monthlyContent.classList.remove('hidden');
        monthlyBtn.classList.add('text-green-600', 'border-green-600');
        monthlyBtn.classList.remove('text-slate-500', 'border-transparent');
        weeklyBtn.classList.add('text-slate-500', 'border-transparent');
        weeklyBtn.classList.remove('text-green-600', 'border-green-600');
        agentLoadMonthlyPerformance();
      }
    }

    // Monthly Performance Calculation
    // Monthly Performance Calculation
    function agentLoadMonthlyPerformance() {
      if (!currentSessionUser || currentSessionUser.role !== 'agent') return;

      const agentId = currentSessionUser.id;

      // Get or initialize monthly data storage
      let monthlyData = JSON.parse(localStorage.getItem(`agentMonthlyData_${agentId}`) || '{}');
      const now = new Date();

      // If no data exists or month has passed, initialize new month
      if (!monthlyData.startDate) {
        monthlyData = {
          startDate: now.getTime(),
          weeks: [
            { weekNumber: 1, audits: 0, avgScore: 0, fatalCount: 0 },
            { weekNumber: 2, audits: 0, avgScore: 0, fatalCount: 0 },
            { weekNumber: 3, audits: 0, avgScore: 0, fatalCount: 0 },
            { weekNumber: 4, audits: 0, avgScore: 0, fatalCount: 0 }
          ]
        };
      } else {
        // Check if 28 days have passed since month started
        const monthStartTime = new Date(monthlyData.startDate);
        const daysPassed = (now - monthStartTime) / (1000 * 60 * 60 * 24);

        if (daysPassed >= 28) {
          // Reset the month - start new cycle
          monthlyData = {
            startDate: now.getTime(),
            weeks: [
              { weekNumber: 1, audits: 0, avgScore: 0, fatalCount: 0 },
              { weekNumber: 2, audits: 0, avgScore: 0, fatalCount: 0 },
              { weekNumber: 3, audits: 0, avgScore: 0, fatalCount: 0 },
              { weekNumber: 4, audits: 0, avgScore: 0, fatalCount: 0 }
            ]
          };
        }
      }

      // Calculate which week we're in based on days elapsed
      const monthStartTime = new Date(monthlyData.startDate);
      const daysPassed = (now - monthStartTime) / (1000 * 60 * 60 * 24);
      const currentWeekNumber = Math.floor(daysPassed / 7) + 1;

      // Get current week reviews
      let reviews = JSON.parse(localStorage.getItem('adminReviews') || '[]');
      const agentReviews = reviews.filter(r => r.agentId === agentId);

      const fourWeeksAgo = new Date(now.getTime() - 28 * 24 * 60 * 60 * 1000);
      const monthlyReviews = agentReviews.filter(r => {
        const reviewDate = new Date(r.date);
        return reviewDate >= fourWeeksAgo && reviewDate <= now;
      });

      // Update current week data with latest reviews
      if (monthlyData.weeks[currentWeekNumber - 1]) {
        const weekStart = new Date(monthStartTime.getTime() + (currentWeekNumber - 1) * 7 * 24 * 60 * 60 * 1000);
        const weekEnd = new Date(weekStart.getTime() + 7 * 24 * 60 * 60 * 1000);

        const weekReviews = monthlyReviews.filter(r => {
          const reviewDate = new Date(r.date);
          return reviewDate >= weekStart && reviewDate < weekEnd;
        });

        const weekAudits = weekReviews.length;
        const weekScore = weekAudits > 0 ? Math.round((weekReviews.reduce((sum, r) => sum + r.score, 0) / weekAudits / 100) * 100) : 0;
        const weekFatals = weekReviews.filter(r => r.score === 0).length;

        monthlyData.weeks[currentWeekNumber - 1] = {
          weekNumber: currentWeekNumber,
          audits: weekAudits,
          avgScore: weekScore,
          fatalCount: weekFatals
        };
      }

      // Save updated data
      localStorage.setItem(`agentMonthlyData_${agentId}`, JSON.stringify(monthlyData));

      // Check if we have data to display
      const totalData = monthlyData.weeks.reduce((sum, w) => sum + w.audits, 0);
      const hasEnoughData = totalData > 0;

      document.getElementById('agent-no-monthly-data').classList.toggle('hidden', hasEnoughData);

      if (hasEnoughData) {
        // Calculate overall stats from stored weeks
        const totalAudits = monthlyData.weeks.reduce((sum, w) => sum + w.audits, 0);
        const totalScore = monthlyData.weeks.reduce((sum, w) => sum + (w.audits > 0 ? w.avgScore * w.audits : 0), 0);
        const avgScore = totalAudits > 0 ? Math.round(totalScore / totalAudits) : 0;
        const fatalCount = monthlyData.weeks.reduce((sum, w) => sum + w.fatalCount, 0);

        let status = 'Excellent';
        if (avgScore >= 80) status = 'Excellent';
        else if (avgScore >= 60) status = 'Good';
        else if (avgScore >= 40) status = 'Need Improvement';
        else status = 'Critical';

        document.getElementById('agent-monthly-total-audits').textContent = totalAudits;
        document.getElementById('agent-monthly-avg-score').textContent = avgScore + '%';
        document.getElementById('agent-monthly-fatal-count').textContent = fatalCount;
        document.getElementById('agent-monthly-status').textContent = status;

        // Display stored weekly data
        monthlyData.weeks.forEach((week) => {
          document.getElementById(`agent-monthly-week${week.weekNumber}-audits`).textContent = week.audits;
          document.getElementById(`agent-monthly-week${week.weekNumber}-score`).textContent = week.avgScore + '%';
          document.getElementById(`agent-monthly-week${week.weekNumber}-fatals`).textContent = week.fatalCount;
        });
      } else {
        // No data yet - show dashes
        document.getElementById('agent-monthly-total-audits').textContent = '--';
        document.getElementById('agent-monthly-avg-score').textContent = '--';
        document.getElementById('agent-monthly-fatal-count').textContent = '--';
        document.getElementById('agent-monthly-status').textContent = '----';

        // Clear weekly breakdown
        for (let week = 1; week <= 4; week++) {
          document.getElementById(`agent-monthly-week${week}-audits`).textContent = '--';
          document.getElementById(`agent-monthly-week${week}-score`).textContent = '--';
          document.getElementById(`agent-monthly-week${week}-fatals`).textContent = '--';
        }
      }
    }

    // ===== ADMIN WEEKLY DASHBOARD FUNCTIONS (NEW) =====
    function adminLoadWeeklyDashboard() {
      // Navigate to view
      navigateTo('view-admin-weekly');

      // Load data
      renderAdminWeeklyPerformance();
    }

    // ===== ADMIN MONTHLY DASHBOARD FUNCTIONS =====
    function adminLoadMonthlyDashboard() {
      // Navigate to view
      navigateTo('view-admin-monthly');

      const entity = adminCurrentEntity || 'ALL';
      document.getElementById('admin-monthly-entity-display').textContent = entity;

      const tbody = document.getElementById('admin-monthly-table-body');
      tbody.innerHTML = '<tr><td colspan="6" class="p-6 text-center text-slate-400 italic">Loading performance data...</td></tr>';

      // 1. Get Agents
      let agents = USER_DB.filter(u => u.role === 'agent');
      if (entity !== 'ALL') {
        agents = agents.filter(u => u.entity === entity);
      }

      // 2. Get Reviews & Date Range
      const reviews = JSON.parse(localStorage.getItem('adminReviews') || '[]');
      const now = new Date();
      const thirtyDaysAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);

      // 3. Process Data
      const rows = agents.map(agent => {
        // Filter reviews for this agent within 30 days
        const agentId = String(agent.id).trim().toLowerCase();

        const agentReviews = reviews.filter(r => {
          const rAgentId = String(r.agentId).trim().toLowerCase();
          if (rAgentId !== agentId) return false;

          // Date check
          const d = new Date(r.date);
          if (isNaN(d.getTime())) return false; // skip invalid dates
          return d >= thirtyDaysAgo && d <= now;
        });

        const totalAudits = agentReviews.length;
        const avgScore = totalAudits > 0 ? Math.round(agentReviews.reduce((sum, r) => sum + r.score, 0) / totalAudits) : 0;
        const fatalCount = agentReviews.filter(r => r.score === 0).length;

        // Performace Status
        let status = 'Pending';
        let statusClass = 'bg-slate-100 text-slate-600';

        if (totalAudits > 0) {
          if (avgScore >= 80) { status = 'Excellent'; statusClass = 'bg-emerald-100 text-emerald-700'; }
          else if (avgScore >= 60) { status = 'Good'; statusClass = 'bg-blue-100 text-blue-700'; }
          else if (avgScore >= 40) { status = 'Need Improvement'; statusClass = 'bg-amber-100 text-amber-700'; }
          else { status = 'Critical'; statusClass = 'bg-red-100 text-red-700'; }
        }

        return {
          name: agent.name,
          id: agent.id,
          audits: totalAudits,
          fatals: fatalCount,
          score: avgScore,
          status: status,
          statusClass: statusClass
        };
      });

      // 4. Render
      if (rows.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="p-6 text-center text-slate-400 italic">No agents found for this entity.</td></tr>';
        return;
      }

      // Sort by score desc
      rows.sort((a, b) => b.score - a.score);

      tbody.innerHTML = rows.map((row, index) => {
        // Blank logic for empty audits
        const showAudits = row.audits === 0 ? '--' : row.audits;
        const showFatals = row.audits === 0 ? '--' : row.fatals;
        const showScore = row.audits === 0 ? '--' : row.score + '%';
        const showStatus = row.audits === 0 ? '<span class="text-slate-400">--</span>' : `<span class="px-3 py-1 rounded-full text-xs font-bold uppercase ${row.statusClass}">${row.status}</span>`;
        const scoreClass = row.audits === 0 ? '' : (row.score >= 80 ? 'text-emerald-600 bg-emerald-50' : row.score < 50 ? 'text-red-600 bg-red-50' : 'text-blue-600 bg-blue-50');

        return `
          <tr class="hover:bg-indigo-50/30 dark:hover:bg-slate-700/30 transition">
            <td class="p-6 text-center font-bold text-slate-400">${index + 1}</td>
            <td class="p-6">
                <div class="font-bold text-slate-800 dark:text-slate-200">${row.name}</div>
                <div class="text-xs text-slate-500 font-mono">${row.id}</div>
            </td>
            <td class="p-6 text-center font-bold text-slate-700 dark:text-slate-300 text-lg">${showAudits}</td>
            <td class="p-6 text-center font-bold ${row.fatals > 0 ? 'text-red-600' : 'text-slate-400'} text-lg">${showFatals}</td>
            <td class="p-6 text-center">
                <div class="inline-block px-3 py-1 rounded-full font-bold text-sm ${scoreClass}">
                  ${showScore}
                </div>
            </td>
            <td class="p-6 text-center">
                ${showStatus}
            </td>
          </tr>
        `}).join('');
    }

    // Load reviews on page load
    window.addEventListener('load', function () {
      adminLoadReviewsList();
      adminLoadFeedbackList();

      // Start update checker once initial admin data is loaded
      try {
        startUpdateChecker();
      } catch (e) {
        console.warn('[updateChecker] failed to start', e);
      }

      // Real-time sync helper: Listen to storage events and poll for admin review changes.
      // This notifies other browser tabs/sessions on the same origin. Note: it cannot sync across different machines without a server.
      try {
        // Storage event listener (fires in other tabs/windows on the same origin)
        window.addEventListener('storage', function (ev) {
          try {
            if (!ev.key) return;
            if (ev.key === 'adminReviews' || ev.key === 'adminReviewsUpdatedAt' || ev.key === 'gojira_comments') {
              console.debug('[storage] detected change', ev.key);
              if (currentSessionUser && currentSessionUser.role === 'agent') {
                try { agentLoadQADashboard(); checkAgentNotifications(false); } catch (e) { console.warn('[storage] agent refresh failed', e); }

                // Show in-app/browser notification when new admin reviews are available via storage event
                try {
                  if (ev.key === 'adminReviews' || ev.key === 'adminReviewsUpdatedAt') {
                    const reviews = JSON.parse(localStorage.getItem('adminReviews') || '[]');
                    const latest = reviews.slice(-1)[0];
                    if (latest) {
                      const title = 'New Review from Admin';
                      const body = `${latest.reviewType ? latest.reviewType + ' - ' : ''}${latest.score ? 'Score: ' + latest.score + '. ' : ''}${(latest.observation || '').substring(0, 140)}`;
                      showInAppNotification(title, body, () => openReviewFile(latest.id));
                      if (isNotificationPermissionGranted) showBrowserNotification(title, body, null);
                      playNotificationBeep();
                    }
                  }
                } catch (e) { console.warn('[storage] notify agent failed', e); }
              }
              if (currentUser && (currentUser.role === 'admin' || currentUser.role === 'reviewer')) {
                try { adminLoadReviewsList(); adminLoadFeedbackList(); } catch (e) { console.warn('[storage] admin refresh failed', e); }

                // Show notification to admin when comments change
                try {
                  if (ev.key === 'gojira_comments') {
                    const comments = JSON.parse(localStorage.getItem('gojira_comments') || '[]');
                    const latest = comments.slice(-1)[0];
                    if (latest) {
                      const title = 'New Agent Comment';
                      const body = `${(latest.text || '').substring(0, 140)}`;
                      showInAppNotification(title, body, null);
                      if (isNotificationPermissionGranted) showBrowserNotification(title, body, null);
                      playNotificationBeep();
                    }
                  }
                } catch (e) { console.warn('[storage] notify admin failed', e); }
              }
            }
          } catch (err) { console.warn('[storage] handler error', err); }
        });

        // Polling fallback: check an "adminReviewsUpdatedAt" timestamp every 5s to detect changes across sessions
        let _lastAdminReviewsTimestamp = localStorage.getItem('adminReviewsUpdatedAt') || '';
        setInterval(() => {
          try {
            const ts = localStorage.getItem('adminReviewsUpdatedAt') || '';
            if (ts && ts !== _lastAdminReviewsTimestamp) {
              _lastAdminReviewsTimestamp = ts;
              console.debug('[poll] adminReviewsUpdatedAt changed', ts);
              if (currentSessionUser && currentSessionUser.role === 'agent') {
                try { agentLoadQADashboard(); checkAgentNotifications(false); } catch (e) { console.warn('[poll] agent refresh failed', e); }
              }
            }
          } catch (e) { console.warn('[poll] error', e); }
        }, 5000);
      } catch (e) {
        console.warn('[sync] failed to initialize storage sync helpers', e);
      }
    });

    /* ----------------- Auto-update / cache-refresh checker -----------------
      It checks the embedded APP_VERSION token in the page and periodically
      fetches the page with cache: 'no-store' to detect version changes.
      When a new version is detected it shows a small banner with a reload
      button so users can refresh to get the latest updates without re-sharing.
    ----------------------------------------------------------------------- */

    // Helper: extract token like "APP_VERSION: 20260130-001" from page text
    function _extractAppVersion(text) {
      const m = text.match(/APP_VERSION:\s*([0-9A-Za-z_.\-]+)/i);
      return m ? m[1] : null;
    }

    const _currentAppVersion = _extractAppVersion(document.documentElement.innerHTML) || 'unknown';
    let _updateCheckerInterval = null;

    function showUpdateBanner() {
      const banner = document.getElementById('update-banner');
      if (!banner) return;
      banner.classList.remove('hidden');

      const reloadBtn = document.getElementById('update-reload-btn');
      const dismissBtn = document.getElementById('update-dismiss-btn');

      // Attach handlers
      reloadBtn.onclick = () => location.reload();
      dismissBtn.onclick = () => banner.classList.add('hidden');

      // Auto-reload after 60s to ensure users get the new version (optional)
      setTimeout(() => {
        if (!banner.classList.contains('hidden')) location.reload();
      }, 60000);
    }

    async function checkForUpdates() {
      try {
        const resp = await fetch(location.href, { cache: 'no-store', credentials: 'same-origin' });
        if (!resp.ok) return;
        const text = await resp.text();
        const remoteVersion = _extractAppVersion(text);
        if (remoteVersion && remoteVersion !== _currentAppVersion) {
          console.info('[updateChecker] new version detected', remoteVersion, 'current', _currentAppVersion);
          showUpdateBanner();
          // stop further checks once detected
          if (_updateCheckerInterval) clearInterval(_updateCheckerInterval);
        }
      } catch (e) {
        console.warn('[updateChecker] check failed', e);
      }
    }

    function startUpdateChecker() {
      // Run an immediate check, then poll every 30s
      checkForUpdates();
      _updateCheckerInterval = setInterval(checkForUpdates, 30 * 1000);
    }

  </script>

  <!-- Agent Review Detail Modal -->
  <div id="agent-review-detail-modal"
    class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"
    onclick="if(event.target.id === 'agent-review-detail-modal') closeReviewDetailModal()">
    <div class="bg-white dark:bg-slate-800 rounded-3xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto"
      onclick="event.stopPropagation()">
      <div
        class="sticky top-0 bg-white dark:bg-slate-800 p-6 border-b border-slate-200 dark:border-slate-700 flex justify-between items-center">
        <h2 class="text-2xl font-bold">Review Details</h2>
        <button onclick="closeReviewDetailModal()" class="text-slate-500 hover:text-slate-700 text-2xl">‚úï</button>
      </div>

      <div class="p-6 space-y-6">
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-semibold mb-2">Review Type</label>
            <div id="review-detail-type" class="text-lg font-bold text-blue-600">üéôÔ∏è Voice Call</div>
          </div>
          <div>
            <label class="block text-sm font-semibold mb-2">Date</label>
            <div id="review-detail-date" class="text-lg">-</div>
          </div>
        </div>

        <div id="review-detail-file-section" class="hidden">
          <label class="block text-sm font-semibold mb-2">Uploaded File</label>
          <div class="bg-slate-100 dark:bg-slate-700 p-4 rounded-lg">
            <div id="review-detail-file-name" class="font-semibold mb-2">-</div>
            <button id="review-detail-file-link" class="text-blue-600 underline text-sm">üì• Download/View</button>
          </div>
        </div>

        <div id="review-detail-id-section" class="hidden">
          <label class="block text-sm font-semibold mb-2">EMAIL/CHAT ID</label>
          <div class="bg-slate-100 dark:bg-slate-700 p-4 rounded-lg font-mono text-sm" id="review-detail-id-value">-
          </div>
        </div>

        <div>
          <label class="block text-sm font-semibold mb-2">Observation</label>
          <div id="review-detail-observation"
            class="bg-slate-100 dark:bg-slate-700 p-4 rounded-lg whitespace-pre-wrap text-sm">-</div>
        </div>

        <div>
          <label class="block text-sm font-semibold mb-2">Score</label>
          <div class="text-3xl font-bold" id="review-detail-score">-</div>
        </div>

        <div>
          <label class="block text-sm font-semibold mb-2">Replies</label>
          <div id="review-detail-comments"
            class="bg-slate-50 dark:bg-slate-700 p-4 rounded-lg mb-4 max-h-48 overflow-y-auto">
            <p class="text-slate-500 italic">Loading...</p>
          </div>

          <textarea id="review-detail-reply-input" rows="3" placeholder="Write your reply..."
            class="flex-1 w-full px-4 py-3 rounded-lg border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-700"></textarea>
          <button id="review-detail-reply-btn"
            class="mt-2 w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">
            üì§ Send Reply
          </button>
        </div>
      </div>

      <div class="p-6 border-t border-slate-200 dark:border-slate-700">
        <button onclick="closeReviewDetailModal()"
          class="w-full bg-slate-300 dark:bg-slate-600 text-slate-800 dark:text-slate-200 font-bold py-2 px-4 rounded-lg">
          Close
        </button>
      </div>
    </div>
  </div>


  <!-- Admin Review Detail Modal (NEW) -->
  <div id="admin-review-detail-modal"
    class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"
    onclick="if(event.target.id === 'admin-review-detail-modal') closeAdminReviewDetailModal()">
    <div class="bg-white dark:bg-slate-800 rounded-3xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto"
      onclick="event.stopPropagation()">
      <div
        class="sticky top-0 bg-white dark:bg-slate-800 p-6 border-b border-slate-200 dark:border-slate-700 flex justify-between items-center">
        <h2 class="text-2xl font-bold">Review Details (Admin)</h2>
        <button onclick="closeAdminReviewDetailModal()" class="text-slate-500 hover:text-slate-700 text-2xl">‚úï</button>
      </div>

      <div class="p-6 space-y-6">
        <div class="flex justify-between items-center">
          <div>
            <h3 class="text-lg font-bold" id="admin-review-detail-agent">Agent Name</h3>
            <p class="text-sm text-slate-500" id="admin-review-detail-date">-</p>
          </div>
          <div id="admin-review-detail-type" class="text-lg font-bold text-blue-600"></div>
        </div>

        <div id="admin-review-detail-file-section" class="hidden">
          <label class="block text-sm font-semibold mb-2">Uploaded File</label>
          <div class="bg-slate-100 dark:bg-slate-700 p-4 rounded-lg flex justify-between items-center">
            <div id="admin-review-detail-file-name" class="font-semibold">-</div>
            <button id="admin-review-detail-file-link" class="text-blue-600 underline text-sm font-bold">üì•
              Download/View</button>
          </div>
        </div>

        <div id="admin-review-detail-id-section" class="hidden">
          <label class="block text-sm font-semibold mb-2">Contact ID</label>
          <div class="bg-slate-100 dark:bg-slate-700 p-4 rounded-lg font-mono text-sm"
            id="admin-review-detail-id-value">-</div>
        </div>

        <div>
          <label class="block text-sm font-semibold mb-2">Observation</label>
          <div id="admin-review-detail-observation"
            class="bg-slate-100 dark:bg-slate-700 p-4 rounded-lg whitespace-pre-wrap text-sm">-</div>
        </div>

        <div>
          <label class="block text-sm font-semibold mb-2">Score</label>
          <div class="text-3xl font-bold" id="admin-review-detail-score">-</div>
        </div>

        <div>
          <label class="block text-sm font-semibold mb-2">Comments History</label>
          <div id="admin-review-detail-comments"
            class="bg-slate-50 dark:bg-slate-700 p-4 rounded-lg max-h-60 overflow-y-auto space-y-3">
            <!-- Comments injected here -->
          </div>
        </div>
      </div>

      <div class="p-6 border-t border-slate-200 dark:border-slate-700">
        <button onclick="closeAdminReviewDetailModal()"
          class="w-full bg-slate-200 dark:bg-slate-700 text-slate-800 dark:text-slate-200 font-bold py-3 rounded-lg hover:bg-slate-300 dark:hover:bg-slate-600 transition">
          Close
        </button>
      </div>
    </div>
  </div>

  <!-- SOP Modal -->
  <div id="sop-modal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4"
    onclick="if(event.target.id === 'sop-modal') closeSOPModal()">
    <div id="sop-modal-content" class="bg-white dark:bg-slate-900 w-full max-w-6xl h-[90vh] rounded-2xl shadow-2xl overflow-hidden flex flex-col">
      <!-- Modal Header -->
      <div class="p-6 border-b border-slate-200 dark:border-slate-700 flex items-center justify-between bg-white dark:bg-slate-800">
        <h2 class="text-2xl font-bold">Standard Operating Procedure</h2>
        <div class="flex items-center gap-3">
          <button onclick="toggleSOPFullscreen()"
            class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition">üñ•Ô∏è Fullscreen</button>
          <button onclick="closeSOPModal()"
            class="text-slate-500 hover:text-slate-700 text-3xl font-bold">√ó</button>
        </div>
      </div>

      <!-- Modal Body (Scrollable) -->
      <div class="flex-1 overflow-y-auto p-6 space-y-6">
        <!-- PDF Preview -->
        <div class="border border-slate-200 dark:border-slate-700 rounded-xl overflow-hidden"
          style="height: 500px;">
          <iframe id="sop-modal-iframe" src="resources/SOP_BharatLoan2.pdf" class="w-full h-full" frameborder="0"></iframe>
        </div>

        <!-- Extracted Graphs -->
        <div>
          <div id="sop-modal-graphs-container" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
        </div>
      </div>
    </div>
  </div>

</body>

</html>
