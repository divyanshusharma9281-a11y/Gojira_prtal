<!DOCTYPE html>
<html lang="en" class="light">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gojira | Training Portal</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = { darkMode: 'class' }

    // Cursor Twinkle Animation Script - Global so it's ready
    // Cursor Twinkle Animation Script
    document.addEventListener('mousemove', function (e) {
      const loginView = document.getElementById('view-login');
      // Check if login view exists and is visible (not display: none)
      if (loginView && loginView.style.display !== 'none') {
        createTwinkle(e.clientX, e.clientY);
      }
    });

    function createTwinkle(x, y) {
      const twinkle = document.createElement('div');
      twinkle.classList.add('twinkle');
      twinkle.style.left = x + 'px';
      twinkle.style.top = y + 'px';

      // 30% chance to be a Shiny White Star
      if (Math.random() < 0.3) {
        twinkle.innerText = '‚òÖ'; // Unicode Star
        twinkle.style.color = '#FFFFFF'; // White Color
        twinkle.style.fontSize = (Math.random() * 10 + 10) + 'px'; // Size 10-20px
        twinkle.style.background = 'transparent'; // No background block
        twinkle.style.borderRadius = '0'; // No circle
        twinkle.style.boxShadow = 'none'; // No box shadow
        twinkle.style.textShadow = '0 0 10px rgba(255, 255, 255, 1), 0 0 20px rgba(255, 255, 255, 0.8)'; // Intense White Glow
        twinkle.style.width = 'auto';
        twinkle.style.height = 'auto';
        twinkle.style.display = 'flex';
        twinkle.style.alignItems = 'center';
        twinkle.style.justifyContent = 'center';
      } else {
        // Standard Rainbow Dot
        const size = Math.random() * 4 + 2;
        twinkle.style.width = size + 'px';
        twinkle.style.height = size + 'px';
        twinkle.style.borderRadius = '50%';

        const colors = ['#ff0000', '#ff7f00', '#ffff00', '#00ff00', '#0000ff', '#4b0082', '#9400d3']; // Rainbow
        twinkle.style.background = colors[Math.floor(Math.random() * colors.length)];
      }

      document.body.appendChild(twinkle);

      setTimeout(() => {
        twinkle.remove();
      }, 1000);
    }
  </script>

  <!-- Fonts -->
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Montserrat:wght@700&display=swap"
    rel="stylesheet">

  <style>
    body {
      font-family: 'Inter', sans-serif;
    }

    .app-view {
      display: none;
      min-height: 100vh;
    }

    .app-view.active {
      display: block;
    }

    .hover-lift:hover {
      transform: translateY(-8px);
      box-shadow: 0 20px 30px -10px rgba(0, 0, 0, .15);
    }

    .faq-answer {
      max-height: 0;
      overflow: hidden;
      opacity: 0;
      transition: all 0.4s ease;
    }

    .faq-item.active .faq-answer {
      max-height: 1200px;
      opacity: 1;
      padding-top: 0.75rem;
    }

    .tab-content {
      display: block;
    }

    .hidden {
      display: none !important;
    }

    .stylish {
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
    }

    .glow {
      box-shadow: 0 0 20px rgba(59, 130, 246, 0.5);
    }

    .animate-fade-in {
      animation: fadeIn 0.5s ease-in-out;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Login & Door Animation Styles */
    #view-login {
      position: fixed;
      inset: 0;
      z-index: 1000;
      background: linear-gradient(135deg, #ce0000 0%, #1a237e 100%);
      overflow-y: auto;
      /* Enable vertical scrolling */
      display: block;
      /* Remove flex to allow scrolling flow */
      perspective: 1000px;
    }

    .door-container {
      position: fixed;
      /* Fix doors to viewport so they stay put during scroll */
      inset: 0;
      display: flex;
      pointer-events: none;
      z-index: 20;
    }

    .door {
      flex: 1;
      background: #1e1e1e;
      border: 4px solid #333;
      transition: transform 1.5s cubic-bezier(0.4, 0, 0.2, 1);
      transform-origin: center;
      background: linear-gradient(135deg, #450a0a, #1e1b4b);
      box-shadow: inset 0 0 50px rgba(0, 0, 0, 0.8);
    }

    .door-left {
      transform-origin: left;
      border-right: 1px solid #000;
    }

    .door-right {
      transform-origin: right;
      border-left: 1px solid #000;
    }

    .doors-open .door-left {
      transform: rotateY(-110deg);
    }

    .doors-open .door-right {
      transform: rotateY(110deg);
    }

    .login-content {
      position: relative;
      z-index: 30;
      text-align: center;
      color: white;
      transition: transform 1s ease-out, opacity 1s ease-out;
      transform: scale(1);
      opacity: 1;
    }

    .doors-open .login-content {
      transform: scale(1);
      opacity: 1;
      transition-delay: 0.5s;
    }

    .gojira-logo {
      font-family: 'Montserrat', sans-serif;
      font-size: 8rem;
      font-weight: 900;
      text-transform: uppercase;
      background: -webkit-linear-gradient(#fff, #ccc);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      text-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
      margin-bottom: 2rem;
      letter-spacing: -4px;
    }

    .login-form-container {
      background: rgba(255, 255, 255, 0.1);
      padding: 3rem;
      border-radius: 2rem;
      backdrop-filter: blur(10px);
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    /* Twinkle Animation */
    .twinkle {
      position: fixed;
      border-radius: 50%;
      pointer-events: none;
      animation: fadeDrop 1s linear forwards;
      z-index: 9999;
      box-shadow: 0 0 8px rgba(255, 255, 255, 0.8);
    }

    @keyframes fadeDrop {
      0% {
        opacity: 1;
        transform: translateY(0) scale(1);
      }

      100% {
        opacity: 0;
        transform: translateY(30px) scale(0);
      }
    }
  </style>
</head>

<body class="bg-slate-50 text-slate-900 dark:bg-slate-900 dark:text-slate-100 transition-colors duration-300">

  <!-- LOGIN VIEW -->
  <div id="view-login">
    <div class="door-container" id="door-container">
      <div class="door door-left"></div>
      <div class="door door-right"></div>
    </div>

    <div class="relative z-30 min-h-screen flex flex-col">
      <!-- Login Section -->
      <div class="flex-grow flex flex-col items-center justify-center min-h-screen login-content" id="login-content">
        <h1 class="gojira-logo">GOJIRA</h1>
        <div class="login-form-container">
          <h2 class="text-2xl font-bold mb-6 text-white">Agent Portal</h2>
          <div class="space-y-4">
            <input type="text" id="login-empid" placeholder="Employee ID (e.g. BL/GG/25/704)"
              class="w-full px-6 py-4 rounded-xl bg-white/20 border border-white/30 text-white placeholder-white/70 focus:outline-none focus:ring-2 focus:ring-blue-400 text-center text-xl tracking-widest uppercase">
            <input type="password" id="login-password" placeholder="Password"
              class="w-full px-6 py-4 rounded-xl bg-white/20 border border-white/30 text-white placeholder-white/70 focus:outline-none focus:ring-2 focus:ring-blue-400 text-center text-xl tracking-widest"
              onkeypress="handleLoginKey(event)">
            <button onclick="attemptLogin()"
              class="w-full py-4 rounded-xl bg-blue-600 hover:bg-blue-700 text-white font-bold text-lg shadow-lg hover:shadow-blue-500/50 transition-all transform hover:scale-105">
              Unlock Access
            </button>
            <button onclick="openChangePasswordModal()"
              class="text-white/70 hover:text-white text-sm underline mt-2 block w-full">
              Change Password
            </button>
          </div>
          <p id="login-error" class="text-red-400 font-bold mt-4 hidden">Access Denied</p>
        </div>

        <!-- Scroll Hint -->
        <div class="mt-12 animate-bounce text-white/50 text-sm">
          <p>Scroll Down for Contact details</p>
          <p class="text-2xl">‚¨áÔ∏è</p>
        </div>
      </div>

      <!-- Contact Details Section -->
      <div class="py-16 bg-black/40 backdrop-blur-md text-center text-white border-t border-white/10">
        <h3 class="text-2xl font-bold mb-8">Contact Information</h3>

        <div class="grid md:grid-cols-3 gap-8 max-w-6xl mx-auto px-6">
          <div class="p-6 bg-white/5 rounded-2xl hover:bg-white/10 transition">
            <div class="text-4xl mb-4">üìç</div>
            <p class="font-medium text-lg">Address</p>
            <p class="text-white/70 mt-2">Plot no. 516, 1st floor,<br>Udyog Vihar Phase 3<br>Gurgaon, (Haryana) 122016
            </p>
          </div>

          <div class="p-6 bg-white/5 rounded-2xl hover:bg-white/10 transition">
            <div class="text-4xl mb-4">üìû</div>
            <p class="font-medium text-lg">Call Us</p>
            <p class="text-white/70 mt-2 text-xl font-bold">9220912305</p>
          </div>

          <div class="p-6 bg-white/5 rounded-2xl hover:bg-white/10 transition">
            <div class="text-4xl mb-4">‚úâÔ∏è</div>
            <p class="font-medium text-lg">Email Us</p>
            <p class="text-white/70 mt-2">divyanshu.sharma@bharatloan.com</p>
          </div>
        </div>

        <p class="mt-12 text-white/30 text-sm">¬© 2026 BharatLoan. All rights reserved.</p>
      </div>
    </div>
  </div>

  <!-- CHANGE PASSWORD MODAL -->
  <div id="modal-change-password"
    class="fixed inset-0 z-[1100] bg-black/80 hidden flex items-center justify-center backdrop-blur-sm">
    <div class="bg-gray-900 border border-gray-700 p-8 rounded-2xl w-full max-w-md shadow-2xl relative">
      <h3 class="text-2xl font-bold text-white mb-6">Change Password</h3>

      <div class="space-y-4">
        <div>
          <label class="block text-gray-400 mb-1 text-sm">Current Password</label>
          <input type="password" id="cp-current"
            class="w-full px-4 py-3 rounded-lg bg-gray-800 border border-gray-600 text-white focus:outline-none focus:border-blue-500">
        </div>
        <div>
          <label class="block text-gray-400 mb-1 text-sm">New Password</label>
          <input type="password" id="cp-new"
            class="w-full px-4 py-3 rounded-lg bg-gray-800 border border-gray-600 text-white focus:outline-none focus:border-blue-500">
        </div>
        <div>
          <label class="block text-gray-400 mb-1 text-sm">Confirm New Password</label>
          <input type="password" id="cp-confirm"
            class="w-full px-4 py-3 rounded-lg bg-gray-800 border border-gray-600 text-white focus:outline-none focus:border-blue-500">
        </div>

        <button onclick="submitChangePassword()"
          class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-lg font-bold mt-4 transition">Update
          Password</button>
        <button onclick="closeChangePasswordModal()" class="w-full text-gray-400 hover:text-white py-2">Cancel</button>
      </div>
    </div>
  </div>

  <!-- REVIEW DETAIL MODAL -->
  <div id="view-review-modal"
    class="fixed inset-0 z-[1200] bg-black/80 hidden flex items-center justify-center backdrop-blur-sm">
    <div
      class="bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 p-8 rounded-2xl w-full max-w-2xl shadow-2xl relative max-h-[90vh] overflow-y-auto">
      <div class="flex justify-between items-start mb-6">
        <h3 class="text-2xl font-bold text-slate-800 dark:text-slate-100">Review Details</h3>
        <button onclick="closeReviewModal()"
          class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-200 text-2xl">√ó</button>
      </div>

      <div class="space-y-6">
        <!-- Details -->
        <div class="grid grid-cols-2 gap-4">
          <div class="p-4 bg-slate-50 dark:bg-slate-700/50 rounded-xl">
            <span class="text-xs font-bold text-slate-400 uppercase">File Name</span>
            <div id="modal-review-filename" class="font-medium text-blue-600 underline cursor-pointer truncate"></div>
          </div>
          <div class="p-4 bg-slate-50 dark:bg-slate-700/50 rounded-xl">
            <span class="text-xs font-bold text-slate-400 uppercase">Score</span>
            <div id="modal-review-score" class="font-black text-2xl"></div>
          </div>
        </div>

        <!-- Observation -->
        <div>
          <span class="text-xs font-bold text-slate-400 uppercase">Admin Observation</span>
          <div id="modal-review-observation"
            class="mt-2 p-4 bg-slate-50 dark:bg-slate-700 rounded-xl text-slate-700 dark:text-slate-300 leading-relaxed border border-slate-200 dark:border-slate-600">
          </div>
        </div>

        <!-- Agent Reply Section -->
        <div id="modal-reply-section" class="border-t border-slate-200 dark:border-slate-700 pt-6">
          <h4 class="font-bold text-lg mb-4">Your Reply</h4>

          <!-- Existing Reply -->
          <div id="modal-existing-reply" class="hidden">
            <div class="p-4 bg-blue-50 dark:bg-blue-900/20 rounded-xl border border-blue-100 dark:border-blue-800">
              <span class="text-xs font-bold text-blue-600 dark:text-blue-400 uppercase mb-2 block">You wrote:</span>
              <p id="modal-reply-text" class="text-slate-700 dark:text-slate-300"></p>
            </div>
          </div>

          <!-- Reply Form -->
          <div id="modal-reply-form" class="hidden">
            <textarea id="modal-reply-input" rows="3" placeholder="Write your reply here (One-time only)..."
              class="w-full px-4 py-3 rounded-xl border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-700 focus:ring-2 focus:ring-blue-500 outline-none mb-3"></textarea>
            <button onclick="submitAgentReply()"
              class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-xl transition shadow-lg shadow-blue-500/30">
              Send Reply
            </button>
            <p class="text-xs text-slate-400 mt-2">Note: You can only reply ONCE to this feedback.</p>
          </div>
        </div>
      </div>
    </div>
  </div>
  </div>
  </div>

  <div id="app-container" style="display: none; opacity: 0; transition: opacity 1s ease-in;">
    <!-- TOP NAV -->
    <nav class="h-16 bg-white dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700 sticky top-0 z-50">
      <div class="max-w-7xl mx-auto px-6 h-full flex items-center justify-between">
        <div onclick="navigateTo('view-home')" class="flex items-center gap-3 cursor-pointer group">
          <div
            class="w-12 h-12 bg-slate-900 dark:bg-slate-700 rounded flex items-center justify-center text-white font-bold group-hover:bg-blue-600 transition glow">
            G</div>
          <span
            class="font-['Montserrat'] text-4xl text-transparent bg-clip-text bg-gradient-to-r from-blue-500 via-purple-500 to-indigo-600 stylish">
            Gojira
          </span>
        </div>

        <div class="flex flex-col items-end gap-2">
          <div class="flex items-center gap-2 relative">
            <!-- Notification Bell -->
            <button onclick="toggleNotifications()"
              class="relative text-slate-500 hover:text-blue-600 text-xl p-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-700 transition">
              üîî
              <div id="nav-notification-dot" class="absolute top-2 right-2 w-2 h-2 bg-red-500 rounded-full hidden">
              </div>
            </button>

            <!-- Notification Dropdown -->
            <div id="notification-dropdown"
              class="hidden absolute top-12 right-0 w-80 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl shadow-2xl z-50 overflow-hidden animate-fade-in">
              <div class="p-4 border-b border-slate-100 dark:border-slate-700 flex justify-between items-center">
                <h3 class="font-bold">Notifications</h3>
                <button onclick="NotificationManager.clearAll()" class="text-xs text-blue-600 hover:text-blue-700">Clear
                  All</button>
              </div>
              <div id="notification-list" class="max-h-80 overflow-y-auto">
                <!-- Populated by JS -->
              </div>
            </div>
            <button onclick="logout()"
              class="text-slate-500 hover:text-red-600 text-xl p-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-700 transition"
              title="Logout">
              ‚èª
            </button>
            <button onclick="toggleSearch()"
              class="text-slate-500 hover:text-blue-600 text-xl p-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-700 transition">üîç</button>
            <button onclick="toggleTheme()"
              class="flex items-center gap-2 px-4 py-2 rounded-full bg-slate-100 dark:bg-slate-700 text-sm font-semibold transition">
              <span id="theme-icon">üåô</span>
              <span id="theme-text">Dark</span>
            </button>
          </div>

          <div id="search-bar" class="hidden">
            <input id="search-input" type="text" oninput="performSearch(this.value)" placeholder="Search portal..."
              class="px-4 py-2 rounded-full bg-slate-100 dark:bg-slate-700 text-sm w-64">
            <div id="search-results"
              class="mt-2 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg shadow-lg max-h-60 overflow-y-auto">
            </div>
          </div>
        </div>
      </div>
    </nav>

    <!-- HOME -->
    <div id="view-home" class="app-view active">
      <main class="max-w-7xl mx-auto px-6 py-20 text-center">
        <h1 class="text-5xl font-extrabold mb-6">
          <div id="home-greeting" class="text-3xl text-slate-400 font-medium mb-2">Welcome</div>
          <span class="text-transparent bg-clip-text bg-gradient-to-r from-blue-600 to-indigo-600">
            Welcome to Training & Quality Portal
          </span>
        </h1>

        <!-- Guidelines Subtitle Removed -->



        <div class="grid grid-cols-1 md:grid-cols-4 gap-8" style="pointer-events: auto;">
          <div onclick="navigateTo('view-kb')"
            class="p-10 rounded-[2.5rem] cursor-pointer hover-lift bg-blue-600 text-white"
            style="pointer-events: auto;">
            <div class="w-16 h-16 bg-white/20 rounded-2xl mx-auto mb-6 flex items-center justify-center text-3xl">üìò
            </div>
            <h2 class="text-2xl font-bold mb-2">Knowledge Base</h2>
            <p class="text-sm opacity-90">Crucial FAQs and operational guidelines.</p>
          </div>

          <div onclick="navigateTo('view-entities')"
            class="p-10 rounded-[2.5rem] cursor-pointer hover-lift bg-indigo-600 text-white"
            style="pointer-events: auto;">
            <div class="w-16 h-16 bg-white/20 rounded-2xl mx-auto mb-6 flex items-center justify-center text-3xl">üè¶
            </div>
            <h2 class="text-2xl font-bold mb-2">Brand Entities</h2>
            <p class="text-sm opacity-90">Specific guidelines for each entity.</p>
          </div>

          <div onclick="navigateTo('view-updates')"
            class="p-10 rounded-[2.5rem] cursor-pointer hover-lift bg-amber-500 text-white"
            style="pointer-events: auto;">
            <div class="w-16 h-16 bg-white/20 rounded-2xl mx-auto mb-6 flex items-center justify-center text-3xl">üì¢
            </div>
            <h2 class="text-2xl font-bold mb-2">New Updates</h2>
            <p class="text-sm opacity-90">Latest system & policy logs.</p>
          </div>

          <div onclick="navigateTo('view-resources')"
            class="p-10 rounded-[2.5rem] cursor-pointer hover-lift bg-purple-600 text-white"
            style="pointer-events: auto;">
            <div class="w-16 h-16 bg-white/20 rounded-2xl mx-auto mb-6 flex items-center justify-center text-3xl">üìÅ
            </div>
            <h2 class="text-2xl font-bold mb-2">Quality Performance and Guidelines</h2>
            <p class="text-sm opacity-90"></p>
          </div>
        </div>
      </main>
    </div>

    <!-- KNOWLEDGE BASE -->
    <div id="view-kb" class="app-view bg-white dark:bg-slate-900">
      <header
        class="h-16 flex items-center px-6 border-b border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800">
        <button onclick="navigateTo('view-home')" class="font-bold text-slate-500 hover:text-blue-600">‚Üê Home</button>
        <span class="mx-auto font-bold">Knowledge Base</span>
      </header>
      <div class="max-w-4xl mx-auto px-6 py-14">
        <h1 class="text-4xl font-extrabold mb-10">Frequently Asked Questions</h1>
        <div class="space-y-4">
          <!-- 1 -->
          <div class="faq-item border-b pb-4">
            <button onclick="toggleFaq(this)" class="w-full text-left font-bold text-lg">1. My loan is approved but not
              disbursed. Why?</button>
            <div class="faq-answer text-slate-600 dark:text-slate-300">
              <p class="mb-2">Loan disbursement may be pending due to:</p>
              <ul class="list-disc ml-6 space-y-1">
                <li>Incomplete documentation</li>
                <li>Bank account verification</li>
                <li>Internal compliance or risk checks</li>
              </ul>
              <p class="mt-2 font-medium">Our team will assist you with the exact reason.</p>
            </div>
          </div>

          <!-- 2 -->
          <div class="faq-item border-b pb-4">
            <button onclick="toggleFaq(this)" class="w-full text-left font-bold text-lg">2. Can I increase my loan
              amount
              after sanction?</button>
            <div class="faq-answer text-slate-600 dark:text-slate-300">
              <p class="mb-2">Loan enhancement depends on below mentioned criteria but can be done while accepting the
                offer not post sanction:</p>
              <ul class="list-disc ml-6 space-y-1">
                <li>Your credit profile</li>
                <li>Repayment history</li>
                <li>Internal eligibility checks</li>
              </ul>
              <p class="mt-2">You may reapply after closing or maintaining a good repayment track.</p>
            </div>
          </div>

          <!-- 3 -->
          <div class="faq-item border-b pb-4">
            <button onclick="toggleFaq(this)" class="w-full text-left font-bold text-lg">3. Why was my loan application
              rejected?</button>
            <div class="faq-answer text-slate-600 dark:text-slate-300">
              <p class="mb-2">Loan applications can be rejected due to:</p>
              <ul class="list-disc ml-6 space-y-1">
                <li>Credit score or repayment history</li>
                <li>Existing liabilities</li>
                <li>Internal risk assessment</li>
              </ul>
              <p class="mt-2">Customer care can guide but cannot override system decisions.</p>
            </div>
          </div>

          <!-- 4 -->
          <div class="faq-item border-b pb-4">
            <button onclick="toggleFaq(this)" class="w-full text-left font-bold text-lg">4. How long does it take for
              repayment to reflect after payment?</button>
            <div class="faq-answer text-slate-600 dark:text-slate-300">
              <p>Payments usually reflect within 24‚Äì48 working hours. Delays may occur due to bank processing or
                holidays.
              </p>
            </div>
          </div>

          <!-- 5 -->
          <div class="faq-item border-b pb-4">
            <button onclick="toggleFaq(this)" class="w-full text-left font-bold text-lg">5. How is my total payable
              amount
              calculated?</button>
            <div class="faq-answer text-slate-600 dark:text-slate-300">
              <p class="mb-2">Your payable amount includes:</p>
              <ul class="list-disc ml-6 space-y-1">
                <li>Loan Amount</li>
                <li>Interest calculated till the repayment date</li>
                <li>Penalty (2% post repayment date where 1% is daily interest and 1% is penalty)</li>
              </ul>
            </div>
          </div>

          <!-- 6 -->
          <div class="faq-item border-b pb-4">
            <button onclick="toggleFaq(this)" class="w-full text-left font-bold text-lg">6. Will my credit score be
              affected if I delay payment?</button>
            <div class="faq-answer text-slate-600 dark:text-slate-300">
              <p>Yes. Any delay in repayment may negatively impact your CIBIL score, which can affect future loan or
                credit card approvals.</p>
            </div>
          </div>

          <!-- 7 -->
          <div class="faq-item border-b pb-4">
            <button onclick="toggleFaq(this)" class="w-full text-left font-bold text-lg">7. I have already shared a
              Promise to Pay (PTP). Why am I being called again?</button>
            <div class="faq-answer text-slate-600 dark:text-slate-300">
              <p class="mb-2">We may call to:</p>
              <ul class="list-disc ml-6 space-y-1">
                <li>Confirm your payment readiness</li>
                <li>Check if funds have been arranged</li>
                <li>Assist you in making the payment earlier, if possible</li>
              </ul>
              <p class="mt-2">This helps avoid further penalties or escalation.</p>
            </div>
          </div>

          <!-- 8 -->
          <div class="faq-item border-b pb-4">
            <button onclick="toggleFaq(this)" class="w-full text-left font-bold text-lg">8. Will I continue to receive
              calls after making the payment?</button>
            <div class="faq-answer text-slate-600 dark:text-slate-300">
              <p>No. Once the payment is successfully received and updated in our system, collection calls will stop.
              </p>
              <p class="mt-2">If you still receive a call, please share the payment reference number with the agent.</p>
            </div>
          </div>

          <!-- 9 -->
          <div class="faq-item border-b pb-4">
            <button onclick="toggleFaq(this)" class="w-full text-left font-bold text-lg">9. What is NBFC?</button>
            <div class="faq-answer text-slate-600 dark:text-slate-300">
              <p>NBFC means Non-Banking Financial Company. It is a company that gives loans, but it is not a bank.</p>
              <div class="mt-4 p-4 bg-slate-50 dark:bg-slate-800 rounded-xl space-y-2">
                <p>üè¶ <strong>Bank</strong> = savings account + loans</p>
                <p>üí∞ <strong>NBFC</strong> = only loans</p>
              </div>
              <ul class="list-disc ml-6 mt-4 space-y-1">
                <li>NBFCs give personal loans, business loans, etc.</li>
                <li>They are approved by RBI</li>
                <li>You cannot open a savings account in an NBFC</li>
                <li>They are commonly used in instant loan apps</li>
              </ul>
              <p class="mt-3 text-sm italic">Example: If you take a quick loan from an app and get money fast, it is
                usually an NBFC, not a bank.</p>
            </div>
          </div>

          <!-- 10 -->
          <div class="faq-item border-b pb-4">
            <button onclick="toggleFaq(this)" class="w-full text-left font-bold text-lg">10. What is an Account
              Aggregator?</button>
            <div class="faq-answer text-slate-600 dark:text-slate-300">
              <p class="mb-3">An Account Aggregator (AA) is a secure system that lets you share your bank details
                digitally with a lender only after your permission. It helps banks/NBFCs check your financial data
                online,
                without paperwork.</p>
              <h4 class="font-bold mb-2">How it works:</h4>
              <ol class="list-decimal ml-6 space-y-1 mb-4">
                <li>You give consent</li>
                <li>Your bank statement / financial data is shared securely</li>
                <li>The lender checks your eligibility</li>
                <li>Loan gets processed faster</li>
              </ol>
              <div class="grid grid-cols-2 gap-2 text-sm">
                <div class="bg-slate-100 dark:bg-slate-800 p-2 rounded">üîí Safe & secure</div>
                <div class="bg-slate-100 dark:bg-slate-800 p-2 rounded">‚úÖ RBI regulated</div>
                <div class="bg-slate-100 dark:bg-slate-800 p-2 rounded">‚ùå No data without consent</div>
                <div class="bg-slate-100 dark:bg-slate-800 p-2 rounded">‚ö° Quick & paperless</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- BRAND ENTITIES -->
    <div id="view-entities" class="app-view">
      <header class="h-16 flex items-center px-6 border-b bg-white dark:bg-slate-800">
        <button onclick="navigateTo('view-home')" class="font-bold text-slate-500 hover:text-blue-600">‚Üê Home</button>
        <span class="mx-auto font-bold">Brand Entities</span>
      </header>

      <div class="max-w-6xl mx-auto px-6 py-14 text-center">
        <h1 class="text-3xl font-extrabold mb-12">Select an Entity to View Guidelines</h1>

        <div class="grid md:grid-cols-4 gap-8">
          <div onclick="navigateTo('view-bharatloan')"
            class="relative p-8 rounded-3xl cursor-pointer hover-lift bg-gradient-to-r from-blue-800 via-red-600 to-blue-900 text-white">
            <div
              class="w-16 h-16 bg-black rounded-2xl mx-auto mb-4 flex items-center justify-center font-extrabold text-2xl text-white">
              B</div>
            <h3 class="font-bold text-lg">BharatLoan</h3>
          </div>

          <div onclick="navigateTo('view-rupee112')"
            class="relative p-8 rounded-3xl cursor-pointer hover-lift bg-gradient-to-r from-green-500 to-red-600 text-white">
            <div
              class="w-16 h-16 bg-black rounded-2xl mx-auto mb-4 flex items-center justify-center font-extrabold text-2xl text-white">
              ‚Çπ</div>
            <h3 class="font-bold text-lg">Rupee112</h3>
          </div>

          <div onclick="navigateTo('view-loan112')"
            class="relative p-8 rounded-3xl cursor-pointer hover-lift bg-gradient-to-r from-blue-900 to-red-600 text-white">
            <div
              class="w-16 h-16 bg-black rounded-2xl mx-auto mb-4 flex items-center justify-center font-extrabold text-2xl text-white">
              L</div>
            <h3 class="font-bold text-lg">Loan112</h3>
          </div>

          <div onclick="navigateTo('view-rupeeontime')"
            class="relative p-8 rounded-3xl cursor-pointer hover-lift bg-gradient-to-r from-purple-600 to-red-600 text-white">
            <div
              class="w-16 h-16 bg-black rounded-2xl mx-auto mb-4 flex items-center justify-center font-extrabold text-2xl text-white">
              ‚úî</div>
            <h3 class="font-bold text-lg">RupeeOnTime</h3>
          </div>
        </div>
      </div>
    </div>

    <!-- UPDATES -->
    <div id="view-updates" class="app-view bg-white dark:bg-slate-900">
      <header class="h-16 flex items-center px-6 border-b bg-white dark:bg-slate-800">
        <button onclick="navigateTo('view-home')" class="font-bold text-slate-500 hover:text-blue-600">‚Üê Home</button>
        <span class="mx-auto font-bold">System Updates</span>
      </header>
      <div class="max-w-4xl mx-auto px-6 py-14">
        <h2 class="text-3xl font-extrabold mb-8">Recent Policy Changes</h2>
        <div
          class="bg-blue-50 dark:bg-slate-800 p-8 rounded-3xl border border-blue-100 dark:border-slate-700 text-center">
          <div class="text-4xl mb-4">‚ú®</div>
          <h3 class="text-xl font-bold mb-2">Stay Tuned!</h3>
          <p class="text-slate-600 dark:text-slate-400">There are no new updates currently.</p>
        </div>
      </div>
    </div>

    <!-- BHARATLOAN SPECIFIC VIEW -->
    <div id="view-bharatloan" class="app-view bg-white dark:bg-slate-900">
      <header
        class="h-16 flex items-center justify-between px-6 border-b border-slate-200 dark:border-slate-700 bg-gradient-to-r from-red-600 to-blue-900 text-white relative">
        <button onclick="navigateTo('view-entities')" class="font-bold text-white hover:text-blue-600">‚Üê Back to
          Entities</button>
        <button onclick="toggleDropdown('')" class="text-white hover:text-blue-600">Support üìû</button>
        <div id="support-dropdown"
          class="hidden absolute top-full right-0 mt-2 bg-gradient-to-r from-blue-800 via-red-600 to-blue-900 text-white border border-slate-200 dark:border-slate-700 rounded-lg shadow-lg p-4 z-10">
          <h4 class="font-bold mb-2">Contact Support</h4>
          <p><strong>Call:</strong> 8282824644</p>
          <p><strong>Email:</strong> care@bharatloan.com</p>
        </div>
      </header>

      <div class="max-w-5xl mx-auto px-6 py-14">
        <!-- Tabs Removed: Guidelines tab removed, defaulting to Tools -->
        <!-- Guidelines Tab Content Removed -->
        <h2 class="text-2xl font-bold mb-6 text-slate-700 dark:text-slate-200">Our Operating Tools</h2>

        <!-- Tools Tab Content -->
        <div id="content-tools" class="tab-content">
          <div class="grid gap-6">
            <div
              class="group bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 p-6 rounded-3xl transition-all hover:shadow-lg">
              <div class="flex flex-col md:flex-row md:items-center justify-between gap-6">
                <div class="flex-1">
                  <h3 class="text-xl font-bold mb-2">BharatLoan Portal and Search Module</h3>
                  <p class="text-slate-600 dark:text-slate-300 text-sm leading-relaxed">
                    Main application processing, document view, and status checks. Customer search via PAN, Mobile, or
                    Email.
                  </p>
                </div>
                <a href="https://bharatloanfintech.com/" target="_blank"
                  class="bg-blue-600 text-white font-bold py-3 px-6 rounded-xl hover:bg-blue-700 transition">Visit
                  Portal
                  ‚Üó</a>
              </div>
            </div>

            <div
              class="group bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 p-6 rounded-3xl transition-all hover:shadow-lg">
              <div class="flex flex-col md:flex-row md:items-center justify-between gap-6">
                <div class="flex-1">
                  <h3 class="text-xl font-bold mb-2">WOCOM 365</h3>
                  <p class="text-slate-600 dark:text-slate-300 text-sm leading-relaxed">
                    Telephony integration, lead management, and communication logging.
                  </p>
                </div>
                <a href="https://cpaas.wocom365.com/" target="_blank"
                  class="bg-emerald-600 text-white font-bold py-3 px-6 rounded-xl hover:bg-emerald-700 transition">Open
                  WOCOM ‚Üó</a>
              </div>
            </div>

            <div
              class="group bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 p-6 rounded-3xl transition-all hover:shadow-lg">
              <div class="flex flex-col md:flex-row md:items-center justify-between gap-6">
                <div class="flex-1">
                  <h3 class="text-xl font-bold mb-2">Yellow Ai</h3>
                  <p class="text-slate-600 dark:text-slate-300 text-sm leading-relaxed">
                    Handle real-time customer chats efficiently through the AI-powered cloud platform.
                  </p>
                </div>
                <a href="https://cloud.yellow.ai/auth/login" target="_blank"
                  class="bg-indigo-600 text-white font-bold py-3 px-6 rounded-xl hover:bg-indigo-700 transition">Login
                  Chat ‚Üó</a>
              </div>
            </div>

            <div
              class="group bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 p-6 rounded-3xl transition-all hover:shadow-lg">
              <div class="flex flex-col md:flex-row md:items-center justify-between gap-6">
                <div class="flex-1">
                  <h3 class="text-xl font-bold mb-2">Outlook (Care@bharatloan.com)</h3>
                  <p class="text-slate-600 dark:text-slate-300 text-sm leading-relaxed">
                    Review customer emails and attachments. Standard channel for ticketing and complex queries.
                  </p>
                </div>
                <a href="https://outlook.office.com/mail/" target="_blank"
                  class="bg-amber-500 text-white font-bold py-3 px-6 rounded-xl hover:bg-amber-600 transition">Open Mail
                  ‚Üó</a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- RESOURCES -->
    <div id="view-resources" class="app-view bg-white dark:bg-slate-900">
      <header class="h-16 flex items-center px-6 border-b bg-white dark:bg-slate-800">
        <button onclick="navigateTo('view-home')" class="font-bold text-slate-500 hover:text-blue-600">‚Üê Home</button>
        <span class="mx-auto font-bold">Resources</span>
      </header>
      <div class="max-w-4xl mx-auto px-6 py-14">
        <div class="space-y-6">
          <div
            class="bg-slate-50 dark:bg-slate-800 rounded-3xl border border-slate-200 dark:border-slate-700 overflow-hidden">
            <div
              class="p-6 cursor-pointer flex items-center justify-between hover:bg-slate-100 dark:hover:bg-slate-700/50 transition"
              onclick="toggleGuidelinesDropdown()">
              <div class="flex items-center gap-4">
                <div class="w-12 h-12 bg-purple-600 text-white rounded-xl flex items-center justify-center text-xl">üìÑ
                </div>
                <h3 class="text-xl font-bold">Guidelines</h3>
              </div>
              <span class="text-2xl text-slate-400">‚ñº</span>
            </div>

            <div id="guidelines-dropdown-content"
              class="hidden border-t border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900 p-8 text-slate-700 dark:text-slate-300">
              <h2 class="text-2xl font-extrabold mb-4 text-blue-600">Customer Query Handling ‚Äì All Brands</h2>
              <p class="mb-6 font-medium text-slate-500">Applicable Brands: Bharat Loan, Loan 112, Rupee 112, Rupee On
                Time</p>

              <div class="bg-yellow-50 dark:bg-yellow-900/20 border-l-4 border-yellow-500 p-4 mb-8">
                <p class="font-bold text-yellow-800 dark:text-yellow-200">‚ö†Ô∏è These SOPs are mandatory and must be
                  followed without exception.</p>
                <p class="text-sm text-yellow-700 dark:text-yellow-300 mt-1">From today onwards, the same format,
                  language, and rules must be used while handling emails and calls.</p>
              </div>

              <!-- General Instructions -->
              <div class="mb-6 border border-slate-200 dark:border-slate-700 rounded-2xl overflow-hidden">
                <button onclick="toggleSopSection('sop-general')"
                  class="w-full text-left p-4 bg-slate-50 dark:bg-slate-800 flex justify-between items-center hover:bg-slate-100 dark:hover:bg-slate-700 transition">
                  <h3 class="text-lg font-bold flex items-center gap-2">üîê GENERAL INSTRUCTIONS <span
                      class="text-sm font-normal text-slate-500">(APPLICABLE TO ALL CASES)</span></h3>
                  <span class="text-xl">‚ñº</span>
                </button>
                <div id="sop-general"
                  class="hidden p-6 bg-white dark:bg-slate-900 border-t border-slate-200 dark:border-slate-700">
                  <ul class="space-y-2 list-disc ml-5">
                    <li>Follow only approved responses mentioned in this SOP.</li>
                    <li>Do not provide false assurance or timelines outside what is defined.</li>
                    <li>Do not address customers as ‚ÄúSir/Ma‚Äôam‚Äù.</li>
                    <li><strong>Always address customers by their name.</strong></li>
                    <li>Maintain professional, clear, and consistent communication.</li>
                    <li>Escalations must follow defined conditions only.</li>
                  </ul>
                </div>
              </div>

              <div class="space-y-4">
                <!-- SECTION 1 -->
                <div class="border border-slate-200 dark:border-slate-700 rounded-2xl overflow-hidden">
                  <button onclick="toggleSopSection('sop-sec-1')"
                    class="w-full text-left p-4 bg-slate-50 dark:bg-slate-800 flex justify-between items-center hover:bg-slate-100 dark:hover:bg-slate-700 transition">
                    <h3 class="text-lg font-bold text-slate-900 dark:text-white">1Ô∏è‚É£ PAYMENT-RELATED QUERIES</h3>
                    <span class="text-xl">‚ñº</span>
                  </button>
                  <div id="sop-sec-1"
                    class="hidden p-6 bg-white dark:bg-slate-900 border-t border-slate-200 dark:border-slate-700">
                    <div class="mb-6">
                      <h4 class="font-bold text-lg mb-2">A. Payment Done but NOT Reflecting on Portal</h4>
                      <div class="pl-4 border-l-2 border-purple-200 dark:border-slate-700 space-y-3">
                        <p><strong>Mandatory Steps:</strong></p>
                        <ul class="list-disc ml-5 space-y-1">
                          <li>Ask the customer to confirm the exact payment amount.</li>
                          <li>Verify the details provided by the customer.</li>
                        </ul>
                        <p><strong>While escalating or emailing:</strong></p>
                        <ul class="list-disc ml-5 space-y-1">
                          <li>Mention the confirmed payment amount clearly.</li>
                          <li>Update the WhatsApp group with the same confirmed amount.</li>
                        </ul>
                        <div
                          class="bg-green-50 dark:bg-green-900/20 p-3 rounded-lg text-green-800 dark:text-green-300 text-sm">
                          ‚úÖ Payment amount confirmation is compulsory before any escalation.<br>
                          üö´ Do not escalate without confirming the amount.
                        </div>
                      </div>
                    </div>

                    <div>
                      <h4 class="font-bold text-lg mb-2">B. Payment Done and Reflecting on Portal but Not Updated</h4>
                      <div class="pl-4 border-l-2 border-purple-200 dark:border-slate-700 space-y-3">
                        <p><strong>Steps:</strong> Check amount on portal > Confirm with customer > Inform using format:
                        </p>
                        <div
                          class="bg-slate-100 dark:bg-slate-800 p-4 rounded-xl border border-slate-200 dark:border-slate-600">
                          <span class="text-xs font-bold text-blue-500 uppercase tracking-widest">Approved
                            Response</span>
                          <p class="mt-2 italic">‚ÄúWe have received your payment of ‚Çπ40,000. Your payment is currently
                            under verification and will be updated within 24 hours (maximum).‚Äù</p>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- SECTION 2 -->
                <div class="border border-slate-200 dark:border-slate-700 rounded-2xl overflow-hidden">
                  <button onclick="toggleSopSection('sop-sec-2')"
                    class="w-full text-left p-4 bg-slate-50 dark:bg-slate-800 flex justify-between items-center hover:bg-slate-100 dark:hover:bg-slate-700 transition">
                    <h3 class="text-lg font-bold text-slate-900 dark:text-white">2Ô∏è‚É£ APPLICATION-RELATED QUERIES</h3>
                    <span class="text-xl">‚ñº</span>
                  </button>
                  <div id="sop-sec-2"
                    class="hidden p-6 bg-white dark:bg-slate-900 border-t border-slate-200 dark:border-slate-700">
                    <div class="mb-6">
                      <h4 class="font-bold text-lg mb-2">A. Application NOT Completed (Lead / Partial Status)</h4>
                      <p class="text-sm mb-3 text-slate-500">Examples: OCR error, Registration success, eKYC pending,
                        Bank statement req, OTP verified.</p>

                      <div
                        class="bg-slate-100 dark:bg-slate-800 p-4 rounded-xl border border-slate-200 dark:border-slate-600 mb-3">
                        <span class="text-xs font-bold text-blue-500 uppercase tracking-widest">Approved Customer
                          Response</span>
                        <p class="mt-2 italic">‚ÄúYour application is currently in process. Kindly complete the remaining
                          steps 100% through the Bharat Loan application. If you are facing any issues, please visit our
                          website or contact us at care@bharatloan.com and try again after some time.‚Äù</p>
                      </div>

                      <div class="grid md:grid-cols-2 gap-4">
                        <div class="bg-red-50 dark:bg-red-900/20 p-3 rounded-lg text-red-800 dark:text-red-300 text-sm">
                          üö´ <strong>Do NOT say:</strong> ‚ÄúOur team will contact you within 24 hours‚Äù
                        </div>
                        <div
                          class="bg-blue-50 dark:bg-blue-900/20 p-3 rounded-lg text-blue-800 dark:text-blue-300 text-sm">
                          ‚è≥ <strong>If asked about time:</strong> ‚ÄúMaximum processing time is 24 hours after successful
                          completion. A credit manager will be assigned then.‚Äù
                        </div>
                      </div>
                    </div>

                    <div class="mb-6">
                      <h4 class="font-bold text-lg mb-2">B. Application Submitted Successfully</h4>
                      <p class="text-sm mb-2 text-slate-500">Condition: Ref number generated (e.g., #BLVD9E7E)</p>
                      <div
                        class="bg-slate-100 dark:bg-slate-800 p-4 rounded-xl border border-slate-200 dark:border-slate-600">
                        <span class="text-xs font-bold text-blue-500 uppercase tracking-widest">Approved Response</span>
                        <p class="mt-2 italic">‚ÄúYour application has been submitted successfully. Our team will contact
                          you within 24 hours.‚Äù</p>
                      </div>
                    </div>

                    <div>
                      <h4 class="font-bold text-lg mb-2">C. Repeat Customer ‚Äì Bank Statement Required</h4>
                      <div
                        class="bg-slate-100 dark:bg-slate-800 p-4 rounded-xl border border-slate-200 dark:border-slate-600">
                        <span class="text-xs font-bold text-blue-500 uppercase tracking-widest">Approved Response</span>
                        <p class="mt-2 italic">‚ÄúSince you are an existing customer, your application status is in
                          process. Kindly wait while a credit manager is assigned. They will contact you within 24
                          hours.‚Äù</p>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- SECTION 3 -->
                <div class="border border-slate-200 dark:border-slate-700 rounded-2xl overflow-hidden">
                  <button onclick="toggleSopSection('sop-sec-3')"
                    class="w-full text-left p-4 bg-slate-50 dark:bg-slate-800 flex justify-between items-center hover:bg-slate-100 dark:hover:bg-slate-700 transition">
                    <h3 class="text-lg font-bold text-slate-900 dark:text-white">3Ô∏è‚É£ CREDIT MANAGER-RELATED QUERIES</h3>
                    <span class="text-xl">‚ñº</span>
                  </button>
                  <div id="sop-sec-3"
                    class="hidden p-6 bg-white dark:bg-slate-900 border-t border-slate-200 dark:border-slate-700">
                    <div class="mb-4">
                      <h4 class="font-bold text-lg mb-2">Issue: Credit Manager Not Responding</h4>
                      <ul class="list-disc ml-5 space-y-2">
                        <li><strong>First Time:</strong> Check if raised > If not, escalate & inform 24h timeline.</li>
                        <li><strong>Same Day (Already Raised):</strong> ‚ÄúAn executive has already escalated your
                          concern. Our team will contact you within 24 hours.‚Äù</li>
                        <li><strong>Raised Twice Already:</strong> Tag manager while escalating. Ensure history is
                          clear.</li>
                      </ul>
                    </div>
                  </div>
                </div>

                <!-- SECTION 4 -->
                <div class="border border-slate-200 dark:border-slate-700 rounded-2xl overflow-hidden">
                  <button onclick="toggleSopSection('sop-sec-4')"
                    class="w-full text-left p-4 bg-slate-50 dark:bg-slate-800 flex justify-between items-center hover:bg-slate-100 dark:hover:bg-slate-700 transition">
                    <h3 class="text-lg font-bold text-slate-900 dark:text-white">4Ô∏è‚É£ COLLECTION-RELATED QUERIES</h3>
                    <span class="text-xl">‚ñº</span>
                  </button>
                  <div id="sop-sec-4"
                    class="hidden p-6 bg-white dark:bg-slate-900 border-t border-slate-200 dark:border-slate-700">
                    <div class="mb-6">
                      <h4 class="font-bold text-lg mb-2">A. Extension Request Due to Medical Reasons</h4>
                      <div
                        class="bg-slate-100 dark:bg-slate-800 p-4 rounded-xl border border-slate-200 dark:border-slate-600 mb-3">
                        <span class="text-xs font-bold text-blue-500 uppercase tracking-widest">Approved Response</span>
                        <p class="mt-2 italic">‚ÄúWe do not have the authority to grant extensions. Your case has been
                          forwarded to the collection team. If payment is not made on time, it may impact your CIBIL
                          score, and a charge of 2% per day (1% interest + 1% penalty) will apply. If you have a medical
                          issue, please share valid medical documents at care@bharatloan.com. Our email team will review
                          within 24 hours.‚Äù</p>
                      </div>
                      <p class="text-sm">üìå If documents already shared: Confirm receipt & forward case.</p>
                    </div>

                    <div>
                      <h4 class="font-bold text-lg mb-2">B. Penalty Waiver / Settlement Requests</h4>
                      <div
                        class="bg-slate-100 dark:bg-slate-800 p-4 rounded-xl border border-slate-200 dark:border-slate-600">
                        <span class="text-xs font-bold text-blue-500 uppercase tracking-widest">Approved Response</span>
                        <p class="mt-2 italic">‚ÄúWe do not have the authority to approve penalty waivers or settlements.
                          Please email care@bharatloan.com with valid reasons. Your concern will be escalated, and the
                          team will update you within 24 hours.‚Äù</p>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- SECTION 5 -->
                <div class="border border-slate-200 dark:border-slate-700 rounded-2xl overflow-hidden">
                  <button onclick="toggleSopSection('sop-sec-5')"
                    class="w-full text-left p-4 bg-slate-50 dark:bg-slate-800 flex justify-between items-center hover:bg-slate-100 dark:hover:bg-slate-700 transition">
                    <h3 class="text-lg font-bold text-slate-900 dark:text-white">5Ô∏è‚É£ DISBURSEMENT-RELATED QUERIES</h3>
                    <span class="text-xl">‚ñº</span>
                  </button>
                  <div id="sop-sec-5"
                    class="hidden p-6 bg-white dark:bg-slate-900 border-t border-slate-200 dark:border-slate-700">
                    <div class="mb-6">
                      <h4 class="font-bold text-lg mb-2">A. Disbursement Showing but Amount NOT Credited</h4>
                      <div class="pl-4 border-l-2 border-purple-200 dark:border-slate-700 space-y-2">
                        <p><strong>
                            < 24 Hours:</strong> Do not escalate. Do not email.</p>
                        <p><strong>> 24 Hours:</strong> Request bank statement via email.</p>
                        <div class="bg-blue-50 dark:bg-blue-900/20 p-2 rounded text-sm inline-block">‚úÖ Always guide
                          broadly based on 24-hour timeline.</div>
                      </div>
                    </div>

                    <div>
                      <h4 class="font-bold text-lg mb-2">B. Loan Cancellation After Disbursement</h4>
                      <p>Update case in <strong>Refund Tracker</strong> (Sheet: ‚ÄúCancel After Disbursement‚Äù). Ensure
                        complete details.</p>
                    </div>
                  </div>
                </div>

                <!-- SECTION 6 -->
                <div class="border border-slate-200 dark:border-slate-700 rounded-2xl overflow-hidden">
                  <button onclick="toggleSopSection('sop-sec-6')"
                    class="w-full text-left p-4 bg-slate-50 dark:bg-slate-800 flex justify-between items-center hover:bg-slate-100 dark:hover:bg-slate-700 transition">
                    <h3 class="text-lg font-bold text-slate-900 dark:text-white">6Ô∏è‚É£ REFUND-RELATED QUERIES</h3>
                    <span class="text-xl">‚ñº</span>
                  </button>
                  <div id="sop-sec-6"
                    class="hidden p-6 bg-white dark:bg-slate-900 border-t border-slate-200 dark:border-slate-700">
                    <ul class="list-disc ml-5 space-y-2">
                      <li>Confirm refund amount.</li>
                      <li>Raise concern with email team.</li>
                      <li><strong>Timeline:</strong> üïí 7‚Äì10 working days.</li>
                    </ul>
                  </div>
                </div>

                <!-- EMAIL TEAM -->
                <div class="border border-slate-200 dark:border-slate-700 rounded-2xl overflow-hidden">
                  <button onclick="toggleSopSection('sop-sec-email')"
                    class="w-full text-left p-4 bg-slate-50 dark:bg-slate-800 flex justify-between items-center hover:bg-slate-100 dark:hover:bg-slate-700 transition">
                    <h3 class="text-lg font-bold text-slate-900 dark:text-white">üìß IMPORTANT UPDATE ‚Äì EMAIL TEAM</h3>
                    <span class="text-xl">‚ñº</span>
                  </button>
                  <div id="sop-sec-email"
                    class="hidden p-6 bg-white dark:bg-slate-900 border-t border-slate-200 dark:border-slate-700">
                    <div class="bg-slate-900 text-slate-100 p-6 rounded-2xl font-mono text-sm leading-relaxed">
                      <p class="font-bold text-yellow-400 mb-2">‚úÖ PAYMENT CONFIRMATION EMAIL FORMAT (MANDATORY)</p>
                      <p>This is to confirm that we have received your payment as per the details below:</p>
                      <p class="mt-2">Loan Number: {{Loan Number}}<br>
                        Amount Paid: {{Amount}}<br>
                        Date of Payment: {{Payment Date}}</p>
                    </div>
                    <p class="mt-4 text-sm text-slate-500"><strong>Rules:</strong> Follow SOP, Consistent Format, No
                      Sir/Ma'am, Greet by Name.</p>
                  </div>
                </div>

              </div>
            </div>
          </div>

          <div
            class="bg-slate-50 dark:bg-slate-800 p-6 rounded-3xl border border-slate-200 dark:border-slate-700 cursor-pointer"
            onclick="navigateTo('view-checklist')">
            <div class="flex items-center gap-4 mb-4">
              <div class="w-12 h-12 bg-teal-600 text-white rounded-xl flex items-center justify-center text-xl">üéØ</div>
              <div>
                <h3 class="text-xl font-bold">Quality Assurance Checklist</h3>
                <p class="text-slate-600 dark:text-slate-300">Click to view entity checklists.</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- CHECKLIST VIEW -->
    <div id="view-checklist" class="app-view bg-white dark:bg-slate-900">
      <header class="h-16 flex items-center px-6 border-b bg-white dark:bg-slate-800">
        <button onclick="navigateTo('view-resources')" class="font-bold text-slate-500 hover:text-blue-600">‚Üê Back to
          Resources</button>
        <span class="mx-auto font-bold">Quality Assurance Checklist</span>
      </header>

      <div class="max-w-6xl mx-auto px-6 py-14 text-center">
        <h1 class="text-3xl font-extrabold mb-12">Quality Assurance Checklist</h1>

        <ol class="text-left max-w-2xl mx-auto space-y-6 text-slate-700 dark:text-slate-300">
          <li onclick="openAgentPerformanceModal()"
            class="cursor-pointer hover:scale-105 transition-all duration-300 text-2xl font-bold p-6 rounded-2xl bg-gradient-to-r from-blue-600 to-blue-800 text-white shadow-lg hover:shadow-blue-500/50 flex items-center gap-4">
            <span class="bg-white/20 w-12 h-12 rounded-full flex items-center justify-center text-xl">üìÖ</span>
            Weekly Performance
          </li>
          <li onclick="alert('Monthly Performance data is coming soon.')"
            class="cursor-pointer hover:scale-105 transition-all duration-300 text-2xl font-bold p-6 rounded-2xl bg-gradient-to-r from-purple-600 to-purple-800 text-white shadow-lg hover:shadow-purple-500/50 flex items-center gap-4 opacity-75">
            <span class="bg-white/20 w-12 h-12 rounded-full flex items-center justify-center text-xl">üìÜ</span>
            Monthly Performance
          </li>
        </ol>
      </div>
    </div>

    <!-- RUPEE112 SPECIFIC VIEW -->
    <div id="view-rupee112" class="app-view bg-white dark:bg-slate-900">
      <header
        class="h-16 flex items-center justify-between px-6 border-b border-slate-200 dark:border-slate-700 bg-gradient-to-r from-green-500 to-red-600 text-white relative">
        <button onclick="navigateTo('view-entities')" class="font-bold text-white hover:text-blue-600">‚Üê Back to
          Entities</button>

        <button onclick="toggleDropdown('rupee112')" class="text-white hover:text-blue-600">Support üìû</button>
        <div id="support-dropdown-rupee112"
          class="hidden absolute top-full right-0 mt-2 bg-gradient-to-r from-green-500 to-red-600 text-white border border-slate-200 dark:border-slate-700 rounded-lg shadow-lg p-4 z-10">
          <h4 class="font-bold mb-2">Contact Support</h4>
          <p><strong>Call:</strong> 9220644112</p>
          <p><strong>Email:</strong> care@rupee112.com</p>
        </div>
      </header>

      <div class="max-w-5xl mx-auto px-6 py-14">
        <!-- Tabs -->
        <div class="flex border-b border-slate-200 dark:border-slate-700 mb-8">
          <button onclick="showTab('guidelines', 'rupee112')" id="tab-guidelines-rupee112"
            class="px-6 py-3 font-bold text-slate-500 border-b-2 border-transparent hover:text-slate-700">Guidelines</button>
          <button onclick="showTab('tools', 'rupee112')" id="tab-tools-rupee112"
            class="px-6 py-3 font-bold text-blue-600 border-b-2 border-blue-600">Our Operating Tools</button>
        </div>

        <!-- Guidelines Tab Content -->
        <div id="content-guidelines-rupee112" class="tab-content hidden">
          <div
            class="bg-green-50 dark:bg-slate-800 p-8 rounded-3xl border border-green-100 dark:border-slate-700 text-center">
            <div class="text-4xl mb-4">üìã</div>
            <h3 class="text-xl font-bold mb-2">Guidelines Coming Soon</h3>
            <p class="text-slate-600 dark:text-slate-400">Comprehensive brand guidelines and procedures will be
              available
              shortly.</p>
          </div>
        </div>

        <!-- Tools Tab Content -->
        <div id="content-tools-rupee112" class="tab-content">
          <div class="grid gap-6">
            <div
              class="group bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 p-6 rounded-3xl transition-all hover:shadow-lg">
              <div class="flex flex-col md:flex-row md:items-center justify-between gap-6">
                <div class="flex-1">
                  <h3 class="text-xl font-bold mb-2">Rupee112 Portal and Search Module</h3>
                  <p class="text-slate-600 dark:text-slate-300 text-sm leading-relaxed">
                    Main application processing, document view, and status checks. Customer search via PAN, Mobile, or
                    Email.
                  </p>
                </div>
                <a href="https://rupee112fintech.com/" target="_blank"
                  class="bg-blue-600 text-white font-bold py-3 px-6 rounded-xl hover:bg-blue-700 transition">Visit
                  Portal
                  ‚Üó</a>
              </div>
            </div>

            <div
              class="group bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 p-6 rounded-3xl transition-all hover:shadow-lg">
              <div class="flex flex-col md:flex-row md:items-center justify-between gap-6">
                <div class="flex-1">
                  <h3 class="text-xl font-bold mb-2">WOCOM 365</h3>
                  <p class="text-slate-600 dark:text-slate-300 text-sm leading-relaxed">
                    Telephony integration, lead management, and communication logging.
                  </p>
                </div>
                <a href="https://cpaas.wocom365.com/" target="_blank"
                  class="bg-emerald-600 text-white font-bold py-3 px-6 rounded-xl hover:bg-emerald-700 transition">Open
                  WOCOM ‚Üó</a>
              </div>
            </div>

            <div
              class="group bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 p-6 rounded-3xl transition-all hover:shadow-lg">
              <div class="flex flex-col md:flex-row md:items-center justify-between gap-6">
                <div class="flex-1">
                  <h3 class="text-xl font-bold mb-2">Yellow Ai</h3>
                  <p class="text-slate-600 dark:text-slate-300 text-sm leading-relaxed">
                    Handle real-time customer chats efficiently through the AI-powered cloud platform.
                  </p>
                </div>
                <a href="https://cloud.yellow.ai/auth/login" target="_blank"
                  class="bg-indigo-600 text-white font-bold py-3 px-6 rounded-xl hover:bg-indigo-700 transition">Login
                  Chat ‚Üó</a>
              </div>
            </div>

            <div
              class="group bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 p-6 rounded-3xl transition-all hover:shadow-lg">
              <div class="flex flex-col md:flex-row md:items-center justify-between gap-6">
                <div class="flex-1">
                  <h3 class="text-xl font-bold mb-2">Outlook (Care@rupee112.com)</h3>
                  <p class="text-slate-600 dark:text-slate-300 text-sm leading-relaxed">
                    Review customer emails and attachments. Standard channel for ticketing and complex queries.
                  </p>
                </div>
                <a href="https://outlook.office.com/mail/" target="_blank"
                  class="bg-amber-500 text-white font-bold py-3 px-6 rounded-xl hover:bg-amber-600 transition">Open Mail
                  ‚Üó</a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- LOAN112 SPECIFIC VIEW -->
    <div id="view-loan112" class="app-view bg-white dark:bg-slate-900">
      <header
        class="h-16 flex items-center justify-between px-6 border-b border-slate-200 dark:border-slate-700 bg-gradient-to-r from-blue-900 to-red-600 text-white relative">
        <button onclick="navigateTo('view-entities')" class="font-bold text-white hover:text-blue-600">‚Üê Back to
          Entities</button>

        <button onclick="toggleDropdown('loan112')" class="text-white hover:text-blue-600">Support üìû</button>
        <div id="support-dropdown-loan112"
          class="hidden absolute top-full right-0 mt-2 bg-gradient-to-r from-blue-900 to-red-600 text-white border border-slate-200 dark:border-slate-700 rounded-lg shadow-lg p-4 z-10">
          <h4 class="font-bold mb-2">Contact Support</h4>
          <p><strong>Call:</strong> 9311912970</p>
          <p><strong>Email:</strong> care@loan112.com</p>
        </div>
      </header>

      <div class="max-w-5xl mx-auto px-6 py-14">
        <!-- Tabs -->
        <div class="flex border-b border-slate-200 dark:border-slate-700 mb-8">
          <button onclick="showTab('guidelines', 'loan112')" id="tab-guidelines-loan112"
            class="px-6 py-3 font-bold text-slate-500 border-b-2 border-transparent hover:text-slate-700">Guidelines</button>
          <button onclick="showTab('tools', 'loan112')" id="tab-tools-loan112"
            class="px-6 py-3 font-bold text-blue-600 border-b-2 border-blue-600">Our Operating Tools</button>
        </div>

        <!-- Guidelines Tab Content -->
        <div id="content-guidelines-loan112" class="tab-content hidden">
          <div
            class="bg-blue-50 dark:bg-slate-800 p-8 rounded-3xl border border-blue-100 dark:border-slate-700 text-center">
            <div class="text-4xl mb-4">üìã</div>
            <h3 class="text-xl font-bold mb-2">Guidelines Coming Soon</h3>
            <p class="text-slate-600 dark:text-slate-400">Comprehensive brand guidelines and procedures will be
              available
              shortly.</p>
          </div>
        </div>

        <!-- Tools Tab Content -->
        <div id="content-tools-loan112" class="tab-content">
          <div class="grid gap-6">
            <div
              class="group bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 p-6 rounded-3xl transition-all hover:shadow-lg">
              <div class="flex flex-col md:flex-row md:items-center justify-between gap-6">
                <div class="flex-1">
                  <h3 class="text-xl font-bold mb-2">Loan112 Portal and Search Module</h3>
                  <p class="text-slate-600 dark:text-slate-300 text-sm leading-relaxed">
                    Main application processing, document view, and status checks. Customer search via PAN, Mobile, or
                    Email.
                  </p>
                </div>
                <a href="https://loan112fintech.com/" target="_blank"
                  class="bg-blue-600 text-white font-bold py-3 px-6 rounded-xl hover:bg-blue-700 transition">Visit
                  Portal
                  ‚Üó</a>
              </div>
            </div>

            <div
              class="group bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 p-6 rounded-3xl transition-all hover:shadow-lg">
              <div class="flex flex-col md:flex-row md:items-center justify-between gap-6">
                <div class="flex-1">
                  <h3 class="text-xl font-bold mb-2">WOCOM 365</h3>
                  <p class="text-slate-600 dark:text-slate-300 text-sm leading-relaxed">
                    Telephony integration, lead management, and communication logging.
                  </p>
                </div>
                <a href="https://cpaas.wocom365.com/" target="_blank"
                  class="bg-emerald-600 text-white font-bold py-3 px-6 rounded-xl hover:bg-emerald-700 transition">Open
                  WOCOM ‚Üó</a>
              </div>
            </div>

            <div
              class="group bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 p-6 rounded-3xl transition-all hover:shadow-lg">
              <div class="flex flex-col md:flex-row md:items-center justify-between gap-6">
                <div class="flex-1">
                  <h3 class="text-xl font-bold mb-2">Yellow Ai</h3>
                  <p class="text-slate-600 dark:text-slate-300 text-sm leading-relaxed">
                    Handle real-time customer chats efficiently through the AI-powered cloud platform.
                  </p>
                </div>
                <a href="https://cloud.yellow.ai/auth/login" target="_blank"
                  class="bg-indigo-600 text-white font-bold py-3 px-6 rounded-xl hover:bg-indigo-700 transition">Login
                  Chat ‚Üó</a>
              </div>
            </div>

            <div
              class="group bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 p-6 rounded-3xl transition-all hover:shadow-lg">
              <div class="flex flex-col md:flex-row md:items-center justify-between gap-6">
                <div class="flex-1">
                  <h3 class="text-xl font-bold mb-2">Outlook (Care@loan112.com)</h3>
                  <p class="text-slate-600 dark:text-slate-300 text-sm leading-relaxed">
                    Review customer emails and attachments. Standard channel for ticketing and complex queries.
                  </p>
                </div>
                <a href="https://outlook.office.com/mail/" target="_blank"
                  class="bg-amber-500 text-white font-bold py-3 px-6 rounded-xl hover:bg-amber-600 transition">Open Mail
                  ‚Üó</a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- RUPEEONTIME SPECIFIC VIEW -->
    <div id="view-rupeeontime" class="app-view bg-white dark:bg-slate-900">
      <header
        class="h-16 flex items-center justify-between px-6 border-b border-slate-200 dark:border-slate-700 bg-gradient-to-r from-purple-600 to-red-600 text-white relative">
        <button onclick="navigateTo('view-entities')" class="font-bold text-white hover:text-blue-600">‚Üê Back to
          Entities</button>

        <button onclick="toggleDropdown('rupeeontime')" class="text-white hover:text-blue-600">Support üìû</button>
        <div id="support-dropdown-rupeeontime"
          class="hidden absolute top-full right-0 mt-2 bg-gradient-to-r from-purple-600 to-red-600 text-white border border-slate-200 dark:border-slate-700 rounded-lg shadow-lg p-4 z-10">
          <h4 class="font-bold mb-2">Contact Support</h4>
          <p><strong>Call:</strong> 9220912304</p>
          <p><strong>Email:</strong> care@rupeeontime.com</p>
        </div>
      </header>

      <div class="max-w-5xl mx-auto px-6 py-14">
        <!-- Tabs -->
        <div class="flex border-b border-slate-200 dark:border-slate-700 mb-8">
          <button onclick="showTab('guidelines', 'rupeeontime')" id="tab-guidelines-rupeeontime"
            class="px-6 py-3 font-bold text-slate-500 border-b-2 border-transparent hover:text-slate-700">Guidelines</button>
          <button onclick="showTab('tools', 'rupeeontime')" id="tab-tools-rupeeontime"
            class="px-6 py-3 font-bold text-blue-600 border-b-2 border-blue-600">Our Operating Tools</button>
        </div>

        <!-- Guidelines Tab Content -->
        <div id="content-guidelines-rupeeontime" class="tab-content hidden">
          <div
            class="bg-purple-50 dark:bg-slate-800 p-8 rounded-3xl border border-purple-100 dark:border-slate-700 text-center">
            <div class="text-4xl mb-4">üìã</div>
            <h3 class="text-xl font-bold mb-2">Guidelines Coming Soon</h3>
            <p class="text-slate-600 dark:text-slate-400">Comprehensive brand guidelines and procedures will be
              available
              shortly.</p>
          </div>
        </div>

        <!-- Tools Tab Content -->
        <div id="content-tools-rupeeontime" class="tab-content">
          <div class="grid gap-6">
            <div
              class="group bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 p-6 rounded-3xl transition-all hover:shadow-lg">
              <div class="flex flex-col md:flex-row md:items-center justify-between gap-6">
                <div class="flex-1">
                  <h3 class="text-xl font-bold mb-2">RupeeOnTime Portal and Search Module</h3>
                  <p class="text-slate-600 dark:text-slate-300 text-sm leading-relaxed">
                    Main application processing, document view, and status checks. Customer search via PAN, Mobile, or
                    Email.
                  </p>
                </div>
                <a href="https://rotfintech.com/" target="_blank"
                  class="bg-blue-600 text-white font-bold py-3 px-6 rounded-xl hover:bg-blue-700 transition">Visit
                  Portal
                  ‚Üó</a>
              </div>
            </div>

            <div
              class="group bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 p-6 rounded-3xl transition-all hover:shadow-lg">
              <div class="flex flex-col md:flex-row md:items-center justify-between gap-6">
                <div class="flex-1">
                  <h3 class="text-xl font-bold mb-2">WOCOM 365</h3>
                  <p class="text-slate-600 dark:text-slate-300 text-sm leading-relaxed">
                    Telephony integration, lead management, and communication logging.
                  </p>
                </div>
                <a href="https://cpaas.wocom365.com/" target="_blank"
                  class="bg-emerald-600 text-white font-bold py-3 px-6 rounded-xl hover:bg-emerald-700 transition">Open
                  WOCOM ‚Üó</a>
              </div>
            </div>

            <div
              class="group bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 p-6 rounded-3xl transition-all hover:shadow-lg">
              <div class="flex flex-col md:flex-row md:items-center justify-between gap-6">
                <div class="flex-1">
                  <h3 class="text-xl font-bold mb-2">Yellow Ai</h3>
                  <p class="text-slate-600 dark:text-slate-300 text-sm leading-relaxed">
                    Handle real-time customer chats efficiently through the AI-powered cloud platform.
                  </p>
                </div>
                <a href="https://cloud.yellow.ai/auth/login" target="_blank"
                  class="bg-indigo-600 text-white font-bold py-3 px-6 rounded-xl hover:bg-indigo-700 transition">Login
                  Chat ‚Üó</a>
              </div>
            </div>

            <div
              class="group bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 p-6 rounded-3xl transition-all hover:shadow-lg">
              <div class="flex flex-col md:flex-row md:items-center justify-between gap-6">
                <div class="flex-1">
                  <h3 class="text-xl font-bold mb-2">Outlook (Care@rupeeontime.com)</h3>
                  <p class="text-slate-600 dark:text-slate-300 text-sm leading-relaxed">
                    Review customer emails and attachments. Standard channel for ticketing and complex queries.
                  </p>
                </div>
                <a href="https://outlook.office.com/mail/" target="_blank"
                  class="bg-amber-500 text-white font-bold py-3 px-6 rounded-xl hover:bg-amber-600 transition">Open Mail
                  ‚Üó</a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- PERFORMANCE VIEW (AGENT DASHBOARD) -->
    <div id="view-performance" class="app-view bg-white dark:bg-slate-900">
      <header class="h-16 flex items-center px-6 border-b bg-white dark:bg-slate-800 justify-between">
        <div class="flex items-center gap-4">
          <button onclick="navigateTo('view-checklist')" class="font-bold text-slate-500 hover:text-blue-600">‚Üê
            Back</button>
          <span id="agent-dashboard-title" class="font-bold text-xl">Agent Dashboard</span>
        </div>
        <button onclick="logout()" class="text-slate-500 hover:text-red-500 font-medium">Logout</button>
      </header>

      <div class="max-w-6xl mx-auto px-6 py-10">

        <!-- Welcome Banner -->
        <div class="mb-12 p-8 rounded-3xl bg-gradient-to-r from-indigo-600 to-purple-600 text-white shadow-xl">
          <h1 class="text-3xl font-extrabold mb-2">Hello, <span id="agent-name-display">Agent</span> üëã</h1>
          <p class="opacity-90">Keep up the great work! Check your latest performance reviews below.</p>
        </div>

        <!-- Dashboard Grid -->
        <div class="grid grid-cols-1 max-w-2xl mx-auto gap-8">

          <!-- Weekly Performance Tab/Card -->
          <div onclick="openAgentPerformanceModal()"
            class="cursor-pointer group bg-white dark:bg-slate-800 p-8 rounded-3xl border border-slate-200 dark:border-slate-700 hover:shadow-2xl hover:-translate-y-2 transition-all duration-300 relative overflow-hidden">
            <div class="absolute top-0 right-0 p-4 opacity-5 group-hover:opacity-10 transition">
              <span class="text-9xl">üìà</span>
            </div>

            <div
              class="w-16 h-16 rounded-2xl bg-indigo-50 dark:bg-slate-700 flex items-center justify-center text-3xl mb-6 text-indigo-600">
              üéØ
            </div>

            <h3 class="text-2xl font-bold mb-2">Weekly Performance</h3>
            <p class="text-slate-500 text-sm mb-6">Review your audit scores, compliance stats, and proofs.</p>

            <div class="flex items-center gap-2 text-indigo-600 font-bold group-hover:gap-4 transition-all">
              <span>View Details</span>
              <span>‚Üí</span>
            </div>
          </div>


        </div>
      </div>
    </div>

    <!-- AGENT PERFORMANCE MODAL -->
    <div id="agent-performance-modal"
      class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4">
      <div
        class="bg-white dark:bg-slate-900 w-full max-w-5xl h-[90vh] rounded-[2rem] shadow-2xl overflow-hidden flex flex-col animate-scale-up">

        <!-- Modal Header -->
        <div
          class="p-6 border-b border-slate-100 dark:border-slate-800 flex items-center justify-between bg-white dark:bg-slate-900 z-10">
          <div>
            <h2 class="text-2xl font-extrabold flex items-center gap-2">
              <span>üìä</span> Weekly Performance Review
            </h2>
            <p class="text-xs text-slate-500 font-mono mt-1" id="modal-agent-id">ID: --</p>
          </div>
          <button onclick="closeAgentPerformanceModal()"
            class="w-10 h-10 rounded-full bg-slate-100 dark:bg-slate-800 flex items-center justify-center text-slate-500 hover:bg-red-50 hover:text-red-500 transition font-bold text-xl">&times;</button>
        </div>

        <!-- Modal Content (Scrollable) -->
        <div class="flex-1 overflow-y-auto p-8">

          <div id="perf-content-loaded" class="space-y-10">

            <!-- Performance Stats Cards -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
              <div
                class="p-6 bg-blue-50 dark:bg-slate-800 rounded-2xl border border-blue-100 dark:border-slate-700 text-center">
                <p class="text-xs font-bold uppercase text-slate-400 mb-2">No. of Audits</p>
                <div id="modal-audit-count" class="text-4xl font-black text-blue-600">--</div>
              </div>
              <div
                class="p-6 bg-red-50 dark:bg-slate-800 rounded-2xl border border-red-100 dark:border-slate-700 text-center">
                <p class="text-xs font-bold uppercase text-slate-400 mb-2">Fatal Errors (Score 0)</p>
                <div id="modal-fatal-count" class="text-4xl font-black text-red-600">--</div>
              </div>
              <div
                class="p-6 bg-emerald-50 dark:bg-slate-800 rounded-2xl border border-emerald-100 dark:border-slate-700 text-center">
                <p class="text-xs font-bold uppercase text-slate-400 mb-2">Good (Score 100)</p>
                <div id="modal-good-count" class="text-4xl font-black text-emerald-600">--</div>
              </div>
              <div
                class="p-6 bg-indigo-50 dark:bg-slate-800 rounded-2xl border border-indigo-100 dark:border-slate-700 text-center">
                <p class="text-xs font-bold uppercase text-slate-400 mb-2">Total Score</p>
                <div id="modal-total-score" class="text-4xl font-black text-indigo-600">--</div>
              </div>
            </div>

            <!-- Detailed Reviews List -->
            <div>
              <h3 class="text-xl font-bold mb-4 flex items-center gap-2">
                <span class="bg-indigo-100 dark:bg-slate-700 text-indigo-600 p-2 rounded-lg text-sm">üìã</span>
                Quality Reviews
              </h3>
              <div id="modal-reviews-list" class="space-y-4">
                <!-- Reviews will be populated here by JS -->
              </div>
            </div>

            <!-- Comment Section -->
            <div class="bg-slate-50 dark:bg-slate-800 p-6 rounded-2xl border border-slate-200 dark:border-slate-700">
              <h3 class="text-lg font-bold mb-4">üí¨ Add Your Feedback/Comments</h3>
              <textarea id="agent-comment-input" rows="4"
                class="w-full p-4 rounded-xl border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-900 focus:ring-2 focus:ring-indigo-500 outline-none transition mb-4"
                placeholder="Write your comments or feedback regarding these reviews..."></textarea>
              <button onclick="agentSubmitComment()"
                class="bg-indigo-600 text-white font-bold py-3 px-8 rounded-xl hover:bg-indigo-700 transition shadow-lg shadow-indigo-500/30">Send
                Feedback</button>
            </div>

          </div>

          <!-- Empty State -->
          <div id="perf-content-empty"
            class="hidden h-full flex flex-col items-center justify-center text-center opacity-50 py-20">
            <div class="text-6xl mb-4">üì≠</div>
            <h3 class="text-xl font-bold">No performance review available yet.</h3>
          </div>

        </div>
      </div>
    </div>

    <!-- ADMIN DASHBOARD -->
    <div id="view-admin" class="app-view bg-white dark:bg-slate-900">
      <header class="h-16 flex items-center px-6 border-b bg-white dark:bg-slate-800 justify-between">
        <div class="flex items-center gap-4">
          <span class="font-bold text-xl text-indigo-600">Admin Dashboard - <span
              id="admin-entity-display">--</span></span>
        </div>
        <button onclick="logout()" class="text-slate-500 hover:text-red-500 font-medium">Logout</button>
      </header>

      <div class="max-w-6xl mx-auto px-6 py-10">
        <!-- Week Management -->
        <div class="flex flex-wrap justify-end gap-4 mb-8">
          <button onclick="adminResetWeeklyData()"
            class="bg-red-100 text-red-700 border border-red-200 font-bold py-3 px-6 rounded-xl hover:bg-red-200 transition flex items-center gap-2">
            <span>üîÑ</span> Reset Data for This Week
          </button>
          <button onclick="adminFinalSubmitWeek()" id="btn-final-submit-week" disabled
            class="bg-green-600 text-white font-bold py-3 px-6 rounded-xl hover:bg-green-700 transition opacity-50 cursor-not-allowed flex items-center gap-2 shadow-lg">
            <span>üìÖ</span> Final Submit for This Week
          </button>
        </div>

        <!-- Section 1: Select Agent Only -->
        <div class="bg-blue-50 dark:bg-slate-800 p-8 rounded-3xl mb-12 border border-blue-200 dark:border-slate-700">
          <h2 class="text-2xl font-bold mb-6 flex items-center gap-3">
            <span class="bg-blue-600 text-white rounded-lg p-2 text-xl">üë•</span>
            Select Agent
          </h2>

          <!-- Agent Selection -->
          <!-- Agent Selection Dropdown -->
          <div class="mb-6">
            <label class="block text-sm font-semibold mb-2 text-slate-600 dark:text-slate-400">Choose an Agent to
              Review</label>
            <select id="admin-agent-selector" onchange="adminSelectAgentFromDropdown(this)"
              class="w-full p-4 rounded-xl border-2 border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 font-bold text-lg focus:border-blue-500 outline-none transition cursor-pointer">
              <option value="">-- Click to Select Agent --</option>
            </select>
          </div>

          <!-- Interaction Type Selection -->
          <div id="admin-interaction-type-section" class="hidden mb-8 animate-fade-in">
            <label class="block text-sm font-semibold mb-3 text-slate-600 dark:text-slate-400">Select Interaction
              Type</label>
            <div class="flex gap-4">
              <label class="flex-1 cursor-pointer group">
                <input type="radio" name="interaction-type" value="voice" class="peer hidden"
                  onchange="adminHandleInteractionTypeStart()">
                <div
                  class="p-6 rounded-2xl border-2 border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-700 peer-checked:border-blue-500 peer-checked:bg-blue-50 dark:peer-checked:bg-blue-900/20 peer-checked:shadow-lg transition flex flex-col items-center gap-2 group-hover:border-blue-300">
                  <span class="text-3xl">üé§</span>
                  <span class="font-bold text-lg">Voice Process</span>
                  <span class="text-xs text-slate-500">Audio Recording</span>
                </div>
              </label>
              <label class="flex-1 cursor-pointer group">
                <input type="radio" name="interaction-type" value="non-voice" class="peer hidden"
                  onchange="adminHandleInteractionTypeStart()">
                <div
                  class="p-6 rounded-2xl border-2 border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-700 peer-checked:border-purple-500 peer-checked:bg-purple-50 dark:peer-checked:bg-purple-900/20 peer-checked:shadow-lg transition flex flex-col items-center gap-2 group-hover:border-purple-300">
                  <span class="text-3xl">üí¨</span>
                  <span class="font-bold text-lg">Non-Voice Process</span>
                  <span class="text-xs text-slate-500">Chat / Email</span>
                </div>
              </label>
            </div>
          </div>

          <button id="admin-start-review-btn" onclick="adminStartQualityReview()" disabled
            class="hidden w-full bg-slate-800 text-white font-bold py-4 px-8 rounded-xl hover:bg-slate-900 transition shadow-xl">
            Start Quality Review Check
          </button>
        </div>

        <!-- Section 2: Quality Review Form (Hidden initially) -->
        <div id="admin-quality-form-section"
          class="hidden bg-emerald-50 dark:bg-slate-800 p-8 rounded-3xl mb-12 border border-emerald-200 dark:border-slate-700">
          <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl font-bold flex items-center gap-3">
              <span class="bg-emerald-600 text-white rounded-lg p-2 text-xl">üìù</span>
              Quality Review - <span id="admin-review-agent-display" class="text-emerald-600"></span>
            </h2>
            <button onclick="adminCancelReview()" class="text-slate-500 hover:text-slate-700 text-sm font-medium">‚Üê
              Back</button>
          </div>

          <div id="admin-review-items-container" class="space-y-6">
            <!-- Review items will be dynamically added here -->
          </div>

          <div class="flex gap-3 mt-8">
            <button onclick="adminAddReviewItem()" id="admin-add-review-btn"
              class="flex-1 bg-blue-600 text-white font-bold py-3 px-8 rounded-xl hover:bg-blue-700 transition">
              ‚ûï Add Review (Min 3, Max 10)
            </button>
            <button onclick="adminFinalSubmit()" id="admin-final-submit-btn" disabled
              class="flex-1 bg-green-600 text-white font-bold py-3 px-8 rounded-xl hover:bg-green-700 transition opacity-50 cursor-not-allowed">
              ‚úÖ Final Submit
            </button>
          </div>
        </div>

        <!-- Section 3: Submitted Reviews -->
        <div class="mb-12">
          <h2 class="text-2xl font-bold mb-6 flex items-center gap-3">
            <span class="bg-indigo-600 text-white rounded-lg p-2 text-xl">üìã</span>
            Submitted Reviews
          </h2>
          <div class="overflow-x-auto rounded-3xl border border-slate-200 dark:border-slate-700">
            <table class="w-full bg-white dark:bg-slate-800 text-left border-collapse">
              <thead class="bg-slate-50 dark:bg-slate-700 text-slate-500 uppercase text-xs">
                <tr>
                  <th class="p-6">Date</th>
                  <th class="p-6">Agent</th>
                  <th class="p-6">File</th>
                  <th class="p-6">Score</th>
                  <th class="p-6">Observation</th>
                  <th class="p-6 text-right">Action</th>
                </tr>
              </thead>
              <tbody id="admin-reviews-list" class="divide-y divide-slate-100 dark:divide-slate-700">
                <!-- JS Populates this -->
              </tbody>
            </table>
          </div>
        </div>

        <!-- Section 4: Agent Feedback -->
        <div>
          <h2 class="text-2xl font-bold mb-6 flex items-center gap-3">
            <span class="bg-amber-600 text-white rounded-lg p-2 text-xl">üí¨</span>
            Agent Comments
          </h2>
          <div class="mb-4">
            <button onclick="adminDeleteAllFeedback()"
              class="bg-red-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-red-700 transition text-sm">
              üóëÔ∏è Delete All Feedback
            </button>
          </div>
          <div class="overflow-x-auto rounded-3xl border border-slate-200 dark:border-slate-700">
            <table class="w-full bg-white dark:bg-slate-800 text-left border-collapse">
              <thead class="bg-slate-50 dark:bg-slate-700 text-slate-500 uppercase text-xs">
                <tr>
                  <th class="p-6">Date</th>
                  <th class="p-6">Agent</th>
                  <th class="p-6">Feedback</th>
                  <th class="p-6 text-right">Action</th>
                </tr>
              </thead>
              <tbody id="admin-feedback-list" class="divide-y divide-slate-100 dark:divide-slate-700">
                <!-- JS Populates this -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- LOGIN MODAL -->
    <div id="login-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div class="bg-white dark:bg-slate-800 p-8 rounded-3xl shadow-lg max-w-md w-full mx-4">
        <div class="flex justify-between items-center mb-6">
          <h2 id="login-title" class="text-2xl font-bold">Login</h2>
          <button onclick="hideLogin()" class="text-slate-500 hover:text-slate-700 text-2xl">&times;</button>
        </div>
        <form onsubmit="submitLogin(event)">
          <div class="mb-6">
            <label class="block text-sm font-medium mb-2">Employee ID</label>
            <input id="empid" type="text" required
              class="w-full px-4 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-slate-50 dark:bg-slate-700">
          </div>

          <button type="submit"
            class="w-full bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition">Login</button>
        </form>
      </div>
    </div>

    <!-- ACCESS DENIED MODAL -->
    <div id="access-denied-modal"
      class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div class="bg-white dark:bg-slate-800 p-8 rounded-3xl shadow-lg max-w-md w-full mx-4">
        <div class="flex justify-between items-center mb-6">
          <h2 id="access-denied-title" class="text-2xl font-bold text-red-600">Access Denied</h2>
          <button onclick="document.getElementById('access-denied-modal').classList.add('hidden')"
            class="text-slate-500 hover:text-slate-700 text-2xl">&times;</button>
        </div>
        <p class="text-slate-600 dark:text-slate-400 mb-6">You do not have permission to access this entity. Please use
          the correct Employee ID for the selected entity.</p>
        <button onclick="document.getElementById('access-denied-modal').classList.add('hidden')"
          class="w-full bg-red-600 text-white py-2 px-4 rounded-lg hover:bg-red-700 transition">Close</button>
      </div>
    </div>

    <!-- EDIT REVIEW MODAL -->
    <div id="admin-edit-review-modal"
      class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4">
      <div class="bg-white dark:bg-slate-800 p-8 rounded-3xl shadow-lg max-w-lg w-full">
        <h3 class="text-2xl font-bold mb-6">Edit Review</h3>

        <!-- Score -->
        <div class="mb-4">
          <label class="block text-sm font-medium mb-2">Score</label>
          <div class="flex gap-4">
            <label
              class="flex items-center gap-2 cursor-pointer bg-emerald-50 dark:bg-slate-700 p-3 rounded-xl border border-emerald-100 dark:border-slate-600">
              <input type="radio" name="edit-score" value="100" class="w-5 h-5 text-emerald-600">
              <span class="font-bold text-emerald-600">100 (Pass)</span>
            </label>
            <label
              class="flex items-center gap-2 cursor-pointer bg-red-50 dark:bg-slate-700 p-3 rounded-xl border border-red-100 dark:border-slate-600">
              <input type="radio" name="edit-score" value="0" class="w-5 h-5 text-red-600">
              <span class="font-bold text-red-600">0 (Fatal/Fail)</span>
            </label>
          </div>
        </div>

        <!-- Observation -->
        <div class="mb-4">
          <label class="block text-sm font-medium mb-2">Observation</label>
          <textarea id="edit-observation" rows="3"
            class="w-full px-4 py-2 rounded-lg border border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 focus:ring-2 focus:ring-blue-500 outline-none"></textarea>
        </div>

        <!-- File -->
        <div class="mb-6">
          <label class="block text-sm font-medium mb-2">Update File (Optional)</label>
          <p class="text-xs text-slate-500 mb-2">Current: <span id="edit-current-filename"
              class="font-mono font-bold"></span></p>
          <input type="file" id="edit-file-upload"
            class="w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
        </div>

        <div class="flex gap-3">
          <button onclick="adminSaveEdit()" id="btn-save-edit"
            class="flex-1 bg-blue-600 text-white font-bold py-3 rounded-xl hover:bg-blue-700 transition">Save
            Changes</button>
          <button onclick="document.getElementById('admin-edit-review-modal').classList.add('hidden')"
            class="px-6 py-3 rounded-xl border border-slate-300 hover:bg-slate-50 dark:border-slate-600 dark:hover:bg-slate-700 transition">Cancel</button>
        </div>
      </div>
    </div>

    <script>
      // MOCK BACKEND
      class MockBackend {
        static getReports() {
          return JSON.parse(localStorage.getItem('gojira_reports') || '[]');
        }

        static addReport(file, content) {
          const reports = this.getReports();
          reports.unshift({
            id: Date.now(),
            name: file.name,
            type: file.type || 'Unknown',
            date: new Date().toLocaleString(),
            uploader: 'Admin',
            content: content // Store Base64 string
          });
          // Limit storage to prevent quota exceeded (keep last 5)
          if (reports.length > 5) reports.pop();
          localStorage.setItem('gojira_reports', JSON.stringify(reports));
        }

        static getComments() {
          return JSON.parse(localStorage.getItem('gojira_comments') || '[]');
        }

        static addComment(text, agentId) {
          const comments = this.getComments();
          comments.unshift({
            id: Date.now(),
            text,
            agentId,
            date: new Date().toLocaleString()
          });
          localStorage.setItem('gojira_comments', JSON.stringify(comments));
        }

        static deleteComment(id) {
          const comments = this.getComments().filter(c => c.id != id);
          localStorage.setItem('gojira_comments', JSON.stringify(comments));
        }

        static deleteReport(id) {
          const reports = this.getReports().filter(r => r.id != id);
          localStorage.setItem('gojira_reports', JSON.stringify(reports));
        }

        // PERFORMANCE DATA
        static getPerformance(agentId) {
          const db = JSON.parse(localStorage.getItem('gojira_performance') || '{}');
          return db[agentId] || null;
        }

        static savePerformance(agentId, data) {
          const db = JSON.parse(localStorage.getItem('gojira_performance') || '{}');
          db[agentId] = {
            ...data,
            lastUpdated: new Date().toLocaleString()
          };
          localStorage.setItem('gojira_performance', JSON.stringify(db));
        }

        static savePerformanceScore(performanceData) {
          const scores = JSON.parse(localStorage.getItem('gojira_performance_scores') || '[]');
          scores.unshift({
            id: Date.now(),
            ...performanceData
          });
          // Keep only last 50 scores to prevent storage bloat
          if (scores.length > 50) scores.pop();
          localStorage.setItem('gojira_performance_scores', JSON.stringify(scores));

          // Update the agent's current performance score
          const currentPerf = this.getPerformance(performanceData.agentId) || {};
          this.savePerformance(performanceData.agentId, {
            score: performanceData.score,
            isFatal: performanceData.isFatal,
            lastReviewDate: new Date().toLocaleString(),
            reviewerId: performanceData.reviewerId
          });
        }

        static getPerformanceScores() {
          return JSON.parse(localStorage.getItem('gojira_performance_scores') || '[]');
        }

        static deletePerformanceScore(scoreId) {
          const scores = this.getPerformanceScores();
          const scoreToDelete = scores.find(s => s.id == scoreId);

          if (scoreToDelete) {
            // Remove the score
            const updatedScores = scores.filter(s => s.id != scoreId);
            localStorage.setItem('gojira_performance_scores', JSON.stringify(updatedScores));

            // Check if this was the agent's most recent score
            const agentScores = updatedScores.filter(s => s.agentId === scoreToDelete.agentId);
            if (agentScores.length === 0) {
              // No more scores for this agent, remove their performance record
              const performanceDb = JSON.parse(localStorage.getItem('gojira_performance') || '{}');
              delete performanceDb[scoreToDelete.agentId];
              localStorage.setItem('gojira_performance', JSON.stringify(performanceDb));
            } else {
              // Update with the most recent remaining score
              const latestScore = agentScores.reduce((latest, current) =>
                new Date(current.timestamp) > new Date(latest.timestamp) ? current : latest
              );
              this.savePerformance(scoreToDelete.agentId, {
                score: latestScore.score,
                isFatal: latestScore.isFatal,
                lastReviewDate: new Date(latestScore.timestamp).toLocaleString(),
                reviewerId: latestScore.reviewerId
              });
            }
          }
        }

        static clearAllPerformanceData() {
          // Clear all performance scores history
          localStorage.removeItem('gojira_performance_scores');
          // Clear all current performance records
          localStorage.removeItem('gojira_performance');
        }
      }

      // NOTIFICATION MANAGER
      class NotificationManager {
        static getNotifications() {
          return JSON.parse(localStorage.getItem('gojira_notifications') || '[]');
        }

        static add(recipientRole, recipientId, message) {
          const notifs = this.getNotifications();
          notifs.unshift({
            id: Date.now(),
            recipientRole,
            recipientId,
            message,
            read: false,
            date: new Date().toLocaleString()
          });
          localStorage.setItem('gojira_notifications', JSON.stringify(notifs));
          this.updateIcon();
        }

        static notifyAgent(agentId, message) {
          this.add('agent', agentId, message);
        }

        static notifyAdmin(message) {
          this.add('admin', 'ALL', message);
        }

        static updateIcon() {
          if (!currentUser) return;
          const notifs = this.getNotifications();
          // Filter for current user
          const myNotifs = notifs.filter(n => {
            if (n.read) return false;
            if (n.recipientRole === 'admin' && currentUser.role === 'admin') return true;
            if (n.recipientRole === 'agent' && n.recipientId === currentUser.id) return true;
            return false;
          });

          const dot = document.getElementById('nav-notification-dot');
          if (myNotifs.length > 0) {
            dot.classList.remove('hidden');
          } else {
            dot.classList.add('hidden');
          }
        }

        static renderDropdown() {
          const list = document.getElementById('notification-list');
          const notifs = this.getNotifications();

          // Filter for current user
          const myNotifs = notifs.filter(n => {
            if (n.recipientRole === 'admin' && currentUser.role === 'admin') return true;
            if (n.recipientRole === 'agent' && n.recipientId === currentUser.id) return true;
            return false;
          });

          if (myNotifs.length === 0) {
            list.innerHTML = '<div class="p-4 text-center text-slate-500 text-sm">‚ú®there\'s no any notifications.</div>';
            return;
          }

          list.innerHTML = myNotifs.map(n => `
             <div class="p-3 border-b border-slate-100 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-700/50 transition cursor-pointer ${n.read ? 'opacity-60' : 'font-semibold'}" onclick="NotificationManager.markRead(${n.id})">
               <p class="text-sm">${n.message}</p>
               <p class="text-xs text-slate-400 mt-1">${n.date}</p>
             </div>
           `).join('');
        }

        static markRead(id) {
          const notifs = this.getNotifications();
          const target = notifs.find(n => n.id === id);
          if (target) {
            target.read = true;
            localStorage.setItem('gojira_notifications', JSON.stringify(notifs));
            this.updateIcon();
            this.renderDropdown();
          }
        }

        static clearAll() {
          // Only clear for this user
          let notifs = this.getNotifications();
          notifs = notifs.filter(n => {
            // Keep notifications NOT for this user
            if (n.recipientRole === 'admin' && currentUser.role === 'admin') return false;
            if (n.recipientRole === 'agent' && n.recipientId === currentUser.id) return false;
            return true;
          });
          localStorage.setItem('gojira_notifications', JSON.stringify(notifs));
          this.updateIcon();
          this.renderDropdown();
        }
      }

      // ADMIN & AGENT FUNCTIONS
      function renderAdminDashboard() {
        // 1. Set Entity Header
        const entityContext = currentEntity || 'ALL'; // Fallback
        document.getElementById('admin-current-entity-name').innerText = entityContext === 'ALL' ? 'All Entities' : entityContext;

        // 2. Populate Agent Selector Dropdown
        const agentSelector = document.getElementById('agent-selector');

        // Filter Agents
        let agents = USER_DB.filter(u => u.role === 'agent');
        if (entityContext !== 'ALL') {
          agents = agents.filter(u => u.entity === entityContext);
        }

        // Clear existing options except the first one
        agentSelector.innerHTML = '<option value="">Choose an agent...</option>';

        // Add agent options
        agents.forEach(agent => {
          const perf = MockBackend.getPerformance(agent.id);
          const pendingReviews = getPendingReviews(agent.id);
          const reviewProgress = pendingReviews.length > 0 ? ` (${pendingReviews.length}/3 reviews)` : '';
          const scoreText = perf ? `${perf.score}%` : 'Not Scored';
          const option = document.createElement('option');
          option.value = agent.id;
          option.textContent = `${agent.name} (${agent.id}) - ${scoreText}${reviewProgress}`;
          agentSelector.appendChild(option);
        });

        // 3. Populate Reports Table
        const reports = MockBackend.getReports();
        const reportsList = document.getElementById('admin-reports-list');
        if (reports.length === 0) {
          reportsList.innerHTML = '<tr><td colspan="4" class="p-6 text-center text-slate-400">No reports uploaded yet.</td></tr>';
        } else {
          reportsList.innerHTML = reports.map(r => `
          <tr class="hover:bg-slate-50 dark:hover:bg-slate-700/50">
            <td class="p-6">${r.date}</td>
            <td class="p-6">${r.name}</td>
            <td class="p-6">${r.type || 'Unknown'}</td>
            <td class="p-6 text-right">
              <button onclick="openReport('${r.content}', '${r.type}')" class="text-blue-600 hover:text-blue-800 mr-2">View</button>
              <button onclick="handleDeleteReport(${r.id})" class="text-red-600 hover:text-red-800">Delete</button>
            </td>
          </tr>
        `).join('');
        }

        // 4. Populate Performance Reviews Table
        const reviews = MockBackend.getPerformanceScores();
        const reviewsList = document.getElementById('admin-reviews-list');
        if (reviews.length === 0) {
          reviewsList.innerHTML = '<tr><td colspan="6" class="p-6 text-center text-slate-400">No performance reviews yet.</td></tr>';
        } else {
          reviewsList.innerHTML = reviews.map(r => {
            const agent = USER_DB.find(u => u.id === r.agentId);
            const agentName = agent ? agent.name : r.agentId;
            const scoreClass = r.score === 100 ? 'text-emerald-600' : 'text-red-600';
            const scoreText = r.score === 0 ? '0 (Fatal)' : r.score;
            const date = new Date(r.timestamp).toLocaleString();

            return `
            <tr class="hover:bg-slate-50 dark:hover:bg-slate-700/50">
              <td class="p-6">${date}</td>
              <td class="p-6">${agentName}</td>
              <td class="p-6"><span class="${scoreClass} font-bold">${scoreText}</span></td>
              <td class="p-6">--</td>
              <td class="p-6">${r.feedbackData.fileName}</td>
              <td class="p-6 text-right">
                <button onclick="viewReviewDetails(${r.id})" class="text-blue-600 hover:text-blue-800 mr-2">View</button>
                <button onclick="handleDeleteReview(${r.id})" class="text-red-600 hover:text-red-800">Delete</button>
              </td>
            </tr>
          `;
          }).join('');
        }

        // 5. Populate Comments Table
        const comments = MockBackend.getComments();
        const commentsList = document.getElementById('admin-comments-list');
        if (comments.length === 0) {
          commentsList.innerHTML = '<tr><td colspan="4" class="p-6 text-center text-slate-400">No comments yet.</td></tr>';
        } else {
          commentsList.innerHTML = comments.map(c => `
          <tr class="hover:bg-slate-50 dark:hover:bg-slate-700/50">
            <td class="p-6">${c.date}</td>
            <td class="p-6">${USER_DB.find(u => u.id === c.agentId)?.name || c.agentId}</td>
            <td class="p-6">${c.text}</td>
            <td class="p-6 text-right">
              <button onclick="handleDeleteComment(${c.id})" class="text-red-600 hover:text-red-800">Delete</button>
            </td>
          </tr>
        `).join('');
        }

        // 6. Update Final Submit Week Button Logic
        const perfDb = JSON.parse(localStorage.getItem('gojira_performance') || '{}');
        const adminReviews = JSON.parse(localStorage.getItem('adminReviews') || '[]');

        // Count unique agents
        const reviewedAgents = new Set(adminReviews.map(r => r.agentId));
        const totalAgents = new Set([...Object.keys(perfDb), ...reviewedAgents]).size;

        const btnFinalWeek = document.getElementById('btn-final-submit-week');
        if (btnFinalWeek) {
          if (totalAgents > 0) {
            btnFinalWeek.disabled = false;
            btnFinalWeek.classList.remove('opacity-50', 'cursor-not-allowed');
            btnFinalWeek.innerText = `Final Submit for This Week (${totalAgents})`;
          } else {
            btnFinalWeek.disabled = true;
            btnFinalWeek.classList.add('opacity-50', 'cursor-not-allowed');
            btnFinalWeek.innerText = 'Final Submit for This Week';
          }
        }
      }

      // NEW WORKFLOW FUNCTIONS
      let selectedAgentForReview = null;
      let selectedFileForReview = null;
      let selectedProcessType = null;

      function onAgentSelected() {
        const agentSelector = document.getElementById('agent-selector');
        const selectedAgentId = agentSelector.value;

        if (selectedAgentId) {
          selectedAgentForReview = USER_DB.find(u => u.id === selectedAgentId);
          if (selectedAgentForReview) {
            // Show agent details section and populate it
            document.getElementById('admin-agent-list-section').classList.remove('hidden');
            document.getElementById('selected-agent-display-name').innerText = selectedAgentForReview.name;

            // Populate agent details
            const agentListContainer = document.getElementById('admin-agent-list');
            const perf = MockBackend.getPerformance(selectedAgentForReview.id);
            const pendingReviews = getPendingReviews(selectedAgentForReview.id);
            const scoreClass = perf ? (perf.score >= 90 ? 'text-emerald-500' : 'text-red-500') : 'text-slate-300';
            const scoreText = perf ? perf.score + '%' : 'Not Scored';

            const reviewStatus = pendingReviews.length === 0
              ? 'No reviews in progress'
              : pendingReviews.length >= 3
                ? 'Ready for final submission'
                : `${pendingReviews.length}/3 reviews completed`;

            const buttonText = pendingReviews.length >= 3
              ? 'Complete Final Submission'
              : pendingReviews.length === 0
                ? 'Start Quality Review'
                : `Continue Review (${pendingReviews.length}/3)`;

            const buttonAction = pendingReviews.length >= 3
              ? 'showFinalSubmissionOptionForSelectedAgent()'
              : 'startQualityReview()';

            agentListContainer.innerHTML = `
            <div class="bg-white dark:bg-slate-700 p-6 rounded-2xl border border-slate-200 dark:border-slate-600">
               <div class="flex items-center justify-between mb-4">
                  <div>
                     <h4 class="font-bold text-slate-700 dark:text-slate-200 text-xl">${selectedAgentForReview.name}</h4>
                     <p class="text-sm text-slate-500 font-mono">${selectedAgentForReview.id}</p>
                     <p class="text-xs text-slate-400 mt-1">Entity: ${selectedAgentForReview.entity}</p>
                     <p class="text-xs text-blue-600 mt-1 font-medium">${reviewStatus}</p>
                  </div>
                  <div class="text-right">
                     <div class="font-black ${scoreClass} text-2xl">${scoreText}</div>
                     <div class="text-xs text-slate-400 uppercase">Current Score</div>
                  </div>
               </div>

               <!-- Process Selection -->
               <div class="mb-4">
                 <label class="block text-sm font-semibold mb-3">Select Process Type</label>
                 <div class="grid grid-cols-2 gap-3">
                   <button onclick="selectProcessType('voice')" class="p-3 border-2 border-slate-200 dark:border-slate-600 rounded-lg hover:border-blue-500 hover:bg-blue-50 dark:hover:bg-blue-900/20 transition text-center" id="voice-btn">
                     <div class="text-2xl mb-1">üìû</div>
                     <div class="font-medium">Voice</div>
                     <div class="text-xs text-slate-500">Phone calls</div>
                   </button>
                   <button onclick="selectProcessType('non-voice')" class="p-3 border-2 border-slate-200 dark:border-slate-600 rounded-lg hover:border-green-500 hover:bg-green-50 dark:hover:bg-green-900/20 transition text-center" id="non-voice-btn">
                     <div class="text-2xl mb-1">üí¨</div>
                     <div class="font-medium">Non-Voice</div>
                     <div class="text-xs text-slate-500">Chat/Email</div>
                   </button>
                 </div>
               </div>

               <div class="flex gap-3">
                  <button onclick="startQualityReview()" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-xl hover:bg-blue-700 transition" id="start-review-btn" disabled>
                     ${buttonText}
                  </button>
                  <button onclick="clearAgentSelection()" class="bg-slate-500 text-white font-medium py-2 px-4 rounded-xl hover:bg-slate-600 transition">
                     Clear Selection
                  </button>
               </div>
            </div>
          `;
          }
        } else {
          // Hide agent details section if no agent selected
          document.getElementById('admin-agent-list-section').classList.add('hidden');
          selectedAgentForReview = null;
          clearAgentSelection();
        }
      }

      function selectProcessType(processType) {
        selectedProcessType = processType;

        // Update button styles to show selection
        const voiceBtn = document.getElementById('voice-btn');
        const nonVoiceBtn = document.getElementById('non-voice-btn');
        const startBtn = document.getElementById('start-review-btn');

        if (processType === 'voice') {
          voiceBtn.classList.add('border-blue-500', 'bg-blue-50', 'dark:bg-blue-900/20');
          voiceBtn.classList.remove('border-slate-200', 'dark:border-slate-600');
          nonVoiceBtn.classList.remove('border-green-500', 'bg-green-50', 'dark:bg-green-900/20');
          nonVoiceBtn.classList.add('border-slate-200', 'dark:border-slate-600');
        } else {
          nonVoiceBtn.classList.add('border-green-500', 'bg-green-50', 'dark:bg-green-900/20');
          nonVoiceBtn.classList.remove('border-slate-200', 'dark:border-slate-600');
          voiceBtn.classList.remove('border-blue-500', 'bg-blue-50', 'dark:bg-blue-900/20');
          voiceBtn.classList.add('border-slate-200', 'dark:border-slate-600');
        }

        // Enable start review button
        startBtn.disabled = false;
        startBtn.classList.remove('opacity-50', 'cursor-not-allowed');
      }

      function startQualityReview() {
        if (selectedAgentForReview && selectedProcessType) {
          // Hide agent details, show file selection section
          document.getElementById('admin-agent-list-section').classList.add('hidden');
          document.getElementById('file-selection-section').classList.remove('hidden');

          // Set agent info in file selection section
          document.getElementById('selected-agent-name-file').innerText = selectedAgentForReview.name;
          document.getElementById('selected-agent-id-file').innerText = selectedAgentForReview.id;
          document.getElementById('selected-process-type').innerText = selectedProcessType === 'voice' ? 'Voice' : 'Non-Voice';
        }
      }

      function clearAgentSelection() {
        // Reset agent selector
        document.getElementById('agent-selector').value = '';
        // Hide all workflow sections
        document.getElementById('admin-agent-list-section').classList.add('hidden');
        document.getElementById('file-selection-section').classList.add('hidden');
        document.getElementById('feedback-form-section').classList.add('hidden');
        document.getElementById('scoring-section').classList.add('hidden');
        // Clear selections
        selectedAgentForReview = null;
        selectedFileForReview = null;
        selectedProcessType = null;
        localStorage.removeItem('currentQualityFeedback');
      }

      function proceedToFeedback() {
        const fileInput = document.getElementById('quality-feedback-file');

        if (!fileInput.files[0]) {
          alert('Please select a file for quality review.');
          return;
        }

        selectedFileForReview = fileInput.files[0];

        // Hide file selection, show feedback form
        document.getElementById('file-selection-section').classList.add('hidden');
        document.getElementById('feedback-form-section').classList.remove('hidden');

        // Set agent and file info in feedback section
        document.getElementById('selected-agent-name-feedback').innerText = selectedAgentForReview.name;
        document.getElementById('selected-agent-id-feedback').innerText = selectedAgentForReview.id;
        document.getElementById('selected-process-feedback').innerText = selectedProcessType === 'voice' ? 'Voice' : 'Non-Voice';
        document.getElementById('selected-process-feedback-display').innerText = selectedProcessType === 'voice' ? 'Voice' : 'Non-Voice';
        document.getElementById('selected-file-name').innerText = selectedFileForReview.name;
      }

      function backToFileSelection() {
        // Hide feedback form, show file selection
        document.getElementById('feedback-form-section').classList.add('hidden');
        document.getElementById('file-selection-section').classList.remove('hidden');
      }

      function submitFeedbackAndProceed() {
        const feedback = document.getElementById('feedback-observations').value.trim();


        if (!feedback) {
          alert('Please provide feedback and observations.');
          return;
        }

        // Store feedback data temporarily
        const feedbackData = {
          agentId: selectedAgentForReview.id,
          file: selectedFileForReview,
          processType: selectedProcessType,
          // interactionType: removed
          feedback: feedback,
          timestamp: new Date().toISOString()
        };

        // Store in localStorage for now
        localStorage.setItem('currentQualityFeedback', JSON.stringify({
          ...feedbackData,
          fileName: selectedFileForReview.name
        }));

        // Hide feedback form, show additional feedback section
        document.getElementById('feedback-form-section').classList.add('hidden');
        document.getElementById('additional-feedback-section').classList.remove('hidden');

        // Set agent info in additional feedback section
        document.getElementById('selected-agent-name-additional').innerText = selectedAgentForReview.name;
        document.getElementById('selected-agent-id-additional').innerText = selectedAgentForReview.id;
        document.getElementById('process-type-additional').innerText = selectedProcessType === 'voice' ? 'Voice' : 'Non-Voice';
        document.getElementById('process-type-additional').innerText = selectedProcessType === 'voice' ? 'Voice' : 'Non-Voice';
        // Interaction Type removed
        document.getElementById('interaction-type-additional').parentElement.classList.add('hidden'); // Hide the interaction type line
        document.getElementById('primary-feedback-display').innerText = feedback;

        // Initialize with 3 default feedback items
        initializeAdditionalFeedback();
      }

      function initializeAdditionalFeedback() {
        // The HTML already has 3 default feedback items
        // Just update the count and ensure proper button states
        updateFeedbackCount();

        // Ensure the first 3 items have disabled remove buttons
        const container = document.getElementById('additional-feedback-container');
        const feedbackItems = container.querySelectorAll('.feedback-item');
        feedbackItems.forEach((item, index) => {
          const removeBtn = item.querySelector('button[onclick*="removeFeedbackItem"]');
          if (index < 3) {
            removeBtn.disabled = true;
            removeBtn.classList.add('opacity-50');
          } else {
            removeBtn.disabled = false;
            removeBtn.classList.remove('opacity-50');
          }
        });
      }

      function backToFeedbackForm() {
        // Hide additional feedback, show feedback form
        document.getElementById('additional-feedback-section').classList.add('hidden');
        document.getElementById('feedback-form-section').classList.remove('hidden');
      }

      function addFeedbackItem() {
        const container = document.getElementById('additional-feedback-container');
        const feedbackItems = container.querySelectorAll('.feedback-item');
        const count = feedbackItems.length;

        if (count >= 10) {
          alert('Maximum 10 feedback items allowed.');
          return;
        }

        const newItem = document.createElement('div');
        newItem.className = 'feedback-item mb-3 p-4 bg-white dark:bg-slate-700 rounded-xl border border-slate-200 dark:border-slate-600';
        newItem.innerHTML = `
        <div class="flex items-center justify-between mb-2">
          <label class="text-sm font-medium">Feedback Item ${count + 1}</label>
          <button onclick="removeFeedbackItem(this)" class="text-red-500 hover:text-red-700 text-sm">Remove</button>
        </div>
        <input type="text" placeholder="Enter additional feedback point..." class="w-full px-3 py-2 rounded-lg border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-700 focus:ring-2 focus:ring-purple-500 outline-none">
      `;

        container.appendChild(newItem);
        updateFeedbackCount();

        // Disable add button if at max
        if (count + 1 >= 10) {
          document.getElementById('add-feedback-btn').disabled = true;
          document.getElementById('add-feedback-btn').classList.add('opacity-50', 'cursor-not-allowed');
        }

        // Update remove button states for all items
        const allItems = container.querySelectorAll('.feedback-item');
        allItems.forEach((item, index) => {
          const removeBtn = item.querySelector('button[onclick*="removeFeedbackItem"]');
          if (index < 3) {
            removeBtn.disabled = true;
            removeBtn.classList.add('opacity-50');
          } else {
            removeBtn.disabled = false;
            removeBtn.classList.remove('opacity-50');
          }
        });
      }

      function removeFeedbackItem(button) {
        const container = document.getElementById('additional-feedback-container');
        const feedbackItems = container.querySelectorAll('.feedback-item');
        const count = feedbackItems.length;

        if (count <= 3) {
          alert('Minimum 3 feedback items required.');
          return;
        }

        button.closest('.feedback-item').remove();
        updateFeedbackCount();

        // Re-enable add button if below max
        document.getElementById('add-feedback-btn').disabled = false;
        document.getElementById('add-feedback-btn').classList.remove('opacity-50', 'cursor-not-allowed');

        // Renumber remaining items and update remove button states
        const remainingItems = container.querySelectorAll('.feedback-item');
        remainingItems.forEach((item, index) => {
          const label = item.querySelector('label');
          label.textContent = `Feedback Item ${index + 1}`;

          const removeBtn = item.querySelector('button[onclick*="removeFeedbackItem"]');
          if (index < 3) {
            removeBtn.disabled = true;
            removeBtn.classList.add('opacity-50');
          } else {
            removeBtn.disabled = false;
            removeBtn.classList.remove('opacity-50');
          }
        });
      }

      function updateFeedbackCount() {
        const container = document.getElementById('additional-feedback-container');
        const count = container.querySelectorAll('.feedback-item').length;
        document.getElementById('feedback-count').textContent = count;
      }

      function submitAdditionalFeedback() {
        const container = document.getElementById('additional-feedback-container');
        const feedbackInputs = container.querySelectorAll('.feedback-item input');
        const additionalFeedback = [];

        // Validate minimum 3 items
        if (feedbackInputs.length < 3) {
          alert('Minimum 3 feedback items required.');
          return;
        }

        // Collect feedback items
        feedbackInputs.forEach(input => {
          const value = input.value.trim();
          if (value) {
            additionalFeedback.push(value);
          }
        });

        // Validate that we have at least 3 non-empty items
        if (additionalFeedback.length < 3) {
          alert('Please fill in at least 3 feedback items.');
          return;
        }

        // Get existing feedback data and add additional feedback
        const existingData = JSON.parse(localStorage.getItem('currentQualityFeedback'));
        existingData.additionalFeedback = additionalFeedback;

        // Update localStorage
        localStorage.setItem('currentQualityFeedback', JSON.stringify(existingData));

        // Hide additional feedback, show scoring section
        document.getElementById('additional-feedback-section').classList.add('hidden');
        document.getElementById('scoring-section').classList.remove('hidden');

        // Set agent info in scoring section
        document.getElementById('selected-agent-name-scoring').innerText = selectedAgentForReview.name;
        document.getElementById('selected-agent-id-scoring').innerText = selectedAgentForReview.id;
        document.getElementById('process-type-display').innerText = existingData.processType === 'voice' ? 'Voice' : 'Non-Voice';
        document.getElementById('process-type-display').innerText = existingData.processType === 'voice' ? 'Voice' : 'Non-Voice';
        // document.getElementById('interaction-type-display').innerText = existingData.interactionType... removed;
        document.getElementById('interaction-type-display').parentElement.classList.add('hidden');
        document.getElementById('scoring-file-name').innerText = existingData.fileName;
        document.getElementById('feedback-display').innerText = existingData.feedback;

        // Update Submit Button State
        const pendingReviews = getPendingReviews(selectedAgentForReview.id);
        const currentCount = pendingReviews.length;
        const finalSubmitBtn = document.getElementById('final-submit-btn');
        const addReviewBtn = document.getElementById('add-review-btn');

        // We are working on the next review (currentCount + 1)
        const potentialTotal = currentCount + 1;

        if (potentialTotal >= 3) {
          finalSubmitBtn.disabled = false;
          finalSubmitBtn.classList.remove('opacity-50', 'cursor-not-allowed');
          finalSubmitBtn.innerHTML = `Submit Final Reviews (${potentialTotal})`;
        } else {
          finalSubmitBtn.disabled = true;
          finalSubmitBtn.classList.add('opacity-50', 'cursor-not-allowed');
          finalSubmitBtn.innerHTML = `Submit Final Reviews (Need ${3 - potentialTotal} more)`;
        }

        // Check max limit for Add More
        if (potentialTotal >= 10) {
          addReviewBtn.disabled = true;
          addReviewBtn.classList.add('opacity-50', 'cursor-not-allowed');
          addReviewBtn.innerText = "Max Reviews Reached";
        } else {
          addReviewBtn.disabled = false;
          addReviewBtn.classList.remove('opacity-50', 'cursor-not-allowed');
          addReviewBtn.innerText = "Add more quality review";
        }
      }

      function backToFeedback() {
        // Hide scoring, show feedback form
        document.getElementById('scoring-section').classList.add('hidden');
        document.getElementById('feedback-form-section').classList.remove('hidden');
      }

      function restoreAdditionalFeedback(feedbackItems) {
        const container = document.getElementById('additional-feedback-container');
        container.innerHTML = ''; // Clear existing

        feedbackItems.forEach((item, index) => {
          const newItem = document.createElement('div');
          newItem.className = 'feedback-item mb-3 p-4 bg-white dark:bg-slate-700 rounded-xl border border-slate-200 dark:border-slate-600';
          const isDisabled = index < 3;
          newItem.innerHTML = `
          <div class="flex items-center justify-between mb-2">
            <label class="text-sm font-medium">Feedback Item ${index + 1}</label>
            <button onclick="removeFeedbackItem(this)" class="text-red-500 hover:text-red-700 text-sm ${isDisabled ? 'opacity-50' : ''}" ${isDisabled ? 'disabled' : ''}>Remove</button>
          </div>
          <input type="text" value="${item}" placeholder="Enter additional feedback point..." class="w-full px-3 py-2 rounded-lg border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-700 focus:ring-2 focus:ring-purple-500 outline-none">
        `;

          container.appendChild(newItem);
        });

        updateFeedbackCount();

        // Update add button state
        const count = feedbackItems.length;
        const addBtn = document.getElementById('add-feedback-btn');
        if (count >= 10) {
          addBtn.disabled = true;
          addBtn.classList.add('opacity-50', 'cursor-not-allowed');
        } else {
          addBtn.disabled = false;
          addBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        }
      }

      function submitPerformanceScore(isFinal = false) {
        const score = document.querySelector('input[name="performance-score"]:checked');

        if (!score) {
          alert('Please select a performance score.');
          return;
        }

        const feedbackData = JSON.parse(localStorage.getItem('currentQualityFeedback'));
        if (!feedbackData) {
          alert('No feedback data found. Please restart the process.');
          return;
        }

        // Save this review to pending reviews for the agent
        const reviewData = {
          agentId: selectedAgentForReview.id,
          score: parseInt(score.value),
          isFatal: score.value === '0',
          feedbackData: feedbackData,
          timestamp: new Date().toISOString(),
          reviewerId: currentUser.id,
          fileName: feedbackData.fileName
        };

        savePendingReview(reviewData);

        // Clear temporary data
        localStorage.removeItem('currentQualityFeedback');

        // Check agent review count
        const pendingReviews = getPendingReviews(selectedAgentForReview.id);

        if (isFinal) {
          if (pendingReviews.length < 3) {
            alert(`Minimum 3 reviews required. Currently: ${pendingReviews.length}`);
            return;
          }
          showFinalSubmissionOption(selectedAgentForReview.id);
        } else {
          // Add more review
          if (pendingReviews.length >= 10) {
            alert('Maximum 10 reviews reached. Please submit final.');
            // Maybe force final?
            showFinalSubmissionOption(selectedAgentForReview.id);
            return;
          }

          // Reset workflow for next review
          resetForNextReview();
          alert(`Review saved. Total pending: ${pendingReviews.length}. You can add more or submit final.`);
        }
      }

      function savePendingReview(reviewData) {
        const pendingReviews = JSON.parse(localStorage.getItem('pending_agent_reviews') || '{}');
        if (!pendingReviews[reviewData.agentId]) {
          pendingReviews[reviewData.agentId] = [];
        }
        pendingReviews[reviewData.agentId].push(reviewData);
        localStorage.setItem('pending_agent_reviews', JSON.stringify(pendingReviews));
      }

      function getPendingReviews(agentId) {
        const pendingReviews = JSON.parse(localStorage.getItem('pending_agent_reviews') || '{}');
        return pendingReviews[agentId] || [];
      }

      function showFinalSubmissionOption(agentId) {
        const pendingReviews = getPendingReviews(agentId);
        const agent = USER_DB.find(u => u.id === agentId);

        // Hide current workflow sections
        document.getElementById('scoring-section').classList.add('hidden');

        // Show final submission section
        const finalSection = document.getElementById('final-submission-section');
        if (!finalSection) {
          // Create the final submission section
          createFinalSubmissionSection();
        }

        document.getElementById('final-submission-section').classList.remove('hidden');

        // Populate final submission data
        document.getElementById('final-agent-name').innerText = agent.name;
        document.getElementById('final-agent-id').innerText = agent.id;

        // Calculate average score
        const totalScore = pendingReviews.reduce((sum, review) => sum + review.score, 0);
        const averageScore = Math.round(totalScore / pendingReviews.length);
        document.getElementById('final-average-score').innerText = averageScore;

        // Show review summary
        const reviewSummary = document.getElementById('final-review-summary');
        reviewSummary.innerHTML = '';
        pendingReviews.forEach((review, index) => {
          const reviewDiv = document.createElement('div');
          reviewDiv.className = 'p-3 bg-slate-50 dark:bg-slate-700 rounded-lg mb-2';
          reviewDiv.innerHTML = `
          <div class="flex justify-between items-center">
            <span class="font-medium">Review ${index + 1}</span>
            <span class="text-sm text-slate-500">${new Date(review.timestamp).toLocaleDateString()}</span>
          </div>
          <div class="text-sm text-slate-600 dark:text-slate-300 mt-1">
            Process: ${review.processType === 'voice' ? 'Voice' : 'Non-Voice'} | File: ${review.fileName} | Score: ${review.score}/100
          </div>
        `;
          reviewSummary.appendChild(reviewDiv);
        });
      }

      function createFinalSubmissionSection() {
        const section = document.createElement('div');
        section.id = 'final-submission-section';
        section.className = 'hidden bg-green-50 dark:bg-slate-800 p-8 rounded-3xl mb-12 border border-green-200 dark:border-slate-700';

        section.innerHTML = `
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-2xl font-bold flex items-center gap-3">
            <span class="bg-green-600 text-white rounded-lg p-2 text-xl">‚úÖ</span>
            Final Performance Submission for <span id="final-agent-name" class="text-green-600"></span>
          </h2>
          <button onclick="cancelReviewProcess()" class="text-slate-500 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-200 text-sm font-medium">
            Cancel Process
          </button>
        </div>

        <div class="mb-6 p-4 bg-white dark:bg-slate-700 rounded-xl border border-slate-200 dark:border-slate-600">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm text-slate-600 dark:text-slate-300">
            <div><strong>Agent ID:</strong> <span id="final-agent-id" class="font-mono"></span></div>
            <div><strong>Average Score:</strong> <span id="final-average-score" class="font-bold text-green-600"></span>/100</div>
          </div>
        </div>

        <div class="mb-6">
          <h3 class="text-lg font-semibold mb-4">Review Summary (3 Reviews Completed)</h3>
          <div id="final-review-summary" class="space-y-2">
            <!-- Review summaries will be populated here -->
          </div>
        </div>

        <div class="mb-6 p-4 bg-yellow-50 dark:bg-slate-700 rounded-xl border border-yellow-200 dark:border-slate-600">
          <p class="text-sm text-yellow-800 dark:text-yellow-200">
            <strong>Note:</strong> This will calculate the final performance score based on the average of all 3 reviews and update the agent's performance record.
          </p>
        </div>

        <button onclick="submitFinalPerformanceScore()"
          class="bg-green-600 text-white font-bold py-3 px-8 rounded-xl hover:bg-green-700 transition shadow-lg shadow-green-500/30">
          Submit Final Performance Score
        </button>
      `;

        // Insert after the scoring section
        const scoringSection = document.getElementById('scoring-section');
        scoringSection.parentNode.insertBefore(section, scoringSection.nextSibling);
      }

      function submitFinalPerformanceScore() {
        const agentId = document.getElementById('final-agent-id').innerText;
        const pendingReviews = getPendingReviews(agentId);

        if (pendingReviews.length < 3) {
          alert('Minimum 3 reviews required before final submission.');
          return;
        }

        // Calculate final score (average of all reviews)
        const totalScore = pendingReviews.reduce((sum, review) => sum + review.score, 0);
        const finalScore = Math.round(totalScore / pendingReviews.length);

        // Check if any review was fatal (score = 0)
        const hasFatal = pendingReviews.some(review => review.isFatal);

        // Save the final performance score
        const performanceData = {
          agentId: agentId,
          score: finalScore,
          isFatal: hasFatal,
          feedbackData: { reviews: pendingReviews }, // Store all reviews
          timestamp: new Date().toISOString(),
          reviewerId: currentUser.id
        };

        // performanceData object creation removed (was duplicate)

        MockBackend.savePerformanceScore(performanceData);

        // Notify Agent
        NotificationManager.notifyAgent(agentId, `Weekly Performance Reviewed. Final Score: ${finalScore}%`);

        // Notify Agent
        NotificationManager.notifyAgent(agentId, `Weekly Performance Reviewed. Final Score: ${finalScore}%`);

        // Clear pending reviews for this agent
        const allPending = JSON.parse(localStorage.getItem('pending_agent_reviews') || '{}');
        delete allPending[agentId];
        localStorage.setItem('pending_agent_reviews', JSON.stringify(allPending));

        // Reset workflow
        document.getElementById('final-submission-section').classList.add('hidden');
        document.getElementById('admin-agent-list-section').classList.add('hidden');

        // Reset selections
        selectedAgentForReview = null;
        selectedFileForReview = null;
        document.getElementById('agent-selector').value = '';

        // Refresh dashboard
        renderAdminDashboard();

        alert(`Final performance score (${finalScore}/100) submitted successfully for agent!`);
      }

      function showFinalSubmissionOptionForSelectedAgent() {
        if (selectedAgentForReview) {
          showFinalSubmissionOption(selectedAgentForReview.id);
        }
      }

      function cancelReviewProcess() {
        // Clear any temporary data
        localStorage.removeItem('currentQualityFeedback');

        // If there's a selected agent with pending reviews, ask if they want to clear them
        if (selectedAgentForReview) {
          const pendingReviews = getPendingReviews(selectedAgentForReview.id);
          if (pendingReviews.length > 0) {
            const clearPending = confirm(`This agent has ${pendingReviews.length} pending review(s). Do you want to clear all pending reviews for this agent?`);
            if (clearPending) {
              const allPending = JSON.parse(localStorage.getItem('pending_agent_reviews') || '{}');
              delete allPending[selectedAgentForReview.id];
              localStorage.setItem('pending_agent_reviews', JSON.stringify(allPending));
            }
          }
        }

        selectedAgentForReview = null;
        selectedFileForReview = null;

        // Reset to agent selection view (hide all workflow sections)
        document.getElementById('file-selection-section').classList.add('hidden');
        document.getElementById('feedback-form-section').classList.add('hidden');
        document.getElementById('additional-feedback-section').classList.add('hidden');
        document.getElementById('scoring-section').classList.add('hidden');
        document.getElementById('final-submission-section').classList.add('hidden');
        document.getElementById('admin-agent-list-section').classList.add('hidden');

        // Reset agent selector
        document.getElementById('agent-selector').value = '';

        // Refresh dashboard to update agent statuses
        renderAdminDashboard();
      }

      function resetForNextReview() {
        // Hide scoring section
        document.getElementById('scoring-section').classList.add('hidden');

        // Reset to file selection for next review
        document.getElementById('file-selection-section').classList.remove('hidden');

        // Clear file selection
        selectedFileForReview = null;
        const fileInput = document.getElementById('quality-feedback-file');
        if (fileInput) fileInput.value = '';

        document.getElementById('selected-file-name').innerText = 'No file selected';

        // Reset Feedback Form
        document.getElementById('feedback-observations').value = '';

        // Reset Additional Feedback Section to default 3 items
        const container = document.getElementById('additional-feedback-container');
        container.innerHTML = `
        <div class="feedback-item mb-3 p-4 bg-white dark:bg-slate-700 rounded-xl border border-slate-200 dark:border-slate-600">
          <div class="flex items-center justify-between mb-2">
            <label class="text-sm font-medium">Feedback Item 1</label>
            <button onclick="removeFeedbackItem(this)" class="text-red-500 hover:text-red-700 text-sm opacity-50" disabled>Remove</button>
          </div>
          <input type="text" placeholder="Enter additional feedback point..." class="w-full px-3 py-2 rounded-lg border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-700 focus:ring-2 focus:ring-purple-500 outline-none">
        </div>
        <div class="feedback-item mb-3 p-4 bg-white dark:bg-slate-700 rounded-xl border border-slate-200 dark:border-slate-600">
          <div class="flex items-center justify-between mb-2">
            <label class="text-sm font-medium">Feedback Item 2</label>
            <button onclick="removeFeedbackItem(this)" class="text-red-500 hover:text-red-700 text-sm opacity-50" disabled>Remove</button>
          </div>
          <input type="text" placeholder="Enter additional feedback point..." class="w-full px-3 py-2 rounded-lg border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-700 focus:ring-2 focus:ring-purple-500 outline-none">
        </div>
        <div class="feedback-item mb-3 p-4 bg-white dark:bg-slate-700 rounded-xl border border-slate-200 dark:border-slate-600">
          <div class="flex items-center justify-between mb-2">
            <label class="text-sm font-medium">Feedback Item 3</label>
            <button onclick="removeFeedbackItem(this)" class="text-red-500 hover:text-red-700 text-sm opacity-50" disabled>Remove</button>
          </div>
          <input type="text" placeholder="Enter additional feedback point..." class="w-full px-3 py-2 rounded-lg border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-700 focus:ring-2 focus:ring-purple-500 outline-none">
        </div>
      `;
        updateFeedbackCount();
        document.getElementById('add-feedback-btn').disabled = false;
        document.getElementById('add-feedback-btn').classList.remove('opacity-50', 'cursor-not-allowed');

        // Reset Performance Score Radios
        const scoreRadios = document.getElementsByName('performance-score');
        scoreRadios.forEach(radio => radio.checked = false);
      }

      function calculateTotalScore() {
        const audit = parseInt(document.getElementById('indiv-score').value) || 0;
        const errors = parseInt(document.getElementById('indiv-errors').value);
        const compliance = parseInt(document.getElementById('indiv-compliance').value) || 0;

        const display = document.getElementById('calc-total-score');

        // Logic: 
        // If Fatal Error (1) -> Score 0
        // Else -> Average of Audit & Compliance? Or just Audit?
        // User said "choose the score 0 and hundred... automatically fetch total"
        // Let's assume strict compliance.

        let total = 0;

        if (document.getElementById('indiv-errors').value === "") {
          display.innerText = "--";
          return;
        }

        if (errors === 1) {
          total = 0;
        } else {
          // If no fatal errors
          // Using simple average for now, standard QA math
          total = (audit + compliance) / 2;
        }

        display.innerText = total + "%";
        if (total === 100) display.className = "text-2xl font-black text-emerald-500";
        else if (total === 0) display.className = "text-2xl font-black text-red-500";
        else display.className = "text-2xl font-black text-indigo-600";
      }

      function handleFileUpload() {
        const fileInput = document.getElementById('admin-file-upload');
        if (fileInput.files.length > 0) {
          const file = fileInput.files[0];

          // Read file content
          const reader = new FileReader();
          reader.onload = function (e) {
            const content = e.target.result;
            try {
              MockBackend.addReport(file, content);
              alert(`Successfully uploaded "${file.name}"`);
              renderAdminDashboard(); // Refresh UI
            } catch (err) {
              alert('Upload failed: File might be too large for browser storage.');
              console.error(err);
            }
          };
          reader.readAsDataURL(file);

          fileInput.value = ''; // Reset
        } else {
          alert('Please select a file first.');
        }
      }

      function handleDeleteReport(id) {
        if (confirm('Are you sure you want to delete this report? It will be removed for all agents.')) {
          MockBackend.deleteReport(id);
          renderAdminDashboard(); // Refresh
        }
      }

      function handleDeleteComment(id) {
        if (confirm('Are you sure you want to delete this comment?')) {
          MockBackend.deleteComment(id);
          renderAdminDashboard(); // Refresh
        }
      }

      function viewReviewDetails(reviewId) {
        const reviews = MockBackend.getPerformanceScores();
        const review = reviews.find(r => r.id == reviewId);

        if (review) {
          const agent = USER_DB.find(u => u.id === review.agentId);
          const agentName = agent ? agent.name : review.agentId;
          const date = new Date(review.timestamp).toLocaleString();

          const details = `
Review Details:
- Date: ${date}
- Agent: ${agentName} (${review.agentId})
- Score: ${review.score === 0 ? '0 (Fatal Error)' : review.score}
- Interaction Type: ${review.feedbackData.interactionType}
- File: ${review.feedbackData.fileName}
- Feedback: ${review.feedbackData.feedback}

Reviewer: ${review.reviewerId}
        `;

          alert(details);
        }
      }

      function resetAllPerformanceData() {
        if (confirm('Are you sure you want to reset ALL performance data? This will clear all reviews and scores for all agents. This action cannot be undone.')) {
          MockBackend.clearAllPerformanceData();
          renderAdminDashboard();
          alert('All performance data has been reset. All agents now show as "Not Scored".');
        }
      }

      function clearSelectedAgent() {
        selectedAgentForUpload = null;
        document.getElementById('indiv-agent-search').value = '';
        document.getElementById('indiv-agent-results').classList.add('hidden');
        document.getElementById('indiv-agent-selected').classList.add('hidden');
        document.getElementById('indiv-agent-selected').classList.remove('flex');
        document.getElementById('indiv-upload-form').classList.add('hidden');
        document.getElementById('indiv-score').value = '';
        document.getElementById('indiv-errors').value = '';
        document.getElementById('indiv-compliance').value = '';
        document.getElementById('calc-total-score').innerText = '--';
        document.getElementById('proof-audio').value = '';
        document.getElementById('proof-chat').value = '';
        document.getElementById('proof-email').value = '';
      }

      function renderAgentDashboard() {
        if (currentUser) {
          document.getElementById('agent-name-display').innerText = currentUser.name;
        }
      }

      function openAgentPerformanceModal() {
        if (!currentUser) return;
        const modal = document.getElementById('agent-performance-modal');
        const contentLoaded = document.getElementById('perf-content-loaded');
        const contentEmpty = document.getElementById('perf-content-empty');

        document.getElementById('modal-agent-id').innerText = `ID: ${currentUser.id}`;
        modal.classList.remove('hidden');

        const perfData = MockBackend.getPerformance(currentUser.id);

        if (perfData) {
          contentLoaded.classList.remove('hidden');
          contentEmpty.classList.add('hidden');

          // Populate Scores
          document.getElementById('modal-audit-score').innerText = perfData.score;
          document.getElementById('modal-fatal-errors').innerText = perfData.errors;
          document.getElementById('modal-compliance').innerText = perfData.compliance === '100' ? '100%' : '0%';

          // Calculate Total if not saved, or use saved logic. 
          // Since we save specific fields, let's re-calculate display total or assume Audit is main.
          // User said "Total Quality Score... automatically fetch".
          // In Admin calc we did: If Fatal=1 -> 0, else (Audit+Comp)/2. Let's replicate or use saved.
          // We should ideally save the Total. But for now re-calc.
          let total = 0;
          const audit = parseInt(perfData.score) || 0;
          const comp = parseInt(perfData.compliance) || 0;
          const errors = parseInt(perfData.errors) || 0;

          if (errors === 1) total = 0;
          else total = (audit + comp) / 2;

          document.getElementById('modal-total-score').innerText = total + '%';

          // Populate Proofs
          const proofsList = document.getElementById('modal-proofs-list');
          if (perfData.proofs && perfData.proofs.length > 0) {
            proofsList.innerHTML = perfData.proofs.map(p => `
                <div class="flex items-center justify-between p-4 bg-white dark:bg-slate-700 rounded-xl border border-slate-200 dark:border-slate-600">
                   <div class="flex items-center gap-3">
                      <div class="w-10 h-10 rounded-full bg-slate-100 dark:bg-slate-600 flex items-center justify-center text-xl">${p.icon}</div>
                      <div>
                         <p class="font-bold text-sm text-slate-700 dark:text-slate-200">${p.name}</p>
                         <p class="text-[10px] text-slate-400 uppercase">${p.type.split('/')[1] || 'FILE'}</p>
                      </div>
                   </div>
                   <button onclick="openReport('${p.content}', '${p.type}')" class="bg-indigo-50 dark:bg-indigo-900/30 text-indigo-600 px-4 py-2 rounded-lg font-bold text-sm hover:bg-indigo-100 transition">View üëÅÔ∏è</button>
                </div>
             `).join('');
          } else {
            proofsList.innerHTML = '<p class="col-span-2 text-center text-slate-400 italic">No proofs attached.</p>';
          }

        } else {
          contentLoaded.classList.add('hidden');
          contentEmpty.classList.remove('hidden');
        }
      }

      function closeAgentPerformanceModal() {
        document.getElementById('agent-performance-modal').classList.add('hidden');
      }

      // BULK PERFORMANCE MANAGER
      function openReport(content, type) {
        const win = window.open();
        if (win) {
          if (type.startsWith('image/')) {
            win.document.write(`<div style="display:flex;justify-content:center;align-items:center;height:100vh;background:#f0f0f0;"><img src="${content}" style="max-width:100%;max-height:100%;box-shadow:0 0 20px rgba(0,0,0,0.1);"></div>`);
          } else if (type === 'application/pdf') {
            win.document.write(`<embed width="100%" height="100%" src="${content}" type="application/pdf">`);
          } else {
            // Fallback for other types
            win.document.write(`<h2 style="font-family:sans-serif;text-align:center;padding:20px;">Preview not available for this file type. Please download to view.</h2><div style="text-align:center;"><a href="${content}" download="file" style="padding:10px 20px;background:#3b82f6;color:white;text-decoration:none;border-radius:5px;">Download File</a></div>`);
          }
          win.document.title = "View Report";
          win.document.close(); // Important for loading
        } else {
          alert('Pop-up blocked! Please allow pop-ups for this site to view reports.');
        }
      }

      function handleCommentSubmit() {
        const input = document.getElementById('agent-comment-input');
        const text = input.value.trim();

        if (!text) return alert('Please write a comment first.');
        if (!currentUser) return alert('You must be logged in.');

        MockBackend.addComment(text, currentUser.id);
        alert('Feedback sent to Admin successfully!');
        input.value = '';
      }

      function logout() {
        currentUser = null;
        localStorage.removeItem('currentUser');
        location.reload(); // Reload to show login screen
      }



      function handleAgentSearch(query) {
        const resultsDiv = document.getElementById('indiv-agent-results');
        if (!query || query.length < 2) {
          resultsDiv.classList.add('hidden');
          return;
        }

        const matched = USER_DB.filter(u =>
          u.role === 'agent' &&
          (u.name.toLowerCase().includes(query.toLowerCase()) || u.id.toLowerCase().includes(query.toLowerCase()))
        );

        if (matched.length === 0) {
          resultsDiv.innerHTML = '<div class="p-4 text-sm text-slate-500 italic">No agents found</div>';
        } else {
          resultsDiv.innerHTML = matched.map(u => `
          <div onclick="selectAgent('${u.id}')" class="p-3 hover:bg-slate-50 dark:hover:bg-slate-700 cursor-pointer border-b border-slate-50 dark:border-slate-700 last:border-0">
             <div class="font-bold text-slate-700 dark:text-slate-200">${u.name}</div>
             <div class="text-xs text-slate-500 font-mono">${u.id} ‚Ä¢ ${u.entity}</div>
          </div>
        `).join('');
        }
        resultsDiv.classList.remove('hidden');
      }

      function selectAgent(id) {
        selectedAgentForUpload = USER_DB.find(u => u.id === id);
        if (!selectedAgentForUpload) return;

        // Update UI
        document.getElementById('indiv-agent-search').value = '';
        document.getElementById('indiv-agent-results').classList.add('hidden');
        document.getElementById('indiv-agent-selected').classList.remove('hidden');
        document.getElementById('indiv-agent-selected').classList.add('flex');
        document.getElementById('indiv-upload-form').classList.remove('hidden');

        document.getElementById('selected-agent-name').innerText = selectedAgentForUpload.name;
        document.getElementById('selected-agent-id').innerText = selectedAgentForUpload.id;

        // Search Input hidden or disabled
        document.getElementById('indiv-agent-search').parentElement.parentElement.classList.add('hidden');
      }



      async function submitIndividualScore() {
        if (!selectedAgentForUpload) return alert('No agent selected.');

        const score = document.getElementById('indiv-score').value;
        const errors = document.getElementById('indiv-errors').value;
        const compliance = document.getElementById('indiv-compliance').value;

        if (!score || !errors) return alert('Please enter Score and Errors.');

        // Handle File Uploads
        const proofs = [];
        const files = [
          { id: 'proof-audio', name: 'Call Recording', icon: 'üé§' },
          { id: 'proof-chat', name: 'Chat Transcript', icon: 'üí¨' },
          { id: 'proof-email', name: 'Email Proof', icon: '‚úâÔ∏è' }
        ];

        try {
          for (const f of files) {
            const input = document.getElementById(f.id);
            if (input.files.length > 0) {
              const file = input.files[0];
              const content = await readFileAsBase64(file);
              proofs.push({
                name: f.name + ` (${file.name})`,
                icon: f.icon,
                type: file.type,
                content: content
              });
            }
          }
        } catch (e) {
          console.error(e);
          return alert('Error processing files. Please try again.');
        }

        // Save
        MockBackend.savePerformance(selectedAgentForUpload.id, {
          score,
          errors,
          compliance,
          proofs
        });

        alert(`Performance updated for ${selectedAgentForUpload.name} successfully!`);
        clearSelectedAgent();
      }

      function readFileAsBase64(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.readAsDataURL(file);
          reader.onload = () => resolve(reader.result);
          reader.onerror = error => reject(error);
        });
      }

      const searchData = [
        { name: 'Knowledge Base', id: 'view-kb' },
        { name: 'Brand Entities', id: 'view-entities' },
        { name: 'New Updates', id: 'view-updates' },
        { name: 'Resources', id: 'view-resources' },
        { name: 'BharatLoan', id: 'view-bharatloan' },
        { name: 'Rupee112', id: 'view-rupee112' },
        { name: 'Loan112', id: 'view-loan112' },
        { name: 'RupeeOnTime', id: 'view-rupeeontime' },
        { name: 'Quality Assurance Checklist', id: 'view-checklist' },
        { name: 'BharatLoan Portal', id: 'view-bharatloan' },
        { name: 'Rupee112 Portal', id: 'view-rupee112' },
        { name: 'Loan112 Portal', id: 'view-loan112' },
        { name: 'RupeeOnTime Portal', id: 'view-rupeeontime' },
        { name: 'WOCOM 365', id: 'view-bharatloan' },
        { name: 'Yellow Ai', id: 'view-bharatloan' },
        { name: 'Outlook', id: 'view-bharatloan' },
      ];

      let currentEntity = '';
      let currentUser = null;
      let selectedAgentForUpload = null;

      const ENTITY_VIEW_MAP = {
        'view-bharatloan': 'BharatLoan',
        'view-rupee112': 'Rupee112',
        'view-loan112': 'Loan112',
        'view-rupeeontime': 'RupeeOnTime'
      };

      function navigateTo(id) {
        // CHECK ACCESS PERMISSION
        if (currentUser) {
          if (currentUser.entity !== 'ALL') {
            const targetEntity = ENTITY_VIEW_MAP[id];
            if (targetEntity && targetEntity !== currentUser.entity) {

              // Dynamic check: Update modal text to ensure it matches requirement
              const modalTitle = document.getElementById('access-denied-title');
              if (modalTitle) modalTitle.innerText = 'Please enter the correct ID and can choose the correct entity for this ID';

              // Show Access Denied Modal
              document.getElementById('access-denied-modal').classList.remove('hidden');
              return; // STOP NAVIGATION
            }
          }
        }

        document.querySelectorAll('.app-view').forEach(v => v.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        window.scrollTo({ top: 0, behavior: 'smooth' });
        // Close search after navigation
        document.getElementById('search-bar').classList.add('hidden');
        document.getElementById('search-input').value = '';
        document.getElementById('search-results').innerHTML = '';
      }

      function toggleFaq(btn) {
        btn.parentElement.classList.toggle('active');
      }

      function toggleSopSection(id) {
        const el = document.getElementById(id);
        if (el) {
          el.classList.toggle('hidden');
        }
      }

      function showTab(tab, entity = '') {
        const prefix = entity ? '-' + entity : '';
        // Hide all tab contents
        document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));
        // Remove active from all tabs
        const tabSelectors = entity ? `#tab-guidelines${prefix}, #tab-tools${prefix}` : '#tab-guidelines, #tab-tools';
        document.querySelectorAll(tabSelectors).forEach(btn => {
          btn.classList.remove('text-blue-600', 'border-blue-600');
          btn.classList.add('text-slate-500', 'border-transparent');
        });
        // Show selected tab content
        document.getElementById('content-' + tab + prefix).classList.remove('hidden');
        // Activate selected tab
        document.getElementById('tab-' + tab + prefix).classList.add('text-blue-600', 'border-blue-600');
        document.getElementById('tab-' + tab + prefix).classList.remove('text-slate-500', 'border-transparent');
      }

      function toggleTheme() {
        const html = document.documentElement;
        const icon = document.getElementById('theme-icon');
        const text = document.getElementById('theme-text');

        if (html.classList.contains('dark')) {
          html.classList.remove('dark');
          icon.innerText = 'üåô';
          text.innerText = 'Dark';
          localStorage.setItem('theme', 'light');
        } else {
          html.classList.add('dark');
          icon.innerText = '‚òÄÔ∏è';
          text.innerText = 'Light';
          localStorage.setItem('theme', 'dark');
        }
      }

      function toggleDropdown(entity) {
        const dropdown = document.getElementById('support-dropdown' + (entity ? '-' + entity : ''));
        dropdown.classList.toggle('hidden');
      }

      function toggleSearch() {
        const bar = document.getElementById('search-bar');
        bar.classList.toggle('hidden');
        if (!bar.classList.contains('hidden')) {
          document.getElementById('search-input').focus();
        } else {
          document.getElementById('search-input').value = '';
          document.getElementById('search-results').innerHTML = '';
        }
      }

      function performSearch(query) {
        const resultsDiv = document.getElementById('search-results');
        if (!query.trim()) {
          resultsDiv.innerHTML = '';
          return;
        }
        const filtered = searchData.filter(item => item.name.toLowerCase().includes(query.toLowerCase()));
        resultsDiv.innerHTML = filtered.map(item => `<div onclick="navigateTo('${item.id}')" class="px-4 py-2 hover:bg-slate-100 dark:hover:bg-slate-700 cursor-pointer">${item.name}</div>`).join('');
      }

      function showLogin(entity) {
        currentEntity = entity;
        document.getElementById('login-title').innerText = `Login to ${entity}`;
        document.getElementById('login-modal').classList.remove('hidden');
        document.getElementById('empid').value = '';
      }



      function hideLogin() {
        document.getElementById('login-modal').classList.add('hidden');
        document.getElementById('empid').value = '';
      }

      // USER DATABASE
      const USER_DB = [
        { id: 'BL/GG/25/1135', name: 'Siddhant Chauhan', role: 'admin', entity: 'ALL' },
        { id: 'BL/GG/25/703', name: 'SHARAD ADHIKARI', role: 'agent', entity: 'BharatLoan' },
        { id: 'BL/GG/25/704', name: 'DIVYANSHU SHARMA', role: 'agent', entity: 'BharatLoan' },
        { id: 'BL/GG/25/705', name: 'AYUSHMAN TIBREWAL', role: 'agent', entity: 'BharatLoan' },
        { id: 'BL/GG/25/1189', name: 'Khushi Kumari', role: 'agent', entity: 'BharatLoan' },
        { id: 'BL/GG/25/712', name: 'AKSHAY NAGIA', role: 'agent', entity: 'BharatLoan' },
        { id: 'BL/GG/25/1021', name: 'Chitresh Kumar', role: 'agent', entity: 'BharatLoan' },
        { id: 'BL/GG/25/1022', name: 'Akshat', role: 'agent', entity: 'BharatLoan' },
        { id: 'BL/GG/25/1055', name: 'KAJAL', role: 'agent', entity: 'BharatLoan' },
        { id: 'BL/GG/25/1134', name: 'Isha', role: 'agent', entity: 'BharatLoan' },

        { id: 'BL/GG/25/1240', name: 'KUNDAN KUMAR', role: 'agent', entity: 'BharatLoan' },
        { id: 'BL/GG/25/1338', name: 'MOHIT KUMAR', role: 'agent', entity: 'BharatLoan' },
        { id: 'BL/GG/26/042', name: 'MOHD. KAIF', role: 'agent', entity: 'BharatLoan' },


        // LOAN112 AGENTS
        { id: 'L112/GG/25/021', name: 'RITU YADAV', role: 'agent', entity: 'Loan112' },
        { id: 'L112/GG/25/047', name: 'Hari Kishan', role: 'agent', entity: 'Loan112' },
        { id: 'L112/GG/25/022', name: 'ADITYA SINGH', role: 'agent', entity: 'Loan112' },
        { id: 'L112/GG/25/015', name: 'Kunal Kukreti', role: 'agent', entity: 'Loan112' },
        { id: 'L112/GG/25/086', name: 'Joba', role: 'agent', entity: 'Loan112' },
        { id: 'L112/GG/25/026', name: 'AMAAN KHAN', role: 'agent', entity: 'Loan112' },
        { id: 'L112/GG/25/087', name: 'Ajit', role: 'agent', entity: 'Loan112' },
        { id: 'L112/GG/25/046', name: 'Avinash', role: 'agent', entity: 'Loan112' },

        // RUPEE112 AGENTS
        { id: 'R112/GG/25/710', name: 'Priya Kumari', role: 'agent', entity: 'Rupee112' },
        { id: 'R112/GG/24/410', name: 'CHANDAN PANDAY', role: 'agent', entity: 'Rupee112' },
        { id: 'R112/GG/24/432', name: 'SHEETAL SINGH', role: 'agent', entity: 'Rupee112' },
        { id: 'R112/GG/25/623', name: 'GUNJAN', role: 'agent', entity: 'Rupee112' },
        { id: 'R112/GG/25/707', name: 'Dunna Vishal', role: 'agent', entity: 'Rupee112' },
        { id: 'R112/GG/25/754', name: 'Nishu Yadav', role: 'agent', entity: 'Rupee112' },
        { id: 'R112/GG/25/724', name: 'Aryan', role: 'agent', entity: 'Rupee112' },
        { id: 'R112/GG/25/732', name: 'Ansh Rai', role: 'agent', entity: 'Rupee112' },
        { id: 'RDA/GG/25/006', name: 'Ashish Rawat', role: 'agent', entity: 'Rupee112' },
        { id: 'R112/GG/24/478', name: 'KOMAL', role: 'agent', entity: 'Rupee112' },
        { id: 'R112/GG/25/725', name: 'Kusum sharma', role: 'agent', entity: 'Rupee112' },
        { id: 'RDA/GG/25/038', name: 'Nippi', role: 'agent', entity: 'Loan112' },
        { id: 'R112/GG/23/168', name: 'Ruksar', role: 'agent', entity: 'Rupee112' },
        { id: 'R112/GG/25/692', name: 'NEHA', role: 'agent', entity: 'Rupee112' }
      ];

      function hideLogin() {
        document.getElementById('login-modal').classList.add('hidden');
        document.getElementById('empid').value = '';
      }

      function submitLogin(event) {
        event.preventDefault();
        const empId = document.getElementById('empid').value.trim();

        const user = USER_DB.find(u => u.id === empId);

        if (user) {
          if (user.role === 'admin') {
            // For admin, use the selected entity from the dropdown, fallback to currentEntity
            const selectedEntity = document.getElementById('login-entity')?.value || currentEntity || 'ALL';
            adminCurrentEntity = selectedEntity;

            currentUser = user;
            navigateTo('view-admin');
            adminLoadAgents();
            hideLogin();
          } else {
            // For agents, check entity match
            if (currentEntity && user.entity !== currentEntity) {
              const modalTitle = document.getElementById('access-denied-title');
              if (modalTitle) modalTitle.innerText = 'Please enter the correct ID and can choose the correct entity for this ID';
              hideLogin();
              document.getElementById('access-denied-modal').classList.remove('hidden');
              return;
            }

            currentUser = user;

            // Update Header Title
            const titleSpan = document.getElementById('agent-dashboard-title');
            if (titleSpan) titleSpan.innerText = `Welcome ${user.name}`;

            // Update Banner Name
            const bannerName = document.getElementById('agent-name-display');
            if (bannerName) bannerName.innerText = user.name;

            navigateTo('view-performance');
            hideLogin();
          }
        } else {
          alert('Invalid Employee ID. Please check your credentials.');
        }
      }

      window.onload = () => {
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'dark') {
          document.documentElement.classList.add('dark');
          document.getElementById('theme-icon').innerText = '‚òÄÔ∏è';
          document.getElementById('theme-text').innerText = 'Light';
        }
      }

      // ===== NEW ADMIN DASHBOARD FUNCTIONS =====
      let adminCurrentEntity = '';
      let adminCurrentAgent = '';
      let adminCurrentAgentName = '';
      let adminReviewItems = [];

      function adminLoadAgents() {
        // Display current entity
        document.getElementById('admin-entity-display').textContent = adminCurrentEntity === 'ALL' ? 'All Entities' : adminCurrentEntity;

        let agents = USER_DB.filter(u => u.role === 'agent');
        if (adminCurrentEntity !== 'ALL') {
          agents = agents.filter(u => u.entity === adminCurrentEntity);
        }

        // Group by Entity
        const grouped = {};
        agents.forEach(agent => {
          if (!grouped[agent.entity]) grouped[agent.entity] = [];
          grouped[agent.entity].push(agent);
        });

        const selector = document.getElementById('admin-agent-selector');
        selector.innerHTML = '<option value="">-- Click to Select Agent --</option>';

        Object.keys(grouped).forEach(entity => {
          const optgroup = document.createElement('optgroup');
          optgroup.label = entity;

          grouped[entity].forEach(agent => {
            const option = document.createElement('option');
            option.value = agent.id;
            option.text = `${agent.name} (${agent.id})`;
            option.dataset.name = agent.name; // Store name for easy access
            optgroup.appendChild(option);
          });

          selector.appendChild(optgroup);
        });
      }

      let adminCurrentInteractionType = 'voice';

      function adminSelectAgentFromDropdown(selectElement) {
        const selectedOption = selectElement.options[selectElement.selectedIndex];
        const agentId = selectedOption.value;
        const agentName = selectedOption.dataset.name;

        if (agentId) {
          adminSelectAgent(agentId, agentName);
        } else {
          // Reset if they select default option
          adminCurrentAgent = '';
          document.getElementById('admin-interaction-type-section').classList.add('hidden');
          document.getElementById('admin-start-review-btn').classList.add('hidden');
        }
      }

      function adminSelectAgent(agentId, agentName) {
        adminCurrentAgent = agentId;
        adminCurrentAgentName = agentName;

        // Show Interaction Type Selection
        const typeSection = document.getElementById('admin-interaction-type-section');
        typeSection.classList.remove('hidden');

        // Reset Radio Buttons
        document.querySelectorAll('input[name="interaction-type"]').forEach(r => r.checked = false);

        // Hide Start Button until type selected
        document.getElementById('admin-start-review-btn').classList.add('hidden');
        document.getElementById('admin-start-review-btn').disabled = true;

        // Hide Form if open
        document.getElementById('admin-quality-form-section').classList.add('hidden');

        // Refresh reviews list for this agent (kept from original)
        adminLoadReviewsList();
      }

      function adminHandleInteractionTypeStart() {
        // Check if agent is selected
        if (!adminCurrentAgent) return;

        // Check if type is selected
        const typeEl = document.querySelector('input[name="interaction-type"]:checked');
        if (typeEl) {
          adminCurrentInteractionType = typeEl.value;
          const btn = document.getElementById('admin-start-review-btn');
          btn.classList.remove('hidden');
          btn.disabled = false;
          btn.classList.remove('opacity-50', 'cursor-not-allowed');

          // Update Button Text
          btn.innerText = `Start ${adminCurrentInteractionType === 'voice' ? 'Voice' : 'Non-Voice'} Review`;
        }
      }

      function adminStartQualityReview() {
        if (!adminCurrentEntity || !adminCurrentAgent) {
          alert('Please select an agent');
          return;
        }

        adminReviewItems = [];
        document.getElementById('admin-quality-form-section').classList.remove('hidden');

        // Update Title
        const typeLabel = adminCurrentInteractionType === 'voice' ? 'Voice Process' : 'Non-Voice Process';
        document.getElementById('admin-review-agent-display').textContent = `${adminCurrentAgentName} (${typeLabel})`;

        // Add first item
        document.getElementById('admin-review-items-container').innerHTML = '';
        adminAddReviewItem();
      }

      function adminCancelReview() {
        document.getElementById('admin-quality-form-section').classList.add('hidden');
        adminReviewItems = [];
        document.getElementById('admin-review-items-container').innerHTML = '';

        // Reset Selection UI
        document.getElementById('admin-start-review-btn').classList.add('hidden');
        document.querySelectorAll('input[name="interaction-type"]').forEach(r => r.checked = false);

        adminCurrentAgent = '';
        document.getElementById('admin-agent-selector').value = "";
        document.getElementById('admin-interaction-type-section').classList.add('hidden');
      }

      function adminAddReviewItem() {
        if (adminReviewItems.length >= 10) {
          alert('Maximum 10 reviews allowed per agent');
          return;
        }

        const itemIndex = adminReviewItems.length + 1;
        const container = document.getElementById('admin-review-items-container');

        // Determine Input HTML based on Type
        let inputHtml = '';
        if (adminCurrentInteractionType === 'voice') {
          inputHtml = `
            <div class="mb-4">
                <label class="block text-sm font-semibold mb-2">Select Audio File (Max 20MB)</label>
                <input type="file" class="review-file-input block w-full text-sm file:mr-4 file:py-2 file:px-4 file:rounded file:border-0 file:text-sm file:font-semibold file:bg-blue-100 file:text-blue-700"
                  accept="audio/*" data-item-index="${itemIndex - 1}" onchange="adminOnFileSelected(${itemIndex - 1})">
                <p class="text-xs text-slate-500 mt-1">Selected: <span class="review-file-name">None</span></p>
                <input type="hidden" class="review-input-type" value="file">
            </div>`;
        } else {
          inputHtml = `
            <div class="mb-4">
                <label class="block text-sm font-semibold mb-2">Chat/Email ID or Content</label>
                <textarea class="review-text-input w-full px-4 py-3 rounded-lg border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-700 focus:ring-2 focus:ring-purple-500 outline-none" 
                  rows="2" placeholder="Paste Chat ID or Content here..." data-item-index="${itemIndex - 1}"></textarea>
                <input type="hidden" class="review-input-type" value="text">
            </div>`;
        }

        const itemHtml = `
        <div class="admin-review-item bg-white dark:bg-slate-700 p-6 rounded-xl border border-slate-200 dark:border-slate-600 animate-fade-in">
          <div class="flex items-center justify-between mb-4">
            <h4 class="font-bold text-lg">Review #${itemIndex}</h4>
            ${itemIndex > 1 ? `<button onclick="adminRemoveReviewItem(${itemIndex - 1})" class="text-red-600 hover:text-red-700 text-sm">üóëÔ∏è Remove</button>` : ''}
          </div>

          ${inputHtml}

          <!-- Observation -->
          <div class="mb-4">
            <label class="block text-sm font-semibold mb-2">Observation</label>
            <textarea class="review-observation w-full px-4 py-3 rounded-lg border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-700 focus:ring-2 focus:ring-emerald-500 outline-none" 
              rows="4" placeholder="Enter your observation for this review..." data-item-index="${itemIndex - 1}"></textarea>
          </div>

          <!-- Score -->
          <div class="mb-4">
            <label class="block text-sm font-semibold mb-3">Performance Score</label>
            <div class="flex gap-4">
              <label class="flex items-center gap-2 p-3 bg-emerald-50 dark:bg-slate-600 rounded-lg border border-emerald-200 dark:border-slate-500 cursor-pointer flex-1">
                <input type="radio" name="score-${itemIndex - 1}" value="100" class="review-score" data-item-index="${itemIndex - 1}">
                <div>
                  <div class="font-bold text-emerald-600">100</div>
                  <div class="text-xs text-slate-600 dark:text-slate-300">Good</div>
                </div>
              </label>
              <label class="flex items-center gap-2 p-3 bg-red-50 dark:bg-slate-600 rounded-lg border border-red-200 dark:border-slate-500 cursor-pointer flex-1">
                <input type="radio" name="score-${itemIndex - 1}" value="0" class="review-score" data-item-index="${itemIndex - 1}">
                <div>
                  <div class="font-bold text-red-600">0</div>
                  <div class="text-xs text-slate-600 dark:text-slate-300">Fatal</div>
                </div>
              </label>
            </div>
          </div>
        </div>
      `;

        container.insertAdjacentHTML('beforeend', itemHtml);
        adminReviewItems.push({ file: null, observation: '', score: null });

        // Update button states
        adminUpdateReviewButtons();
      }

      function adminRemoveReviewItem(index) {
        adminReviewItems.splice(index, 1);
        const items = document.querySelectorAll('.admin-review-item');
        if (items[index]) items[index].remove();
        adminUpdateReviewButtons();
      }

      function adminOnFileSelected(index) {
        const fileInput = document.querySelector(`input[data-item-index="${index}"]`);
        const file = fileInput.files[0];

        if (file) {
          if (file.size > 20 * 1024 * 1024) {
            alert('File size exceeds 20MB limit');
            fileInput.value = '';
            return;
          }
          adminReviewItems[index].file = file;
          document.querySelector(`.admin-review-item:nth-child(${index + 1}) .review-file-name`).textContent = file.name;
        }
      }

      function adminUpdateReviewButtons() {
        const count = adminReviewItems.length;
        const addBtn = document.getElementById('admin-add-review-btn');
        const finalBtn = document.getElementById('admin-final-submit-btn');

        // Disable add button if max reached
        addBtn.disabled = count >= 10;
        addBtn.classList.toggle('opacity-50', count >= 10);
        addBtn.classList.toggle('cursor-not-allowed', count >= 10);

        // Enable final submit if min reached (3)
        const canSubmit = count >= 3;
        finalBtn.disabled = !canSubmit;
        finalBtn.classList.toggle('opacity-50', !canSubmit);
        finalBtn.classList.toggle('cursor-not-allowed', !canSubmit);
      }

      async function adminFinalSubmit() {
        // Collect data from form
        adminReviewItems = [];
        document.querySelectorAll('.admin-review-item').forEach((item, index) => {
          const fileInput = item.querySelector('.review-file-input');
          const observation = item.querySelector('.review-observation').value;
          const score = item.querySelector('.review-score:checked')?.value;

          if (fileInput.files[0]) {
            adminReviewItems[index] = {
              file: fileInput.files[0],
              observation: observation,
              score: parseInt(score) || null
            };
          }
        });

        // Validate
        if (adminReviewItems.length === 0) {
          alert('Please add at least one review');
          return;
        }

        const submitBtn = document.getElementById('admin-final-submit-btn');
        submitBtn.innerText = 'Submitting...';
        submitBtn.disabled = true;

        try {
          // Read all files as Data URLs
          const processedItems = await Promise.all(adminReviewItems.map(item => {
            return new Promise((resolve, reject) => {
              if (!item.file) resolve(null);
              const reader = new FileReader();
              reader.onload = (e) => resolve({ ...item, fileContent: e.target.result });
              reader.onerror = reject;
              reader.readAsDataURL(item.file);
            });
          }));

          // Save to localStorage
          let reviews = JSON.parse(localStorage.getItem('adminReviews') || '[]');
          const now = new Date();

          processedItems.forEach(item => {
            if (item) {
              reviews.push({
                date: now.toLocaleDateString(),
                agentId: adminCurrentAgent,
                agentName: adminCurrentAgentName,
                entity: adminCurrentEntity,
                fileName: item.file.name,
                fileContent: item.fileContent, // Store content
                score: item.score,
                observation: item.observation,
                expiryDate: new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000).toLocaleDateString()
              });
            }
          });

          localStorage.setItem('adminReviews', JSON.stringify(reviews));

          alert('Quality reviews submitted successfully!');
          adminCancelReview();
          adminLoadReviewsList();
        } catch (error) {
          console.error("Error submitting reviews:", error);
          alert("Failed to submit reviews. Please try again.");
        } finally {
          submitBtn.innerText = '‚úÖ Final Submit';
          submitBtn.disabled = false;
        }
      }

      function adminLoadReviewsList() {
        let reviews = JSON.parse(localStorage.getItem('adminReviews') || '[]');
        const tbody = document.getElementById('admin-reviews-list');

        // Remove expired reviews
        const now = new Date();
        let filtered = reviews.filter(r => new Date(r.expiryDate) >= now);
        localStorage.setItem('adminReviews', JSON.stringify(filtered));

        // Filter by current entity (admin can only see reviews for their logged-in entity)
        if (adminCurrentEntity && adminCurrentEntity !== 'ALL') {
          filtered = filtered.filter(r => r.entity === adminCurrentEntity);
        }

        // Filter by selected agent if one is chosen
        if (adminCurrentAgent) {
          filtered = filtered.filter(r => r.agentId === adminCurrentAgent);
        }

        tbody.innerHTML = filtered.map((review, idx) => `
        <tr class="hover:bg-slate-50 dark:hover:bg-slate-700/50">
          <td class="p-6">${review.date}</td>
          <td class="p-6">${review.agentName}</td>
          <td class="p-6 text-sm text-blue-600 underline cursor-pointer" onclick="openFileContent('${review.fileContent}', '${review.fileName}')">${review.fileName}</td>
          <td class="p-6"><span class="font-bold ${review.score === 100 ? 'text-emerald-600' : 'text-red-600'}">${review.score}</span></td>
          <td class="p-6 text-sm">${review.observation.substring(0, 50)}...</td>
          <td class="p-6 text-right space-x-2">
            <button onclick="adminViewReview(${idx})" class="text-blue-600 hover:text-blue-700">üëÅÔ∏è View</button>
            <button onclick="adminEditReview(${idx})" class="text-amber-600 hover:text-amber-700">‚úèÔ∏è Edit</button>
            <button onclick="adminDeleteReview(${idx})" class="text-red-600 hover:text-red-700">üóëÔ∏è Delete</button>
          </td>
        </tr>
      `).join('');
      }

      function openFileContent(content, name) {
        if (!content) return alert('File content not found.');
        // Open in new window
        const win = window.open();
        if (win) {
          win.document.write(`<iframe src="${content}" frameborder="0" style="border:0; top:0px; left:0px; bottom:0px; right:0px; width:100%; height:100%;" allowfullscreen></iframe>`);
          win.document.title = name;
        } else {
          alert('Please allow popups to view the file.');
        }
      }

      function adminViewReview(index) {
        const reviews = JSON.parse(localStorage.getItem('adminReviews') || '[]');
        const review = reviews[index];

        const choice = confirm(`File: ${review.fileName}\nAgent: ${review.agentName}\nScore: ${review.score}\nObservation: ${review.observation}\n\nClick OK to open the file.`);
        if (choice && review.fileContent) {
          openFileContent(review.fileContent, review.fileName);
        }
      }

      let currentEditIndex = -1;

      function toggleGuidelinesDropdown() {
        const content = document.getElementById('guidelines-dropdown-content');
        content.classList.toggle('hidden');
      }

      function adminEditReview(index) {
        currentEditIndex = index;
        const reviews = JSON.parse(localStorage.getItem('adminReviews') || '[]');
        const review = reviews[index];

        // Populate Modal
        document.getElementById('edit-observation').value = review.observation;
        document.getElementById('edit-current-filename').innerText = review.fileName || 'None';

        // Set Radio
        const radios = document.getElementsByName('edit-score');
        radios.forEach(r => {
          // Reset first
          r.checked = false;
          if (parseInt(r.value) === review.score) r.checked = true;
        });

        // Clear file input
        document.getElementById('edit-file-upload').value = '';

        // Show Modal
        document.getElementById('admin-edit-review-modal').classList.remove('hidden');
      }

      async function adminSaveEdit() {
        if (currentEditIndex === -1) return;

        const reviews = JSON.parse(localStorage.getItem('adminReviews') || '[]');
        const review = reviews[currentEditIndex];

        // Get Values
        const obs = document.getElementById('edit-observation').value;
        const scoreEl = document.querySelector('input[name="edit-score"]:checked');
        if (!scoreEl) return alert('Please select a score');
        const score = parseInt(scoreEl.value);

        // Handle File
        const fileInput = document.getElementById('edit-file-upload');

        const saveBtn = document.getElementById('btn-save-edit');
        saveBtn.innerText = 'Saving...';
        saveBtn.disabled = true;

        try {
          if (fileInput.files.length > 0) {
            const file = fileInput.files[0];
            const content = await new Promise((resolve, reject) => {
              const reader = new FileReader();
              reader.onload = (e) => resolve(e.target.result);
              reader.onerror = reject;
              reader.readAsDataURL(file);
            });
            review.fileName = file.name;
            review.fileContent = content; // Update content
          }

          review.observation = obs;
          review.score = score;

          // Save
          reviews[currentEditIndex] = review;
          localStorage.setItem('adminReviews', JSON.stringify(reviews));

          // Refresh & Close
          adminLoadReviewsList();
          document.getElementById('admin-edit-review-modal').classList.add('hidden');
          alert('Review updated successfully!');
        } catch (err) {
          console.error(err);
          alert('Error saving edit');
        } finally {
          saveBtn.innerText = 'Save Changes';
          saveBtn.disabled = false;
        }
      }

      function adminDeleteReview(index) {
        if (confirm('Delete this review?')) {
          let reviews = JSON.parse(localStorage.getItem('adminReviews') || '[]');
          reviews.splice(index, 1);
          localStorage.setItem('adminReviews', JSON.stringify(reviews));
          adminLoadReviewsList();
        }
      }

      function adminDeleteAllFeedback() {
        if (confirm('Delete all feedback? This action cannot be undone.')) {
          localStorage.removeItem('agentComments');
          adminLoadFeedbackList();
        }
      }

      function adminLoadFeedbackList() {
        const comments = JSON.parse(localStorage.getItem('agentComments') || '[]');
        const tbody = document.getElementById('admin-feedback-list');

        // Remove old feedback (older than 7 days)
        const now = new Date();
        const filtered = comments.filter(c => {
          const commentDate = new Date(c.date);
          const diffTime = now - commentDate;
          const diffDays = diffTime / (1000 * 60 * 60 * 24);
          return diffDays < 7;
        });
        localStorage.setItem('agentComments', JSON.stringify(filtered));

        tbody.innerHTML = filtered.map((comment, idx) => `
        <tr>
          <td class="p-6">${comment.date}</td>
          <td class="p-6">${comment.agentName}</td>
          <td class="p-6">${comment.comment}</td>
          <td class="p-6 text-right">
            <button onclick="adminDeleteFeedback(${idx})" class="text-red-600 hover:text-red-700">üóëÔ∏è Delete</button>
          </td>
        </tr>
      `).join('');
      }

      function adminDeleteFeedback(index) {
        let comments = JSON.parse(localStorage.getItem('agentComments') || '[]');
        comments.splice(index, 1);
        localStorage.setItem('agentComments', JSON.stringify(comments));
        adminLoadFeedbackList();
      }

      function adminResetWeeklyData() {
        if (confirm('Are you sure you want to RESET data for this week? This will clear current agent scores and all reviews to prepare for a new week. History will be preserved.')) {
          // Clear current performance (weekly state)
          localStorage.removeItem('gojira_performance');
          // Clear pending reviews
          localStorage.removeItem('pending_agent_reviews');
          // Clear individual admin reviews
          localStorage.removeItem('adminReviews');

          // Refresh Dashboard
          renderAdminDashboard();
          adminLoadReviewsList(); // detailed list

          alert('Weekly cycle reset successful. All data cleared for new week.');
        }
      }

      function adminFinalSubmitWeek() {
        const perfDb = JSON.parse(localStorage.getItem('gojira_performance') || '{}');
        const adminReviews = JSON.parse(localStorage.getItem('adminReviews') || '[]');

        const reviewedAgents = new Set(adminReviews.map(r => r.agentId));
        const count = new Set([...Object.keys(perfDb), ...reviewedAgents]).size;

        if (count === 0) return alert('No performance data to submit.');

        if (confirm(`Confirm Final Submission for this week? (${count} Agents Scored)`)) {
          // Logic for submission (e.g. API call) goes here
          // For now we confirm success
          alert('Weekly Performance Report Submitted Successfully!');
        }
      }

      // ===== NEW AGENT DASHBOARD FUNCTIONS =====
      function openAgentPerformanceModal() {
        const modal = document.getElementById('agent-performance-modal');
        const agentId = currentUser.id;

        document.getElementById('modal-agent-id').textContent = `ID: ${agentId}`;

        // Load reviews for this agent
        const reviews = JSON.parse(localStorage.getItem('adminReviews') || '[]');
        const agentReviews = reviews.filter(r => r.agentId === agentId);

        if (agentReviews.length === 0) {
          document.getElementById('perf-content-loaded').classList.add('hidden');
          document.getElementById('perf-content-empty').classList.remove('hidden');
          modal.classList.remove('hidden');
          return;
        }

        // Calculate stats
        const totalAudits = agentReviews.length;
        const fatalCount = agentReviews.filter(r => r.score === 0).length;
        const goodCount = agentReviews.filter(r => r.score === 100).length;
        const totalScore = (goodCount * 100) / totalAudits;

        // Display stats
        document.getElementById('modal-audit-count').textContent = totalAudits;
        document.getElementById('modal-fatal-count').textContent = fatalCount;
        document.getElementById('modal-good-count').textContent = goodCount;
        document.getElementById('modal-total-score').textContent = totalScore.toFixed(0);

        // Display reviews
        const reviewsList = document.getElementById('modal-reviews-list');
        reviewsList.innerHTML = agentReviews.map((review, idx) => `
        <div class="bg-slate-50 dark:bg-slate-700 p-4 rounded-lg border border-slate-200 dark:border-slate-600">
          <div class="flex justify-between items-start mb-2">
            <div>
              <p class="font-bold text-sm">Review #${idx + 1}</p>
              <p class="text-xs text-slate-500">${review.date}</p>
            </div>
            <span class="font-bold ${review.score === 100 ? 'text-emerald-600 text-lg' : 'text-red-600 text-lg'}">Score: ${review.score}</span>
          </div>
          <p class="text-sm mb-2"><strong>File:</strong> ${review.fileName}</p>
          <p class="text-sm mb-2"><strong>Observation:</strong> ${review.observation}</p>
          <button onclick="agentViewReviewDetail(${idx})" class="text-blue-600 hover:text-blue-700 text-sm">üëÅÔ∏è View Details</button>
        </div>
      `).join('');

        document.getElementById('perf-content-loaded').classList.remove('hidden');
        document.getElementById('perf-content-empty').classList.add('hidden');
        modal.classList.remove('hidden');
      }

      let currentReviewIndex = null;

      function agentViewReviewDetail(index) {
        currentReviewIndex = index;
        const reviews = JSON.parse(localStorage.getItem('adminReviews') || '[]');
        const agentId = currentUser.id; // Corrected: Using global currentUser
        const agentReviews = reviews.filter(r => r.agentId === agentId);
        const review = agentReviews[index];

        // Find actual index in main array for saving later
        // Because we filtered by agentId, 'index' is local. We need the real index to save reply.
        // Simple strategy: Store the unique timestamp/ID or just iterate to find it.
        // For now, let's just find it by properties matching since we don't have IDs on reviews yet.
        // IMPROVEMENT: We should add IDs to reviews. But assuming uniqueness of timestamp+agent.

        // Populate Modal
        document.getElementById('modal-review-filename').innerText = review.fileName;
        document.getElementById('modal-review-filename').onclick = () => openFileContent(review.fileContent, review.fileName);

        const scoreEl = document.getElementById('modal-review-score');
        scoreEl.innerText = review.score;
        scoreEl.className = `font-black text-2xl ${review.score === 100 ? 'text-emerald-600' : 'text-red-600'}`;

        document.getElementById('modal-review-observation').innerText = review.observation;

        // Reply Logic
        const replyForm = document.getElementById('modal-reply-form');
        const existingReply = document.getElementById('modal-existing-reply');

        if (review.agentReply) {
          existingReply.classList.remove('hidden');
          document.getElementById('modal-reply-text').innerText = review.agentReply;
          replyForm.classList.add('hidden');
        } else {
          existingReply.classList.add('hidden');
          replyForm.classList.remove('hidden');
          document.getElementById('modal-reply-input').value = '';
        }

        document.getElementById('view-review-modal').classList.remove('hidden');
      }

      function closeReviewModal() {
        document.getElementById('view-review-modal').classList.add('hidden');
      }

      function submitAgentReply() {
        const reply = document.getElementById('modal-reply-input').value.trim();
        if (!reply) return alert("Please write a reply.");

        const reviews = JSON.parse(localStorage.getItem('adminReviews') || '[]');
        const agentId = currentUser.id;

        // Find the specific review to update. 
        // Since we don't have IDs, we match by AgentID + Date + FileName (should be unique enough)
        // Or getting the 'index' from the filtered list passed to ViewDetail.

        // Re-get filtered list to find the match
        let agentReviews = reviews.filter(r => r.agentId === agentId);
        let targetReview = agentReviews[currentReviewIndex];

        // Now find this object in the main 'reviews' array
        let mainIndex = reviews.findIndex(r =>
          r.agentId === targetReview.agentId &&
          r.date === targetReview.date &&
          r.fileName === targetReview.fileName
        );

        if (mainIndex !== -1) {
          reviews[mainIndex].agentReply = reply;
          reviews[mainIndex].agentReplyDate = new Date().toISOString();
          localStorage.setItem('adminReviews', JSON.stringify(reviews));

          // Notify Admin
          NotificationManager.notifyAdmin(`Reply from ${currentUser.name} on review ${targetReview.fileName}: "${reply.substring(0, 20)}..."`);

          alert("Reply sent successfully!");
          closeReviewModal();
          // Maybe refresh the modal if we want to show it immediately
        }
      }

      function agentSubmitComment() {
        const textarea = document.getElementById('agent-comment-input');
        const comment = textarea.value.trim();

        if (!comment) {
          alert('Please enter a comment');
          return;
        }

        let comments = JSON.parse(localStorage.getItem('agentComments') || '[]');
        comments.push({
          date: new Date().toLocaleDateString(),
          agentId: currentUser.id,
          agentName: currentUser.name,
          comment: comment
        });

        localStorage.setItem('agentComments', JSON.stringify(comments));
        textarea.value = '';
        localStorage.setItem('agentComments', JSON.stringify(comments));

        // Notify Admin
        NotificationManager.notifyAdmin(`New feedback from Agent ${currentUser.name}: "${comment.substring(0, 20)}..."`);

        textarea.value = '';
        alert('Your feedback has been sent to admin!');
      }

      function closeAgentPerformanceModal() {
        document.getElementById('agent-performance-modal').classList.add('hidden');
        document.getElementById('agent-comment-input').value = '';
      }

      // Load reviews on page load
      window.addEventListener('load', function () {
        // Restore Session
        const storedUser = localStorage.getItem('currentUser');
        if (storedUser) {
          currentUser = JSON.parse(storedUser);
          // Skip Login
          document.getElementById('view-login').style.display = 'none';
          document.getElementById('app-container').style.display = 'block';
          document.getElementById('app-container').style.opacity = '1';

          // Set Greeting
          const greeting = document.getElementById('home-greeting');
          if (greeting) greeting.innerText = `Hii ${currentUser.name}`;

          if (currentUser.role === 'admin') {
            renderAdminDashboard();
          } else {
            renderAgentDashboard();
          }
        }

        adminLoadReviewsList();
        adminLoadFeedbackList();
      });
      // ===== LOGIN SYSTEM =====
      const DEFAULT_PASSWORD = '1234';

      function handleLoginKey(e) {
        if (e.key === 'Enter') attemptLogin();
      }

      function attemptLogin() {
        const empidInput = document.getElementById('login-empid').value.trim();
        const passwordInput = document.getElementById('login-password').value;
        const errorMsg = document.getElementById('login-error');

        // Validate Input
        if (!empidInput || !passwordInput) {
          errorMsg.innerText = "Please enter Employee ID and Password";
          errorMsg.classList.remove('hidden');
          shakeLogin();
          return;
        }

        // Find User
        const user = USER_DB.find(u => u.id === empidInput);

        // Check Creds
        // Note: Using a single pass for all for demo, or stored individual
        // Ideally should match user.password if it existed in DB
        const globalPass = localStorage.getItem('agentPassword') || DEFAULT_PASSWORD;

        if (user && (passwordInput === globalPass || passwordInput === DEFAULT_PASSWORD)) {
          // Success
          currentUser = user; // Set Global User
          localStorage.setItem('currentUser', JSON.stringify(currentUser)); // Session Persistence

          errorMsg.classList.add('hidden');

          // Set Personalized Greeting
          document.getElementById('home-greeting').innerText = `Hii ${user.name}`;

          // Re-render dashboards based on user
          if (user.role === 'admin') {
            renderAdminDashboard();
            document.getElementById('view-admin').classList.remove('hidden'); // Ensure available
          } else {
            renderAgentDashboard();
          }

          triggerDoorAnimation();
        } else {
          // Failure
          errorMsg.innerText = "Invalid Credenitals";
          errorMsg.classList.remove('hidden');
          shakeLogin();
        }
      }

      function shakeLogin() {
        const container = document.querySelector('.login-form-container');
        container.style.transform = 'translateX(10px)';
        setTimeout(() => container.style.transform = 'translateX(-10px)', 100);
        setTimeout(() => container.style.transform = 'translateX(10px)', 200);
        setTimeout(() => container.style.transform = 'translateX(0)', 300);
      }

      function openChangePasswordModal() {
        document.getElementById('modal-change-password').classList.remove('hidden');
      }

      function closeChangePasswordModal() {
        document.getElementById('modal-change-password').classList.add('hidden');
        document.getElementById('cp-current').value = '';
        document.getElementById('cp-new').value = '';
        document.getElementById('cp-confirm').value = '';
      }

      function submitChangePassword() {
        const currentInput = document.getElementById('cp-current').value;
        const newPass = document.getElementById('cp-new').value;
        const confirmPass = document.getElementById('cp-confirm').value;

        const storedPass = localStorage.getItem('agentPassword') || DEFAULT_PASSWORD;

        if (currentInput !== storedPass) {
          alert('Current password is incorrect.');
          return;
        }

        if (newPass.length < 4) {
          alert('New password must be at least 4 characters.');
          return;
        }

        if (newPass !== confirmPass) {
          alert('New passwords do not match.');
          return;
        }

        localStorage.setItem('agentPassword', newPass);
        alert('Password changed successfully!');
        closeChangePasswordModal();
      }

      function triggerDoorAnimation() {
        const loginContent = document.getElementById('login-content');

        // Open doors class trigger
        document.body.classList.add('doors-open');

        // Fade out login content
        loginContent.style.opacity = '0';
        loginContent.style.transform = 'scale(0.5)';

        setTimeout(() => {
          // Hide login view
          const loginView = document.getElementById('view-login');
          loginView.style.opacity = '0';
          loginView.style.transition = 'opacity 1s ease';

          // Show App
          const app = document.getElementById('app-container');
          app.style.display = 'block';

          // Small delay to allow display:block to apply before opacity transition
          setTimeout(() => {
            app.style.opacity = '1';
            // Remove login view from DOM or hide completely
            setTimeout(() => {
              loginView.style.display = 'none';
            }, 1000);
          }, 50);

        }, 1200); // Wait for door animation
      }

      function toggleNotifications() {
        const dropdown = document.getElementById('notification-dropdown');
        dropdown.classList.toggle('hidden');
        if (!dropdown.classList.contains('hidden')) {
          NotificationManager.renderDropdown();
        }
      }

    </script>
  </div> <!-- Close app-container -->
</body>

</html>
