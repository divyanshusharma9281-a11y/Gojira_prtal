<!DOCTYPE html>
<html lang="en" class="light">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gojira TP | Training Portal</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = { darkMode: 'class' }
  </script>

  <!-- Fonts -->
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Montserrat:wght@700&display=swap"
    rel="stylesheet">

  <style>
    body {
      font-family: 'Inter', sans-serif;
    }

    .app-view {
      display: none;
      min-height: 100vh;
    }

    .app-view.active {
      display: block;
    }

    .hover-lift:hover {
      transform: translateY(-8px);
      box-shadow: 0 20px 30px -10px rgba(0, 0, 0, .15);
    }

    .faq-answer {
      max-height: 0;
      overflow: hidden;
      opacity: 0;
      transition: all 0.4s ease;
    }

    .faq-item.active .faq-answer {
      max-height: 1200px;
      opacity: 1;
      padding-top: 0.75rem;
    }

    .tab-content {
      display: block;
    }

    .hidden {
      display: none;
    }

    .stylish {
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
    }

    .glow {
      box-shadow: 0 0 20px rgba(59, 130, 246, 0.5);
    }

    .animate-fade-in {
      animation: fadeIn 0.5s ease-in-out;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
  </style>
</head>

<body class="bg-slate-50 text-slate-900 dark:bg-slate-900 dark:text-slate-100 transition-colors duration-300">

  <!-- MAIN PORTAL LOGIN SCREEN -->
  <div id="portal-login-screen"
    class="fixed inset-0 bg-gradient-to-br from-indigo-600 to-blue-600 flex items-center justify-center z-50">
    <div class="bg-white dark:bg-slate-800 p-12 rounded-3xl shadow-2xl max-w-md w-full mx-4">
      <div class="text-center mb-8">
        <div
          class="w-16 h-16 bg-indigo-600 rounded-full flex items-center justify-center text-white font-bold text-3xl mx-auto mb-4">
          G</div>
        <h1 class="text-3xl font-bold text-indigo-600">Gojira TP</h1>
        <p class="text-slate-600 dark:text-slate-400 text-sm mt-2">Training Portal Login</p>
      </div>

      <form onsubmit="portalLogin(event)">
        <div class="mb-6">
          <label class="block text-sm font-semibold mb-2">Employee ID</label>
          <input id="portal-emp-id" type="text" required placeholder="Enter your Employee ID"
            class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-lg bg-slate-50 dark:bg-slate-700 focus:border-indigo-600 focus:ring-2 focus:ring-indigo-200 outline-none transition">
        </div>

        <div class="mb-6">
          <label class="block text-sm font-semibold mb-2">Password</label>
          <input id="portal-password" type="password" required placeholder="Enter your password"
            class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-lg bg-slate-50 dark:bg-slate-700 focus:border-indigo-600 focus:ring-2 focus:ring-indigo-200 outline-none transition">
        </div>

        <button type="submit"
          class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 transition mb-4">Login</button>
      </form>

      <div class="text-center">
        <button onclick="showChangePasswordModal()"
          class="text-indigo-600 hover:text-indigo-700 text-sm font-semibold underline">Change Password</button>
      </div>
    </div>
  </div>

  <!-- CHANGE PASSWORD MODAL -->
  <div id="change-password-modal"
    class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white dark:bg-slate-800 p-8 rounded-3xl shadow-lg max-w-md w-full mx-4">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold">Change Password</h2>
        <button onclick="hideChangePasswordModal()"
          class="text-slate-500 hover:text-slate-700 text-2xl">&times;</button>
      </div>

      <form onsubmit="submitChangePassword(event)">
        <div class="mb-6">
          <label class="block text-sm font-semibold mb-2">Employee ID</label>
          <input id="change-pass-emp-id" type="text" required placeholder="Enter your Employee ID"
            class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-lg bg-slate-50 dark:bg-slate-700 focus:border-indigo-600 outline-none transition">
        </div>

        <div class="mb-6">
          <label class="block text-sm font-semibold mb-2">Current Password</label>
          <input id="change-pass-current" type="password" required placeholder="Enter current password"
            class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-lg bg-slate-50 dark:bg-slate-700 focus:border-indigo-600 outline-none transition">
        </div>

        <div class="mb-6">
          <label class="block text-sm font-semibold mb-2">New Password</label>
          <input id="change-pass-new" type="password" required placeholder="Enter new password"
            class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-lg bg-slate-50 dark:bg-slate-700 focus:border-indigo-600 outline-none transition">
        </div>

        <button type="submit"
          class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 transition">Update
          Password</button>
      </form>
    </div>
  </div>

  <!-- TOP NAV (hidden initially) -->
  <nav id="top-nav"
    class="hidden bg-white dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700 sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-6 py-3 flex items-start justify-between">
      <div onclick="navigateTo('view-home')" class="flex gap-3 cursor-pointer group">
        <div
          class="w-12 h-12 bg-slate-900 dark:bg-slate-700 rounded flex items-center justify-center text-white font-bold group-hover:bg-blue-600 transition glow">
          G</div>
        <div class="flex flex-col">
          <span
            class="font-['Montserrat'] text-3xl text-transparent bg-clip-text bg-gradient-to-r from-blue-500 via-purple-500 to-indigo-600 stylish leading-none">
            Gojira TP
          </span>
        </div>
      </div>

      <div class="flex flex-col items-end gap-2">
        <div class="flex items-center gap-2">
          <button onclick="toggleSearch()" class="text-slate-500 hover:text-blue-600 text-xl">üîç</button>
          <button onclick="toggleTheme()"
            class="flex items-center gap-2 px-4 py-2 rounded-full bg-slate-100 dark:bg-slate-700 text-sm font-semibold transition">
            <span id="theme-icon">üåô</span>
            <span id="theme-text">Dark</span>
          </button>

          <!-- Agent Notification (Home) -->
          <div class="relative cursor-pointer hover:bg-slate-100 dark:hover:bg-slate-700 p-2 rounded-full transition agent-notification-bell"
            onclick="checkAgentNotifications(true)" title="Check Updates">
            <span class="text-xl">üîî</span>
            <span
              class="agent-notification-dot hidden absolute top-0 right-0 w-3 h-3 bg-red-500 rounded-full border-2 border-white dark:border-slate-800"></span>
          </div>

          <button onclick="portalLogout()"
            class="flex items-center gap-2 px-4 py-2 rounded-full bg-red-100 dark:bg-red-900 text-red-600 dark:text-red-300 text-sm font-semibold hover:bg-red-200 dark:hover:bg-red-800 transition">
            üö™ Logout
          </button>
        </div>

        <div id="search-bar" class="hidden">
          <input id="search-input" type="text" oninput="performSearch(this.value)" placeholder="Search portal..."
            class="px-4 py-2 rounded-full bg-slate-100 dark:bg-slate-700 text-sm w-64">
          <div id="search-results"
            class="mt-2 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg shadow-lg max-h-60 overflow-y-auto">
          </div>
        </div>
      </div>
    </div>
  </nav>

  <!-- HOME -->
  <div id="view-home" class="app-view active">
    <main class="max-w-7xl mx-auto px-6 py-20 text-center">
      <p id="home-user-greeting" class="text-3xl font-bold text-blue-600 dark:text-blue-400 mb-4">Hi Guest</p>

      <h1 class="text-5xl font-extrabold mb-12">
        Welcome to
        <span class="text-transparent bg-clip-text bg-gradient-to-r from-blue-600 to-indigo-600">
          Training & Quality Portal
        </span>
      </h1>

      <div class="grid grid-cols-1 md:grid-cols-4 gap-8" style="pointer-events: auto;">
        <div onclick="navigateTo('view-kb')"
          class="p-10 rounded-[2.5rem] cursor-pointer hover-lift bg-blue-600 text-white" style="pointer-events: auto;">
          <div class="w-16 h-16 bg-white/20 rounded-2xl mx-auto mb-6 flex items-center justify-center text-3xl">üìò</div>
          <h2 class="text-2xl font-bold mb-2">Knowledge Base</h2>
          <p class="text-sm opacity-90">Crucial FAQs and operational guidelines.</p>
        </div>

        <div onclick="navigateTo('view-entities')"
          class="p-10 rounded-[2.5rem] cursor-pointer hover-lift bg-indigo-600 text-white"
          style="pointer-events: auto;">
          <div class="w-16 h-16 bg-white/20 rounded-2xl mx-auto mb-6 flex items-center justify-center text-3xl">üè¶</div>
          <h2 class="text-2xl font-bold mb-2">Brand Entities</h2>
        </div>

        <div onclick="navigateTo('view-updates')"
          class="p-10 rounded-[2.5rem] cursor-pointer hover-lift bg-amber-500 text-white" style="pointer-events: auto;">
          <div class="w-16 h-16 bg-white/20 rounded-2xl mx-auto mb-6 flex items-center justify-center text-3xl">üì¢</div>
          <h2 class="text-2xl font-bold mb-2">New Updates</h2>
          <p class="text-sm opacity-90">Latest system & policy logs.</p>
        </div>

        <div onclick="navigateTo('view-resources')"
          class="p-10 rounded-[2.5rem] cursor-pointer hover-lift bg-purple-600 text-white"
          style="pointer-events: auto;">
          <div class="w-16 h-16 bg-white/20 rounded-2xl mx-auto mb-6 flex items-center justify-center text-3xl">üìÅ</div>
          <h2 class="text-2xl font-bold mb-2">Resources</h2>
          <p class="text-sm opacity-90">Guidelines and quality checkup</p>
        </div>
      </div>
    </main>
  </div>

  <!-- KNOWLEDGE BASE -->
  <div id="view-kb" class="app-view bg-white dark:bg-slate-900">
    <header
      class="h-16 flex items-center px-6 border-b border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800">
      <button onclick="navigateTo('view-home')" class="font-bold text-slate-500 hover:text-blue-600">‚Üê Home</button>
      <span class="mx-auto font-bold">Knowledge Base</span>
    </header>
    <div class="max-w-4xl mx-auto px-6 py-14">
      <h1 class="text-4xl font-extrabold mb-10">Frequently Asked Questions</h1>
      <div class="space-y-4">
        <!-- 1 -->
        <div class="faq-item border-b pb-4">
          <button onclick="toggleFaq(this)" class="w-full text-left font-bold text-lg">1. My loan is approved but not
            disbursed. Why?</button>
          <div class="faq-answer text-slate-600 dark:text-slate-300">
            <p class="mb-2">Loan disbursement may be pending due to:</p>
            <ul class="list-disc ml-6 space-y-1">
              <li>Incomplete documentation</li>
              <li>Bank account verification</li>
              <li>Internal compliance or risk checks</li>
            </ul>
            <p class="mt-2 font-medium">Our team will assist you with the exact reason.</p>
          </div>
        </div>

        <!-- 2 -->
        <div class="faq-item border-b pb-4">
          <button onclick="toggleFaq(this)" class="w-full text-left font-bold text-lg">2. Can I increase my loan amount
            after sanction?</button>
          <div class="faq-answer text-slate-600 dark:text-slate-300">
            <p class="mb-2">Loan enhancement depends on below mentioned criteria but can be done while accepting the
              offer not post sanction:</p>
            <ul class="list-disc ml-6 space-y-1">
              <li>Your credit profile</li>
              <li>Repayment history</li>
              <li>Internal eligibility checks</li>
            </ul>
            <p class="mt-2">You may reapply after closing or maintaining a good repayment track.</p>
          </div>
        </div>

        <!-- 3 -->
        <div class="faq-item border-b pb-4">
          <button onclick="toggleFaq(this)" class="w-full text-left font-bold text-lg">3. Why was my loan application
            rejected?</button>
          <div class="faq-answer text-slate-600 dark:text-slate-300">
            <p class="mb-2">Loan applications can be rejected due to:</p>
            <ul class="list-disc ml-6 space-y-1">
              <li>Credit score or repayment history</li>
              <li>Existing liabilities</li>
              <li>Internal risk assessment</li>
            </ul>
            <p class="mt-2">Customer care can guide but cannot override system decisions.</p>
          </div>
        </div>

        <!-- 4 -->
        <div class="faq-item border-b pb-4">
          <button onclick="toggleFaq(this)" class="w-full text-left font-bold text-lg">4. How long does it take for
            repayment to reflect after payment?</button>
          <div class="faq-answer text-slate-600 dark:text-slate-300">
            <p>Payments usually reflect within 24‚Äì48 working hours. Delays may occur due to bank processing or holidays.
            </p>
          </div>
        </div>

        <!-- 5 -->
        <div class="faq-item border-b pb-4">
          <button onclick="toggleFaq(this)" class="w-full text-left font-bold text-lg">5. How is my total payable amount
            calculated?</button>
          <div class="faq-answer text-slate-600 dark:text-slate-300">
            <p class="mb-2">Your payable amount includes:</p>
            <ul class="list-disc ml-6 space-y-1">
              <li>Loan Amount</li>
              <li>Interest calculated till the repayment date</li>
              <li>Penalty (2% post repayment date where 1% is daily interest and 1% is penalty)</li>
            </ul>
          </div>
        </div>

        <!-- 6 -->
        <div class="faq-item border-b pb-4">
          <button onclick="toggleFaq(this)" class="w-full text-left font-bold text-lg">6. Will my credit score be
            affected if I delay payment?</button>
          <div class="faq-answer text-slate-600 dark:text-slate-300">
            <p>Yes. Any delay in repayment may negatively impact your CIBIL score, which can affect future loan or
              credit card approvals.</p>
          </div>
        </div>

        <!-- 7 -->
        <div class="faq-item border-b pb-4">
          <button onclick="toggleFaq(this)" class="w-full text-left font-bold text-lg">7. I have already shared a
            Promise to Pay (PTP). Why am I being called again?</button>
          <div class="faq-answer text-slate-600 dark:text-slate-300">
            <p class="mb-2">We may call to:</p>
            <ul class="list-disc ml-6 space-y-1">
              <li>Confirm your payment readiness</li>
              <li>Check if funds have been arranged</li>
              <li>Assist you in making the payment earlier, if possible</li>
            </ul>
            <p class="mt-2">This helps avoid further penalties or escalation.</p>
          </div>
        </div>

        <!-- 8 -->
        <div class="faq-item border-b pb-4">
          <button onclick="toggleFaq(this)" class="w-full text-left font-bold text-lg">8. Will I continue to receive
            calls after making the payment?</button>
          <div class="faq-answer text-slate-600 dark:text-slate-300">
            <p>No. Once the payment is successfully received and updated in our system, collection calls will stop.</p>
            <p class="mt-2">If you still receive a call, please share the payment reference number with the agent.</p>
          </div>
        </div>

        <!-- 9 -->
        <div class="faq-item border-b pb-4">
          <button onclick="toggleFaq(this)" class="w-full text-left font-bold text-lg">9. What is NBFC?</button>
          <div class="faq-answer text-slate-600 dark:text-slate-300">
            <p>NBFC means Non-Banking Financial Company. It is a company that gives loans, but it is not a bank.</p>
            <div class="mt-4 p-4 bg-slate-50 dark:bg-slate-800 rounded-xl space-y-2">
              <p>üè¶ <strong>Bank</strong> = savings account + loans</p>
              <p>üí∞ <strong>NBFC</strong> = only loans</p>
            </div>
            <ul class="list-disc ml-6 mt-4 space-y-1">
              <li>NBFCs give personal loans, business loans, etc.</li>
              <li>They are approved by RBI</li>
              <li>You cannot open a savings account in an NBFC</li>
              <li>They are commonly used in instant loan apps</li>
            </ul>
            <p class="mt-3 text-sm italic">Example: If you take a quick loan from an app and get money fast, it is
              usually an NBFC, not a bank.</p>
          </div>
        </div>

        <!-- 10 -->
        <div class="faq-item border-b pb-4">
          <button onclick="toggleFaq(this)" class="w-full text-left font-bold text-lg">10. What is an Account
            Aggregator?</button>
          <div class="faq-answer text-slate-600 dark:text-slate-300">
            <p class="mb-3">An Account Aggregator (AA) is a secure system that lets you share your bank details
              digitally with a lender only after your permission. It helps banks/NBFCs check your financial data online,
              without paperwork.</p>
            <h4 class="font-bold mb-2">How it works:</h4>
            <ol class="list-decimal ml-6 space-y-1 mb-4">
              <li>You give consent</li>
              <li>Your bank statement / financial data is shared securely</li>
              <li>The lender checks your eligibility</li>
              <li>Loan gets processed faster</li>
            </ol>
            <div class="grid grid-cols-2 gap-2 text-sm">
              <div class="bg-slate-100 dark:bg-slate-800 p-2 rounded">üîí Safe & secure</div>
              <div class="bg-slate-100 dark:bg-slate-800 p-2 rounded">‚úÖ RBI regulated</div>
              <div class="bg-slate-100 dark:bg-slate-800 p-2 rounded">‚ùå No data without consent</div>
              <div class="bg-slate-100 dark:bg-slate-800 p-2 rounded">‚ö° Quick & paperless</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- BRAND ENTITIES -->
  <div id="view-entities" class="app-view">
    <header class="h-16 flex items-center px-6 border-b bg-white dark:bg-slate-800">
      <button onclick="navigateTo('view-home')" class="font-bold text-slate-500 hover:text-blue-600">‚Üê Home</button>
      <span class="mx-auto font-bold">Brand Entities</span>
    </header>

    <div class="max-w-6xl mx-auto px-6 py-14 text-center">
      <h1 class="text-3xl font-extrabold mb-12">Select an Entity to View Guidelines</h1>

      <div class="grid md:grid-cols-4 gap-8">
        <div onclick="navigateTo('view-bharatloan')"
          class="relative p-8 rounded-3xl cursor-pointer hover-lift bg-gradient-to-r from-blue-800 via-red-600 to-blue-900 text-white">
          <div
            class="w-16 h-16 bg-black rounded-2xl mx-auto mb-4 flex items-center justify-center font-extrabold text-2xl text-white">
            B</div>
          <h3 class="font-bold text-lg">BharatLoan</h3>
        </div>

        <div onclick="navigateTo('view-rupee112')"
          class="relative p-8 rounded-3xl cursor-pointer hover-lift bg-gradient-to-r from-green-500 to-red-600 text-white">
          <div
            class="w-16 h-16 bg-black rounded-2xl mx-auto mb-4 flex items-center justify-center font-extrabold text-2xl text-white">
            ‚Çπ</div>
          <h3 class="font-bold text-lg">Rupee112</h3>
        </div>

        <div onclick="navigateTo('view-loan112')"
          class="relative p-8 rounded-3xl cursor-pointer hover-lift bg-gradient-to-r from-blue-900 to-red-600 text-white">
          <div
            class="w-16 h-16 bg-black rounded-2xl mx-auto mb-4 flex items-center justify-center font-extrabold text-2xl text-white">
            L</div>
          <h3 class="font-bold text-lg">Loan112</h3>
        </div>

        <div onclick="navigateTo('view-rupeeontime')"
          class="relative p-8 rounded-3xl cursor-pointer hover-lift bg-gradient-to-r from-purple-600 to-red-600 text-white">
          <div
            class="w-16 h-16 bg-black rounded-2xl mx-auto mb-4 flex items-center justify-center font-extrabold text-2xl text-white">
            ‚úî</div>
          <h3 class="font-bold text-lg">RupeeOnTime</h3>
        </div>
      </div>
    </div>
  </div>

  <!-- UPDATES -->
  <div id="view-updates" class="app-view bg-white dark:bg-slate-900">
    <header class="h-16 flex items-center px-6 border-b bg-white dark:bg-slate-800">
      <button onclick="navigateTo('view-home')" class="font-bold text-slate-500 hover:text-blue-600">‚Üê Home</button>
      <span class="mx-auto font-bold">System Updates</span>
    </header>
    <div class="max-w-4xl mx-auto px-6 py-14">
      <h2 class="text-3xl font-extrabold mb-8">Recent Policy Changes</h2>
      <div
        class="bg-blue-50 dark:bg-slate-800 p-8 rounded-3xl border border-blue-100 dark:border-slate-700 text-center">
        <div class="text-4xl mb-4">‚ú®</div>
        <h3 class="text-xl font-bold mb-2">Stay Tuned!</h3>
        <p class="text-slate-600 dark:text-slate-400">There are no new updates currently.</p>
      </div>
    </div>
  </div>

  <!-- BHARATLOAN SPECIFIC VIEW -->
  <div id="view-bharatloan" class="app-view bg-white dark:bg-slate-900">
    <header
      class="h-16 flex items-center justify-between px-6 border-b border-slate-200 dark:border-slate-700 bg-gradient-to-r from-red-600 to-blue-900 text-white relative">
      <button onclick="navigateTo('view-entities')" class="font-bold text-white hover:text-blue-600">‚Üê Back to
        Entities</button>
      <button onclick="toggleDropdown('')" class="text-white hover:text-blue-600">Support üìû</button>
      <div id="support-dropdown"
        class="hidden absolute top-full right-0 mt-2 bg-gradient-to-r from-blue-800 via-red-600 to-blue-900 text-white border border-slate-200 dark:border-slate-700 rounded-lg shadow-lg p-4 z-10">
        <h4 class="font-bold mb-2">Contact Support</h4>
        <p><strong>Call:</strong> 8282824644</p>
        <p><strong>Email:</strong> care@bharatloan.com</p>
      </div>
    </header>

    <div class="max-w-5xl mx-auto px-6 py-14">
      <!-- Tabs -->
      <div class="flex border-b border-slate-200 dark:border-slate-700 mb-8">
        <button onclick="showTab('tools')" id="tab-tools"
          class="px-6 py-3 font-bold text-blue-600 border-b-2 border-blue-600">Our Operating Tools</button>
      </div>

      <!-- Tools Tab Content -->
      <div id="content-tools" class="tab-content">
        <div class="grid gap-6">
          <div
            class="group bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 p-6 rounded-3xl transition-all hover:shadow-lg">
            <div class="flex flex-col md:flex-row md:items-center justify-between gap-6">
              <div class="flex-1">
                <h3 class="text-xl font-bold mb-2">BharatLoan Portal and Search Module</h3>
                <p class="text-slate-600 dark:text-slate-300 text-sm leading-relaxed">
                  Main application processing, document view, and status checks. Customer search via PAN, Mobile, or
                  Email.
                </p>
              </div>
              <a href="https://bharatloanfintech.com/" target="_blank"
                class="bg-blue-600 text-white font-bold py-3 px-6 rounded-xl hover:bg-blue-700 transition">Visit Portal
                ‚Üó</a>
            </div>
          </div>

          <div
            class="group bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 p-6 rounded-3xl transition-all hover:shadow-lg">
            <div class="flex flex-col md:flex-row md:items-center justify-between gap-6">
              <div class="flex-1">
                <h3 class="text-xl font-bold mb-2">WOCOM 365</h3>
                <p class="text-slate-600 dark:text-slate-300 text-sm leading-relaxed">
                  Telephony integration, lead management, and communication logging.
                </p>
              </div>
              <a href="https://cpaas.wocom365.com/" target="_blank"
                class="bg-emerald-600 text-white font-bold py-3 px-6 rounded-xl hover:bg-emerald-700 transition">Open
                WOCOM ‚Üó</a>
            </div>
          </div>

          <div
            class="group bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 p-6 rounded-3xl transition-all hover:shadow-lg">
            <div class="flex flex-col md:flex-row md:items-center justify-between gap-6">
              <div class="flex-1">
                <h3 class="text-xl font-bold mb-2">Yellow Ai</h3>
                <p class="text-slate-600 dark:text-slate-300 text-sm leading-relaxed">
                  Handle real-time customer chats efficiently through the AI-powered cloud platform.
                </p>
              </div>
              <a href="https://cloud.yellow.ai/auth/login" target="_blank"
                class="bg-indigo-600 text-white font-bold py-3 px-6 rounded-xl hover:bg-indigo-700 transition">Login
                Chat ‚Üó</a>
            </div>
          </div>

          <div
            class="group bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 p-6 rounded-3xl transition-all hover:shadow-lg">
            <div class="flex flex-col md:flex-row md:items-center justify-between gap-6">
              <div class="flex-1">
                <h3 class="text-xl font-bold mb-2">Outlook (Care@bharatloan.com)</h3>
                <p class="text-slate-600 dark:text-slate-300 text-sm leading-relaxed">
                  Review customer emails and attachments. Standard channel for ticketing and complex queries.
                </p>
              </div>
              <a href="https://outlook.office.com/mail/" target="_blank"
                class="bg-amber-500 text-white font-bold py-3 px-6 rounded-xl hover:bg-amber-600 transition">Open Mail
                ‚Üó</a>
            </div>
          </div>
        </div>
      </div>


    </div>
  </div>

  <!-- RESOURCES -->
  <div id="view-resources" class="app-view bg-white dark:bg-slate-900">
    <header class="h-16 flex items-center px-6 border-b bg-white dark:bg-slate-800">
      <button onclick="navigateTo('view-home')" class="font-bold text-slate-500 hover:text-blue-600">‚Üê Home</button>
      <span class="mx-auto font-bold">Resources</span>
    </header>
    <div class="max-w-4xl mx-auto px-6 py-14">
      <div class="space-y-6">
        <div
          class="bg-slate-50 dark:bg-slate-800 p-6 rounded-3xl border border-slate-200 dark:border-slate-700 cursor-pointer hover:border-purple-600 transition"
          onclick="document.getElementById('guidelines-list').classList.toggle('hidden')">
          <div class="flex items-center gap-4">
            <div class="w-12 h-12 bg-purple-600 text-white rounded-xl flex items-center justify-center text-xl">üìÑ</div>
            <div class="flex-1">
              <h3 class="text-xl font-bold">Guidelines</h3>
              <p class="text-slate-600 dark:text-slate-300">Click to view operational procedures.</p>
            </div>
            <div class="text-2xl text-slate-400">‚ñº</div>
          </div>

          <div id="guidelines-list" class="hidden space-y-4 mt-6 pt-6 border-t border-slate-200 dark:border-slate-700"
            onclick="event.stopPropagation()">
            <!-- 1. Payment Queries -->
            <div class="faq-item border-b border-slate-200 dark:border-slate-700 pb-4">
              <button onclick="toggleFaq(this)" class="w-full text-left font-bold text-lg">1. Payment Queries</button>
              <div class="faq-answer text-slate-600 dark:text-slate-300 text-sm">
                <div class="mb-4 mt-2">
                  <h4 class="font-bold text-slate-800 dark:text-slate-100 mb-2">A. Payment Not Reflecting (Agent Portal)
                  </h4>
                  <p><strong>Step 1:</strong> Verbally confirm the exact payment amount with the customer.</p>
                  <p><strong>Step 2:</strong> Update the WhatsApp Group immediately with the confirmed amount.</p>
                  <p><strong>Step 3:</strong> Escalate/Tag the concerned team via email.</p>
                  <p class="text-red-500 font-bold mt-1">Rule: Escalation is forbidden without prior amount
                    confirmation.</p>
                </div>
                <div>
                  <h4 class="font-bold text-slate-800 dark:text-slate-100 mb-2">B. Payment Reflecting (Verification
                    Pending)</h4>
                  <p><strong>Script:</strong> "We have received your payment of ‚Çπ[Amount]. Your payment is currently
                    under verification and will be updated within 24 hours (maximum)."</p>
                </div>
              </div>
            </div>

            <!-- 2. Application Status Queries -->
            <div class="faq-item border-b border-slate-200 dark:border-slate-700 pb-4">
              <button onclick="toggleFaq(this)" class="w-full text-left font-bold text-lg">2. Application Status
                Queries</button>
              <div class="faq-answer text-slate-600 dark:text-slate-300 text-sm">
                <div class="mb-4 mt-2">
                  <h4 class="font-bold text-slate-800 dark:text-slate-100 mb-2">A. Incomplete Applications
                    (Leads/Partial/eKYC Pending)</h4>
                  <p><strong>Script:</strong> "Your application is currently in process. Kindly complete the remaining
                    steps 100% through the application. If you are facing any issues, please visit our website or
                    contact us at care@bharatloan.com and try again after some time."</p>
                  <p class="mt-2"><strong>If asked about time:</strong> "There is a maximum processing time of 24 hours
                    after 100% completion. A credit manager will then be assigned and will contact you within 24 hours."
                  </p>
                  <p class="text-red-500 font-bold mt-1">üö´ Prohibition: Never assure a callback within 24 hours for
                    incomplete applications.</p>
                </div>
                <div class="mb-4">
                  <h4 class="font-bold text-slate-800 dark:text-slate-100 mb-2">B. Successfully Submitted (#Reference
                    Generated)</h4>
                  <p><strong>Script:</strong> "Your application has been submitted successfully. Our team will contact
                    you within 24 hours."</p>
                </div>
                <div>
                  <h4 class="font-bold text-slate-800 dark:text-slate-100 mb-2">C. Repeat Customers (100% Applied)</h4>
                  <p><strong>Script:</strong> "Since you are an existing customer, your application status is in
                    process. Kindly wait while a credit manager is assigned. They will contact you within 24 hours."</p>
                </div>
              </div>
            </div>

            <!-- 3. Credit Manager Escalations -->
            <div class="faq-item border-b border-slate-200 dark:border-slate-700 pb-4">
              <button onclick="toggleFaq(this)" class="w-full text-left font-bold text-lg">3. Credit Manager
                Escalations</button>
              <div class="faq-answer text-slate-600 dark:text-slate-300 text-sm">
                <table class="w-full text-left mt-2 border-collapse">
                  <thead>
                    <tr class="border-b border-slate-200 dark:border-slate-700">
                      <th class="py-2 font-bold">Scenario</th>
                      <th class="py-2 font-bold">Action</th>
                      <th class="py-2 font-bold">Agent Script</th>
                    </tr>
                  </thead>
                  <tbody class="divide-y divide-slate-100 dark:divide-slate-700">
                    <tr>
                      <td class="py-2 pr-2">New Concern</td>
                      <td class="py-2 pr-2">Highlight/Escalate</td>
                      <td class="py-2 italic">"Your concern is being escalated; the team will contact you within 24
                        hours."</td>
                    </tr>
                    <tr>
                      <td class="py-2 pr-2">Raised Same Day</td>
                      <td class="py-2 pr-2">Verify previous log</td>
                      <td class="py-2 italic">"An executive has already escalated this; the team will contact you within
                        24 hours."</td>
                    </tr>
                    <tr>
                      <td class="py-2 pr-2">Raised Twice</td>
                      <td class="py-2 pr-2">Tag Manager in email</td>
                      <td class="py-2 italic">"We are prioritizing this with senior management. Please wait for the 24h
                        window."</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>

            <!-- 4. Collections & Special Requests -->
            <div class="faq-item border-b border-slate-200 dark:border-slate-700 pb-4">
              <button onclick="toggleFaq(this)" class="w-full text-left font-bold text-lg">4. Collections & Special
                Requests</button>
              <div class="faq-answer text-slate-600 dark:text-slate-300 text-sm">
                <div class="mb-4 mt-2">
                  <h4 class="font-bold text-slate-800 dark:text-slate-100 mb-2">A. Medical Extensions</h4>
                  <p><strong>Mandatory Script:</strong> "We do not have the authority to grant extensions. Your case is
                    with the collection team. If payment is delayed, it may impact your CIBIL score, and a 2% daily
                    charge (1% interest + 1% penalty) will apply. Please email valid medical documents to
                    care@bharatloan.com for review."</p>
                </div>
                <div>
                  <h4 class="font-bold text-slate-800 dark:text-slate-100 mb-2">B. Penalty Waiver / Settlement</h4>
                  <p><strong>Step 1:</strong> Ask the customer for the specific reason.</p>
                  <p><strong>Script:</strong> "We do not have authority for waivers. Please email care@bharatloan.com
                    with valid reasons and evidence. Your concern will be escalated for a response within 24 hours."</p>
                </div>
              </div>
            </div>

            <!-- 5. Disbursement & Refunds -->
            <div class="faq-item border-b border-slate-200 dark:border-slate-700 pb-4">
              <button onclick="toggleFaq(this)" class="w-full text-left font-bold text-lg">5. Disbursement &
                Refunds</button>
              <div class="faq-answer text-slate-600 dark:text-slate-300 text-sm">
                <div class="mb-4 mt-2">
                  <h4 class="font-bold text-slate-800 dark:text-slate-100 mb-2">A. Disbursement Delay</h4>
                  <p><strong>Rule:</strong> Wait 48 hours from the disbursement date.</p>
                  <p><strong>Action (&lt;48h):</strong> Do not escalate. Advise the customer to wait.</p>
                  <p><strong>Action (&gt;48h):</strong> Request a bank statement via email for verification.</p>
                </div>
                <div class="mb-4">
                  <h4 class="font-bold text-slate-800 dark:text-slate-100 mb-2">B. Cancellation After Disbursement</h4>
                  <p><strong>Action:</strong> Immediately update the Refund Tracker under the sheet ‚ÄúCancel After
                    Disbursement‚Äù with 100% accurate details.</p>
                </div>
                <div>
                  <h4 class="font-bold text-slate-800 dark:text-slate-100 mb-2">C. Pending Refunds</h4>
                  <p><strong>Step 1:</strong> Confirm the refund amount with the customer.</p>
                  <p><strong>Timeline:</strong> Inform the customer of the 7‚Äì10 working days window.</p>
                </div>
              </div>
            </div>

            <!-- 6. Email Protocol -->
            <div class="faq-item border-b border-slate-200 dark:border-slate-700 pb-4">
              <button onclick="toggleFaq(this)" class="w-full text-left font-bold text-lg">6. Email Protocol
                (Mandatory)</button>
              <div class="faq-answer text-slate-600 dark:text-slate-300 text-sm">
                <div class="mb-4 mt-2">
                  <p class="text-red-500 font-bold mb-2">üö´ Strict Prohibition: Never use "Sir" or "Ma'am."</p>
                  <p><strong>Greeting:</strong> Always use the customer's First Name (e.g., "Dear Rajesh,").</p>
                </div>
                <div
                  class="bg-indigo-50 dark:bg-slate-700 p-4 rounded-xl border border-indigo-100 dark:border-slate-600">
                  <h4 class="font-bold text-indigo-700 dark:text-indigo-300 mb-2">Payment Confirmation Format:</h4>
                  <p class="font-mono text-xs">
                    Dear [Customer Name],<br><br>
                    This is to confirm that we have received your payment as per the details below:<br><br>
                    Loan Number: {{Loan Number}}<br>
                    Amount Paid: {{Amount}}<br>
                    Date of Payment: {{Payment Date}}
                  </p>
                </div>
              </div>
            </div>

          </div>
        </div>

        <!-- Quality Assurance Checklist - Agent Only -->
        <div id="qa-checklist-card-agent"
          class="hidden bg-slate-50 dark:bg-slate-800 p-6 rounded-3xl border border-slate-200 dark:border-slate-700 cursor-pointer hover:border-purple-400 transition"
          onclick="navigateTo('view-agent-qa')">
          <div class="flex items-center gap-4 mb-4">
            <div class="w-12 h-12 bg-purple-600 text-white rounded-xl flex items-center justify-center text-xl">üìä</div>
            <div>
              <h3 class="text-xl font-bold">Quality Assurance Checklist</h3>
              <p class="text-slate-600 dark:text-slate-300">View your weekly performance and reviews.</p>
            </div>
          </div>
        </div>

        <!-- Quality Assurance Checklist - Non-Agent Users -->
        <div id="qa-checklist-card-other"
          class="bg-slate-50 dark:bg-slate-800 p-6 rounded-3xl border border-slate-200 dark:border-slate-700 cursor-pointer"
          onclick="navigateTo('view-checklist')">
          <div class="flex items-center gap-4 mb-4">
            <div class="w-12 h-12 bg-teal-600 text-white rounded-xl flex items-center justify-center text-xl">üéØ</div>
            <div>
              <h3 class="text-xl font-bold">Quality Assurance Checklist</h3>
              <p class="text-slate-600 dark:text-slate-300">Click to view entity checklists.</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- CHECKLIST VIEW -->
  <div id="view-checklist" class="app-view bg-white dark:bg-slate-900">
    <header class="h-16 flex items-center px-6 border-b bg-white dark:bg-slate-800">
      <button onclick="navigateTo('view-resources')" class="font-bold text-slate-500 hover:text-blue-600">‚Üê Back to
        Resources</button>
      <span class="mx-auto font-bold">Quality Assurance Checklist</span>
    </header>

    <div class="max-w-6xl mx-auto px-6 py-14 text-center">
      <h1 class="text-3xl font-extrabold mb-12">Quality Assurance Checklist</h1>

      <ol class="text-left max-w-2xl mx-auto space-y-6 text-slate-700 dark:text-slate-300">
        <li onclick="handleChecklistClick('BharatLoan')"
          class="cursor-pointer hover:scale-105 transition-all duration-300 text-2xl font-bold p-6 rounded-2xl bg-gradient-to-r from-blue-800 via-blue-700 to-blue-900 text-white shadow-lg hover:shadow-blue-500/50 flex items-center gap-4">
          <span class="bg-white/20 w-12 h-12 rounded-full flex items-center justify-center text-xl">B</span>
          1. BharatLoan
        </li>
        <li onclick="handleChecklistClick('RupeeOnTime')"
          class="cursor-pointer hover:scale-105 transition-all duration-300 text-2xl font-bold p-6 rounded-2xl bg-gradient-to-r from-purple-600 via-purple-500 to-purple-800 text-white shadow-lg hover:shadow-purple-500/50 flex items-center gap-4">
          <span class="bg-white/20 w-12 h-12 rounded-full flex items-center justify-center text-xl">‚úî</span>
          2. RupeeOnTime
        </li>
        <li onclick="handleChecklistClick('Rupee112')"
          class="cursor-pointer hover:scale-105 transition-all duration-300 text-2xl font-bold p-6 rounded-2xl bg-gradient-to-r from-emerald-600 via-emerald-500 to-emerald-800 text-white shadow-lg hover:shadow-emerald-500/50 flex items-center gap-4">
          <span class="bg-white/20 w-12 h-12 rounded-full flex items-center justify-center text-xl">‚Çπ</span>
          3. Rupee112
        </li>
        <li onclick="handleChecklistClick('Loan112')"
          class="cursor-pointer hover:scale-105 transition-all duration-300 text-2xl font-bold p-6 rounded-2xl bg-gradient-to-r from-indigo-600 via-indigo-500 to-indigo-900 text-white shadow-lg hover:shadow-indigo-500/50 flex items-center gap-4">
          <span class="bg-white/20 w-12 h-12 rounded-full flex items-center justify-center text-xl">L</span>
          4. Loan112
        </li>
      </ol>
    </div>
  </div>

  <!-- RUPEE112 SPECIFIC VIEW -->
  <div id="view-rupee112" class="app-view bg-white dark:bg-slate-900">
    <header
      class="h-16 flex items-center justify-between px-6 border-b border-slate-200 dark:border-slate-700 bg-gradient-to-r from-green-500 to-red-600 text-white relative">
      <button onclick="navigateTo('view-entities')" class="font-bold text-white hover:text-blue-600">‚Üê Back to
        Entities</button>

      <button onclick="toggleDropdown('rupee112')" class="text-white hover:text-blue-600">Support üìû</button>
      <div id="support-dropdown-rupee112"
        class="hidden absolute top-full right-0 mt-2 bg-gradient-to-r from-green-500 to-red-600 text-white border border-slate-200 dark:border-slate-700 rounded-lg shadow-lg p-4 z-10">
        <h4 class="font-bold mb-2">Contact Support</h4>
        <p><strong>Call:</strong> 9220644112</p>
        <p><strong>Email:</strong> care@rupee112.com</p>
      </div>
    </header>

    <div class="max-w-5xl mx-auto px-6 py-14">
      <!-- Tabs -->
      <div class="flex border-b border-slate-200 dark:border-slate-700 mb-8">
        <button onclick="showTab('tools', 'rupee112')" id="tab-tools-rupee112"
          class="px-6 py-3 font-bold text-blue-600 border-b-2 border-blue-600">Our Operating Tools</button>
      </div>

      <!-- Tools Tab Content -->
      <div id="content-tools-rupee112" class="tab-content">
        <div class="grid gap-6">
          <div
            class="group bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 p-6 rounded-3xl transition-all hover:shadow-lg">
            <div class="flex flex-col md:flex-row md:items-center justify-between gap-6">
              <div class="flex-1">
                <h3 class="text-xl font-bold mb-2">Rupee112 Portal and Search Module</h3>
                <p class="text-slate-600 dark:text-slate-300 text-sm leading-relaxed">
                  Main application processing, document view, and status checks. Customer search via PAN, Mobile, or
                  Email.
                </p>
              </div>
              <a href="https://rupee112fintech.com/" target="_blank"
                class="bg-blue-600 text-white font-bold py-3 px-6 rounded-xl hover:bg-blue-700 transition">Visit Portal
                ‚Üó</a>
            </div>
          </div>

          <div
            class="group bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 p-6 rounded-3xl transition-all hover:shadow-lg">
            <div class="flex flex-col md:flex-row md:items-center justify-between gap-6">
              <div class="flex-1">
                <h3 class="text-xl font-bold mb-2">WOCOM 365</h3>
                <p class="text-slate-600 dark:text-slate-300 text-sm leading-relaxed">
                  Telephony integration, lead management, and communication logging.
                </p>
              </div>
              <a href="https://cpaas.wocom365.com/" target="_blank"
                class="bg-emerald-600 text-white font-bold py-3 px-6 rounded-xl hover:bg-emerald-700 transition">Open
                WOCOM ‚Üó</a>
            </div>
          </div>

          <div
            class="group bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 p-6 rounded-3xl transition-all hover:shadow-lg">
            <div class="flex flex-col md:flex-row md:items-center justify-between gap-6">
              <div class="flex-1">
                <h3 class="text-xl font-bold mb-2">Yellow Ai</h3>
                <p class="text-slate-600 dark:text-slate-300 text-sm leading-relaxed">
                  Handle real-time customer chats efficiently through the AI-powered cloud platform.
                </p>
              </div>
              <a href="https://cloud.yellow.ai/auth/login" target="_blank"
                class="bg-indigo-600 text-white font-bold py-3 px-6 rounded-xl hover:bg-indigo-700 transition">Login
                Chat ‚Üó</a>
            </div>
          </div>

          <div
            class="group bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 p-6 rounded-3xl transition-all hover:shadow-lg">
            <div class="flex flex-col md:flex-row md:items-center justify-between gap-6">
              <div class="flex-1">
                <h3 class="text-xl font-bold mb-2">Outlook (Care@rupee112.com)</h3>
                <p class="text-slate-600 dark:text-slate-300 text-sm leading-relaxed">
                  Review customer emails and attachments. Standard channel for ticketing and complex queries.
                </p>
              </div>
              <a href="https://outlook.office.com/mail/" target="_blank"
                class="bg-amber-500 text-white font-bold py-3 px-6 rounded-xl hover:bg-amber-600 transition">Open Mail
                ‚Üó</a>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- LOAN112 SPECIFIC VIEW -->
  <div id="view-loan112" class="app-view bg-white dark:bg-slate-900">
    <header
      class="h-16 flex items-center justify-between px-6 border-b border-slate-200 dark:border-slate-700 bg-gradient-to-r from-blue-900 to-red-600 text-white relative">
      <button onclick="navigateTo('view-entities')" class="font-bold text-white hover:text-blue-600">‚Üê Back to
        Entities</button>

      <button onclick="toggleDropdown('loan112')" class="text-white hover:text-blue-600">Support üìû</button>
      <div id="support-dropdown-loan112"
        class="hidden absolute top-full right-0 mt-2 bg-gradient-to-r from-blue-900 to-red-600 text-white border border-slate-200 dark:border-slate-700 rounded-lg shadow-lg p-4 z-10">
        <h4 class="font-bold mb-2">Contact Support</h4>
        <p><strong>Call:</strong> 9311912970</p>
        <p><strong>Email:</strong> care@loan112.com</p>
      </div>
    </header>

    <div class="max-w-5xl mx-auto px-6 py-14">
      <!-- Tabs -->
      <div class="flex border-b border-slate-200 dark:border-slate-700 mb-8">
        <button onclick="showTab('tools', 'loan112')" id="tab-tools-loan112"
          class="px-6 py-3 font-bold text-blue-600 border-b-2 border-blue-600">Our Operating Tools</button>
      </div>

      <!-- Tools Tab Content -->
      <div id="content-tools-loan112" class="tab-content">
        <div class="grid gap-6">
          <div
            class="group bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 p-6 rounded-3xl transition-all hover:shadow-lg">
            <div class="flex flex-col md:flex-row md:items-center justify-between gap-6">
              <div class="flex-1">
                <h3 class="text-xl font-bold mb-2">Loan112 Portal and Search Module</h3>
                <p class="text-slate-600 dark:text-slate-300 text-sm leading-relaxed">
                  Main application processing, document view, and status checks. Customer search via PAN, Mobile, or
                  Email.
                </p>
              </div>
              <a href="https://loan112fintech.com/" target="_blank"
                class="bg-blue-600 text-white font-bold py-3 px-6 rounded-xl hover:bg-blue-700 transition">Visit Portal
                ‚Üó</a>
            </div>
          </div>

          <div
            class="group bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 p-6 rounded-3xl transition-all hover:shadow-lg">
            <div class="flex flex-col md:flex-row md:items-center justify-between gap-6">
              <div class="flex-1">
                <h3 class="text-xl font-bold mb-2">WOCOM 365</h3>
                <p class="text-slate-600 dark:text-slate-300 text-sm leading-relaxed">
                  Telephony integration, lead management, and communication logging.
                </p>
              </div>
              <a href="https://cpaas.wocom365.com/" target="_blank"
                class="bg-emerald-600 text-white font-bold py-3 px-6 rounded-xl hover:bg-emerald-700 transition">Open
                WOCOM ‚Üó</a>
            </div>
          </div>

          <div
            class="group bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 p-6 rounded-3xl transition-all hover:shadow-lg">
            <div class="flex flex-col md:flex-row md:items-center justify-between gap-6">
              <div class="flex-1">
                <h3 class="text-xl font-bold mb-2">Yellow Ai</h3>
                <p class="text-slate-600 dark:text-slate-300 text-sm leading-relaxed">
                  Handle real-time customer chats efficiently through the AI-powered cloud platform.
                </p>
              </div>
              <a href="https://cloud.yellow.ai/auth/login" target="_blank"
                class="bg-indigo-600 text-white font-bold py-3 px-6 rounded-xl hover:bg-indigo-700 transition">Login
                Chat ‚Üó</a>
            </div>
          </div>

          <div
            class="group bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 p-6 rounded-3xl transition-all hover:shadow-lg">
            <div class="flex flex-col md:flex-row md:items-center justify-between gap-6">
              <div class="flex-1">
                <h3 class="text-xl font-bold mb-2">Outlook (Care@loan112.com)</h3>
                <p class="text-slate-600 dark:text-slate-300 text-sm leading-relaxed">
                  Review customer emails and attachments. Standard channel for ticketing and complex queries.
                </p>
              </div>
              <a href="https://outlook.office.com/mail/" target="_blank"
                class="bg-amber-500 text-white font-bold py-3 px-6 rounded-xl hover:bg-amber-600 transition">Open Mail
                ‚Üó</a>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- RUPEEONTIME SPECIFIC VIEW -->
  <div id="view-rupeeontime" class="app-view bg-white dark:bg-slate-900">
    <header
      class="h-16 flex items-center justify-between px-6 border-b border-slate-200 dark:border-slate-700 bg-gradient-to-r from-purple-600 to-red-600 text-white relative">
      <button onclick="navigateTo('view-entities')" class="font-bold text-white hover:text-blue-600">‚Üê Back to
        Entities</button>

      <button onclick="toggleDropdown('rupeeontime')" class="text-white hover:text-blue-600">Support üìû</button>
      <div id="support-dropdown-rupeeontime"
        class="hidden absolute top-full right-0 mt-2 bg-gradient-to-r from-purple-600 to-red-600 text-white border border-slate-200 dark:border-slate-700 rounded-lg shadow-lg p-4 z-10">
        <h4 class="font-bold mb-2">Contact Support</h4>
        <p><strong>Call:</strong> 9220912304</p>
        <p><strong>Email:</strong> care@rupeeontime.com</p>
      </div>
    </header>

    <div class="max-w-5xl mx-auto px-6 py-14">
      <!-- Tabs -->
      <div class="flex border-b border-slate-200 dark:border-slate-700 mb-8">
        <button onclick="showTab('tools', 'rupeeontime')" id="tab-tools-rupeeontime"
          class="px-6 py-3 font-bold text-blue-600 border-b-2 border-blue-600">Our Operating Tools</button>
      </div>

      <!-- Tools Tab Content -->
      <div id="content-tools-rupeeontime" class="tab-content">
        <div class="grid gap-6">
          <div
            class="group bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 p-6 rounded-3xl transition-all hover:shadow-lg">
            <div class="flex flex-col md:flex-row md:items-center justify-between gap-6">
              <div class="flex-1">
                <h3 class="text-xl font-bold mb-2">RupeeOnTime Portal and Search Module</h3>
                <p class="text-slate-600 dark:text-slate-300 text-sm leading-relaxed">
                  Main application processing, document view, and status checks. Customer search via PAN, Mobile, or
                  Email.
                </p>
              </div>
              <a href="https://rotfintech.com/" target="_blank"
                class="bg-blue-600 text-white font-bold py-3 px-6 rounded-xl hover:bg-blue-700 transition">Visit Portal
                ‚Üó</a>
            </div>
          </div>

          <div
            class="group bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 p-6 rounded-3xl transition-all hover:shadow-lg">
            <div class="flex flex-col md:flex-row md:items-center justify-between gap-6">
              <div class="flex-1">
                <h3 class="text-xl font-bold mb-2">WOCOM 365</h3>
                <p class="text-slate-600 dark:text-slate-300 text-sm leading-relaxed">
                  Telephony integration, lead management, and communication logging.
                </p>
              </div>
              <a href="https://cpaas.wocom365.com/" target="_blank"
                class="bg-emerald-600 text-white font-bold py-3 px-6 rounded-xl hover:bg-emerald-700 transition">Open
                WOCOM ‚Üó</a>
            </div>
          </div>

          <div
            class="group bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 p-6 rounded-3xl transition-all hover:shadow-lg">
            <div class="flex flex-col md:flex-row md:items-center justify-between gap-6">
              <div class="flex-1">
                <h3 class="text-xl font-bold mb-2">Yellow Ai</h3>
                <p class="text-slate-600 dark:text-slate-300 text-sm leading-relaxed">
                  Handle real-time customer chats efficiently through the AI-powered cloud platform.
                </p>
              </div>
              <a href="https://cloud.yellow.ai/auth/login" target="_blank"
                class="bg-indigo-600 text-white font-bold py-3 px-6 rounded-xl hover:bg-indigo-700 transition">Login
                Chat ‚Üó</a>
            </div>
          </div>

          <div
            class="group bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 p-6 rounded-3xl transition-all hover:shadow-lg">
            <div class="flex flex-col md:flex-row md:items-center justify-between gap-6">
              <div class="flex-1">
                <h3 class="text-xl font-bold mb-2">Outlook (Care@rupeeontime.com)</h3>
                <p class="text-slate-600 dark:text-slate-300 text-sm leading-relaxed">
                  Review customer emails and attachments. Standard channel for ticketing and complex queries.
                </p>
              </div>
              <a href="https://outlook.office.com/mail/" target="_blank"
                class="bg-amber-500 text-white font-bold py-3 px-6 rounded-xl hover:bg-amber-600 transition">Open Mail
                ‚Üó</a>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- PERFORMANCE VIEW (AGENT DASHBOARD) -->
  <div id="view-performance" class="app-view bg-white dark:bg-slate-900">
    <header class="h-16 flex items-center px-6 border-b bg-white dark:bg-slate-800 justify-between">
      <div class="flex items-center gap-4">
        <button onclick="navigateTo('view-checklist')" class="font-bold text-slate-500 hover:text-blue-600">‚Üê
          Back</button>
        <span id="agent-dashboard-title" class="font-bold text-xl">Agent Dashboard</span>
      </div>
      <div class="flex items-center gap-4">
        <div class="relative cursor-pointer hover:bg-slate-100 dark:hover:bg-slate-700 p-2 rounded-full transition agent-notification-bell"
          onclick="checkAgentNotifications(true)" title="Check Updates">
          <span class="text-2xl">üîî</span>
          <span
            class="agent-notification-dot hidden absolute top-0 right-0 w-3 h-3 bg-red-500 rounded-full border-2 border-white dark:border-slate-800"></span>
        </div>
      </div>
    </header>

    <div class="max-w-6xl mx-auto px-6 py-10">

      <!-- Welcome Banner -->
      <div class="mb-12 p-8 rounded-3xl bg-gradient-to-r from-indigo-600 to-purple-600 text-white shadow-xl">
        <h1 class="text-3xl font-extrabold mb-2">Hello, <span id="agent-name-display">Agent</span> üëã</h1>
        <p class="opacity-90">Keep up the great work! Check your latest performance reviews below.</p>
      </div>

      <!-- Dashboard Grid -->
      <div class="grid grid-cols-1 max-w-2xl mx-auto gap-8">

        <!-- Weekly Performance Tab/Card -->
        <div onclick="openAgentPerformanceModal()"
          class="cursor-pointer group bg-white dark:bg-slate-800 p-8 rounded-3xl border border-slate-200 dark:border-slate-700 hover:shadow-2xl hover:-translate-y-2 transition-all duration-300 relative overflow-hidden">
          <div class="absolute top-0 right-0 p-4 opacity-5 group-hover:opacity-10 transition">
            <span class="text-9xl">üìà</span>
          </div>

          <div
            class="w-16 h-16 rounded-2xl bg-indigo-50 dark:bg-slate-700 flex items-center justify-center text-3xl mb-6 text-indigo-600">
            üéØ
          </div>

          <h3 class="text-2xl font-bold mb-2">Weekly Performance</h3>
          <p class="text-slate-500 text-sm mb-6">Review your audit scores, compliance stats, and proofs.</p>

          <div class="flex items-center gap-2 text-indigo-600 font-bold group-hover:gap-4 transition-all">
            <span>View Details</span>
            <span>‚Üí</span>
          </div>
        </div>


      </div>
    </div>
  </div>

  <!-- AGENT PERFORMANCE MODAL -->
  <div id="agent-performance-modal"
    class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4">
    <div
      class="bg-white dark:bg-slate-900 w-full max-w-5xl h-[90vh] rounded-[2rem] shadow-2xl overflow-hidden flex flex-col animate-scale-up">

      <!-- Modal Header -->
      <div
        class="p-6 border-b border-slate-100 dark:border-slate-800 flex items-center justify-between bg-white dark:bg-slate-900 z-10">
        <div>
          <h2 class="text-2xl font-extrabold flex items-center gap-2">
            <span>üìä</span> Weekly Performance Review
          </h2>
          <p class="text-xs text-slate-500 font-mono mt-1" id="modal-agent-id">ID: --</p>
        </div>
        <button onclick="closeAgentPerformanceModal()"
          class="w-10 h-10 rounded-full bg-slate-100 dark:bg-slate-800 flex items-center justify-center text-slate-500 hover:bg-red-50 hover:text-red-500 transition font-bold text-xl">&times;</button>
      </div>

      <!-- Modal Content (Scrollable) -->
      <div class="flex-1 overflow-y-auto p-8">

        <div id="perf-content-loaded" class="space-y-10">

          <!-- Performance Stats Cards -->
          <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div
              class="p-6 bg-blue-50 dark:bg-slate-800 rounded-2xl border border-blue-100 dark:border-slate-700 text-center">
              <p class="text-xs font-bold uppercase text-slate-400 mb-2">No. of Audits</p>
              <div id="modal-audit-count" class="text-4xl font-black text-blue-600">--</div>
            </div>
            <div
              class="p-6 bg-red-50 dark:bg-slate-800 rounded-2xl border border-red-100 dark:border-slate-700 text-center">
              <p class="text-xs font-bold uppercase text-slate-400 mb-2">Fatal Errors (Score 0)</p>
              <div id="modal-fatal-count" class="text-4xl font-black text-red-600">--</div>
            </div>
            <div
              class="p-6 bg-emerald-50 dark:bg-slate-800 rounded-2xl border border-emerald-100 dark:border-slate-700 text-center">
              <p class="text-xs font-bold uppercase text-slate-400 mb-2">Good (Score 100)</p>
              <div id="modal-good-count" class="text-4xl font-black text-emerald-600">--</div>
            </div>
            <div
              class="p-6 bg-indigo-50 dark:bg-slate-800 rounded-2xl border border-indigo-100 dark:border-slate-700 text-center">
              <p class="text-xs font-bold uppercase text-slate-400 mb-2">Total Score</p>
              <div id="modal-total-score" class="text-4xl font-black text-indigo-600">--</div>
            </div>
          </div>

          <!-- Detailed Reviews List -->
          <div>
            <h3 class="text-xl font-bold mb-4 flex items-center gap-2">
              <span class="bg-indigo-100 dark:bg-slate-700 text-indigo-600 p-2 rounded-lg text-sm">üìã</span>
              Quality Reviews
            </h3>
            <div id="modal-reviews-list" class="space-y-4">
              <!-- Reviews will be populated here by JS -->
            </div>
          </div>

          <!-- Comment Section -->
          <div class="bg-slate-50 dark:bg-slate-800 p-6 rounded-2xl border border-slate-200 dark:border-slate-700">
            <h3 class="text-lg font-bold mb-4">üí¨ Add Your Feedback/Comments</h3>
            <textarea id="agent-comment-input" rows="4"
              class="w-full p-4 rounded-xl border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-900 focus:ring-2 focus:ring-indigo-500 outline-none transition mb-4"
              placeholder="Write your comments or feedback regarding these reviews..."></textarea>
            <button onclick="agentSubmitComment()"
              class="bg-indigo-600 text-white font-bold py-3 px-8 rounded-xl hover:bg-indigo-700 transition shadow-lg shadow-indigo-500/30">Send
              Feedback</button>
          </div>

        </div>

        <!-- Empty State -->
        <div id="perf-content-empty"
          class="hidden h-full flex flex-col items-center justify-center text-center opacity-50 py-20">
          <div class="text-6xl mb-4">üì≠</div>
          <h3 class="text-xl font-bold">No performance review available yet.</h3>
        </div>

      </div>
    </div>
  </div>

  <!-- ADMIN DASHBOARD -->
  <div id="view-admin" class="app-view bg-white dark:bg-slate-900">
    <header class="h-16 flex items-center px-6 border-b bg-white dark:bg-slate-800 justify-between">
      <div class="flex items-center gap-4">
        <button onclick="navigateTo('view-checklist')" class="font-bold text-slate-500 hover:text-blue-600">‚Üê
          Back</button>
        <span class="font-bold text-xl text-indigo-600">Admin Dashboard - <span
            id="admin-entity-display">--</span></span>
      </div>
    </header>

    <div class="max-w-6xl mx-auto px-6 py-10">
      <!-- Welcome Banner -->
      <div class="mb-8 p-6 bg-gradient-to-r from-indigo-600 to-blue-600 text-white rounded-3xl">
        <h1 id="admin-welcome-text" class="text-3xl font-bold">Welcome Siddhant Chauhan</h1>
      </div>

      <!-- Section 1: Select Agent Only -->
      <div class="bg-blue-50 dark:bg-slate-800 p-8 rounded-3xl mb-12 border border-blue-200 dark:border-slate-700">
        <h2 class="text-2xl font-bold mb-6 flex items-center gap-3">
          <span class="bg-blue-600 text-white rounded-lg p-2 text-xl">üë•</span>
          Select Agent
        </h2>

        <!-- Agent Selection -->
        <!-- Agent Selection Dropdown -->
        <div class="mb-6">
          <label class="block text-sm font-semibold mb-2 text-slate-600 dark:text-slate-400">Choose an Agent to
            Review</label>
          <select id="admin-agent-selector" onchange="adminSelectAgentFromDropdown(this)"
            class="w-full p-4 rounded-xl border-2 border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 font-bold text-lg focus:border-blue-500 outline-none transition cursor-pointer">
            <option value="">-- Click to Select Agent --</option>
          </select>
        </div>

        <button id="admin-start-review-btn" onclick="adminStartQualityReview()" disabled
          class="w-full bg-blue-600 text-white font-bold py-3 px-8 rounded-xl hover:bg-blue-700 transition opacity-50 cursor-not-allowed">
          Start Quality Review
        </button>
      </div>

      <!-- Voice/Non-Voice Type Selection Modal -->
      <div id="voice-type-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white dark:bg-slate-800 p-8 rounded-3xl shadow-2xl max-w-md w-full mx-4">
          <h2 class="text-2xl font-bold mb-6 text-center">Select Review Type</h2>
          <p class="text-slate-600 dark:text-slate-400 text-center mb-6">Choose the type of quality check for this agent</p>
          
          <div class="space-y-4">
            <button onclick="selectVoiceType('voice')" 
              class="w-full bg-blue-600 text-white font-bold py-4 px-6 rounded-xl hover:bg-blue-700 transition flex items-center justify-center gap-3">
              <span class="text-2xl">üéôÔ∏è</span>
              <div>
                <div class="font-bold">Voice</div>
                <div class="text-sm opacity-90">Call recordings & interaction</div>
              </div>
            </button>
            
            <button onclick="selectVoiceType('non-voice')" 
              class="w-full bg-purple-600 text-white font-bold py-4 px-6 rounded-xl hover:bg-purple-700 transition flex items-center justify-center gap-3">
              <span class="text-2xl">üí¨</span>
              <div>
                <div class="font-bold">Non-Voice</div>
                <div class="text-sm opacity-90">Chat/Email interactions</div>
              </div>
            </button>
          </div>
          
          <button onclick="document.getElementById('voice-type-modal').classList.add('hidden')" 
            class="w-full mt-4 bg-slate-300 text-slate-700 font-bold py-2 px-4 rounded-lg hover:bg-slate-400 transition">
            Cancel
          </button>
        </div>
      </div>

      <!-- Section 2: Quality Review Form (Hidden initially) -->
      <div id="admin-quality-form-section"
        class="hidden bg-emerald-50 dark:bg-slate-800 p-8 rounded-3xl mb-12 border border-emerald-200 dark:border-slate-700">
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-2xl font-bold flex items-center gap-3">
            <span class="bg-emerald-600 text-white rounded-lg p-2 text-xl">üìù</span>
            Quality Review - <span id="admin-review-agent-display" class="text-emerald-600"></span>
          </h2>
          <button onclick="adminCancelReview()" class="text-slate-500 hover:text-slate-700 text-sm font-medium">‚Üê
            Back</button>
        </div>

        <!-- File Input Section (for Voice reviews) -->
        <div id="admin-review-file-section" class="hidden mb-6 p-4 bg-white dark:bg-slate-700 rounded-xl border border-emerald-200 dark:border-slate-600">
          <label class="block text-sm font-semibold mb-3">Select Call Recording or File (Max 100MB)</label>
          <input type="file" id="admin-review-file-input" 
            class="block w-full text-sm file:mr-4 file:py-2 file:px-4 file:rounded file:border-0 file:text-sm file:font-semibold file:bg-blue-100 file:text-blue-700">
          <p class="text-xs text-slate-500 mt-2">Selected: <span id="admin-review-file-name">None</span></p>
        </div>

        <!-- Chat/Email ID Section (for Non-Voice reviews) -->
        <div id="admin-review-id-section" class="hidden mb-6 p-4 bg-white dark:bg-slate-700 rounded-xl border border-purple-200 dark:border-slate-600">
          <label class="block text-sm font-semibold mb-3">Enter Chat/Email ID or Thread ID</label>
          <input type="text" id="admin-review-id-input" placeholder="e.g., chat_12345 or email_thread_789"
            class="block w-full px-4 py-3 rounded-lg border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 focus:ring-2 focus:ring-purple-500 outline-none">
          <p class="text-xs text-slate-500 mt-2">This ID will be referenced in the review</p>
        </div>

        <div id="admin-review-items-container" class="space-y-6">
          <!-- Review items will be dynamically added here -->
        </div>

        <div class="flex gap-3 mt-8">
          <button onclick="adminAddReviewItem()" id="admin-add-review-btn"
            class="flex-1 bg-blue-600 text-white font-bold py-3 px-8 rounded-xl hover:bg-blue-700 transition">
            ‚ûï Add Review (Min 3, Max 10)
          </button>
          <button onclick="adminFinalSubmit()" id="admin-final-submit-btn" disabled
            class="flex-1 bg-green-600 text-white font-bold py-3 px-8 rounded-xl hover:bg-green-700 transition opacity-50 cursor-not-allowed">
            ‚úÖ Final Submit
          </button>
        </div>
      </div>

      <!-- Section 3: Submitted Reviews -->
      <div id="admin-submitted-reviews-section" class="mb-12 hidden">
        <h2 class="text-2xl font-bold mb-6 flex items-center gap-3">
          <span class="bg-indigo-600 text-white rounded-lg p-2 text-xl">üìã</span>
          Submitted Reviews
        </h2>
        <div class="mb-4">
          <button onclick="adminDeleteAllReviews()"
            class="bg-red-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-red-700 transition text-sm">
            üóëÔ∏è Delete All Reviews
          </button>
        </div>
        <div class="overflow-x-auto rounded-3xl border border-slate-200 dark:border-slate-700">
          <table class="w-full bg-white dark:bg-slate-800 text-left border-collapse">
            <thead class="bg-slate-50 dark:bg-slate-700 text-slate-500 uppercase text-xs">
              <tr>
                <th class="p-6">Date</th>
                <th class="p-6">Agent</th>
                <th class="p-6">File</th>
                <th class="p-6">Score</th>
                <th class="p-6">Observation</th>
                <th class="p-6 text-right">Action</th>
              </tr>
            </thead>
            <tbody id="admin-reviews-list" class="divide-y divide-slate-100 dark:divide-slate-700">
              <!-- JS Populates this -->
            </tbody>
          </table>
        </div>
      </div>

      <!-- Section 4: Agent Feedback -->
      <div>
        <h2 class="text-2xl font-bold mb-6 flex items-center gap-3">
          <span class="bg-amber-600 text-white rounded-lg p-2 text-xl">üí¨</span>
          Agent Comments
        </h2>
        <div class="mb-4">
          <button onclick="adminDeleteAllFeedback()"
            class="bg-red-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-red-700 transition text-sm">
            üóëÔ∏è Delete All Feedback
          </button>
        </div>
        <div class="overflow-x-auto rounded-3xl border border-slate-200 dark:border-slate-700">
          <table class="w-full bg-white dark:bg-slate-800 text-left border-collapse">
            <thead class="bg-slate-50 dark:bg-slate-700 text-slate-500 uppercase text-xs">
              <tr>
                <th class="p-6">Date</th>
                <th class="p-6">Agent</th>
                <th class="p-6">Feedback</th>
                <th class="p-6 text-right">Action</th>
              </tr>
            </thead>
            <tbody id="admin-feedback-list" class="divide-y divide-slate-100 dark:divide-slate-700">
              <!-- JS Populates this -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- AGENT QUALITY ASSURANCE CHECKLIST -->
  <div id="view-agent-qa" class="app-view bg-white dark:bg-slate-900">
    <header class="h-16 flex items-center px-6 border-b bg-white dark:bg-slate-800 justify-between">
      <div class="flex items-center gap-4">
        <button onclick="navigateTo('view-performance')" class="font-bold text-slate-500 hover:text-blue-600">‚Üê
          Back</button>
        <span class="font-bold text-xl text-purple-600">Quality Assurance Checklist - Weekly Performance</span>
      </div>
      <div class="flex items-center gap-4">
        <div class="relative cursor-pointer hover:bg-slate-100 dark:hover:bg-slate-700 p-2 rounded-full transition agent-notification-bell"
          onclick="checkAgentNotifications(true)" title="Check Updates">
          <span class="text-2xl">üîî</span>
          <span
            class="agent-notification-dot hidden absolute top-0 right-0 w-3 h-3 bg-red-500 rounded-full border-2 border-white dark:border-slate-800"></span>
        </div>
      </div>
    </header>

    <div class="max-w-6xl mx-auto px-6 py-10">
      <!-- Welcome Banner -->
      <div class="mb-8 p-6 bg-gradient-to-r from-purple-600 to-indigo-600 text-white rounded-3xl">
        <h1 id="agent-qa-welcome-text" class="text-3xl font-bold">Welcome</h1>
        <p class="text-purple-100 mt-2">View your weekly performance and quality scores</p>
      </div>

      <!-- Weekly Performance Section -->
      <div class="bg-purple-50 dark:bg-slate-800 p-8 rounded-3xl mb-12 border border-purple-200 dark:border-slate-700">
        <h2 class="text-2xl font-bold mb-8 flex items-center gap-3">
          <span class="bg-purple-600 text-white rounded-lg p-2 text-xl">üìä</span>
          Weekly Performance
        </h2>

        <!-- Performance Stats -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
          <!-- Total Reviews -->
          <div class="bg-white dark:bg-slate-700 p-6 rounded-2xl border border-purple-200 dark:border-slate-600">
            <div class="text-3xl font-bold text-purple-600" id="agent-total-reviews">0</div>
            <p class="text-slate-600 dark:text-slate-400 text-sm mt-2">Total Reviews</p>
          </div>

          <!-- Average Score -->
          <div class="bg-white dark:bg-slate-700 p-6 rounded-2xl border border-purple-200 dark:border-slate-600">
            <div class="text-3xl font-bold text-indigo-600" id="agent-avg-score">0</div>
            <p class="text-slate-600 dark:text-slate-400 text-sm mt-2">Average Score</p>
          </div>

          <!-- Last Review -->
          <div class="bg-white dark:bg-slate-700 p-6 rounded-2xl border border-purple-200 dark:border-slate-600">
            <div class="text-lg font-bold text-blue-600" id="agent-last-review">--</div>
            <p class="text-slate-600 dark:text-slate-400 text-sm mt-2">Last Review Date</p>
          </div>

          <!-- Performance Status -->
          <div class="bg-white dark:bg-slate-700 p-6 rounded-2xl border border-purple-200 dark:border-slate-600">
            <div class="text-lg font-bold text-green-600" id="agent-performance-status">Excellent</div>
            <p class="text-slate-600 dark:text-slate-400 text-sm mt-2">Current Status</p>
          </div>
        </div>

        <!-- Reviews History Table -->
        <h3 class="text-xl font-bold mb-4 mt-8">Your Review History</h3>
        <div class="overflow-x-auto rounded-3xl border border-slate-200 dark:border-slate-700">
          <table class="w-full bg-white dark:bg-slate-800 text-left border-collapse">
            <thead class="bg-slate-50 dark:bg-slate-700 text-slate-500 uppercase text-xs">
              <tr>
                <th class="p-6">Date</th>
                <th class="p-6">Reviewer</th>
                <th class="p-6">File</th>
                <th class="p-6">Score</th>
                <th class="p-6">Observation</th>
                <th class="p-6">Status</th>
              </tr>
            </thead>
            <tbody id="agent-reviews-history" class="divide-y divide-slate-100 dark:divide-slate-700">
              <!-- JS Populates this -->
            </tbody>
          </table>
        </div>

        <!-- No Reviews Message -->
        <div id="agent-no-reviews-message" class="text-center py-12 hidden">
          <div class="text-4xl mb-4">üì≠</div>
          <h4 class="text-xl font-bold text-slate-600 dark:text-slate-400">No Reviews Yet</h4>
          <p class="text-slate-500 dark:text-slate-500 mt-2">Your reviews will appear here once submitted by quality
            assurance team.</p>
        </div>
      </div>

      <!-- Feedback Section -->
      <div class="mb-12">
        <h2 class="text-2xl font-bold mb-6 flex items-center gap-3">
          <span class="bg-amber-600 text-white rounded-lg p-2 text-xl">üí¨</span>
          Your Feedback
        </h2>
        <div class="overflow-x-auto rounded-3xl border border-slate-200 dark:border-slate-700">
          <table class="w-full bg-white dark:bg-slate-800 text-left border-collapse">
            <thead class="bg-slate-50 dark:bg-slate-700 text-slate-500 uppercase text-xs">
              <tr>
                <th class="p-6">Date</th>
                <th class="p-6">Reviewer</th>
                <th class="p-6">Feedback</th>
                <th class="p-6">Expires In</th>
              </tr>
            </thead>
            <tbody id="agent-feedback-list" class="divide-y divide-slate-100 dark:divide-slate-700">
              <!-- JS Populates this -->
            </tbody>
          </table>
        </div>

        <!-- No Feedback Message -->
        <div id="agent-no-feedback-message" class="text-center py-12 hidden">
          <div class="text-4xl mb-4">‚ú®</div>
          <h4 class="text-xl font-bold text-slate-600 dark:text-slate-400">No Feedback Yet</h4>
          <p class="text-slate-500 dark:text-slate-500 mt-2">You're all set! No pending feedback at the moment.</p>
        </div>
      </div>
    </div>
  </div>

  <!-- REVIEWER DASHBOARD -->
  <div id="view-reviewer" class="app-view bg-white dark:bg-slate-900">
    <header class="h-16 flex items-center px-6 border-b bg-white dark:bg-slate-800 justify-between">
      <div class="flex items-center gap-4">
        <button onclick="navigateTo('view-checklist')" class="font-bold text-slate-500 hover:text-blue-600">‚Üê
          Back</button>

        <span class="font-bold text-xl text-purple-600">Review Dashboard - <span
            id="reviewer-entity-display">--</span></span>
      </div>
    </header>

    <div class="max-w-6xl mx-auto px-6 py-10">
      <!-- Welcome Banner -->
      <div class="mb-8 p-6 bg-gradient-to-r from-purple-600 to-indigo-600 text-white rounded-3xl">
        <h1 id="reviewer-welcome-text" class="text-3xl font-bold">Welcome Ayushi Gupta</h1>
      </div>

      <!-- Section 1: Select Agent -->
      <div class="bg-purple-50 dark:bg-slate-800 p-8 rounded-3xl mb-12 border border-purple-200 dark:border-slate-700">
        <h2 class="text-2xl font-bold mb-6 flex items-center gap-3">
          <span class="bg-purple-600 text-white rounded-lg p-2 text-xl">üë•</span>
          Select Agent
        </h2>

        <!-- Agent Selection -->
        <div class="mb-6">
          <label class="block text-sm font-semibold mb-2 text-slate-600 dark:text-slate-400">Select Agent</label>
          <select id="reviewer-agent-selector" onchange="reviewerSelectAgent(this)"
            class="w-full p-4 rounded-xl border-2 border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 font-bold text-lg focus:border-purple-500 outline-none transition cursor-pointer">
            <option value="">-- Choose Agent --</option>
          </select>
        </div>
      </div>

      <!-- Section 2: Reviews List -->
      <div id="reviewer-reviews-section" class="mb-12 hidden">
        <h2 class="text-2xl font-bold mb-6 flex items-center gap-3">
          <span class="bg-purple-600 text-white rounded-lg p-2 text-xl">üìã</span>
          Agent Reviews
        </h2>
        <div class="overflow-x-auto rounded-3xl border border-slate-200 dark:border-slate-700">
          <table class="w-full bg-white dark:bg-slate-800 text-left border-collapse">
            <thead class="bg-slate-50 dark:bg-slate-700 text-slate-500 uppercase text-xs">
              <tr>
                <th class="p-6">Date</th>
                <th class="p-6">Agent</th>
                <th class="p-6">File</th>
                <th class="p-6">Score</th>
                <th class="p-6">Observation</th>
                <th class="p-6 text-right">Action</th>
              </tr>
            </thead>
            <tbody id="reviewer-reviews-list" class="divide-y divide-slate-100 dark:divide-slate-700">
              <!-- JS Populates this -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- LOGIN MODAL -->
  <div id="login-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white dark:bg-slate-800 p-8 rounded-3xl shadow-lg max-w-md w-full mx-4">
      <div class="flex justify-between items-center mb-6">
        <h2 id="login-title" class="text-2xl font-bold">Login</h2>
        <button onclick="hideLogin()" class="text-slate-500 hover:text-slate-700 text-2xl">&times;</button>
      </div>
      <form onsubmit="submitLogin(event)">
        <div class="mb-6">
          <label class="block text-sm font-medium mb-2">Employee ID</label>
          <input id="empid" type="text" required
            class="w-full px-4 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-slate-50 dark:bg-slate-700">
        </div>

        <button type="submit"
          class="w-full bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition">Login</button>
      </form>
    </div>
  </div>

  <!-- ACCESS DENIED MODAL -->
  <div id="access-denied-modal"
    class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white dark:bg-slate-800 p-8 rounded-3xl shadow-lg max-w-md w-full mx-4">
      <div class="flex justify-between items-center mb-6">
        <h2 id="access-denied-title" class="text-2xl font-bold text-red-600">Access Denied</h2>
        <button onclick="document.getElementById('access-denied-modal').classList.add('hidden')"
          class="text-slate-500 hover:text-slate-700 text-2xl">&times;</button>
      </div>
      <p class="text-slate-600 dark:text-slate-400 mb-6">You do not have permission to access this entity. Please use
        the correct Employee ID for the selected entity.</p>
      <button onclick="document.getElementById('access-denied-modal').classList.add('hidden')"
        class="w-full bg-red-600 text-white py-2 px-4 rounded-lg hover:bg-red-700 transition">Close</button>
    </div>
  </div>

  <!-- EDIT REVIEW MODAL -->
  <div id="admin-edit-review-modal"
    class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4">
    <div class="bg-white dark:bg-slate-800 p-8 rounded-3xl shadow-lg max-w-lg w-full">
      <h3 class="text-2xl font-bold mb-6">Edit Review</h3>

      <!-- Score -->
      <div class="mb-4">
        <label class="block text-sm font-medium mb-2">Score</label>
        <div class="flex gap-4">
          <label
            class="flex items-center gap-2 cursor-pointer bg-emerald-50 dark:bg-slate-700 p-3 rounded-xl border border-emerald-100 dark:border-slate-600">
            <input type="radio" name="edit-score" value="100" class="w-5 h-5 text-emerald-600">
            <span class="font-bold text-emerald-600">100 (Pass)</span>
          </label>
          <label
            class="flex items-center gap-2 cursor-pointer bg-red-50 dark:bg-slate-700 p-3 rounded-xl border border-red-100 dark:border-slate-600">
            <input type="radio" name="edit-score" value="0" class="w-5 h-5 text-red-600">
            <span class="font-bold text-red-600">0 (Fatal/Fail)</span>
          </label>
        </div>
      </div>

      <!-- Observation -->
      <div class="mb-4">
        <label class="block text-sm font-medium mb-2">Observation</label>
        <textarea id="edit-observation" rows="3"
          class="w-full px-4 py-2 rounded-lg border border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 focus:ring-2 focus:ring-blue-500 outline-none"></textarea>
      </div>

      <!-- File -->
      <div class="mb-6">
        <label class="block text-sm font-medium mb-2">Update File (Optional)</label>
        <p class="text-xs text-slate-500 mb-2">Current: <span id="edit-current-filename"
            class="font-mono font-bold"></span></p>
        <input type="file" id="edit-file-upload"
          class="w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
      </div>

      <div class="flex gap-3">
        <button onclick="adminSaveEdit()" id="btn-save-edit"
          class="flex-1 bg-blue-600 text-white font-bold py-3 rounded-xl hover:bg-blue-700 transition">Save
          Changes</button>
        <button onclick="document.getElementById('admin-edit-review-modal').classList.add('hidden')"
          class="px-6 py-3 rounded-xl border border-slate-300 hover:bg-slate-50 dark:border-slate-600 dark:hover:bg-slate-700 transition">Cancel</button>
      </div>
    </div>
  </div>

  <script>
    // ===== PORTAL LOGIN SYSTEM =====
    let currentSessionUser = null;

    // Initialize portal login on page load
    function initPortal() {
      const savedPasswords = JSON.parse(localStorage.getItem('gojira_passwords') || '{}');
      if (!Object.keys(savedPasswords).length) {
        // Initialize all users with default password "1234"
        const allUsers = {};
        USER_DB.forEach(user => {
          allUsers[user.id] = '1234'; // Default password
        });
        localStorage.setItem('gojira_passwords', JSON.stringify(allUsers));
      }

      // Check if already logged in
      const sessionUser = localStorage.getItem('gojira_session_user');
      if (sessionUser) {
        currentSessionUser = JSON.parse(sessionUser);
        showPortalContent();
      }
    }

    // Portal Login Function
    function portalLogin(event) {
      event.preventDefault();
      const empId = document.getElementById('portal-emp-id').value.trim();
      const password = document.getElementById('portal-password').value;

      // Check if employee exists
      const user = USER_DB.find(u => u.id === empId);
      if (!user) {
        alert('‚ùå Invalid Employee ID');
        return;
      }

      // Check password
      const savedPasswords = JSON.parse(localStorage.getItem('gojira_passwords') || '{}');
      const correctPassword = savedPasswords[empId] || '1234';

      if (password !== correctPassword) {
        alert('‚ùå Invalid Password');
        return;
      }

      // Login successful
      currentSessionUser = { id: user.id, name: user.name, role: user.role, entity: user.entity };
      localStorage.setItem('gojira_session_user', JSON.stringify(currentSessionUser));

      // Clear login form
      document.getElementById('portal-emp-id').value = '';
      document.getElementById('portal-password').value = '';

      // Show portal content
      showPortalContent();
    }

    // Show Portal Content (Hide Login Screen)
    function showPortalContent() {
      document.getElementById('portal-login-screen').classList.add('hidden');
      document.getElementById('top-nav').classList.remove('hidden');

      // Set user greeting on home page
      const firstName = currentSessionUser.name.split(' ')[0];
      document.getElementById('home-user-greeting').innerText = `Hi ${firstName}`;

      // Filter entities display based on user
      filterEntitiesDisplay();
      filterResourcesQACard(); // Set QA card visibility based on user role

      // Set currentUser and currentEntity for all users
      currentUser = currentSessionUser;
      currentEntity = currentSessionUser.entity;

      // Route all users to home page
      navigateTo('view-home');
    }

    // Portal Logout
    function portalLogout() {
      currentSessionUser = null;
      localStorage.removeItem('gojira_session_user');

      // Reset user greeting
      document.getElementById('home-user-greeting').innerText = 'Hi Guest';

      // Clear all forms
      document.getElementById('portal-emp-id').value = '';
      document.getElementById('portal-password').value = '';
      document.getElementById('change-pass-emp-id').value = '';
      document.getElementById('change-pass-current').value = '';
      document.getElementById('change-pass-new').value = '';

      // Show login screen
      document.getElementById('portal-login-screen').classList.remove('hidden');
      document.getElementById('top-nav').classList.add('hidden');

      // Hide all views
      document.querySelectorAll('.app-view').forEach(view => {
        view.classList.remove('active');
      });
    }

    // Change Password Modal Functions
    function showChangePasswordModal() {
      document.getElementById('change-password-modal').classList.remove('hidden');
    }

    function hideChangePasswordModal() {
      document.getElementById('change-password-modal').classList.add('hidden');
      document.getElementById('change-pass-emp-id').value = '';
      document.getElementById('change-pass-current').value = '';
      document.getElementById('change-pass-new').value = '';
    }

    // Submit Change Password
    function submitChangePassword(event) {
      event.preventDefault();

      const empId = document.getElementById('change-pass-emp-id').value.trim();
      const currentPassword = document.getElementById('change-pass-current').value;
      const newPassword = document.getElementById('change-pass-new').value;

      // Validate employee exists
      const user = USER_DB.find(u => u.id === empId);
      if (!user) {
        alert('‚ùå Employee ID not found');
        return;
      }

      // Validate current password
      const savedPasswords = JSON.parse(localStorage.getItem('gojira_passwords') || '{}');
      const storedPassword = savedPasswords[empId] || '1234';

      if (currentPassword !== storedPassword) {
        alert('‚ùå Current password is incorrect');
        return;
      }

      // Validate new password
      if (newPassword.trim().length < 4) {
        alert('‚ùå New password must be at least 4 characters');
        return;
      }

      // Update password
      savedPasswords[empId] = newPassword;
      localStorage.setItem('gojira_passwords', JSON.stringify(savedPasswords));

      alert('‚úÖ Password changed successfully! You can now login with your new password.');
      hideChangePasswordModal();
    }

    // MOCK BACKEND
    class MockBackend {
      static getReports() {
        return JSON.parse(localStorage.getItem('gojira_reports') || '[]');
      }

      static addReport(file, content) {
        const reports = this.getReports();
        reports.unshift({
          id: Date.now(),
          name: file.name,
          type: file.type || 'Unknown',
          date: new Date().toLocaleString(),
          uploader: 'Admin',
          content: content // Store Base64 string
        });
        // Limit storage to prevent quota exceeded (keep last 5)
        if (reports.length > 5) reports.pop();
        localStorage.setItem('gojira_reports', JSON.stringify(reports));
      }

      static getComments() {
        return JSON.parse(localStorage.getItem('gojira_comments') || '[]');
      }

      static addComment(text, agentId) {
        const comments = this.getComments();
        comments.unshift({
          id: Date.now(),
          text,
          agentId,
          date: new Date().toLocaleString()
        });
        localStorage.setItem('gojira_comments', JSON.stringify(comments));
      }

      static deleteComment(id) {
        const comments = this.getComments().filter(c => c.id != id);
        localStorage.setItem('gojira_comments', JSON.stringify(comments));
      }

      static deleteReport(id) {
        const reports = this.getReports().filter(r => r.id != id);
        localStorage.setItem('gojira_reports', JSON.stringify(reports));
      }

      static clearAllReports() {
        localStorage.setItem('gojira_reports', JSON.stringify([]));
      }

      // PERFORMANCE DATA
      static getPerformance(agentId) {
        const db = JSON.parse(localStorage.getItem('gojira_performance') || '{}');
        return db[agentId] || null;
      }

      static savePerformance(agentId, data) {
        const db = JSON.parse(localStorage.getItem('gojira_performance') || '{}');
        db[agentId] = {
          ...data,
          lastUpdated: new Date().toLocaleString()
        };
        localStorage.setItem('gojira_performance', JSON.stringify(db));
      }

      static savePerformanceScore(performanceData) {
        const scores = JSON.parse(localStorage.getItem('gojira_performance_scores') || '[]');
        scores.unshift({
          id: Date.now(),
          ...performanceData
        });
        // Keep only last 50 scores to prevent storage bloat
        if (scores.length > 50) scores.pop();
        localStorage.setItem('gojira_performance_scores', JSON.stringify(scores));

        // Update the agent's current performance score
        const currentPerf = this.getPerformance(performanceData.agentId) || {};
        this.savePerformance(performanceData.agentId, {
          score: performanceData.score,
          isFatal: performanceData.isFatal,
          lastReviewDate: new Date().toLocaleString(),
          reviewerId: performanceData.reviewerId
        });
      }

      static getPerformanceScores() {
        return JSON.parse(localStorage.getItem('gojira_performance_scores') || '[]');
      }

      static deletePerformanceScore(scoreId) {
        const scores = this.getPerformanceScores();
        const scoreToDelete = scores.find(s => s.id == scoreId);

        if (scoreToDelete) {
          // Remove the score
          const updatedScores = scores.filter(s => s.id != scoreId);
          localStorage.setItem('gojira_performance_scores', JSON.stringify(updatedScores));

          // Check if this was the agent's most recent score
          const agentScores = updatedScores.filter(s => s.agentId === scoreToDelete.agentId);
          if (agentScores.length === 0) {
            // No more scores for this agent, remove their performance record
            const performanceDb = JSON.parse(localStorage.getItem('gojira_performance') || '{}');
            delete performanceDb[scoreToDelete.agentId];
            localStorage.setItem('gojira_performance', JSON.stringify(performanceDb));
          } else {
            // Update with the most recent remaining score
            const latestScore = agentScores.reduce((latest, current) =>
              new Date(current.timestamp) > new Date(latest.timestamp) ? current : latest
            );
            this.savePerformance(scoreToDelete.agentId, {
              score: latestScore.score,
              isFatal: latestScore.isFatal,
              lastReviewDate: new Date(latestScore.timestamp).toLocaleString(),
              reviewerId: latestScore.reviewerId
            });
          }
        }
      }

      static clearAllPerformanceData() {
        // Clear all performance scores history
        localStorage.removeItem('gojira_performance_scores');
        // Clear all current performance records
        localStorage.removeItem('gojira_performance');
      }
    }

    // ADMIN & AGENT FUNCTIONS
    function renderAdminDashboard() {
      // This function is called to refresh UI after operations
      // It should use adminLoadAgents() instead to maintain consistency
      adminLoadAgents();

      // Populate Performance Reviews Table
      const reviews = MockBackend.getPerformanceScores();
      const reviewsList = document.getElementById('admin-reviews-list');
      if (reviewsList) {
        if (reviews.length === 0) {
          reviewsList.innerHTML = '<tr><td colspan="6" class="p-6 text-center text-slate-400">No performance reviews yet.</td></tr>';
        } else {
          reviewsList.innerHTML = reviews.map(r => {
            const agent = USER_DB.find(u => u.id === r.agentId);
            const agentName = agent ? agent.name : r.agentId;
            const scoreClass = r.score === 100 ? 'text-emerald-600' : 'text-red-600';
            const scoreText = r.score === 0 ? '0 (Fatal)' : r.score;
            const date = new Date(r.timestamp).toLocaleString();

            return `
              <tr class="hover:bg-slate-50 dark:hover:bg-slate-700/50">
                <td class="p-6">${date}</td>
                <td class="p-6">${agentName}</td>
                <td class="p-6"><span class="${scoreClass} font-bold">${scoreText}</span></td>
                <td class="p-6">--</td>
                <td class="p-6">${r.feedbackData.fileName}</td>
                <td class="p-6 text-right">
                  <button onclick="viewReviewDetails(${r.id})" class="text-blue-600 hover:text-blue-800 mr-2">View</button>
                  <button onclick="handleDeleteReview(${r.id})" class="text-red-600 hover:text-red-800">Delete</button>
                </td>
              </tr>
            `;
          }).join('');
        }
      }

      // Populate Comments Table
      const comments = MockBackend.getComments();
      const commentsList = document.getElementById('admin-comments-list');
      if (commentsList) {
        if (comments.length === 0) {
          commentsList.innerHTML = '<tr><td colspan="4" class="p-6 text-center text-slate-400">No comments yet.</td></tr>';
        } else {
          commentsList.innerHTML = comments.map(c => `
            <tr class="hover:bg-slate-50 dark:hover:bg-slate-700/50">
              <td class="p-6">${c.date}</td>
              <td class="p-6">${USER_DB.find(u => u.id === c.agentId)?.name || c.agentId}</td>
              <td class="p-6">${c.text}</td>
              <td class="p-6 text-right">
                <button onclick="handleDeleteComment(${c.id})" class="text-red-600 hover:text-red-800">Delete</button>
              </td>
            </tr>
          `).join('');
        }
      }
    }

    // NEW WORKFLOW FUNCTIONS
    let selectedAgentForReview = null;
    let selectedFileForReview = null;
    let selectedProcessType = null;

    function onAgentSelected() {
      const agentSelector = document.getElementById('agent-selector');
      const selectedAgentId = agentSelector.value;

      if (selectedAgentId) {
        selectedAgentForReview = USER_DB.find(u => u.id === selectedAgentId);
        if (selectedAgentForReview) {
          // Show agent details section and populate it
          document.getElementById('admin-agent-list-section').classList.remove('hidden');
          document.getElementById('selected-agent-display-name').innerText = selectedAgentForReview.name;

          // Populate agent details
          const agentListContainer = document.getElementById('admin-agent-list');
          const perf = MockBackend.getPerformance(selectedAgentForReview.id);
          const pendingReviews = getPendingReviews(selectedAgentForReview.id);
          const scoreClass = perf ? (perf.score >= 90 ? 'text-emerald-500' : 'text-red-500') : 'text-slate-300';
          const scoreText = perf ? perf.score + '%' : 'Not Scored';

          const reviewStatus = pendingReviews.length === 0
            ? 'No reviews in progress'
            : pendingReviews.length >= 3
              ? 'Ready for final submission'
              : `${pendingReviews.length}/3 reviews completed`;

          const buttonText = pendingReviews.length >= 3
            ? 'Complete Final Submission'
            : pendingReviews.length === 0
              ? 'Start Quality Review'
              : `Continue Review (${pendingReviews.length}/3)`;

          const buttonAction = pendingReviews.length >= 3
            ? 'showFinalSubmissionOptionForSelectedAgent()'
            : 'startQualityReview()';

          agentListContainer.innerHTML = `
            <div class="bg-white dark:bg-slate-700 p-6 rounded-2xl border border-slate-200 dark:border-slate-600">
               <div class="flex items-center justify-between mb-4">
                  <div>
                     <h4 class="font-bold text-slate-700 dark:text-slate-200 text-xl">${selectedAgentForReview.name}</h4>
                     <p class="text-sm text-slate-500 font-mono">${selectedAgentForReview.id}</p>
                     <p class="text-xs text-slate-400 mt-1">Entity: ${selectedAgentForReview.entity}</p>
                     <p class="text-xs text-blue-600 mt-1 font-medium">${reviewStatus}</p>
                  </div>
                  <div class="text-right">
                     <div class="font-black ${scoreClass} text-2xl">${scoreText}</div>
                     <div class="text-xs text-slate-400 uppercase">Current Score</div>
                  </div>
               </div>

               <!-- Process Selection -->
               <div class="mb-4">
                 <label class="block text-sm font-semibold mb-3">Select Process Type</label>
                 <div class="grid grid-cols-2 gap-3">
                   <button onclick="selectProcessType('voice')" class="p-3 border-2 border-slate-200 dark:border-slate-600 rounded-lg hover:border-blue-500 hover:bg-blue-50 dark:hover:bg-blue-900/20 transition text-center" id="voice-btn">
                     <div class="text-2xl mb-1">üìû</div>
                     <div class="font-medium">Voice</div>
                     <div class="text-xs text-slate-500">Phone calls</div>
                   </button>
                   <button onclick="selectProcessType('non-voice')" class="p-3 border-2 border-slate-200 dark:border-slate-600 rounded-lg hover:border-green-500 hover:bg-green-50 dark:hover:bg-green-900/20 transition text-center" id="non-voice-btn">
                     <div class="text-2xl mb-1">üí¨</div>
                     <div class="font-medium">Non-Voice</div>
                     <div class="text-xs text-slate-500">Chat/Email</div>
                   </button>
                 </div>
               </div>

               <div class="flex gap-3">
                  <button onclick="startQualityReview()" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-xl hover:bg-blue-700 transition" id="start-review-btn" disabled>
                     ${buttonText}
                  </button>
                  <button onclick="clearAgentSelection()" class="bg-slate-500 text-white font-medium py-2 px-4 rounded-xl hover:bg-slate-600 transition">
                     Clear Selection
                  </button>
               </div>
            </div>
          `;
        }
      } else {
        // Hide agent details section if no agent selected
        document.getElementById('admin-agent-list-section').classList.add('hidden');
        selectedAgentForReview = null;
        clearAgentSelection();
      }
    }

    function selectProcessType(processType) {
      selectedProcessType = processType;

      // Update button styles to show selection
      const voiceBtn = document.getElementById('voice-btn');
      const nonVoiceBtn = document.getElementById('non-voice-btn');
      const startBtn = document.getElementById('start-review-btn');

      if (processType === 'voice') {
        voiceBtn.classList.add('border-blue-500', 'bg-blue-50', 'dark:bg-blue-900/20');
        voiceBtn.classList.remove('border-slate-200', 'dark:border-slate-600');
        nonVoiceBtn.classList.remove('border-green-500', 'bg-green-50', 'dark:bg-green-900/20');
        nonVoiceBtn.classList.add('border-slate-200', 'dark:border-slate-600');
      } else {
        nonVoiceBtn.classList.add('border-green-500', 'bg-green-50', 'dark:bg-green-900/20');
        nonVoiceBtn.classList.remove('border-slate-200', 'dark:border-slate-600');
        voiceBtn.classList.remove('border-blue-500', 'bg-blue-50', 'dark:bg-blue-900/20');
        voiceBtn.classList.add('border-slate-200', 'dark:border-slate-600');
      }

      // Enable start review button
      startBtn.disabled = false;
      startBtn.classList.remove('opacity-50', 'cursor-not-allowed');
    }

    function startQualityReview() {
      if (selectedAgentForReview && selectedProcessType) {
        // Hide agent details, show file selection section
        document.getElementById('admin-agent-list-section').classList.add('hidden');
        document.getElementById('file-selection-section').classList.remove('hidden');

        // Set agent info in file selection section
        document.getElementById('selected-agent-name-file').innerText = selectedAgentForReview.name;
        document.getElementById('selected-agent-id-file').innerText = selectedAgentForReview.id;
        document.getElementById('selected-process-type').innerText = selectedProcessType === 'voice' ? 'Voice' : 'Non-Voice';
      }
    }

    function clearAgentSelection() {
      // Reset agent selector
      document.getElementById('agent-selector').value = '';
      // Hide all workflow sections
      document.getElementById('admin-agent-list-section').classList.add('hidden');
      document.getElementById('file-selection-section').classList.add('hidden');
      document.getElementById('feedback-form-section').classList.add('hidden');
      document.getElementById('scoring-section').classList.add('hidden');
      // Clear selections
      selectedAgentForReview = null;
      selectedFileForReview = null;
      selectedProcessType = null;
      localStorage.removeItem('currentQualityFeedback');
    }

    function proceedToFeedback() {
      const fileInput = document.getElementById('quality-feedback-file');

      if (!fileInput.files[0]) {
        alert('Please select a file for quality review.');
        return;
      }

      selectedFileForReview = fileInput.files[0];

      // Hide file selection, show feedback form
      document.getElementById('file-selection-section').classList.add('hidden');
      document.getElementById('feedback-form-section').classList.remove('hidden');

      // Set agent and file info in feedback section
      document.getElementById('selected-agent-name-feedback').innerText = selectedAgentForReview.name;
      document.getElementById('selected-agent-id-feedback').innerText = selectedAgentForReview.id;
      document.getElementById('selected-process-feedback').innerText = selectedProcessType === 'voice' ? 'Voice' : 'Non-Voice';
      document.getElementById('selected-process-feedback-display').innerText = selectedProcessType === 'voice' ? 'Voice' : 'Non-Voice';
      document.getElementById('selected-file-name').innerText = selectedFileForReview.name;
    }

    function backToFileSelection() {
      // Hide feedback form, show file selection
      document.getElementById('feedback-form-section').classList.add('hidden');
      document.getElementById('file-selection-section').classList.remove('hidden');
    }

    function submitFeedbackAndProceed() {
      const feedback = document.getElementById('feedback-observations').value.trim();


      if (!feedback) {
        alert('Please provide feedback and observations.');
        return;
      }

      // Store feedback data temporarily
      const feedbackData = {
        agentId: selectedAgentForReview.id,
        file: selectedFileForReview,
        processType: selectedProcessType,
        // interactionType: removed
        feedback: feedback,
        timestamp: new Date().toISOString()
      };

      // Store in localStorage for now
      localStorage.setItem('currentQualityFeedback', JSON.stringify({
        ...feedbackData,
        fileName: selectedFileForReview.name
      }));

      // Hide feedback form, show additional feedback section
      document.getElementById('feedback-form-section').classList.add('hidden');
      document.getElementById('additional-feedback-section').classList.remove('hidden');

      // Set agent info in additional feedback section
      document.getElementById('selected-agent-name-additional').innerText = selectedAgentForReview.name;
      document.getElementById('selected-agent-id-additional').innerText = selectedAgentForReview.id;
      document.getElementById('process-type-additional').innerText = selectedProcessType === 'voice' ? 'Voice' : 'Non-Voice';
      document.getElementById('process-type-additional').innerText = selectedProcessType === 'voice' ? 'Voice' : 'Non-Voice';
      // Interaction Type removed
      document.getElementById('interaction-type-additional').parentElement.classList.add('hidden'); // Hide the interaction type line
      document.getElementById('primary-feedback-display').innerText = feedback;

      // Initialize with 3 default feedback items
      initializeAdditionalFeedback();
    }

    function initializeAdditionalFeedback() {
      // The HTML already has 3 default feedback items
      // Just update the count and ensure proper button states
      updateFeedbackCount();

      // Ensure the first 3 items have disabled remove buttons
      const container = document.getElementById('additional-feedback-container');
      const feedbackItems = container.querySelectorAll('.feedback-item');
      feedbackItems.forEach((item, index) => {
        const removeBtn = item.querySelector('button[onclick*="removeFeedbackItem"]');
        if (index < 3) {
          removeBtn.disabled = true;
          removeBtn.classList.add('opacity-50');
        } else {
          removeBtn.disabled = false;
          removeBtn.classList.remove('opacity-50');
        }
      });
    }

    function backToFeedbackForm() {
      // Hide additional feedback, show feedback form
      document.getElementById('additional-feedback-section').classList.add('hidden');
      document.getElementById('feedback-form-section').classList.remove('hidden');
    }

    function addFeedbackItem() {
      const container = document.getElementById('additional-feedback-container');
      const feedbackItems = container.querySelectorAll('.feedback-item');
      const count = feedbackItems.length;

      if (count >= 10) {
        alert('Maximum 10 feedback items allowed.');
        return;
      }

      const newItem = document.createElement('div');
      newItem.className = 'feedback-item mb-3 p-4 bg-white dark:bg-slate-700 rounded-xl border border-slate-200 dark:border-slate-600';
      newItem.innerHTML = `
        <div class="flex items-center justify-between mb-2">
          <label class="text-sm font-medium">Feedback Item ${count + 1}</label>
          <button onclick="removeFeedbackItem(this)" class="text-red-500 hover:text-red-700 text-sm">Remove</button>
        </div>
        <input type="text" placeholder="Enter additional feedback point..." class="w-full px-3 py-2 rounded-lg border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-700 focus:ring-2 focus:ring-purple-500 outline-none">
      `;

      container.appendChild(newItem);
      updateFeedbackCount();

      // Disable add button if at max
      if (count + 1 >= 10) {
        document.getElementById('add-feedback-btn').disabled = true;
        document.getElementById('add-feedback-btn').classList.add('opacity-50', 'cursor-not-allowed');
      }

      // Update remove button states for all items
      const allItems = container.querySelectorAll('.feedback-item');
      allItems.forEach((item, index) => {
        const removeBtn = item.querySelector('button[onclick*="removeFeedbackItem"]');
        if (index < 3) {
          removeBtn.disabled = true;
          removeBtn.classList.add('opacity-50');
        } else {
          removeBtn.disabled = false;
          removeBtn.classList.remove('opacity-50');
        }
      });
    }

    function removeFeedbackItem(button) {
      const container = document.getElementById('additional-feedback-container');
      const feedbackItems = container.querySelectorAll('.feedback-item');
      const count = feedbackItems.length;

      if (count <= 3) {
        alert('Minimum 3 feedback items required.');
        return;
      }

      button.closest('.feedback-item').remove();
      updateFeedbackCount();

      // Re-enable add button if below max
      document.getElementById('add-feedback-btn').disabled = false;
      document.getElementById('add-feedback-btn').classList.remove('opacity-50', 'cursor-not-allowed');

      // Renumber remaining items and update remove button states
      const remainingItems = container.querySelectorAll('.feedback-item');
      remainingItems.forEach((item, index) => {
        const label = item.querySelector('label');
        label.textContent = `Feedback Item ${index + 1}`;

        const removeBtn = item.querySelector('button[onclick*="removeFeedbackItem"]');
        if (index < 3) {
          removeBtn.disabled = true;
          removeBtn.classList.add('opacity-50');
        } else {
          removeBtn.disabled = false;
          removeBtn.classList.remove('opacity-50');
        }
      });
    }

    function updateFeedbackCount() {
      const container = document.getElementById('additional-feedback-container');
      const count = container.querySelectorAll('.feedback-item').length;
      document.getElementById('feedback-count').textContent = count;
    }

    function submitAdditionalFeedback() {
      const container = document.getElementById('additional-feedback-container');
      const feedbackInputs = container.querySelectorAll('.feedback-item input');
      const additionalFeedback = [];

      // Validate minimum 3 items
      if (feedbackInputs.length < 3) {
        alert('Minimum 3 feedback items required.');
        return;
      }

      // Collect feedback items
      feedbackInputs.forEach(input => {
        const value = input.value.trim();
        if (value) {
          additionalFeedback.push(value);
        }
      });

      // Validate that we have at least 3 non-empty items
      if (additionalFeedback.length < 3) {
        alert('Please fill in at least 3 feedback items.');
        return;
      }

      // Get existing feedback data and add additional feedback
      const existingData = JSON.parse(localStorage.getItem('currentQualityFeedback'));
      existingData.additionalFeedback = additionalFeedback;

      // Update localStorage
      localStorage.setItem('currentQualityFeedback', JSON.stringify(existingData));

      // Hide additional feedback, show scoring section
      document.getElementById('additional-feedback-section').classList.add('hidden');
      document.getElementById('scoring-section').classList.remove('hidden');

      // Set agent info in scoring section
      document.getElementById('selected-agent-name-scoring').innerText = selectedAgentForReview.name;
      document.getElementById('selected-agent-id-scoring').innerText = selectedAgentForReview.id;
      document.getElementById('process-type-display').innerText = existingData.processType === 'voice' ? 'Voice' : 'Non-Voice';
      document.getElementById('process-type-display').innerText = existingData.processType === 'voice' ? 'Voice' : 'Non-Voice';
      // document.getElementById('interaction-type-display').innerText = existingData.interactionType... removed;
      document.getElementById('interaction-type-display').parentElement.classList.add('hidden');
      document.getElementById('scoring-file-name').innerText = existingData.fileName;
      document.getElementById('feedback-display').innerText = existingData.feedback;

      // Update Submit Button State
      const pendingReviews = getPendingReviews(selectedAgentForReview.id);
      const currentCount = pendingReviews.length;
      const finalSubmitBtn = document.getElementById('final-submit-btn');
      const addReviewBtn = document.getElementById('add-review-btn');

      // We are working on the next review (currentCount + 1)
      const potentialTotal = currentCount + 1;

      if (potentialTotal >= 3) {
        finalSubmitBtn.disabled = false;
        finalSubmitBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        finalSubmitBtn.innerHTML = `Submit Final Reviews (${potentialTotal})`;
      } else {
        finalSubmitBtn.disabled = true;
        finalSubmitBtn.classList.add('opacity-50', 'cursor-not-allowed');
        finalSubmitBtn.innerHTML = `Submit Final Reviews (Need ${3 - potentialTotal} more)`;
      }

      // Check max limit for Add More
      if (potentialTotal >= 10) {
        addReviewBtn.disabled = true;
        addReviewBtn.classList.add('opacity-50', 'cursor-not-allowed');
        addReviewBtn.innerText = "Max Reviews Reached";
      } else {
        addReviewBtn.disabled = false;
        addReviewBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        addReviewBtn.innerText = "Add more quality review";
      }
    }

    function backToFeedback() {
      // Hide scoring, show feedback form
      document.getElementById('scoring-section').classList.add('hidden');
      document.getElementById('feedback-form-section').classList.remove('hidden');
    }

    function restoreAdditionalFeedback(feedbackItems) {
      const container = document.getElementById('additional-feedback-container');
      container.innerHTML = ''; // Clear existing

      feedbackItems.forEach((item, index) => {
        const newItem = document.createElement('div');
        newItem.className = 'feedback-item mb-3 p-4 bg-white dark:bg-slate-700 rounded-xl border border-slate-200 dark:border-slate-600';
        const isDisabled = index < 3;
        newItem.innerHTML = `
          <div class="flex items-center justify-between mb-2">
            <label class="text-sm font-medium">Feedback Item ${index + 1}</label>
            <button onclick="removeFeedbackItem(this)" class="text-red-500 hover:text-red-700 text-sm ${isDisabled ? 'opacity-50' : ''}" ${isDisabled ? 'disabled' : ''}>Remove</button>
          </div>
          <input type="text" value="${item}" placeholder="Enter additional feedback point..." class="w-full px-3 py-2 rounded-lg border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-700 focus:ring-2 focus:ring-purple-500 outline-none">
        `;

        container.appendChild(newItem);
      });

      updateFeedbackCount();

      // Update add button state
      const count = feedbackItems.length;
      const addBtn = document.getElementById('add-feedback-btn');
      if (count >= 10) {
        addBtn.disabled = true;
        addBtn.classList.add('opacity-50', 'cursor-not-allowed');
      } else {
        addBtn.disabled = false;
        addBtn.classList.remove('opacity-50', 'cursor-not-allowed');
      }
    }

    function submitPerformanceScore(isFinal = false) {
      const score = document.querySelector('input[name="performance-score"]:checked');

      if (!score) {
        alert('Please select a performance score.');
        return;
      }

      const feedbackData = JSON.parse(localStorage.getItem('currentQualityFeedback'));
      if (!feedbackData) {
        alert('No feedback data found. Please restart the process.');
        return;
      }

      // Save this review to pending reviews for the agent
      const reviewData = {
        agentId: selectedAgentForReview.id,
        score: parseInt(score.value),
        isFatal: score.value === '0',
        feedbackData: feedbackData,
        timestamp: new Date().toISOString(),
        reviewerId: currentUser.id,
        fileName: feedbackData.fileName
      };

      savePendingReview(reviewData);

      // Clear temporary data
      localStorage.removeItem('currentQualityFeedback');

      // Check agent review count
      const pendingReviews = getPendingReviews(selectedAgentForReview.id);

      if (isFinal) {
        if (pendingReviews.length < 3) {
          alert(`Minimum 3 reviews required. Currently: ${pendingReviews.length}`);
          return;
        }
        showFinalSubmissionOption(selectedAgentForReview.id);
      } else {
        // Add more review
        if (pendingReviews.length >= 10) {
          alert('Maximum 10 reviews reached. Please submit final.');
          // Maybe force final?
          showFinalSubmissionOption(selectedAgentForReview.id);
          return;
        }

        // Reset workflow for next review
        resetForNextReview();
        alert(`Review saved. Total pending: ${pendingReviews.length}. You can add more or submit final.`);
      }
    }

    function savePendingReview(reviewData) {
      const pendingReviews = JSON.parse(localStorage.getItem('pending_agent_reviews') || '{}');
      if (!pendingReviews[reviewData.agentId]) {
        pendingReviews[reviewData.agentId] = [];
      }
      pendingReviews[reviewData.agentId].push(reviewData);
      localStorage.setItem('pending_agent_reviews', JSON.stringify(pendingReviews));
    }

    function getPendingReviews(agentId) {
      const pendingReviews = JSON.parse(localStorage.getItem('pending_agent_reviews') || '{}');
      return pendingReviews[agentId] || [];
    }

    function showFinalSubmissionOption(agentId) {
      const pendingReviews = getPendingReviews(agentId);
      const agent = USER_DB.find(u => u.id === agentId);

      // Hide current workflow sections
      document.getElementById('scoring-section').classList.add('hidden');

      // Show final submission section
      const finalSection = document.getElementById('final-submission-section');
      if (!finalSection) {
        // Create the final submission section
        createFinalSubmissionSection();
      }

      document.getElementById('final-submission-section').classList.remove('hidden');

      // Populate final submission data
      document.getElementById('final-agent-name').innerText = agent.name;
      document.getElementById('final-agent-id').innerText = agent.id;

      // Calculate average score
      const totalScore = pendingReviews.reduce((sum, review) => sum + review.score, 0);
      const averageScore = Math.round(totalScore / pendingReviews.length);
      document.getElementById('final-average-score').innerText = averageScore;

      // Show review summary
      const reviewSummary = document.getElementById('final-review-summary');
      reviewSummary.innerHTML = '';
      pendingReviews.forEach((review, index) => {
        const reviewDiv = document.createElement('div');
        reviewDiv.className = 'p-3 bg-slate-50 dark:bg-slate-700 rounded-lg mb-2';
        reviewDiv.innerHTML = `
          <div class="flex justify-between items-center">
            <span class="font-medium">Review ${index + 1}</span>
            <span class="text-sm text-slate-500">${new Date(review.timestamp).toLocaleDateString()}</span>
          </div>
          <div class="text-sm text-slate-600 dark:text-slate-300 mt-1">
            Process: ${review.processType === 'voice' ? 'Voice' : 'Non-Voice'} | File: ${review.fileName} | Score: ${review.score}/100
          </div>
        `;
        reviewSummary.appendChild(reviewDiv);
      });
    }

    function createFinalSubmissionSection() {
      const section = document.createElement('div');
      section.id = 'final-submission-section';
      section.className = 'hidden bg-green-50 dark:bg-slate-800 p-8 rounded-3xl mb-12 border border-green-200 dark:border-slate-700';

      section.innerHTML = `
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-2xl font-bold flex items-center gap-3">
            <span class="bg-green-600 text-white rounded-lg p-2 text-xl">‚úÖ</span>
            Final Performance Submission for <span id="final-agent-name" class="text-green-600"></span>
          </h2>
          <button onclick="cancelReviewProcess()" class="text-slate-500 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-200 text-sm font-medium">
            Cancel Process
          </button>
        </div>

        <div class="mb-6 p-4 bg-white dark:bg-slate-700 rounded-xl border border-slate-200 dark:border-slate-600">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm text-slate-600 dark:text-slate-300">
            <div><strong>Agent ID:</strong> <span id="final-agent-id" class="font-mono"></span></div>
            <div><strong>Average Score:</strong> <span id="final-average-score" class="font-bold text-green-600"></span>/100</div>
          </div>
        </div>

        <div class="mb-6">
          <h3 class="text-lg font-semibold mb-4">Review Summary (3 Reviews Completed)</h3>
          <div id="final-review-summary" class="space-y-2">
            <!-- Review summaries will be populated here -->
          </div>
        </div>

        <div class="mb-6 p-4 bg-yellow-50 dark:bg-slate-700 rounded-xl border border-yellow-200 dark:border-slate-600">
          <p class="text-sm text-yellow-800 dark:text-yellow-200">
            <strong>Note:</strong> This will calculate the final performance score based on the average of all 3 reviews and update the agent's performance record.
          </p>
        </div>

        <button onclick="submitFinalPerformanceScore()"
          class="bg-green-600 text-white font-bold py-3 px-8 rounded-xl hover:bg-green-700 transition shadow-lg shadow-green-500/30">
          Submit Final Performance Score
        </button>
      `;

      // Insert after the scoring section
      const scoringSection = document.getElementById('scoring-section');
      scoringSection.parentNode.insertBefore(section, scoringSection.nextSibling);
    }

    function submitFinalPerformanceScore() {
      const agentId = document.getElementById('final-agent-id').innerText;
      const pendingReviews = getPendingReviews(agentId);

      if (pendingReviews.length < 3) {
        alert('Minimum 3 reviews required before final submission.');
        return;
      }

      // Calculate final score (average of all reviews)
      const totalScore = pendingReviews.reduce((sum, review) => sum + review.score, 0);
      const finalScore = Math.round(totalScore / pendingReviews.length);

      // Check if any review was fatal (score = 0)
      const hasFatal = pendingReviews.some(review => review.isFatal);

      // Save the final performance score
      const performanceData = {
        agentId: agentId,
        score: finalScore,
        isFatal: hasFatal,
        feedbackData: { reviews: pendingReviews }, // Store all reviews
        timestamp: new Date().toISOString(),
        reviewerId: currentUser.id
      };

      MockBackend.savePerformanceScore(performanceData);

      // Clear pending reviews for this agent
      const allPending = JSON.parse(localStorage.getItem('pending_agent_reviews') || '{}');
      delete allPending[agentId];
      localStorage.setItem('pending_agent_reviews', JSON.stringify(allPending));

      // Reset workflow
      document.getElementById('final-submission-section').classList.add('hidden');
      document.getElementById('admin-agent-list-section').classList.add('hidden');

      // Reset selections
      selectedAgentForReview = null;
      selectedFileForReview = null;
      document.getElementById('agent-selector').value = '';

      // Refresh dashboard
      renderAdminDashboard();

      alert(`Final performance score (${finalScore}/100) submitted successfully for agent!`);
    }

    function showFinalSubmissionOptionForSelectedAgent() {
      if (selectedAgentForReview) {
        showFinalSubmissionOption(selectedAgentForReview.id);
      }
    }

    function cancelReviewProcess() {
      // Clear any temporary data
      localStorage.removeItem('currentQualityFeedback');

      // If there's a selected agent with pending reviews, ask if they want to clear them
      if (selectedAgentForReview) {
        const pendingReviews = getPendingReviews(selectedAgentForReview.id);
        if (pendingReviews.length > 0) {
          const clearPending = confirm(`This agent has ${pendingReviews.length} pending review(s). Do you want to clear all pending reviews for this agent?`);
          if (clearPending) {
            const allPending = JSON.parse(localStorage.getItem('pending_agent_reviews') || '{}');
            delete allPending[selectedAgentForReview.id];
            localStorage.setItem('pending_agent_reviews', JSON.stringify(allPending));
          }
        }
      }

      selectedAgentForReview = null;
      selectedFileForReview = null;

      // Reset to agent selection view (hide all workflow sections)
      document.getElementById('file-selection-section').classList.add('hidden');
      document.getElementById('feedback-form-section').classList.add('hidden');
      document.getElementById('additional-feedback-section').classList.add('hidden');
      document.getElementById('scoring-section').classList.add('hidden');
      document.getElementById('final-submission-section').classList.add('hidden');
      document.getElementById('admin-agent-list-section').classList.add('hidden');

      // Reset agent selector
      document.getElementById('agent-selector').value = '';

      // Refresh dashboard to update agent statuses
      renderAdminDashboard();
    }

    function resetForNextReview() {
      // Hide scoring section
      document.getElementById('scoring-section').classList.add('hidden');

      // Reset to file selection for next review
      document.getElementById('file-selection-section').classList.remove('hidden');

      // Clear file selection
      selectedFileForReview = null;
      const fileInput = document.getElementById('quality-feedback-file');
      if (fileInput) fileInput.value = '';

      document.getElementById('selected-file-name').innerText = 'No file selected';

      // Reset Feedback Form
      document.getElementById('feedback-observations').value = '';

      // Reset Additional Feedback Section to default 3 items
      const container = document.getElementById('additional-feedback-container');
      container.innerHTML = `
        <div class="feedback-item mb-3 p-4 bg-white dark:bg-slate-700 rounded-xl border border-slate-200 dark:border-slate-600">
          <div class="flex items-center justify-between mb-2">
            <label class="text-sm font-medium">Feedback Item 1</label>
            <button onclick="removeFeedbackItem(this)" class="text-red-500 hover:text-red-700 text-sm opacity-50" disabled>Remove</button>
          </div>
          <input type="text" placeholder="Enter additional feedback point..." class="w-full px-3 py-2 rounded-lg border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-700 focus:ring-2 focus:ring-purple-500 outline-none">
        </div>
        <div class="feedback-item mb-3 p-4 bg-white dark:bg-slate-700 rounded-xl border border-slate-200 dark:border-slate-600">
          <div class="flex items-center justify-between mb-2">
            <label class="text-sm font-medium">Feedback Item 2</label>
            <button onclick="removeFeedbackItem(this)" class="text-red-500 hover:text-red-700 text-sm opacity-50" disabled>Remove</button>
          </div>
          <input type="text" placeholder="Enter additional feedback point..." class="w-full px-3 py-2 rounded-lg border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-700 focus:ring-2 focus:ring-purple-500 outline-none">
        </div>
        <div class="feedback-item mb-3 p-4 bg-white dark:bg-slate-700 rounded-xl border border-slate-200 dark:border-slate-600">
          <div class="flex items-center justify-between mb-2">
            <label class="text-sm font-medium">Feedback Item 3</label>
            <button onclick="removeFeedbackItem(this)" class="text-red-500 hover:text-red-700 text-sm opacity-50" disabled>Remove</button>
          </div>
          <input type="text" placeholder="Enter additional feedback point..." class="w-full px-3 py-2 rounded-lg border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-700 focus:ring-2 focus:ring-purple-500 outline-none">
        </div>
      `;
      updateFeedbackCount();
      document.getElementById('add-feedback-btn').disabled = false;
      document.getElementById('add-feedback-btn').classList.remove('opacity-50', 'cursor-not-allowed');

      // Reset Performance Score Radios
      const scoreRadios = document.getElementsByName('performance-score');
      scoreRadios.forEach(radio => radio.checked = false);
    }

    function calculateTotalScore() {
      const audit = parseInt(document.getElementById('indiv-score').value) || 0;
      const errors = parseInt(document.getElementById('indiv-errors').value);
      const compliance = parseInt(document.getElementById('indiv-compliance').value) || 0;

      const display = document.getElementById('calc-total-score');

      // Logic: 
      // If Fatal Error (1) -> Score 0
      // Else -> Average of Audit & Compliance? Or just Audit?
      // User said "choose the score 0 and hundred... automatically fetch total"
      // Let's assume strict compliance.

      let total = 0;

      if (document.getElementById('indiv-errors').value === "") {
        display.innerText = "--";
        return;
      }

      if (errors === 1) {
        total = 0;
      } else {
        // If no fatal errors
        // Using simple average for now, standard QA math
        total = (audit + compliance) / 2;
      }

      display.innerText = total + "%";
      if (total === 100) display.className = "text-2xl font-black text-emerald-500";
      else if (total === 0) display.className = "text-2xl font-black text-red-500";
      else display.className = "text-2xl font-black text-indigo-600";
    }

    function handleFileUpload() {
      const fileInput = document.getElementById('admin-file-upload');
      if (fileInput.files.length > 0) {
        const file = fileInput.files[0];

        // Read file content
        const reader = new FileReader();
        reader.onload = function (e) {
          const content = e.target.result;
          try {
            MockBackend.addReport(file, content);
            alert(`Successfully uploaded "${file.name}"`);
            renderAdminDashboard(); // Refresh UI
          } catch (err) {
            alert('Upload failed: File might be too large for browser storage.');
            console.error(err);
          }
        };
        reader.readAsDataURL(file);

        fileInput.value = ''; // Reset
      } else {
        alert('Please select a file first.');
      }
    }

    function handleDeleteReport(id) {
      if (confirm('Are you sure you want to delete this report? It will be removed for all agents.')) {
        MockBackend.deleteReport(id);
        renderAdminDashboard(); // Refresh
      }
    }

    function handleDeleteComment(id) {
      if (confirm('Are you sure you want to delete this comment?')) {
        MockBackend.deleteComment(id);
        renderAdminDashboard(); // Refresh
      }
    }

    function viewReviewDetails(reviewId) {
      const reviews = MockBackend.getPerformanceScores();
      const review = reviews.find(r => r.id == reviewId);

      if (review) {
        const agent = USER_DB.find(u => u.id === review.agentId);
        const agentName = agent ? agent.name : review.agentId;
        const date = new Date(review.timestamp).toLocaleString();

        const details = `
Review Details:
- Date: ${date}
- Agent: ${agentName} (${review.agentId})
- Score: ${review.score === 0 ? '0 (Fatal Error)' : review.score}
- Interaction Type: ${review.feedbackData.interactionType}
- File: ${review.feedbackData.fileName}
- Feedback: ${review.feedbackData.feedback}

Reviewer: ${review.reviewerId}
        `;

        alert(details);
      }
    }

    function resetAllPerformanceData() {
      if (confirm('Are you sure you want to reset ALL performance data? This will clear all reviews and scores for all agents. This action cannot be undone.')) {
        MockBackend.clearAllPerformanceData();
        renderAdminDashboard();
        alert('All performance data has been reset. All agents now show as "Not Scored".');
      }
    }

    function clearSelectedAgent() {
      selectedAgentForUpload = null;
      document.getElementById('indiv-agent-search').value = '';
      document.getElementById('indiv-agent-results').classList.add('hidden');
      document.getElementById('indiv-agent-selected').classList.add('hidden');
      document.getElementById('indiv-agent-selected').classList.remove('flex');
      document.getElementById('indiv-upload-form').classList.add('hidden');
      document.getElementById('indiv-score').value = '';
      document.getElementById('indiv-errors').value = '';
      document.getElementById('indiv-compliance').value = '';
      document.getElementById('calc-total-score').innerText = '--';
      document.getElementById('proof-audio').value = '';
      document.getElementById('proof-chat').value = '';
      document.getElementById('proof-email').value = '';
    }

    function renderAgentDashboard() {
      if (currentUser) {
        document.getElementById('agent-name-display').innerText = currentUser.name;
      }
    }

    function openAgentPerformanceModal() {
      if (!currentUser) return;
      const modal = document.getElementById('agent-performance-modal');
      const contentLoaded = document.getElementById('perf-content-loaded');
      const contentEmpty = document.getElementById('perf-content-empty');

      document.getElementById('modal-agent-id').innerText = `ID: ${currentUser.id}`;
      modal.classList.remove('hidden');

      const perfData = MockBackend.getPerformance(currentUser.id);

      if (perfData) {
        contentLoaded.classList.remove('hidden');
        contentEmpty.classList.add('hidden');

        // Populate Scores based on localStorage reviews (Primary Source)
        let reviews = JSON.parse(localStorage.getItem('adminReviews') || '[]');
        reviews = reviews.filter(r => r.agentId === currentUser.id);

        let totalScore = 0;
        let fatalCount = 0;
        let goodCount = 0;
        let avgScore = 0;

        if (reviews.length > 0) {
          reviews.forEach(r => {
            // Handle score parsing properly
            let s = parseInt(r.score);
            if (isNaN(s)) s = 0;

            totalScore += s;
            if (s === 0) fatalCount++;
            if (s === 100) goodCount++;
          });
          avgScore = Math.round(totalScore / reviews.length);
        } else {
          // Fallback to MockBackend logic if no reviews found
          const audit = parseInt(perfData.score) || 0;
          avgScore = audit;
        }

        document.getElementById('modal-audit-score').innerText = perfData.score; // Keep original Monthly? Or switch to count? User request ambiguous. Let's keep perfData for compliance/stats if consistent.
        // Actually, let's use the box for "No. of Audits" as per the new label in HTML?
        // HTML Line 1163: <p class="text-xs font-bold uppercase text-slate-400 mb-2">No. of Audits</p>
        // HTML ID: modal-audit-count. Wait, the JS below uses 'modal-audit-score'.
        // Let's check the view_file of openAgentPerformanceModal again.
        // It used document.getElementById('modal-audit-score').innerText = perfData.score;
        // BUT the HTML in view-performance (Line 1164) has id="modal-audit-count".
        // The previous JS snippet I viewed had `modal-audit-score` ???
        // Let's assume the ID in HTML is `modal-audit-count` per my view of line 1164.

        const countSpan = document.getElementById('modal-audit-count');
        if (countSpan) countSpan.innerText = reviews.length;

        document.getElementById('modal-fatal-count').innerText = fatalCount;
        document.getElementById('modal-good-count').innerText = goodCount;
        document.getElementById('modal-total-score').innerText = avgScore + '%';

        // Populate Reviews List
        const reviewsList = document.getElementById('modal-reviews-list');
        if (reviews.length > 0) {
          reviewsList.innerHTML = reviews.map(r => `
            <div class="bg-slate-50 dark:bg-slate-800 p-6 rounded-2xl border border-slate-200 dark:border-slate-700">
              <div class="flex justify-between items-start mb-4">
                <div>
                  <p class="text-sm text-slate-500">${r.date}</p>
                  <h4 class="font-bold text-lg">${r.fileName || 'Review'}</h4>
                  <p class="text-sm text-blue-600 underline cursor-pointer" onclick="openFileContent('${r.fileContent}', '${r.fileName}')">View File</p>
                </div>
                <div class="text-right">
                  <span class="inline-block px-3 py-1 rounded-full text-sm font-bold ${r.score == 100 ? 'bg-emerald-100 text-emerald-600' : 'bg-red-100 text-red-600'}">
                    Score: ${r.score}
                  </span>
                </div>
              </div>
              <div class="bg-white dark:bg-slate-900 p-4 rounded-xl border border-slate-100 dark:border-slate-800">
                 <p class="text-sm font-bold text-slate-500 mb-1">Observation:</p>
                 <p class="text-slate-700 dark:text-slate-300">${r.observation}</p>
              </div>
            </div>
          `).join('');
        } else {
          reviewsList.innerHTML = '<p class="text-center text-slate-500 italic">No reviews found.</p>';
        }

        // MockBackend Proofs (Preserved)
        const proofsList = document.getElementById('modal-proofs-list');
        if (perfData.proofs && perfData.proofs.length > 0) {
          proofsList.innerHTML = perfData.proofs.map(p => `
                <div class="flex items-center justify-between p-4 bg-white dark:bg-slate-700 rounded-xl border border-slate-200 dark:border-slate-600">
                   <div class="flex items-center gap-3">
                      <div class="w-10 h-10 rounded-full bg-slate-100 dark:bg-slate-600 flex items-center justify-center text-xl">${p.icon}</div>
                      <div>
                         <p class="font-bold text-sm text-slate-700 dark:text-slate-200">${p.name}</p>
                         <p class="text-[10px] text-slate-400 uppercase">${p.type.split('/')[1] || 'FILE'}</p>
                      </div>
                   </div>
                   <button onclick="openReport('${p.content}', '${p.type}')" class="bg-indigo-50 dark:bg-indigo-900/30 text-indigo-600 px-4 py-2 rounded-lg font-bold text-sm hover:bg-indigo-100 transition">View üëÅÔ∏è</button>
                </div>
             `).join('');
        } else {
          proofsList.innerHTML = '<p class="col-span-2 text-center text-slate-400 italic">No proofs attached.</p>';
        }

        // Check notifications on load
        checkAgentNotifications(false);

      } else {
        contentLoaded.classList.add('hidden');
        contentEmpty.classList.remove('hidden');
      }
    }

    function checkAgentNotifications(showPopup) {
      if (!currentUser || currentUser.role !== 'agent') return;

      let reviews = JSON.parse(localStorage.getItem('adminReviews') || '[]');
      const now = new Date();
      // Filter for this week (last 7 days) and current agent
      const oneWeekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);

      const newReviews = reviews.filter(r => {
        // Handle date string MM/DD/YYYY or similar
        return r.agentId === currentUser.id;
      });

      const recentReviews = newReviews.filter(r => {
        const d = new Date(r.date);
        return !isNaN(d.getTime()) && d >= oneWeekAgo;
      });

      const hasUpdate = recentReviews.length > 0;
      const dots = document.querySelectorAll('.agent-notification-dot');

      if (hasUpdate) {
        dots.forEach(dot => dot.classList.remove('hidden'));
        if (showPopup) {
          alert('You have received the quality feedback for this week kindly check.');
          // Auto-remove notification after agent sees it
          dots.forEach(dot => dot.classList.add('hidden'));
        }
      } else {
        dots.forEach(dot => dot.classList.add('hidden'));
        if (showPopup) {
          alert("There's no update.");
        }
      }
    }

    function closeAgentPerformanceModal() {
      document.getElementById('agent-performance-modal').classList.add('hidden');
    }

    // BULK PERFORMANCE MANAGER
    function openReport(content, type) {
      const win = window.open();
      if (win) {
        if (type.startsWith('image/')) {
          win.document.write(`<div style="display:flex;justify-content:center;align-items:center;height:100vh;background:#f0f0f0;"><img src="${content}" style="max-width:100%;max-height:100%;box-shadow:0 0 20px rgba(0,0,0,0.1);"></div>`);
        } else if (type === 'application/pdf') {
          win.document.write(`<embed width="100%" height="100%" src="${content}" type="application/pdf">`);
        } else {
          // Fallback for other types
          win.document.write(`<h2 style="font-family:sans-serif;text-align:center;padding:20px;">Preview not available for this file type. Please download to view.</h2><div style="text-align:center;"><a href="${content}" download="file" style="padding:10px 20px;background:#3b82f6;color:white;text-decoration:none;border-radius:5px;">Download File</a></div>`);
        }
        win.document.title = "View Report";
        win.document.close(); // Important for loading
      } else {
        alert('Pop-up blocked! Please allow pop-ups for this site to view reports.');
      }
    }

    function handleCommentSubmit() {
      const input = document.getElementById('agent-comment-input');
      const text = input.value.trim();

      if (!text) return alert('Please write a comment first.');
      if (!currentUser) return alert('You must be logged in.');

      MockBackend.addComment(text, currentUser.id);
      alert('Feedback sent to Admin successfully!');
      input.value = '';
    }

    function logout() {
      currentUser = null;
      navigateTo('view-home');
    }

    // ===== AGENT QUALITY ASSURANCE FUNCTIONS =====
    function agentLoadQADashboard() {
      if (!currentSessionUser || currentSessionUser.role !== 'agent') {
        return; // Only for agents
      }

      const agentId = currentSessionUser.id;
      const agentName = currentSessionUser.name;

      // Set welcome text
      document.getElementById('agent-qa-welcome-text').innerText = `Welcome ${agentName}`;

      // Load reviews for this agent
      let reviews = JSON.parse(localStorage.getItem('adminReviews') || '[]');

      // Filter reviews for current agent only
      const agentReviews = reviews.filter(r => r.agentId === agentId);

      // Calculate stats
      const totalReviews = agentReviews.length;
      const avgScore = totalReviews > 0 ? Math.round(agentReviews.reduce((sum, r) => sum + r.score, 0) / totalReviews) : 0;

      // Get last review date
      let lastReviewDate = '--';
      if (agentReviews.length > 0) {
        const lastReview = agentReviews[0];
        lastReviewDate = lastReview.date;
      }

      // Determine performance status
      let status = 'Excellent';
      let statusColor = 'text-green-600';
      if (avgScore >= 80) {
        status = 'Excellent';
        statusColor = 'text-green-600';
      } else if (avgScore >= 60) {
        status = 'Good';
        statusColor = 'text-blue-600';
      } else if (avgScore >= 40) {
        status = 'Need Improvement';
        statusColor = 'text-amber-600';
      } else {
        status = 'Critical';
        statusColor = 'text-red-600';
      }

      // Update stats
      document.getElementById('agent-total-reviews').innerText = totalReviews;
      document.getElementById('agent-avg-score').innerText = avgScore;
      document.getElementById('agent-last-review').innerText = lastReviewDate;
      document.getElementById('agent-performance-status').className = `text-lg font-bold ${statusColor}`;
      document.getElementById('agent-performance-status').innerText = status;

      // Populate reviews history table
      const tbody = document.getElementById('agent-reviews-history');
      const noReviewsMsg = document.getElementById('agent-no-reviews-message');

      if (agentReviews.length === 0) {
        tbody.innerHTML = '';
        noReviewsMsg.classList.remove('hidden');
      } else {
        noReviewsMsg.classList.add('hidden');
        // Build rows showing full observation and comment/reply UI
        tbody.innerHTML = agentReviews.map(review => {
          const fileCell = review.fileName ? `<td class="p-6 text-sm text-blue-600 underline cursor-pointer" onclick="openFileContent('${review.fileContent}', '${review.fileName}')">${review.fileName}</td>` : `<td class="p-6 text-sm">-</td>`;

          // Comments for this review
          const comments = (JSON.parse(localStorage.getItem('reviewComments') || '[]')).filter(c => c.reviewId === review.id);
          const commentsHtml = comments.length === 0 ? '<div class="text-sm text-slate-500 italic">No replies yet</div>' : comments.map(c => `<div class="mb-2"><strong class="text-sm">${c.authorName || c.authorId}</strong> <span class="text-xs text-slate-400">(${c.date})</span><div class="text-sm mt-1">${c.text}</div></div>`).join('');

          return `
          <tr class="hover:bg-slate-50 dark:hover:bg-slate-700/50">
            <td class="p-6">${review.date}</td>
            <td class="p-6">${review.reviewerName || 'Admin'}</td>
            ${fileCell}
            <td class="p-6"><span class="font-bold ${review.score === 100 ? 'text-emerald-600' : review.score >= 50 ? 'text-blue-600' : 'text-red-600'}">${review.score}</span></td>
            <td class="p-6 text-sm">
              <div class="mb-3"><strong class="text-sm">Observation</strong>
                <div class="text-sm mt-1 whitespace-pre-wrap">${(review.observation || '').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/\n/g, '<br>')}</div>
              </div>
              <div class="mb-3"><strong class="text-sm">Replies</strong>
                <div id="review-comments-${review.id}" class="mt-2">${commentsHtml}</div>
              </div>
              <div class="flex gap-2">
                <textarea id="reply-${review.id}" rows="2" placeholder="Add a reply..." class="w-full px-3 py-2 rounded border border-slate-200"></textarea>
                <button onclick="agentReplyToReview('${review.id}')" class="px-4 py-2 bg-blue-600 text-white rounded">Reply</button>
              </div>
            </td>
            <td class="p-6"><span class="px-3 py-1 rounded-full text-xs font-bold ${review.score === 100 ? 'bg-emerald-100 text-emerald-700' : 'bg-amber-100 text-amber-700'}">${review.score === 100 ? 'Good' : 'Review'}</span></td>
          </tr>
        `}).join('');
      }

      // Load feedback
      agentLoadFeedback(agentId);
    }

    function agentLoadFeedback(agentId) {
      let comments = JSON.parse(localStorage.getItem('gojira_comments') || '[]');

      // Filter feedback for current agent
      let agentComments = comments.filter(c => c.agentId === agentId);

      const tbody = document.getElementById('agent-feedback-list');
      const noFeedbackMsg = document.getElementById('agent-no-feedback-message');

      if (agentComments.length === 0) {
        tbody.innerHTML = '';
        noFeedbackMsg.classList.remove('hidden');
      } else {
        noFeedbackMsg.classList.add('hidden');
        const now = new Date();
        tbody.innerHTML = agentComments.map(comment => {
          // Calculate expiry date (7 days from comment date)
          const commentDate = new Date(comment.date);
          const expiryDate = new Date(commentDate.getTime() + 7 * 24 * 60 * 60 * 1000);
          const daysLeft = Math.ceil((expiryDate - now) / (1000 * 60 * 60 * 24));

          return `
            <tr class="hover:bg-slate-50 dark:hover:bg-slate-700/50">
              <td class="p-6">${comment.date}</td>
              <td class="p-6">Quality Team</td>
              <td class="p-6 text-sm">${comment.text.substring(0, 50)}...</td>
              <td class="p-6"><span class="px-3 py-1 rounded-full text-xs font-bold ${daysLeft > 0 ? 'bg-blue-100 text-blue-700' : 'bg-slate-100 text-slate-700'}">${daysLeft > 0 ? daysLeft + ' days' : 'Expired'}</span></td>
            </tr>
          `;
        }).join('');
      }
    }

    function handleAgentSearch(query) {
      const resultsDiv = document.getElementById('indiv-agent-results');
      if (!query || query.length < 2) {
        resultsDiv.classList.add('hidden');
        return;
      }

      const matched = USER_DB.filter(u =>
        u.role === 'agent' &&
        (u.name.toLowerCase().includes(query.toLowerCase()) || u.id.toLowerCase().includes(query.toLowerCase()))
      );

      if (matched.length === 0) {
        resultsDiv.innerHTML = '<div class="p-4 text-sm text-slate-500 italic">No agents found</div>';
      } else {
        resultsDiv.innerHTML = matched.map(u => `
          <div onclick="selectAgent('${u.id}')" class="p-3 hover:bg-slate-50 dark:hover:bg-slate-700 cursor-pointer border-b border-slate-50 dark:border-slate-700 last:border-0">
             <div class="font-bold text-slate-700 dark:text-slate-200">${u.name}</div>
             <div class="text-xs text-slate-500 font-mono">${u.id} ‚Ä¢ ${u.entity}</div>
          </div>
        `).join('');
      }
      resultsDiv.classList.remove('hidden');
    }

    // Agent reply to a specific review
    function agentReplyToReview(reviewId) {
      const textarea = document.getElementById('reply-' + reviewId);
      if (!textarea) return;
      const text = textarea.value.trim();
      if (!text) return alert('Please write a reply first.');
      const now = new Date().toLocaleString();

      const comments = JSON.parse(localStorage.getItem('reviewComments') || '[]');
      comments.unshift({
        id: Date.now().toString() + '-' + Math.floor(Math.random() * 1000).toString(),
        reviewId: reviewId,
        authorId: currentSessionUser?.id || currentUser?.id || 'agent',
        authorName: currentSessionUser?.name || currentUser?.name || 'Agent',
        text: text,
        date: now
      });
      localStorage.setItem('reviewComments', JSON.stringify(comments));

      // Clear textarea and refresh agent dashboard comments
      textarea.value = '';
      agentLoadQADashboard();
    }

    function selectAgent(id) {
      selectedAgentForUpload = USER_DB.find(u => u.id === id);
      if (!selectedAgentForUpload) return;

      // Update UI
      document.getElementById('indiv-agent-search').value = '';
      document.getElementById('indiv-agent-results').classList.add('hidden');
      document.getElementById('indiv-agent-selected').classList.remove('hidden');
      document.getElementById('indiv-agent-selected').classList.add('flex');
      document.getElementById('indiv-upload-form').classList.remove('hidden');

      document.getElementById('selected-agent-name').innerText = selectedAgentForUpload.name;
      document.getElementById('selected-agent-id').innerText = selectedAgentForUpload.id;

      // Search Input hidden or disabled
      document.getElementById('indiv-agent-search').parentElement.parentElement.classList.add('hidden');
    }



    async function submitIndividualScore() {
      if (!selectedAgentForUpload) return alert('No agent selected.');

      const score = document.getElementById('indiv-score').value;
      const errors = document.getElementById('indiv-errors').value;
      const compliance = document.getElementById('indiv-compliance').value;

      if (!score || !errors) return alert('Please enter Score and Errors.');

      // Handle File Uploads
      const proofs = [];
      const files = [
        { id: 'proof-audio', name: 'Call Recording', icon: 'üé§' },
        { id: 'proof-chat', name: 'Chat Transcript', icon: 'üí¨' },
        { id: 'proof-email', name: 'Email Proof', icon: '‚úâÔ∏è' }
      ];

      try {
        for (const f of files) {
          const input = document.getElementById(f.id);
          if (input.files.length > 0) {
            const file = input.files[0];
            const content = await readFileAsBase64(file);
            proofs.push({
              name: f.name + ` (${file.name})`,
              icon: f.icon,
              type: file.type,
              content: content
            });
          }
        }
      } catch (e) {
        console.error(e);
        return alert('Error processing files. Please try again.');
      }

      // Save
      MockBackend.savePerformance(selectedAgentForUpload.id, {
        score,
        errors,
        compliance,
        proofs
      });

      alert(`Performance updated for ${selectedAgentForUpload.name} successfully!`);
      clearSelectedAgent();
    }

    function readFileAsBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result);
        reader.onerror = error => reject(error);
      });
    }

    const searchData = [
      { name: 'Knowledge Base', id: 'view-kb' },
      { name: 'Brand Entities', id: 'view-entities' },
      { name: 'New Updates', id: 'view-updates' },
      { name: 'Resources', id: 'view-resources' },
      { name: 'BharatLoan', id: 'view-bharatloan' },
      { name: 'Rupee112', id: 'view-rupee112' },
      { name: 'Loan112', id: 'view-loan112' },
      { name: 'RupeeOnTime', id: 'view-rupeeontime' },
      { name: 'Quality Assurance Checklist', id: 'view-checklist' },
      { name: 'BharatLoan Portal', id: 'view-bharatloan' },
      { name: 'Rupee112 Portal', id: 'view-rupee112' },
      { name: 'Loan112 Portal', id: 'view-loan112' },
      { name: 'RupeeOnTime Portal', id: 'view-rupeeontime' },
      { name: 'WOCOM 365', id: 'view-bharatloan' },
      { name: 'Yellow Ai', id: 'view-bharatloan' },
      { name: 'Outlook', id: 'view-bharatloan' },
    ];

    let currentEntity = '';
    let currentUser = null;
    let selectedAgentForUpload = null;

    const ENTITY_VIEW_MAP = {
      'view-bharatloan': 'BharatLoan',
      'view-rupee112': 'Rupee112',
      'view-loan112': 'Loan112',
      'view-rupeeontime': 'RupeeOnTime'
    };

    // Filter entities display based on user role
    function filterEntitiesDisplay() {
      const userToCheck = currentSessionUser || currentUser;
      if (!userToCheck) return; // Not logged in via new system

      // Get all entity cards
      const entities = document.querySelectorAll('#view-entities .grid > div');

      entities.forEach(entityCard => {
        // Check which entity this card represents based on onclick attribute
        const onclick = entityCard.getAttribute('onclick');
        let entityToShow = null;

        if (onclick.includes('bharatloan')) entityToShow = 'BharatLoan';
        else if (onclick.includes('rupee112')) entityToShow = 'Rupee112';
        else if (onclick.includes('loan112')) entityToShow = 'Loan112';
        else if (onclick.includes('rupeeontime')) entityToShow = 'RupeeOnTime';

        // Show/hide based on user's entity
        if (userToCheck.entity === 'ALL') {
          entityCard.style.display = ''; // Show all for admin/reviewer
        } else if (userToCheck.entity === entityToShow) {
          entityCard.style.display = ''; // Show only matching entity for agents
        } else {
          entityCard.style.display = 'none'; // Hide non-matching entities
        }
      });
    }

    // Filter QA Checklist card in Resources based on user role
    function filterResourcesQACard() {
      const userToCheck = currentSessionUser || currentUser;
      const agentCard = document.getElementById('qa-checklist-card-agent');
      const otherCard = document.getElementById('qa-checklist-card-other');

      if (!agentCard || !otherCard) return;

      if (userToCheck && userToCheck.role === 'agent') {
        // Show agent-specific QA card
        agentCard.classList.remove('hidden');
        otherCard.classList.add('hidden');
      } else {
        // Show entity checklist QA card for others
        agentCard.classList.add('hidden');
        otherCard.classList.remove('hidden');
      }
    }

    function navigateTo(id) {
      // CHECK ACCESS PERMISSION - Use currentSessionUser for new login system
      const userToCheck = currentSessionUser || currentUser;

      if (userToCheck && userToCheck.entity !== 'ALL') {
        const targetEntity = ENTITY_VIEW_MAP[id];
        if (targetEntity && targetEntity !== userToCheck.entity) {

          // Dynamic check: Update modal text to ensure it matches requirement
          const modalTitle = document.getElementById('access-denied-title');
          if (modalTitle) modalTitle.innerText = 'Please enter the correct ID and can choose the correct entity for this ID';

          // Show Access Denied Modal
          document.getElementById('access-denied-modal').classList.remove('hidden');
          return; // STOP NAVIGATION
        }
      }

      document.querySelectorAll('.app-view').forEach(v => v.classList.remove('active'));
      document.getElementById(id).classList.add('active');
      window.scrollTo({ top: 0, behavior: 'smooth' });
      // Close search after navigation
      document.getElementById('search-bar').classList.add('hidden');
      document.getElementById('search-input').value = '';
      document.getElementById('search-results').innerHTML = '';

      // Filter Resources QA card when navigating to resources
      if (id === 'view-resources') {
        filterResourcesQACard();
      }

      // Load QA Dashboard for agents
      if (id === 'view-agent-qa') {
        agentLoadQADashboard();
      }

      // Check notifications on navigation if agent
      if (currentSessionUser && currentSessionUser.role === 'agent') {
        checkAgentNotifications(false);
      } else if (currentUser && currentUser.role === 'agent') {
        checkAgentNotifications(false);
      }

      // Show notification bell only on homepage
      document.querySelectorAll('.agent-notification-bell').forEach(b => {
        if (id === 'view-home') b.classList.remove('hidden'); else b.classList.add('hidden');
      });
    }

    function toggleFaq(btn) {
      btn.parentElement.classList.toggle('active');
    }

    function showTab(tab, entity = '') {
      const prefix = entity ? '-' + entity : '';
      // Hide all tab contents
      document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));
      // Remove active from all tabs
      const tabSelectors = entity ? `#tab-tools${prefix}` : '#tab-tools';
      document.querySelectorAll(tabSelectors).forEach(btn => {
        btn.classList.remove('text-blue-600', 'border-blue-600');
        btn.classList.add('text-slate-500', 'border-transparent');
      });
      // Show selected tab content
      document.getElementById('content-' + tab + prefix).classList.remove('hidden');
      // Activate selected tab
      document.getElementById('tab-' + tab + prefix).classList.add('text-blue-600', 'border-blue-600');
      document.getElementById('tab-' + tab + prefix).classList.remove('text-slate-500', 'border-transparent');

      // Populate agents list if agents tab is selected
      if (tab === 'agents') {
        populateAgentsList(entity);
      }
    }

    function populateAgentsList(entity) {
      const entityMap = {
        'bharatloan': 'BharatLoan',
        'rupee112': 'Rupee112',
        'loan112': 'Loan112',
        'rupeeontime': 'RupeeOnTime',
        '': 'BharatLoan' // default
      };

      const entityName = entityMap[entity] || 'BharatLoan';
      const containerId = `agents-list-${entity || 'bharatloan'}`;
      const container = document.getElementById(containerId);

      if (!container) return;

      // Filter agents for the current entity
      const agents = USER_DB.filter(u => u.role === 'agent' && u.entity === entityName);

      if (agents.length === 0) {
        container.innerHTML = '<div class="p-4 text-center text-slate-500">No agents found for this entity.</div>';
        return;
      }

      // Create agent list HTML
      container.innerHTML = agents.map(agent => `
        <div class="bg-white dark:bg-slate-700 p-4 rounded-xl border border-slate-200 dark:border-slate-600 hover:shadow-md transition">
          <div class="flex items-center justify-between">
            <div>
              <h4 class="font-bold text-slate-900 dark:text-white text-lg">${agent.name}</h4>
              <p class="text-sm text-slate-600 dark:text-slate-300 font-mono">${agent.id}</p>
            </div>
            <div class="bg-indigo-100 dark:bg-indigo-900 text-indigo-700 dark:text-indigo-200 px-3 py-1 rounded-lg text-sm font-semibold">${agent.entity}</div>
          </div>
        </div>
      `).join('');
    }

    function toggleTheme() {
      const html = document.documentElement;
      const icon = document.getElementById('theme-icon');
      const text = document.getElementById('theme-text');

      if (html.classList.contains('dark')) {
        html.classList.remove('dark');
        icon.innerText = 'üåô';
        text.innerText = 'Dark';
        localStorage.setItem('theme', 'light');
      } else {
        html.classList.add('dark');
        icon.innerText = '‚òÄÔ∏è';
        text.innerText = 'Light';
        localStorage.setItem('theme', 'dark');
      }
    }

    function toggleDropdown(entity) {
      const dropdown = document.getElementById('support-dropdown' + (entity ? '-' + entity : ''));
      dropdown.classList.toggle('hidden');
    }

    function toggleSearch() {
      const bar = document.getElementById('search-bar');
      bar.classList.toggle('hidden');
      if (!bar.classList.contains('hidden')) {
        document.getElementById('search-input').focus();
      } else {
        document.getElementById('search-input').value = '';
        document.getElementById('search-results').innerHTML = '';
      }
    }

    function performSearch(query) {
      const resultsDiv = document.getElementById('search-results');
      if (!query.trim()) {
        resultsDiv.innerHTML = '';
        return;
      }
      const filtered = searchData.filter(item => item.name.toLowerCase().includes(query.toLowerCase()));
      resultsDiv.innerHTML = filtered.map(item => `<div onclick="navigateTo('${item.id}')" class="px-4 py-2 hover:bg-slate-100 dark:hover:bg-slate-700 cursor-pointer">${item.name}</div>`).join('');
    }

    function showLogin(entity) {
      currentEntity = entity;
      document.getElementById('login-title').innerText = `Login to ${entity}`;
      document.getElementById('login-modal').classList.remove('hidden');
      document.getElementById('empid').value = '';
    }

    function handleChecklistClick(entityName) {
      // If user is logged in as admin, set entity and navigate to admin dashboard
      if (currentSessionUser && currentSessionUser.role === 'admin') {
        currentEntity = entityName;
        adminCurrentEntity = entityName;
        navigateTo('view-admin');
        adminLoadAgents();
      } else {
        // For non-logged-in users or non-admins, show login modal
        showLogin(entityName);
      }
    }

    function hideLogin() {
      document.getElementById('login-modal').classList.add('hidden');
      document.getElementById('empid').value = '';
    }

    // USER DATABASE
    const USER_DB = [
      { id: 'BL/GG/25/1135', name: 'Siddhant Chauhan', role: 'admin', entity: 'ALL' },
      { id: 'BL/GG/25/0957', name: 'Ayushi Gupta', role: 'reviewer', entity: 'ALL' },
      { id: 'BL/GG/25/703', name: 'SHARAD ADHIKARI', role: 'agent', entity: 'BharatLoan' },
      { id: 'BL/GG/25/704', name: 'DIVYANSHU SHARMA', role: 'agent', entity: 'BharatLoan' },
      { id: 'BL/GG/25/705', name: 'AYUSHMAN TIBREWAL', role: 'agent', entity: 'BharatLoan' },
      { id: 'BL/GG/25/1189', name: 'Khushi Kumari', role: 'agent', entity: 'BharatLoan' },
      { id: 'BL/GG/25/712', name: 'AKSHAY NAGIA', role: 'agent', entity: 'BharatLoan' },
      { id: 'BL/GG/25/1021', name: 'Chitresh Kumar', role: 'agent', entity: 'BharatLoan' },
      { id: 'BL/GG/25/1022', name: 'Akshat', role: 'agent', entity: 'BharatLoan' },
      { id: 'BL/GG/25/1055', name: 'KAJAL', role: 'agent', entity: 'BharatLoan' },
      { id: 'BL/GG/25/1134', name: 'Isha', role: 'agent', entity: 'BharatLoan' },

      { id: 'BL/GG/25/1240', name: 'KUNDAN KUMAR', role: 'agent', entity: 'BharatLoan' },
      { id: 'BL/GG/25/1338', name: 'MOHIT KUMAR', role: 'agent', entity: 'BharatLoan' },
      { id: 'BL/GG/26/042', name: 'MOHD. KAIF', role: 'agent', entity: 'BharatLoan' },


      // LOAN112 AGENTS
      { id: 'L112/GG/25/021', name: 'RITU YADAV', role: 'agent', entity: 'Loan112' },
      { id: 'L112/GG/25/047', name: 'Hari Kishan', role: 'agent', entity: 'Loan112' },
      { id: 'L112/GG/25/022', name: 'ADITYA SINGH', role: 'agent', entity: 'Loan112' },
      { id: 'L112/GG/25/015', name: 'Kunal Kukreti', role: 'agent', entity: 'Loan112' },
      { id: 'L112/GG/25/086', name: 'Joba', role: 'agent', entity: 'Loan112' },
      { id: 'L112/GG/25/026', name: 'AMAAN KHAN', role: 'agent', entity: 'Loan112' },
      { id: 'L112/GG/25/087', name: 'Ajit', role: 'agent', entity: 'Loan112' },
      { id: 'L112/GG/25/046', name: 'Avinash', role: 'agent', entity: 'Loan112' },

      // RUPEE112 AGENTS
      { id: 'R112/GG/25/710', name: 'Priya Kumari', role: 'agent', entity: 'Rupee112' },
      { id: 'R112/GG/24/410', name: 'CHANDAN PANDAY', role: 'agent', entity: 'Rupee112' },
      { id: 'R112/GG/24/432', name: 'SHEETAL SINGH', role: 'agent', entity: 'Rupee112' },
      { id: 'R112/GG/25/623', name: 'GUNJAN', role: 'agent', entity: 'Rupee112' },
      { id: 'R112/GG/25/707', name: 'Dunna Vishal', role: 'agent', entity: 'Rupee112' },
      { id: 'R112/GG/25/754', name: 'Nishu Yadav', role: 'agent', entity: 'Rupee112' },
      { id: 'R112/GG/25/724', name: 'Aryan', role: 'agent', entity: 'Rupee112' },
      { id: 'R112/GG/25/732', name: 'Ansh Rai', role: 'agent', entity: 'Rupee112' },
      { id: 'RDA/GG/25/006', name: 'Ashish Rawat', role: 'agent', entity: 'Rupee112' },
      { id: 'R112/GG/24/478', name: 'KOMAL', role: 'agent', entity: 'Rupee112' },
      { id: 'R112/GG/25/725', name: 'Kusum sharma', role: 'agent', entity: 'Rupee112' },
      { id: 'RDA/GG/25/038', name: 'Nippi', role: 'agent', entity: 'Loan112' },
      { id: 'R112/GG/23/168', name: 'Ruksar', role: 'agent', entity: 'Rupee112' },
      { id: 'R112/GG/25/692', name: 'NEHA', role: 'agent', entity: 'Rupee112' }
    ];

    function hideLogin() {
      document.getElementById('login-modal').classList.add('hidden');
      document.getElementById('empid').value = '';
    }

    function submitLogin(event) {
      event.preventDefault();
      const empId = document.getElementById('empid').value.trim();

      const user = USER_DB.find(u => u.id === empId);

      if (user) {
        if (user.role === 'admin') {
          // For admin, use the selected entity from the dropdown, fallback to currentEntity
          const selectedEntity = document.getElementById('login-entity')?.value || currentEntity || 'ALL';
          adminCurrentEntity = selectedEntity;

          currentUser = user;

          // Set welcome message with admin name
          document.getElementById('admin-welcome-text').innerText = `Welcome ${user.name}`;

          navigateTo('view-admin');
          adminLoadAgents();
          hideLogin();
        } else if (user.role === 'reviewer') {
          // For reviewer, use the selected entity from the dropdown, fallback to currentEntity
          const selectedEntity = document.getElementById('login-entity')?.value || currentEntity || 'BharatLoan';
          reviewerCurrentEntity = selectedEntity;

          currentUser = user;

          // Set welcome message with reviewer name
          document.getElementById('reviewer-welcome-text').innerText = `Welcome ${user.name}`;

          // Set entity display
          document.getElementById('reviewer-entity-display').textContent = reviewerCurrentEntity;

          navigateTo('view-reviewer');
          reviewerLoadAgentsForEntity();
          hideLogin();
        } else {
          // For agents, check entity match
          if (currentEntity && user.entity !== currentEntity) {
            const modalTitle = document.getElementById('access-denied-title');
            if (modalTitle) modalTitle.innerText = 'Please enter the correct ID and can choose the correct entity for this ID';
            hideLogin();
            document.getElementById('access-denied-modal').classList.remove('hidden');
            return;
          }

          currentUser = user;

          // Update Header Title
          const titleSpan = document.getElementById('agent-dashboard-title');
          if (titleSpan) titleSpan.innerText = `Welcome ${user.name}`;

          // Update Banner Name
          const bannerName = document.getElementById('agent-name-display');
          if (bannerName) bannerName.innerText = user.name;

          navigateTo('view-performance');
          hideLogin();
        }
      } else {
        alert('Invalid Employee ID. Please check your credentials.');
      }
    }

    window.onload = () => {
      const savedTheme = localStorage.getItem('theme');
      if (savedTheme === 'dark') {
        document.documentElement.classList.add('dark');
        document.getElementById('theme-icon').innerText = '‚òÄÔ∏è';
        document.getElementById('theme-text').innerText = 'Light';
      }

      // Initialize portal login system
      initPortal();
    }

    // ===== NEW ADMIN DASHBOARD FUNCTIONS =====
    let adminCurrentEntity = '';
    let adminCurrentAgent = '';
    let adminCurrentAgentName = '';
    let adminReviewItems = [];
    let adminReviewType = ''; // 'voice' or 'non-voice'

    function adminLoadAgents() {
      // Display current entity
      const entityDisplay = document.getElementById('admin-entity-display');
      if (entityDisplay) {
        entityDisplay.textContent = adminCurrentEntity === 'ALL' ? 'All Entities' : adminCurrentEntity;
      }

      // Get the selector dropdown
      const selector = document.getElementById('admin-agent-selector');
      if (!selector) {
        console.error('admin-agent-selector element not found');
        return;
      }

      // Filter agents by entity
      let agents = USER_DB.filter(u => u.role === 'agent');
      if (adminCurrentEntity && adminCurrentEntity !== 'ALL') {
        agents = agents.filter(u => u.entity === adminCurrentEntity);
      }

      // Clear and repopulate dropdown
      selector.innerHTML = '<option value="">-- Click to Select Agent --</option>';

      agents.forEach(agent => {
        const option = document.createElement('option');
        option.value = agent.id;
        option.text = `${agent.name} ${agent.id}`;
        option.dataset.name = agent.name;
        selector.appendChild(option);
      });

      // Load reviews for the current entity
      adminLoadReviewsList();
    }

    function adminSelectAgentFromDropdown(selectElement) {
      const selectedOption = selectElement.options[selectElement.selectedIndex];
      const agentId = selectedOption.value;
      const agentName = selectedOption.dataset.name;

      if (agentId) {
        adminCurrentAgent = agentId;
        adminCurrentAgentName = agentName;
        // Enable the start review button
        document.getElementById('admin-start-review-btn').disabled = false;
        document.getElementById('admin-start-review-btn').classList.remove('opacity-50', 'cursor-not-allowed');
        // Show the submitted reviews section
        document.getElementById('admin-submitted-reviews-section').classList.remove('hidden');
        // Load reviews for this agent
        adminLoadReviewsList();
      } else {
        adminCurrentAgent = '';
        adminCurrentAgentName = '';
        // Disable the start review button
        document.getElementById('admin-start-review-btn').disabled = true;
        document.getElementById('admin-start-review-btn').classList.add('opacity-50', 'cursor-not-allowed');
        // Hide the submitted reviews section
        document.getElementById('admin-submitted-reviews-section').classList.add('hidden');
      }
    }

    function adminSelectAgent(agentId, agentName) {
      adminCurrentAgent = agentId;
      adminCurrentAgentName = agentName;

      // Show the submitted reviews section when agent is selected
      document.getElementById('admin-submitted-reviews-section').classList.remove('hidden');

      // Enable start button
      document.getElementById('admin-start-review-btn').disabled = false;
      document.getElementById('admin-start-review-btn').classList.remove('opacity-50', 'cursor-not-allowed');

      // Refresh reviews list for this agent
      adminLoadReviewsList();
    }

    function adminStartQualityReview() {
      if (!adminCurrentEntity || !adminCurrentAgent) {
        alert('Please select an agent');
        return;
      }

      // Show voice/non-voice selection modal
      document.getElementById('voice-type-modal').classList.remove('hidden');
    }

    function selectVoiceType(type) {
      // type: 'voice' or 'non-voice'
      adminReviewType = type;
      document.getElementById('voice-type-modal').classList.add('hidden');
      
      // Show quality review form
      adminReviewItems = [];
      document.getElementById('admin-quality-form-section').classList.remove('hidden');
      document.getElementById('admin-review-agent-display').textContent = adminCurrentAgentName;
      
      // Show/hide file vs ID input based on type
      const fileSection = document.getElementById('admin-review-file-section');
      const idSection = document.getElementById('admin-review-id-section');
      
      if (type === 'voice') {
        fileSection.classList.remove('hidden');
        idSection.classList.add('hidden');
      } else {
        fileSection.classList.add('hidden');
        idSection.classList.remove('hidden');
      }

      // Add first item
      adminAddReviewItem();
    }

    function adminCancelReview() {
      document.getElementById('admin-quality-form-section').classList.add('hidden');
      adminReviewItems = [];
      document.getElementById('admin-review-items-container').innerHTML = '';
      document.querySelectorAll('.admin-agent-btn').forEach(btn => {
        btn.classList.remove('border-blue-500', 'bg-blue-100', 'dark:bg-slate-500');
      });
      document.getElementById('admin-start-review-btn').disabled = true;
      document.getElementById('admin-start-review-btn').classList.add('opacity-50', 'cursor-not-allowed');
      adminCurrentAgent = '';
    }

    function adminAddReviewItem() {
      if (adminReviewItems.length >= 10) {
        alert('Maximum 10 reviews allowed per agent');
        return;
      }

      const itemIndex = adminReviewItems.length + 1;
      const container = document.getElementById('admin-review-items-container');

      let itemHtml = `
        <div class="admin-review-item bg-white dark:bg-slate-700 p-6 rounded-xl border border-slate-200 dark:border-slate-600">
          <div class="flex items-center justify-between mb-4">
            <h4 class="font-bold text-lg">Review #${itemIndex}</h4>
            ${itemIndex > 1 ? `<button onclick="adminRemoveReviewItem(${itemIndex - 1})" class="text-red-600 hover:text-red-700 text-sm">üóëÔ∏è Remove</button>` : ''}
          </div>
      `;

      // Show file upload only for voice reviews
      if (adminReviewType === 'voice') {
        itemHtml += `
          <!-- File Upload (Voice) -->
          <div class="mb-4">
            <label class="block text-sm font-semibold mb-2">Select File (Max 20MB)</label>
            <input type="file" class="review-file-input block w-full text-sm file:mr-4 file:py-2 file:px-4 file:rounded file:border-0 file:text-sm file:font-semibold file:bg-blue-100 file:text-blue-700"
              data-item-index="${itemIndex - 1}" onchange="adminOnFileSelected(${itemIndex - 1})">
            <p class="text-xs text-slate-500 mt-1">Selected: <span class="review-file-name">None</span></p>
          </div>
        `;
      }

      // Common fields for both voice and non-voice
      itemHtml += `
          <!-- Observation -->
          <div class="mb-4">
            <label class="block text-sm font-semibold mb-2">Observation</label>
            <textarea class="review-observation w-full px-4 py-3 rounded-lg border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-700 focus:ring-2 focus:ring-emerald-500 outline-none" 
              rows="4" placeholder="Enter your observation for this review..." data-item-index="${itemIndex - 1}"></textarea>
          </div>

          <!-- Score -->
          <div class="mb-4">
            <label class="block text-sm font-semibold mb-3">Performance Score</label>
            <div class="flex gap-4">
              <label class="flex items-center gap-2 p-3 bg-emerald-50 dark:bg-slate-600 rounded-lg border border-emerald-200 dark:border-slate-500 cursor-pointer flex-1">
                <input type="radio" name="score-${itemIndex - 1}" value="100" class="review-score" data-item-index="${itemIndex - 1}">
                <div>
                  <div class="font-bold text-emerald-600">100</div>
                  <div class="text-xs text-slate-600 dark:text-slate-300">Good</div>
                </div>
              </label>
              <label class="flex items-center gap-2 p-3 bg-red-50 dark:bg-slate-600 rounded-lg border border-red-200 dark:border-slate-500 cursor-pointer flex-1">
                <input type="radio" name="score-${itemIndex - 1}" value="0" class="review-score" data-item-index="${itemIndex - 1}">
                <div>
                  <div class="font-bold text-red-600">0</div>
                  <div class="text-xs text-slate-600 dark:text-slate-300">Fatal</div>
                </div>
              </label>
            </div>
          </div>
        </div>
      `;

      container.insertAdjacentHTML('beforeend', itemHtml);
      adminReviewItems.push({ file: null, observation: '', score: null, reviewType: adminReviewType });

      // Update button states
      adminUpdateReviewButtons();
    }

    function adminRemoveReviewItem(index) {
      adminReviewItems.splice(index, 1);
      const items = document.querySelectorAll('.admin-review-item');
      if (items[index]) items[index].remove();
      adminUpdateReviewButtons();
    }

    function adminOnFileSelected(index) {
      const fileInput = document.querySelector(`input[data-item-index="${index}"]`);
      const file = fileInput.files[0];

      if (file) {
        if (file.size > 20 * 1024 * 1024) {
          alert('File size exceeds 20MB limit');
          fileInput.value = '';
          return;
        }
        adminReviewItems[index].file = file;
        document.querySelector(`.admin-review-item:nth-child(${index + 1}) .review-file-name`).textContent = file.name;
      }
    }

    function adminUpdateReviewButtons() {
      const count = adminReviewItems.length;
      const addBtn = document.getElementById('admin-add-review-btn');
      const finalBtn = document.getElementById('admin-final-submit-btn');

      // Disable add button if max reached
      addBtn.disabled = count >= 10;
      addBtn.classList.toggle('opacity-50', count >= 10);
      addBtn.classList.toggle('cursor-not-allowed', count >= 10);

      // Enable final submit if min reached
      // Enable final submit always (User Request)
      const allComplete = true;
      finalBtn.disabled = false;
      finalBtn.classList.remove('opacity-50', 'cursor-not-allowed');
    }

    async function adminFinalSubmit() {
      // Collect data from form
      const items = [];
      document.querySelectorAll('.admin-review-item').forEach((item, index) => {
        const observation = item.querySelector('.review-observation').value;
        const score = item.querySelector('.review-score:checked')?.value;
        
        // For voice reviews, file is required. For non-voice, file is not needed.
        const fileInput = item.querySelector('.review-file-input');
        const file = fileInput ? fileInput.files[0] : null;

        items.push({
          file: file,
          observation: observation,
          score: parseInt(score) || null,
          reviewType: adminReviewType
        });
      });

      // Filter out empty items but allow non-voice items without files
      const validItems = items.filter(item => {
        if (adminReviewType === 'voice') {
          return item.file && item.observation && item.score !== null;
        } else {
          // Non-voice: file not required, but observation and score are
          return item.observation && item.score !== null;
        }
      });

      // Validate
      if (validItems.length === 0) {
        alert(`Please complete at least one ${adminReviewType === 'voice' ? 'file upload with' : ''} review item`);
        return;
      }

      const submitBtn = document.getElementById('admin-final-submit-btn');
      submitBtn.innerText = 'Submitting...';
      submitBtn.disabled = true;

      try {
        // Read all files as Data URLs (for voice reviews only)
        const processedItems = await Promise.all(validItems.map(item => {
          return new Promise((resolve, reject) => {
            if (!item.file) {
              // Non-voice review without file
              resolve({ ...item, fileContent: null, fileName: null });
            } else {
              // Voice review with file
              const reader = new FileReader();
              reader.onload = (e) => resolve({ ...item, fileContent: e.target.result, fileName: item.file.name });
              reader.onerror = reject;
              reader.readAsDataURL(item.file);
            }
          });
        }));

        // Save to localStorage
        let reviews = JSON.parse(localStorage.getItem('adminReviews') || '[]');
        const now = new Date();

        processedItems.forEach((item, idx) => {
          const reviewId = Date.now().toString() + '-' + Math.floor(Math.random() * 1000).toString() + '-' + idx;
          reviews.push({
            id: reviewId,
            date: now.toLocaleDateString(),
            agentId: adminCurrentAgent,
            agentName: adminCurrentAgentName,
            entity: adminCurrentEntity,
            reviewType: item.reviewType,
            fileName: item.fileName,
            fileContent: item.fileContent,
            score: item.score,
            observation: item.observation,
            expiryDate: new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000).toLocaleDateString()
          });
        });

        localStorage.setItem('adminReviews', JSON.stringify(reviews));

        // Add feedback to agent in gojira_comments
        let comments = JSON.parse(localStorage.getItem('gojira_comments') || '[]');
        const feedbackText = processedItems
          .filter(item => item.observation)
          .map((item, idx) => `Review ${idx + 1}: ${item.observation}`)
          .join('\n');

        if (feedbackText.trim()) {
          comments.unshift({
            id: Date.now(),
            text: feedbackText,
            agentId: adminCurrentAgent,
            date: new Date().toLocaleString()
          });
          localStorage.setItem('gojira_comments', JSON.stringify(comments));
        }

        alert('Quality reviews submitted successfully!');
        adminCancelReview();
        // Show the submitted reviews section and reload the list
        document.getElementById('admin-submitted-reviews-section').classList.remove('hidden');
        adminLoadReviewsList();
      } catch (error) {
        console.error("Error submitting reviews:", error);
        alert("Failed to submit reviews. Please try again.");
      } finally {
        submitBtn.innerText = '‚úÖ Final Submit';
        submitBtn.disabled = false;
      }
    }

    function adminLoadReviewsList() {
      let reviews = JSON.parse(localStorage.getItem('adminReviews') || '[]');
      const tbody = document.getElementById('admin-reviews-list');

      // Remove expired reviews
      const now = new Date();
      let filtered = reviews.filter(r => new Date(r.expiryDate) >= now);
      localStorage.setItem('adminReviews', JSON.stringify(filtered));

      // Filter by current entity (admin can only see reviews for their logged-in entity)
      if (adminCurrentEntity && adminCurrentEntity !== 'ALL') {
        filtered = filtered.filter(r => r.entity === adminCurrentEntity);
      }

      // IMPORTANT: Only show reviews for the SELECTED agent
      if (adminCurrentAgent) {
        filtered = filtered.filter(r => r.agentId === adminCurrentAgent);
      } else {
        // If no agent is selected, show no reviews
        filtered = [];
      }

      if (filtered.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="p-6 text-center text-slate-400">No submitted reviews for this agent yet.</td></tr>';
        return;
      }

      tbody.innerHTML = filtered.map((review, idx) => `
        <tr class="hover:bg-slate-50 dark:hover:bg-slate-700/50">
          <td class="p-6">${review.date}</td>
          <td class="p-6">${review.agentName}</td>
          <td class="p-6 text-sm text-blue-600 underline cursor-pointer" onclick="openFileContent('${review.fileContent}', '${review.fileName}')">${review.fileName}</td>
          <td class="p-6"><span class="font-bold ${review.score === 100 ? 'text-emerald-600' : 'text-red-600'}">${review.score}</span></td>
          <td class="p-6 text-sm">${review.observation.substring(0, 50)}...</td>
          <td class="p-6 text-right space-x-2">
            <button onclick="adminViewReview(${idx})" class="text-blue-600 hover:text-blue-700">üëÅÔ∏è View</button>
            <button onclick="adminDeleteReview(${idx})" class="text-red-600 hover:text-red-700">üóëÔ∏è Delete</button>
          </td>
        </tr>
      `).join('');
    }

    function openFileContent(content, name) {
      if (!content) return alert('File content not found.');
      // Open in new window
      const win = window.open();
      if (win) {
        win.document.write(`<iframe src="${content}" frameborder="0" style="border:0; top:0px; left:0px; bottom:0px; right:0px; width:100%; height:100%;" allowfullscreen></iframe>`);
        win.document.title = name;
      } else {
        alert('Please allow popups to view the file.');
      }
    }

    function adminViewReview(index) {
      const reviews = JSON.parse(localStorage.getItem('adminReviews') || '[]');
      const review = reviews[index];

      const choice = confirm(`File: ${review.fileName}\nAgent: ${review.agentName}\nScore: ${review.score}\nObservation: ${review.observation}\n\nClick OK to open the file.`);
      if (choice && review.fileContent) {
        openFileContent(review.fileContent, review.fileName);
      }
    }

    let currentEditIndex = -1;

    function adminEditReview(index) {
      currentEditIndex = index;
      const reviews = JSON.parse(localStorage.getItem('adminReviews') || '[]');
      const review = reviews[index];

      // Populate Modal
      document.getElementById('edit-observation').value = review.observation;
      document.getElementById('edit-current-filename').innerText = review.fileName || 'None';

      // Set Radio
      const radios = document.getElementsByName('edit-score');
      radios.forEach(r => {
        // Reset first
        r.checked = false;
        if (parseInt(r.value) === review.score) r.checked = true;
      });

      // Clear file input
      document.getElementById('edit-file-upload').value = '';

      // Show Modal
      document.getElementById('admin-edit-review-modal').classList.remove('hidden');
    }

    async function adminSaveEdit() {
      if (currentEditIndex === -1) return;

      const reviews = JSON.parse(localStorage.getItem('adminReviews') || '[]');
      const review = reviews[currentEditIndex];

      // Get Values
      const obs = document.getElementById('edit-observation').value;
      const scoreEl = document.querySelector('input[name="edit-score"]:checked');
      if (!scoreEl) return alert('Please select a score');
      const score = parseInt(scoreEl.value);

      // Handle File
      const fileInput = document.getElementById('edit-file-upload');

      const saveBtn = document.getElementById('btn-save-edit');
      saveBtn.innerText = 'Saving...';
      saveBtn.disabled = true;

      try {
        if (fileInput.files.length > 0) {
          const file = fileInput.files[0];
          const content = await new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = (e) => resolve(e.target.result);
            reader.onerror = reject;
            reader.readAsDataURL(file);
          });
          review.fileName = file.name;
          review.fileContent = content; // Update content
        }

        review.observation = obs;
        review.score = score;

        // Save
        reviews[currentEditIndex] = review;
        localStorage.setItem('adminReviews', JSON.stringify(reviews));

        // Refresh & Close
        adminLoadReviewsList();
        document.getElementById('admin-edit-review-modal').classList.add('hidden');
        alert('Review updated successfully!');
      } catch (err) {
        console.error(err);
        alert('Error saving edit');
      } finally {
        saveBtn.innerText = 'Save Changes';
        saveBtn.disabled = false;
      }
    }

    function adminDeleteReview(index) {
      if (confirm('Delete this review?')) {
        let reviews = JSON.parse(localStorage.getItem('adminReviews') || '[]');
        reviews.splice(index, 1);
        localStorage.setItem('adminReviews', JSON.stringify(reviews));
        adminLoadReviewsList();
      }
    }

    function adminDeleteAllReviews() {
      if (confirm('Delete all reviews for this entity? This action cannot be undone.')) {
        let reviews = JSON.parse(localStorage.getItem('adminReviews') || '[]');

        // Remove only reviews for the current entity
        reviews = reviews.filter(r => r.entity !== adminCurrentEntity);

        localStorage.setItem('adminReviews', JSON.stringify(reviews));
        adminLoadReviewsList();
        alert('All reviews for this entity have been deleted.');
      }
    }

    function adminDeleteAllReports() {
      if (confirm('Delete all reports? This action cannot be undone.')) {
        MockBackend.clearAllReports();
        renderAdminDashboard();
        alert('All reports have been deleted.');
      }
    }

    function adminDeleteAllFeedback() {
      if (confirm('Delete all feedback? This action cannot be undone.')) {
        localStorage.removeItem('agentComments');
        adminLoadFeedbackList();
      }
    }

    function adminLoadFeedbackList() {
      const comments = JSON.parse(localStorage.getItem('agentComments') || '[]');
      const tbody = document.getElementById('admin-feedback-list');

      // Remove old feedback (older than 7 days)
      const now = new Date();
      const filtered = comments.filter(c => {
        const commentDate = new Date(c.date);
        const diffTime = now - commentDate;
        const diffDays = diffTime / (1000 * 60 * 60 * 24);
        return diffDays < 7;
      });
      localStorage.setItem('agentComments', JSON.stringify(filtered));

      tbody.innerHTML = filtered.map((comment, idx) => `
        <tr>
          <td class="p-6">${comment.date}</td>
          <td class="p-6">${comment.agentName}</td>
          <td class="p-6">${comment.comment}</td>
          <td class="p-6 text-right">
            <button onclick="adminDeleteFeedback(${idx})" class="text-red-600 hover:text-red-700">üóëÔ∏è Delete</button>
          </td>
        </tr>
      `).join('');
    }

    function adminDeleteFeedback(index) {
      let comments = JSON.parse(localStorage.getItem('agentComments') || '[]');
      comments.splice(index, 1);
      localStorage.setItem('agentComments', JSON.stringify(comments));
      adminLoadFeedbackList();
    }

    // ===== NEW AGENT DASHBOARD FUNCTIONS =====
    function openAgentPerformanceModal() {
      const modal = document.getElementById('agent-performance-modal');
      const agentId = currentUser.id;

      document.getElementById('modal-agent-id').textContent = `ID: ${agentId}`;

      // Load reviews for this agent
      const reviews = JSON.parse(localStorage.getItem('adminReviews') || '[]');
      const agentReviews = reviews.filter(r => r.agentId === agentId);

      if (agentReviews.length === 0) {
        document.getElementById('perf-content-loaded').classList.add('hidden');
        document.getElementById('perf-content-empty').classList.remove('hidden');
        modal.classList.remove('hidden');
        return;
      }

      // Calculate stats
      const totalAudits = agentReviews.length;
      const fatalCount = agentReviews.filter(r => r.score === 0).length;
      const goodCount = agentReviews.filter(r => r.score === 100).length;
      const totalScore = (goodCount * 100) / totalAudits;

      // Display stats
      document.getElementById('modal-audit-count').textContent = totalAudits;
      document.getElementById('modal-fatal-count').textContent = fatalCount;
      document.getElementById('modal-good-count').textContent = goodCount;
      document.getElementById('modal-total-score').textContent = totalScore.toFixed(0);

      // Display reviews
      const reviewsList = document.getElementById('modal-reviews-list');
      reviewsList.innerHTML = agentReviews.map((review, idx) => `
        <div class="bg-slate-50 dark:bg-slate-700 p-4 rounded-lg border border-slate-200 dark:border-slate-600">
          <div class="flex justify-between items-start mb-2">
            <div>
              <p class="font-bold text-sm">Review #${idx + 1}</p>
              <p class="text-xs text-slate-500">${review.date}</p>
            </div>
            <span class="font-bold ${review.score === 100 ? 'text-emerald-600 text-lg' : 'text-red-600 text-lg'}">Score: ${review.score}</span>
          </div>
          <p class="text-sm mb-2"><strong>File:</strong> ${review.fileName}</p>
          <p class="text-sm mb-2"><strong>Observation:</strong> ${review.observation}</p>
          <button onclick="agentViewReviewDetail(${idx})" class="text-blue-600 hover:text-blue-700 text-sm">üëÅÔ∏è View Details</button>
        </div>
      `).join('');

      document.getElementById('perf-content-loaded').classList.remove('hidden');
      document.getElementById('perf-content-empty').classList.add('hidden');
      modal.classList.remove('hidden');
    }

    function agentViewReviewDetail(index) {
      const reviews = JSON.parse(localStorage.getItem('adminReviews') || '[]');
      const agentId = currentUser.id;
      const agentReviews = reviews.filter(r => r.agentId === agentId);
      const review = agentReviews[index];

      const choice = confirm(`üìã Review Detail\n\nFile: ${review.fileName}\nScore: ${review.score}\nObservation:\n${review.observation}\n\nClick OK to OPEN THE FILE.`);
      if (choice && review.fileContent) {
        openFileContent(review.fileContent, review.fileName);
      }
    }

    function agentSubmitComment() {
      const textarea = document.getElementById('agent-comment-input');
      const comment = textarea.value.trim();

      if (!comment) {
        alert('Please enter a comment');
        return;
      }

      let comments = JSON.parse(localStorage.getItem('agentComments') || '[]');
      comments.push({
        date: new Date().toLocaleDateString(),
        agentId: currentUser.id,
        agentName: currentUser.name,
        comment: comment
      });

      localStorage.setItem('agentComments', JSON.stringify(comments));
      textarea.value = '';
      alert('Your feedback has been sent to admin!');
    }

    function closeAgentPerformanceModal() {
      document.getElementById('agent-performance-modal').classList.add('hidden');
      document.getElementById('agent-comment-input').value = '';
    }

    // Load reviews on page load
    window.addEventListener('load', function () {
      adminLoadReviewsList();
      adminLoadFeedbackList();
    });
  </script>

</body>

</html>
