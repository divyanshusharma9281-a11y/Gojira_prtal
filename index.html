<!DOCTYPE html>
<html lang="en" class="light">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gojira TP | Training Portal</title>
  <!-- APP_VERSION: 20260130-001 -->

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = { darkMode: 'class' }
  </script>

  <!-- Fonts -->
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Montserrat:wght@700&display=swap"
    rel="stylesheet">

  <style>
    body {
      font-family: 'Inter', sans-serif;
    }

    .app-view {
      display: none;
      min-height: 100vh;
    }

    .app-view.active {
      display: block;
    }

    .hover-lift:hover {
      transform: translateY(-8px);
      box-shadow: 0 20px 30px -10px rgba(0, 0, 0, .15);
    }

    .faq-answer {
      max-height: 0;
      overflow: hidden;
      opacity: 0;
      transition: all 0.4s ease;
    }

    .faq-item.active .faq-answer {
      max-height: 1200px;
      opacity: 1;
      padding-top: 0.75rem;
    }

    .tab-content {
      display: block;
    }

    .hidden {
      display: none;
    }

    .stylish {
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
    }

    .glow {
      box-shadow: 0 0 20px rgba(59, 130, 246, 0.5);
    }

    .animate-fade-in {
      animation: fadeIn 0.5s ease-in-out;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes zoomIn {
      from {
        opacity: 0;
        transform: translateY(20px) scale(0.7);
      }

      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    /* Door brand descent animation: keeps same size but moves down behind the login card */
    @keyframes doorBrandDescend {
      0% {
        transform: translateY(0) scale(1) rotate(-8deg);
        opacity: 1;
      }

      60% {
        transform: translateY(7rem) scale(0.96) rotate(-8deg);
        opacity: 0.6;
      }

      100% {
        transform: translateY(14rem) scale(0.85) rotate(-8deg);
        opacity: 0.18;
      }
    }

    /* Login card stacking helper */
    .login-card { z-index: 30; }
    .login-card.raised { z-index: 70 !important; }

    /* 3D Swing Animations */
    @keyframes swingLeft {
      from {
        transform: rotateY(0deg);
      }

      to {
        transform: rotateY(95deg);
        opacity: 0;
      }
    }

    @keyframes swingRight {
      from {
        transform: rotateY(0deg);
      }

      to {
        transform: rotateY(-95deg);
        opacity: 0;
      }
    }

    .animate-zoom-in {
      animation: zoomIn 2.8s cubic-bezier(0.2, 0.8, 0.2, 1) 0.6s forwards;
      /* Slightly longer, slower zoom out */
      opacity: 0;
    }

    /* Apply door-brand descent to the big heading so it moves when doors swing */
    #door-brand .door-brand {
      transform-origin: center;
      will-change: transform, opacity;
      transform: translateY(0) rotate(0deg);
    }

    /* Class to start the descent animation on demand */
    .door-descend {
      animation: doorBrandDescend 1.8s cubic-bezier(0.25, 0.46, 0.45, 0.94) 0.5s forwards;
    }

    #door-brand.moved {
      z-index: 0 !important;
      opacity: 0.18 !important;
      pointer-events: none;
      transform: translateY(14rem) scale(0.85) rotate(0deg);
    }

    .animate-door-left {
      transform-origin: left;
      animation: swingLeft 1.8s cubic-bezier(0.25, 0.46, 0.45, 0.94) 0.5s forwards;
    }

    .animate-door-right {
      transform-origin: right;
      animation: swingRight 1.8s cubic-bezier(0.25, 0.46, 0.45, 0.94) 0.5s forwards;
    }

    /* Gojira Theme Variables and Styles */
    :root {
      --gojira-red: #b91c1c; /* deep red */
      --gojira-blue: #0f172a; /* dark blue */
      --gojira-grad: linear-gradient(90deg, #b91c1c, #1e40af);
    }

    /* Theme applied after login to make pages colorful */
    .gojira-theme header {
      background: var(--gojira-grad) !important;
      color: #fff !important;
      border: none !important;
    }

    .gojira-theme .app-view {
      background: linear-gradient(180deg, rgba(185,28,28,0.02), rgba(14,42,90,0.02));
    }

    .gojira-theme .card,
    .gojira-theme .panel {
      border-radius: 12px;
      box-shadow: 0 8px 30px rgba(14, 40, 90, 0.06);
      border: 1px solid rgba(255,255,255,0.03);
    }

    .gojira-theme .accent-btn {
      background: var(--gojira-grad); color: white; border: none;
      box-shadow: 0 10px 30px rgba(30,58,138,0.12);
    }

    /* Door branding */
    .door-brand {
      font-family: 'Montserrat', sans-serif;
      text-shadow: 4px 5px 10px rgba(0,0,0,0.45);
      letter-spacing: -2px;
    }

    /* Login label styling */
    .login-label { color: var(--gojira-red); font-weight: 700; }
  </style>
</head>

<body class="bg-slate-50 text-slate-900 dark:bg-slate-900 dark:text-slate-100 transition-colors duration-300">

  <!-- Update Available Banner (hidden by default) -->
  <div id="update-banner"
    class="hidden fixed top-4 left-1/2 transform -translate-x-1/2 z-50 w-full max-w-3xl mx-auto px-4">
    <div
      class="bg-yellow-50 border-l-4 border-yellow-400 text-yellow-900 p-4 rounded-lg shadow-md flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="text-lg">üîî</div>
        <div>
          <div class="font-bold">New version available</div>
          <div class="text-sm text-yellow-800">A new version of the portal is available. Refresh to get the latest
            updates.</div>
        </div>
      </div>
      <div class="flex items-center gap-3">
        <button id="update-reload-btn" class="bg-yellow-600 text-white px-4 py-2 rounded-md font-semibold">Reload
          Now</button>
        <button id="update-dismiss-btn" class="text-sm text-yellow-800 underline">Dismiss</button>
      </div>
    </div>
  </div>

  <!-- MAIN PORTAL LOGIN SCREEN -->
  <div id="portal-login-screen" class="fixed inset-0 bg-slate-900 flex items-center justify-center z-50 overflow-hidden"
    style="perspective: 1500px;">

    <!-- The Split Doors (3D Swing) -->
    <div
      class="fixed inset-y-0 left-0 w-1/2 z-50 animate-door-left flex items-center justify-end border-r border-transparent shadow-2xl"
      style="background: linear-gradient(90deg, #7f1d1d 0%, #0b1220 50%, #1e3a8a 100%);">
    </div>
    <div
      class="fixed inset-y-0 right-0 w-1/2 z-50 animate-door-right flex items-center justify-start border-l border-transparent shadow-2xl"
      style="background: linear-gradient(270deg, #7f1d1d 0%, #0b1220 50%, #1e3a8a 100%);">
    </div>

    <!-- Revealed Background -->
    <div class="absolute inset-0 z-0" style="background: linear-gradient(135deg, #7f1d1d 0%, #0b1220 50%, #1e3a8a 100%);"></div>

    <!-- Background Typography Theme (Door Branding) -->
    <div id="door-brand" class="absolute inset-0 flex items-center justify-center pointer-events-none select-none z-10">
      <h1
        class="door-brand text-[18rem] font-montserrat font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-red-500 to-blue-500 whitespace-nowrap drop-shadow-lg"
        style="pointer-events: none; will-change: transform, opacity; transform: translateY(0) rotate(0deg);">
        G - Gojira</h1>
    </div>

    <!-- Colored Login Card -->
    <div id="login-card"
      class="p-12 rounded-3xl shadow-2xl max-w-md w-full mx-4 relative z-60 login-card overflow-hidden border border-indigo-500/30 animate-zoom-in shadow-indigo-500/20"
      style="background-color: rgba(10, 14, 22, 0.97);">
      <div class="text-center mb-8">
        <div
          class="w-20 h-20 bg-gradient-to-br from-red-600 to-blue-600 rounded-full flex items-center justify-center text-white font-black text-4xl mx-auto mb-4 shadow-lg shadow-blue-900/50">
          G</div>
        <h1
          class="text-4xl font-black text-transparent bg-clip-text bg-gradient-to-r from-red-600 to-blue-600 drop-shadow-sm">
          Gojira TP</h1>
        <p class="text-slate-500 dark:text-slate-400 text-sm mt-3 font-semibold tracking-wide uppercase">Training Portal
          Login</p>
      </div>

      <form onsubmit="submitLogin(event)">
        <div class="mb-6">
          <label class="block text-sm font-semibold mb-2 login-label">Employee ID</label>
          <input id="portal-emp-id" type="text" required placeholder="Enter your Employee ID"
            class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-lg bg-slate-50 dark:bg-slate-700 focus:border-indigo-600 focus:ring-2 focus:ring-indigo-200 outline-none transition">
        </div>"

        <div class="mb-6">
          <label class="block text-sm font-semibold mb-2 login-label">Password</label>
          <input id="portal-password" type="password" required placeholder="Enter your password"
            class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-lg bg-slate-50 dark:bg-slate-700 focus:border-indigo-600 focus:ring-2 focus:ring-indigo-200 outline-none transition">
        </div>

        <button type="submit"
          class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 transition mb-4">Login</button>
      </form>

      <div class="text-center">
        <button onclick="showChangePasswordModal()"
          class="text-indigo-600 hover:text-indigo-700 text-sm font-semibold underline">Change Password</button>
      </div>
    </div>
  </div>

  <!-- CHANGE PASSWORD MODAL -->
  <div id="change-password-modal"
    class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <!-- ... content kept as is ... -->
    <div class="bg-white dark:bg-slate-800 p-8 rounded-3xl shadow-lg max-w-md w-full mx-4">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold">Change Password</h2>
        <button onclick="hideChangePasswordModal()"
          class="text-slate-500 hover:text-slate-700 text-2xl">&times;</button>
      </div>

      <form onsubmit="submitChangePassword(event)">
        <div class="mb-6">
          <label class="block text-sm font-semibold mb-2">Employee ID</label>
          <input id="change-pass-emp-id" type="text" required placeholder="Enter your Employee ID"
            class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-lg bg-slate-50 dark:bg-slate-700 focus:border-indigo-600 outline-none transition">
        </div>

        <div class="mb-6">
          <label class="block text-sm font-semibold mb-2">Current Password</label>
          <input id="change-pass-current" type="password" required placeholder="Enter current password"
            class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-lg bg-slate-50 dark:bg-slate-700 focus:border-indigo-600 outline-none transition">
        </div>

        <div class="mb-6">
          <label class="block text-sm font-semibold mb-2">New Password</label>
          <input id="change-pass-new" type="password" required placeholder="Enter new password"
            class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-lg bg-slate-50 dark:bg-slate-700 focus:border-indigo-600 outline-none transition">
        </div>

        <button type="submit"
          class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 transition">Update
          Password</button>
      </form>
    </div>
  </div>

  <!-- ADMIN REVIEW TYPE MODAL (NEW) -->
  <div id="admin-review-type-modal"
    class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-[60] p-4">
    <div
      class="bg-white dark:bg-slate-800 rounded-3xl shadow-2xl max-w-md w-full p-8 transform transition-all scale-100">
      <div class="text-center mb-8">
        <div
          class="w-16 h-16 bg-blue-100 dark:bg-blue-900 rounded-full flex items-center justify-center mx-auto mb-4 text-3xl">
          üéØ</div>
        <h2 class="text-2xl font-bold mb-2">Select Review Type</h2>
        <p class="text-slate-600 dark:text-slate-400">Choose the type of interaction you want to review for <span
            id="review-type-agent-name" class="font-bold text-blue-600">Agent</span>.</p>
      </div>

      <div class="grid grid-cols-2 gap-4 mb-6">
        <button onclick="adminSelectReviewType('voice')"
          class="p-6 rounded-2xl border-2 border-slate-200 dark:border-slate-700 hover:border-blue-500 hover:bg-blue-50 dark:hover:bg-slate-700 transition group text-center">
          <div class="text-4xl mb-3 group-hover:scale-110 transition-transform">üéôÔ∏è</div>
          <div class="font-bold text-slate-800 dark:text-white">Voice</div>
          <p class="text-xs text-slate-500 mt-1">Upload Call Recording</p>
        </button>

        <button onclick="adminSelectReviewType('non-voice')"
          class="p-6 rounded-2xl border-2 border-slate-200 dark:border-slate-700 hover:border-purple-500 hover:bg-purple-50 dark:hover:bg-slate-700 transition group text-center">
          <div class="text-4xl mb-3 group-hover:scale-110 transition-transform">üí¨</div>
          <div class="font-bold text-slate-800 dark:text-white">Non-Voice</div>
          <p class="text-xs text-slate-500 mt-1">Chat / Email ID</p>
        </button>
      </div>

      <div class="text-center">
        <button onclick="document.getElementById('admin-review-type-modal').classList.add('hidden')"
          class="text-slate-400 hover:text-slate-600 font-semibold text-sm">Cancel</button>
      </div>
    </div>
  </div>

  <!-- NOTIFICATIONS MODAL -->
  <div id="notifications-modal"
    class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"
    onclick="if(event.target.id === 'notifications-modal') closeNotificationsModal()">
    <div class="bg-white dark:bg-slate-800 rounded-3xl shadow-2xl max-w-2xl w-full max-h-[80vh] overflow-y-auto"
      onclick="event.stopPropagation()">
      <div
        class="sticky top-0 bg-white dark:bg-slate-800 p-6 border-b border-slate-200 dark:border-slate-700 flex justify-between items-center">
        <h2 class="text-2xl font-bold">Notifications</h2>
        <button onclick="closeNotificationsModal()" class="text-slate-500 hover:text-slate-700 text-2xl">‚úï</button>
      </div>

      <div id="notifications-list" class="p-6 space-y-3">
        <!-- Notifications populated here -->
      </div>

      <div id="notifications-empty" class="text-center py-12 p-6">
        <div class="text-4xl mb-4">‚ú®</div>
        <h4 class="text-xl font-bold text-slate-600 dark:text-slate-400">All Caught Up!</h4>
        <p class="text-slate-500 dark:text-slate-500 mt-2">No new notifications at the moment.</p>
      </div>
    </div>
  </div>

  <!-- TOP NAV (hidden initially) -->
  <nav id="top-nav"
    class="hidden bg-white dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700 sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-6 py-3 flex items-start justify-between">
      <div onclick="navigateTo('view-home')" class="flex gap-3 cursor-pointer group">
        <div
          class="w-12 h-12 bg-slate-900 dark:bg-slate-700 rounded flex items-center justify-center text-white font-bold group-hover:bg-blue-600 transition glow">
          G</div>
        <div class="flex flex-col">
          <span
            class="font-['Montserrat'] text-3xl text-transparent bg-clip-text bg-gradient-to-r from-blue-500 via-purple-500 to-indigo-600 stylish leading-none">
            Gojira TP
          </span>
        </div>
      </div>

      <div class="flex flex-col items-end gap-2">
        <div class="flex items-center gap-2">
          <button onclick="toggleSearch()" class="text-slate-500 hover:text-blue-600 text-xl">üîç</button>
          <button onclick="toggleTheme()"
            class="flex items-center gap-2 px-4 py-2 rounded-full bg-slate-100 dark:bg-slate-700 text-sm font-semibold transition">
            <span id="theme-icon">üåô</span>
            <span id="theme-text">Dark</span>
          </button>

          <!-- Unified Notification Bell -->
          <div
            class="relative cursor-pointer hover:bg-slate-100 dark:hover:bg-slate-700 p-2 rounded-full transition notification-bell"
            onclick="checkNotifications(true)" title="Check Notifications">
            <span class="text-xl">üîî</span>
            <span
              class="notification-dot hidden absolute top-0 right-0 w-3 h-3 bg-red-500 rounded-full border-2 border-white dark:border-slate-800"></span>
          </div>

          <button onclick="portalLogout()"
            class="flex items-center gap-2 px-4 py-2 rounded-full bg-red-100 dark:bg-red-900 text-red-600 dark:text-red-300 text-sm font-semibold hover:bg-red-200 dark:hover:bg-red-800 transition">
            üö™ Logout
          </button>
        </div>

        <div id="search-bar" class="hidden">
          <input id="search-input" type="text" oninput="performSearch(this.value)" placeholder="Search portal..."
            class="px-4 py-2 rounded-full bg-slate-100 dark:bg-slate-700 text-sm w-64">
          <div id="search-results"
            class="mt-2 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg shadow-lg max-h-60 overflow-y-auto">
          </div>
        </div>
      </div>
    </div>
  </nav>

  <!-- HOME -->
  <div id="view-home" class="app-view active">
    <main class="max-w-7xl mx-auto px-6 py-20 text-center">
      <p id="home-user-greeting" class="text-3xl font-bold text-blue-600 dark:text-blue-400 mb-4">Hi Guest</p>

      <h1 class="text-5xl font-extrabold mb-12">
        Welcome to
        <span class="text-transparent bg-clip-text bg-gradient-to-r from-blue-600 to-indigo-600">
          Training & Quality Portal
        </span>
      </h1>

      <div class="grid grid-cols-1 md:grid-cols-4 gap-8" style="pointer-events: auto;">
        <div onclick="navigateTo('view-kb')"
          class="p-10 rounded-[2.5rem] cursor-pointer hover-lift bg-blue-600 text-white" style="pointer-events: auto;">
          <div class="w-16 h-16 bg-white/20 rounded-2xl mx-auto mb-6 flex items-center justify-center text-3xl">üìò</div>
          <h2 class="text-2xl font-bold mb-2">Knowledge Base</h2>
          <p class="text-sm opacity-90">Crucial FAQs and operational guidelines.</p>
        </div>

        <div onclick="navigateTo('view-entities')"
          class="p-10 rounded-[2.5rem] cursor-pointer hover-lift bg-indigo-600 text-white"
          style="pointer-events: auto;">
          <div class="w-16 h-16 bg-white/20 rounded-2xl mx-auto mb-6 flex items-center justify-center text-3xl">üè¶</div>
          <h2 class="text-2xl font-bold mb-2">Brand Entities</h2>
        </div>

        <div onclick="navigateTo('view-updates')"
          class="p-10 rounded-[2.5rem] cursor-pointer hover-lift bg-amber-500 text-white" style="pointer-events: auto;">
          <div class="w-16 h-16 bg-white/20 rounded-2xl mx-auto mb-6 flex items-center justify-center text-3xl">üì¢</div>
          <h2 class="text-2xl font-bold mb-2">New Updates</h2>
          <p class="text-sm opacity-90">Latest system & policy logs.</p>
        </div>

        <div onclick="navigateTo('view-resources')"
          class="p-10 rounded-[2.5rem] cursor-pointer hover-lift bg-purple-600 text-white"
          style="pointer-events: auto;">
          <div class="w-16 h-16 bg-white/20 rounded-2xl mx-auto mb-6 flex items-center justify-center text-3xl">üìÅ</div>
          <h2 class="text-2xl font-bold mb-2">Resources</h2>
          <p class="text-sm opacity-90">Guidelines and quality checkup</p>
        </div>
      </div>
    </main>
  </div>

  <!-- KNOWLEDGE BASE -->
  <div id="view-kb" class="app-view bg-white dark:bg-slate-900">
    <header
      class="h-16 flex items-center px-6 border-b border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800">
      <button onclick="navigateTo('view-home')" class="font-bold text-slate-500 hover:text-blue-600">‚Üê Home</button>
      <span class="mx-auto font-bold">Knowledge Base</span>
    </header>
    <div class="max-w-4xl mx-auto px-6 py-14">
      <h1 class="text-4xl font-extrabold mb-10">Frequently Asked Questions</h1>
      <div class="space-y-4">
        <!-- 1 -->
        <div class="faq-item border-b pb-4">
          <button onclick="toggleFaq(this)" class="w-full text-left font-bold text-lg">1. My loan is approved but not
            disbursed. Why?</button>
          <div class="faq-answer text-slate-600 dark:text-slate-300">
            <p class="mb-2">Loan disbursement may be pending due to:</p>
            <ul class="list-disc ml-6 space-y-1">
              <li>Incomplete documentation</li>
              <li>Bank account verification</li>
              <li>Internal compliance or risk checks</li>
            </ul>
            <p class="mt-2 font-medium">Our team will assist you with the exact reason.</p>
          </div>
        </div>

        <!-- 2 -->
        <div class="faq-item border-b pb-4">
          <button onclick="toggleFaq(this)" class="w-full text-left font-bold text-lg">2. Can I increase my loan amount
            after sanction?</button>
          <div class="faq-answer text-slate-600 dark:text-slate-300">
            <p class="mb-2">Loan enhancement depends on below mentioned criteria but can be done while accepting the
              offer not post sanction:</p>
            <ul class="list-disc ml-6 space-y-1">
              <li>Your credit profile</li>
              <li>Repayment history</li>
              <li>Internal eligibility checks</li>
            </ul>
            <p class="mt-2">You may reapply after closing or maintaining a good repayment track.</p>
          </div>
        </div>

        <!-- 3 -->
        <div class="faq-item border-b pb-4">
          <button onclick="toggleFaq(this)" class="w-full text-left font-bold text-lg">3. Why was my loan application
            rejected?</button>
          <div class="faq-answer text-slate-600 dark:text-slate-300">
            <p class="mb-2">Loan applications can be rejected due to:</p>
            <ul class="list-disc ml-6 space-y-1">
              <li>Credit score or repayment history</li>
              <li>Existing liabilities</li>
              <li>Internal risk assessment</li>
            </ul>
            <p class="mt-2">Customer care can guide but cannot override system decisions.</p>
          </div>
        </div>

        <!-- 4 -->
        <div class="faq-item border-b pb-4">
          <button onclick="toggleFaq(this)" class="w-full text-left font-bold text-lg">4. How long does it take for
            repayment to reflect after payment?</button>
          <div class="faq-answer text-slate-600 dark:text-slate-300">
            <p>Payments usually reflect within 24‚Äì48 working hours. Delays may occur due to bank processing or holidays.
            </p>
          </div>
        </div>

        <!-- 5 -->
        <div class="faq-item border-b pb-4">
          <button onclick="toggleFaq(this)" class="w-full text-left font-bold text-lg">5. How is my total payable amount
            calculated?</button>
          <div class="faq-answer text-slate-600 dark:text-slate-300">
            <p class="mb-2">Your payable amount includes:</p>
            <ul class="list-disc ml-6 space-y-1">
              <li>Loan Amount</li>
              <li>Interest calculated till the repayment date</li>
              <li>Penalty (2% post repayment date where 1% is daily interest and 1% is penalty)</li>
            </ul>
          </div>
        </div>

        <!-- 6 -->
        <div class="faq-item border-b pb-4">
          <button onclick="toggleFaq(this)" class="w-full text-left font-bold text-lg">6. Will my credit score be
            affected if I delay payment?</button>
          <div class="faq-answer text-slate-600 dark:text-slate-300">
            <p>Yes. Any delay in repayment may negatively impact your CIBIL score, which can affect future loan or
              credit card approvals.</p>
          </div>
        </div>

        <!-- 7 -->
        <div class="faq-item border-b pb-4">
          <button onclick="toggleFaq(this)" class="w-full text-left font-bold text-lg">7. I have already shared a
            Promise to Pay (PTP). Why am I being called again?</button>
          <div class="faq-answer text-slate-600 dark:text-slate-300">
            <p class="mb-2">We may call to:</p>
            <ul class="list-disc ml-6 space-y-1">
              <li>Confirm your payment readiness</li>
              <li>Check if funds have been arranged</li>
              <li>Assist you in making the payment earlier, if possible</li>
            </ul>
            <p class="mt-2">This helps avoid further penalties or escalation.</p>
          </div>
        </div>

        <!-- 8 -->
        <div class="faq-item border-b pb-4">
          <button onclick="toggleFaq(this)" class="w-full text-left font-bold text-lg">8. Will I continue to receive
            calls after making the payment?</button>
          <div class="faq-answer text-slate-600 dark:text-slate-300">
            <p>No. Once the payment is successfully received and updated in our system, collection calls will stop.</p>
            <p class="mt-2">If you still receive a call, please share the payment reference number with the agent.</p>
          </div>
        </div>

        <!-- 9 -->
        <div class="faq-item border-b pb-4">
          <button onclick="toggleFaq(this)" class="w-full text-left font-bold text-lg">9. What is NBFC?</button>
          <div class="faq-answer text-slate-600 dark:text-slate-300">
            <p>NBFC means Non-Banking Financial Company. It is a company that gives loans, but it is not a bank.</p>
            <div class="mt-4 p-4 bg-slate-50 dark:bg-slate-800 rounded-xl space-y-2">
              <p>üè¶ <strong>Bank</strong> = savings account + loans</p>
              <p>üí∞ <strong>NBFC</strong> = only loans</p>
            </div>
            <ul class="list-disc ml-6 mt-4 space-y-1">
              <li>NBFCs give personal loans, business loans, etc.</li>
              <li>They are approved by RBI</li>
              <li>You cannot open a savings account in an NBFC</li>
              <li>They are commonly used in instant loan apps</li>
            </ul>
            <p class="mt-3 text-sm italic">Example: If you take a quick loan from an app and get money fast, it is
              usually an NBFC, not a bank.</p>
          </div>
        </div>

        <!-- 10 -->
        <div class="faq-item border-b pb-4">
          <button onclick="toggleFaq(this)" class="w-full text-left font-bold text-lg">10. What is an Account
            Aggregator?</button>
          <div class="faq-answer text-slate-600 dark:text-slate-300">
            <p class="mb-3">An Account Aggregator (AA) is a secure system that lets you share your bank details
              digitally with a lender only after your permission. It helps banks/NBFCs check your financial data online,
              without paperwork.</p>
            <h4 class="font-bold mb-2">How it works:</h4>
            <ol class="list-decimal ml-6 space-y-1 mb-4">
              <li>You give consent</li>
              <li>Your bank statement / financial data is shared securely</li>
              <li>The lender checks your eligibility</li>
              <li>Loan gets processed faster</li>
            </ol>
            <div class="grid grid-cols-2 gap-2 text-sm">
              <div class="bg-slate-100 dark:bg-slate-800 p-2 rounded">üîí Safe & secure</div>
              <div class="bg-slate-100 dark:bg-slate-800 p-2 rounded">‚úÖ RBI regulated</div>
              <div class="bg-slate-100 dark:bg-slate-800 p-2 rounded">‚ùå No data without consent</div>
              <div class="bg-slate-100 dark:bg-slate-800 p-2 rounded">‚ö° Quick & paperless</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- BRAND ENTITIES -->
  <div id="view-entities" class="app-view">
    <header class="h-16 flex items-center px-6 border-b bg-white dark:bg-slate-800">
      <button onclick="navigateTo('view-home')" class="font-bold text-slate-500 hover:text-blue-600">‚Üê Home</button>
      <span class="mx-auto font-bold">Brand Entities</span>
    </header>

    <div class="max-w-6xl mx-auto px-6 py-14 text-center">
      <h1 class="text-3xl font-extrabold mb-12">Select an Entity to View Guidelines</h1>

      <div class="grid md:grid-cols-4 gap-8">
        <div onclick="navigateTo('view-bharatloan')"
          class="relative p-8 rounded-3xl cursor-pointer hover-lift bg-gradient-to-r from-blue-800 via-red-600 to-blue-900 text-white">
          <div
            class="w-16 h-16 bg-black rounded-2xl mx-auto mb-4 flex items-center justify-center font-extrabold text-2xl text-white">
            B</div>
          <h3 class="font-bold text-lg">BharatLoan</h3>
        </div>

        <div onclick="navigateTo('view-rupee112')"
          class="relative p-8 rounded-3xl cursor-pointer hover-lift bg-gradient-to-r from-green-500 to-red-600 text-white">
          <div
            class="w-16 h-16 bg-black rounded-2xl mx-auto mb-4 flex items-center justify-center font-extrabold text-2xl text-white">
            ‚Çπ</div>
          <h3 class="font-bold text-lg">Rupee112</h3>
        </div>

        <div onclick="navigateTo('view-loan112')"
          class="relative p-8 rounded-3xl cursor-pointer hover-lift bg-gradient-to-r from-blue-900 to-red-600 text-white">
          <div
            class="w-16 h-16 bg-black rounded-2xl mx-auto mb-4 flex items-center justify-center font-extrabold text-2xl text-white">
            L</div>
          <h3 class="font-bold text-lg">Loan112</h3>
        </div>

        <div onclick="navigateTo('view-rupeeontime')"
          class="relative p-8 rounded-3xl cursor-pointer hover-lift bg-gradient-to-r from-purple-600 to-red-600 text-white">
          <div
            class="w-16 h-16 bg-black rounded-2xl mx-auto mb-4 flex items-center justify-center font-extrabold text-2xl text-white">
            ‚úî</div>
          <h3 class="font-bold text-lg">RupeeOnTime</h3>
        </div>
      </div>
    </div>
  </div>

  <!-- UPDATES -->
  <div id="view-updates" class="app-view bg-white dark:bg-slate-900">
    <header class="h-16 flex items-center px-6 border-b bg-white dark:bg-slate-800">
      <button onclick="navigateTo('view-home')" class="font-bold text-slate-500 hover:text-blue-600">‚Üê Home</button>
      <span class="mx-auto font-bold">System Updates</span>
    </header>
    <div class="max-w-4xl mx-auto px-6 py-14">
      <h2 class="text-3xl font-extrabold mb-8">Recent Policy Changes</h2>
      <div
        class="bg-blue-50 dark:bg-slate-800 p-8 rounded-3xl border border-blue-100 dark:border-slate-700 text-center">
        <div class="text-4xl mb-4">‚ú®</div>
        <h3 class="text-xl font-bold mb-2">Stay Tuned!</h3>
        <p class="text-slate-600 dark:text-slate-400">There are no new updates currently.</p>
      </div>
    </div>
  </div>

  <!-- BHARATLOAN SPECIFIC VIEW -->
  <div id="view-bharatloan" class="app-view bg-white dark:bg-slate-900">
    <header
      class="h-16 flex items-center justify-between px-6 border-b border-slate-200 dark:border-slate-700 bg-gradient-to-r from-red-600 to-blue-900 text-white relative">
      <button onclick="navigateTo('view-entities')" class="font-bold text-white hover:text-blue-600">‚Üê Back to
        Entities</button>
      <button onclick="toggleDropdown('')" class="text-white hover:text-blue-600">Support üìû</button>
      <div id="support-dropdown"
        class="hidden absolute top-full right-0 mt-2 bg-gradient-to-r from-blue-800 via-red-600 to-blue-900 text-white border border-slate-200 dark:border-slate-700 rounded-lg shadow-lg p-4 z-10">
        <h4 class="font-bold mb-2">Contact Support</h4>
        <p><strong>Call:</strong> 8282824644</p>
        <p><strong>Email:</strong> care@bharatloan.com</p>
      </div>
    </header>

    <div class="max-w-5xl mx-auto px-6 py-14">
      <!-- Tabs -->
      <div class="flex border-b border-slate-200 dark:border-slate-700 mb-8">
        <button onclick="showTab('tools')" id="tab-tools"
          class="px-6 py-3 font-bold text-blue-600 border-b-2 border-blue-600">Our Operating Tools</button>
      </div>

      <!-- Tools Tab Content -->
      <div id="content-tools" class="tab-content">
        <div class="grid gap-6">
          <div
            class="group bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 p-6 rounded-3xl transition-all hover:shadow-lg">
            <div class="flex flex-col md:flex-row md:items-center justify-between gap-6">
              <div class="flex-1">
                <h3 class="text-xl font-bold mb-2">BharatLoan Portal and Search Module</h3>
                <p class="text-slate-600 dark:text-slate-300 text-sm leading-relaxed">
                  Main application processing, document view, and status checks. Customer search via PAN, Mobile, or
                  Email.
                </p>
              </div>
              <a href="https://bharatloanfintech.com/" target="_blank"
                class="bg-blue-600 text-white font-bold py-3 px-6 rounded-xl hover:bg-blue-700 transition">Visit Portal
                ‚Üó</a>
            </div>
          </div>

          <div
            class="group bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 p-6 rounded-3xl transition-all hover:shadow-lg">
            <div class="flex flex-col md:flex-row md:items-center justify-between gap-6">
              <div class="flex-1">
                <h3 class="text-xl font-bold mb-2">WOCOM 365</h3>
                <p class="text-slate-600 dark:text-slate-300 text-sm leading-relaxed">
                  Telephony integration, lead management, and communication logging.
                </p>
              </div>
              <a href="https://cpaas.wocom365.com/" target="_blank"
                class="bg-emerald-600 text-white font-bold py-3 px-6 rounded-xl hover:bg-emerald-700 transition">Open
                WOCOM ‚Üó</a>
            </div>
          </div>

          <div
            class="group bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 p-6 rounded-3xl transition-all hover:shadow-lg">
            <div class="flex flex-col md:flex-row md:items-center justify-between gap-6">
              <div class="flex-1">
                <h3 class="text-xl font-bold mb-2">Yellow Ai</h3>
                <p class="text-slate-600 dark:text-slate-300 text-sm leading-relaxed">
                  Handle real-time customer chats efficiently through the AI-powered cloud platform.
                </p>
              </div>
              <a href="https://cloud.yellow.ai/auth/login" target="_blank"
                class="bg-indigo-600 text-white font-bold py-3 px-6 rounded-xl hover:bg-indigo-700 transition">Login
                Chat ‚Üó</a>
            </div>
          </div>

          <div
            class="group bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 p-6 rounded-3xl transition-all hover:shadow-lg">
            <div class="flex flex-col md:flex-row md:items-center justify-between gap-6">
              <div class="flex-1">
                <h3 class="text-xl font-bold mb-2">Outlook (Care@bharatloan.com)</h3>
                <p class="text-slate-600 dark:text-slate-300 text-sm leading-relaxed">
                  Review customer emails and attachments. Standard channel for ticketing and complex queries.
                </p>
              </div>
              <a href="https://outlook.office.com/mail/" target="_blank"
                class="bg-amber-500 text-white font-bold py-3 px-6 rounded-xl hover:bg-amber-600 transition">Open Mail
                ‚Üó</a>
            </div>
          </div>
        </div>
      </div>


    </div>
  </div>

  <!-- RESOURCES -->
  <div id="view-resources" class="app-view bg-white dark:bg-slate-900">
    <header class="h-16 flex items-center px-6 border-b bg-white dark:bg-slate-800">
      <button onclick="navigateTo('view-home')" class="font-bold text-slate-500 hover:text-blue-600">‚Üê Home</button>
      <span class="mx-auto font-bold">Resources</span>
    </header>
    <div class="max-w-4xl mx-auto px-6 py-14">
      <div class="space-y-6">
        <div
          class="bg-slate-50 dark:bg-slate-800 p-6 rounded-3xl border border-slate-200 dark:border-slate-700 cursor-pointer hover:border-purple-600 transition"
          onclick="document.getElementById('guidelines-list').classList.toggle('hidden')">
          <div class="flex items-center gap-4">
            <div class="w-12 h-12 bg-purple-600 text-white rounded-xl flex items-center justify-center text-xl">üìÑ</div>
            <div class="flex-1">
              <h3 class="text-xl font-bold">Guidelines</h3>
              <p class="text-slate-600 dark:text-slate-300">Click to view operational procedures.</p>
            </div>
            <div class="text-2xl text-slate-400">‚ñº</div>
          </div>

          <div id="guidelines-list" class="hidden space-y-4 mt-6 pt-6 border-t border-slate-200 dark:border-slate-700"
            onclick="event.stopPropagation()">
            <!-- 1. Payment Queries -->
            <div class="faq-item border-b border-slate-200 dark:border-slate-700 pb-4">
              <button onclick="toggleFaq(this)" class="w-full text-left font-bold text-lg">1. Payment Queries</button>
              <div class="faq-answer text-slate-600 dark:text-slate-300 text-sm">
                <div class="mb-4 mt-2">
                  <h4 class="font-bold text-slate-800 dark:text-slate-100 mb-2">A. Payment Not Reflecting (Agent Portal)
                  </h4>
                  <p><strong>Step 1:</strong> Verbally confirm the exact payment amount with the customer.</p>
                  <p><strong>Step 2:</strong> Update the WhatsApp Group immediately with the confirmed amount.</p>
                  <p><strong>Step 3:</strong> Escalate/Tag the concerned team via email.</p>
                  <p class="text-red-500 font-bold mt-1">Rule: Escalation is forbidden without prior amount
                    confirmation.</p>
                </div>
                <div>
                  <h4 class="font-bold text-slate-800 dark:text-slate-100 mb-2">B. Payment Reflecting (Verification
                    Pending)</h4>
                  <p><strong>Script:</strong> "We have received your payment of ‚Çπ[Amount]. Your payment is currently
                    under verification and will be updated within 24 hours (maximum)."</p>
                </div>
              </div>
            </div>

            <!-- 2. Application Status Queries -->
            <div class="faq-item border-b border-slate-200 dark:border-slate-700 pb-4">
              <button onclick="toggleFaq(this)" class="w-full text-left font-bold text-lg">2. Application Status
                Queries</button>
              <div class="faq-answer text-slate-600 dark:text-slate-300 text-sm">
                <div class="mb-4 mt-2">
                  <h4 class="font-bold text-slate-800 dark:text-slate-100 mb-2">A. Incomplete Applications
                    (Leads/Partial/eKYC Pending)</h4>
                  <p><strong>Script:</strong> "Your application is currently in process. Kindly complete the remaining
                    steps 100% through the application. If you are facing any issues, please visit our website or
                    contact us at care@bharatloan.com and try again after some time."</p>
                  <p class="mt-2"><strong>If asked about time:</strong> "There is a maximum processing time of 24 hours
                    after 100% completion. A credit manager will then be assigned and will contact you within 24 hours."
                  </p>
                  <p class="text-red-500 font-bold mt-1">üö´ Prohibition: Never assure a callback within 24 hours for
                    incomplete applications.</p>
                </div>
                <div class="mb-4">
                  <h4 class="font-bold text-slate-800 dark:text-slate-100 mb-2">B. Successfully Submitted (#Reference
                    Generated)</h4>
                  <p><strong>Script:</strong> "Your application has been submitted successfully. Our team will contact
                    you within 24 hours."</p>
                </div>
                <div>
                  <h4 class="font-bold text-slate-800 dark:text-slate-100 mb-2">C. Repeat Customers (100% Applied)</h4>
                  <p><strong>Script:</strong> "Since you are an existing customer, your application status is in
                    process. Kindly wait while a credit manager is assigned. They will contact you within 24 hours."</p>
                </div>
              </div>
            </div>

            <!-- 3. Credit Manager Escalations -->
            <div class="faq-item border-b border-slate-200 dark:border-slate-700 pb-4">
              <button onclick="toggleFaq(this)" class="w-full text-left font-bold text-lg">3. Credit Manager
                Escalations</button>
              <div class="faq-answer text-slate-600 dark:text-slate-300 text-sm">
                <table class="w-full text-left mt-2 border-collapse">
                  <thead>
                    <tr class="border-b border-slate-200 dark:border-slate-700">
                      <th class="py-2 font-bold">Scenario</th>
                      <th class="py-2 font-bold">Action</th>
                      <th class="py-2 font-bold">Agent Script</th>
                    </tr>
                  </thead>
                  <tbody class="divide-y divide-slate-100 dark:divide-slate-700">
                    <tr>
                      <td class="py-2 pr-2">New Concern</td>
                      <td class="py-2 pr-2">Highlight/Escalate</td>
                      <td class="py-2 italic">"Your concern is being escalated; the team will contact you within 24
                        hours."</td>
                    </tr>
                    <tr>
                      <td class="py-2 pr-2">Raised Same Day</td>
                      <td class="py-2 pr-2">Verify previous log</td>
                      <td class="py-2 italic">"An executive has already escalated this; the team will contact you within
                        24 hours."</td>
                    </tr>
                    <tr>
                      <td class="py-2 pr-2">Raised Twice</td>
                      <td class="py-2 pr-2">Tag Manager in email</td>
                      <td class="py-2 italic">"We are prioritizing this with senior management. Please wait for the 24h
                        window."</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>

            <!-- 4. Collections & Special Requests -->
            <div class="faq-item border-b border-slate-200 dark:border-slate-700 pb-4">
              <button onclick="toggleFaq(this)" class="w-full text-left font-bold text-lg">4. Collections & Special
                Requests</button>
              <div class="faq-answer text-slate-600 dark:text-slate-300 text-sm">
                <div class="mb-4 mt-2">
                  <h4 class="font-bold text-slate-800 dark:text-slate-100 mb-2">A. Medical Extensions</h4>
                  <p><strong>Mandatory Script:</strong> "We do not have the authority to grant extensions. Your case is
                    with the collection team. If payment is delayed, it may impact your CIBIL score, and a 2% daily
                    charge (1% interest + 1% penalty) will apply. Please email valid medical documents to
                    care@bharatloan.com for review."</p>
                </div>
                <div>
                  <h4 class="font-bold text-slate-800 dark:text-slate-100 mb-2">B. Penalty Waiver / Settlement</h4>
                  <p><strong>Step 1:</strong> Ask the customer for the specific reason.</p>
                  <p><strong>Script:</strong> "We do not have authority for waivers. Please email care@bharatloan.com
                    with valid reasons and evidence. Your concern will be escalated for a response within 24 hours."</p>
                </div>
              </div>
            </div>

            <!-- 5. Disbursement & Refunds -->
            <div class="faq-item border-b border-slate-200 dark:border-slate-700 pb-4">
              <button onclick="toggleFaq(this)" class="w-full text-left font-bold text-lg">5. Disbursement &
                Refunds</button>
              <div class="faq-answer text-slate-600 dark:text-slate-300 text-sm">
                <div class="mb-4 mt-2">
                  <h4 class="font-bold text-slate-800 dark:text-slate-100 mb-2">A. Disbursement Delay</h4>
                  <p><strong>Rule:</strong> Wait 48 hours from the disbursement date.</p>
                  <p><strong>Action (&lt;48h):</strong> Do not escalate. Advise the customer to wait.</p>
                  <p><strong>Action (&gt;48h):</strong> Request a bank statement via email for verification.</p>
                </div>
                <div class="mb-4">
                  <h4 class="font-bold text-slate-800 dark:text-slate-100 mb-2">B. Cancellation After Disbursement</h4>
                  <p><strong>Action:</strong> Immediately update the Refund Tracker under the sheet ‚ÄúCancel After
                    Disbursement‚Äù with 100% accurate details.</p>
                </div>
                <div>
                  <h4 class="font-bold text-slate-800 dark:text-slate-100 mb-2">C. Pending Refunds</h4>
                  <p><strong>Step 1:</strong> Confirm the refund amount with the customer.</p>
                  <p><strong>Timeline:</strong> Inform the customer of the 7‚Äì10 working days window.</p>
                </div>
              </div>
            </div>

            <!-- 6. Email Protocol -->
            <div class="faq-item border-b border-slate-200 dark:border-slate-700 pb-4">
              <button onclick="toggleFaq(this)" class="w-full text-left font-bold text-lg">6. Email Protocol
                (Mandatory)</button>
              <div class="faq-answer text-slate-600 dark:text-slate-300 text-sm">
                <div class="mb-4 mt-2">
                  <p class="text-red-500 font-bold mb-2">üö´ Strict Prohibition: Never use "Sir" or "Ma'am."</p>
                  <p><strong>Greeting:</strong> Always use the customer's First Name (e.g., "Dear Rajesh,").</p>
                </div>
                <div
                  class="bg-indigo-50 dark:bg-slate-700 p-4 rounded-xl border border-indigo-100 dark:border-slate-600">
                  <h4 class="font-bold text-indigo-700 dark:text-indigo-300 mb-2">Payment Confirmation Format:</h4>
                  <p class="font-mono text-xs">
                    Dear [Customer Name],<br><br>
                    This is to confirm that we have received your payment as per the details below:<br><br>
                    Loan Number: {{Loan Number}}<br>
                    Amount Paid: {{Amount}}<br>
                    Date of Payment: {{Payment Date}}
                  </p>
                </div>
              </div>
            </div>

          </div>
        </div>

        <!-- Quality Assurance Checklist - Agent Only -->
        <div id="qa-checklist-card-agent"
          class="hidden bg-slate-50 dark:bg-slate-800 p-6 rounded-3xl border border-slate-200 dark:border-slate-700 cursor-pointer hover:border-purple-400 transition"
          onclick="navigateTo('view-agent-qa')">
          <div class="flex items-center gap-4 mb-4">
            <div class="w-12 h-12 bg-purple-600 text-white rounded-xl flex items-center justify-center text-xl">üìä</div>
            <div>
              <h3 class="text-xl font-bold">Quality Assurance Checklist</h3>
              <p class="text-slate-600 dark:text-slate-300">View your weekly performance and reviews.</p>
            </div>
          </div>
        </div>

        <!-- Quality Assurance Checklist - Non-Agent Users -->
        <div id="qa-checklist-card-other"
          class="bg-slate-50 dark:bg-slate-800 p-6 rounded-3xl border border-slate-200 dark:border-slate-700 cursor-pointer"
          onclick="navigateTo('view-checklist')">
          <div class="flex items-center gap-4 mb-4">
            <div class="w-12 h-12 bg-teal-600 text-white rounded-xl flex items-center justify-center text-xl">üéØ</div>
            <div>
              <h3 class="text-xl font-bold">Quality Assurance Checklist</h3>
              <p class="text-slate-600 dark:text-slate-300">Click to view entity checklists.</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- CHECKLIST VIEW -->
  <div id="view-checklist" class="app-view bg-white dark:bg-slate-900">
    <header class="h-16 flex items-center px-6 border-b bg-white dark:bg-slate-800">
      <button onclick="navigateTo('view-resources')" class="font-bold text-slate-500 hover:text-blue-600">‚Üê Back to
        Resources</button>
      <span class="mx-auto font-bold">Quality Assurance Checklist</span>
    </header>

    <div class="max-w-6xl mx-auto px-6 py-14 text-center">
      <h1 class="text-3xl font-extrabold mb-12">Quality Assurance Checklist</h1>

      <ol class="text-left max-w-2xl mx-auto space-y-6 text-slate-700 dark:text-slate-300">
        <li onclick="handleChecklistClick('BharatLoan')"
          class="cursor-pointer hover:scale-105 transition-all duration-300 text-2xl font-bold p-6 rounded-2xl bg-gradient-to-r from-blue-800 via-blue-700 to-blue-900 text-white shadow-lg hover:shadow-blue-500/50 flex items-center gap-4">
          <span class="bg-white/20 w-12 h-12 rounded-full flex items-center justify-center text-xl">B</span>
          1. BharatLoan
        </li>
        <li onclick="handleChecklistClick('RupeeOnTime')"
          class="cursor-pointer hover:scale-105 transition-all duration-300 text-2xl font-bold p-6 rounded-2xl bg-gradient-to-r from-purple-600 via-purple-500 to-purple-800 text-white shadow-lg hover:shadow-purple-500/50 flex items-center gap-4">
          <span class="bg-white/20 w-12 h-12 rounded-full flex items-center justify-center text-xl">‚úî</span>
          2. RupeeOnTime
        </li>
        <li onclick="handleChecklistClick('Rupee112')"
          class="cursor-pointer hover:scale-105 transition-all duration-300 text-2xl font-bold p-6 rounded-2xl bg-gradient-to-r from-emerald-600 via-emerald-500 to-emerald-800 text-white shadow-lg hover:shadow-emerald-500/50 flex items-center gap-4">
          <span class="bg-white/20 w-12 h-12 rounded-full flex items-center justify-center text-xl">‚Çπ</span>
          3. Rupee112
        </li>
        <li onclick="handleChecklistClick('Loan112')"
          class="cursor-pointer hover:scale-105 transition-all duration-300 text-2xl font-bold p-6 rounded-2xl bg-gradient-to-r from-indigo-600 via-indigo-500 to-indigo-900 text-white shadow-lg hover:shadow-indigo-500/50 flex items-center gap-4">
          <span class="bg-white/20 w-12 h-12 rounded-full flex items-center justify-center text-xl">L</span>
          4. Loan112
        </li>
      </ol>
    </div>
  </div>

  <!-- RUPEE112 SPECIFIC VIEW -->
  <div id="view-rupee112" class="app-view bg-white dark:bg-slate-900">
    <header
      class="h-16 flex items-center justify-between px-6 border-b border-slate-200 dark:border-slate-700 bg-gradient-to-r from-green-500 to-red-600 text-white relative">
      <button onclick="navigateTo('view-entities')" class="font-bold text-white hover:text-blue-600">‚Üê Back to
        Entities</button>

      <button onclick="toggleDropdown('rupee112')" class="text-white hover:text-blue-600">Support üìû</button>
      <div id="support-dropdown-rupee112"
        class="hidden absolute top-full right-0 mt-2 bg-gradient-to-r from-green-500 to-red-600 text-white border border-slate-200 dark:border-slate-700 rounded-lg shadow-lg p-4 z-10">
        <h4 class="font-bold mb-2">Contact Support</h4>
        <p><strong>Call:</strong> 9220644112</p>
        <p><strong>Email:</strong> care@rupee112.com</p>
      </div>
    </header>

    <div class="max-w-5xl mx-auto px-6 py-14">
      <!-- Tabs -->
      <div class="flex border-b border-slate-200 dark:border-slate-700 mb-8">
        <button onclick="showTab('tools', 'rupee112')" id="tab-tools-rupee112"
          class="px-6 py-3 font-bold text-blue-600 border-b-2 border-blue-600">Our Operating Tools</button>
      </div>

      <!-- Tools Tab Content -->
      <div id="content-tools-rupee112" class="tab-content">
        <div class="grid gap-6">
          <div
            class="group bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 p-6 rounded-3xl transition-all hover:shadow-lg">
            <div class="flex flex-col md:flex-row md:items-center justify-between gap-6">
              <div class="flex-1">
                <h3 class="text-xl font-bold mb-2">Rupee112 Portal and Search Module</h3>
                <p class="text-slate-600 dark:text-slate-300 text-sm leading-relaxed">
                  Main application processing, document view, and status checks. Customer search via PAN, Mobile, or
                  Email.
                </p>
              </div>
              <a href="https://rupee112fintech.com/" target="_blank"
                class="bg-blue-600 text-white font-bold py-3 px-6 rounded-xl hover:bg-blue-700 transition">Visit Portal
                ‚Üó</a>
            </div>
          </div>

          <div
            class="group bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 p-6 rounded-3xl transition-all hover:shadow-lg">
            <div class="flex flex-col md:flex-row md:items-center justify-between gap-6">
              <div class="flex-1">
                <h3 class="text-xl font-bold mb-2">WOCOM 365</h3>
                <p class="text-slate-600 dark:text-slate-300 text-sm leading-relaxed">
                  Telephony integration, lead management, and communication logging.
                </p>
              </div>
              <a href="https://cpaas.wocom365.com/" target="_blank"
                class="bg-emerald-600 text-white font-bold py-3 px-6 rounded-xl hover:bg-emerald-700 transition">Open
                WOCOM ‚Üó</a>
            </div>
          </div>

          <div
            class="group bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 p-6 rounded-3xl transition-all hover:shadow-lg">
            <div class="flex flex-col md:flex-row md:items-center justify-between gap-6">
              <div class="flex-1">
                <h3 class="text-xl font-bold mb-2">Yellow Ai</h3>
                <p class="text-slate-600 dark:text-slate-300 text-sm leading-relaxed">
                  Handle real-time customer chats efficiently through the AI-powered cloud platform.
                </p>
              </div>
              <a href="https://cloud.yellow.ai/auth/login" target="_blank"
                class="bg-indigo-600 text-white font-bold py-3 px-6 rounded-xl hover:bg-indigo-700 transition">Login
                Chat ‚Üó</a>
            </div>
          </div>

          <div
            class="group bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 p-6 rounded-3xl transition-all hover:shadow-lg">
            <div class="flex flex-col md:flex-row md:items-center justify-between gap-6">
              <div class="flex-1">
                <h3 class="text-xl font-bold mb-2">Outlook (Care@rupee112.com)</h3>
                <p class="text-slate-600 dark:text-slate-300 text-sm leading-relaxed">
                  Review customer emails and attachments. Standard channel for ticketing and complex queries.
                </p>
              </div>
              <a href="https://outlook.office.com/mail/" target="_blank"
                class="bg-amber-500 text-white font-bold py-3 px-6 rounded-xl hover:bg-amber-600 transition">Open Mail
                ‚Üó</a>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- LOAN112 SPECIFIC VIEW -->
  <div id="view-loan112" class="app-view bg-white dark:bg-slate-900">
    <header
      class="h-16 flex items-center justify-between px-6 border-b border-slate-200 dark:border-slate-700 bg-gradient-to-r from-blue-900 to-red-600 text-white relative">
      <button onclick="navigateTo('view-entities')" class="font-bold text-white hover:text-blue-600">‚Üê Back to
        Entities</button>

      <button onclick="toggleDropdown('loan112')" class="text-white hover:text-blue-600">Support üìû</button>
      <div id="support-dropdown-loan112"
        class="hidden absolute top-full right-0 mt-2 bg-gradient-to-r from-blue-900 to-red-600 text-white border border-slate-200 dark:border-slate-700 rounded-lg shadow-lg p-4 z-10">
        <h4 class="font-bold mb-2">Contact Support</h4>
        <p><strong>Call:</strong> 9311912970</p>
        <p><strong>Email:</strong> care@loan112.com</p>
      </div>
    </header>

    <div class="max-w-5xl mx-auto px-6 py-14">
      <!-- Tabs -->
      <div class="flex border-b border-slate-200 dark:border-slate-700 mb-8">
        <button onclick="showTab('tools', 'loan112')" id="tab-tools-loan112"
          class="px-6 py-3 font-bold text-blue-600 border-b-2 border-blue-600">Our Operating Tools</button>
      </div>

      <!-- Tools Tab Content -->
      <div id="content-tools-loan112" class="tab-content">
        <div class="grid gap-6">
          <div
            class="group bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 p-6 rounded-3xl transition-all hover:shadow-lg">
            <div class="flex flex-col md:flex-row md:items-center justify-between gap-6">
              <div class="flex-1">
                <h3 class="text-xl font-bold mb-2">Loan112 Portal and Search Module</h3>
                <p class="text-slate-600 dark:text-slate-300 text-sm leading-relaxed">
                  Main application processing, document view, and status checks. Customer search via PAN, Mobile, or
                  Email.
                </p>
              </div>
              <a href="https://loan112fintech.com/" target="_blank"
                class="bg-blue-600 text-white font-bold py-3 px-6 rounded-xl hover:bg-blue-700 transition">Visit Portal
                ‚Üó</a>
            </div>
          </div>

          <div
            class="group bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 p-6 rounded-3xl transition-all hover:shadow-lg">
            <div class="flex flex-col md:flex-row md:items-center justify-between gap-6">
              <div class="flex-1">
                <h3 class="text-xl font-bold mb-2">WOCOM 365</h3>
                <p class="text-slate-600 dark:text-slate-300 text-sm leading-relaxed">
                  Telephony integration, lead management, and communication logging.
                </p>
              </div>
              <a href="https://cpaas.wocom365.com/" target="_blank"
                class="bg-emerald-600 text-white font-bold py-3 px-6 rounded-xl hover:bg-emerald-700 transition">Open
                WOCOM ‚Üó</a>
            </div>
          </div>

          <div
            class="group bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 p-6 rounded-3xl transition-all hover:shadow-lg">
            <div class="flex flex-col md:flex-row md:items-center justify-between gap-6">
              <div class="flex-1">
                <h3 class="text-xl font-bold mb-2">Yellow Ai</h3>
                <p class="text-slate-600 dark:text-slate-300 text-sm leading-relaxed">
                  Handle real-time customer chats efficiently through the AI-powered cloud platform.
                </p>
              </div>
              <a href="https://cloud.yellow.ai/auth/login" target="_blank"
                class="bg-indigo-600 text-white font-bold py-3 px-6 rounded-xl hover:bg-indigo-700 transition">Login
                Chat ‚Üó</a>
            </div>
          </div>

          <div
            class="group bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 p-6 rounded-3xl transition-all hover:shadow-lg">
            <div class="flex flex-col md:flex-row md:items-center justify-between gap-6">
              <div class="flex-1">
                <h3 class="text-xl font-bold mb-2">Outlook (Care@loan112.com)</h3>
                <p class="text-slate-600 dark:text-slate-300 text-sm leading-relaxed">
                  Review customer emails and attachments. Standard channel for ticketing and complex queries.
                </p>
              </div>
              <a href="https://outlook.office.com/mail/" target="_blank"
                class="bg-amber-500 text-white font-bold py-3 px-6 rounded-xl hover:bg-amber-600 transition">Open Mail
                ‚Üó</a>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- RUPEEONTIME SPECIFIC VIEW -->
  <div id="view-rupeeontime" class="app-view bg-white dark:bg-slate-900">
    <header
      class="h-16 flex items-center justify-between px-6 border-b border-slate-200 dark:border-slate-700 bg-gradient-to-r from-purple-600 to-red-600 text-white relative">
      <button onclick="navigateTo('view-entities')" class="font-bold text-white hover:text-blue-600">‚Üê Back to
        Entities</button>

      <button onclick="toggleDropdown('rupeeontime')" class="text-white hover:text-blue-600">Support üìû</button>
      <div id="support-dropdown-rupeeontime"
        class="hidden absolute top-full right-0 mt-2 bg-gradient-to-r from-purple-600 to-red-600 text-white border border-slate-200 dark:border-slate-700 rounded-lg shadow-lg p-4 z-10">
        <h4 class="font-bold mb-2">Contact Support</h4>
        <p><strong>Call:</strong> 9220912304</p>
        <p><strong>Email:</strong> care@rupeeontime.com</p>
      </div>
    </header>

    <div class="max-w-5xl mx-auto px-6 py-14">
      <!-- Tabs -->
      <div class="flex border-b border-slate-200 dark:border-slate-700 mb-8">
        <button onclick="showTab('tools', 'rupeeontime')" id="tab-tools-rupeeontime"
          class="px-6 py-3 font-bold text-blue-600 border-b-2 border-blue-600">Our Operating Tools</button>
      </div>

      <!-- Tools Tab Content -->
      <div id="content-tools-rupeeontime" class="tab-content">
        <div class="grid gap-6">
          <div
            class="group bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 p-6 rounded-3xl transition-all hover:shadow-lg">
            <div class="flex flex-col md:flex-row md:items-center justify-between gap-6">
              <div class="flex-1">
                <h3 class="text-xl font-bold mb-2">RupeeOnTime Portal and Search Module</h3>
                <p class="text-slate-600 dark:text-slate-300 text-sm leading-relaxed">
                  Main application processing, document view, and status checks. Customer search via PAN, Mobile, or
                  Email.
                </p>
              </div>
              <a href="https://rotfintech.com/" target="_blank"
                class="bg-blue-600 text-white font-bold py-3 px-6 rounded-xl hover:bg-blue-700 transition">Visit Portal
                ‚Üó</a>
            </div>
          </div>

          <div
            class="group bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 p-6 rounded-3xl transition-all hover:shadow-lg">
            <div class="flex flex-col md:flex-row md:items-center justify-between gap-6">
              <div class="flex-1">
                <h3 class="text-xl font-bold mb-2">WOCOM 365</h3>
                <p class="text-slate-600 dark:text-slate-300 text-sm leading-relaxed">
                  Telephony integration, lead management, and communication logging.
                </p>
              </div>
              <a href="https://cpaas.wocom365.com/" target="_blank"
                class="bg-emerald-600 text-white font-bold py-3 px-6 rounded-xl hover:bg-emerald-700 transition">Open
                WOCOM ‚Üó</a>
            </div>
          </div>

          <div
            class="group bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 p-6 rounded-3xl transition-all hover:shadow-lg">
            <div class="flex flex-col md:flex-row md:items-center justify-between gap-6">
              <div class="flex-1">
                <h3 class="text-xl font-bold mb-2">Yellow Ai</h3>
                <p class="text-slate-600 dark:text-slate-300 text-sm leading-relaxed">
                  Handle real-time customer chats efficiently through the AI-powered cloud platform.
                </p>
              </div>
              <a href="https://cloud.yellow.ai/auth/login" target="_blank"
                class="bg-indigo-600 text-white font-bold py-3 px-6 rounded-xl hover:bg-indigo-700 transition">Login
                Chat ‚Üó</a>
            </div>
          </div>

          <div
            class="group bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 p-6 rounded-3xl transition-all hover:shadow-lg">
            <div class="flex flex-col md:flex-row md:items-center justify-between gap-6">
              <div class="flex-1">
                <h3 class="text-xl font-bold mb-2">Outlook (Care@rupeeontime.com)</h3>
                <p class="text-slate-600 dark:text-slate-300 text-sm leading-relaxed">
                  Review customer emails and attachments. Standard channel for ticketing and complex queries.
                </p>
              </div>
              <a href="https://outlook.office.com/mail/" target="_blank"
                class="bg-amber-500 text-white font-bold py-3 px-6 rounded-xl hover:bg-amber-600 transition">Open Mail
                ‚Üó</a>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- PERFORMANCE VIEW (AGENT DASHBOARD) -->
  <div id="view-performance" class="app-view bg-white dark:bg-slate-900">
    <header class="h-16 flex items-center px-6 border-b bg-white dark:bg-slate-800 justify-between">
      <div class="flex items-center gap-4">
        <button onclick="navigateTo('view-checklist')" class="font-bold text-slate-500 hover:text-blue-600">‚Üê
          Back</button>
        <span id="agent-dashboard-title" class="font-bold text-xl">Agent Dashboard</span>
      </div>
      <div class="flex items-center gap-4">
      </div>
    </header>

    <div class="max-w-6xl mx-auto px-6 py-10">

      <!-- Welcome Banner -->
      <div class="mb-12 p-8 rounded-3xl bg-gradient-to-r from-indigo-600 to-purple-600 text-white shadow-xl">
        <h1 class="text-3xl font-extrabold mb-2">Hello, <span id="agent-name-display">Agent</span> üëã</h1>
        <p class="opacity-90">Keep up the great work! Check your latest performance reviews below.</p>
      </div>

      <!-- Dashboard Grid -->
      <div class="grid grid-cols-1 max-w-2xl mx-auto gap-8">

        <!-- Weekly Performance Tab/Card -->
        <div onclick="openAgentPerformanceModal()"
          class="cursor-pointer group bg-white dark:bg-slate-800 p-8 rounded-3xl border border-slate-200 dark:border-slate-700 hover:shadow-2xl hover:-translate-y-2 transition-all duration-300 relative overflow-hidden">
          <div class="absolute top-0 right-0 p-4 opacity-5 group-hover:opacity-10 transition">
            <span class="text-9xl">üìà</span>
          </div>

          <div
            class="w-16 h-16 rounded-2xl bg-indigo-50 dark:bg-slate-700 flex items-center justify-center text-3xl mb-6 text-indigo-600">
            üéØ
          </div>

          <h3 class="text-2xl font-bold mb-2">Weekly Performance</h3>
          <p class="text-slate-500 text-sm mb-6">Review your audit scores, compliance stats, and proofs.</p>

          <div class="flex items-center gap-2 text-indigo-600 font-bold group-hover:gap-4 transition-all">
            <span>View Details</span>
            <span>‚Üí</span>
          </div>
        </div>


      </div>
    </div>
  </div>

  <!-- AGENT PERFORMANCE MODAL -->
  <div id="agent-performance-modal"
    class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4">
    <div
      class="bg-white dark:bg-slate-900 w-full max-w-5xl h-[90vh] rounded-[2rem] shadow-2xl overflow-hidden flex flex-col animate-scale-up">

      <!-- Modal Header -->
      <div
        class="p-6 border-b border-slate-100 dark:border-slate-800 flex items-center justify-between bg-white dark:bg-slate-900 z-10">
        <div>
          <h2 class="text-2xl font-extrabold flex items-center gap-2">
            <span>üìä</span> Weekly Performance Review
          </h2>
          <p class="text-xs text-slate-500 font-mono mt-1" id="modal-agent-id">ID: --</p>
        </div>
        <button onclick="closeAgentPerformanceModal()"
          class="w-10 h-10 rounded-full bg-slate-100 dark:bg-slate-800 flex items-center justify-center text-slate-500 hover:bg-red-50 hover:text-red-500 transition font-bold text-xl">&times;</button>
      </div>

      <!-- Modal Content (Scrollable) -->
      <div class="flex-1 overflow-y-auto p-8">

        <div id="perf-content-loaded" class="space-y-10">

          <!-- Performance Stats Cards -->
          <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div
              class="p-6 bg-blue-50 dark:bg-slate-800 rounded-2xl border border-blue-100 dark:border-slate-700 text-center">
              <p class="text-xs font-bold uppercase text-slate-400 mb-2">No. of Audits</p>
              <div id="modal-audit-count" class="text-4xl font-black text-blue-600">--</div>
            </div>
            <div
              class="p-6 bg-red-50 dark:bg-slate-800 rounded-2xl border border-red-100 dark:border-slate-700 text-center">
              <p class="text-xs font-bold uppercase text-slate-400 mb-2">Fatal Errors (Score 0)</p>
              <div id="modal-fatal-count" class="text-4xl font-black text-red-600">--</div>
            </div>
            <div
              class="p-6 bg-emerald-50 dark:bg-slate-800 rounded-2xl border border-emerald-100 dark:border-slate-700 text-center">
              <p class="text-xs font-bold uppercase text-slate-400 mb-2">Good (Score 100)</p>
              <div id="modal-good-count" class="text-4xl font-black text-emerald-600">--</div>
            </div>
            <div
              class="p-6 bg-indigo-50 dark:bg-slate-800 rounded-2xl border border-indigo-100 dark:border-slate-700 text-center">
              <p class="text-xs font-bold uppercase text-slate-400 mb-2">Total Score</p>
              <div id="modal-total-score" class="text-4xl font-black text-indigo-600">--</div>
            </div>
          </div>

          <!-- Detailed Reviews List -->
          <div>
            <h3 class="text-xl font-bold mb-4 flex items-center gap-2">
              <span class="bg-indigo-100 dark:bg-slate-700 text-indigo-600 p-2 rounded-lg text-sm">üìã</span>
              Quality Reviews
            </h3>
            <div id="modal-reviews-list" class="space-y-4">
              <!-- Reviews will be populated here by JS -->
            </div>
          </div>

          <!-- Comment Section -->
          <div class="bg-slate-50 dark:bg-slate-800 p-6 rounded-2xl border border-slate-200 dark:border-slate-700">
            <h3 class="text-lg font-bold mb-4">üí¨ Add Your Feedback/Comments</h3>
            <textarea id="agent-comment-input" rows="4"
              class="w-full p-4 rounded-xl border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-900 focus:ring-2 focus:ring-indigo-500 outline-none transition mb-4"
              placeholder="Write your comments or feedback regarding these reviews..."></textarea>
            <button onclick="agentSubmitComment()"
              class="bg-indigo-600 text-white font-bold py-3 px-8 rounded-xl hover:bg-indigo-700 transition shadow-lg shadow-indigo-500/30">Send
              Feedback</button>
          </div>

          <!-- Agent Feedback (moved here from Admin homepage) -->
          <div class="mt-6">
            <h3 class="text-lg font-bold mb-4 flex items-center gap-3">
              <span class="bg-amber-600 text-white rounded-lg p-2 text-xl">üí¨</span>
              Agent Comments
            </h3>
            <div class="mb-4">
              <button onclick="adminDeleteAllFeedback()"
                class="bg-red-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-red-700 transition text-sm">
                üóëÔ∏è Delete All Feedback
              </button>
            </div>
            <div class="overflow-x-auto rounded-3xl border border-slate-200 dark:border-slate-700">
              <table class="w-full bg-white dark:bg-slate-800 text-left border-collapse">
                <thead class="bg-slate-50 dark:bg-slate-700 text-slate-500 uppercase text-xs">
                  <tr>
                    <th class="p-6">Date</th>
                    <th class="p-6">Agent</th>
                    <th class="p-6">Feedback</th>
                    <th class="p-6 text-right">Action</th>
                  </tr>
                </thead>
                <tbody id="admin-feedback-list" class="divide-y divide-slate-100 dark:divide-slate-700">
                  <!-- JS Populates this -->
                </tbody>
              </table>
            </div>
          </div>

        </div>

        <!-- Empty State -->
        <div id="perf-content-empty"
          class="hidden h-full flex flex-col items-center justify-center text-center opacity-50 py-20">
          <div class="text-6xl mb-4">üì≠</div>
          <h3 class="text-xl font-bold">No performance review available yet.</h3>
        </div>

      </div>
    </div>
  </div>

  <!-- ADMIN DASHBOARD -->
  <div id="view-admin" class="app-view bg-white dark:bg-slate-900">
    <header class="h-16 flex items-center px-6 border-b bg-white dark:bg-slate-800 justify-between">
      <div class="flex items-center gap-4">
        <button onclick="navigateTo('view-checklist')" class="font-bold text-slate-500 hover:text-blue-600">‚Üê
          Back</button>
        <span class="font-bold text-xl text-indigo-600">Admin Dashboard - <span
            id="admin-entity-display">--</span></span>
      </div>
    </header>

    <div class="max-w-6xl mx-auto px-6 py-10">
      <!-- Welcome Banner -->
      <div class="mb-8 p-6 bg-gradient-to-r from-indigo-600 to-blue-600 text-white rounded-3xl">
        <h1 id="admin-welcome-text" class="text-3xl font-bold">Welcome Siddhant Chauhan</h1>
      </div>

      <!-- Section 1: Select Agent Only -->
      <div class="bg-blue-50 dark:bg-slate-800 p-8 rounded-3xl mb-12 border border-blue-200 dark:border-slate-700">
        <h2 class="text-2xl font-bold mb-6 flex items-center gap-3">
          <span class="bg-blue-600 text-white rounded-lg p-2 text-xl">üë•</span>
          Select Agent
        </h2>

        <!-- Agent Selection -->
        <!-- Agent Selection Dropdown -->
        <div class="mb-6">
          <label class="block text-sm font-semibold mb-2 text-slate-600 dark:text-slate-400">Choose an Agent to
            Review</label>
          <div class="flex items-center gap-3 mb-3">
            <div class="text-sm text-slate-700 dark:text-slate-300">Current Week: <span id="admin-week-display"
                class="font-bold">1</span></div>
            <div id="admin-week-progress" class="text-sm text-slate-500">(0/0 completed)</div>
            <button id="admin-week-final-submit-btn" onclick="adminFinalizeWeek()"
              class="ml-auto bg-blue-600 text-white px-4 py-2 rounded-md text-sm font-semibold opacity-50 cursor-not-allowed"
              disabled>Final Submit This Week</button>
            <button onclick="adminLoadMonthlyDashboard()"
              class="ml-2 bg-indigo-600 text-white px-4 py-2 rounded-md text-sm font-semibold hover:bg-indigo-700 transition shadow-lg shadow-indigo-500/30">Monthly
              Scorecard üìä</button>
          </div>
          <!-- Hidden native select (kept for backwards compatibility) -->
          <select id="admin-agent-selector" onchange="adminSelectAgentFromDropdown(this)"
            class="w-full p-4 rounded-xl border-2 border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 font-bold text-lg focus:border-blue-500 outline-none transition cursor-pointer">
            <option value="">-- Click to Select Agent --</option>
          </select>
        </div>

        <button id="admin-start-review-btn" onclick="adminStartQualityReview()" disabled
          class="w-full bg-blue-600 text-white font-bold py-3 px-8 rounded-xl hover:bg-blue-700 transition opacity-50 cursor-not-allowed">
          Start Quality Review
        </button>

        <!-- Agent Process Modal (Voice / Non-Voice) -->
        <div id="agent-process-modal"
          class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div class="bg-white dark:bg-slate-800 p-8 rounded-3xl shadow-2xl max-w-md w-full mx-4">
            <div class="flex justify-between items-center mb-4">
              <h2 class="text-2xl font-bold">Start Quality Review</h2>
              <button onclick="document.getElementById('agent-process-modal').classList.add('hidden')"
                class="text-slate-500 hover:text-slate-700 text-2xl">&times;</button>
            </div>
            <p class="text-slate-600 dark:text-slate-400 mb-6">Choose the review type for <span id="modal-agent-name"
                class="font-bold"></span></p>

            <div class="space-y-4">
              <button onclick="startQualityReviewWithType('voice')"
                class="w-full bg-blue-600 text-white font-bold py-4 px-6 rounded-xl hover:bg-blue-700 transition flex items-center justify-center gap-3">
                <span class="text-2xl">üéôÔ∏è</span>
                <div>
                  <div class="font-bold">Voice</div>
                  <div class="text-sm opacity-90">Call recordings & interaction (requires file)</div>
                </div>
              </button>

              <button onclick="startQualityReviewWithType('non-voice')"
                class="w-full bg-green-600 text-white font-bold py-4 px-6 rounded-xl hover:bg-green-700 transition flex items-center justify-center gap-3">
                <span class="text-2xl">üí¨</span>
                <div>
                  <div class="font-bold">Non-Voice</div>
                  <div class="text-sm opacity-90">Chat / Email interactions (paste Chat/Email ID)</div>
                </div>
              </button>
            </div>

            <button onclick="document.getElementById('agent-process-modal').classList.add('hidden')"
              class="w-full mt-4 bg-slate-300 text-slate-700 font-bold py-2 px-4 rounded-lg hover:bg-slate-400 transition">Cancel</button>
          </div>
        </div>

      </div>



      <!-- Confirm Clear Finalizations Modal -->



    </div>
  </div>

  <!-- Section 2: Quality Review Form (Hidden initially) -->
  <div id="admin-quality-form-section"
    class="hidden bg-emerald-50 dark:bg-slate-800 p-8 rounded-3xl mb-12 border border-emerald-200 dark:border-slate-700">
    <div class="flex items-center justify-between mb-6">
      <h2 class="text-2xl font-bold flex items-center gap-3">
        <span class="bg-emerald-600 text-white rounded-lg p-2 text-xl">üìù</span>
        Quality Review - <span id="admin-review-agent-display" class="text-emerald-600"></span>
      </h2>
      <button onclick="adminCancelReview()" class="text-slate-500 hover:text-slate-700 text-sm font-medium">‚Üê
        Back</button>
    </div>

    <!-- File Input Section (for Voice reviews) -->
    <div id="admin-review-file-section"
      class="hidden mb-6 p-4 bg-white dark:bg-slate-700 rounded-xl border border-emerald-200 dark:border-slate-600">
      <label class="block text-sm font-semibold mb-3">Select Call Recording or File (Max 100MB)</label>
      <input type="file" id="admin-review-file-input"
        class="block w-full text-sm file:mr-4 file:py-2 file:px-4 file:rounded file:border-0 file:text-sm file:font-semibold file:bg-blue-100 file:text-blue-700">
      <p class="text-xs text-slate-500 mt-2">Selected: <span id="admin-review-file-name">None</span></p>
    </div>

    <div id="admin-review-items-container" class="space-y-6">
      <!-- Review items will be dynamically added here -->
    </div>

    <div class="flex gap-3 mt-8">
      <button onclick="adminAddReviewItem()" id="admin-add-review-btn"
        class="flex-1 bg-blue-600 text-white font-bold py-3 px-8 rounded-xl hover:bg-blue-700 transition">
        ‚ûï Add Review (Min 3, Max 10)
      </button>
      <button onclick="adminFinalSubmit()" id="admin-final-submit-btn" disabled
        class="flex-1 bg-green-600 text-white font-bold py-3 px-8 rounded-xl hover:bg-green-700 transition opacity-50 cursor-not-allowed">
        ‚úÖ Final Submit
      </button>
    </div>
  </div>

  <!-- Section 3: Submitted Reviews -->
  <div id="admin-submitted-reviews-section" class="mb-12 hidden">
    <h2 class="text-2xl font-bold mb-6 flex items-center gap-3">
      <span class="bg-indigo-600 text-white rounded-lg p-2 text-xl">üìã</span>
      Submitted Reviews
    </h2>
    <div class="mb-4 flex gap-3">
      <button onclick="adminDeleteAllReviews()"
        class="bg-red-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-red-700 transition text-sm">
        üóëÔ∏è Delete All Reviews
      </button>
      <button onclick="adminClearFinalizations()" id="admin-clear-finalizations-btn"
        class="bg-yellow-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-yellow-600 transition text-sm">
        ‚úñÔ∏è Clear Finalizations
      </button>
    </div>
    <div class="overflow-x-auto rounded-3xl border border-slate-200 dark:border-slate-700">
      <table class="w-full bg-white dark:bg-slate-800 text-left border-collapse">
        <thead class="bg-slate-50 dark:bg-slate-700 text-slate-500 uppercase text-xs">
          <tr>
            <th class="p-6">Date</th>
            <th class="p-6">Agent</th>
            <th class="p-6">File</th>
            <th class="p-6">Score</th>
            <th class="p-6">Observation</th>
            <th class="p-6 text-right">Action</th>
          </tr>
        </thead>
        <tbody id="admin-reviews-list" class="divide-y divide-slate-100 dark:divide-slate-700">
          <!-- JS Populates this -->
        </tbody>
      </table>
    </div>
  </div>


  </div>
  </div>

  <!-- ADMIN MONTHLY DASHBOARD (NEW) -->
  <div id="view-admin-monthly" class="app-view bg-white dark:bg-slate-900">
    <header class="h-16 flex items-center px-6 border-b bg-white dark:bg-slate-800 sticky top-0 z-40">
      <button onclick="navigateTo('view-admin')" class="font-bold text-slate-500 hover:text-blue-600 mr-4">‚Üê
        Back</button>
      <h1 class="font-bold text-xl text-indigo-600">Monthly Performance Scorecard</h1>
    </header>

    <div class="max-w-7xl mx-auto px-6 py-10">
      <div
        class="bg-indigo-50 dark:bg-slate-800 p-8 rounded-3xl mb-8 border border-indigo-100 dark:border-slate-700 flex justify-between items-center">
        <div>
          <h2 class="text-3xl font-bold mb-2">Team Performance Overview</h2>
          <p class="text-slate-600 dark:text-slate-400">Aggregated performance for the last 30 days.</p>
        </div>
        <div class="text-right">
          <div class="text-sm font-bold text-slate-500 uppercase">Entity</div>
          <div class="text-2xl font-bold text-indigo-600" id="admin-monthly-entity-display">--</div>
        </div>
      </div>

      <div
        class="bg-white dark:bg-slate-800 rounded-3xl shadow-xl overflow-hidden border border-slate-200 dark:border-slate-700">
        <div class="overflow-x-auto">
          <table class="w-full text-left border-collapse">
            <thead class="bg-slate-50 dark:bg-slate-700 text-slate-500 uppercase text-xs font-bold">
              <tr>
                <th class="p-6 text-center w-16">#</th>
                <th class="p-6">Agent Name</th>
                <th class="p-6 text-center">Total Audits</th>
                <th class="p-6 text-center">Fatal Errors</th>
                <th class="p-6 text-center">Avg Score</th>
                <th class="p-6 text-center">Performance</th>
              </tr>
            </thead>
            <tbody id="admin-monthly-table-body" class="divide-y divide-slate-100 dark:divide-slate-700 text-sm">
              <!-- JS Populates this -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- AGENT QUALITY ASSURANCE CHECKLIST -->
  <div id="view-agent-qa" class="app-view bg-white dark:bg-slate-900">
    <header class="h-16 flex items-center px-6 border-b bg-white dark:bg-slate-800 justify-between">
      <div class="flex items-center gap-4">
        <button onclick="navigateTo('view-home')" class="font-bold text-slate-500 hover:text-blue-600">‚Üê
          Back</button>
        <span class="font-bold text-xl text-purple-600">Quality Assurance Checklist</span>
      </div>
      <div class="flex items-center gap-4">
      </div>
    </header>

    <div class="max-w-6xl mx-auto px-6 py-10">
      <!-- Welcome Banner -->
      <div class="mb-8 p-6 bg-gradient-to-r from-purple-600 to-indigo-600 text-white rounded-3xl">
        <h1 id="agent-qa-welcome-text" class="text-3xl font-bold">Welcome</h1>
        <p class="text-purple-100 mt-2">View your performance and quality scores</p>
      </div>

      <!-- Tab Navigation -->
      <div class="flex gap-4 mb-8 border-b border-slate-200 dark:border-slate-700">
        <button onclick="agentSwitchTab('weekly')" id="tab-weekly"
          class="px-6 py-3 font-bold text-purple-600 border-b-2 border-purple-600">üìä Weekly Performance</button>
        <button onclick="agentSwitchTab('monthly')" id="tab-monthly"
          class="px-6 py-3 font-bold text-slate-500 border-b-2 border-transparent hover:text-slate-700">üìà Monthly
          Performance</button>
      </div>

      <!-- Weekly Performance Section -->
      <div id="tab-content-weekly"
        class="bg-purple-50 dark:bg-slate-800 p-8 rounded-3xl mb-12 border border-purple-200 dark:border-slate-700">
        <h2 class="text-2xl font-bold mb-8 flex items-center gap-3">
          <span class="bg-purple-600 text-white rounded-lg p-2 text-xl">üìä</span>
          Weekly Performance
        </h2>

        <!-- Performance Stats -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
          <!-- Total Reviews -->
          <div class="bg-white dark:bg-slate-700 p-6 rounded-2xl border border-purple-200 dark:border-slate-600">
            <div class="text-3xl font-bold text-purple-600" id="agent-total-reviews">0</div>
            <p class="text-slate-600 dark:text-slate-400 text-sm mt-2">Total Reviews</p>
          </div>

          <!-- Average Score -->
          <div class="bg-white dark:bg-slate-700 p-6 rounded-2xl border border-purple-200 dark:border-slate-600">
            <div class="text-3xl font-bold text-indigo-600" id="agent-avg-score">0</div>
            <p class="text-slate-600 dark:text-slate-400 text-sm mt-2">Average Score</p>
          </div>

          <!-- Last Review -->
          <div class="bg-white dark:bg-slate-700 p-6 rounded-2xl border border-purple-200 dark:border-slate-600">
            <div class="text-lg font-bold text-blue-600" id="agent-last-review">--</div>
            <p class="text-slate-600 dark:text-slate-400 text-sm mt-2">Last Review Date</p>
          </div>

          <!-- Performance Status -->
          <div class="bg-white dark:bg-slate-700 p-6 rounded-2xl border border-purple-200 dark:border-slate-600">
            <div class="text-lg font-bold text-green-600" id="agent-performance-status">Excellent</div>
            <p class="text-slate-600 dark:text-slate-400 text-sm mt-2">Current Status</p>
          </div>
        </div>

        <!-- Reviews History Table -->
        <h3 class="text-xl font-bold mb-4 mt-8">Your Review History</h3>
        <div class="overflow-x-auto rounded-3xl border border-slate-200 dark:border-slate-700">
          <table class="w-full bg-white dark:bg-slate-800 text-left border-collapse">
            <thead class="bg-slate-50 dark:bg-slate-700 text-slate-500 uppercase text-xs">
              <tr>
                <th class="p-6">Date</th>
                <th class="p-6">Reviewer</th>
                <th class="p-6">Details</th>
                <th class="p-6">Score</th>
                <th class="p-6">Replies</th>
                <th class="p-6">Status</th>
              </tr>
            </thead>
            <tbody id="agent-reviews-history" class="divide-y divide-slate-100 dark:divide-slate-700">
              <!-- JS Populates this -->
            </tbody>
          </table>
        </div>

        <!-- No Reviews Message -->
        <div id="agent-no-reviews-message" class="text-center py-12 hidden">
          <div class="text-4xl mb-4">üì≠</div>
          <h4 class="text-xl font-bold text-slate-600 dark:text-slate-400">No Reviews Yet</h4>
          <p class="text-slate-500 dark:text-slate-500 mt-2">Your reviews will appear here once submitted by quality
            assurance team.</p>
        </div>
      </div>

      <!-- Monthly Performance Section -->
      <div id="tab-content-monthly"
        class="hidden bg-green-50 dark:bg-slate-800 p-8 rounded-3xl mb-12 border border-green-200 dark:border-slate-700">
        <h2 class="text-2xl font-bold mb-8 flex items-center gap-3">
          <span class="bg-green-600 text-white rounded-lg p-2 text-xl">üìà</span>
          Monthly Performance (Last 4 Weeks)
        </h2>

        <!-- Monthly Stats -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
          <div class="bg-white dark:bg-slate-700 p-6 rounded-2xl border border-green-200 dark:border-slate-600">
            <div class="text-3xl font-bold text-green-600" id="agent-monthly-total-audits">0</div>
            <p class="text-slate-600 dark:text-slate-400 text-sm mt-2">Total Audits</p>
          </div>

          <div class="bg-white dark:bg-slate-700 p-6 rounded-2xl border border-green-200 dark:border-slate-600">
            <div class="text-3xl font-bold text-indigo-600" id="agent-monthly-avg-score">0%</div>
            <p class="text-slate-600 dark:text-slate-400 text-sm mt-2">Overall Score</p>
          </div>

          <div class="bg-white dark:bg-slate-700 p-6 rounded-2xl border border-green-200 dark:border-slate-600">
            <div class="text-3xl font-bold text-red-600" id="agent-monthly-fatal-count">0</div>
            <p class="text-slate-600 dark:text-slate-400 text-sm mt-2">Total Fatal Issues</p>
          </div>

          <div class="bg-white dark:bg-slate-700 p-6 rounded-2xl border border-green-200 dark:border-slate-600">
            <div class="text-lg font-bold text-green-600" id="agent-monthly-status">Excellent</div>
            <p class="text-slate-600 dark:text-slate-400 text-sm mt-2">Monthly Status</p>
          </div>
        </div>

        <!-- Weekly Breakdown -->
        <div id="agent-monthly-weekly-breakdown" class="mb-8">
          <!-- Week 1 -->
          <div class="bg-white dark:bg-slate-700 p-6 rounded-2xl border border-slate-200 dark:border-slate-600 mb-4">
            <h4 class="font-bold text-lg mb-4">Week 1</h4>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
              <div>
                <p class="text-sm text-slate-600 dark:text-slate-400">Audits</p>
                <p class="text-2xl font-bold" id="agent-monthly-week1-audits">0</p>
              </div>
              <div>
                <p class="text-sm text-slate-600 dark:text-slate-400">Score</p>
                <p class="text-2xl font-bold" id="agent-monthly-week1-score">0%</p>
              </div>
              <div>
                <p class="text-sm text-slate-600 dark:text-slate-400">Fatals</p>
                <p class="text-2xl font-bold text-red-600" id="agent-monthly-week1-fatals">0</p>
              </div>
            </div>
          </div>

          <!-- Week 2 -->
          <div class="bg-white dark:bg-slate-700 p-6 rounded-2xl border border-slate-200 dark:border-slate-600 mb-4">
            <h4 class="font-bold text-lg mb-4">Week 2</h4>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
              <div>
                <p class="text-sm text-slate-600 dark:text-slate-400">Audits</p>
                <p class="text-2xl font-bold" id="agent-monthly-week2-audits">0</p>
              </div>
              <div>
                <p class="text-sm text-slate-600 dark:text-slate-400">Score</p>
                <p class="text-2xl font-bold" id="agent-monthly-week2-score">0%</p>
              </div>
              <div>
                <p class="text-sm text-slate-600 dark:text-slate-400">Fatals</p>
                <p class="text-2xl font-bold text-red-600" id="agent-monthly-week2-fatals">0</p>
              </div>
            </div>
          </div>

          <!-- Week 3 -->
          <div class="bg-white dark:bg-slate-700 p-6 rounded-2xl border border-slate-200 dark:border-slate-600 mb-4">
            <h4 class="font-bold text-lg mb-4">Week 3</h4>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
              <div>
                <p class="text-sm text-slate-600 dark:text-slate-400">Audits</p>
                <p class="text-2xl font-bold" id="agent-monthly-week3-audits">0</p>
              </div>
              <div>
                <p class="text-sm text-slate-600 dark:text-slate-400">Score</p>
                <p class="text-2xl font-bold" id="agent-monthly-week3-score">0%</p>
              </div>
              <div>
                <p class="text-sm text-slate-600 dark:text-slate-400">Fatals</p>
                <p class="text-2xl font-bold text-red-600" id="agent-monthly-week3-fatals">0</p>
              </div>
            </div>
          </div>

          <!-- Week 4 -->
          <div class="bg-white dark:bg-slate-700 p-6 rounded-2xl border border-slate-200 dark:border-slate-600 mb-4">
            <h4 class="font-bold text-lg mb-4">Week 4</h4>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
              <div>
                <p class="text-sm text-slate-600 dark:text-slate-400">Audits</p>
                <p class="text-2xl font-bold" id="agent-monthly-week4-audits">0</p>
              </div>
              <div>
                <p class="text-sm text-slate-600 dark:text-slate-400">Score</p>
                <p class="text-2xl font-bold" id="agent-monthly-week4-score">0%</p>
              </div>
              <div>
                <p class="text-sm text-slate-600 dark:text-slate-400">Fatals</p>
                <p class="text-2xl font-bold text-red-600" id="agent-monthly-week4-fatals">0</p>
              </div>
            </div>
          </div>
        </div>

        <div id="agent-no-monthly-data" class="text-center py-12">
          <div class="text-4xl mb-4">üìÖ</div>
          <h4 class="text-xl font-bold text-slate-600 dark:text-slate-400">Need More Data</h4>
          <p class="text-slate-500 dark:text-slate-500 mt-2">Monthly performance requires at least 4 weeks of audit
            data.</p>
        </div>
      </div>
    </div>
  </div>

  <!-- REVIEWER DASHBOARD -->
  <div id="view-reviewer" class="app-view bg-white dark:bg-slate-900">
    <header class="h-16 flex items-center px-6 border-b bg-white dark:bg-slate-800 justify-between">
      <div class="flex items-center gap-4">
        <button onclick="navigateTo('view-checklist')" class="font-bold text-slate-500 hover:text-blue-600">‚Üê
          Back</button>

        <span class="font-bold text-xl text-purple-600">Review Dashboard - <span
            id="reviewer-entity-display">--</span></span>
      </div>
    </header>

    <div class="max-w-6xl mx-auto px-6 py-10">
      <!-- Welcome Banner -->
      <div class="mb-8 p-6 bg-gradient-to-r from-purple-600 to-indigo-600 text-white rounded-3xl">
        <h1 id="reviewer-welcome-text" class="text-3xl font-bold">Welcome Ayushi Gupta</h1>
      </div>

      <!-- Section 1: Select Agent -->
      <div class="bg-purple-50 dark:bg-slate-800 p-8 rounded-3xl mb-12 border border-purple-200 dark:border-slate-700">
        <h2 class="text-2xl font-bold mb-6 flex items-center gap-3">
          <span class="bg-purple-600 text-white rounded-lg p-2 text-xl">üë•</span>
          Select Agent
        </h2>

        <!-- Agent Selection -->
        <div class="mb-6">
          <label class="block text-sm font-semibold mb-2 text-slate-600 dark:text-slate-400">Select Agent</label>
          <select id="reviewer-agent-selector" onchange="reviewerSelectAgent(this)"
            class="w-full p-4 rounded-xl border-2 border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 font-bold text-lg focus:border-purple-500 outline-none transition cursor-pointer">
            <option value="">-- Choose Agent --</option>
          </select>
        </div>
      </div>

      <!-- Section 2: Reviews List -->
      <div id="reviewer-reviews-section" class="mb-12 hidden">
        <h2 class="text-2xl font-bold mb-6 flex items-center gap-3">
          <span class="bg-purple-600 text-white rounded-lg p-2 text-xl">üìã</span>
          Agent Reviews
        </h2>
        <div class="overflow-x-auto rounded-3xl border border-slate-200 dark:border-slate-700">
          <table class="w-full bg-white dark:bg-slate-800 text-left border-collapse">
            <thead class="bg-slate-50 dark:bg-slate-700 text-slate-500 uppercase text-xs">
              <tr>
                <th class="p-6">Date</th>
                <th class="p-6">Agent</th>
                <th class="p-6">File</th>
                <th class="p-6">Score</th>
                <th class="p-6">Observation</th>
                <th class="p-6 text-right">Action</th>
              </tr>
            </thead>
            <tbody id="reviewer-reviews-list" class="divide-y divide-slate-100 dark:divide-slate-700">
              <!-- JS Populates this -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- LOGIN MODAL -->
  <div id="login-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white dark:bg-slate-800 p-8 rounded-3xl shadow-lg max-w-md w-full mx-4">
      <div class="flex justify-between items-center mb-6">
        <h2 id="login-title" class="text-2xl font-bold">Login</h2>
        <button onclick="hideLogin()" class="text-slate-500 hover:text-slate-700 text-2xl">&times;</button>
      </div>
      <form onsubmit="submitLogin(event)">
        <div class="mb-6">
          <label class="block text-sm font-medium mb-2">Employee ID</label>
          <input id="empid" type="text" required
            class="w-full px-4 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-slate-50 dark:bg-slate-700">
        </div>

        <button type="submit"
          class="w-full bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition">Login</button>
      </form>
    </div>
  </div>

  <!-- ACCESS DENIED MODAL -->
  <div id="access-denied-modal"
    class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white dark:bg-slate-800 p-8 rounded-3xl shadow-lg max-w-md w-full mx-4">
      <div class="flex justify-between items-center mb-6">
        <h2 id="access-denied-title" class="text-2xl font-bold text-red-600">Access Denied</h2>
        <button onclick="document.getElementById('access-denied-modal').classList.add('hidden')"
          class="text-slate-500 hover:text-slate-700 text-2xl">&times;</button>
      </div>
      <p class="text-slate-600 dark:text-slate-400 mb-6">You do not have permission to access this entity. Please use
        the correct Employee ID for the selected entity.</p>
      <button onclick="document.getElementById('access-denied-modal').classList.add('hidden')"
        class="w-full bg-red-600 text-white py-2 px-4 rounded-lg hover:bg-red-700 transition">Close</button>
    </div>
  </div>

  <!-- EDIT REVIEW MODAL -->
  <div id="admin-edit-review-modal"
    class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4">
    <div class="bg-white dark:bg-slate-800 p-8 rounded-3xl shadow-lg max-w-lg w-full">
      <h3 class="text-2xl font-bold mb-6">Edit Review</h3>

      <!-- Score -->
      <div class="mb-4">
        <label class="block text-sm font-medium mb-2">Score</label>
        <div class="flex gap-4">
          <label
            class="flex items-center gap-2 cursor-pointer bg-emerald-50 dark:bg-slate-700 p-3 rounded-xl border border-emerald-100 dark:border-slate-600">
            <input type="radio" name="edit-score" value="100" class="w-5 h-5 text-emerald-600">
            <span class="font-bold text-emerald-600">100 (Pass)</span>
          </label>
          <label
            class="flex items-center gap-2 cursor-pointer bg-red-50 dark:bg-slate-700 p-3 rounded-xl border border-red-100 dark:border-slate-600">
            <input type="radio" name="edit-score" value="0" class="w-5 h-5 text-red-600">
            <span class="font-bold text-red-600">0 (Fatal/Fail)</span>
          </label>
        </div>
      </div>

      <!-- Observation -->
      <div class="mb-4">
        <label class="block text-sm font-medium mb-2">Observation</label>
        <textarea id="edit-observation" rows="3"
          class="w-full px-4 py-2 rounded-lg border border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 focus:ring-2 focus:ring-blue-500 outline-none"></textarea>
      </div>

      <!-- File -->
      <div class="mb-6">
        <label class="block text-sm font-medium mb-2">Update File (Optional)</label>
        <p class="text-xs text-slate-500 mb-2">Current: <span id="edit-current-filename"
            class="font-mono font-bold"></span></p>
        <input type="file" id="edit-file-upload"
          class="w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
      </div>

      <div class="flex gap-3">
        <button onclick="adminSaveEdit()" id="btn-save-edit"
          class="flex-1 bg-blue-600 text-white font-bold py-3 rounded-xl hover:bg-blue-700 transition">Save
          Changes</button>
        <button onclick="document.getElementById('admin-edit-review-modal').classList.add('hidden')"
          class="px-6 py-3 rounded-xl border border-slate-300 hover:bg-slate-50 dark:border-slate-600 dark:hover:bg-slate-700 transition">Cancel</button>
      </div>
    </div>
  </div>

  <script>
    // ===== PORTAL LOGIN SYSTEM =====
    let currentSessionUser = null;

    // Initialize portal login on page load
    function initPortal() {
      const savedPasswords = JSON.parse(localStorage.getItem('gojira_passwords') || '{}');
      if (!Object.keys(savedPasswords).length) {
        // Initialize all users with default password "1234"
        const allUsers = {};
        USER_DB.forEach(user => {
          allUsers[user.id] = '1234'; // Default password
        });
        localStorage.setItem('gojira_passwords', JSON.stringify(allUsers));
      }

      // Check if already logged in
      const sessionUser = localStorage.getItem('gojira_session_user');
      if (sessionUser) {
        try {
          currentSessionUser = JSON.parse(sessionUser);
          console.info('[initPortal] Restored session for', currentSessionUser.id, currentSessionUser.role);
          // Restore role-specific UI and state
          if (currentSessionUser.role === 'admin') {
            currentUser = currentSessionUser;
            adminCurrentEntity = currentSessionUser.entity || 'ALL';
            const welcomeText = document.getElementById('admin-welcome-text');
            if (welcomeText) welcomeText.innerText = `Welcome ${currentSessionUser.name}`;
            adminLoadAgents();
          } else if (currentSessionUser.role === 'reviewer') {
            currentUser = currentSessionUser;
            reviewerCurrentEntity = currentSessionUser.entity || 'BharatLoan';
            adminCurrentEntity = reviewerCurrentEntity; // ensure agents load correctly
            const welcomeText = document.getElementById('reviewer-welcome-text');
            if (welcomeText) welcomeText.innerText = `Welcome ${currentSessionUser.name}`;
            const entityDisplay = document.getElementById('reviewer-entity-display');
            if (entityDisplay) entityDisplay.textContent = reviewerCurrentEntity;
            adminLoadAgents();
          } else {
            currentUser = currentSessionUser;
          }
          showPortalContent();
        } catch (err) {
          console.error('[initPortal] invalid session data', err);
        }
      }
    }


    // Portal Login Function
    function showPortalContent() {
      document.getElementById('portal-login-screen').classList.add('hidden');
      document.getElementById('top-nav').classList.remove('hidden');

      // Set user greeting on home page
      const firstName = currentSessionUser.name.split(' ')[0];
      document.getElementById('home-user-greeting').innerText = `Hi ${firstName}`;

      // Filter entities display based on user
      filterEntitiesDisplay();
      filterResourcesQACard(); // Set QA card visibility based on user role

      // Set currentUser and currentEntity for all users
      currentUser = currentSessionUser;
      currentEntity = currentSessionUser.entity;

      // Route all users to home page
      navigateTo('view-home');
    }

    // Portal Logout
    function portalLogout() {
      currentSessionUser = null;
      localStorage.removeItem('gojira_session_user');

      // Reset user greeting
      document.getElementById('home-user-greeting').innerText = 'Hi Guest';

      // Clear all forms
      document.getElementById('portal-emp-id').value = '';
      document.getElementById('portal-password').value = '';
      document.getElementById('change-pass-emp-id').value = '';
      document.getElementById('change-pass-current').value = '';
      document.getElementById('change-pass-new').value = '';

      // Show login screen
      document.getElementById('portal-login-screen').classList.remove('hidden');
      document.getElementById('top-nav').classList.add('hidden');

      // Remove Gojira theme
      document.body.classList.remove('gojira-theme');
      localStorage.removeItem('gojira_theme_active');

      // Hide all views
      document.querySelectorAll('.app-view').forEach(view => {
        view.classList.remove('active');
      });
    }

    // Change Password Modal Functions
    function showChangePasswordModal() {
      document.getElementById('change-password-modal').classList.remove('hidden');
    }

    function hideChangePasswordModal() {
      document.getElementById('change-password-modal').classList.add('hidden');
      document.getElementById('change-pass-emp-id').value = '';
      document.getElementById('change-pass-current').value = '';
      document.getElementById('change-pass-new').value = '';
    }

    // Submit Change Password
    function submitChangePassword(event) {
      event.preventDefault();

      const empId = document.getElementById('change-pass-emp-id').value.trim();
      const currentPassword = document.getElementById('change-pass-current').value;
      const newPassword = document.getElementById('change-pass-new').value;

      // Validate employee exists
      const user = USER_DB.find(u => u.id === empId);
      if (!user) {
        alert('‚ùå Employee ID not found');
        return;
      }

      // Validate current password
      const savedPasswords = JSON.parse(localStorage.getItem('gojira_passwords') || '{}');
      const storedPassword = savedPasswords[empId] || '1234';

      if (currentPassword !== storedPassword) {
        alert('‚ùå Current password is incorrect');
        return;
      }

      // Validate new password
      if (newPassword.trim().length < 4) {
        alert('‚ùå New password must be at least 4 characters');
        return;
      }

      // Update password
      savedPasswords[empId] = newPassword;
      localStorage.setItem('gojira_passwords', JSON.stringify(savedPasswords));

      alert('‚úÖ Password changed successfully! You can now login with your new password.');
      hideChangePasswordModal();
    }

    // MOCK BACKEND
    class MockBackend {
      static getReports() {
        return JSON.parse(localStorage.getItem('gojira_reports') || '[]');
      }

      static addReport(file, content) {
        const reports = this.getReports();
        reports.unshift({
          id: Date.now(),
          name: file.name,
          type: file.type || 'Unknown',
          date: new Date().toLocaleString(),
          uploader: 'Admin',
          content: content // Store Base64 string
        });
        // Limit storage to prevent quota exceeded (keep last 5)
        if (reports.length > 5) reports.pop();
        localStorage.setItem('gojira_reports', JSON.stringify(reports));
      }

      static getComments() {
        return JSON.parse(localStorage.getItem('gojira_comments') || '[]');
      }

      static addComment(text, agentId) {
        const comments = this.getComments();
        comments.unshift({
          id: Date.now(),
          text,
          agentId,
          date: new Date().toLocaleString()
        });
        localStorage.setItem('gojira_comments', JSON.stringify(comments));
      }

      static deleteComment(id) {
        const comments = this.getComments().filter(c => c.id != id);
        localStorage.setItem('gojira_comments', JSON.stringify(comments));
      }

      static deleteReport(id) {
        const reports = this.getReports().filter(r => r.id != id);
        localStorage.setItem('gojira_reports', JSON.stringify(reports));
      }

      static clearAllReports() {
        localStorage.setItem('gojira_reports', JSON.stringify([]));
      }

      // PERFORMANCE DATA
      static getPerformance(agentId) {
        const db = JSON.parse(localStorage.getItem('gojira_performance') || '{}');
        return db[agentId] || null;
      }

      static savePerformance(agentId, data) {
        const db = JSON.parse(localStorage.getItem('gojira_performance') || '{}');
        db[agentId] = {
          ...data,
          lastUpdated: new Date().toLocaleString()
        };
        localStorage.setItem('gojira_performance', JSON.stringify(db));
      }

      static savePerformanceScore(performanceData) {
        const scores = JSON.parse(localStorage.getItem('gojira_performance_scores') || '[]');
        scores.unshift({
          id: Date.now(),
          ...performanceData
        });
        // Keep only last 50 scores to prevent storage bloat
        if (scores.length > 50) scores.pop();
        localStorage.setItem('gojira_performance_scores', JSON.stringify(scores));

        // Update the agent's current performance score
        const currentPerf = this.getPerformance(performanceData.agentId) || {};
        this.savePerformance(performanceData.agentId, {
          score: performanceData.score,
          isFatal: performanceData.isFatal,
          lastReviewDate: new Date().toLocaleString(),
          reviewerId: performanceData.reviewerId
        });
      }

      static getPerformanceScores() {
        return JSON.parse(localStorage.getItem('gojira_performance_scores') || '[]');
      }

      static deletePerformanceScore(scoreId) {
        const scores = this.getPerformanceScores();
        const scoreToDelete = scores.find(s => s.id == scoreId);

        if (scoreToDelete) {
          // Remove the score
          const updatedScores = scores.filter(s => s.id != scoreId);
          localStorage.setItem('gojira_performance_scores', JSON.stringify(updatedScores));

          // Check if this was the agent's most recent score
          const agentScores = updatedScores.filter(s => s.agentId === scoreToDelete.agentId);
          if (agentScores.length === 0) {
            // No more scores for this agent, remove their performance record
            const performanceDb = JSON.parse(localStorage.getItem('gojira_performance') || '{}');
            delete performanceDb[scoreToDelete.agentId];
            localStorage.setItem('gojira_performance', JSON.stringify(performanceDb));
          } else {
            // Update with the most recent remaining score
            const latestScore = agentScores.reduce((latest, current) =>
              new Date(current.timestamp) > new Date(latest.timestamp) ? current : latest
            );
            this.savePerformance(scoreToDelete.agentId, {
              score: latestScore.score,
              isFatal: latestScore.isFatal,
              lastReviewDate: new Date(latestScore.timestamp).toLocaleString(),
              reviewerId: latestScore.reviewerId
            });
          }
        }
      }

      static clearAllPerformanceData() {
        // Clear all performance scores history
        localStorage.removeItem('gojira_performance_scores');
        // Clear all current performance records
        localStorage.removeItem('gojira_performance');
      }
    }

    // ADMIN & AGENT FUNCTIONS
    function renderAdminDashboard() {
      // This function is called to refresh UI after operations
      // It should use adminLoadAgents() instead to maintain consistency
      adminLoadAgents();

      // Populate Performance Reviews Table
      const reviews = MockBackend.getPerformanceScores();
      const reviewsList = document.getElementById('admin-reviews-list');
      if (reviewsList) {
        if (reviews.length === 0) {
          reviewsList.innerHTML = '<tr><td colspan="6" class="p-6 text-center text-slate-400">No performance reviews yet.</td></tr>';
        } else {
          reviewsList.innerHTML = reviews.map(r => {
            const agent = USER_DB.find(u => u.id === r.agentId);
            const agentName = agent ? agent.name : r.agentId;
            const scoreClass = r.score === 100 ? 'text-emerald-600' : 'text-red-600';
            const scoreText = r.score === 0 ? '0 (Fatal)' : r.score;
            const date = new Date(r.timestamp).toLocaleString();

            return `
              <tr class="hover:bg-slate-50 dark:hover:bg-slate-700/50">
                <td class="p-6">${date}</td>
                <td class="p-6">${agentName}</td>
                <td class="p-6"><span class="${scoreClass} font-bold">${scoreText}</span></td>
                <td class="p-6">--</td>
                <td class="p-6">${r.feedbackData.fileName}</td>
                <td class="p-6 text-right">
                  <button onclick="viewReviewDetails(${r.id})" class="text-blue-600 hover:text-blue-800 mr-2">View</button>
                  <button onclick="handleDeleteReview(${r.id})" class="text-red-600 hover:text-red-800">Delete</button>
                </td>
              </tr>
            `;
          }).join('');
        }
      }

      // Populate Comments Table
      const comments = MockBackend.getComments();
      const commentsList = document.getElementById('admin-comments-list');
      if (commentsList) {
        if (comments.length === 0) {
          commentsList.innerHTML = '<tr><td colspan="4" class="p-6 text-center text-slate-400">No comments yet.</td></tr>';
        } else {
          commentsList.innerHTML = comments.map(c => `
            <tr class="hover:bg-slate-50 dark:hover:bg-slate-700/50">
              <td class="p-6">${c.date}</td>
              <td class="p-6">${USER_DB.find(u => u.id === c.agentId)?.name || c.agentId}</td>
              <td class="p-6">${c.text}</td>
              <td class="p-6 text-right">
                <button onclick="handleDeleteComment(${c.id})" class="text-red-600 hover:text-red-800">Delete</button>
              </td>
            </tr>
          `).join('');
        }
      }
    }

    // NEW WORKFLOW FUNCTIONS
    let selectedAgentForReview = null;
    let selectedFileForReview = null;
    let selectedProcessType = null;

    function onAgentSelected() {
      const agentSelector = document.getElementById('agent-selector');
      const selectedAgentId = agentSelector.value;

      if (selectedAgentId) {
        selectedAgentForReview = USER_DB.find(u => u.id === selectedAgentId);
        if (selectedAgentForReview) {
          // Show agent details section and populate it
          document.getElementById('admin-agent-list-section').classList.remove('hidden');
          document.getElementById('selected-agent-display-name').innerText = selectedAgentForReview.name;

          // Populate agent details
          const agentListContainer = document.getElementById('admin-agent-list');
          const perf = MockBackend.getPerformance(selectedAgentForReview.id);
          const pendingReviews = getPendingReviews(selectedAgentForReview.id);
          const scoreClass = perf ? (perf.score >= 90 ? 'text-emerald-500' : 'text-red-500') : 'text-slate-300';
          const scoreText = perf ? perf.score + '%' : 'Not Scored';

          const reviewStatus = pendingReviews.length === 0
            ? 'No reviews in progress'
            : pendingReviews.length >= 3
              ? 'Ready for final submission'
              : `${pendingReviews.length}/3 reviews completed`;

          const buttonText = pendingReviews.length >= 3
            ? 'Complete Final Submission'
            : pendingReviews.length === 0
              ? 'Start Quality Review'
              : `Continue Review (${pendingReviews.length}/3)`;

          // Check if this agent is finalized for the current week
          const state = getEntityWeekState(adminCurrentEntity || 'ALL');
          const currentWeek = state.currentWeek || 1;
          const finalized = state.completedAgents && state.completedAgents[currentWeek] && state.completedAgents[currentWeek][selectedAgentForReview.id];
          const finalizedBadge = finalized ? `<div class="text-sm text-emerald-600 font-semibold">Finalized Week ${currentWeek} ‚úÖ</div>` : '';

          const buttonAction = pendingReviews.length >= 3
            ? 'showFinalSubmissionOptionForSelectedAgent()'
            : 'startQualityReview()';

          agentListContainer.innerHTML = `
            <div class="bg-white dark:bg-slate-700 p-6 rounded-2xl border border-slate-200 dark:border-slate-600">
               <div class="flex items-center justify-between mb-4">
                  <div>
                     <h4 class="font-bold text-slate-700 dark:text-slate-200 text-xl">${selectedAgentForReview.name}</h4>
                     ${finalizedBadge}
                     <p class="text-sm text-slate-500 font-mono">${selectedAgentForReview.id}</p>
                     <p class="text-xs text-slate-400 mt-1">Entity: ${selectedAgentForReview.entity}</p>
                     <p class="text-xs text-blue-600 mt-1 font-medium">${reviewStatus}</p>
                  </div>
                  <div class="text-right">
                     <div class="font-black ${scoreClass} text-2xl">${scoreText}</div>
                     <div class="text-xs text-slate-400 uppercase">Current Score</div>
                  </div>
               </div>

               <!-- Replaced inline process selection with modal-driven process selector -->
               <div class="flex gap-3">
                  <button onclick="document.getElementById('agent-process-modal').classList.remove('hidden')" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-xl hover:bg-blue-700 transition" id="start-review-btn">
                     ${buttonText}
                  </button>
                  <button onclick="clearAgentSelection()" class="bg-slate-500 text-white font-medium py-2 px-4 rounded-xl hover:bg-slate-600 transition">
                     Clear Selection
                  </button>
               </div>
            </div>
          `;

          // Auto-open the admin review type modal when an agent is selected from the list
          try {
            const modalName = document.getElementById('review-type-agent-name');
            if (modalName) modalName.textContent = selectedAgentForReview.name;
            document.getElementById('admin-review-type-modal').classList.remove('hidden');
          } catch (e) {
            /* ignore if modal not present */
          }
        }
      } else {
        // Hide agent details section if no agent selected
        document.getElementById('admin-agent-list-section').classList.add('hidden');
        selectedAgentForReview = null;
        clearAgentSelection();
      }
    }

    function selectProcessType(processType) {
      selectedProcessType = processType;

      // Update button styles to show selection
      const voiceBtn = document.getElementById('voice-btn');
      const nonVoiceBtn = document.getElementById('non-voice-btn');
      const startBtn = document.getElementById('start-review-btn');

      if (processType === 'voice') {
        voiceBtn.classList.add('border-blue-500', 'bg-blue-50', 'dark:bg-blue-900/20');
        voiceBtn.classList.remove('border-slate-200', 'dark:border-slate-600');
        nonVoiceBtn.classList.remove('border-green-500', 'bg-green-50', 'dark:bg-green-900/20');
        nonVoiceBtn.classList.add('border-slate-200', 'dark:border-slate-600');
      } else {
        nonVoiceBtn.classList.add('border-green-500', 'bg-green-50', 'dark:bg-green-900/20');
        nonVoiceBtn.classList.remove('border-slate-200', 'dark:border-slate-600');
        voiceBtn.classList.remove('border-blue-500', 'bg-blue-50', 'dark:bg-blue-900/20');
        voiceBtn.classList.add('border-slate-200', 'dark:border-slate-600');
      }

      // Enable start review button
      startBtn.disabled = false;
      startBtn.classList.remove('opacity-50', 'cursor-not-allowed');
    }

    function startQualityReview() {
      if (selectedAgentForReview && selectedProcessType) {
        // Hide agent details, show file selection section
        document.getElementById('admin-agent-list-section').classList.add('hidden');
        document.getElementById('file-selection-section').classList.remove('hidden');

        // Set agent info in file selection section
        document.getElementById('selected-agent-name-file').innerText = selectedAgentForReview.name;
        document.getElementById('selected-agent-id-file').innerText = selectedAgentForReview.id;
        document.getElementById('selected-process-type').innerText = selectedProcessType === 'voice' ? 'Voice' : 'Non-Voice';
      }
    }

    function clearAgentSelection() {
      // Reset agent selector
      document.getElementById('agent-selector').value = '';
      // Hide all workflow sections
      document.getElementById('admin-agent-list-section').classList.add('hidden');
      document.getElementById('file-selection-section').classList.add('hidden');
      document.getElementById('feedback-form-section').classList.add('hidden');
      document.getElementById('scoring-section').classList.add('hidden');
      // Clear selections
      selectedAgentForReview = null;
      selectedFileForReview = null;
      selectedProcessType = null;
      localStorage.removeItem('currentQualityFeedback');
    }

    function proceedToFeedback() {
      const fileInput = document.getElementById('quality-feedback-file');

      if (!fileInput.files[0]) {
        alert('Please select a file for quality review.');
        return;
      }

      selectedFileForReview = fileInput.files[0];

      // Hide file selection, show feedback form
      document.getElementById('file-selection-section').classList.add('hidden');
      document.getElementById('feedback-form-section').classList.remove('hidden');

      // Set agent and file info in feedback section
      document.getElementById('selected-agent-name-feedback').innerText = selectedAgentForReview.name;
      document.getElementById('selected-agent-id-feedback').innerText = selectedAgentForReview.id;
      document.getElementById('selected-process-feedback').innerText = selectedProcessType === 'voice' ? 'Voice' : 'Non-Voice';
      document.getElementById('selected-process-feedback-display').innerText = selectedProcessType === 'voice' ? 'Voice' : 'Non-Voice';
      document.getElementById('selected-file-name').innerText = selectedFileForReview.name;
    }

    function backToFileSelection() {
      // Hide feedback form, show file selection
      document.getElementById('feedback-form-section').classList.add('hidden');
      document.getElementById('file-selection-section').classList.remove('hidden');
    }

    function submitFeedbackAndProceed() {
      const feedback = document.getElementById('feedback-observations').value.trim();


      if (!feedback) {
        alert('Please provide feedback and observations.');
        return;
      }

      // Store feedback data temporarily
      const feedbackData = {
        agentId: selectedAgentForReview.id,
        file: selectedFileForReview,
        processType: selectedProcessType,
        // interactionType: removed
        feedback: feedback,
        timestamp: new Date().toISOString()
      };

      // Store in localStorage for now
      localStorage.setItem('currentQualityFeedback', JSON.stringify({
        ...feedbackData,
        fileName: selectedFileForReview.name
      }));

      // Hide feedback form, show additional feedback section
      document.getElementById('feedback-form-section').classList.add('hidden');
      document.getElementById('additional-feedback-section').classList.remove('hidden');

      // Set agent info in additional feedback section
      document.getElementById('selected-agent-name-additional').innerText = selectedAgentForReview.name;
      document.getElementById('selected-agent-id-additional').innerText = selectedAgentForReview.id;
      document.getElementById('process-type-additional').innerText = selectedProcessType === 'voice' ? 'Voice' : 'Non-Voice';
      document.getElementById('process-type-additional').innerText = selectedProcessType === 'voice' ? 'Voice' : 'Non-Voice';
      // Interaction Type removed
      document.getElementById('interaction-type-additional').parentElement.classList.add('hidden'); // Hide the interaction type line
      document.getElementById('primary-feedback-display').innerText = feedback;

      // Initialize with 3 default feedback items
      initializeAdditionalFeedback();
    }

    function initializeAdditionalFeedback() {
      // The HTML already has 3 default feedback items
      // Just update the count and ensure proper button states
      updateFeedbackCount();

      // Ensure the first 3 items have disabled remove buttons
      const container = document.getElementById('additional-feedback-container');
      const feedbackItems = container.querySelectorAll('.feedback-item');
      feedbackItems.forEach((item, index) => {
        const removeBtn = item.querySelector('button[onclick*="removeFeedbackItem"]');
        if (index < 3) {
          removeBtn.disabled = true;
          removeBtn.classList.add('opacity-50');
        } else {
          removeBtn.disabled = false;
          removeBtn.classList.remove('opacity-50');
        }
      });
    }

    function backToFeedbackForm() {
      // Hide additional feedback, show feedback form
      document.getElementById('additional-feedback-section').classList.add('hidden');
      document.getElementById('feedback-form-section').classList.remove('hidden');
    }

    function addFeedbackItem() {
      const container = document.getElementById('additional-feedback-container');
      const feedbackItems = container.querySelectorAll('.feedback-item');
      const count = feedbackItems.length;

      if (count >= 10) {
        alert('Maximum 10 feedback items allowed.');
        return;
      }

      const newItem = document.createElement('div');
      newItem.className = 'feedback-item mb-3 p-4 bg-white dark:bg-slate-700 rounded-xl border border-slate-200 dark:border-slate-600';
      newItem.innerHTML = `
        <div class="flex items-center justify-between mb-2">
          <label class="text-sm font-medium">Feedback Item ${count + 1}</label>
          <button onclick="removeFeedbackItem(this)" class="text-red-500 hover:text-red-700 text-sm">Remove</button>
        </div>
        <input type="text" placeholder="Enter additional feedback point..." class="w-full px-3 py-2 rounded-lg border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-700 focus:ring-2 focus:ring-purple-500 outline-none">
      `;

      container.appendChild(newItem);
      updateFeedbackCount();

      // Disable add button if at max
      if (count + 1 >= 10) {
        document.getElementById('add-feedback-btn').disabled = true;
        document.getElementById('add-feedback-btn').classList.add('opacity-50', 'cursor-not-allowed');
      }

      // Update remove button states for all items
      const allItems = container.querySelectorAll('.feedback-item');
      allItems.forEach((item, index) => {
        const removeBtn = item.querySelector('button[onclick*="removeFeedbackItem"]');
        if (index < 3) {
          removeBtn.disabled = true;
          removeBtn.classList.add('opacity-50');
        } else {
          removeBtn.disabled = false;
          removeBtn.classList.remove('opacity-50');
        }
      });
    }

    function removeFeedbackItem(button) {
      const container = document.getElementById('additional-feedback-container');
      const feedbackItems = container.querySelectorAll('.feedback-item');
      const count = feedbackItems.length;

      if (count <= 3) {
        alert('Minimum 3 feedback items required.');
        return;
      }

      button.closest('.feedback-item').remove();
      updateFeedbackCount();

      // Re-enable add button if below max
      document.getElementById('add-feedback-btn').disabled = false;
      document.getElementById('add-feedback-btn').classList.remove('opacity-50', 'cursor-not-allowed');

      // Renumber remaining items and update remove button states
      const remainingItems = container.querySelectorAll('.feedback-item');
      remainingItems.forEach((item, index) => {
        const label = item.querySelector('label');
        label.textContent = `Feedback Item ${index + 1}`;

        const removeBtn = item.querySelector('button[onclick*="removeFeedbackItem"]');
        if (index < 3) {
          removeBtn.disabled = true;
          removeBtn.classList.add('opacity-50');
        } else {
          removeBtn.disabled = false;
          removeBtn.classList.remove('opacity-50');
        }
      });
    }

    function updateFeedbackCount() {
      const container = document.getElementById('additional-feedback-container');
      const count = container.querySelectorAll('.feedback-item').length;
      document.getElementById('feedback-count').textContent = count;
    }

    function submitAdditionalFeedback() {
      const container = document.getElementById('additional-feedback-container');
      const feedbackInputs = container.querySelectorAll('.feedback-item input');
      const additionalFeedback = [];

      // Validate minimum 3 items
      if (feedbackInputs.length < 3) {
        alert('Minimum 3 feedback items required.');
        return;
      }

      // Collect feedback items
      feedbackInputs.forEach(input => {
        const value = input.value.trim();
        if (value) {
          additionalFeedback.push(value);
        }
      });

      // Validate that we have at least 3 non-empty items
      if (additionalFeedback.length < 3) {
        alert('Please fill in at least 3 feedback items.');
        return;
      }

      // Get existing feedback data and add additional feedback
      const existingData = JSON.parse(localStorage.getItem('currentQualityFeedback'));
      existingData.additionalFeedback = additionalFeedback;

      // Update localStorage
      localStorage.setItem('currentQualityFeedback', JSON.stringify(existingData));

      // Hide additional feedback, show scoring section
      document.getElementById('additional-feedback-section').classList.add('hidden');
      document.getElementById('scoring-section').classList.remove('hidden');

      // Set agent info in scoring section
      document.getElementById('selected-agent-name-scoring').innerText = selectedAgentForReview.name;
      document.getElementById('selected-agent-id-scoring').innerText = selectedAgentForReview.id;
      document.getElementById('process-type-display').innerText = existingData.processType === 'voice' ? 'Voice' : 'Non-Voice';
      document.getElementById('process-type-display').innerText = existingData.processType === 'voice' ? 'Voice' : 'Non-Voice';
      // document.getElementById('interaction-type-display').innerText = existingData.interactionType... removed;
      document.getElementById('interaction-type-display').parentElement.classList.add('hidden');
      document.getElementById('scoring-file-name').innerText = existingData.fileName;
      document.getElementById('feedback-display').innerText = existingData.feedback;

      // Update Submit Button State
      const pendingReviews = getPendingReviews(selectedAgentForReview.id);
      const currentCount = pendingReviews.length;
      const finalSubmitBtn = document.getElementById('final-submit-btn');
      const addReviewBtn = document.getElementById('add-review-btn');

      // We are working on the next review (currentCount + 1)
      const potentialTotal = currentCount + 1;

      if (potentialTotal >= 3) {
        finalSubmitBtn.disabled = false;
        finalSubmitBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        finalSubmitBtn.innerHTML = `Submit Final Reviews (${potentialTotal})`;
      } else {
        finalSubmitBtn.disabled = true;
        finalSubmitBtn.classList.add('opacity-50', 'cursor-not-allowed');
        finalSubmitBtn.innerHTML = `Submit Final Reviews (Need ${3 - potentialTotal} more)`;
      }

      // Check max limit for Add More
      if (potentialTotal >= 10) {
        addReviewBtn.disabled = true;
        addReviewBtn.classList.add('opacity-50', 'cursor-not-allowed');
        addReviewBtn.innerText = "Max Reviews Reached";
      } else {
        addReviewBtn.disabled = false;
        addReviewBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        addReviewBtn.innerText = "Add more quality review";
      }
    }

    function backToFeedback() {
      // Hide scoring, show feedback form
      document.getElementById('scoring-section').classList.add('hidden');
      document.getElementById('feedback-form-section').classList.remove('hidden');
    }

    function restoreAdditionalFeedback(feedbackItems) {
      const container = document.getElementById('additional-feedback-container');
      container.innerHTML = ''; // Clear existing

      feedbackItems.forEach((item, index) => {
        const newItem = document.createElement('div');
        newItem.className = 'feedback-item mb-3 p-4 bg-white dark:bg-slate-700 rounded-xl border border-slate-200 dark:border-slate-600';
        const isDisabled = index < 3;
        newItem.innerHTML = `
          <div class="flex items-center justify-between mb-2">
            <label class="text-sm font-medium">Feedback Item ${index + 1}</label>
            <button onclick="removeFeedbackItem(this)" class="text-red-500 hover:text-red-700 text-sm ${isDisabled ? 'opacity-50' : ''}" ${isDisabled ? 'disabled' : ''}>Remove</button>
          </div>
          <input type="text" value="${item}" placeholder="Enter additional feedback point..." class="w-full px-3 py-2 rounded-lg border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-700 focus:ring-2 focus:ring-purple-500 outline-none">
        `;

        container.appendChild(newItem);
      });

      updateFeedbackCount();

      // Update add button state
      const count = feedbackItems.length;
      const addBtn = document.getElementById('add-feedback-btn');
      if (count >= 10) {
        addBtn.disabled = true;
        addBtn.classList.add('opacity-50', 'cursor-not-allowed');
      } else {
        addBtn.disabled = false;
        addBtn.classList.remove('opacity-50', 'cursor-not-allowed');
      }
    }

    function submitPerformanceScore(isFinal = false) {
      const score = document.querySelector('input[name="performance-score"]:checked');

      if (!score) {
        alert('Please select a performance score.');
        return;
      }

      const feedbackData = JSON.parse(localStorage.getItem('currentQualityFeedback'));
      if (!feedbackData) {
        alert('No feedback data found. Please restart the process.');
        return;
      }

      // Save this review to pending reviews for the agent
      const reviewData = {
        agentId: selectedAgentForReview.id,
        score: parseInt(score.value),
        isFatal: score.value === '0',
        feedbackData: feedbackData,
        timestamp: new Date().toISOString(),
        reviewerId: currentUser.id,
        fileName: feedbackData.fileName
      };

      savePendingReview(reviewData);

      // Clear temporary data
      localStorage.removeItem('currentQualityFeedback');

      // Check agent review count
      const pendingReviews = getPendingReviews(selectedAgentForReview.id);

      if (isFinal) {
        if (pendingReviews.length < 3) {
          alert(`Minimum 3 reviews required. Currently: ${pendingReviews.length}`);
          return;
        }
        showFinalSubmissionOption(selectedAgentForReview.id);
      } else {
        // Add more review
        if (pendingReviews.length >= 10) {
          alert('Maximum 10 reviews reached. Please submit final.');
          // Maybe force final?
          showFinalSubmissionOption(selectedAgentForReview.id);
          return;
        }

        // Reset workflow for next review
        resetForNextReview();
        alert(`Review saved. Total pending: ${pendingReviews.length}. You can add more or submit final.`);
      }
    }

    function savePendingReview(reviewData) {
      const pendingReviews = JSON.parse(localStorage.getItem('pending_agent_reviews') || '{}');
      if (!pendingReviews[reviewData.agentId]) {
        pendingReviews[reviewData.agentId] = [];
      }
      pendingReviews[reviewData.agentId].push(reviewData);
      localStorage.setItem('pending_agent_reviews', JSON.stringify(pendingReviews));
    }

    function getPendingReviews(agentId) {
      const pendingReviews = JSON.parse(localStorage.getItem('pending_agent_reviews') || '{}');
      return pendingReviews[agentId] || [];
    }

    function showFinalSubmissionOption(agentId) {
      const pendingReviews = getPendingReviews(agentId);
      const agent = USER_DB.find(u => u.id === agentId);

      // Hide current workflow sections
      document.getElementById('scoring-section').classList.add('hidden');

      // Show final submission section
      const finalSection = document.getElementById('final-submission-section');
      if (!finalSection) {
        // Create the final submission section
        createFinalSubmissionSection();
      }

      document.getElementById('final-submission-section').classList.remove('hidden');

      // Populate final submission data
      document.getElementById('final-agent-name').innerText = agent.name;
      document.getElementById('final-agent-id').innerText = agent.id;

      // Calculate average score
      const totalScore = pendingReviews.reduce((sum, review) => sum + review.score, 0);
      const averageScore = Math.round(totalScore / pendingReviews.length);
      document.getElementById('final-average-score').innerText = averageScore;

      // Show review summary
      const reviewSummary = document.getElementById('final-review-summary');
      reviewSummary.innerHTML = '';
      pendingReviews.forEach((review, index) => {
        const reviewDiv = document.createElement('div');
        reviewDiv.className = 'p-3 bg-slate-50 dark:bg-slate-700 rounded-lg mb-2';
        reviewDiv.innerHTML = `
          <div class="flex justify-between items-center">
            <span class="font-medium">Review ${index + 1}</span>
            <span class="text-sm text-slate-500">${new Date(review.timestamp).toLocaleDateString()}</span>
          </div>
          <div class="text-sm text-slate-600 dark:text-slate-300 mt-1">
            Process: ${review.processType === 'voice' ? 'Voice' : 'Non-Voice'} | File: ${review.fileName} | Score: ${review.score}/100
          </div>
        `;
        reviewSummary.appendChild(reviewDiv);
      });
    }

    function createFinalSubmissionSection() {
      const section = document.createElement('div');
      section.id = 'final-submission-section';
      section.className = 'hidden bg-green-50 dark:bg-slate-800 p-8 rounded-3xl mb-12 border border-green-200 dark:border-slate-700';

      section.innerHTML = `
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-2xl font-bold flex items-center gap-3">
            <span class="bg-green-600 text-white rounded-lg p-2 text-xl">‚úÖ</span>
            Final Performance Submission for <span id="final-agent-name" class="text-green-600"></span>
          </h2>
          <button onclick="cancelReviewProcess()" class="text-slate-500 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-200 text-sm font-medium">
            Cancel Process
          </button>
        </div>

        <div class="mb-6 p-4 bg-white dark:bg-slate-700 rounded-xl border border-slate-200 dark:border-slate-600">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm text-slate-600 dark:text-slate-300">
            <div><strong>Agent ID:</strong> <span id="final-agent-id" class="font-mono"></span></div>
            <div><strong>Average Score:</strong> <span id="final-average-score" class="font-bold text-green-600"></span>/100</div>
          </div>
        </div>

        <div class="mb-6">
          <h3 class="text-lg font-semibold mb-4">Review Summary (3 Reviews Completed)</h3>
          <div id="final-review-summary" class="space-y-2">
            <!-- Review summaries will be populated here -->
          </div>
        </div>

        <div class="mb-6 p-4 bg-yellow-50 dark:bg-slate-700 rounded-xl border border-yellow-200 dark:border-slate-600">
          <p class="text-sm text-yellow-800 dark:text-yellow-200">
            <strong>Note:</strong> This will calculate the final performance score based on the average of all 3 reviews and update the agent's performance record.
          </p>
        </div>

        <button onclick="submitFinalPerformanceScore()"
          class="bg-green-600 text-white font-bold py-3 px-8 rounded-xl hover:bg-green-700 transition shadow-lg shadow-green-500/30">
          Submit Final Performance Score
        </button>
      `;

      // Insert after the scoring section
      const scoringSection = document.getElementById('scoring-section');
      scoringSection.parentNode.insertBefore(section, scoringSection.nextSibling);
    }

    function submitFinalPerformanceScore() {
      const agentId = document.getElementById('final-agent-id').innerText;
      const pendingReviews = getPendingReviews(agentId);

      if (pendingReviews.length < 3) {
        alert('Minimum 3 reviews required before final submission.');
        return;
      }

      // Calculate final score (average of all reviews)
      const totalScore = pendingReviews.reduce((sum, review) => sum + review.score, 0);
      const finalScore = Math.round(totalScore / pendingReviews.length);

      // Check if any review was fatal (score = 0)
      const hasFatal = pendingReviews.some(review => review.isFatal);

      // Save the final performance score
      const performanceData = {
        agentId: agentId,
        score: finalScore,
        isFatal: hasFatal,
        feedbackData: { reviews: pendingReviews }, // Store all reviews
        timestamp: new Date().toISOString(),
        reviewerId: currentUser.id
      };

      MockBackend.savePerformanceScore(performanceData);

      // Mark this agent as completed for the current week
      markAgentWeekComplete(adminCurrentEntity || currentEntity || 'ALL', agentId);

      // Clear pending reviews for this agent
      const allPending = JSON.parse(localStorage.getItem('pending_agent_reviews') || '{}');
      delete allPending[agentId];
      localStorage.setItem('pending_agent_reviews', JSON.stringify(allPending));

      // Reset workflow
      document.getElementById('final-submission-section').classList.add('hidden');
      document.getElementById('admin-agent-list-section').classList.add('hidden');

      // Reset selections
      selectedAgentForReview = null;
      selectedFileForReview = null;
      document.getElementById('agent-selector').value = '';

      // Refresh dashboard
      renderAdminDashboard();
      adminLoadAgents();
      checkAndEnableWeekFinalButton();

      alert(`Final performance score (${finalScore}/100) submitted successfully for agent!`);
    }

    function showFinalSubmissionOptionForSelectedAgent() {
      if (selectedAgentForReview) {
        showFinalSubmissionOption(selectedAgentForReview.id);
      }
    }

    function cancelReviewProcess() {
      // Clear any temporary data
      localStorage.removeItem('currentQualityFeedback');

      // If there's a selected agent with pending reviews, ask if they want to clear them
      if (selectedAgentForReview) {
        const pendingReviews = getPendingReviews(selectedAgentForReview.id);
        if (pendingReviews.length > 0) {
          const clearPending = confirm(`This agent has ${pendingReviews.length} pending review(s). Do you want to clear all pending reviews for this agent?`);
          if (clearPending) {
            const allPending = JSON.parse(localStorage.getItem('pending_agent_reviews') || '{}');
            delete allPending[selectedAgentForReview.id];
            localStorage.setItem('pending_agent_reviews', JSON.stringify(allPending));
          }
        }
      }

      selectedAgentForReview = null;
      selectedFileForReview = null;

      // Reset to agent selection view (hide all workflow sections)
      document.getElementById('file-selection-section').classList.add('hidden');
      document.getElementById('feedback-form-section').classList.add('hidden');
      document.getElementById('additional-feedback-section').classList.add('hidden');
      document.getElementById('scoring-section').classList.add('hidden');
      document.getElementById('final-submission-section').classList.add('hidden');
      document.getElementById('admin-agent-list-section').classList.add('hidden');

      // Reset agent selector
      document.getElementById('agent-selector').value = '';

      // Refresh dashboard to update agent statuses
      renderAdminDashboard();
    }

    function resetForNextReview() {
      // Hide scoring section
      document.getElementById('scoring-section').classList.add('hidden');

      // Reset to file selection for next review
      document.getElementById('file-selection-section').classList.remove('hidden');

      // Clear file selection
      selectedFileForReview = null;
      const fileInput = document.getElementById('quality-feedback-file');
      if (fileInput) fileInput.value = '';

      document.getElementById('selected-file-name').innerText = 'No file selected';

      // Reset Feedback Form
      document.getElementById('feedback-observations').value = '';

      // Reset Additional Feedback Section to default 3 items
      const container = document.getElementById('additional-feedback-container');
      container.innerHTML = `
        <div class="feedback-item mb-3 p-4 bg-white dark:bg-slate-700 rounded-xl border border-slate-200 dark:border-slate-600">
          <div class="flex items-center justify-between mb-2">
            <label class="text-sm font-medium">Feedback Item 1</label>
            <button onclick="removeFeedbackItem(this)" class="text-red-500 hover:text-red-700 text-sm opacity-50" disabled>Remove</button>
          </div>
          <input type="text" placeholder="Enter additional feedback point..." class="w-full px-3 py-2 rounded-lg border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-700 focus:ring-2 focus:ring-purple-500 outline-none">
        </div>
        <div class="feedback-item mb-3 p-4 bg-white dark:bg-slate-700 rounded-xl border border-slate-200 dark:border-slate-600">
          <div class="flex items-center justify-between mb-2">
            <label class="text-sm font-medium">Feedback Item 2</label>
            <button onclick="removeFeedbackItem(this)" class="text-red-500 hover:text-red-700 text-sm opacity-50" disabled>Remove</button>
          </div>
          <input type="text" placeholder="Enter additional feedback point..." class="w-full px-3 py-2 rounded-lg border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-700 focus:ring-2 focus:ring-purple-500 outline-none">
        </div>
        <div class="feedback-item mb-3 p-4 bg-white dark:bg-slate-700 rounded-xl border border-slate-200 dark:border-slate-600">
          <div class="flex items-center justify-between mb-2">
            <label class="text-sm font-medium">Feedback Item 3</label>
            <button onclick="removeFeedbackItem(this)" class="text-red-500 hover:text-red-700 text-sm opacity-50" disabled>Remove</button>
          </div>
          <input type="text" placeholder="Enter additional feedback point..." class="w-full px-3 py-2 rounded-lg border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-700 focus:ring-2 focus:ring-purple-500 outline-none">
        </div>
      `;
      updateFeedbackCount();
      document.getElementById('add-feedback-btn').disabled = false;
      document.getElementById('add-feedback-btn').classList.remove('opacity-50', 'cursor-not-allowed');

      // Reset Performance Score Radios
      const scoreRadios = document.getElementsByName('performance-score');
      scoreRadios.forEach(radio => radio.checked = false);
    }

    function calculateTotalScore() {
      const audit = parseInt(document.getElementById('indiv-score').value) || 0;
      const errors = parseInt(document.getElementById('indiv-errors').value);
      const compliance = parseInt(document.getElementById('indiv-compliance').value) || 0;

      const display = document.getElementById('calc-total-score');

      // Logic: 
      // If Fatal Error (1) -> Score 0
      // Else -> Average of Audit & Compliance? Or just Audit?
      // User said "choose the score 0 and hundred... automatically fetch total"
      // Let's assume strict compliance.

      let total = 0;

      if (document.getElementById('indiv-errors').value === "") {
        display.innerText = "--";
        return;
      }

      if (errors === 1) {
        total = 0;
      } else {
        // If no fatal errors
        // Using simple average for now, standard QA math
        total = (audit + compliance) / 2;
      }

      display.innerText = total + "%";
      if (total === 100) display.className = "text-2xl font-black text-emerald-500";
      else if (total === 0) display.className = "text-2xl font-black text-red-500";
      else display.className = "text-2xl font-black text-indigo-600";
    }

    function handleFileUpload() {
      const fileInput = document.getElementById('admin-file-upload');
      if (fileInput.files.length > 0) {
        const file = fileInput.files[0];

        // Read file content
        const reader = new FileReader();
        reader.onload = function (e) {
          const content = e.target.result;
          try {
            MockBackend.addReport(file, content);
            alert(`Successfully uploaded "${file.name}"`);
            renderAdminDashboard(); // Refresh UI
          } catch (err) {
            alert('Upload failed: File might be too large for browser storage.');
            console.error(err);
          }
        };
        reader.readAsDataURL(file);

        fileInput.value = ''; // Reset
      } else {
        alert('Please select a file first.');
      }
    }

    function handleDeleteReport(id) {
      if (confirm('Are you sure you want to delete this report? It will be removed for all agents.')) {
        MockBackend.deleteReport(id);
        renderAdminDashboard(); // Refresh
      }
    }

    function handleDeleteComment(id) {
      if (confirm('Are you sure you want to delete this comment?')) {
        MockBackend.deleteComment(id);
        renderAdminDashboard(); // Refresh
      }
    }

    function viewReviewDetails(reviewId) {
      const reviews = MockBackend.getPerformanceScores();
      const review = reviews.find(r => r.id == reviewId);

      if (review) {
        const agent = USER_DB.find(u => u.id === review.agentId);
        const agentName = agent ? agent.name : review.agentId;
        const date = new Date(review.timestamp).toLocaleString();

        const details = `
Review Details:
- Date: ${date}
- Agent: ${agentName} (${review.agentId})
- Score: ${review.score === 0 ? '0 (Fatal Error)' : review.score}
- Interaction Type: ${review.feedbackData.interactionType}
- File: ${review.feedbackData.fileName}
- Feedback: ${review.feedbackData.feedback}

Reviewer: ${review.reviewerId}
        `;

        alert(details);
      }
    }

    function resetAllPerformanceData() {
      if (confirm('Are you sure you want to reset ALL performance data? This will clear all reviews and scores for all agents. This action cannot be undone.')) {
        MockBackend.clearAllPerformanceData();
        renderAdminDashboard();
        alert('All performance data has been reset. All agents now show as "Not Scored".');
      }
    }

    function clearSelectedAgent() {
      selectedAgentForUpload = null;
      document.getElementById('indiv-agent-search').value = '';
      document.getElementById('indiv-agent-results').classList.add('hidden');
      document.getElementById('indiv-agent-selected').classList.add('hidden');
      document.getElementById('indiv-agent-selected').classList.remove('flex');
      document.getElementById('indiv-upload-form').classList.add('hidden');
      document.getElementById('indiv-score').value = '';
      document.getElementById('indiv-errors').value = '';
      document.getElementById('indiv-compliance').value = '';
      document.getElementById('calc-total-score').innerText = '--';
      document.getElementById('proof-audio').value = '';
      document.getElementById('proof-chat').value = '';
      document.getElementById('proof-email').value = '';
    }

    function renderAgentDashboard() {
      if (currentUser) {
        document.getElementById('agent-name-display').innerText = currentUser.name;
      }
    }

    function openAgentPerformanceModal() {
      if (!currentUser) return;
      const modal = document.getElementById('agent-performance-modal');
      const contentLoaded = document.getElementById('perf-content-loaded');
      const contentEmpty = document.getElementById('perf-content-empty');

      document.getElementById('modal-agent-id').innerText = `ID: ${currentUser.id}`;
      modal.classList.remove('hidden');

      const perfData = MockBackend.getPerformance(currentUser.id);

      if (perfData) {
        contentLoaded.classList.remove('hidden');
        contentEmpty.classList.add('hidden');

        // Populate Scores based on localStorage reviews (Primary Source)
        let reviews = JSON.parse(localStorage.getItem('adminReviews') || '[]');
        reviews = reviews.filter(r => r.agentId === currentUser.id);

        let totalScore = 0;
        let fatalCount = 0;
        let goodCount = 0;
        let avgScore = 0;

        if (reviews.length > 0) {
          reviews.forEach(r => {
            // Handle score parsing properly
            let s = parseInt(r.score);
            if (isNaN(s)) s = 0;

            totalScore += s;
            if (s === 0) fatalCount++;
            if (s === 100) goodCount++;
          });
          avgScore = Math.round(totalScore / reviews.length);
        } else {
          // Fallback to MockBackend logic if no reviews found
          const audit = parseInt(perfData.score) || 0;
          avgScore = audit;
        }

        document.getElementById('modal-audit-score').innerText = perfData.score; // Keep original Monthly? Or switch to count? User request ambiguous. Let's keep perfData for compliance/stats if consistent.
        // Actually, let's use the box for "No. of Audits" as per the new label in HTML?
        // HTML Line 1163: <p class="text-xs font-bold uppercase text-slate-400 mb-2">No. of Audits</p>
        // HTML ID: modal-audit-count. Wait, the JS below uses 'modal-audit-score'.
        // Let's check the view_file of openAgentPerformanceModal again.
        // It used document.getElementById('modal-audit-score').innerText = perfData.score;
        // BUT the HTML in view-performance (Line 1164) has id="modal-audit-count".
        // The previous JS snippet I viewed had `modal-audit-score` ???
        // Let's assume the ID in HTML is `modal-audit-count` per my view of line 1164.

        const countSpan = document.getElementById('modal-audit-count');
        if (countSpan) countSpan.innerText = reviews.length;

        document.getElementById('modal-fatal-count').innerText = fatalCount;
        document.getElementById('modal-good-count').innerText = goodCount;
        document.getElementById('modal-total-score').innerText = avgScore + '%';

        // Populate Reviews List
        const reviewsList = document.getElementById('modal-reviews-list');
        if (reviews.length > 0) {
          reviewsList.innerHTML = reviews.map(r => `
            <div class="bg-slate-50 dark:bg-slate-800 p-6 rounded-2xl border border-slate-200 dark:border-slate-700">
              <div class="flex justify-between items-start mb-4">
                <div>
                  <p class="text-sm text-slate-500">${r.date}</p>
                  <h4 class="font-bold text-lg">${r.fileName || 'Review'}</h4>
                  <p class="text-sm text-blue-600 underline cursor-pointer" onclick="openFileContent('${r.fileContent}', '${r.fileName}')">View File</p>
                </div>
                <div class="text-right">
                  <span class="inline-block px-3 py-1 rounded-full text-sm font-bold ${r.score == 100 ? 'bg-emerald-100 text-emerald-600' : 'bg-red-100 text-red-600'}">
                    Score: ${r.score}
                  </span>
                </div>
              </div>
              <div class="bg-white dark:bg-slate-900 p-4 rounded-xl border border-slate-100 dark:border-slate-800">
                 <p class="text-sm font-bold text-slate-500 mb-1">Observation:</p>
                 <p class="text-slate-700 dark:text-slate-300">${r.observation}</p>
              </div>
            </div>
          `).join('');
        } else {
          reviewsList.innerHTML = '<p class="text-center text-slate-500 italic">No reviews found.</p>';
        }

        // MockBackend Proofs (Preserved)
        const proofsList = document.getElementById('modal-proofs-list');
        if (perfData.proofs && perfData.proofs.length > 0) {
          proofsList.innerHTML = perfData.proofs.map(p => `
                <div class="flex items-center justify-between p-4 bg-white dark:bg-slate-700 rounded-xl border border-slate-200 dark:border-slate-600">
                   <div class="flex items-center gap-3">
                      <div class="w-10 h-10 rounded-full bg-slate-100 dark:bg-slate-600 flex items-center justify-center text-xl">${p.icon}</div>
                      <div>
                         <p class="font-bold text-sm text-slate-700 dark:text-slate-200">${p.name}</p>
                         <p class="text-[10px] text-slate-400 uppercase">${p.type.split('/')[1] || 'FILE'}</p>
                      </div>
                   </div>
                   <button onclick="openReport('${p.content}', '${p.type}')" class="bg-indigo-50 dark:bg-indigo-900/30 text-indigo-600 px-4 py-2 rounded-lg font-bold text-sm hover:bg-indigo-100 transition">View üëÅÔ∏è</button>
                </div>
             `).join('');
        } else {
          proofsList.innerHTML = '<p class="col-span-2 text-center text-slate-400 italic">No proofs attached.</p>';
        }

        // Check notifications on load
        checkAgentNotifications(false);

      } else {
        contentLoaded.classList.add('hidden');
        contentEmpty.classList.remove('hidden');
      }
    }

    function checkNotifications(showPopup) {
      if (!currentUser) return;

      const dot = document.querySelector('.notification-dot');

      if (currentUser.role === 'agent') {
        checkAgentNotifications(showPopup);
      } else if (currentUser.role === 'admin' || currentUser.role === 'reviewer') {
        checkAdminNotifications(showPopup);
      }
    }

    function getAgentSeenNotifications(agentId) {
      return JSON.parse(localStorage.getItem(`agentNotifications_${agentId}`) || '[]');
    }

    function markAgentSeenNotifications(agentId, ids) {
      const seen = new Set(getAgentSeenNotifications(agentId));
      ids.forEach(id => seen.add(id));
      localStorage.setItem(`agentNotifications_${agentId}`, JSON.stringify(Array.from(seen)));
    }

    function checkAgentNotifications(showPopup) {
      if (!currentUser || currentUser.role !== 'agent') return;

      let reviews = JSON.parse(localStorage.getItem('adminReviews') || '[]');
      const now = new Date();
      // Filter for this week (last 7 days) and current agent
      const oneWeekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);

      // Safe Trim Comparison
      const currentAgentId = String(currentUser.id).trim().toLowerCase();
      const agentReviews = reviews.filter(r => String(r.agentId).trim().toLowerCase() === currentAgentId);

      const recentReviews = agentReviews.filter(r => {
        // Try parsing ISO date first, then fallback
        let d = new Date(r.date);
        if (isNaN(d.getTime())) {
          // Fallback for older locale strings (MM/DD/YYYY or DD/MM/YYYY dependent on browser)
          // If we can't parse it, we might show it anyway if it's recent in the list?
          // But let's assume valid date.
          return false;
        }
        return d >= oneWeekAgo;
      });

      const seenIds = getAgentSeenNotifications(currentAgentId);
      const unseen = recentReviews.filter(r => !seenIds.includes(r.id));

      const dot = document.querySelector('.notification-dot');

      if (unseen.length > 0) {
        if (dot) dot.classList.remove('hidden');
        if (showPopup) {
          // Show all recent reviews but mark them as seen once shown
          showAgentNotifications(recentReviews);
          markAgentSeenNotifications(currentAgentId, recentReviews.map(r => r.id));
          if (dot) dot.classList.add('hidden');
        }
      } else {
        if (dot) dot.classList.add('hidden');
        if (showPopup) {
          showNotificationsModal([]);
        }
      }
    }

    function showAgentNotifications(reviews) {
      const notificationsList = document.getElementById('notifications-list');
      const notificationsEmpty = document.getElementById('notifications-empty');

      if (reviews.length === 0) {
        notificationsList.classList.add('hidden');
        notificationsEmpty.classList.remove('hidden');
      } else {
        notificationsList.classList.remove('hidden');
        notificationsEmpty.classList.add('hidden');

        notificationsList.innerHTML = reviews.map(review => {
          const displayDate = review.displayDate || review.date;
          return `
          <div class="bg-gradient-to-r from-purple-50 to-indigo-50 dark:from-slate-700 dark:to-slate-600 p-4 rounded-xl border border-purple-200 dark:border-slate-600 cursor-pointer hover:shadow-lg transition" onclick="agentViewNotificationReview('${review.id}')">
            <div class="flex items-start justify-between">
              <div class="flex-1">
                <h3 class="font-bold text-purple-900 dark:text-purple-200">Quality Review Received</h3>
                <p class="text-sm text-slate-600 dark:text-slate-400 mt-1">From: ${review.reviewerName || 'Quality Team'}</p>
                <p class="text-sm text-slate-600 dark:text-slate-400">Date: ${displayDate}</p>
                <p class="text-sm font-semibold mt-2">Score: <span class="text-indigo-600 dark:text-indigo-300">${review.score}</span></p>
              </div>
              <span class="bg-purple-600 text-white rounded-full w-8 h-8 flex items-center justify-center text-sm font-bold">‚Üí</span>
            </div>
          </div>
        `}).join('');
      }

      document.getElementById('notifications-modal').classList.remove('hidden');
      document.querySelector('.notification-dot').classList.add('hidden');
      // Mark reviews as seen for this agent when the modal is opened
      if (currentUser && currentUser.role === 'agent') {
        markAgentSeenNotifications(currentUser.id, reviews.map(r => r.id));
      }
    }

    function agentViewNotificationReview(reviewId) {
      const reviews = JSON.parse(localStorage.getItem('adminReviews') || '[]');
      const review = reviews.find(r => r.id === reviewId);
      if (review) {
        closeNotificationsModal();
        // Mark this review as seen for the agent
        if (currentUser && currentUser.role === 'agent') {
          markAgentSeenNotifications(currentUser.id, [reviewId]);
          const dot = document.querySelector('.notification-dot');
          if (dot) dot.classList.add('hidden');
        }

        // Navigate agent to QA dashboard and open the review detail
        navigateTo('view-agent-qa');
        // Ensure agent dashboard reloads
        setTimeout(() => {
          agentLoadQADashboard();
          setTimeout(() => {
            openReviewDetail(reviewId);
          }, 200);
        }, 200);
      }
    }

    function checkAdminNotifications(showPopup) {
      if (!currentUser || (currentUser.role !== 'admin' && currentUser.role !== 'reviewer')) return;

      const comments = JSON.parse(localStorage.getItem('reviewComments') || '[]');
      const adminNotifications = JSON.parse(localStorage.getItem('adminNotifications') || '[]');

      // Find new comments that haven't been seen by admin/reviewer
      const newComments = comments.filter(c => !adminNotifications.includes(c.id));

      const dot = document.querySelector('.notification-dot');

      if (newComments.length > 0) {
        dot.classList.remove('hidden');
        if (showPopup) {
          showAdminNotifications(newComments);
        }
      } else {
        dot.classList.add('hidden');
        if (showPopup) {
          showNotificationsModal([]);
        }
      }
    }

    function showAdminNotifications(comments) {
      const notificationsList = document.getElementById('notifications-list');
      const notificationsEmpty = document.getElementById('notifications-empty');
      const reviews = JSON.parse(localStorage.getItem('adminReviews') || '[]');

      if (comments.length === 0) {
        notificationsList.classList.add('hidden');
        notificationsEmpty.classList.remove('hidden');
      } else {
        notificationsList.classList.remove('hidden');
        notificationsEmpty.classList.add('hidden');

        notificationsList.innerHTML = comments.map(comment => {
          const review = reviews.find(r => r.id === comment.reviewId);
          return `
            <div class="bg-gradient-to-r from-orange-50 to-amber-50 dark:from-slate-700 dark:to-slate-600 p-4 rounded-xl border border-orange-200 dark:border-slate-600 cursor-pointer hover:shadow-lg transition" onclick="adminViewNotificationComment('${comment.reviewId}')">
              <div class="flex items-start justify-between">
                <div class="flex-1">
                  <h3 class="font-bold text-orange-900 dark:text-orange-200">${comment.authorName} commented on review</h3>
                  <p class="text-sm text-slate-600 dark:text-slate-400 mt-1">Review Date: ${comment.date}</p>
                  <p class="text-sm mt-2 text-slate-700 dark:text-slate-300 line-clamp-2">"${comment.text.substring(0, 80)}..."</p>
                </div>
                <span class="bg-orange-600 text-white rounded-full w-8 h-8 flex items-center justify-center text-sm font-bold">‚Üí</span>
              </div>
            </div>
          `;
        }).join('');

        // Mark all as seen
        const allCommentIds = comments.map(c => c.id);
        localStorage.setItem('adminNotifications', JSON.stringify(allCommentIds));
      }

      document.getElementById('notifications-modal').classList.remove('hidden');
      document.querySelector('.notification-dot').classList.add('hidden');
    }

    function adminViewNotificationComment(reviewId) {
      const reviews = JSON.parse(localStorage.getItem('adminReviews') || '[]');
      const review = reviews.find(r => r.id === reviewId);
      if (review) {
        closeNotificationsModal();

        // Mark the related comments as read for admin
        const adminNotifications = JSON.parse(localStorage.getItem('adminNotifications') || '[]');
        const comments = JSON.parse(localStorage.getItem('reviewComments') || '[]');
        const relatedCommentIds = comments.filter(c => c.reviewId === reviewId).map(c => c.id);
        relatedCommentIds.forEach(id => { if (!adminNotifications.includes(id)) adminNotifications.push(id); });
        localStorage.setItem('adminNotifications', JSON.stringify(adminNotifications));

        // Navigate to admin dashboard and focus the agent and review
        adminCurrentEntity = review.entity || adminCurrentEntity || 'ALL';
        adminCurrentAgent = review.agentId;
        adminCurrentAgentName = review.agentName;

        navigateTo('view-admin');
        adminLoadAgents();

        // Give DOM a moment to render and then load reviews and open the specific review
        setTimeout(() => {
          // Set selector to agent
          const sel = document.getElementById('admin-agent-selector');
          if (sel) sel.value = adminCurrentAgent;
          adminLoadReviewsList();

          // Find index in filtered reviews
          const filtered = JSON.parse(localStorage.getItem('adminReviews') || '[]').filter(r => r.entity === adminCurrentEntity && r.agentId === adminCurrentAgent);
          const index = filtered.findIndex(r => r.id === reviewId);
          if (index !== -1) {
            setTimeout(() => {
              adminViewReview(index);
            }, 100);
          } else {
            alert('The review referenced by this notification is not available.');
          }
        }, 200);
      }
    }

    function showAdminComments(reviewId) {
      const comments = JSON.parse(localStorage.getItem('reviewComments') || '[]').filter(c => c.reviewId === reviewId);
      if (comments.length === 0) {
        alert('No replies yet for this review.');
        return;
      }

      let commentsText = `Comments for the selected review:\n\n`;
      comments.forEach(c => {
        commentsText += `[${c.date}] ${c.authorName}:\n${c.text}\n\n`;
      });

      alert(commentsText);
    }

    function showNotificationsModal(notifications) {
      const notificationsList = document.getElementById('notifications-list');
      const notificationsEmpty = document.getElementById('notifications-empty');

      if (notifications.length === 0) {
        notificationsList.classList.add('hidden');
        notificationsEmpty.classList.remove('hidden');
      }

      document.getElementById('notifications-modal').classList.remove('hidden');
    }

    function closeNotificationsModal() {
      document.getElementById('notifications-modal').classList.add('hidden');
    }

    function closeAgentPerformanceModal() {
      document.getElementById('agent-performance-modal').classList.add('hidden');
    }

    // BULK PERFORMANCE MANAGER
    function openReport(content, type) {
      const win = window.open();
      if (win) {
        if (type.startsWith('image/')) {
          win.document.write(`<div style="display:flex;justify-content:center;align-items:center;height:100vh;background:#f0f0f0;"><img src="${content}" style="max-width:100%;max-height:100%;box-shadow:0 0 20px rgba(0,0,0,0.1);"></div>`);
        } else if (type === 'application/pdf') {
          win.document.write(`<embed width="100%" height="100%" src="${content}" type="application/pdf">`);
        } else {
          // Fallback for other types
          win.document.write(`<h2 style="font-family:sans-serif;text-align:center;padding:20px;">Preview not available for this file type. Please download to view.</h2><div style="text-align:center;"><a href="${content}" download="file" style="padding:10px 20px;background:#3b82f6;color:white;text-decoration:none;border-radius:5px;">Download File</a></div>`);
        }
        win.document.title = "View Report";
        win.document.close(); // Important for loading
      } else {
        alert('Pop-up blocked! Please allow pop-ups for this site to view reports.');
      }
    }

    function handleCommentSubmit() {
      const input = document.getElementById('agent-comment-input');
      const text = input.value.trim();

      if (!text) return alert('Please write a comment first.');
      if (!currentUser) return alert('You must be logged in.');

      MockBackend.addComment(text, currentUser.id);
      alert('Feedback sent to Admin successfully!');
      input.value = '';
    }

    function logout() {
      currentUser = null;
      navigateTo('view-home');
    }

    // ===== AGENT QUALITY ASSURANCE FUNCTIONS =====
    function agentLoadQADashboard() {
      if (!currentSessionUser || currentSessionUser.role !== 'agent') {
        return; // Only for agents
      }

      const agentId = String(currentSessionUser.id).trim().toLowerCase(); // Normalize Agent ID
      const agentName = currentSessionUser.name;

      // Set welcome text
      document.getElementById('agent-qa-welcome-text').innerText = `Welcome ${agentName}`;

      // Load reviews for this agent
      let reviews = JSON.parse(localStorage.getItem('adminReviews') || '[]');

      // Filter reviews for current agent only (robust comparison)
      const agentReviews = reviews.filter(r => String(r.agentId).trim().toLowerCase() === agentId);

      // Calculate stats
      const totalReviews = agentReviews.length;
      const avgScore = totalReviews > 0 ? Math.round(agentReviews.reduce((sum, r) => sum + r.score, 0) / totalReviews) : 0;

      // Get last review date
      let lastReviewDate = '--';
      if (agentReviews.length > 0) {
        // Sort by actual date if possible, assuming new ones appended last usually, but let's be safe
        // Use normalized date for sorting if needed, but for "last review" getting the last item in array is usually enough for appended logs
        const lastReview = agentReviews[agentReviews.length - 1];
        lastReviewDate = lastReview.displayDate || lastReview.date;
      }

      // Determine performance status
      let status = 'Pending';
      let statusColor = 'text-slate-600';

      if (totalReviews === 0) {
        status = 'Pending';
        statusColor = 'text-slate-600';
      } else if (avgScore >= 80) {
        status = 'Excellent';
        statusColor = 'text-green-600';
      } else if (avgScore >= 60) {
        status = 'Good';
        statusColor = 'text-blue-600';
      } else if (avgScore >= 40) {
        status = 'Need Improvement';
        statusColor = 'text-amber-600';
      } else {
        status = 'Critical';
        statusColor = 'text-red-600';
      }

      // Update stats
      document.getElementById('agent-total-reviews').innerText = totalReviews;
      document.getElementById('agent-avg-score').innerText = avgScore;
      document.getElementById('agent-last-review').innerText = lastReviewDate;
      document.getElementById('agent-performance-status').className = `text-lg font-bold ${statusColor}`;
      document.getElementById('agent-performance-status').innerText = status;

      // Populate reviews history table
      const tbody = document.getElementById('agent-reviews-history');
      const noReviewsMsg = document.getElementById('agent-no-reviews-message');

      if (agentReviews.length === 0) {
        tbody.innerHTML = '';
        noReviewsMsg.classList.remove('hidden');
      } else {
        noReviewsMsg.classList.add('hidden');
        // Build rows with View button to see details
        // Reverse to show newest first
        tbody.innerHTML = [...agentReviews].reverse().map(review => {
          const comments = (JSON.parse(localStorage.getItem('reviewComments') || '[]')).filter(c => c.reviewId === review.id);
          const replyCount = comments.length;
          const displayDate = review.displayDate || review.date;

          return `
          <tr class="hover:bg-slate-50 dark:hover:bg-slate-700/50">
            <td class="p-6">${displayDate}</td>
            <td class="p-6" title="${review.reviewerName || 'Quality Team'}">Quality Team</td>
            <td class="p-6">
              <button onclick="openReviewDetail('${review.id}')" class="text-blue-600 hover:text-blue-800 underline font-semibold">
                üëÅÔ∏è View
              </button>
            </td>
            <td class="p-6"><span class="font-bold ${review.score === 100 ? 'text-emerald-600' : review.score >= 50 ? 'text-blue-600' : 'text-red-600'}">${review.score}</span></td>
            <td class="p-6 text-sm">${replyCount} <span class="text-slate-500">replies</span></td>
            <td class="p-6"><span class="px-3 py-1 rounded-full text-xs font-bold ${review.score === 100 ? 'bg-emerald-100 text-emerald-700' : 'bg-amber-100 text-amber-700'}">${review.score === 100 ? 'Good' : 'Review'}</span></td>
          </tr>
        `}).join('');
      }

      // Load feedback
      agentLoadFeedback(agentId);
    }

    function agentLoadFeedback(agentId) {
      let comments = JSON.parse(localStorage.getItem('gojira_comments') || '[]');

      // Filter feedback for current agent
      let agentComments = comments.filter(c => c.agentId === agentId);

      const tbody = document.getElementById('agent-feedback-list');
      const noFeedbackMsg = document.getElementById('agent-no-feedback-message');

      if (agentComments.length === 0) {
        tbody.innerHTML = '';
        noFeedbackMsg.classList.remove('hidden');
      } else {
        noFeedbackMsg.classList.add('hidden');
        const now = new Date();
        tbody.innerHTML = agentComments.map(comment => {
          // Calculate expiry date (7 days from comment date)
          const commentDate = new Date(comment.date);
          const expiryDate = new Date(commentDate.getTime() + 7 * 24 * 60 * 60 * 1000);
          const daysLeft = Math.ceil((expiryDate - now) / (1000 * 60 * 60 * 24));

          return `
            <tr class="hover:bg-slate-50 dark:hover:bg-slate-700/50">
              <td class="p-6">${comment.date}</td>
              <td class="p-6">Quality Team</td>
              <td class="p-6 text-sm">${comment.text.substring(0, 50)}...</td>
              <td class="p-6"><span class="px-3 py-1 rounded-full text-xs font-bold ${daysLeft > 0 ? 'bg-blue-100 text-blue-700' : 'bg-slate-100 text-slate-700'}">${daysLeft > 0 ? daysLeft + ' days' : 'Expired'}</span></td>
            </tr>
          `;
        }).join('');
      }
    }

    function handleAgentSearch(query) {
      const resultsDiv = document.getElementById('indiv-agent-results');
      if (!query || query.length < 2) {
        resultsDiv.classList.add('hidden');
        return;
      }

      const matched = USER_DB.filter(u =>
        u.role === 'agent' &&
        (u.name.toLowerCase().includes(query.toLowerCase()) || u.id.toLowerCase().includes(query.toLowerCase()))
      );

      if (matched.length === 0) {
        resultsDiv.innerHTML = '<div class="p-4 text-sm text-slate-500 italic">No agents found</div>';
      } else {
        resultsDiv.innerHTML = matched.map(u => `
          <div onclick="selectAgent('${u.id}')" class="p-3 hover:bg-slate-50 dark:hover:bg-slate-700 cursor-pointer border-b border-slate-50 dark:border-slate-700 last:border-0">
             <div class="font-bold text-slate-700 dark:text-slate-200">${u.name}</div>
             <div class="text-xs text-slate-500 font-mono">${u.id} ‚Ä¢ ${u.entity}</div>
          </div>
        `).join('');
      }
      resultsDiv.classList.remove('hidden');
    }

    // Agent reply to a specific review
    // Deprecated - use modal version instead
    function agentReplyToReview(reviewId) {
      // This is kept for backwards compatibility but not used
      return;
    }

    function selectAgent(id) {
      selectedAgentForUpload = USER_DB.find(u => u.id === id);
      if (!selectedAgentForUpload) return;

      // Update UI
      document.getElementById('indiv-agent-search').value = '';
      document.getElementById('indiv-agent-results').classList.add('hidden');
      document.getElementById('indiv-agent-selected').classList.remove('hidden');
      document.getElementById('indiv-agent-selected').classList.add('flex');
      document.getElementById('indiv-upload-form').classList.remove('hidden');

      document.getElementById('selected-agent-name').innerText = selectedAgentForUpload.name;
      document.getElementById('selected-agent-id').innerText = selectedAgentForUpload.id;

      // Search Input hidden or disabled
      document.getElementById('indiv-agent-search').parentElement.parentElement.classList.add('hidden');
    }



    async function submitIndividualScore() {
      if (!selectedAgentForUpload) return alert('No agent selected.');

      const score = document.getElementById('indiv-score').value;
      const errors = document.getElementById('indiv-errors').value;
      const compliance = document.getElementById('indiv-compliance').value;

      if (!score || !errors) return alert('Please enter Score and Errors.');

      // Handle File Uploads
      const proofs = [];
      const files = [
        { id: 'proof-audio', name: 'Call Recording', icon: 'üé§' },
        { id: 'proof-chat', name: 'Chat Transcript', icon: 'üí¨' },
        { id: 'proof-email', name: 'Email Proof', icon: '‚úâÔ∏è' }
      ];

      try {
        for (const f of files) {
          const input = document.getElementById(f.id);
          if (input.files.length > 0) {
            const file = input.files[0];
            const content = await readFileAsBase64(file);
            proofs.push({
              name: f.name + ` (${file.name})`,
              icon: f.icon,
              type: file.type,
              content: content
            });
          }
        }
      } catch (e) {
        console.error(e);
        return alert('Error processing files. Please try again.');
      }

      // Save
      MockBackend.savePerformance(selectedAgentForUpload.id, {
        score,
        errors,
        compliance,
        proofs
      });

      alert(`Performance updated for ${selectedAgentForUpload.name} successfully!`);
      clearSelectedAgent();
    }

    function readFileAsBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result);
        reader.onerror = error => reject(error);
      });
    }

    const searchData = [
      { name: 'Knowledge Base', id: 'view-kb' },
      { name: 'Brand Entities', id: 'view-entities' },
      { name: 'New Updates', id: 'view-updates' },
      { name: 'Resources', id: 'view-resources' },
      { name: 'BharatLoan', id: 'view-bharatloan' },
      { name: 'Rupee112', id: 'view-rupee112' },
      { name: 'Loan112', id: 'view-loan112' },
      { name: 'RupeeOnTime', id: 'view-rupeeontime' },
      { name: 'Quality Assurance Checklist', id: 'view-checklist' },
      { name: 'BharatLoan Portal', id: 'view-bharatloan' },
      { name: 'Rupee112 Portal', id: 'view-rupee112' },
      { name: 'Loan112 Portal', id: 'view-loan112' },
      { name: 'RupeeOnTime Portal', id: 'view-rupeeontime' },
      { name: 'WOCOM 365', id: 'view-bharatloan' },
      { name: 'Yellow Ai', id: 'view-bharatloan' },
      { name: 'Outlook', id: 'view-bharatloan' },
    ];

    let currentEntity = '';
    let currentUser = null;
    let selectedAgentForUpload = null;

    const ENTITY_VIEW_MAP = {
      'view-bharatloan': 'BharatLoan',
      'view-rupee112': 'Rupee112',
      'view-loan112': 'Loan112',
      'view-rupeeontime': 'RupeeOnTime'
    };

    // Filter entities display based on user role
    function filterEntitiesDisplay() {
      const userToCheck = currentSessionUser || currentUser;
      if (!userToCheck) return; // Not logged in via new system

      // Get all entity cards
      const entities = document.querySelectorAll('#view-entities .grid > div');

      entities.forEach(entityCard => {
        // Check which entity this card represents based on onclick attribute
        const onclick = entityCard.getAttribute('onclick');
        let entityToShow = null;

        if (onclick.includes('bharatloan')) entityToShow = 'BharatLoan';
        else if (onclick.includes('rupee112')) entityToShow = 'Rupee112';
        else if (onclick.includes('loan112')) entityToShow = 'Loan112';
        else if (onclick.includes('rupeeontime')) entityToShow = 'RupeeOnTime';

        // Show/hide based on user's entity
        if (userToCheck.entity === 'ALL') {
          entityCard.style.display = ''; // Show all for admin/reviewer
        } else if (userToCheck.entity === entityToShow) {
          entityCard.style.display = ''; // Show only matching entity for agents
        } else {
          entityCard.style.display = 'none'; // Hide non-matching entities
        }
      });
    }

    // Filter QA Checklist card in Resources based on user role
    function filterResourcesQACard() {
      const userToCheck = currentSessionUser || currentUser;
      const agentCard = document.getElementById('qa-checklist-card-agent');
      const otherCard = document.getElementById('qa-checklist-card-other');

      if (!agentCard || !otherCard) return;

      if (userToCheck && userToCheck.role === 'agent') {
        // Show agent-specific QA card
        agentCard.classList.remove('hidden');
        otherCard.classList.add('hidden');
      } else {
        // Show entity checklist QA card for others
        agentCard.classList.add('hidden');
        otherCard.classList.remove('hidden');
      }
    }

    function navigateTo(id) {
      // CHECK ACCESS PERMISSION - Use currentSessionUser for new login system
      const userToCheck = currentSessionUser || currentUser;

      if (userToCheck && userToCheck.entity !== 'ALL') {
        const targetEntity = ENTITY_VIEW_MAP[id];
        if (targetEntity && targetEntity !== userToCheck.entity) {

          // Dynamic check: Update modal text to ensure it matches requirement
          const modalTitle = document.getElementById('access-denied-title');
          if (modalTitle) modalTitle.innerText = 'Please enter the correct ID and can choose the correct entity for this ID';

          // Show Access Denied Modal
          document.getElementById('access-denied-modal').classList.remove('hidden');
          return; // STOP NAVIGATION
        }
      }

      document.querySelectorAll('.app-view').forEach(v => v.classList.remove('active'));
      document.getElementById(id).classList.add('active');
      window.scrollTo({ top: 0, behavior: 'smooth' });
      // Close search after navigation
      document.getElementById('search-bar').classList.add('hidden');
      document.getElementById('search-input').value = '';
      document.getElementById('search-results').innerHTML = '';

      // Filter Resources QA card when navigating to resources
      if (id === 'view-resources') {
        filterResourcesQACard();
      }

      // Load QA Dashboard for agents
      if (id === 'view-agent-qa') {
        agentLoadQADashboard();
      }

      // Check notifications on navigation if agent
      if (currentSessionUser && currentSessionUser.role === 'agent') {
        checkAgentNotifications(false);
      } else if (currentUser && currentUser.role === 'agent') {
        checkAgentNotifications(false);
      }

      // Show notification bell only on homepage
      document.querySelectorAll('.agent-notification-bell').forEach(b => {
        if (id === 'view-home') b.classList.remove('hidden'); else b.classList.add('hidden');
      });
    }

    function toggleFaq(btn) {
      btn.parentElement.classList.toggle('active');
    }

    function showTab(tab, entity = '') {
      const prefix = entity ? '-' + entity : '';
      // Hide all tab contents
      document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));
      // Remove active from all tabs
      const tabSelectors = entity ? `#tab-tools${prefix}` : '#tab-tools';
      document.querySelectorAll(tabSelectors).forEach(btn => {
        btn.classList.remove('text-blue-600', 'border-blue-600');
        btn.classList.add('text-slate-500', 'border-transparent');
      });
      // Show selected tab content
      document.getElementById('content-' + tab + prefix).classList.remove('hidden');
      // Activate selected tab
      document.getElementById('tab-' + tab + prefix).classList.add('text-blue-600', 'border-blue-600');
      document.getElementById('tab-' + tab + prefix).classList.remove('text-slate-500', 'border-transparent');

      // Populate agents list if agents tab is selected
      if (tab === 'agents') {
        populateAgentsList(entity);
      }
    }

    function populateAgentsList(entity) {
      const entityMap = {
        'bharatloan': 'BharatLoan',
        'rupee112': 'Rupee112',
        'loan112': 'Loan112',
        'rupeeontime': 'RupeeOnTime',
        '': 'BharatLoan' // default
      };

      const entityName = entityMap[entity] || 'BharatLoan';
      const containerId = `agents-list-${entity || 'bharatloan'}`;
      const container = document.getElementById(containerId);

      if (!container) return;

      // Filter agents for the current entity
      const agents = USER_DB.filter(u => u.role === 'agent' && u.entity === entityName);

      if (agents.length === 0) {
        container.innerHTML = '<div class="p-4 text-center text-slate-500">No agents found for this entity.</div>';
        return;
      }

      // Create agent list HTML
      container.innerHTML = agents.map(agent => `
        <div class="bg-white dark:bg-slate-700 p-4 rounded-xl border border-slate-200 dark:border-slate-600 hover:shadow-md transition">
          <div class="flex items-center justify-between">
            <div>
              <h4 class="font-bold text-slate-900 dark:text-white text-lg">${agent.name}</h4>
              <p class="text-sm text-slate-600 dark:text-slate-300 font-mono">${agent.id}</p>
            </div>
            <div class="bg-indigo-100 dark:bg-indigo-900 text-indigo-700 dark:text-indigo-200 px-3 py-1 rounded-lg text-sm font-semibold">${agent.entity}</div>
          </div>
        </div>
      `).join('');
    }

    function toggleTheme() {
      const html = document.documentElement;
      const icon = document.getElementById('theme-icon');
      const text = document.getElementById('theme-text');

      if (html.classList.contains('dark')) {
        html.classList.remove('dark');
        icon.innerText = 'üåô';
        text.innerText = 'Dark';
        localStorage.setItem('theme', 'light');
      } else {
        html.classList.add('dark');
        icon.innerText = '‚òÄÔ∏è';
        text.innerText = 'Light';
        localStorage.setItem('theme', 'dark');
      }
    }

    function toggleDropdown(entity) {
      const dropdown = document.getElementById('support-dropdown' + (entity ? '-' + entity : ''));
      dropdown.classList.toggle('hidden');
    }

    function toggleSearch() {
      const bar = document.getElementById('search-bar');
      bar.classList.toggle('hidden');
      if (!bar.classList.contains('hidden')) {
        document.getElementById('search-input').focus();
      } else {
        document.getElementById('search-input').value = '';
        document.getElementById('search-results').innerHTML = '';
      }
    }

    function performSearch(query) {
      const resultsDiv = document.getElementById('search-results');
      if (!query.trim()) {
        resultsDiv.innerHTML = '';
        return;
      }
      const filtered = searchData.filter(item => item.name.toLowerCase().includes(query.toLowerCase()));
      resultsDiv.innerHTML = filtered.map(item => `<div onclick="navigateTo('${item.id}')" class="px-4 py-2 hover:bg-slate-100 dark:hover:bg-slate-700 cursor-pointer">${item.name}</div>`).join('');
    }

    function showLogin(entity) {
      currentEntity = entity;
      document.getElementById('login-title').innerText = `Login to ${entity}`;
      document.getElementById('login-modal').classList.remove('hidden');
      document.getElementById('empid').value = '';
    }

    function handleChecklistClick(entityName) {
      // If user is logged in as admin or reviewer, set entity and navigate to admin/reviewer dashboard
      if (currentSessionUser && (currentSessionUser.role === 'admin' || currentSessionUser.role === 'reviewer')) {
        currentEntity = entityName;
        adminCurrentEntity = entityName;
        if (currentSessionUser.role === 'admin') {
          navigateTo('view-admin');
          adminLoadAgents();
        } else if (currentSessionUser.role === 'reviewer') {
          navigateTo('view-reviewer');
          adminLoadAgents();
        }
      } else {
        // For non-logged-in users or agents, show login modal
        showLogin(entityName);
      }
    }

    function hideLogin() {
      document.getElementById('login-modal').classList.add('hidden');
      document.getElementById('empid').value = '';
    }

    // USER DATABASE
    const USER_DB = [
      { id: 'BL/GG/25/1135', name: 'Siddhant Chauhan', role: 'admin', entity: 'ALL' },
      { id: 'BL/GG/25/0957', name: 'Ayushi Gupta', role: 'reviewer', entity: 'ALL' },
      { id: 'BL/GG/25/703', name: 'SHARAD ADHIKARI', role: 'agent', entity: 'BharatLoan' },
      { id: 'BL/GG/25/704', name: 'DIVYANSHU SHARMA', role: 'agent', entity: 'BharatLoan' },
      { id: 'BL/GG/25/705', name: 'AYUSHMAN TIBREWAL', role: 'agent', entity: 'BharatLoan' },
      { id: 'BL/GG/25/1189', name: 'Khushi Kumari', role: 'agent', entity: 'BharatLoan' },
      { id: 'BL/GG/25/712', name: 'AKSHAY NAGIA', role: 'agent', entity: 'BharatLoan' },
      { id: 'BL/GG/25/1021', name: 'Chitresh Kumar', role: 'agent', entity: 'BharatLoan' },
      { id: 'BL/GG/25/1022', name: 'Akshat', role: 'agent', entity: 'BharatLoan' },
      { id: 'BL/GG/25/1055', name: 'KAJAL', role: 'agent', entity: 'BharatLoan' },
      { id: 'BL/GG/25/1134', name: 'Isha', role: 'agent', entity: 'BharatLoan' },

      { id: 'BL/GG/25/1240', name: 'KUNDAN KUMAR', role: 'agent', entity: 'BharatLoan' },
      { id: 'BL/GG/25/1338', name: 'MOHIT KUMAR', role: 'agent', entity: 'BharatLoan' },
      { id: 'BL/GG/26/042', name: 'MOHD. KAIF', role: 'agent', entity: 'BharatLoan' },


      // LOAN112 AGENTS
      { id: 'L112/GG/25/021', name: 'RITU YADAV', role: 'agent', entity: 'Loan112' },
      { id: 'L112/GG/25/047', name: 'Hari Kishan', role: 'agent', entity: 'Loan112' },
      { id: 'L112/GG/25/022', name: 'ADITYA SINGH', role: 'agent', entity: 'Loan112' },
      { id: 'L112/GG/25/015', name: 'Kunal Kukreti', role: 'agent', entity: 'Loan112' },
      { id: 'L112/GG/25/086', name: 'Joba', role: 'agent', entity: 'Loan112' },
      { id: 'L112/GG/25/026', name: 'AMAAN KHAN', role: 'agent', entity: 'Loan112' },
      { id: 'L112/GG/25/087', name: 'Ajit', role: 'agent', entity: 'Loan112' },
      { id: 'L112/GG/25/046', name: 'Avinash', role: 'agent', entity: 'Loan112' },

      // RUPEE112 AGENTS
      { id: 'R112/GG/25/710', name: 'Priya Kumari', role: 'agent', entity: 'Rupee112' },
      { id: 'R112/GG/24/410', name: 'CHANDAN PANDAY', role: 'agent', entity: 'Rupee112' },
      { id: 'R112/GG/24/432', name: 'SHEETAL SINGH', role: 'agent', entity: 'Rupee112' },
      { id: 'R112/GG/25/623', name: 'GUNJAN', role: 'agent', entity: 'Rupee112' },
      { id: 'R112/GG/25/707', name: 'Dunna Vishal', role: 'agent', entity: 'Rupee112' },
      { id: 'R112/GG/25/754', name: 'Nishu Yadav', role: 'agent', entity: 'Rupee112' },
      { id: 'R112/GG/25/724', name: 'Aryan', role: 'agent', entity: 'Rupee112' },
      { id: 'R112/GG/25/732', name: 'Ansh Rai', role: 'agent', entity: 'Rupee112' },
      { id: 'RDA/GG/25/006', name: 'Ashish Rawat', role: 'agent', entity: 'Rupee112' },
      { id: 'R112/GG/24/478', name: 'KOMAL', role: 'agent', entity: 'Rupee112' },
      { id: 'R112/GG/25/725', name: 'Kusum sharma', role: 'agent', entity: 'Rupee112' },
      { id: 'RDA/GG/25/038', name: 'Nippi', role: 'agent', entity: 'Loan112' },
      { id: 'R112/GG/23/168', name: 'Ruksar', role: 'agent', entity: 'Rupee112' },
      { id: 'R112/GG/25/692', name: 'NEHA', role: 'agent', entity: 'Rupee112' }
    ];

    function hideLogin() {
      document.getElementById('login-modal').classList.add('hidden');
      document.getElementById('empid').value = '';
    }

    function submitLogin(event) {
      try {
        event.preventDefault();
        const empId = document.getElementById('portal-emp-id').value.trim();
        const password = document.getElementById('portal-password').value;
        console.debug('[submitLogin] empId:', empId);

        // Check if employee exists
        const user = USER_DB.find(u => u.id === empId);
        if (!user) {
          console.warn('[submitLogin] Invalid Employee ID:', empId);
          alert('‚ùå Invalid Employee ID');
          return;
        }

        // Check password
        const savedPasswords = JSON.parse(localStorage.getItem('gojira_passwords') || '{}');
        console.debug('[submitLogin] savedPasswords sample:', Object.keys(savedPasswords).slice(0, 5));
        const correctPassword = savedPasswords[empId] || '1234';

        if (password !== correctPassword) {
          console.warn('[submitLogin] Invalid Password for', empId);
          alert('‚ùå Invalid Password');
          return;
        }

        // Login successful - save session
        currentSessionUser = { id: user.id, name: user.name, role: user.role, entity: user.entity };
        localStorage.setItem('gojira_session_user', JSON.stringify(currentSessionUser));
        console.info('[submitLogin] Login successful for', user.id, user.role);

        // Apply colorful Gojira theme across pages after login
        document.body.classList.add('gojira-theme');
        localStorage.setItem('gojira_theme_active', '1');

        // Clear login form
        document.getElementById('portal-emp-id').value = '';
        document.getElementById('portal-password').value = '';

        // Route users based on role
        if (user.role === 'admin') {
          // For admin
          const selectedEntity = document.getElementById('login-entity')?.value || currentEntity || 'ALL';
          adminCurrentEntity = selectedEntity;
          currentUser = user;
          currentEntity = user.entity;

          // Set welcome message with admin name
          const welcomeText = document.getElementById('admin-welcome-text');
          if (welcomeText) welcomeText.innerText = `Welcome ${user.name}`;

          showPortalContent();
          navigateTo('view-home');
        } else if (user.role === 'reviewer') {
          // For reviewer
          const selectedEntity = document.getElementById('login-entity')?.value || currentEntity || 'BharatLoan';
          reviewerCurrentEntity = selectedEntity;
          adminCurrentEntity = selectedEntity; // ensure agent lists populate
          currentUser = user;
          currentEntity = user.entity;

          // Set welcome message with reviewer name
          const welcomeText = document.getElementById('reviewer-welcome-text');
          if (welcomeText) welcomeText.innerText = `Welcome ${user.name}`;

          // Set entity display
          const entityDisplay = document.getElementById('reviewer-entity-display');
          if (entityDisplay) entityDisplay.textContent = reviewerCurrentEntity;

          // Populate agent list for reviewer
          adminLoadAgents();

          showPortalContent();
          navigateTo('view-home');
        } else if (user.role === 'agent') {
          // For agents
          currentUser = user;
          currentEntity = user.entity;

          // Update Header Title
          const titleSpan = document.getElementById('agent-dashboard-title');
          if (titleSpan) titleSpan.innerText = `Welcome ${user.name}`;

          // Update Banner Name
          const bannerName = document.getElementById('agent-name-display');
          if (bannerName) bannerName.innerText = user.name;

          showPortalContent();
          navigateTo('view-home');
        }
      } catch (err) {
        console.error('[submitLogin] error', err);
        alert('An unexpected error occurred during login. Check console for details.');
      }
    }

    window.onload = () => {
      const savedTheme = localStorage.getItem('theme');
      if (savedTheme === 'dark') {
        document.documentElement.classList.add('dark');
        document.getElementById('theme-icon').innerText = '‚òÄÔ∏è';
        document.getElementById('theme-text').innerText = 'Light';
      }

      // Safety: Ensure session persists across refreshes. 
      try {
        const sessionUserRaw = localStorage.getItem('gojira_session_user');
        if (sessionUserRaw) {
          currentSessionUser = JSON.parse(sessionUserRaw);
          console.info('[onload] Restoring session from localStorage for', currentSessionUser?.id);

          // Restore global variables based on role
          currentUser = currentSessionUser;

          // If a theme was active for this session, re-apply it
          const themeActive = localStorage.getItem('gojira_theme_active');
          if (themeActive && currentSessionUser) {
            document.body.classList.add('gojira-theme');
            console.debug('[onload] Re-applying Gojira theme for restored session');
          }

          // Move door-brand behind login after its animation completes (synchronised with doors)
          try {
            const doorBrandEl = document.getElementById('door-brand');
            if (doorBrandEl) {
              const heading = doorBrandEl.querySelector('.door-brand');

              // When left door animation ends, trigger heading descend animation so it stays centered until doors move
              const leftDoor = document.querySelector('.animate-door-left');
              if (leftDoor) {
                leftDoor.addEventListener('animationend', () => {
                  heading?.classList.add('door-descend');
                  console.debug('[onload] left door animation ended - started door-descend');
                });
              }

              // When heading finishes its descend, finalize moved state and raise the login card
              heading?.addEventListener('animationend', () => {
                doorBrandEl.classList.add('moved');
                const loginCardEl = document.getElementById('login-card');
                if (loginCardEl) loginCardEl.classList.add('raised');
                console.debug('[onload] door-brand animation ended, moved behind login and login-card raised');
              });

              // Fallback in case animation events aren't triggered - ensure proper final state after a short delay
              setTimeout(() => {
                if (!doorBrandEl.classList.contains('moved')) {
                  heading?.classList.add('door-descend');
                }
                setTimeout(() => {
                  doorBrandEl.classList.add('moved');
                  const loginCardEl = document.getElementById('login-card');
                  if (loginCardEl) loginCardEl.classList.add('raised');
                }, 900);
              }, 2400);
            }
          } catch (e) {
            console.warn('[onload] failed to attach door-brand listeners', e);
          }

          // initPortal will be called but we will override its default "show login" behavior if we have a user
        }
      } catch (e) {
        console.warn('[onload] failed to restore session safely', e);
      }

      // Initialize portal login system
      // If we have a user, this function should respect it or we override it immediately after
      initPortal();

      if (currentSessionUser) {
        showPortalContent();
        if (currentSessionUser.role === 'admin') {
          adminCurrentEntity = currentSessionUser.entity === 'ALL' ? (adminCurrentEntity || 'BharatLoan') : currentSessionUser.entity;
          adminLoadAgents();
        } else if (currentSessionUser.role === 'reviewer') {
          adminCurrentEntity = currentSessionUser.entity === 'ALL' ? (adminCurrentEntity || 'BharatLoan') : currentSessionUser.entity;
          adminLoadAgents();
        } else if (currentSessionUser.role === 'agent') {
          // Agent specific init if needed
          const titleSpan = document.getElementById('agent-dashboard-title');
          if (titleSpan) titleSpan.innerText = `Welcome ${currentSessionUser.name}`;
          const bannerName = document.getElementById('agent-name-display');
          if (bannerName) bannerName.innerText = currentSessionUser.name;
        }

        // Navigate to home or last view? Default to home for now to be safe, or stay on current if possible.
        // User request: "refresh ... it shouldn't be logout"
        // keeping it simple: just show portal content.
      }
    }

    // ===== NEW ADMIN DASHBOARD FUNCTIONS =====
    let adminCurrentEntity = '';
    let adminCurrentAgent = '';
    let adminCurrentAgentName = '';
    let adminReviewItems = [];
    let adminReviewType = ''; // 'voice' or 'non-voice'
    let reviewerCurrentEntity = '';
    let agentCurrentEntity = '';

    function getEntityWeekState(entity) {
      if (!entity) entity = 'ALL';
      return JSON.parse(localStorage.getItem(`entityWeekState_${entity}`) || JSON.stringify({ currentWeek: 1, completedAgents: {} }));
    }

    function setEntityWeekState(entity, state) {
      if (!entity) entity = 'ALL';
      localStorage.setItem(`entityWeekState_${entity}`, JSON.stringify(state));
    }

    function markAgentWeekComplete(entity, agentId) {
      const state = getEntityWeekState(entity);
      const week = state.currentWeek || 1;
      state.completedAgents = state.completedAgents || {};
      state.completedAgents[week] = state.completedAgents[week] || {};
      state.completedAgents[week][agentId] = true;
      setEntityWeekState(entity, state);
      // Refresh UI dropdown and controls
      renderAdminAgentDropdown();
      checkAndEnableWeekFinalButton();
    }

    function unmarkAgentWeekComplete(entity, agentId) {
      // If entity provided is specific, remove for that entity/week; otherwise sweep all stored entityWeekState_ keys
      const sweepAll = !entity || entity === 'ALL';

      if (sweepAll) {
        // Remove agent from any entityWeekState_* entries
        Object.keys(localStorage).forEach(key => {
          if (!key.startsWith('entityWeekState_')) return;
          try {
            const state = JSON.parse(localStorage.getItem(key) || '{}');
            if (state && state.completedAgents) {
              let changed = false;
              Object.keys(state.completedAgents).forEach(wk => {
                if (state.completedAgents[wk] && state.completedAgents[wk][agentId]) {
                  delete state.completedAgents[wk][agentId];
                  changed = true;
                }
              });
              if (changed) localStorage.setItem(key, JSON.stringify(state));
            }
          } catch (e) {
            console.warn('Failed parsing', key, e);
          }
        });
      } else {
        const state = getEntityWeekState(entity);
        const week = state.currentWeek || 1;
        if (state.completedAgents && state.completedAgents[week] && state.completedAgents[week][agentId]) {
          delete state.completedAgents[week][agentId];
          setEntityWeekState(entity, state);
        }
      }
    }







    function isAgentWeekComplete(entity, agentId) {
      const state = getEntityWeekState(entity);
      const week = state.currentWeek || 1;
      return !!(state.completedAgents && state.completedAgents[week] && state.completedAgents[week][agentId]);
    }

    function renderAdminAgentDropdown() {
      const adminSelector = document.getElementById('admin-agent-selector');
      const dropdownList = document.getElementById('admin-agent-dropdown-list');
      const selectedText = document.getElementById('admin-agent-dropdown-selected-text');
      const dropdownSelected = document.getElementById('admin-agent-dropdown-selected');
      if (!dropdownList || !adminSelector || !selectedText || !dropdownSelected) return;

      // Build agent list
      dropdownList.innerHTML = '';
      adminSelector.innerHTML = '<option value="">-- Click to Select Agent --</option>';

      let agents = USER_DB.filter(u => u.role === 'agent');
      if (adminCurrentEntity && adminCurrentEntity !== 'ALL') {
        agents = agents.filter(u => u.entity === adminCurrentEntity);
      }

      const state = getEntityWeekState(adminCurrentEntity || 'ALL');
      const currentWeek = state.currentWeek || 1;

      agents.forEach(agent => {
        const completed = !!(state.completedAgents && state.completedAgents[currentWeek] && state.completedAgents[currentWeek][agent.id]);

        // Populate hidden select for backwards compatibility
        const option = document.createElement('option');
        option.value = agent.id;
        option.text = `${agent.name} ${agent.id}${completed ? ' ‚úÖ' : ''}`;
        option.dataset.name = agent.name;
        if (completed) option.title = `Finalized for Week ${currentWeek}`;
        adminSelector.appendChild(option);

        // Create visible list item
        const item = document.createElement('div');
        item.className = 'p-3 cursor-pointer hover:bg-slate-100 dark:hover:bg-slate-700 flex items-center justify-between';
        item.innerHTML = `
          <div class="flex items-center">
            <div class="w-6 h-6 rounded-full mr-3 flex items-center justify-center ${completed ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-600'}">${completed ? '‚úî' : ''}</div>
            <div class="font-bold">${agent.name} ${agent.id}</div>
          </div>
          <div class="text-sm text-slate-500">${completed ? 'Finalized Wk ' + currentWeek : ''}</div>
        `;

        item.addEventListener('click', () => {
          adminSelectAgent(agent.id, agent.name);
          // Update selected text
          selectedText.innerHTML = `${agent.name} ${agent.id}${completed ? ' <span class=\"text-blue-600 font-bold\">‚úî</span>' : ''}`;
          // close dropdown
          dropdownList.classList.add('hidden');
        });

        dropdownList.appendChild(item);
      });

      // Update selected text if an agent is already selected (show blue tick if completed)
      if (adminCurrentAgent) {
        const sel = [...adminSelector.options].find(o => o.value === adminCurrentAgent);
        const agent = agents.find(a => a.id === adminCurrentAgent);
        const completed = agent && isAgentWeekComplete(adminCurrentEntity || 'ALL', adminCurrentAgent);
        if (sel) selectedText.innerHTML = `${agent.name} ${agent.id}${completed ? ' <span class="text-blue-600 font-bold">‚úî</span>' : ''}`;
      } else {
        selectedText.textContent = '-- Click to Select Agent --';
      }

      // Toggle dropdown on click
      dropdownSelected.onclick = (e) => {
        e.stopPropagation();
        dropdownList.classList.toggle('hidden');
      };

      // Close dropdown when clicking outside (attach listener only once)
      if (!dropdownList.dataset.listenerAttached) {
        document.addEventListener('click', (ev) => {
          if (!dropdownList.classList.contains('hidden')) dropdownList.classList.add('hidden');
        });
        dropdownList.dataset.listenerAttached = '1';
      }
    }

    function checkAndEnableWeekFinalButton() {
      const state = getEntityWeekState(adminCurrentEntity || 'ALL');
      const currentWeek = state.currentWeek || 1;
      const agentsList = USER_DB.filter(u => u.role === 'agent' && (!adminCurrentEntity || adminCurrentEntity === 'ALL' || u.entity === adminCurrentEntity));
      const total = agentsList.length;
      const completedCount = agentsList.filter(a => state.completedAgents && state.completedAgents[currentWeek] && state.completedAgents[currentWeek][a.id]).length;

      const progressEl = document.getElementById('admin-week-progress');
      const weekDisplay = document.getElementById('admin-week-display');
      const finalBtn = document.getElementById('admin-week-final-submit-btn');
      if (weekDisplay) weekDisplay.textContent = currentWeek;
      if (progressEl) progressEl.textContent = `(${completedCount}/${total} completed)`;

      if (completedCount > 0 && completedCount === total) {
        if (finalBtn) {
          finalBtn.disabled = false;
          finalBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        }
      } else {
        if (finalBtn) {
          finalBtn.disabled = true;
          finalBtn.classList.add('opacity-50', 'cursor-not-allowed');
        }
      }
    }

    function adminFinalizeWeek() {
      if (!adminCurrentEntity) adminCurrentEntity = 'ALL';
      const state = getEntityWeekState(adminCurrentEntity);
      const currentWeek = state.currentWeek || 1;
      // Mark week as finalized
      state.finalizedWeeks = state.finalizedWeeks || [];
      if (!state.finalizedWeeks.includes(currentWeek)) state.finalizedWeeks.push(currentWeek);
      // Advance week
      if (currentWeek < 4) {
        state.currentWeek = currentWeek + 1;
      } else {
        // Cycle back to week 1 after week 4
        state.currentWeek = 1;
      }
      // Reset completed for new week
      state.completedAgents[state.currentWeek] = state.completedAgents[state.currentWeek] || {};
      setEntityWeekState(adminCurrentEntity, state);

      alert(`Week ${currentWeek} finalized. Moved to Week ${state.currentWeek}.`);
      // Refresh UI
      adminLoadAgents();
      checkAndEnableWeekFinalButton();
    }

    function adminLoadAgents() {
      // Display current entity for admin dashboard
      const adminEntityDisplay = document.getElementById('admin-entity-display');
      if (adminEntityDisplay) {
        adminEntityDisplay.textContent = adminCurrentEntity === 'ALL' ? 'All Entities' : adminCurrentEntity;
      }

      // Display current entity for reviewer dashboard
      const reviewerEntityDisplay = document.getElementById('reviewer-entity-display');
      if (reviewerEntityDisplay && currentSessionUser && currentSessionUser.role === 'reviewer') {
        reviewerEntityDisplay.textContent = adminCurrentEntity === 'ALL' ? 'All Entities' : adminCurrentEntity;
      }

      // Get the selector dropdown for admin
      const adminSelector = document.getElementById('admin-agent-selector');
      const reviewerSelector = document.getElementById('reviewer-agent-selector');

      // Filter agents by entity
      let agents = USER_DB.filter(u => u.role === 'agent');
      if (adminCurrentEntity && adminCurrentEntity !== 'ALL') {
        agents = agents.filter(u => u.entity === adminCurrentEntity);
      }



      // Populate reviewer dropdown
      if (reviewerSelector) {
        reviewerSelector.innerHTML = '<option value="">-- Choose Agent --</option>';
        agents.forEach(agent => {
          const state = getEntityWeekState(adminCurrentEntity || 'ALL');
          const currentWeek = state.currentWeek || 1;
          const completed = state.completedAgents && state.completedAgents[currentWeek] && state.completedAgents[currentWeek][agent.id];
          const option = document.createElement('option');
          option.value = agent.id;
          option.text = `${agent.name} ${agent.id}${completed ? ' ‚úÖ' : ''}`;
          option.title = completed ? `Finalized for Week ${currentWeek}` : '';
          option.dataset.name = agent.name;
          reviewerSelector.appendChild(option);
        });
      }

      // Populate admin dropdown
      if (adminSelector) {
        adminSelector.innerHTML = '<option value="">-- Click to Select Agent --</option>';
        agents.forEach(agent => {
          const state = getEntityWeekState(adminCurrentEntity || 'ALL');
          const currentWeek = state.currentWeek || 1;
          const completed = state.completedAgents && state.completedAgents[currentWeek] && state.completedAgents[currentWeek][agent.id];
          const option = document.createElement('option');
          option.value = agent.id;
          option.text = `${agent.name} ${agent.id}${completed ? ' ‚úÖ' : ''}`;
          option.title = completed ? `Finalized for Week ${currentWeek}` : '';
          option.dataset.name = agent.name;
          adminSelector.appendChild(option);
        });
      }

      // Load reviews for the current entity
      adminLoadReviewsList();

      // Render agent dropdown with inline badges for admin
      renderAdminAgentDropdown();

      // Update week UI and final button state
      checkAndEnableWeekFinalButton();

      // Update Clear Finalizations button label
      updateClearFinalizationsButton();
    }

    function adminSelectAgentFromDropdown(selectElement) {
      const selectedOption = selectElement.options[selectElement.selectedIndex];
      const agentId = selectedOption.value;
      const agentName = selectedOption.dataset.name;

      if (agentId) {
        adminCurrentAgent = agentId;
        adminCurrentAgentName = agentName;

        // Reset any previous inline selection state (inline controls removed)
        adminReviewType = '';

        // Enable the start review button (dropdown users will use modal to pick type)
        document.getElementById('admin-start-review-btn').disabled = false;
        document.getElementById('admin-start-review-btn').classList.remove('opacity-50', 'cursor-not-allowed');

        // Show the submitted reviews section and load reviews for this agent
        document.getElementById('admin-submitted-reviews-section').classList.remove('hidden');
        adminLoadReviewsList();
        // Update clear finalizations button
        updateClearFinalizationsButton();
      } else {
        adminCurrentAgent = '';
        adminCurrentAgentName = '';
        // Disable the start review button
        document.getElementById('admin-start-review-btn').disabled = true;
        document.getElementById('admin-start-review-btn').classList.add('opacity-50', 'cursor-not-allowed');
        // Hide the submitted reviews section
        document.getElementById('admin-submitted-reviews-section').classList.add('hidden');
        adminReviewType = '';
        // Update clear finalizations button
        updateClearFinalizationsButton();
      }
    }

    function adminSelectAgent(agentId, agentName) {
      adminCurrentAgent = agentId;
      adminCurrentAgentName = agentName;

      // Show the submitted reviews section when agent is selected
      document.getElementById('admin-submitted-reviews-section').classList.remove('hidden');

      // Clear any previous inline selection state
      adminReviewType = '';

      // Enable start button so admin can proceed to Quality Checklist
      document.getElementById('admin-start-review-btn').disabled = false;
      document.getElementById('admin-start-review-btn').classList.remove('opacity-50', 'cursor-not-allowed');

      // Update summary card similar to onAgentSelected but using adminReviews
      const agentListContainer = document.getElementById('admin-agent-list');
      const reviews = JSON.parse(localStorage.getItem('adminReviews') || '[]');
      const agentReviews = reviews.filter(r => String(r.agentId) === String(agentId) && (!adminCurrentEntity || adminCurrentEntity === 'ALL' || r.entity === adminCurrentEntity));
      const reviewStatus = agentReviews.length === 0
        ? 'No reviews submitted'
        : agentReviews.length >= 3
          ? 'Ready for final submission'
          : `${agentReviews.length}/3 reviews completed`;

      agentListContainer.innerHTML = `
        <div class="bg-white dark:bg-slate-700 p-6 rounded-2xl border border-slate-200 dark:border-slate-600">
           <div class="flex items-center justify-between mb-4">
              <div>
                 <h4 class="font-bold text-slate-700 dark:text-slate-200 text-xl">${agentName}</h4>
                 <p class="text-sm text-slate-500 font-mono">${agentId}</p>
                 <p class="text-xs text-slate-400 mt-1">Entity: ${USER_DB.find(u => String(u.id) === String(agentId))?.entity || ''}</p>
                 <p class="text-xs text-blue-600 mt-1 font-medium">${reviewStatus}</p>
              </div>
              <div class="text-right flex items-center gap-3">
                 <button onclick="adminClearReviewsForAgent('${agentId}')" id="admin-clear-reviews-btn" class="bg-red-100 text-red-700 px-3 py-2 rounded-md text-sm font-semibold border border-red-200 hover:bg-red-200">Clear Reviews</button>
                 <button onclick="adminStartQualityReview()" id="admin-top-start-btn" class="bg-blue-600 text-white px-4 py-2 rounded-md text-sm font-semibold">${agentReviews.length >= 3 ? 'Complete Final Submission' : 'Start Quality Review'}</button>
              </div>
           </div>
        </div>
      `;

      // Refresh reviews list for this agent
      adminLoadReviewsList();

      // Update Clear Finalizations button label
      updateClearFinalizationsButton();
    }

    function reviewerSelectAgent(selectElement) {
      const selectedOption = selectElement.options[selectElement.selectedIndex];
      const agentId = selectedOption.value;
      const agentName = selectedOption.dataset.name;

      if (agentId) {
        adminCurrentAgent = agentId;
        adminCurrentAgentName = agentName;
        // Show the reviews section
        document.getElementById('reviewer-reviews-section').classList.remove('hidden');
        // Load reviews for this agent
        reviewerLoadReviewsList();
      } else {
        adminCurrentAgent = '';
        adminCurrentAgentName = '';
        // Hide the reviews section
        document.getElementById('reviewer-reviews-section').classList.add('hidden');
      }
    }

    function adminStartQualityReview() {
      if (!adminCurrentEntity || !adminCurrentAgent) {
        alert('Please select an agent');
        return;
      }
      // Trigger the new modal
      document.getElementById('admin-review-type-modal').classList.remove('hidden');
      document.getElementById('review-type-agent-name').textContent = adminCurrentAgentName;
    }

    function startQualityReviewWithType(type) {
      console.debug('[startQualityReviewWithType] type=', type, 'adminCurrentAgent=', adminCurrentAgent, 'selectedAgentForReview=', selectedAgentForReview?.id);
      try { document.getElementById('agent-process-modal').classList.add('hidden'); } catch (e) { }

      if (!adminCurrentAgent && selectedAgentForReview) {
        adminCurrentAgent = selectedAgentForReview.id;
        adminCurrentAgentName = selectedAgentForReview.name;
      }

      try { document.getElementById('review-type-agent-name').textContent = adminCurrentAgentName; } catch (e) { }

      // Reuse the existing adminSelectReviewType flow
      adminSelectReviewType(type);
    }

    function adminSelectReviewType(type) {
      // type: 'voice' or 'non-voice'
      console.debug('[adminSelectReviewType] selected type', type, 'for agent', adminCurrentAgentName);
      adminReviewType = type;
      document.getElementById('admin-review-type-modal').classList.add('hidden');

      // Show quality review form
      adminReviewItems = [];
      document.getElementById('admin-review-items-container').innerHTML = '';
      document.getElementById('admin-quality-form-section').classList.remove('hidden');
      document.getElementById('admin-review-agent-display').textContent = adminCurrentAgentName;

      // Add first review item automatically
      adminAddReviewItem();
    }

    function adminCancelReview() {
      document.getElementById('admin-quality-form-section').classList.add('hidden');
      adminReviewItems = [];
      document.getElementById('admin-review-items-container').innerHTML = '';
      document.querySelectorAll('.admin-agent-btn').forEach(btn => {
        btn.classList.remove('border-blue-500', 'bg-blue-100', 'dark:bg-slate-500');
      });
      document.getElementById('admin-start-review-btn').disabled = true;
      document.getElementById('admin-start-review-btn').classList.add('opacity-50', 'cursor-not-allowed');
      adminCurrentAgent = '';
    }

    function adminAddReviewItem() {
      if (adminReviewItems.length >= 10) {
        alert('Maximum 10 reviews allowed per agent');
        return;
      }

      const itemIndex = adminReviewItems.length + 1;
      const container = document.getElementById('admin-review-items-container');

      let itemHtml = `
        <div class="admin-review-item bg-white dark:bg-slate-700 p-6 rounded-xl border border-slate-200 dark:border-slate-600 mb-4">
          <div class="flex items-center justify-between mb-4">
            <h4 class="font-bold text-lg">Review #${itemIndex}</h4>
            ${itemIndex > 1 ? `<button onclick="adminRemoveReviewItem(${itemIndex - 1})" class="text-red-600 hover:text-red-700 text-sm">üóëÔ∏è Remove</button>` : ''}
          </div>
      `;

      // Show file upload only for voice reviews
      if (adminReviewType === 'voice') {
        itemHtml += `
          <!-- File Upload (Voice) -->
          <div class="mb-4">
            <label class="block text-sm font-semibold mb-2">Select File (Max 20MB)</label>
            <input type="file" class="review-file-input block w-full text-sm file:mr-4 file:py-2 file:px-4 file:rounded file:border-0 file:text-sm file:font-semibold file:bg-blue-100 file:text-blue-700"
              data-item-index="${itemIndex - 1}" onchange="adminOnFileSelected(${itemIndex - 1})">
            <p class="text-xs text-slate-500 mt-1">Selected: <span class="review-file-name">None</span></p>
          </div>
        `;
      } else {
        // Show single contact input for non-voice reviews (Chat ID or Email ID - only one required)
        itemHtml += `
          <!-- Chat or Email ID (Non-Voice) -->
          <div class="mb-4">
            <label class="block text-sm font-semibold mb-2">Chat ID or Email ID</label>
            <input type="text" class="review-contact-id w-full px-4 py-3 rounded-lg border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-700 focus:ring-2 focus:ring-emerald-500 outline-none" 
              placeholder="Enter Chat ID or Email ID (one required)" data-item-index="${itemIndex - 1}">
          </div>
        `;
      }

      // Observation and Score (Binary)
      itemHtml += `
          <!-- Observation -->
          <div class="mb-4">
            <label class="block text-sm font-semibold mb-2">Observation</label>
            <textarea class="review-observation w-full px-4 py-3 rounded-lg border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-700 focus:ring-2 focus:ring-emerald-500 outline-none" 
              rows="4" placeholder="Enter your observation for this review..." data-item-index="${itemIndex - 1}"></textarea>
          </div>

          <!-- Score (Binary 0 or 100) -->
          <div class="mb-4">
            <label class="block text-sm font-semibold mb-3">Performance Score</label>
            <div class="flex gap-4">
              <label class="flex items-center gap-2 p-3 bg-emerald-50 dark:bg-slate-600 rounded-lg border border-emerald-200 dark:border-slate-500 cursor-pointer flex-1 transition hover:bg-emerald-100">
                <input type="radio" name="score-${itemIndex - 1}" value="100" class="review-score w-5 h-5 text-emerald-600 focus:ring-emerald-500 border-gray-300" data-item-index="${itemIndex - 1}">
                <div>
                  <div class="font-bold text-emerald-600">Good (100)</div>
                </div>
              </label>
              <label class="flex items-center gap-2 p-3 bg-red-50 dark:bg-slate-600 rounded-lg border border-red-200 dark:border-slate-500 cursor-pointer flex-1 transition hover:bg-red-100">
                <input type="radio" name="score-${itemIndex - 1}" value="0" class="review-score w-5 h-5 text-red-600 focus:ring-red-500 border-gray-300" data-item-index="${itemIndex - 1}">
                <div>
                  <div class="font-bold text-red-600">Fatal (0)</div>
                </div>
              </label>
            </div>
          </div>
        </div>
      `;

      container.insertAdjacentHTML('beforeend', itemHtml);
      // Initialize with correct fields structure
      adminReviewItems.push({ file: null, chatId: '', emailId: '', observation: '', score: null, reviewType: adminReviewType });

      // Update button states
      adminUpdateReviewButtons();
    }

    function adminRemoveReviewItem(index) {
      adminReviewItems.splice(index, 1);
      const items = document.querySelectorAll('.admin-review-item');
      if (items[index]) items[index].remove();
      adminUpdateReviewButtons();
    }

    function adminOnFileSelected(index) {
      const fileInput = document.querySelector(`input[data-item-index="${index}"]`);
      const file = fileInput.files[0];

      if (file) {
        if (file.size > 20 * 1024 * 1024) {
          alert('File size exceeds 20MB limit');
          fileInput.value = '';
          return;
        }
        adminReviewItems[index].file = file;
        document.querySelector(`.admin-review-item:nth-child(${index + 1}) .review-file-name`).textContent = file.name;
      }
    }

    function adminUpdateReviewButtons() {
      const count = document.querySelectorAll('.admin-review-item').length; // Use DOM count for accuracy
      const addBtn = document.getElementById('admin-add-review-btn');
      const finalBtn = document.getElementById('admin-final-submit-btn');

      // Add Button: Max 10
      if (count >= 10) {
        addBtn.disabled = true;
        addBtn.classList.add('opacity-50', 'cursor-not-allowed');
        addBtn.innerText = "Max 10 Reviews Reached";
      } else {
        addBtn.disabled = false;
        addBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        addBtn.innerText = "+ Add Another Review";
      }

      // Final Submit Button: Min 3
      if (count >= 3) {
        finalBtn.disabled = false;
        finalBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        finalBtn.innerHTML = `‚úÖ Final Submit (${count} reviews)`;
      } else {
        finalBtn.disabled = true;
        finalBtn.classList.add('opacity-50', 'cursor-not-allowed');
        finalBtn.innerHTML = `Final Submit (Need ${3 - count} more)`;
      }
    }

    async function adminFinalSubmit() {
      // Validate again before submission
      const itemElements = document.querySelectorAll('.admin-review-item');
      if (itemElements.length < 3) {
        alert('Minimum 3 reviews required.');
        return;
      }
      if (itemElements.length > 10) {
        alert('Maximum 10 reviews allowed.');
        return;
      }

      const items = [];
      let missingFields = false;

      itemElements.forEach((item, index) => {
        const observation = item.querySelector('.review-observation').value.trim();
        const scoreInput = item.querySelector('.review-score:checked');
        const score = scoreInput ? parseInt(scoreInput.value) : null;

        let file = null;
        let chatId = '';
        let emailId = '';

        if (adminReviewType === 'voice') {
          const fileInput = item.querySelector('.review-file-input');
          file = fileInput ? fileInput.files[0] : null;
          if (!file) missingFields = true;
        } else {
          // For non-voice, accept either Chat ID or Email ID (one required)
          const contactInput = item.querySelector('.review-contact-id');
          const contactVal = contactInput ? contactInput.value.trim() : '';

          if (contactVal) {
            if (contactVal.includes('@')) {
              emailId = contactVal;
            } else {
              chatId = contactVal;
            }
          } else {
            missingFields = true; // neither provided
          }
        }

        if (!observation || score === null) missingFields = true;

        items.push({
          file: file,
          chatId: chatId,
          emailId: emailId, // Store email ID
          observation: observation,
          score: score,
          reviewType: adminReviewType
        });
      });

      if (missingFields) {
        alert('Please fill all fields (File/IDs, Observation, Score) for all review items.');
        return;
      }

      const submitBtn = document.getElementById('admin-final-submit-btn');
      submitBtn.innerText = 'Submitting...';
      submitBtn.disabled = true;

      try {
        // Process files
        const processedItems = await Promise.all(items.map(item => {
          return new Promise((resolve, reject) => {
            if (!item.file) {
              resolve({ ...item, fileContent: null, fileName: null });
            } else {
              const reader = new FileReader();
              reader.onload = (e) => resolve({ ...item, fileContent: e.target.result, fileName: item.file.name });
              reader.onerror = reject;
              reader.readAsDataURL(item.file);
            }
          });
        }));

        // STORAGE: Save to localStorage
        let reviews = JSON.parse(localStorage.getItem('adminReviews') || '[]');
        const now = new Date();

        processedItems.forEach((item, idx) => {
          const reviewId = Date.now().toString() + '-' + Math.floor(Math.random() * 10000).toString() + '-' + idx;
          const reviewObj = {
            id: reviewId,
            date: now.toISOString(), // Use ISO format for consistent parsing
            displayDate: now.toLocaleDateString(), // Keep human readable date for display
            agentId: adminCurrentAgent,
            agentName: adminCurrentAgentName,
            entity: adminCurrentEntity,
            reviewType: item.reviewType,
            score: item.score,
            observation: item.observation,
            expiryDate: new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000).toISOString(),
            reviewerId: currentUser?.id || 'admin',
            reviewerName: currentUser?.name || 'Admin',
            // Specific fields
            chatId: item.chatId,
            emailId: item.emailId
          };

          if (item.reviewType === 'voice') {
            reviewObj.fileName = item.fileName;
            reviewObj.fileContent = item.fileContent;
          }

          reviews.push(reviewObj);
        });

        localStorage.setItem('adminReviews', JSON.stringify(reviews));

        // NOTIFICATION: Add feedback to agent comments
        let comments = JSON.parse(localStorage.getItem('gojira_comments') || '[]');
        const feedbackText = processedItems.map((item, idx) => `Review #${idx + 1} (${item.score}): ${item.observation}`).join('\n\n');

        if (feedbackText) {
          comments.unshift({
            id: Date.now(),
            text: `[${adminReviewType.toUpperCase()}] Weekly Review:\n` + feedbackText,
            agentId: adminCurrentAgent,
            date: new Date().toLocaleString()
          });
          localStorage.setItem('gojira_comments', JSON.stringify(comments));
        }

        // FINALIZE AGENT: Mark Agent as Finalized (Blue Tick)
        // User said: "once the admin will click on the final submit... agent... will be signed as blue tick"
        // This implies instant finalization upon this submission.
        markAgentWeekComplete(adminCurrentEntity || 'ALL', adminCurrentAgent);

        alert(`Successfully submitted ${processedItems.length} reviews for ${adminCurrentAgentName}. Agent finalized.`);

        // Reset UI
        adminCancelReview();
        // Refresh List to show Blue Tick
        adminLoadAgents();

        // Re-open agent dashboard to show the cleared state and updated list
        if (adminCurrentAgent) {
          adminSelectAgent(adminCurrentAgent, adminCurrentAgentName);
        }

      } catch (error) {
        console.error("Error submitting reviews:", error);
        alert("Failed to submit reviews. Please try again.");
      } finally {
        submitBtn.innerText = '‚úÖ Final Submit';
        submitBtn.disabled = false;
      }
    }

    function adminLoadReviewsList() {
      let reviews = JSON.parse(localStorage.getItem('adminReviews') || '[]');
      const tbody = document.getElementById('admin-reviews-list');

      // Remove expired reviews
      const now = new Date();
      let filtered = reviews.filter(r => new Date(r.expiryDate) >= now);
      localStorage.setItem('adminReviews', JSON.stringify(filtered));

      // Filter by current entity (admin can only see reviews for their logged-in entity)
      if (adminCurrentEntity && adminCurrentEntity !== 'ALL') {
        filtered = filtered.filter(r => r.entity === adminCurrentEntity);
      }

      // IMPORTANT: Only show reviews for the SELECTED agent
      if (adminCurrentAgent) {
        filtered = filtered.filter(r => r.agentId === adminCurrentAgent);
      } else {
        // If no agent is selected, show no reviews
        filtered = [];
      }

      if (filtered.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="p-6 text-center text-slate-400">No submitted reviews for this agent yet.</td></tr>';
        return;
      }

      tbody.innerHTML = filtered.map((review, idx) => `
        <tr class="hover:bg-slate-50 dark:hover:bg-slate-700/50">
          <td class="p-6">${review.date}</td>
          <td class="p-6">${review.agentName}</td>
          <td class="p-6 text-sm text-blue-600 underline cursor-pointer" onclick="openFileContent('${review.fileContent}', '${review.fileName}')">${review.fileName}</td>
          <td class="p-6"><span class="font-bold ${review.score === 100 ? 'text-emerald-600' : 'text-red-600'}">${review.score}</span></td>
          <td class="p-6 text-sm">${review.observation.substring(0, 50)}...</td>
          <td class="p-6 text-right space-x-2">
            <button onclick="adminViewReview(${idx})" class="text-blue-600 hover:text-blue-700">üëÅÔ∏è View</button>
            <button onclick="adminDeleteReview(${idx})" class="text-red-600 hover:text-red-700">üóëÔ∏è Delete</button>
          </td>
        </tr>
      `).join('');
    }

    function reviewerLoadReviewsList() {
      let reviews = JSON.parse(localStorage.getItem('adminReviews') || '[]');
      const tbody = document.getElementById('reviewer-reviews-list');

      // Remove expired reviews
      const now = new Date();
      let filtered = reviews.filter(r => new Date(r.expiryDate) >= now);

      // Filter by current entity
      if (adminCurrentEntity && adminCurrentEntity !== 'ALL') {
        filtered = filtered.filter(r => r.entity === adminCurrentEntity);
      }

      // Only show reviews for the SELECTED agent
      if (adminCurrentAgent) {
        filtered = filtered.filter(r => r.agentId === adminCurrentAgent);
      } else {
        filtered = [];
      }

      if (filtered.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="p-6 text-center text-slate-400">No submitted reviews for this agent yet.</td></tr>';
        return;
      }

      tbody.innerHTML = filtered.map((review, idx) => `
        <tr class="hover:bg-slate-50 dark:hover:bg-slate-700/50">
          <td class="p-6">${review.date}</td>
          <td class="p-6">${review.agentName}</td>
          <td class="p-6 text-sm text-blue-600 underline cursor-pointer" onclick="openFileContent('${review.fileContent}', '${review.fileName}')">${review.fileName}</td>
          <td class="p-6"><span class="font-bold ${review.score === 100 ? 'text-emerald-600' : 'text-red-600'}">${review.score}</span></td>
          <td class="p-6 text-sm">${review.observation.substring(0, 50)}...</td>
          <td class="p-6 text-right space-x-2">
            <button onclick="reviewerViewReview('${review.id}')" class="text-blue-600 hover:text-blue-700">üëÅÔ∏è View</button>
            <button onclick="reviewerViewComments('${review.id}')" class="text-purple-600 hover:text-purple-700">üí¨ Comments</button>
          </td>
        </tr>
      `).join('');
    }

    function reviewerViewReview(reviewId) {
      const reviews = JSON.parse(localStorage.getItem('adminReviews') || '[]');
      const review = reviews.find(r => r.id === reviewId);
      if (review) {
        const choice = confirm(`File: ${review.fileName}\nAgent: ${review.agentName}\nScore: ${review.score}\nObservation: ${review.observation}\n\nClick OK to open the file.`);
        if (choice && review.fileContent) {
          openFileContent(review.fileContent, review.fileName);
        }
      }
    }

    function reviewerViewComments(reviewId) {
      const comments = JSON.parse(localStorage.getItem('reviewComments') || '[]');
      const reviewComments = comments.filter(c => c.reviewId === reviewId);
      const reviews = JSON.parse(localStorage.getItem('adminReviews') || '[]');
      const review = reviews.find(r => r.id === reviewId);

      if (reviewComments.length === 0) {
        alert('No comments yet for this review.');
      } else {
        let commentsText = `Comments for ${review.agentName}'s review:\n\n`;
        reviewComments.forEach(c => {
          commentsText += `[${c.date}] ${c.authorName}:\n${c.text}\n\n`;
        });
        alert(commentsText);
      }
    }

    function openFileContent(content, name) {
      if (!content) return alert('File content not found.');
      // Open in new window
      const win = window.open();
      if (win) {
        win.document.write(`<iframe src="${content}" frameborder="0" style="border:0; top:0px; left:0px; bottom:0px; right:0px; width:100%; height:100%;" allowfullscreen></iframe>`);
        win.document.title = name;
      } else {
        alert('Please allow popups to view the file.');
      }
    }

    function adminViewReview(index) {
      const reviews = JSON.parse(localStorage.getItem('adminReviews') || '[]');
      const review = reviews[index];
      if (!review) return;

      const modal = document.getElementById('admin-review-detail-modal');

      // Populate fields
      document.getElementById('admin-review-detail-agent').textContent = review.agentName || 'Unknown Agent';
      document.getElementById('admin-review-detail-type').textContent = review.reviewType === 'voice' ? 'üéôÔ∏è Voice Call' : 'üí¨ Chat/Email';
      document.getElementById('admin-review-detail-date').textContent = review.displayDate || review.date;
      document.getElementById('admin-review-detail-score').textContent = review.score;
      document.getElementById('admin-review-detail-observation').textContent = review.observation;

      // File or ID
      if (review.reviewType === 'voice') {
        document.getElementById('admin-review-detail-file-section').classList.remove('hidden');
        document.getElementById('admin-review-detail-id-section').classList.add('hidden');
        document.getElementById('admin-review-detail-file-name').textContent = review.fileName || 'N/A';
        document.getElementById('admin-review-detail-file-link').onclick = () => openFileContent(review.fileContent, review.fileName);
      } else {
        document.getElementById('admin-review-detail-file-section').classList.add('hidden');
        document.getElementById('admin-review-detail-id-section').classList.remove('hidden');
        const idText = (review.emailId ? 'Email: ' + review.emailId : '') + (review.emailId && review.chatId ? ' | ' : '') + (review.chatId ? 'Chat: ' + review.chatId : '');
        document.getElementById('admin-review-detail-id-value').textContent = idText || 'N/A';
      }

      // Comments
      const comments = JSON.parse(localStorage.getItem('reviewComments') || '[]').filter(c => c.reviewId === review.id);
      const commentsHtml = comments.length === 0 ? '<p class="text-slate-500 italic">No comments yet</p>' : comments.map(c => `
        <div class="bg-slate-100 dark:bg-slate-600 p-3 rounded mb-2 ${c.authorId === (currentUser?.id || 'admin') ? 'ml-8 bg-blue-50 dark:bg-blue-900/20' : 'mr-8'}">
          <div class="flex justify-between items-center mb-1">
             <span class="font-bold text-sm ${c.authorId === (currentUser?.id || 'admin') ? 'text-blue-700 dark:text-blue-300' : 'text-slate-700 dark:text-slate-200'}">${c.authorName || 'User'}</span>
             <span class="text-xs text-slate-400">${c.date}</span>
          </div>
          <div class="text-sm text-slate-800 dark:text-slate-200">${c.text}</div>
        </div>
      `).join('');
      document.getElementById('admin-review-detail-comments').innerHTML = commentsHtml;

      modal.classList.remove('hidden');
    }

    function closeAdminReviewDetailModal() {
      document.getElementById('admin-review-detail-modal').classList.add('hidden');
    }

    let currentEditIndex = -1;

    function adminEditReview(index) {
      currentEditIndex = index;
      const reviews = JSON.parse(localStorage.getItem('adminReviews') || '[]');
      const review = reviews[index];

      // Populate Modal
      document.getElementById('edit-observation').value = review.observation;
      document.getElementById('edit-current-filename').innerText = review.fileName || 'None';

      // Set Radio
      const radios = document.getElementsByName('edit-score');
      radios.forEach(r => {
        // Reset first
        r.checked = false;
        if (parseInt(r.value) === review.score) r.checked = true;
      });

      // Clear file input
      document.getElementById('edit-file-upload').value = '';

      // Show Modal
      document.getElementById('admin-edit-review-modal').classList.remove('hidden');
    }

    async function adminSaveEdit() {
      if (currentEditIndex === -1) return;

      const reviews = JSON.parse(localStorage.getItem('adminReviews') || '[]');
      const review = reviews[currentEditIndex];

      // Get Values
      const obs = document.getElementById('edit-observation').value;
      const scoreEl = document.querySelector('input[name="edit-score"]:checked');
      if (!scoreEl) return alert('Please select a score');
      const score = parseInt(scoreEl.value);

      // Handle File
      const fileInput = document.getElementById('edit-file-upload');

      const saveBtn = document.getElementById('btn-save-edit');
      saveBtn.innerText = 'Saving...';
      saveBtn.disabled = true;

      try {
        if (fileInput.files.length > 0) {
          const file = fileInput.files[0];
          const content = await new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = (e) => resolve(e.target.result);
            reader.onerror = reject;
            reader.readAsDataURL(file);
          });
          review.fileName = file.name;
          review.fileContent = content; // Update content
        }

        review.observation = obs;
        review.score = score;

        // Save
        reviews[currentEditIndex] = review;
        localStorage.setItem('adminReviews', JSON.stringify(reviews));

        // Refresh & Close
        adminLoadReviewsList();
        document.getElementById('admin-edit-review-modal').classList.add('hidden');
        alert('Review updated successfully!');
      } catch (err) {
        console.error(err);
        alert('Error saving edit');
      } finally {
        saveBtn.innerText = 'Save Changes';
        saveBtn.disabled = false;
      }
    }

    function adminDeleteReview(index) {
      if (confirm('Delete this review?')) {
        let reviews = JSON.parse(localStorage.getItem('adminReviews') || '[]');
        const review = reviews[index];
        const agentId = review ? review.agentId : null;

        reviews.splice(index, 1);
        localStorage.setItem('adminReviews', JSON.stringify(reviews));

        // If this deletion caused the agent to fall below threshold, unmark completion
        if (agentId) {
          const remaining = reviews.filter(r => String(r.agentId) === String(agentId)).length;
          if (remaining < 3) {
            unmarkAgentWeekComplete('ALL', agentId);
            // Reconcile flags globally to ensure consistency
            reconcileFinalizeFlags();
            // Refresh dropdown etc.
            renderAdminAgentDropdown();
            checkAndEnableWeekFinalButton();
            if (adminCurrentAgent && String(adminCurrentAgent) === String(agentId)) {
              adminSelectAgent(agentId, adminCurrentAgentName || agentId);
            }
            alert(`Reviews for agent ${agentId} now ${remaining}. Finalized flag removed.`);
          }
        }

        adminLoadReviewsList();
      }
    }

    function adminDeleteAllReviews() {
      if (confirm('Delete all reviews for this entity? This action cannot be undone.')) {
        let reviews = JSON.parse(localStorage.getItem('adminReviews') || '[]');

        // Determine which agents had reviews removed for this entity
        const removedAgents = new Set(reviews.filter(r => r.entity === adminCurrentEntity).map(r => r.agentId));

        // Remove only reviews for the current entity
        reviews = reviews.filter(r => r.entity !== adminCurrentEntity);

        localStorage.setItem('adminReviews', JSON.stringify(reviews));

        // For each removed agent, if they now have 0 global reviews, unmark finalization
        removedAgents.forEach(agentId => {
          const remaining = reviews.filter(r => String(r.agentId) === String(agentId)).length;
          if (remaining === 0) {
            unmarkAgentWeekComplete('ALL', agentId);
          }
        });

        // Reconcile across all entities to handle edge cases where flags may remain
        reconcileFinalizeFlags();

        // Refresh UI
        renderAdminAgentDropdown();
        checkAndEnableWeekFinalButton();
        adminLoadReviewsList();

        alert('All reviews for this entity have been deleted. Finalization flags were cleared where applicable.');
      }
    }

    // ----- Confirm modal & undo flow for clearing finalizations -----
    let _pendingFinalizationClearBuffer = null; // stores pending buffer id and expiry in localStorage

    function adminClearFinalizations(targetAgentId) {
      // Build list of affected agents
      let agents = [];
      if (targetAgentId || adminCurrentAgent) {
        const id = targetAgentId || adminCurrentAgent;
        const agentObj = USER_DB.find(u => String(u.id) === String(id));
        if (agentObj) agents.push(agentObj);
      } else {
        agents = USER_DB.filter(u => u.role === 'agent' && (!adminCurrentEntity || adminCurrentEntity === 'ALL' || u.entity === adminCurrentEntity));
      }

      if (agents.length === 0) return alert('No agents found for this operation.');

      // Render modal details
      const details = document.getElementById('confirm-clear-finalizations-details');
      details.innerHTML = '';
      const list = document.createElement('ul');
      list.className = 'list-disc pl-5 space-y-2';
      agents.forEach(a => {
        const li = document.createElement('li');
        const reviewCount = (JSON.parse(localStorage.getItem('adminReviews') || '[]').filter(r => String(r.agentId) === String(a.id)) || []).length;
        li.innerHTML = `<strong>${a.name}</strong> (${a.id}) ‚Äî ${reviewCount} review(s)`;
        list.appendChild(li);
      });
      details.appendChild(list);

      // Store pending selection in a temporary global so confirm can access
      _pendingFinalizationClearBuffer = { id: `buf_${Date.now()}_${Math.floor(Math.random() * 1000)}`, agents: agents.map(a => a.id), entity: adminCurrentEntity || 'ALL', timestamp: Date.now() };

      document.getElementById('confirm-clear-finalizations-modal').classList.remove('hidden');
    }

    function confirmClearFinalizationsModalCancel() {
      _pendingFinalizationClearBuffer = null;
      document.getElementById('confirm-clear-finalizations-modal').classList.add('hidden');
    }

    function confirmClearFinalizationsModalConfirm() {
      if (!_pendingFinalizationClearBuffer) return;
      const buf = _pendingFinalizationClearBuffer;
      document.getElementById('confirm-clear-finalizations-modal').classList.add('hidden');
      _performClearFinalizationsWithUndo(buf);
      _pendingFinalizationClearBuffer = null;
    }

    function _performClearFinalizationsWithUndo(buffer) {
      // Backup all entityWeekState_* entries so we can restore on undo
      const backups = {};
      Object.keys(localStorage).forEach(key => {
        if (!key.startsWith('entityWeekState_')) return;
        backups[key] = localStorage.getItem(key);
      });

      // Save buffer to localStorage as undo buffer
      const undoBuffer = { id: buffer.id, timestamp: Date.now(), actor: (currentUser?.name || currentSessionUser?.name || 'admin'), entity: buffer.entity, agents: buffer.agents, backups };
      localStorage.setItem('finalizationUndoBuffer', JSON.stringify(undoBuffer));

      // Perform clear: unmark agents across all entities
      buffer.agents.forEach(agentId => {
        unmarkAgentWeekComplete('ALL', agentId);
      });

      reconcileFinalizeFlags();

      // Push audit entry
      const history = JSON.parse(localStorage.getItem('finalizationClearHistory') || '[]');
      history.unshift({ id: buffer.id, actor: (currentUser?.name || currentSessionUser?.name || 'admin'), entity: buffer.entity, agents: buffer.agents, action: 'cleared', timestamp: new Date().toISOString() });
      localStorage.setItem('finalizationClearHistory', JSON.stringify(history));

      // Refresh UI
      renderAdminAgentDropdown();
      checkAndEnableWeekFinalButton();
      adminLoadReviewsList();
      updateClearFinalizationsButton();

      // Show undo toast
      const toast = document.getElementById('finalization-undo-toast');
      const text = document.getElementById('finalization-undo-text');
      const btn = document.getElementById('finalization-undo-btn');
      text.innerText = `Finalizations cleared for ${buffer.agents.length} agent(s).`;
      toast.classList.remove('hidden');

      // Wire undo button
      btn.onclick = () => undoClearFinalizations(buffer.id);

      // Auto-expire buffer after 10s
      setTimeout(() => {
        const existing = JSON.parse(localStorage.getItem('finalizationUndoBuffer') || 'null');
        if (existing && existing.id === buffer.id) {
          localStorage.removeItem('finalizationUndoBuffer');
          dismissFinalizationUndoToast();
        }
      }, 10000);

      // Save the buffer reference in memory too
      _pendingFinalizationClearBuffer = { id: buffer.id };
    }

    function undoClearFinalizations(bufferId) {
      const buf = JSON.parse(localStorage.getItem('finalizationUndoBuffer') || 'null');
      if (!buf || buf.id !== bufferId) return alert('Nothing to undo.');

      // Restore backups
      Object.keys(buf.backups || {}).forEach(key => {
        localStorage.setItem(key, buf.backups[key]);
      });

      // Reconcile and refresh UI
      reconcileFinalizeFlags();
      renderAdminAgentDropdown();
      checkAndEnableWeekFinalButton();
      adminLoadReviewsList();

      // Audit undo
      const history = JSON.parse(localStorage.getItem('finalizationClearHistory') || '[]');
      history.unshift({ id: `undo_${bufferId}`, actor: (currentUser?.name || currentSessionUser?.name || 'admin'), entity: buf.entity, agents: buf.agents, action: 'undo', timestamp: new Date().toISOString() });
      localStorage.setItem('finalizationClearHistory', JSON.stringify(history));

      // Remove undo buffer
      localStorage.removeItem('finalizationUndoBuffer');
      dismissFinalizationUndoToast();

      alert('Undo complete. Finalization flags restored.');
    }

    function dismissFinalizationUndoToast() {
      const toast = document.getElementById('finalization-undo-toast');
      if (toast) toast.classList.add('hidden');
    }

    function adminDeleteAllReports() {
      if (confirm('Delete all reports? This action cannot be undone.')) {
        MockBackend.clearAllReports();
        renderAdminDashboard();
        alert('All reports have been deleted.');
      }
    }

    function adminDeleteAllFeedback() {
      if (confirm('Delete all feedback? This action cannot be undone.')) {
        localStorage.removeItem('agentComments');
        adminLoadFeedbackList();
      }
    }

    function adminLoadFeedbackList() {
      const comments = JSON.parse(localStorage.getItem('reviewComments') || '[]');
      const tbody = document.getElementById('admin-feedback-list');

      if (comments.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" class="p-6 text-center text-slate-400">No agent replies yet.</td></tr>';
        return;
      }

      tbody.innerHTML = comments.map((comment, idx) => `
        <tr>
          <td class="p-6">${comment.date}</td>
          <td class="p-6">${comment.authorName}</td>
          <td class="p-6">${comment.text.substring(0, 80)}...</td>
          <td class="p-6 text-right">
            <button onclick="adminDeleteFeedback(${idx})" class="text-red-600 hover:text-red-700">üóëÔ∏è Delete</button>
          </td>
        </tr>
      `).join('');
    }

    function adminDeleteFeedback(index) {
      let comments = JSON.parse(localStorage.getItem('reviewComments') || '[]');
      comments.splice(index, 1);
      localStorage.setItem('reviewComments', JSON.stringify(comments));
      adminLoadFeedbackList();
    }

    // ===== NEW AGENT DASHBOARD FUNCTIONS =====
    function openAgentPerformanceModal() {
      const modal = document.getElementById('agent-performance-modal');
      const agentId = currentUser.id;

      document.getElementById('modal-agent-id').textContent = `ID: ${agentId}`;

      // Load reviews for this agent
      const reviews = JSON.parse(localStorage.getItem('adminReviews') || '[]');
      const agentReviews = reviews.filter(r => r.agentId === agentId);

      if (agentReviews.length === 0) {
        document.getElementById('perf-content-loaded').classList.add('hidden');
        document.getElementById('perf-content-empty').classList.remove('hidden');
        modal.classList.remove('hidden');
        return;
      }

      // Calculate stats
      const totalAudits = agentReviews.length;
      const fatalCount = agentReviews.filter(r => r.score === 0).length;
      const goodCount = agentReviews.filter(r => r.score === 100).length;
      const totalScore = (goodCount * 100) / totalAudits;

      // Display stats
      document.getElementById('modal-audit-count').textContent = totalAudits;
      document.getElementById('modal-fatal-count').textContent = fatalCount;
      document.getElementById('modal-good-count').textContent = goodCount;
      document.getElementById('modal-total-score').textContent = totalScore.toFixed(0);

      // Display reviews
      const reviewsList = document.getElementById('modal-reviews-list');
      reviewsList.innerHTML = agentReviews.map((review, idx) => `
        <div class="bg-slate-50 dark:bg-slate-700 p-4 rounded-lg border border-slate-200 dark:border-slate-600">
          <div class="flex justify-between items-start mb-2">
            <div>
              <p class="font-bold text-sm">Review #${idx + 1}</p>
              <p class="text-xs text-slate-500">${review.date}</p>
            </div>
            <span class="font-bold ${review.score === 100 ? 'text-emerald-600 text-lg' : 'text-red-600 text-lg'}">Score: ${review.score}</span>
          </div>
          <p class="text-sm mb-2"><strong>File:</strong> ${review.fileName}</p>
          <p class="text-sm mb-2"><strong>Observation:</strong> ${review.observation}</p>
          <button onclick="agentViewReviewDetail(${idx})" class="text-blue-600 hover:text-blue-700 text-sm">üëÅÔ∏è View Details</button>
        </div>
      `).join('');

      document.getElementById('perf-content-loaded').classList.remove('hidden');
      document.getElementById('perf-content-empty').classList.add('hidden');
      modal.classList.remove('hidden');
    }

    function agentViewReviewDetail(index) {
      const reviews = JSON.parse(localStorage.getItem('adminReviews') || '[]');
      const agentId = currentUser.id;
      const agentReviews = reviews.filter(r => r.agentId === agentId);
      const review = agentReviews[index];

      const choice = confirm(`üìã Review Detail\n\nFile: ${review.fileName}\nScore: ${review.score}\nObservation:\n${review.observation}\n\nClick OK to OPEN THE FILE.`);
      if (choice && review.fileContent) {
        openFileContent(review.fileContent, review.fileName);
      }
    }

    function agentSubmitComment() {
      const textarea = document.getElementById('agent-comment-input');
      const comment = textarea.value.trim();

      if (!comment) {
        alert('Please enter a comment');
        return;
      }

      let comments = JSON.parse(localStorage.getItem('agentComments') || '[]');
      comments.push({
        date: new Date().toLocaleDateString(),
        agentId: currentUser.id,
        agentName: currentUser.name,
        comment: comment
      });

      localStorage.setItem('agentComments', JSON.stringify(comments));
      textarea.value = '';
      alert('Your feedback has been sent to admin!');
    }

    function closeAgentPerformanceModal() {
      document.getElementById('agent-performance-modal').classList.add('hidden');
      document.getElementById('agent-comment-input').value = '';
    }

    // Review Detail Modal for Agents
    function openReviewDetail(reviewId) {
      const reviews = JSON.parse(localStorage.getItem('adminReviews') || '[]');
      const review = reviews.find(r => r.id === reviewId);
      if (!review) return;

      const modal = document.getElementById('agent-review-detail-modal');
      document.getElementById('review-detail-type').textContent = review.reviewType === 'voice' ? 'üéôÔ∏è Voice Call' : 'üí¨ Chat/Email';

      if (review.reviewType === 'voice') {
        document.getElementById('review-detail-file-section').classList.remove('hidden');
        document.getElementById('review-detail-id-section').classList.add('hidden');
        document.getElementById('review-detail-file-name').textContent = review.fileName || 'N/A';
        document.getElementById('review-detail-file-link').onclick = () => openFileContent(review.fileContent, review.fileName);
      } else {
        document.getElementById('review-detail-file-section').classList.add('hidden');
        document.getElementById('review-detail-id-section').classList.remove('hidden');
        document.getElementById('review-detail-id-value').textContent = review.chatId || 'N/A';
      }

      document.getElementById('review-detail-date').textContent = review.date;
      document.getElementById('review-detail-observation').textContent = review.observation;
      document.getElementById('review-detail-score').textContent = review.score;

      // Show reviewer/quality team
      if (!document.getElementById('review-detail-reviewer')) {
        const reviewerRow = document.createElement('div');
        reviewerRow.className = 'text-sm text-slate-500 mb-2';
        reviewerRow.id = 'review-detail-reviewer';
        reviewerRow.innerHTML = `<strong>Reviewed by:</strong> ${review.reviewerName || 'Quality Team'}`;
        const container = document.querySelector('#agent-review-detail-modal .p-6');
        if (container) container.insertBefore(reviewerRow, container.firstChild);
      } else {
        document.getElementById('review-detail-reviewer').innerHTML = `<strong>Reviewed by:</strong> ${review.reviewerName || 'Quality Team'}`;
      }

      // Load comments for this review
      const allComments = JSON.parse(localStorage.getItem('reviewComments') || '[]');
      const comments = allComments.filter(c => c.reviewId === reviewId);
      const commentsHtml = comments.length === 0 ? '<p class="text-slate-500 italic">No replies yet</p>' : comments.map(c => `
        <div class="bg-slate-100 dark:bg-slate-600 p-3 rounded mb-2">
          <div class="font-semibold text-sm">${c.authorName || 'Agent'}</div>
          <div class="text-xs text-slate-500">${c.date}</div>
          <div class="text-sm mt-1">${c.text}</div>
        </div>
      `).join('');
      document.getElementById('review-detail-comments').innerHTML = commentsHtml;

      // Check if agent has already replied
      const replyInput = document.getElementById('review-detail-reply-input');
      const replyBtn = document.getElementById('review-detail-reply-btn');

      const hasReplied = comments.some(c => c.authorId === (currentUser.id || currentSessionUser.id));

      if (hasReplied && (currentUser.role === 'agent')) {
        replyInput.disabled = true;
        replyInput.placeholder = "You have already replied to this review.";
        replyBtn.disabled = true;
        replyBtn.innerHTML = "Reply Sent ‚úÖ";
        replyBtn.classList.add('opacity-50', 'cursor-not-allowed');
      } else {
        replyInput.disabled = false;
        replyInput.placeholder = "Write your reply...";
        replyBtn.disabled = false;
        replyBtn.innerHTML = "üì§ Send Reply";
        replyBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        // Set reply handler
        replyBtn.onclick = () => agentReplyFromModal(reviewId);
      }

      document.getElementById('agent-review-detail-modal').classList.remove('hidden');
    }

    function agentReplyFromModal(reviewId) {
      const allComments = JSON.parse(localStorage.getItem('reviewComments') || '[]');
      const alreadyReplied = allComments.some(c => c.reviewId === reviewId && c.authorId === (currentUser.id || currentSessionUser.id));

      if (alreadyReplied && (currentUser.role === 'agent')) {
        alert('You have already replied to this review.');
        return;
      }

      const textarea = document.getElementById('review-detail-reply-input');
      const text = textarea.value.trim();
      if (!text) return alert('Please write a reply first.');

      const comments = JSON.parse(localStorage.getItem('reviewComments') || '[]');
      comments.unshift({
        id: Date.now().toString() + '-' + Math.floor(Math.random() * 1000).toString(),
        reviewId: reviewId,
        authorId: currentSessionUser?.id || currentUser?.id || 'agent',
        authorName: currentSessionUser?.name || currentUser?.name || 'Agent',
        text: text,
        date: new Date().toLocaleString()
      });
      localStorage.setItem('reviewComments', JSON.stringify(comments));
      textarea.value = '';
      alert('Reply submitted!');
      openReviewDetail(reviewId); // Refresh modal
      agentLoadQADashboard(); // Refresh dashboard
      // Notify admin of new reply
      if (document.querySelector('.notification-dot')) {
        document.querySelector('.notification-dot').classList.remove('hidden');
      }
    }

    function closeReviewDetailModal() {
      const modal = document.getElementById('agent-review-detail-modal');
      if (modal) {
        modal.classList.add('hidden');
      }
    }

    // Tab Switching Function
    function agentSwitchTab(tab) {
      const weeklyContent = document.getElementById('tab-content-weekly');
      const monthlyContent = document.getElementById('tab-content-monthly');
      const weeklyBtn = document.getElementById('tab-weekly');
      const monthlyBtn = document.getElementById('tab-monthly');

      if (tab === 'weekly') {
        weeklyContent.classList.remove('hidden');
        monthlyContent.classList.add('hidden');
        weeklyBtn.classList.add('text-purple-600', 'border-purple-600');
        weeklyBtn.classList.remove('text-slate-500', 'border-transparent');
        monthlyBtn.classList.add('text-slate-500', 'border-transparent');
        monthlyBtn.classList.remove('text-purple-600', 'border-purple-600');
      } else {
        weeklyContent.classList.add('hidden');
        monthlyContent.classList.remove('hidden');
        monthlyBtn.classList.add('text-green-600', 'border-green-600');
        monthlyBtn.classList.remove('text-slate-500', 'border-transparent');
        weeklyBtn.classList.add('text-slate-500', 'border-transparent');
        weeklyBtn.classList.remove('text-green-600', 'border-green-600');
        agentLoadMonthlyPerformance();
      }
    }

    // Monthly Performance Calculation
    // Monthly Performance Calculation
    function agentLoadMonthlyPerformance() {
      if (!currentSessionUser || currentSessionUser.role !== 'agent') return;

      const agentId = currentSessionUser.id;

      // Get or initialize monthly data storage
      let monthlyData = JSON.parse(localStorage.getItem(`agentMonthlyData_${agentId}`) || '{}');
      const now = new Date();

      // If no data exists or month has passed, initialize new month
      if (!monthlyData.startDate) {
        monthlyData = {
          startDate: now.getTime(),
          weeks: [
            { weekNumber: 1, audits: 0, avgScore: 0, fatalCount: 0 },
            { weekNumber: 2, audits: 0, avgScore: 0, fatalCount: 0 },
            { weekNumber: 3, audits: 0, avgScore: 0, fatalCount: 0 },
            { weekNumber: 4, audits: 0, avgScore: 0, fatalCount: 0 }
          ]
        };
      } else {
        // Check if 28 days have passed since month started
        const monthStartTime = new Date(monthlyData.startDate);
        const daysPassed = (now - monthStartTime) / (1000 * 60 * 60 * 24);

        if (daysPassed >= 28) {
          // Reset the month - start new cycle
          monthlyData = {
            startDate: now.getTime(),
            weeks: [
              { weekNumber: 1, audits: 0, avgScore: 0, fatalCount: 0 },
              { weekNumber: 2, audits: 0, avgScore: 0, fatalCount: 0 },
              { weekNumber: 3, audits: 0, avgScore: 0, fatalCount: 0 },
              { weekNumber: 4, audits: 0, avgScore: 0, fatalCount: 0 }
            ]
          };
        }
      }

      // Calculate which week we're in based on days elapsed
      const monthStartTime = new Date(monthlyData.startDate);
      const daysPassed = (now - monthStartTime) / (1000 * 60 * 60 * 24);
      const currentWeekNumber = Math.floor(daysPassed / 7) + 1;

      // Get current week reviews
      let reviews = JSON.parse(localStorage.getItem('adminReviews') || '[]');
      const agentReviews = reviews.filter(r => r.agentId === agentId);

      const fourWeeksAgo = new Date(now.getTime() - 28 * 24 * 60 * 60 * 1000);
      const monthlyReviews = agentReviews.filter(r => {
        const reviewDate = new Date(r.date);
        return reviewDate >= fourWeeksAgo && reviewDate <= now;
      });

      // Update current week data with latest reviews
      if (monthlyData.weeks[currentWeekNumber - 1]) {
        const weekStart = new Date(monthStartTime.getTime() + (currentWeekNumber - 1) * 7 * 24 * 60 * 60 * 1000);
        const weekEnd = new Date(weekStart.getTime() + 7 * 24 * 60 * 60 * 1000);

        const weekReviews = monthlyReviews.filter(r => {
          const reviewDate = new Date(r.date);
          return reviewDate >= weekStart && reviewDate < weekEnd;
        });

        const weekAudits = weekReviews.length;
        const weekScore = weekAudits > 0 ? Math.round((weekReviews.reduce((sum, r) => sum + r.score, 0) / weekAudits / 100) * 100) : 0;
        const weekFatals = weekReviews.filter(r => r.score === 0).length;

        monthlyData.weeks[currentWeekNumber - 1] = {
          weekNumber: currentWeekNumber,
          audits: weekAudits,
          avgScore: weekScore,
          fatalCount: weekFatals
        };
      }

      // Save updated data
      localStorage.setItem(`agentMonthlyData_${agentId}`, JSON.stringify(monthlyData));

      // Check if we have data to display
      const totalData = monthlyData.weeks.reduce((sum, w) => sum + w.audits, 0);
      const hasEnoughData = totalData > 0;

      document.getElementById('agent-no-monthly-data').classList.toggle('hidden', hasEnoughData);

      if (hasEnoughData) {
        // Calculate overall stats from stored weeks
        const totalAudits = monthlyData.weeks.reduce((sum, w) => sum + w.audits, 0);
        const totalScore = monthlyData.weeks.reduce((sum, w) => sum + (w.audits > 0 ? w.avgScore * w.audits : 0), 0);
        const avgScore = totalAudits > 0 ? Math.round(totalScore / totalAudits) : 0;
        const fatalCount = monthlyData.weeks.reduce((sum, w) => sum + w.fatalCount, 0);

        let status = 'Excellent';
        if (avgScore >= 80) status = 'Excellent';
        else if (avgScore >= 60) status = 'Good';
        else if (avgScore >= 40) status = 'Need Improvement';
        else status = 'Critical';

        document.getElementById('agent-monthly-total-audits').textContent = totalAudits;
        document.getElementById('agent-monthly-avg-score').textContent = avgScore + '%';
        document.getElementById('agent-monthly-fatal-count').textContent = fatalCount;
        document.getElementById('agent-monthly-status').textContent = status;

        // Display stored weekly data
        monthlyData.weeks.forEach((week) => {
          document.getElementById(`agent-monthly-week${week.weekNumber}-audits`).textContent = week.audits;
          document.getElementById(`agent-monthly-week${week.weekNumber}-score`).textContent = week.avgScore + '%';
          document.getElementById(`agent-monthly-week${week.weekNumber}-fatals`).textContent = week.fatalCount;
        });
      } else {
        // No data yet - show dashes
        document.getElementById('agent-monthly-total-audits').textContent = '--';
        document.getElementById('agent-monthly-avg-score').textContent = '--';
        document.getElementById('agent-monthly-fatal-count').textContent = '--';
        document.getElementById('agent-monthly-status').textContent = '----';

        // Clear weekly breakdown
        for (let week = 1; week <= 4; week++) {
          document.getElementById(`agent-monthly-week${week}-audits`).textContent = '--';
          document.getElementById(`agent-monthly-week${week}-score`).textContent = '--';
          document.getElementById(`agent-monthly-week${week}-fatals`).textContent = '--';
        }
      }
    }

    // ===== ADMIN MONTHLY DASHBOARD FUNCTIONS =====
    function adminLoadMonthlyDashboard() {
      // Navigate to view
      navigateTo('view-admin-monthly');

      const entity = adminCurrentEntity || 'ALL';
      document.getElementById('admin-monthly-entity-display').textContent = entity;

      const tbody = document.getElementById('admin-monthly-table-body');
      tbody.innerHTML = '<tr><td colspan="6" class="p-6 text-center text-slate-400 italic">Loading performance data...</td></tr>';

      // 1. Get Agents
      let agents = USER_DB.filter(u => u.role === 'agent');
      if (entity !== 'ALL') {
        agents = agents.filter(u => u.entity === entity);
      }

      // 2. Get Reviews & Date Range
      const reviews = JSON.parse(localStorage.getItem('adminReviews') || '[]');
      const now = new Date();
      const thirtyDaysAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);

      // 3. Process Data
      const rows = agents.map(agent => {
        // Filter reviews for this agent within 30 days
        const agentId = String(agent.id).trim().toLowerCase();

        const agentReviews = reviews.filter(r => {
          const rAgentId = String(r.agentId).trim().toLowerCase();
          if (rAgentId !== agentId) return false;

          // Date check
          const d = new Date(r.date);
          if (isNaN(d.getTime())) return false; // skip invalid dates
          return d >= thirtyDaysAgo && d <= now;
        });

        const totalAudits = agentReviews.length;
        const avgScore = totalAudits > 0 ? Math.round(agentReviews.reduce((sum, r) => sum + r.score, 0) / totalAudits) : 0;
        const fatalCount = agentReviews.filter(r => r.score === 0).length;

        // Performace Status
        let status = 'Pending';
        let statusClass = 'bg-slate-100 text-slate-600';

        if (totalAudits > 0) {
          if (avgScore >= 80) { status = 'Excellent'; statusClass = 'bg-emerald-100 text-emerald-700'; }
          else if (avgScore >= 60) { status = 'Good'; statusClass = 'bg-blue-100 text-blue-700'; }
          else if (avgScore >= 40) { status = 'Need Improvement'; statusClass = 'bg-amber-100 text-amber-700'; }
          else { status = 'Critical'; statusClass = 'bg-red-100 text-red-700'; }
        }

        return {
          name: agent.name,
          id: agent.id,
          audits: totalAudits,
          fatals: fatalCount,
          score: avgScore,
          status: status,
          statusClass: statusClass
        };
      });

      // 4. Render
      if (rows.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="p-6 text-center text-slate-400 italic">No agents found for this entity.</td></tr>';
        return;
      }

      // Sort by score desc
      rows.sort((a, b) => b.score - a.score);

      tbody.innerHTML = rows.map((row, index) => {
        // Blank logic for empty audits
        const showAudits = row.audits === 0 ? '--' : row.audits;
        const showFatals = row.audits === 0 ? '--' : row.fatals;
        const showScore = row.audits === 0 ? '--' : row.score + '%';
        const showStatus = row.audits === 0 ? '<span class="text-slate-400">--</span>' : `<span class="px-3 py-1 rounded-full text-xs font-bold uppercase ${row.statusClass}">${row.status}</span>`;
        const scoreClass = row.audits === 0 ? '' : (row.score >= 80 ? 'text-emerald-600 bg-emerald-50' : row.score < 50 ? 'text-red-600 bg-red-50' : 'text-blue-600 bg-blue-50');

        return `
        <tr class="hover:bg-indigo-50/30 dark:hover:bg-slate-700/30 transition">
           <td class="p-6 text-center font-bold text-slate-400">${index + 1}</td>
           <td class="p-6">
              <div class="font-bold text-slate-800 dark:text-slate-200">${row.name}</div>
              <div class="text-xs text-slate-500 font-mono">${row.id}</div>
           </td>
           <td class="p-6 text-center font-bold text-slate-700 dark:text-slate-300 text-lg">${showAudits}</td>
           <td class="p-6 text-center font-bold ${row.fatals > 0 ? 'text-red-600' : 'text-slate-400'} text-lg">${showFatals}</td>
           <td class="p-6 text-center">
              <div class="inline-block px-3 py-1 rounded-full font-bold text-sm ${scoreClass}">
                 ${showScore}
              </div>
           </td>
           <td class="p-6 text-center">
              ${showStatus}
           </td>
        </tr>
      `}).join('');
    }

    // Load reviews on page load
    window.addEventListener('load', function () {
      adminLoadReviewsList();
      adminLoadFeedbackList();

      // Start update checker once initial admin data is loaded
      try {
        startUpdateChecker();
      } catch (e) {
        console.warn('[updateChecker] failed to start', e);
      }
    });

    /* ----------------- Auto-update / cache-refresh checker -----------------
       It checks the embedded APP_VERSION token in the page and periodically
       fetches the page with cache: 'no-store' to detect version changes.
       When a new version is detected it shows a small banner with a reload
       button so users can refresh to get the latest updates without re-sharing.
    ----------------------------------------------------------------------- */

    // Helper: extract token like "APP_VERSION: 20260130-001" from page text
    function _extractAppVersion(text) {
      const m = text.match(/APP_VERSION:\s*([0-9A-Za-z_.\-]+)/i);
      return m ? m[1] : null;
    }

    const _currentAppVersion = _extractAppVersion(document.documentElement.innerHTML) || 'unknown';
    let _updateCheckerInterval = null;

    function showUpdateBanner() {
      const banner = document.getElementById('update-banner');
      if (!banner) return;
      banner.classList.remove('hidden');

      const reloadBtn = document.getElementById('update-reload-btn');
      const dismissBtn = document.getElementById('update-dismiss-btn');

      // Attach handlers
      reloadBtn.onclick = () => location.reload();
      dismissBtn.onclick = () => banner.classList.add('hidden');

      // Auto-reload after 60s to ensure users get the new version (optional)
      setTimeout(() => {
        if (!banner.classList.contains('hidden')) location.reload();
      }, 60000);
    }

    async function checkForUpdates() {
      try {
        const resp = await fetch(location.href, { cache: 'no-store', credentials: 'same-origin' });
        if (!resp.ok) return;
        const text = await resp.text();
        const remoteVersion = _extractAppVersion(text);
        if (remoteVersion && remoteVersion !== _currentAppVersion) {
          console.info('[updateChecker] new version detected', remoteVersion, 'current', _currentAppVersion);
          showUpdateBanner();
          // stop further checks once detected
          if (_updateCheckerInterval) clearInterval(_updateCheckerInterval);
        }
      } catch (e) {
        console.warn('[updateChecker] check failed', e);
      }
    }

    function startUpdateChecker() {
      // Run an immediate check, then poll every 30s
      checkForUpdates();
      _updateCheckerInterval = setInterval(checkForUpdates, 30 * 1000);
    }

  </script>

  <!-- Agent Review Detail Modal -->
  <div id="agent-review-detail-modal"
    class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"
    onclick="if(event.target.id === 'agent-review-detail-modal') closeReviewDetailModal()">
    <div class="bg-white dark:bg-slate-800 rounded-3xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto"
      onclick="event.stopPropagation()">
      <div
        class="sticky top-0 bg-white dark:bg-slate-800 p-6 border-b border-slate-200 dark:border-slate-700 flex justify-between items-center">
        <h2 class="text-2xl font-bold">Review Details</h2>
        <button onclick="closeReviewDetailModal()" class="text-slate-500 hover:text-slate-700 text-2xl">‚úï</button>
      </div>

      <div class="p-6 space-y-6">
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-semibold mb-2">Review Type</label>
            <div id="review-detail-type" class="text-lg font-bold text-blue-600">üéôÔ∏è Voice Call</div>
          </div>
          <div>
            <label class="block text-sm font-semibold mb-2">Date</label>
            <div id="review-detail-date" class="text-lg">-</div>
          </div>
        </div>

        <div id="review-detail-file-section" class="hidden">
          <label class="block text-sm font-semibold mb-2">Uploaded File</label>
          <div class="bg-slate-100 dark:bg-slate-700 p-4 rounded-lg">
            <div id="review-detail-file-name" class="font-semibold mb-2">-</div>
            <button id="review-detail-file-link" class="text-blue-600 underline text-sm">üì• Download/View</button>
          </div>
        </div>

        <div id="review-detail-id-section" class="hidden">
          <label class="block text-sm font-semibold mb-2">EMAIL/CHAT ID</label>
          <div class="bg-slate-100 dark:bg-slate-700 p-4 rounded-lg font-mono text-sm" id="review-detail-id-value">-
          </div>
        </div>

        <div>
          <label class="block text-sm font-semibold mb-2">Observation</label>
          <div id="review-detail-observation"
            class="bg-slate-100 dark:bg-slate-700 p-4 rounded-lg whitespace-pre-wrap text-sm">-</div>
        </div>

        <div>
          <label class="block text-sm font-semibold mb-2">Score</label>
          <div class="text-3xl font-bold" id="review-detail-score">-</div>
        </div>

        <div>
          <label class="block text-sm font-semibold mb-2">Replies</label>
          <div id="review-detail-comments"
            class="bg-slate-50 dark:bg-slate-700 p-4 rounded-lg mb-4 max-h-48 overflow-y-auto">
            <p class="text-slate-500 italic">Loading...</p>
          </div>

          <textarea id="review-detail-reply-input" rows="3" placeholder="Write your reply..."
            class="flex-1 w-full px-4 py-3 rounded-lg border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-700"></textarea>
          <button id="review-detail-reply-btn"
            class="mt-2 w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">
            üì§ Send Reply
          </button>
        </div>
      </div>

      <div class="p-6 border-t border-slate-200 dark:border-slate-700">
        <button onclick="closeReviewDetailModal()"
          class="w-full bg-slate-300 dark:bg-slate-600 text-slate-800 dark:text-slate-200 font-bold py-2 px-4 rounded-lg">
          Close
        </button>
      </div>
    </div>
  </div>


  <!-- Admin Review Detail Modal (NEW) -->
  <div id="admin-review-detail-modal"
    class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"
    onclick="if(event.target.id === 'admin-review-detail-modal') closeAdminReviewDetailModal()">
    <div class="bg-white dark:bg-slate-800 rounded-3xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto"
      onclick="event.stopPropagation()">
      <div
        class="sticky top-0 bg-white dark:bg-slate-800 p-6 border-b border-slate-200 dark:border-slate-700 flex justify-between items-center">
        <h2 class="text-2xl font-bold">Review Details (Admin)</h2>
        <button onclick="closeAdminReviewDetailModal()" class="text-slate-500 hover:text-slate-700 text-2xl">‚úï</button>
      </div>

      <div class="p-6 space-y-6">
        <div class="flex justify-between items-center">
          <div>
            <h3 class="text-lg font-bold" id="admin-review-detail-agent">Agent Name</h3>
            <p class="text-sm text-slate-500" id="admin-review-detail-date">-</p>
          </div>
          <div id="admin-review-detail-type" class="text-lg font-bold text-blue-600"></div>
        </div>

        <div id="admin-review-detail-file-section" class="hidden">
          <label class="block text-sm font-semibold mb-2">Uploaded File</label>
          <div class="bg-slate-100 dark:bg-slate-700 p-4 rounded-lg flex justify-between items-center">
            <div id="admin-review-detail-file-name" class="font-semibold">-</div>
            <button id="admin-review-detail-file-link" class="text-blue-600 underline text-sm font-bold">üì•
              Download/View</button>
          </div>
        </div>

        <div id="admin-review-detail-id-section" class="hidden">
          <label class="block text-sm font-semibold mb-2">Contact ID</label>
          <div class="bg-slate-100 dark:bg-slate-700 p-4 rounded-lg font-mono text-sm"
            id="admin-review-detail-id-value">-</div>
        </div>

        <div>
          <label class="block text-sm font-semibold mb-2">Observation</label>
          <div id="admin-review-detail-observation"
            class="bg-slate-100 dark:bg-slate-700 p-4 rounded-lg whitespace-pre-wrap text-sm">-</div>
        </div>

        <div>
          <label class="block text-sm font-semibold mb-2">Score</label>
          <div class="text-3xl font-bold" id="admin-review-detail-score">-</div>
        </div>

        <div>
          <label class="block text-sm font-semibold mb-2">Comments History</label>
          <div id="admin-review-detail-comments"
            class="bg-slate-50 dark:bg-slate-700 p-4 rounded-lg max-h-60 overflow-y-auto space-y-3">
            <!-- Comments injected here -->
          </div>
        </div>
      </div>

      <div class="p-6 border-t border-slate-200 dark:border-slate-700">
        <button onclick="closeAdminReviewDetailModal()"
          class="w-full bg-slate-200 dark:bg-slate-700 text-slate-800 dark:text-slate-200 font-bold py-3 rounded-lg hover:bg-slate-300 dark:hover:bg-slate-600 transition">
          Close
        </button>
      </div>
    </div>
  </div>

</body>

</html>
